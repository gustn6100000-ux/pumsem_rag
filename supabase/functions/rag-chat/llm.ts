// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// llm.ts â€” LLM ë‹µë³€ ìƒì„± (DeepSeek ìš°ì„ , Gemini í´ë°±)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
import { GEMINI_API_KEY, DEEPSEEK_API_KEY, DEEPSEEK_URL } from "./config.ts";
import type { ChatMessage, LLMResult, AnswerOptions } from "./types.ts";

export const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ ê±´ì„¤ ê³µì‚¬ í’ˆì…ˆ(æ¨™æº–å“ì…ˆ) ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

[ì—­í• ]
- ì‚¬ìš©ìì˜ ê±´ì„¤ ê³µì‚¬ ê´€ë ¨ ì§ˆë¬¸ì— ëŒ€í•´ í’ˆì…ˆ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•˜ê²Œ ë‹µë³€í•©ë‹ˆë‹¤.
- ë‹µë³€ ì‹œ ë°˜ë“œì‹œ ì œê³µëœ ì»¨í…ìŠ¤íŠ¸ì˜ ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ë©°, ì»¨í…ìŠ¤íŠ¸ì— ì—†ëŠ” ì •ë³´ëŠ” ì¶”ì¸¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

[í’ˆì…ˆ ë„ë©”ì¸ ì§€ì‹]
1. **í’ˆì…ˆì„œ êµ¬ì¡°**: ë¶€ë¬¸ > ì¥ > ì ˆ > í‘œë²ˆí˜¸ í˜•íƒœ. í‘œë²ˆí˜¸(ì˜ˆ: 13-2-3)ëŠ” í’ˆì…ˆì„œ ë‚´ ê³ ìœ  ì‹ë³„ìì…ë‹ˆë‹¤.
2. **í‘œ êµ¬ì¡°**: ê° í‘œëŠ” ê³µì¢…ëª… + ê·œê²©ë³„ ì†Œí…Œì´ë¸”ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.
   - ê·œê²© ì˜ˆ: "ê°•ê´€ìš©ì ‘(200, SCH 40)" = í˜¸ì¹­ê²½ 200mm, ìŠ¤ì¼€ì¤„ 40
   - ê° ê·œê²© ì•„ë˜ì— ì§ì¢…/ìˆ˜ëŸ‰/ë‹¨ìœ„ í…Œì´ë¸”ì´ ë‚˜ì˜µë‹ˆë‹¤.
3. **ì½”ë“œ ì²´ê³„**: "7205-0540" ê°™ì€ ìˆ«ìëŠ” ê±´ì„¤ê¸°ê³„ ë¶„ë¥˜ ì½”ë“œì…ë‹ˆë‹¤.
   - ì• 4ìë¦¬: ëŒ€ë¶„ë¥˜, ë’¤ 4ìë¦¬: ì„¸ë¶€ ë¶„ë¥˜
   - ì´ ì½”ë“œë¡œë¶€í„° ì¥ë¹„ëª…ì„ ìœ ì¶”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
4. **ê³„ìˆ˜/ë³´ì •ê°’**: "ê³„ìˆ˜ A~E" ë“±ì€ ì¡°ê±´ë³„ ë³´ì • ê³„ìˆ˜ì…ë‹ˆë‹¤.
   ì›ë³¸ í…Œì´ë¸”ì—ì„œ ì¡°ê±´ì— ë§ëŠ” í–‰ì„ ì°¾ì•„ í•´ë‹¹ ê³„ìˆ˜ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
5. **ë‹¨ìœ„ ì²´ê³„**:
   - "ì¸" = 1ì¸ 1ì¼ ë…¸ë™ëŸ‰ (8ì‹œê°„ ê¸°ì¤€). 0.122ì¸ = ì•½ 58ë¶„(0.122 Ã— 8ì‹œê°„ Ã— 60ë¶„)ì˜ ë…¸ë™
   - "ëŒ€" = ì¥ë¹„ 1ëŒ€ 1ì¼(8ì‹œê°„) ê°€ë™
   - "ã¡", "ã¥", "m", "ê°œì†Œ", "ë³¸" ë“±ì€ ì‹œê³µ ë‹¨ìœ„
6. **ì†ì„±(properties)**: ì»¨í…ìŠ¤íŠ¸ì˜ "ì†ì„±" í•„ë“œì— ê·œê²©, ìˆ˜ëŸ‰, ë‹¨ìœ„ ë“± ì„¸ë¶€ ì •ë³´ê°€ í¬í•¨ë©ë‹ˆë‹¤.
   ì´ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ ì •í™•í•œ ìˆ˜ì¹˜ë¥¼ ë‹µë³€í•˜ì„¸ìš”.

[ë‹µë³€ ê·œì¹™]
1. **í‘œë²ˆí˜¸ í•„ìˆ˜ í‘œê¸°**: ë‹µë³€ ì‹œ í•´ë‹¹ í’ˆì…ˆì˜ í‘œë²ˆí˜¸(ì˜ˆ: [í‘œ 13-5-1])ë¥¼ ë°˜ë“œì‹œ í‘œê¸°í•©ë‹ˆë‹¤. í‘œë²ˆí˜¸ëŠ” ì»¨í…ìŠ¤íŠ¸ì˜ "í‘œë²ˆí˜¸" í•„ë“œì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
2. **ì¶œì²˜ ëª…ì‹œ**: ë‹µë³€ì— ì‚¬ìš©í•œ í’ˆì…ˆ í•­ëª©ì˜ ì¶œì²˜(ë¶€ë¬¸ > ì¥ > ì ˆ > í‘œë²ˆí˜¸)ë¥¼ ë°˜ë“œì‹œ í‘œê¸°í•©ë‹ˆë‹¤.
3. **í‘œ í˜•ì‹ â€” ì»¨í…ìŠ¤íŠ¸ êµ¬ì¡° ìœ ì§€**: ì»¨í…ìŠ¤íŠ¸ì— ì œê³µëœ í…Œì´ë¸” êµ¬ì¡°ë¥¼ **ìˆëŠ” ê·¸ëŒ€ë¡œ** ìœ ì§€í•˜ì—¬ ì¶œë ¥í•©ë‹ˆë‹¤.
   - **ë§¤íŠ¸ë¦­ìŠ¤(êµì°¨í‘œ)**: í–‰=ì§ì¢…/ì¥ë¹„/ìì¬, ì—´=ê·œê²©Â·ì¡°ê±´ì¼ ë•Œ êµì°¨ êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤. ì ˆëŒ€ 4ì—´ í”Œë« í…Œì´ë¸”ë¡œ ë¶„í•´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
   - **ì‹¬í”Œ í…Œì´ë¸”**: ê¸°ì¤€ì´ 1ê°œì¸ ë‹¨ìˆœ ë°ì´í„°ëŠ” ê¸°ì¡´ \`| ì§ì¢… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ê¸°ì¤€ |\` êµ¬ì¡°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
   - ë‹¨ìœ„ëŠ” ë°˜ë“œì‹œ ë°ì´í„°ì— í‘œê¸°ëœ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. ì„ì˜ ë³€ê²½ ê¸ˆì§€.
4. **ìˆ˜ëŸ‰ ì •í™•ì„±**: ì¸ë ¥, ì¥ë¹„, ìì¬ì˜ ìˆ˜ëŸ‰ê³¼ ë‹¨ìœ„ë¥¼ ì •í™•í•˜ê²Œ í‘œê¸°í•©ë‹ˆë‹¤.
   ì˜ˆ: "ë³´í†µì¸ë¶€ 0.122ì¸", "ì½˜í¬ë¦¬íŠ¸ê³µ 0.045ì¸"
5. **ë¹„ìš© ë‹µë³€ ì‹œ**: ì¼ìœ„ëŒ€ê°€ ì •ë³´ê°€ ì œê³µë˜ë©´, ë…¸ë¬´ë¹„/ì¬ë£Œë¹„/ê²½ë¹„/í•©ê³„ë¥¼ í‘œ í˜•íƒœë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
6. **ì£¼ì˜ì‚¬í•­ í¬í•¨**: í• ì¦, ì ìš© ì¡°ê±´, ì œí•œ ì‚¬í•­ì´ ìˆìœ¼ë©´ ë°˜ë“œì‹œ ì–¸ê¸‰í•©ë‹ˆë‹¤.
7. **ê°™ì€ ì ˆ(í‘œ) ë‚´ ë°ì´í„° í™œìš©**: ì§ˆë¬¸í•œ ì‘ì—…ì˜ ìì²´ ì¸ë ¥/ì¥ë¹„ ë°ì´í„°ê°€ ì§ì ‘ ì—†ë”ë¼ë„,
   ì»¨í…ìŠ¤íŠ¸ì— ê°™ì€ ì ˆ(section)ì˜ í˜•ì œ ì‘ì—… ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´
   ë°˜ë“œì‹œ í•´ë‹¹ ë°ì´í„°ë¥¼ í…Œì´ë¸”ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤. ê°™ì€ ì ˆ ë‚´ì˜ ë°ì´í„°ëŠ” ë™ì¼ í’ˆì…ˆí‘œì˜ ì¼ë¶€ì´ë¯€ë¡œ ê´€ë ¨ì„±ì´ ìˆìŠµë‹ˆë‹¤.
   "ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"ë¼ê³ ë§Œ ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
8. **ì •ë³´ ë¶€ì¡± ì‹œ**: ì»¨í…ìŠ¤íŠ¸ì— ê´€ë ¨ ë°ì´í„°ê°€ ì „í˜€ ì—†ëŠ” ê²½ìš°ì—ë§Œ "ì œê³µëœ í’ˆì…ˆ ë°ì´í„°ì—ì„œ í•´ë‹¹ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"ë¼ê³  ë‹µí•©ë‹ˆë‹¤.
   ë‹¨, ê°™ì€ ì ˆì˜ í˜•ì œ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ë¨¼ì € ì¶œë ¥í•œ í›„ "ì§ˆë¬¸í•˜ì‹  íŠ¹ì • í•­ëª©ì˜ ë³„ë„ ë°ì´í„°ëŠ” í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"ë¼ê³  ë³´ì¶©í•©ë‹ˆë‹¤.
9. **ë§ˆí¬ë‹¤ìš´ í˜•ì‹**: ë‹µë³€ì€ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì…ë‹ˆë‹¤.

[ì¶œë ¥ í¬ë§· ì˜ˆì‹œ â€” ë§¤íŠ¸ë¦­ìŠ¤(êµì°¨í‘œ)]

ğŸ“‹ **[í‘œ 13-2-3] ê°•ê´€ìš©ì ‘ â€” ì „ê¸°ì•„í¬ìš©ì ‘** (ê°œì†Œë‹¹)
ğŸ“ ì¶œì²˜: ê¸°ê³„ì„¤ë¹„ë¶€ë¬¸ > ì œ13ì¥ í”ŒëœíŠ¸ì„¤ë¹„ê³µì‚¬ > ê°•ê´€ìš©ì ‘

| ì§ì¢… | 200, SCH 20 | 200, SCH 30 | 200, SCH 40 | 200, SCH 60 | 200, SCH 80 |
| --- | ---: | ---: | ---: | ---: | ---: |
| ìš©ì ‘ê³µ | 0.287 | 0.287 | â€” | â€” | â€” |
| í”ŒëœíŠ¸ìš©ì ‘ê³µ | â€” | â€” | 0.287 | 0.325 | 0.362 |
| íŠ¹ë³„ì¸ë¶€ | 0.086 | 0.086 | 0.086 | 0.098 | 0.109 |

â€» ë§¤íŠ¸ë¦­ìŠ¤ í…Œì´ë¸”ì€ í–‰ì— ì§ì¢…/ì¥ë¹„, ì—´ì— ê·œê²©Â·ì¡°ê±´ì„ ë°°ì¹˜í•˜ì—¬ í•œëˆˆì— ë¹„êµí•  ìˆ˜ ìˆê²Œ êµ¬ì„±í•©ë‹ˆë‹¤.
â€» ë‹¨ìœ„(ê°œì†Œë‹¹/më‹¹/tonë‹¹ ë“±)ëŠ” ë°ì´í„°ì— í¬í•¨ëœ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.

[ê¸ˆì§€ ì‚¬í•­]
- ì»¨í…ìŠ¤íŠ¸ì— ì—†ëŠ” ìˆ˜ì¹˜ë‚˜ ê¸°ì¤€ì„ ì„ì˜ë¡œ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- "ì¼ë°˜ì ìœ¼ë¡œ", "ë³´í†µ", "ëŒ€ëµ" ë“± ëª¨í˜¸í•œ í‘œí˜„ ëŒ€ì‹  ì •í™•í•œ ìˆ˜ì¹˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ê±´ì„¤ ê´€ë ¨ì´ ì•„ë‹Œ ì§ˆë¬¸ì—ëŠ” "ê±´ì„¤ í’ˆì…ˆ ê´€ë ¨ ì§ˆë¬¸ì—ë§Œ ë‹µë³€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"ë¼ê³  ì‘ë‹µí•©ë‹ˆë‹¤.
- ë‹¨ìœ„ë¥¼ ì„ì˜ë¡œ ë°”ê¾¸ì§€ ì•ŠìŠµë‹ˆë‹¤. ì£¼ì–´ì§€ëŠ” ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ì”ë‹ˆë‹¤.
- ë§¤íŠ¸ë¦­ìŠ¤ êµì°¨í‘œë¥¼ 4ì—´ í”Œë« í…Œì´ë¸”(ì§ì¢…/ìˆ˜ëŸ‰/ë‹¨ìœ„/ê¸°ì¤€)ë¡œ ë¶„í•´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì»¨í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.`;

// Why: ì„ë² ë”©ì€ DB ë²¡í„° í˜¸í™˜ì„± ë•Œë¬¸ì— Gemini ìœ ì§€ (13,387ê°œ ì—”í‹°í‹° ì¬ì„ë² ë”© ë¶ˆê°€)
//       ë‹µë³€ ìƒì„±ë§Œ DeepSeek v3.2ë¡œ ì „í™˜

export async function generateAnswer(
    question: string,
    context: string,
    history: ChatMessage[],
    options?: AnswerOptions
): Promise<LLMResult> {
    // â”€â”€â”€ intentë³„ í”„ë¡¬í”„íŠ¸ ë™ì  ë¶€ì°© â”€â”€â”€
    let systemContent = SYSTEM_PROMPT;

    if (options?.intent === "cost_calculate") {
        systemContent += `\n\n[íŠ¹ë³„ ì§€ì¹¨: ë…¸ë¬´ë¹„ ì‚°ì¶œ]
ì‚¬ìš©ìê°€ ë…¸ë¬´ë¹„ / ì¸ê±´ë¹„ ê³„ì‚°ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.
1. í’ˆì…ˆ ì¸ë ¥ ë°ì´í„°(ì§ì¢…, ìˆ˜ëŸ‰, ë‹¨ìœ„)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë…¸ë¬´ë¹„ë¥¼ ì‚°ì¶œí•˜ì„¸ìš”.
2. ìˆ˜ëŸ‰ì´ ${options.quantity || 'ë¯¸ì§€ì •'}${options.quantity ? ` (${options.quantity})` : ''}ìœ¼ë¡œ ì£¼ì–´ì¡ŒìŠµë‹ˆë‹¤.
3. ë…¸ë¬´ë¹„ ì‚°ì¶œ í˜•ì‹(ë°˜ë“œì‹œ ì´ í…Œì´ë¸” í˜•íƒœë¡œ):
   | ì§ì¢… | íˆ¬ì…ì¸ì›(ì¸ / ê°œì†Œ) | ìˆ˜ëŸ‰ | ì´ íˆ¬ì…(M / D) | ë…¸ì„ë‹¨ê°€(ì› / ì¼) | ì†Œê³„(ì›) |
    4. ì»¨í…ìŠ¤íŠ¸ì—[2026ë…„ ë…¸ì„ë‹¨ê°€] ì„¹ì„ ì´ ìˆìœ¼ë©´ í•´ë‹¹ ë‹¨ê°€ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
5. í•©ê³„ í–‰ì„ ì¶”ê°€í•˜ê³ , ì´ ë…¸ë¬´ë¹„ë¥¼ êµµì€ ê¸€ì”¨ë¡œ í‘œê¸°í•˜ì„¸ìš”.
6. ìˆ˜ëŸ‰ì´ ë¯¸ì§€ì •ì´ë©´ "1ê°œì†Œë‹¹" ê¸°ì¤€ìœ¼ë¡œ ì‚°ì¶œí•˜ì„¸ìš”.`;
    }

    if (options?.intent === "report_request") {
        systemContent += `\n\n[íŠ¹ë³„ ì§€ì¹¨: ì‚°ì¶œì„œ í˜•íƒœ ì¶œë ¥]
ì‚¬ìš©ìê°€ ì‚°ì¶œì„œ / ë‚´ì—­ì„œë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.
1. ì •í˜•í™”ëœ ì‚°ì¶œ ë‚´ì—­ì„œ í˜•íƒœë¡œ ì¶œë ¥í•˜ì„¸ìš”.
2. í¬í•¨ í•­ëª©: í’ˆì…ˆ ì¶œì²˜(í‘œë²ˆí˜¸, ì ˆ), ê·œê²©, ì¸ë ¥ íˆ¬ì… í…Œì´ë¸”, ë…¸ë¬´ë¹„ ì‚°ì¶œ í…Œì´ë¸”, í•©ê³„
3. ìˆ˜ëŸ‰ì´ ${options.quantity || 'ë¯¸ì§€ì •'}ìœ¼ë¡œ ì£¼ì–´ì¡ŒìŠµë‹ˆë‹¤.
4. í‘œë²ˆí˜¸, ì¶œì²˜ ì •ë³´ë¥¼ ìƒë‹¨ì— ëª…ì‹œí•˜ì„¸ìš”.
5. ìµœì¢… í•©ê³„ ê¸ˆì•¡ì„ ê°•ì¡° í‘œì‹œí•˜ì„¸ìš”.`;
    }

    if (options?.quantity && options.intent !== "cost_calculate" && options.intent !== "report_request") {
        systemContent += `\n\n[ìˆ˜ëŸ‰ ì •ë³´]
ì‚¬ìš©ìê°€ ìˆ˜ëŸ‰ ${options.quantity}ì„ ì§€ì •í–ˆìŠµë‹ˆë‹¤.
í’ˆì…ˆ ì¸ë ¥ / ì¥ë¹„ ìˆ˜ëŸ‰ì— ì´ ê°’ì„ ê³±í•˜ì—¬ ì´ íˆ¬ì…ëŸ‰ì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”.`;
    }

    // â”€â”€â”€ DeepSeek ìš°ì„  ì‹œë„ â”€â”€â”€
    if (DEEPSEEK_API_KEY) {
        try {
            const messages = [
                { role: "system" as const, content: systemContent },
                ...history.slice(-5).map((msg) => ({
                    role: msg.role === "user" ? "user" as const : "assistant" as const,
                    content: msg.content,
                })),
                {
                    role: "user" as const,
                    content: `[ì§ˆë¬¸]\n${question} \n\n[ì°¸ê³  ë°ì´í„°]\n${context} `,
                },
            ];

            const response = await fetch(DEEPSEEK_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${DEEPSEEK_API_KEY} `,
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages,
                    temperature: 0.3,
                    max_tokens: 4096,
                }),
            });

            if (response.ok) {
                const data = await response.json();
                const answer = data.choices?.[0]?.message?.content ?? "ë‹µë³€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                const usage = data.usage || {};
                return {
                    answer,
                    inputTokens: usage.prompt_tokens || 0,
                    outputTokens: usage.completion_tokens || 0,
                };
            }
            console.error(`[generateAnswer] DeepSeek failed: ${response.status}, falling back to Gemini`);
        } catch (err) {
            console.error("[generateAnswer] DeepSeek error:", err, "falling back to Gemini");
        }
    }

    // â”€â”€â”€ Gemini í´ë°± â”€â”€â”€
    const GEMINI_LLM_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
    const contents = [
        ...history.slice(-5).map((msg) => ({
            role: msg.role === "user" ? "user" : "model",
            parts: [{ text: msg.content }],
        })),
        {
            role: "user",
            parts: [{ text: `[ì§ˆë¬¸]\n${question} \n\n[ì°¸ê³  ë°ì´í„°]\n${context} ` }],
        },
    ];

    const response = await fetch(`${GEMINI_LLM_URL}?key = ${GEMINI_API_KEY} `, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            system_instruction: { parts: [{ text: systemContent }] },
            contents,
            generationConfig: { temperature: 0.3, maxOutputTokens: 4096 },
        }),
    });

    if (!response.ok) {
        throw new Error(`LLM API failed: ${response.status} `);
    }

    const data = await response.json();
    const answer = data.candidates?.[0]?.content?.parts?.[0]?.text ?? "ë‹µë³€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
    const usage = data.usageMetadata || {};
    return {
        answer,
        inputTokens: usage.promptTokenCount || 0,
        outputTokens: usage.candidatesTokenCount || 0,
    };
}
