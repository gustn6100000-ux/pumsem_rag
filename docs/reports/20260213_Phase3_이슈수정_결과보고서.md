# Phase 3 이슈 수정 결과 보고서

**작성일**: 2026-02-13  
**대상**: `rag-chat/index.ts`, `rag-chat/index.html`  
**배포 버전**: v33

---

## 1. 수정 항목 요약

| #              | 이슈                                       | 수정 내용                                         | 상태   |
| -------------- | ------------------------------------------ | ------------------------------------------------- | ------ |
| **F-1**        | `graphClarify()` Step 2 ilike 오염         | `ilike baseSectionId%` → `eq sectionId` 정확 매칭 | ✅ 완료 |
| **F-2**        | `handleChat()` Phase -0.5 ilike 오염       | 동일 전략 적용                                    | ✅ 완료 |
| **F-1/2 보완** | base 보완(# 앞 매칭)이 다른 절과 충돌      | base 보완 로직 **완전 제거**                      | ✅ 완료 |
| **F-3**        | Phase 2-1 sectionOnly 블록 중복            | 복수 섹션→직접 칩 생성, 단일→sectionId 전달       | ✅ 완료 |
| **F-5**        | 프론트엔드 entityId/sectionId 미이스케이프 | `escapeHtml()` 적용                               | ✅ 완료 |

---

## 2. 핵심 변경 상세

### 2.1 F-1 + F-2: ilike → eq 정확 매칭 (+ base 보완 제거)

#### 문제
```
sectionId = "9-1-2#3" (기계설비부문 잡철물)
baseSectionId = "9-1-2"

ilike("source_section", "9-1-2%") 결과:
  ✅ W-1564 규격철물 설치_경량철재 (9-1-2#3) → 정확
  ❌ W-0003 1급 기준점 측량       (9-1-2)   → 토목부문 다른 절!
  ❌ W-2138 모르타르 바름          (9-1-2#2) → 건축부문 다른 절!
```

#### 추가 발견: base 보완도 충돌
```
eq("source_section", baseSectionId) = eq("source_section", "9-1-2")
→ W-0003 1급 기준점 측량 (토목부문) 여전히 매칭!

원인: "9-1-2"는 독립된 별도 절이지, "9-1-2#3"의 상위가 아님
```

#### 최종 결정: base 보완 완전 제거
```typescript
// 변경 전 (2단계)
ilike("source_section", `${baseSectionId}%`)  // 다른 절 오염

// 변경 중간 (eq + base 보완)
eq("source_section", sectionId)               // 정확
+ eq("source_section", baseSectionId)         // 다른 절 재오염!

// 최종 (eq 단독)
eq("source_section", sectionId)               // 정확 매칭만
```

### 2.2 F-3: sectionOnly 블록 리팩터링

#### 변경 전
```
Section만 매칭 → graphClarify(analysis) 재호출 (sectionId 없이)
→ DB 중복 검색 + section_id 누락 가능
```

#### 변경 후
```
Section만 매칭 → 분기:
  복수 섹션: 직접 칩 생성 (graph_chunks 메타 조회 1회만)
  단일 섹션: graphClarify(analysis, singleSectionId) 호출 (Step 2 직행)
  WT ≤ 3:   기존 흐름 계속 (Phase 2로 답변 생성)
```

---

## 3. 테스트 결과

### 시나리오 A: "잡철물 제작 품셈" (복수 섹션)

| 단계                             | 결과                                                          | 상태 |
| -------------------------------- | ------------------------------------------------------------- | ---- |
| Step 1                           | `type: "clarify"`, 2개 섹션 (건축 8-3-1#3, 기계설비 9-1-2#3)  | ✅    |
| Step 2 (`section_id: "9-1-2#3"`) | `type: "clarify"`, **6개** WorkType (수정 전 8개 → 오염 제거) | ✅    |
| Step 3 (WorkType 선택)           | `type: "answer"`, 정확한 품셈 데이터                          | ✅    |

### 수정 전후 Step 2 비교

| 항목                                  | 수정 전 | 수정 후          |
| ------------------------------------- | ------- | ---------------- |
| WorkType 수                           | 8개     | **6개**          |
| `W-0003 1급 기준점 측량` (토목 9-1-2) | ❌ 포함  | ✅ **제거**       |
| `W-2138 모르타르 바름` (건축 9-1-2#2) | ❌ 포함  | ✅ **제거**       |
| 모든 option source_section            | 혼재    | **전부 9-1-2#3** |

### 시나리오 B: 회귀 테스트

| 테스트                       | 결과                        | 상태        |
| ---------------------------- | --------------------------- | ----------- |
| "강관용접 200mm SCH 40 품셈" | `type: "answer"`, 정상 답변 | ✅ 회귀 없음 |

---

## 4. 적용 위치 참조

| 파일         | 함수                      | 수정 줄 (대략) | 변경                       |
| ------------ | ------------------------- | -------------- | -------------------------- |
| `index.ts`   | `graphClarify()` Step 2   | L908-922       | ilike → eq, base 보완 삭제 |
| `index.ts`   | `handleChat()` Phase -0.5 | L1582-1593     | ilike → eq, base 보완 삭제 |
| `index.ts`   | `handleChat()` Phase 2-1  | L1766-1853     | 복수/단일 분기 + eq 매칭   |
| `index.html` | chip 렌더링               | L924-925       | escapeHtml() 적용          |

---

## 5. 추가 점검 결과 (2차 코드 리뷰)

전체 코드 정밀 점검 + DB 데이터 쿼리 결과, 3건의 추가 이슈를 발견하여 2건을 수정했습니다.

### 수정 완료

| #       | 이슈                                                                                                    | 심각도 | 수정                                    |
| ------- | ------------------------------------------------------------------------------------------------------- | ------ | --------------------------------------- |
| **I-6** | `ChatRequest` 인터페이스에 `section_id` 미정의 → `(body as any)` 캐스팅 사용                            | 🟢 LOW  | `section_id?: string` 정식 추가         |
| **I-8** | Phase -0.5 `full_view` 요청 시 `graph_chunks`에 해당 section_id 없으면 무언의 Step 2 분기 (사용자 혼란) | 🟡 MED  | chunk 미발견 시 명시적 안내 메시지 반환 |

### 확인 완료 (이상 없음)

| 점검 항목                                     | 결과                                                 |
| --------------------------------------------- | ---------------------------------------------------- |
| `graphClarify` Step 1 전략 1-B `.in()` 정확성 | ✅ 동일 source_section에 다른 department 매핑 **0건** |
| `expandGraph` Section 타입 처리               | ✅ `eq source_section` 사용, 안전                     |
| 프론트엔드 `sendMessage()` 파라미터 전달      | ✅ `entity_id`, `section_id` 정상 전달                |
| `handleClarifyClick` optionType 분기          | ✅ section/full_view → sectionId, worktype → entityId |

### 관찰됨 (수정 불필요)

| #       | 이슈                                               | 심각도 | 상태                                                                                                 |
| ------- | -------------------------------------------------- | ------ | ---------------------------------------------------------------------------------------------------- |
| **I-7** | Section entity 중 `source_section` NULL 221건(18%) | 🟢 LOW  | `filter(Boolean)`으로 걸러짐. 모두 NULL인 극단 케이스에서는 Phase 2로 통과하여 답변 시도 (정상 동작) |

