# Quick Win 구현 결과 보고서

> **일시**: 2026-02-13 09:20~09:27  
> **범위**: Step6 클린 로드 로직 추가 + DB 고아 엔티티 정리

---

## 1. 배경 (문제)

Phase 2 파이프라인 실행 후 DB에 아래 문제가 확인됨:

| 문제 | 원인 | 수치 |
|---|---|---|
| 관계 누적 | `batch_insert`가 기존 행 삭제 없이 INSERT | 52,590 → 24,323 (수동 정리) |
| 고아 엔티티 | `batch_upsert`가 이전 데이터 미삭제 | 17,442 중 4,055건이 고아 |

---

## 2. 구현 내용

### 2.1 Step6 `--clean` 플래그 추가

**파일**: `phase2_extraction/step6_supabase_loader.py` (전체 재작성)

| 추가 항목 | 설명 |
|---|---|
| `clean_tables()` 함수 | FK 의존성 순서로 4개 테이블 전체 삭제 |
| `--clean` CLI 인자 | Phase 1 클린 단계 활성화 |
| `--clean --dry-run` | 삭제 건수 미리보기 (실제 삭제 안 함) |

**삭제 순서** (FK 의존성):
```
graph_relationships → graph_global_relationships → graph_entities → graph_chunks
```

**사용법**:
```bash
python step6_supabase_loader.py --clean           # 전체 삭제 후 적재
python step6_supabase_loader.py --clean --dry-run  # 미리보기
python step6_supabase_loader.py                    # 기존 동작 유지 (upsert/insert)
```

### 2.2 DB 고아 엔티티 정리

Supabase SQL로 직접 실행:

```sql
DELETE FROM graph_entities
WHERE id NOT IN (
  SELECT DISTINCT source_id FROM graph_relationships
  UNION
  SELECT DISTINCT target_id FROM graph_relationships
)
AND type NOT IN ('Section');
```

---

## 3. 결과

### DB 현황 (정리 후)

| 항목 | Before | After | 변동 |
|---|---|---|---|
| 엔티티 | 17,442 | **13,387** | -4,055 |
| 관계 | 24,323 | 24,323 | ±0 |
| 청크 | 2,105 | 2,105 | ±0 |

### 엔티티 타입별 분포 (정리 후)

| 타입 | 건수 |
|---|---|
| Note | 4,763 |
| WorkType | 4,733 |
| Section | 1,218 |
| Equipment | 1,016 |
| Material | 746 |
| Standard | 494 |
| Labor | 417 |

### 검증

| 항목 | 결과 |
|---|---|
| `--clean --dry-run` | ✅ 4개 테이블 건수 정상 출력, 실제 삭제 없음 |
| 고아 엔티티 SQL | ✅ 17,442 → 13,387 정상 감소 |

---

## 4. 참고 사항

> ⚠️ **인코딩 이슈**: PowerShell `Set-Content`가 한글 인코딩을 파손하여 `step6_supabase_loader.py` 전체 재작성. 향후 PowerShell로 한글 포함 파일 수정 시 `[System.IO.File]::WriteAllText()` 사용 권장.

> ⚠️ **임베딩 주의**: `--clean` 사용 시 `graph_chunks`도 삭제되므로 step7 (임베딩 생성) 재실행 필요.
