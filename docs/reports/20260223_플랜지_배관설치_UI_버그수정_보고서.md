# 20260223 — 플랜지 배관설치 UI 버그수정 보고서

> **작성일**: 2026-02-23  
> **수정 대상**: `frontend/index.html`, `edge-function/resolve.ts`  
> **배포 대상**: Cloudflare Pages (Frontend), Supabase Edge Functions (Backend)

---

## 1. 증상 요약

| #   | 증상                                                                                                                                       | 심각도       |
| --- | ------------------------------------------------------------------------------------------------------------------------------------------ | ------------ |
| 1   | 챗봇 메시지 영역이 좁아서 넓은 데이터 테이블이 화면을 채우지 못함                                                                          | Medium       |
| 2   | Selector Panel(체크박스 리스트)의 세로 높이가 `280px`로 고정되어 답답하게 표시됨                                                           | Medium       |
| 3   | "플랜지 배관설치" 검색 시 **"Flange 배관설치 — 규격 선택"** 이라는 잘못된 제목의 체크박스 패널이 표시됨 (실제 내용물은 "플랜트 배관 설치") | **Critical** |
| 4   | Cloudflare Pages에 GitHub push만으로 배포가 동기화되지 않는 문제                                                                           | Low          |
| 5   | Edge Function 재배포 시 `--no-verify-jwt` 플래그 누락으로 401 Unauthorized 발생                                                            | High         |

---

## 2. 원인 분석

### 2-1. 레이아웃 폭 제한 (증상 #1)

```css
/* 수정 전 */
.message {
    max-width: 1600px;  /* 고정 픽셀 → 와이드 모니터에서 여백 과다 */
}
```

**원인**: `.message` 클래스의 `max-width`가 `1600px`로 하드코딩되어 있어, 사용자의 와이드 모니터(2560px+)에서는 양쪽에 큰 여백이 남았음.

### 2-2. 체크박스 리스트 높이 제한 (증상 #2)

```css
/* 수정 전 */
.selector-items {
    max-height: 280px;  /* 5~6개 항목만 보이고 나머지는 스크롤 필요 */
}
```

**원인**: `.selector-items`의 `max-height`가 `280px`로 고정되어 15개 이상의 옵션이 있을 때 사용자가 스크롤해야 했음.

### 2-3. Selector Panel 제목 오류 — 핵심 버그 (증상 #3)

**발생 경로**:
1. 사용자가 **"플랜지 배관설치"** 입력
2. DeepSeek LLM이 의도 분석 → `work_name: "Flange 배관설치"`, `intent: "clarify_needed"` 반환
3. `graphClarify()` → `resolveSection()` 실행
4. DB에 "플랜지 배관설치"라는 정확한 엔티티가 **없음**
5. "배관설치"라는 부분 키워드로 Fallback → **"플랜트 배관 설치"** 항목 15건 매칭
6. `buildSelectorPanel()` 호출 시 **LLM이 반환한 `workName` ("Flange 배관설치")**을 그대로 제목에 사용
7. 결과: 내용물은 "플랜트"인데 제목은 "Flange"라고 표시되는 **의미적 충돌(Semantic Collision)**

```
┌─────────────────────────────────────────┐
│ 🔍 Flange 배관설치 — 규격 선택 (15개)  │  ← 잘못된 제목
├─────────────────────────────────────────┤
│ ☐ 플랜트 배관 설치(동, SCH 80)         │  ← 실제 내용은 "플랜트"
│ ☐ 플랜트 배관 설치(스텐레스강, SCH 100) │
│ ☐ 플랜트 배관 설치(스텐레스강, SCH 125) │
│ ...                                     │
└─────────────────────────────────────────┘
```

**근본 원인**: `buildSelectorPanel()` 함수가 DB 결과의 실제 공통 명칭(Base Name)을 분석하지 않고, LLM이 반환한 `workName`을 맹목적으로 제목에 사용한 것.

---

## 3. 수정 내역

### 3-1. 레이아웃 폭 확장 — `frontend/index.html`

| 항목                 | 수정 전  | 수정 후 |
| -------------------- | -------- | ------- |
| `.message` max-width | `1600px` | `96%`   |

```diff
 .message {
     display: flex;
     gap: 12px;
-    max-width: 1600px;
-    /* Increased from 1200px to better accommodate very wide data tables */
+    max-width: 96%;
+    /* Maximized layout width to dynamically fill 96% of the screen */
     width: 100%;
     margin: 0 auto;
     animation: msgIn 0.35s ease-out;
 }
```

**설계 의도**: 픽셀 고정값 대신 뷰포트 비율(%)을 사용하여 모니터 크기에 관계없이 동적으로 확장. 양쪽에 2%씩 여백을 남겨 시각적 여유 확보.

---

### 3-2. 체크박스 리스트 높이 확장 — `frontend/index.html`

| 항목                         | 수정 전 | 수정 후 |
| ---------------------------- | ------- | ------- |
| `.selector-items` max-height | `280px` | `60vh`  |

```diff
 .selector-items {
-    max-height: 280px;
+    max-height: 60vh;
+    /* Increased from 280px to utilize more vertical screen space */
     overflow-y: auto;
     padding: 6px 0;
 }
```

**설계 의도**: 화면 높이의 60%까지 리스트가 늘어나도록 하여 데스크탑 환경에서 15개 이상의 옵션도 스크롤 없이 한눈에 파악 가능.

---

### 3-3. Selector Panel 제목 정확도 개선 + 그룹핑 타당성 검사 — `edge-function/resolve.ts`

#### (A) Base Name 자동 추출 로직 추가

```typescript
// ─── 유효한 Base Name(공통 공종명) 추출 ───
const counts = new Map<string, number>();
let maxBaseName = workName;
let maxCount = 0;

for (const item of selectorItems) {
    // "플랜트 배관 설치(동, SCH 80)" -> "플랜트 배관 설치" 추출
    let rawName = item.label;
    // 접두어 "[기계부문 > ...]" 제거
    if (rawName.includes('] ')) {
        rawName = rawName.substring(rawName.indexOf('] ') + 2).trim();
    }
    // 괄호 규격 부분 이전 텍스트 추출
    const match = rawName.match(/^([^()]+)\s*\(/);
    const baseName = match ? match[1].trim() : rawName;

    const c = (counts.get(baseName) || 0) + 1;
    counts.set(baseName, c);
    if (c > maxCount) {
        maxCount = c;
        maxBaseName = baseName;
    }
}
```

**동작**: 각 항목의 라벨에서 괄호 앞의 공통 명칭(Base Name)을 추출하여, 가장 많이 등장하는 Base Name을 `maxBaseName`으로 선정. 이 값이 Selector Panel 제목에 사용됨.

#### (B) 그룹핑 타당성 검사 (Selector Panel Abort 조건)

```typescript
// 공통 BaseName 부족 시 Selector Panel 취소 → 일반 칩스(chips)로 폴백
if (!forceSelector && maxCount < 4 && maxCount < selectorItems.length * 0.4) {
    console.log(`[buildSelectorPanel] 공통 BaseName 부족. Selector Panel 취소.`);
    return undefined;
}
```

**동작**: 검색 결과가 서로 다른 품셈 항목들의 잡다한 모음(예: "플랜트 배관 설치" + "Flange 취부" + "강관 절단" 등)일 경우, 이를 억지로 하나의 체크박스 패널로 묶지 않고 기존 칩(버튼) 형태로 자연스럽게 표시.

| 조건                      | 판정                                     |
| ------------------------- | ---------------------------------------- |
| `maxCount >= 4`           | Selector Panel 생성 (공통 항목 충분)     |
| `maxCount >= items * 0.4` | Selector Panel 생성 (40% 이상 동일 계열) |
| 그 외                     | Panel 취소 → 일반 칩스 폴백              |

#### (C) 제목 생성 변경

```diff
 return {
-    title: `${workName} — 규격 선택`,
+    title: `${maxBaseName} — 규격 선택`,
     filters,
     items: selectorItems,
     original_query: workName,
 };
```

---

## 4. 배포 이력

| 시간  | 대상     | 명령어                                                   | 비고                                   |
| ----- | -------- | -------------------------------------------------------- | -------------------------------------- |
| 00:12 | Frontend | `npx wrangler pages deploy frontend`                     | 폭 확장 (96%)                          |
| 00:33 | Frontend | `npx wrangler pages deploy frontend`                     | 체크박스 높이 확장 (60vh)              |
| 00:42 | Backend  | `npx supabase functions deploy rag-chat --no-verify-jwt` | Selector Panel 제목 수정 + 그룹핑 검사 |

> ⚠️ **주의**: Edge Function 배포 시 반드시 `--no-verify-jwt` 플래그를 사용해야 합니다.  
> 이 플래그가 누락되면 프론트엔드에서 `x-api-key` 헤더로 인증하는 현재 방식이 차단되어 **401 Unauthorized** 오류가 발생합니다.

---

## 5. 검증 결과

### 테스트 쿼리: "플랜지 배관설치"

| 항목        | 수정 전                              | 수정 후                      |
| ----------- | ------------------------------------ | ---------------------------- |
| UI 형태     | 체크박스 SelectorPanel               | 칩(Chips) 버튼 리스트        |
| 제목        | "Flange 배관설치 — 규격 선택 (15개)" | 해당 없음 (칩 형태)          |
| 항목 수     | 15개 (플랜트만)                      | 23개 분야 (다양한 배관 품셈) |
| 사용자 혼란 | ❌ 높음 (Flange ≠ 플랜트)             | ✅ 없음 (정직한 검색 결과)    |

### 테스트 쿼리: "플랜트 배관설치" (정상 케이스 — 영향 없음 확인)

이 쿼리는 DB에 정확히 존재하는 항목이므로, `maxCount = 15`로 40% 임계값을 충족 → 기존과 동일하게 SelectorPanel 정상 표시됨.

---

## 6. 영향 범위

| 파일                       | 변경 유형                        | 영향                                                                                                                                                             |
| -------------------------- | -------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `frontend/index.html`      | CSS 수정                         | 레이아웃 폭/높이만 변경. 기능 영향 없음                                                                                                                          |
| `edge-function/resolve.ts` | `buildSelectorPanel()` 로직 추가 | Selector Panel 생성 조건이 **더 엄격해짐**. 기존 정상 케이스(동일 공종명 항목 묶음)에는 영향 없음. Fallback 검색처럼 찾은 항목이 제각각인 경우에만 칩으로 전환됨 |

> **Side Effect 경고 (A3)**: `buildSelectorPanel`의 새 임계값(`maxCount < 4 && maxCount < items * 0.4`)에 의해, 정상적인 소규모 그룹(3개 이하 공통 항목)도 칩으로 전환될 수 있습니다. 단, 기존 조건(`selectorItems.length < 6`)이 먼저 적용되므로 6개 미만 결과에서는 이미 칩이 사용되어 실질적 영향은 없습니다.
