# Phase 2 파이프라인 실행 결과 보고서

> **실행일**: 2026-02-13  
> **LLM 모델**: DeepSeek-V3 (`deepseek-chat`) — Gemini에서 전환  
> **DB**: Supabase (`bfomacoarwtqzjfxszdr`)

---

## 1. LLM 모델 전환 (Gemini → DeepSeek-V3)

### 변경 파일

| 파일 | 변경 내용 |
|---|---|
| `.env` | `DEEPSEEK_API_KEY` 추가 (기존 `GEMINI_API_KEY` 유지 — 임베딩용) |
| `config.py` | `LLM_MODEL` → `"deepseek-chat"` |
| `step2_llm_extractor.py` | `google.genai` → `openai.OpenAI` (base_url: `api.deepseek.com`) |
| `step5_extraction_validator.py` | E5 감사: Gemini → DeepSeek 동일 패턴 전환 |

### 변경하지 않은 파일

| 파일 | 이유 |
|---|---|
| `step7_embedding_generator.py` | Gemini 임베딩 모델 (`gemini-embedding-001`) 사용 — DeepSeek은 임베딩 API 미제공 |
| `rag-chat` Edge Function | Gemini 임베딩 + `gemini-2.0-flash` LLM 답변 생성 (별도 서비스) |

---

## 2. 파이프라인 단계별 실행 결과

### Step 1 — 테이블 추출 (`step1_table_extractor.py`)

| 항목 | 값 |
|---|---|
| 추출 엔티티 | **18,218** |
| 커버리지 | 82.7% |

### Step 2 — LLM 추출 (`step2_llm_extractor.py`)

| 항목 | 값 |
|---|---|
| 처리 청크 | **1,702 / 1,702** |
| 추출 엔티티 | **18,826** |
| 추출 관계 | **17,043** |
| 성공률 | 1,701 / 1,702 (1건 실패) |
| 사용 모델 | `deepseek-chat` (이전 Gemini 결과 재활용) |

**엔티티 유형 분포:**

| 유형 | 수량 |
|---|---:|
| WorkType | 5,061 |
| Note | 4,714 |
| Equipment | 3,260 |
| Labor | 3,093 |
| Material | 1,666 |
| Standard | 1,032 |

### Step 3 — 관계 생성 & 병합 (`step3_relation_builder.py`)

| 항목 | 값 |
|---|---|
| 병합 전 엔티티 | 37,044 → **32,934** (중복 제거 4,110) |
| 병합 전 관계 | 26,685 → **26,056** (중복 제거 629) |
| Section 엔티티 | 708 |
| BELONGS_TO 관계 | 5,234 |
| HAS_CHILD 관계 | 1,063 |
| REFERENCES 관계 | 2 |
| **최종 엔티티** | **33,298** |
| **최종 관계** | **31,593** |

### Step 4 — 정규화 (`step4_normalizer.py`)

| 항목 | 값 |
|---|---|
| 정규화 후 엔티티 | **16,983** |
| 정규화 후 관계 | **27,358** |
| 감소율 | **49.5%** |

**정규화 후 엔티티 분포:**

| 유형 | 수량 |
|---|---:|
| Note | 6,050 |
| WorkType | 5,374 |
| Equipment | 1,695 |
| Material | 1,641 |
| Section | 1,218 |
| Standard | 543 |
| Labor | 462 |

### Step 5 — 품질 검증 (`step5_extraction_validator.py`)

| 항목 | 결과 | 상세 |
|---|---|---|
| E1 엔티티 커버리지 | ✅ PASS | ≥ 90% |
| E2 관계 참조 무결성 | ✅ PASS | |
| E3 수량-단위 완전성 | ✅ PASS | |
| E4 고아 노드 비율 | ✅ PASS | 21.5% ≤ 30% |
| E5 LLM 샘플 감사 | ⏭️ SKIP | `--skip-e5` 플래그 사용 |
| E6 할루시네이션 | ❌ FAIL | 46.3% > 40% (LLM추론 67건, 진짜 의심 26건) |

> **E6 FAIL 분석**: 대부분 LLM이 테이블 코드에서 장비/자재명을 추론한 것(67건)이며, 진짜 의심스러운 것은 26건에 불과함. 이전 실행에서도 동일한 패턴.

### Step 6 — Supabase 적재 (`step6_supabase_loader.py`)

| 항목 | 값 |
|---|---|
| 엔티티 적재 | 16,983 / 16,983 ✅ |
| 관계 적재 | 26,295 / 26,295 ✅ |
| 전역 관계 적재 | 1,063 / 1,063 ✅ |
| 청크 적재 | 2,105 / 2,105 ✅ |
| FK 검증 | 고아 관계 **0건** |

### Step 7 — 임베딩 생성 (`step7_embedding_generator.py`)

| 항목 | 값 |
|---|---|
| 모델 | `gemini-embedding-001` (768차원) |
| 엔티티 임베딩 | 17,442 / 17,442 ✅ (100%) |
| 청크 임베딩 | 2,105 / 2,105 ✅ (100%) |

### DB 정리 (데이터 정합성)

| 작업 | 상세 |
|---|---|
| 관계 중복 제거 | 52,590 → **24,323** (이전 적재 누적분 제거) |
| 고아 엔티티 | 4,491건 (이전 데이터 잔여 + 정상적 고아 노드 혼합) |

---

## 3. 최종 Supabase DB 현황

| 테이블 | 건수 | 임베딩 |
|---|---:|---|
| `graph_entities` | 17,442 | ✅ 100% |
| `graph_relationships` | 24,323 | - |
| `graph_chunks` | 2,105 | ✅ 100% |

---

## 4. RAG 챗봇 검증

### 테스트 환경
- **Edge Function**: `rag-chat` v14
- **임베딩**: Gemini `gemini-embedding-001`
- **LLM 답변**: Gemini `gemini-2.0-flash`

### 테스트 결과

| 질의 | 엔티티 | 관계 확장 | 청크 | 응답 시간 | 비용 |
|---|---:|---:|---:|---|---|
| 강관용접 품셈 | 5 | 다수 | 3 | ~3초 | ₩0.5~1 |
| 콘크리트 타설 품셈 | 5 | 117 | 3 | **2.7초** | **₩0.68** |

### "강관용접 품셈" 응답 검증

- ✅ 규격별(SCH 40/80/160) 데이터 분리 출력
- ✅ 투입 인력: 플랜트용접공, 특별인부 (수량 포함)
- ✅ 장비: 용접기 (인력할당율)
- ✅ 자재: 용접봉(kg), 산소(L), LPG(kg)
- ✅ 주의사항: 비파괴검사, Back Mirror/Ring, Nozzle 용접 가산 등
- ✅ 표번호 [표 13-2-3] 출처 정상 표기

---

## 5. 파이프라인 흐름도

```
[PDF 원문]
    ↓
Step 1: 테이블 추출 (regex/rule) ──→ 18,218 엔티티
    ↓
Step 2: LLM 추출 (DeepSeek-V3) ──→ 18,826 엔티티 + 17,043 관계
    ↓
Step 3: 병합 & 관계 생성 ────────→ 33,298 엔티티 + 31,593 관계
    ↓
Step 4: 정규화 & 중복 제거 ──────→ 16,983 엔티티 + 27,358 관계 (49.5%↓)
    ↓
Step 5: 품질 검증 (E1~E6) ──────→ 4/5 PASS
    ↓
Step 6: Supabase 적재 ────────→ 엔티티 + 관계 + 청크 upsert/insert
    ↓
Step 7: 임베딩 생성 (Gemini) ──→ 768차원 벡터 100% 완료
    ↓
[RAG 챗봇] ← Edge Function (rag-chat v14) ← 사용자 질의
```

---

## 6. 향후 개선 사항

1. **Step6 TRUNCATE 추가**: 재실행 시 관계 누적 방지를 위해 적재 전 기존 데이터 삭제 로직 추가 필요
2. **E6 할루시네이션 개선**: 임계값 조정 또는 LLM 추론 항목 별도 분류 로직 추가
3. **DeepSeek 기반 재추출**: 현재 Step2 결과는 이전 Gemini 세션의 결과를 재활용. 순수 DeepSeek 재추출 시 품질 비교 필요
4. **RAG Edge Function LLM 전환**: 현재 답변 생성에 Gemini `2.0-flash` 사용 중 — DeepSeek 전환 검토 가능
