# Phase 2 DB 적재 & 임베딩 실행 결과 보고서

> **작성일**: 2026-02-12 (수) 20:39  
> **선행 보고서**: `20260212_Phase2_파이프라인_재실행_결과보고서.md` (step1~step5)  
> **실행 계획서**: `20260212_Phase2_DB적재_RAG검증_실행계획서.md`  

---

## 1. 실행 요약

| 단계                             | 시각        |     소요 | 결과                |
| -------------------------------- | ----------- | -------: | ------------------- |
| Phase 1-1: DB 현황 확인          | 20:34       |     즉시 | ✅ 완료              |
| Phase 1-2: 관계 테이블 TRUNCATE  | 20:34       |     즉시 | ✅ 잔존 0건          |
| Phase 1-3: step6 Dry Run         | 20:34       |      1초 | ✅ FK orphan 0건     |
| **Phase 2: step6 DB 적재**       | 20:35~20:36 | **92초** | ✅ 전량 성공, 에러 0 |
| Phase 3-1: step7 Dry Run         | 20:37       |      2초 | ✅ 대상 1,078건 확인 |
| **Phase 3-2: step7 임베딩 생성** | 20:37~20:37 | **26초** | ✅ 전량 성공, 에러 0 |
| Phase 3-3: 최종 DB 상태 확인     | 20:38       |     즉시 | ✅ NULL 0건          |

---

## 2. Phase 1: 사전 준비

### 2-1. 기존 DB 현황 (TRUNCATE 전)

| 테이블                     |  행 수 | 임베딩 상태           |
| -------------------------- | -----: | --------------------- |
| graph_entities             | 16,424 | 16,364 완료 / 60 NULL |
| graph_relationships        | 23,630 | —                     |
| graph_global_relationships |  1,063 | —                     |
| graph_chunks               |  2,105 | 2,105 완료 / 0 NULL   |

### 2-2. 관계 테이블 초기화

- `graph_relationships`: 23,630건 삭제 → 잔존 0건
- `graph_global_relationships`: 1,063건 삭제 → 잔존 0건
- **방법**: `delete().neq("id", -99999999)` (Supabase Python SDK)
- **이유**: step6은 관계를 `INSERT`로 적재하므로 기존 데이터가 남아있으면 중복 발생

### 2-3. step6 Dry Run 결과

```
entities: 17,091건
extractions: 2,105개
entity_ids: 17,091개
FK 검증: valid=26,423, orphaned=0   ← 모든 관계가 유효
```

---

## 3. Phase 2: Step 6 — Supabase 데이터 적재

### 3-1. 실행 명령

```bash
py phase2_extraction/step6_supabase_loader.py
```

### 3-2. 적재 결과

| 내부 Phase | 테이블                     | 방식                |   건수 | 결과 |
| ---------- | -------------------------- | ------------------- | -----: | ---- |
| Phase 2    | graph_entities             | upsert (500건/배치) | 17,091 | ✅ OK |
| Phase 3    | graph_relationships        | insert (500건/배치) | 26,423 | ✅ OK |
| Phase 4    | graph_global_relationships | insert (500건/배치) |  1,063 | ✅ OK |
| Phase 5    | graph_chunks               | upsert (200건/배치) |  2,105 | ✅ OK |

**소요 시간**: 92.1초  
**에러**: 0건  
**FK orphaned**: 0건

### 3-3. 관계 유형별 분포

| 관계 유형          |       건수 |
| ------------------ | ---------: |
| REQUIRES_LABOR     |     10,180 |
| HAS_NOTE           |      6,161 |
| BELONGS_TO         |      5,183 |
| REQUIRES_EQUIPMENT |      2,214 |
| USES_MATERIAL      |      1,830 |
| APPLIES_STANDARD   |        855 |
| **관계 합계**      | **26,423** |

### 3-4. 전역 관계 분포

| 관계 유형     |      건수 |
| ------------- | --------: |
| HAS_CHILD     |     1,061 |
| REFERENCES    |         2 |
| **전역 합계** | **1,063** |

### 3-5. 엔티티 유형별 분포

| 엔티티 유형     |       건수 |
| --------------- | ---------: |
| Note            |      6,050 |
| WorkType        |      5,482 |
| Equipment       |      1,695 |
| Material        |      1,641 |
| Section         |      1,218 |
| Standard        |        543 |
| Labor           |        462 |
| **엔티티 합계** | **17,091** |

---

## 4. Phase 3: Step 7 — 임베딩 생성

### 4-1. Dry Run 결과

| 대상           | embedding IS NULL | 비고        |
| -------------- | ----------------: | ----------- |
| graph_entities |       **1,078건** | 신규 추가분 |
| graph_chunks   |           **0건** | 이미 완료   |

**핵심 관찰**: step6에서 `upsert`할 때 기존 엔티티의 embedding 컬럼은 보존됨. 따라서 신규 추가된 1,078건만 임베딩 API 호출 필요.

### 4-2. 임베딩 실행 결과

```bash
py phase2_extraction/step7_embedding_generator.py
```

| 대상           |  건수 |      성공 | 스킵 | 에러 |
| -------------- | ----: | --------: | ---: | ---: |
| graph_entities | 1,078 | **1,078** |    0 |    0 |
| graph_chunks   |     0 |         0 |    0 |    0 |

**소요 시간**: 26.2초  
**API 호출**: ~11회 (100건/배치)  
**모델**: gemini-embedding-001 (768차원)

### 4-3. 비용

- Gemini embedding-001: 1,078건 × ~50 토큰/건 ≈ 53,900 토큰
- **예상 비용**: 무료 티어 범위 (~$0.005 이하)
- step2 LLM 추출(1,702회 × Gemini 3.0 Flash)과 비교하면 **무시할 수 있는 수준**

---

## 5. 최종 DB 상태 (적재 + 임베딩 후)

| 테이블                     |   이전 |       현재 | 변화               |
| -------------------------- | -----: | ---------: | ------------------ |
| graph_entities             | 16,424 | **17,442** | +1,018 (+6.2%)     |
| graph_relationships        | 23,630 | **26,423** | 전체 교체 (+11.8%) |
| graph_global_relationships |  1,063 |  **1,063** | 전체 교체 (동일)   |
| graph_chunks               |  2,105 |  **2,105** | upsert (동일)      |

### 임베딩 완료 상태

| 테이블         |   전체 | 임베딩 완료 |  NULL |
| -------------- | -----: | ----------: | ----: |
| graph_entities | 17,442 |  **17,442** | **0** |
| graph_chunks   |  2,105 |   **2,105** | **0** |

> **참고**: `graph_entities`가 17,442로 `normalized_entities.json`의 17,091보다 351건 많은 것은, 이전 적재에서 존재했으나 이번 추출에서 생성되지 않은 엔티티가 DB에 잔존하기 때문. upsert는 기존 행을 삭제하지 않으므로 이전 데이터가 보존됨.

---

## 6. 로그 파일 목록

| 파일                                       | 크기   | 설명              |
| ------------------------------------------ | ------ | ----------------- |
| `logs/step6_loader_20260212_203415.log`    | 2.7 KB | step6 Dry Run     |
| `logs/step6_loader_20260212_203517.log`    | 4.3 KB | step6 실행 (LIVE) |
| `logs/step6_summary_20260212_203650.json`  | —      | step6 결과 JSON   |
| `logs/step7_embedding_20260212_203709.log` | 2.3 KB | step7 Dry Run     |
| `logs/step7_embedding_20260212_203729.log` | 1.7 KB | step7 실행 (LIVE) |
| `logs/step7_summary_20260212_203755.json`  | —      | step7 결과 JSON   |

---

## 7. 다음 단계

- [ ] **Phase 4: RAG 챗봇 검증** — TC-1~7 (강관용접 테스트 케이스)
- [ ] 검증 결과에 따라 PASS/PARTIAL/FAIL 판정
- [ ] 최종 보고서 업데이트
