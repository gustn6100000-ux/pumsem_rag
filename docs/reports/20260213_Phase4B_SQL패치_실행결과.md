# Phase 4B SQL 데이터 패치 — 실행 결과 보고서

> **일시**: 2026-02-13 23:55 KST  
> **대상**: Supabase `bfomacoarwtqzjfxszdr` / `graph_entities`, `graph_chunks`  
> **범위**: section `13-2-4` (강판 전기아크용접) — 124 WorkType + 14 Chunks

---

## 1. 실행 요약

| 단계 | 작업                                          | 건수                            | 상태 |
| ---- | --------------------------------------------- | ------------------------------- | ---- |
| 4B-0 | 백업 테이블 생성                              | 엔티티 157 + 관계 594 + 청크 14 | ✅    |
| 4B-2 | `SCH` → `두께` 변환                           | 124건 name + spec               | ✅    |
| 4B-1 | V형/U형 `welding_type` 태깅                   | V형 41 + U형 83 = 124건         | ✅    |
| 4B-3 | Chunk 텍스트 보강 (text=0 → 최소 식별 텍스트) | B~L: 11건(V형), M~N: 2건(U형)   | ✅    |

---

## 2. 구현계획서와의 차이

> [!IMPORTANT]
> 구현계획서(4B-1)에서는 `source_chunk` 필드로 V형/U형을 구분할 계획이었으나, **실제 데이터에서 124건 전부 `source_chunk = null`**이었습니다.

### 대체 전략: 항목 이름 패턴 + 두께 범위 기반 분류

| 패턴                   | 유형 | 근거                                                       |
| ---------------------- | ---- | ---------------------------------------------------------- |
| `용접봉사용량`         | V형  | 원본 PDF "1. 전기아크용접(V형)" 테이블에만 존재하는 항목명 |
| `소요전력` + 두께 ≤15  | V형  | V형 테이블 범위: 3~15mm                                    |
| `인 력(인)` (공백 有)  | V형  | V형 추출 시 공백 포함된 형태                               |
| `하향용접` + 두께 = 15 | V형  | V형에서 15mm에만 두께별 용접 자세 데이터 존재              |
| `용접봉소비량`         | U형  | "2. 전기아크용접(U형)" 테이블에만 존재하는 항목명          |
| `전력소비량`           | U형  | U형 고유 항목명                                            |
| `인력(인)` (공백 無)   | U형  | U형 추출 시 공백 없는 형태                                 |
| `소요전력` + 두께 ≥16  | U형  | V형은 15mm까지만 소요전력 존재                             |
| `하향용접` + 두께 ≥16  | U형  | U형에서 16mm 이상 두께에 자세별 데이터 존재                |

---

## 3. 검증 결과

### 3.1 DB Before/After 비교

| 지표                       | 패치 전 | 패치 후     |
| -------------------------- | ------- | ----------- |
| `name LIKE '%, SCH %'`     | 124     | **0** ✅     |
| `welding_type IS NOT NULL` | 0       | **124** ✅   |
| chunk `length(text) > 0`   | 1/14    | **14/14** ✅ |

### 3.2 챗봇 라이브 테스트

- **쿼리**: `"강판 전기아크용접 두께 10 인력 품셈"`
- **결과**: `STATUS=200`, `TYPE=answer`, `entities_found=5`, `answer=3,611자`
- **지연**: 71.5초 (LLM 응답 생성 시간 포함, Phase 4B와 무관)

---

## 4. 롤백 방법

백업 테이블 3개가 존재합니다:
- `_backup_4b_graph_entities`
- `_backup_4b_graph_relationships`
- `_backup_4b_graph_chunks`

```sql
-- 롤백 실행
DELETE FROM graph_entities WHERE source_section = '13-2-4';
INSERT INTO graph_entities SELECT * FROM _backup_4b_graph_entities;
DELETE FROM graph_relationships WHERE source_id IN (SELECT id FROM _backup_4b_graph_entities);
INSERT INTO graph_relationships SELECT * FROM _backup_4b_graph_relationships;
DELETE FROM graph_chunks WHERE id LIKE 'C-0956%';
INSERT INTO graph_chunks SELECT * FROM _backup_4b_graph_chunks;
```

---

## 5. 남은 작업

| 항목                                                    | Phase | 상태                                       |
| ------------------------------------------------------- | ----- | ------------------------------------------ |
| 13-2-4 외 나머지 SCH 포함 섹션 (41개, 1,147건)          | 4C    | 미처리 — 각 섹션별 SCH 적절성 확인 필요    |
| Python 파이프라인 수정 (`step1_table_extractor.py`)     | 4C    | 미처리 — 별도 세션 권장                    |
| 데이터 정합성 검증 스크립트 (`step6_data_validator.py`) | 4C    | 미작성                                     |
| 임베딩 재생성 (이름 변경된 124건)                       | 후속  | 검토 필요 — 현재 벡터와 텍스트 불일치 가능 |
