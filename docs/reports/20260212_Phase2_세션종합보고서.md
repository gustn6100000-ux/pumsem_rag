# Phase 2 세션 종합 보고서 (2026-02-12)

> **세션 시간**: 2026-02-12 (수) 14:00 ~ 20:50  
> **작업 범위**: step1~step7 재실행 + RAG 챗봇 검증  
> **판정**: ⚠️ **PARTIAL** — DB 적재 성공, RAG 검증 실패 (데이터 중복 이슈)

---

## 1. 세션 타임라인

| 시각  | 작업                                          | 결과                    |
| ----- | --------------------------------------------- | ----------------------- |
| 14:00 | step1~step5 파이프라인 재실행 계획 수립       | ✅                       |
| 14:30 | step1 테이블 추출 (매트릭스 D 패턴 교정 반영) | ✅ 18,218 엔티티         |
| 15:00 | step2 LLM 추출 (중복 배제 교정 반영)          | ✅ 1,702 청크, ~65분     |
| 16:30 | step3 병합 (테이블 수치 우선 교정 반영)       | ✅ 33,298 엔티티         |
| 17:00 | step4 정규화                                  | ✅ 17,091 엔티티         |
| 17:30 | step5 검증                                    | ⚠️ 4/6 PASS (E5/E6 FAIL) |
| 18:00 | 재실행 결과 보고서 작성                       | ✅                       |
| 20:30 | DB 적재 실행 계획서 작성                      | ✅                       |
| 20:34 | **step6** DB 적재 (Dry Run → TRUNCATE → 실행) | ✅ 92초, 에러 0          |
| 20:37 | **step7** 임베딩 생성 (1,078건)               | ✅ 26초, 에러 0          |
| 20:40 | **RAG 챗봇 검증** TC-1~6                      | ❌ 0/5 PASS              |
| 20:45 | 원인 분석 (φ 중복 엔티티 발견)                | ✅ 근본 원인 특정        |
| 20:50 | 검증 결과 보고서 작성                         | ✅                       |

---

## 2. 실행 결과 종합

### 2-1. 파이프라인 결과 (step1~step5)

| 단계            |     출력 건수 | 결과 | 교정 사항                |
| --------------- | ------------: | ---- | ------------------------ |
| step1 규칙 추출 | 18,218 엔티티 | ✅    | P2: 매트릭스 테이블 추출 |
| step2 LLM 추출  |    1,702 청크 | ✅    | 중복 청크 배제           |
| step3 병합      | 33,298 엔티티 | ✅    | P3: 테이블 수치 우선     |
| step4 정규화    | 17,091 엔티티 | ✅    | —                        |
| step5 검증      |      4/6 PASS | ⚠️    | E5/E6 FAIL (LLM 품질)    |

### 2-2. DB 적재 결과 (step6~step7)

| 테이블                     |   이전 |       현재 | 변화        |
| -------------------------- | -----: | ---------: | ----------- |
| graph_entities             | 16,424 | **17,442** | +1,018      |
| graph_relationships        | 23,630 | **26,423** | 전체 교체   |
| graph_global_relationships |  1,063 |  **1,063** | 전체 교체   |
| graph_chunks               |  2,105 |  **2,105** | 동일        |
| **임베딩 NULL**            | **60** |      **0** | ✅ 전량 완료 |

- step6 소요: 92초, 에러 0건
- step7 소요: 26초, API 호출 ~11회, 비용 ~$0
- 임베딩 대상: **1,078건**만 (기존 임베딩 보존)

### 2-3. RAG 챗봇 검증 결과

| TC   | 질문                  | 기대                   | 실제               | 판정 |
| ---- | --------------------- | ---------------------- | ------------------ | ---- |
| TC-1 | 강관용접 200mm SCH 40 | 플랜트용접공 **0.287** | SCH 120 0.557 반환 | ❌    |
| TC-2 | 강관용접 200mm SCH 20 | **용접공** 0.287       | —                  | ❌    |
| TC-3 | 강관용접 200mm SCH 80 | 플랜트용접공 **0.362** | —                  | ❌    |
| TC-5 | 강관용접 φ15 SCH 80   | 플랜트용접공 **0.075** | —                  | ❌    |
| TC-6 | 강관용접 φ350 SCH 20  | **용접공** 0.442       | —                  | ❌    |

---

## 3. 근본 원인 분석

### 3-1. 엔티티 φ 접두사 중복 문제

DB에 동일 물리 대상에 대해 **2벌의 엔티티**가 존재:

```
강관용접(200, SCH 40)   ← step1 D1 패턴 추출 → 수치 정확 ✅
강관용접(φ200, SCH 40)  ← step2 LLM 추출     → 수치 부정확 ❌
```

**검증 결과**:

| 엔티티 (φ 없음)       |      수량 | 정확? | 엔티티 (φ 있음)        |  수량 | 정확? |
| --------------------- | --------: | ----- | ---------------------- | ----: | ----- |
| 강관용접(200, SCH 40) | **0.287** | ✅     | 강관용접(φ200, SCH 40) | 0.294 | ❌     |
| 강관용접(200, SCH 20) | **0.287** | ✅     | 강관용접(φ200, SCH 20) | 0.244 | ❌     |

### 3-2. 발생 경로

```
step1 → "강관용접(200, SCH 40)" (D1 패턴, 정확)
step2 → "강관용접(φ200, SCH 40)" (LLM, φ 추가 + 부정확한 수치)
         ↓
step3 → 이름이 다르므로 별도 엔티티로 보존 (병합 실패)
         ↓
step4 → normalize_name()에 φ 정규화 없음 → 중복 제거 안 됨
         ↓
step6 → 2벌 모두 DB 적재
         ↓
벡터 검색 → φ 버전이 더 높은 유사도 → 부정확한 값 반환
```

### 3-3. 문제의 좌표

- **파일**: `step4_normalizer.py` → `normalize_name()` (라인 89~113)
- **문제**: φ/Φ/ø/∅ 접두사 정규화 로직 없음
- **영향 범위**: 강관용접뿐 아니라 φ 접두사를 사용하는 모든 배관/관련 엔티티

---

## 4. 이번 세션 생성 산출물

### 문서 (docs/)

| #   | 파일명                                            | 내용                                |
| --- | ------------------------------------------------- | ----------------------------------- |
| 1   | `20260212_Phase2_파이프라인_재실행_결과보고서.md` | step1~5 재실행 과정 및 결과 (632줄) |
| 2   | `20260212_Phase2_DB적재_RAG검증_실행계획서.md`    | step6~7 + RAG 검증 계획             |
| 3   | `20260212_Phase2_DB적재_임베딩_실행결과.md`       | step6/7 실행 결과                   |
| 4   | `20260212_Phase4_RAG검증_결과보고서.md`           | RAG 검증 FAIL 원인 분석             |
| 5   | **`20260212_Phase2_세션종합보고서.md`**           | 본 문서 (전체 종합)                 |

### 스크립트

| 파일                | 용도                           | 유지/삭제 |
| ------------------- | ------------------------------ | --------- |
| `_backup_phase2.py` | phase2_output 백업             | 유지      |
| `_check_step1.py`   | step1 결과 확인                | 삭제 가능 |
| `_check_step3.py`   | step3 결과 확인                | 삭제 가능 |
| `_db_check.py`      | DB 건수/임베딩 확인 + TRUNCATE | 유지      |
| `_db_debug.py`      | 강관용접 엔티티 검색           | 삭제 가능 |
| `_db_verify.py`     | 관계 수치 정확도 검증          | 유지      |
| `_test_rag.py`      | RAG 챗봇 TC 자동 검증          | 유지      |
| `_test_tc1.py`      | TC-1 상세 응답 확인            | 삭제 가능 |

### 로그 (phase2_output/logs/)

| 파일                                  | 내용                          |
| ------------------------------------- | ----------------------------- |
| `step6_loader_20260212_203415.log`    | step6 Dry Run                 |
| `step6_loader_20260212_203517.log`    | step6 실행 (92초, 에러 0)     |
| `step7_embedding_20260212_203709.log` | step7 Dry Run (대상: 1,078건) |
| `step7_embedding_20260212_203729.log` | step7 실행 (26초, 에러 0)     |

---

## 5. 미해결 이슈

| #       | 이슈                                                 | 심각도 | 해결 방안                   |
| ------- | ---------------------------------------------------- | ------ | --------------------------- |
| **I-1** | φ 접두사 중복 엔티티 → RAG 검색 실패                 | 🔴 높음 | step4 `normalize_name` 수정 |
| I-2     | step5 E5 LLM Audit 0.402                             | 🟡 중간 | 프롬프트 개선 (장기)        |
| I-3     | step5 E6 Hallucination 45%                           | 🟡 중간 | 2-pass 검증 (장기)          |
| I-4     | 벡터 검색 정확도 (숫자 매칭 약함)                    | 🟡 중간 | 키워드 폴백 검색 추가       |
| I-5     | graph_entities 17,442 > normalized 17,091 (잔존 351) | 🟢 낮음 | 이전 적재 잔존, upsert 특성 |
