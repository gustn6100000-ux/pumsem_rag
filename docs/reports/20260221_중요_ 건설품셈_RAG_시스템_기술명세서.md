# ê±´ì„¤ í’ˆì…ˆ RAG ì‹œìŠ¤í…œ â€” ê¸°ìˆ  ëª…ì„¸ì„œ (Technical Specification)

> **ë¬¸ì„œ ë²„ì „**: v1.0  
> **ì‘ì„±ì¼**: 2026-02-21  
> **í”„ë¡œì íŠ¸ëª…**: Antigravity â€” ê±´ì„¤ í‘œì¤€ í’ˆì…ˆ AI ì–´ì‹œìŠ¤í„´íŠ¸  
> **ì €ì¥ì†Œ**: `github.com/gustn6100000-ux/pumsem_rag`

---

## ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš” (System Overview)](#1-ì‹œìŠ¤í…œ-ê°œìš”)
2. [í”„ë¡œì íŠ¸ êµ¬ì¡° (Project Structure)](#2-í”„ë¡œì íŠ¸-êµ¬ì¡°)
3. [ì „ì²´ ì•„í‚¤í…ì²˜ (Architecture)](#3-ì „ì²´-ì•„í‚¤í…ì²˜)
4. [Phase 1: ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ (Preprocessing Pipeline)](#4-phase-1-ì „ì²˜ë¦¬-íŒŒì´í”„ë¼ì¸)
5. [Phase 1.5: í’ˆì§ˆ ê²€ì¦ (Validation)](#5-phase-15-í’ˆì§ˆ-ê²€ì¦)
6. [Phase 2: ì •ë³´ ì¶”ì¶œ íŒŒì´í”„ë¼ì¸ (Extraction Pipeline)](#6-phase-2-ì •ë³´-ì¶”ì¶œ-íŒŒì´í”„ë¼ì¸)
7. [Phase 3: ë°ì´í„° ì ì¬ ë° ì„ë² ë”© (Loading & Embedding)](#7-phase-3-ë°ì´í„°-ì ì¬-ë°-ì„ë² ë”©)
8. [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ (Database Schema)](#8-ë°ì´í„°ë² ì´ìŠ¤-ìŠ¤í‚¤ë§ˆ)
9. [SQL RPC í•¨ìˆ˜ (Search Functions)](#9-sql-rpc-í•¨ìˆ˜)
10. [Phase 4: Edge Function â€” RAG ì„œë¹™ ë ˆì´ì–´](#10-phase-4-edge-function--rag-ì„œë¹™-ë ˆì´ì–´)
11. [í”„ë¡ íŠ¸ì—”ë“œ (Frontend)](#11-í”„ë¡ íŠ¸ì—”ë“œ)
12. [ë°°í¬ ë° ì¸í”„ë¼ (Deployment & Infrastructure)](#12-ë°°í¬-ë°-ì¸í”„ë¼)
13. [í™˜ê²½ ë³€ìˆ˜ (Environment Variables)](#13-í™˜ê²½-ë³€ìˆ˜)
14. [ë³´ì•ˆ (Security)](#14-ë³´ì•ˆ)
15. [í–¥í›„ ê³„íš (Roadmap)](#15-í–¥í›„-ê³„íš)

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

### 1.1 í”„ë¡œì íŠ¸ ëª©ì 

ê±´ì„¤ ê³µì‚¬ **í‘œì¤€ í’ˆì…ˆì„œ**(æ¨™æº–å“ì…ˆ, Standard of Estimation)ì˜ ë°ì´í„°ë¥¼ **Knowledge Graph + Vector Search** ê¸°ë°˜ì˜ RAG(Retrieval-Augmented Generation) ì‹œìŠ¤í…œìœ¼ë¡œ êµ¬ì¶•í•˜ì—¬, ê±´ì„¤ ì‹¤ë¬´ìê°€ ìì—°ì–´ë¡œ í’ˆì…ˆ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ë…¸ë¬´ë¹„ë¥¼ ì‚°ì¶œí•  ìˆ˜ ìˆëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

### 1.2 í•µì‹¬ ê¸°ëŠ¥

| ê¸°ëŠ¥ | ì„¤ëª… |
|---|---|
| **í’ˆì…ˆ ê²€ìƒ‰** | "ê°•ê´€ìš©ì ‘ 200mm SCH 40" ê°™ì€ ìì—°ì–´ ì§ˆì˜ë¡œ í•´ë‹¹ í’ˆì…ˆì˜ ì¸ë ¥Â·ì¥ë¹„Â·ìì¬ íˆ¬ì…ëŸ‰ì„ 4ì—´ í…Œì´ë¸”ë¡œ ë°˜í™˜ |
| **ëª…í™•í™” (Clarification)** | ëª¨í˜¸í•œ ì§ˆë¬¸(ì˜ˆ: "ìš©ì ‘ í’ˆì…ˆ")ì— ëŒ€í•´ êµ¬ì²´ì  ì„ íƒì§€ë¥¼ ì œì‹œí•˜ì—¬ ì •í™•ë„ í–¥ìƒ |
| **ë…¸ë¬´ë¹„ ì‚°ì¶œ** | í’ˆì…ˆ ë°ì´í„° + 2026ë…„ ë…¸ì„ë‹¨ê°€ë¥¼ ê²°í•©í•˜ì—¬ ìë™ ë…¸ë¬´ë¹„ ê³„ì‚° |
| **ì‚°ì¶œì„œ ìƒì„±** | ì •í˜•í™”ëœ ì‚°ì¶œ ë‚´ì—­ì„œ í˜•íƒœë¡œ ì¶œë ¥ |
| **ë§¥ë½ ìœ ì§€** | ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ í†µí•´ "ì•„ê¹Œ ê±´", "ìˆ˜ëŸ‰ì„ 50më¡œ ë°”ê¿”ì„œ" ë“± í›„ì† ì§ˆë¬¸ ì²˜ë¦¬ |

### 1.3 ê¸°ìˆ  ìŠ¤íƒ

| ê³„ì¸µ | ê¸°ìˆ  |
|---|---|
| **PDF íŒŒì‹±** | Google Gemini 2.0 Flash (OCR/ë§ˆí¬ë‹¤ìš´ ë³€í™˜) |
| **ë°ì´í„° íŒŒì´í”„ë¼ì¸** | Python 3.12 (asyncio, pydantic, BeautifulSoup4, tqdm) |
| **LLM ì¶”ì¶œ** | DeepSeek V3 / Gemini 3.0 Flash (ì—”í‹°í‹°/ê´€ê³„ ì¶”ì¶œ) |
| **ì„ë² ë”©** | Google Gemini `text-embedding-004` (768ì°¨ì›) |
| **ë°ì´í„°ë² ì´ìŠ¤** | Supabase PostgreSQL + pgvector + pg_trgm |
| **ì„œë¹™ ë ˆì´ì–´** | Supabase Edge Functions (Deno/TypeScript) |
| **LLM ë‹µë³€ ìƒì„±** | DeepSeek V3 (`deepseek-chat`) |
| **í”„ë¡ íŠ¸ì—”ë“œ** | Vanilla HTML/CSS/JS + marked.js + DOMPurify |
| **í˜¸ìŠ¤íŒ…** | Cloudflare Pages (í”„ë¡ íŠ¸ì—”ë“œ), Supabase (ë°±ì—”ë“œ) |

---

## 2. í”„ë¡œì íŠ¸ êµ¬ì¡°

```
Antigravity/
â”œâ”€â”€ .env                              # í™˜ê²½ ë³€ìˆ˜ (API í‚¤ ë“±)
â”œâ”€â”€ deploy_chat.bat                   # Edge Function ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
â”‚
â”œâ”€â”€ pipeline/                         # â”â” ë°ì´í„° íŒŒì´í”„ë¼ì¸ â”â”
â”‚   â”œâ”€â”€ .env                          # íŒŒì´í”„ë¼ì¸ ì „ìš© í™˜ê²½ ë³€ìˆ˜
â”‚   â”œâ”€â”€ toc_parser/                   # ëª©ì°¨ íŒŒì‹± ëª¨ë“ˆ
â”‚   â”‚   â””â”€â”€ toc_parser.py             # PDF ëª©ì°¨ â†’ toc_parsed.json
â”‚   â”œâ”€â”€ pdf_extractor/                # PDF â†’ ë§ˆí¬ë‹¤ìš´ ë³€í™˜
â”‚   â”‚   â””â”€â”€ step1_extract_gemini_v33.py   # Gemini OCR ê¸°ë°˜ ì¶”ì¶œ
â”‚   â”œâ”€â”€ phase1_preprocessing/         # â”â” Phase 1: ì „ì²˜ë¦¬ â”â”
â”‚   â”‚   â”œâ”€â”€ config.py                 # ê³µí†µ ì„¤ì •/ê²½ë¡œ/ì„ê³„ê°’
â”‚   â”‚   â”œâ”€â”€ run_pipeline.py           # ì „ì²´ íŒŒì´í”„ë¼ì¸ ì¼ê´„ ì‹¤í–‰
â”‚   â”‚   â”œâ”€â”€ step1_section_splitter.py # Step 1: ì„¹ì…˜ ë¶„í• 
â”‚   â”‚   â”œâ”€â”€ step2_table_parser.py     # Step 2: HTML í…Œì´ë¸” íŒŒì‹±
â”‚   â”‚   â”œâ”€â”€ step3_text_cleaner.py     # Step 3: í…ìŠ¤íŠ¸ ì •ì œ
â”‚   â”‚   â”œâ”€â”€ step4_chunker.py          # Step 4: ì²­í¬ ìƒì„±
â”‚   â”‚   â”œâ”€â”€ step5_validator.py        # Step 5: í’ˆì§ˆ ê²€ì¦
â”‚   â”‚   â”œâ”€â”€ quality_deep_check.py     # ì‹¬ì¸µ í’ˆì§ˆ ë¶„ì„
â”‚   â”‚   â””â”€â”€ utils/                    # HTML ì²˜ë¦¬, í† í° ì¹´ìš´í„° ë“±
â”‚   â”œâ”€â”€ phase1_5_validation/          # â”â” Phase 1.5: ê²€ì¦ ê²°ê³¼ â”â”
â”‚   â”‚   â”œâ”€â”€ validated_entities.json   # ê²€ì¦ í†µê³¼ ì—”í‹°í‹° (22MB)
â”‚   â”‚   â”œâ”€â”€ DLQ_entities.json         # ê²€ì¦ ì‹¤íŒ¨ ì—”í‹°í‹° (1.2MB)
â”‚   â”‚   â”œâ”€â”€ recovered_entities.json   # LLM êµ¬ì œ ì—”í‹°í‹° (196KB)
â”‚   â”‚   â””â”€â”€ discarded_entities.json   # ìµœì¢… íê¸° ì—”í‹°í‹° (1MB)
â”‚   â”œâ”€â”€ phase2_extraction/            # â”â” Phase 2: ì •ë³´ ì¶”ì¶œ â”â”
â”‚   â”‚   â”œâ”€â”€ config.py                 # Phase 2 ì „ìš© ì„¤ì •
â”‚   â”‚   â”œâ”€â”€ schemas.py                # Entity/Relation Pydantic ìŠ¤í‚¤ë§ˆ
â”‚   â”‚   â”œâ”€â”€ step1_table_extractor.py  # Step 2.1: ê·œì¹™ ê¸°ë°˜ í…Œì´ë¸” ì¶”ì¶œ
â”‚   â”‚   â”œâ”€â”€ step2_llm_extractor.py    # Step 2.2: LLM ê¸°ë°˜ ì¶”ì¶œ
â”‚   â”‚   â”œâ”€â”€ step2_5_quarantine_review.py  # Step 2.5: DLQ LLM ì¬í‰ê°€
â”‚   â”‚   â”œâ”€â”€ step2_8_merge_master.py   # Step 2.8: ë§ˆìŠ¤í„° ë°ì´í„° ë³‘í•©
â”‚   â”‚   â”œâ”€â”€ step3_relation_builder.py # Step 2.3: ê´€ê³„ ìƒì„±/ë³‘í•©
â”‚   â”‚   â”œâ”€â”€ step4_normalizer.py       # Step 2.4: ì •ê·œí™”/ì¤‘ë³µì œê±°
â”‚   â”‚   â”œâ”€â”€ step5_extraction_validator.py  # Step 2.5: ì¶”ì¶œ í’ˆì§ˆ ê²€ì¦
â”‚   â”‚   â”œâ”€â”€ step6_supabase_loader.py  # Step 2.6: DB ì ì¬
â”‚   â”‚   â”œâ”€â”€ step7_embedding_generator.py  # Step 2.7: ì„ë² ë”© ìƒì„±
â”‚   â”‚   â””â”€â”€ verify_step*.py           # ê° ë‹¨ê³„ë³„ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ sql/                          # â”â” SQL ë§ˆì´ê·¸ë ˆì´ì…˜ â”â”
â”‚   â”‚   â”œâ”€â”€ step2.6_create_graph_rag_tables.sql   # í…Œì´ë¸” DDL
â”‚   â”‚   â”œâ”€â”€ step2.6_insert_ilwi_items.sql         # ì¼ìœ„ëŒ€ê°€ ì‹œë“œ
â”‚   â”‚   â”œâ”€â”€ step2.6_verify_counts.sql             # ì ì¬ ê²€ì¦ ì¿¼ë¦¬
â”‚   â”‚   â”œâ”€â”€ step2.7_bulk_update_embeddings.sql    # ì„ë² ë”© RPC
â”‚   â”‚   â”œâ”€â”€ step2.7_create_search_functions.sql   # ê²€ìƒ‰ RPC
â”‚   â”‚   â””â”€â”€ step2.7_verification_queries.sql      # ê²€ìƒ‰ ê²€ì¦ ì¿¼ë¦¬
â”‚   â”œâ”€â”€ phase1_output/                # Phase 1 ì¤‘ê°„ ì‚°ì¶œë¬¼
â”‚   â””â”€â”€ phase2_output/                # Phase 2 ì¤‘ê°„ ì‚°ì¶œë¬¼
â”‚
â”œâ”€â”€ edge-function/                    # â”â” RAG ì„œë¹™ ë ˆì´ì–´ â”â”
â”‚   â”œâ”€â”€ index.ts                      # ë©”ì¸ ë¼ìš°í„° + ì»¨í…ìŠ¤íŠ¸ ì¡°í•© (992ì¤„)
â”‚   â”œâ”€â”€ config.ts                     # í™˜ê²½ë³€ìˆ˜, CORS, Rate Limit
â”‚   â”œâ”€â”€ types.ts                      # ê³µí†µ íƒ€ì…/ì¸í„°í˜ì´ìŠ¤ (195ì¤„)
â”‚   â”œâ”€â”€ embedding.ts                  # Gemini ì„ë² ë”© í˜¸ì¶œ
â”‚   â”œâ”€â”€ search.ts                     # ë²¡í„° ê²€ìƒ‰ + í‚¤ì›Œë“œ ê²€ìƒ‰
â”‚   â”œâ”€â”€ graph.ts                      # ê·¸ë˜í”„ í™•ì¥, ì¼ìœ„ëŒ€ê°€, ì²­í¬ ì¡°íšŒ
â”‚   â”œâ”€â”€ clarify.ts                    # ì˜ë„ ë¶„ì„, ëª…í™•í™” ë¡œì§
â”‚   â”œâ”€â”€ resolve.ts                    # ì—”í‹°í‹° í•´ì„, spec ë§¤ì¹­
â”‚   â”œâ”€â”€ llm.ts                        # LLM ë‹µë³€ ìƒì„± + ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
â”‚   â””â”€â”€ context.ts                    # ChatResponse ë¹Œë” ìœ í‹¸
â”‚
â”œâ”€â”€ frontend/                         # â”â” í”„ë¡ íŠ¸ì—”ë“œ â”â”
â”‚   â”œâ”€â”€ index.html                    # ë©”ì¸ UI (46KB)
â”‚   â”œâ”€â”€ style.css                     # ìŠ¤íƒ€ì¼ì‹œíŠ¸
â”‚   â””â”€â”€ app.js                        # í´ë¼ì´ì–¸íŠ¸ JS (315ì¤„)
â”‚
â”œâ”€â”€ supabase/                         # Supabase í”„ë¡œì íŠ¸ ì„¤ì •
â”‚   â””â”€â”€ functions/rag-chat/           # ë°°í¬ìš© Edge Function ë³µì‚¬ë³¸
â”‚
â””â”€â”€ docs/                             # ë¬¸ì„œ
    â”œâ”€â”€ plans/                        # êµ¬í˜„ ê³„íšì„œ
    â””â”€â”€ reports/                      # êµ¬í˜„ ë³´ê³ ì„œ/ë¶„ì„ì„œ
```

---

## 3. ì „ì²´ ì•„í‚¤í…ì²˜

```mermaid
flowchart TB
    subgraph OFFLINE["ì˜¤í”„ë¼ì¸ ë°ì´í„° íŒŒì´í”„ë¼ì¸"]
        PDF["ğŸ“„ í’ˆì…ˆì„œ PDF (1,067í˜ì´ì§€)"]
        TOC["ğŸ“‹ ëª©ì°¨ íŒŒì„œ (toc_parser)"]
        OCR["ğŸ” Gemini OCR â†’ 41ê°œ MD íŒŒì¼"]
        P1["Phase 1: ì „ì²˜ë¦¬<br>(ì„¹ì…˜ë¶„í• â†’í…Œì´ë¸”íŒŒì‹±â†’ì •ì œâ†’ì²­í‚¹â†’ê²€ì¦)"]
        P15["Phase 1.5: DLQ ê²€ì¦<br>(í…ìŠ¤íŠ¸ ê¸°ë°˜ â†’ LLM êµ¬ì œ)"]
        P2["Phase 2: ì¶”ì¶œ<br>(ê·œì¹™+LLM ì—”í‹°í‹°Â·ê´€ê³„ ì¶”ì¶œ)"]
        P3["Phase 2.4: ì •ê·œí™”<br>(A~F 6ë‹¨ê³„ íŒŒì´í”„ë¼ì¸)"]
        LOAD["Phase 3: DB ì ì¬ + ì„ë² ë”©"]
    end

    subgraph ONLINE["ì˜¨ë¼ì¸ ì„œë¹™ ë ˆì´ì–´"]
        EF["Supabase Edge Function<br>(rag-chat, 10ê°œ ëª¨ë“ˆ)"]
        DB[("Supabase PostgreSQL<br>+ pgvector")]
        LLM["DeepSeek V3<br>(ë‹µë³€ ìƒì„±)"]
        EMB["Gemini Embedding<br>(ì¿¼ë¦¬ ì„ë² ë”©)"]
    end

    subgraph CLIENT["í´ë¼ì´ì–¸íŠ¸"]
        FE["Cloudflare Pages<br>(HTML/CSS/JS)"]
    end

    PDF --> TOC --> OCR --> P1 --> P15 --> P2 --> P3 --> LOAD
    LOAD --> DB
    FE -->|POST /rag-chat| EF
    EF -->|ë²¡í„° ê²€ìƒ‰| DB
    EF -->|ì¿¼ë¦¬ ì„ë² ë”©| EMB
    EF -->|ë‹µë³€ ìƒì„±| LLM
    EF -->|JSON ì‘ë‹µ| FE
```

### 3.1 ë°ì´í„° íë¦„ ìš”ì•½

1. **ì˜¤í”„ë¼ì¸**: í’ˆì…ˆì„œ PDF â†’ Gemini OCRë¡œ ë§ˆí¬ë‹¤ìš´ ë³€í™˜ â†’ 5ë‹¨ê³„ ì „ì²˜ë¦¬ â†’ ê²€ì¦(DLQ ì²´ê³„) â†’ ê·œì¹™+LLM ì¶”ì¶œ â†’ 6ë‹¨ê³„ ì •ê·œí™” â†’ Supabase DB ì ì¬ â†’ Gemini ì„ë² ë”© ìƒì„±
2. **ì˜¨ë¼ì¸**: ì‚¬ìš©ì ì§ˆë¬¸ â†’ Edge Functionì—ì„œ ì˜ë„ ë¶„ì„ â†’ ë²¡í„°/í‚¤ì›Œë“œ ê²€ìƒ‰ â†’ ê·¸ë˜í”„ í™•ì¥ â†’ ì»¨í…ìŠ¤íŠ¸ ì¡°í•© â†’ DeepSeek LLM ë‹µë³€ ìƒì„± â†’ JSON ì‘ë‹µ

---

## 4. Phase 1: ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸

> **ìœ„ì¹˜**: `pipeline/phase1_preprocessing/`  
> **ì…ë ¥**: 41ê°œ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ (Gemini OCR ê²°ê³¼, `pipeline/download_file/`)  
> **ì¶œë ¥**: `chunks.json` (1,706ê°œ êµ¬ì¡°í™”ëœ ì²­í¬)

### 4.1 Step 1: ì„¹ì…˜ ë¶„í•  (`step1_section_splitter.py`)

**ëª©ì **: 41ê°œ MD íŒŒì¼ì„ í’ˆì…ˆì„œì˜ ë…¼ë¦¬ì  ë‹¨ìœ„ì¸ **ì ˆ(Section, X-Y-Z)** ë‹¨ìœ„ë¡œ ë¶„í• í•©ë‹ˆë‹¤.

| í•­ëª© | ìƒì„¸ |
|---|---|
| **ì…ë ¥** | 41ê°œ MD íŒŒì¼ + `toc_parsed.json` |
| **ì¶œë ¥** | `raw_sections.json` |
| **í•µì‹¬ ë¡œì§** | `<!-- SECTION: X-Y-Z -->` ë§ˆì»¤ ê¸°ë°˜ ë¶„í•  |
| **ë³´ì™„ ë¡œì§** | CONTEXT ë§ˆì»¤ í´ë°±, ì œëª© íŒ¨í„´ ë§¤ì¹­ í´ë°± |

**ì£¼ìš” í•¨ìˆ˜**:
- `split_sections()`: ë‹¨ì¼ MD íŒŒì¼ì„ SECTION ë§ˆì»¤ ê¸°ì¤€ìœ¼ë¡œ ë¶„í• 
- `redistribute_text_to_sections()`: ì—°ì† ë§ˆì»¤ ê·¸ë£¹ ë’¤ì˜ í…ìŠ¤íŠ¸ë¥¼ ì œëª© íŒ¨í„´ìœ¼ë¡œ ì¬ë¶„ë°° (í•µì‹¬ ë‚œì œ í•´ê²°)
- `context_marker_fallback()`: SECTION ë§ˆì»¤ë¡œ ì¡íˆì§€ ì•Šì€ ì„¹ì…˜ì„ CONTEXT ë§ˆì»¤ì—ì„œ ë³´ì¶©
- `fallback_title_matching()`: TOCì— ìˆìœ¼ë‚˜ ë§ˆì»¤ê°€ ì—†ëŠ” í•­ëª©ì„ ê¸°ì¡´ ì„¹ì…˜ í…ìŠ¤íŠ¸ì—ì„œ ì œëª© íŒ¨í„´ìœ¼ë¡œ ì¶”ê°€ ë¶„í• 
- `build_reverse_map()`: `(section_id, department)` â†’ TOC key ì—­ë°©í–¥ ë§¤í•‘ ìƒì„±

### 4.2 Step 2: HTML í…Œì´ë¸” íŒŒì‹± (`step2_table_parser.py`)

**ëª©ì **: ê° ì„¹ì…˜ ë‚´ `<table>` HTMLì„ **êµ¬ì¡°í™”ëœ ë”•ì…”ë„ˆë¦¬ ë°°ì—´**ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

| í•­ëª© | ìƒì„¸ |
|---|---|
| **ì…ë ¥** | `raw_sections.json` |
| **ì¶œë ¥** | `parsed_tables.json` |
| **í…Œì´ë¸” ìœ í˜•** | `A_í’ˆì…ˆ`, `B_ê·œëª¨ê¸°ì¤€`, `C_êµ¬ë¶„ì„¤ëª…`, `D_ê¸°íƒ€` |

**ì£¼ìš” í•¨ìˆ˜**:
- `classify_table()`: í—¤ë”/í–‰ ë‚´ìš©ìœ¼ë¡œ í…Œì´ë¸” ìœ í˜• A/B/C/D ìë™ ë¶„ë¥˜
- `detect_header_rows()`: í—¤ë” í–‰ ìˆ˜ ì¶”ì • (1~3í–‰ ì§€ì›, ë‹¤ë‹¨ í—¤ë” ì²˜ë¦¬)
- `build_composite_headers()`: ë‹¤ì¤‘ í—¤ë” í–‰ í•©ì„± (ì˜ˆ: "ì¸ì›ìˆ˜_1ì¼ë‹¹_ë³´í†µì¸ë¶€")
- `parse_single_table()`: HTML â†’ `{headers, rows, type, notes_in_table}` êµ¬ì¡°í™”
- `is_note_row()`: í…Œì´ë¸” ë‚´ ì£¼ì„/ë¹„ê³ /êµ¬ë¶„ì í–‰ íŒë³„ â†’ `notes_in_table`ìœ¼ë¡œ ë¶„ë¦¬

**rowspan/colspan ì²˜ë¦¬**: `utils/html_utils.py`ì˜ `expand_table()` í•¨ìˆ˜ì—ì„œ rowspan/colspanì„ í™•ì¥í•˜ì—¬ ëª¨ë“  ì…€ì´ ê°™ì€ í¬ê¸°ì˜ ê·¸ë¦¬ë“œë¥¼ í˜•ì„±í•˜ë„ë¡ ì •ê·œí™”.

### 4.3 Step 3: í…ìŠ¤íŠ¸ ì •ì œ (`step3_text_cleaner.py`)

**ëª©ì **: í…Œì´ë¸” ì™¸ í…ìŠ¤íŠ¸ì—ì„œ **ì£¼ì„, ì¡°ê±´/í• ì¦, êµì°¨ì°¸ì¡°, ë³´ì™„ì—°ë„** ë“± êµ¬ì¡°í™”ëœ ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.

| í•­ëª© | ìƒì„¸ |
|---|---|
| **ì…ë ¥** | `parsed_tables.json` |
| **ì¶œë ¥** | `cleaned_sections.json` |

**ì¶”ì¶œ í•­ëª©**:
- `notes`: `[ì£¼]` ë¸”ë¡, ë²ˆí˜¸ ë§¤ê¸´ ì£¼ì„ (`â‘ `, `1.`, `ê°€.` ë“±)
- `conditions`: í• ì¦/ì ìš© ì¡°ê±´ (ì˜ˆ: "ì§ì ‘ë…¸ë¬´ë¹„ 3ì–µ ì´ìƒì¼ ê²½ìš° 10% í• ì¦")
- `cross_references`: êµì°¨ì°¸ì¡° (ì˜ˆ: "ì œ13ì¥ ì°¸ì¡°", "6-3-1 í•­ ì¤€ìš©")
- `revision_year`: ë³´ì™„ì—°ë„ (ì˜ˆ: "'24ë…„ ë³´ì™„")
- `unit_basis`: ë‹¨ìœ„ ê¸°ì¤€ (ì˜ˆ: "(mÂ³ë‹¹)", "(100më‹¹)")

### 4.4 Step 4: ì²­í¬ ìƒì„± (`step4_chunker.py`)

**ëª©ì **: ì •ì œëœ ì„¹ì…˜ì„ **GraphRAG ë° ë²¡í„° ê²€ìƒ‰ì— ìµœì í™”ëœ ì²­í¬**ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

| í•­ëª© | ìƒì„¸ |
|---|---|
| **ì…ë ¥** | `cleaned_sections.json` |
| **ì¶œë ¥** | `chunks.json` |
| **ì²­í¬ ë‹¨ìœ„** | í•­(X-Y-Z) 1ê°œ = 1ì²­í¬ (ê¸°ë³¸) |
| **í† í° ì œí•œ** | MAX: 1,500í† í°, HARD_LIMIT: 2,000í† í° |
| **ë¶„í•  ì „ëµ** | í…ìŠ¤íŠ¸/í…Œì´ë¸” ë¶„ë¦¬ â†’ ëŒ€í˜• í…Œì´ë¸” í–‰ ë¶„í•  â†’ ì¬ê·€ ë¶„í•  |

**ì²­í¬ ë©”íƒ€ë°ì´í„°**:
```json
{
  "chunk_id": "C-0001",
  "section_id": "6-1-1",
  "department": "í† ëª©ë¶€ë¬¸",
  "chapter": "ì œ6ì¥ ì½˜í¬ë¦¬íŠ¸ê³µì‚¬",
  "section": "ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤",
  "title": "ê±°í‘¸ì§‘ ê³µì‚¬",
  "text": "...",
  "tables": [...],
  "notes": [...],
  "conditions": [...],
  "cross_references": [...],
  "revision_year": "'24ë…„ ë³´ì™„",
  "unit_basis": "mÂ³ë‹¹",
  "token_count": 450,
  "source_file": "pages_100_130.md",
  "page_start": 105
}
```

### 4.5 Step 5: í’ˆì§ˆ ê²€ì¦ (`step5_validator.py`)

**ëª©ì **: ìƒì„±ëœ ì²­í¬ì˜ í’ˆì§ˆì„ ìë™ ê²€ì¦í•˜ê³  íŒŒì´í”„ë¼ì¸ ê²°ê³¼ë¥¼ ìš”ì•½í•©ë‹ˆë‹¤.

**ê²€ì¦ í•­ëª©**:

| ê²€ì¦ | ê¸°ì¤€ | ê²°ê³¼ |
|---|---|---|
| TOC ì„¹ì…˜ ì»¤ë²„ë¦¬ì§€ | â‰¥ 90% | âœ… 97.8% |
| í…Œì´ë¸” íŒŒì‹± ì„±ê³µë¥  | â‰¥ 95% | âœ… 99.2% |
| ë¹ˆ ì²­í¬ ë¹„ìœ¨ | â‰¤ 5% | âœ… 1.3% |
| í† í° HARD_LIMIT ì´ˆê³¼ | 0ê±´ | âœ… 0ê±´ |
| í•„ìˆ˜ ë©”íƒ€ë°ì´í„° ëˆ„ë½ | 0ê±´ | âœ… 0ê±´ |
| ì¤‘ë³µ section_id | 0ê±´ | âœ… 0ê±´ |

---

## 5. Phase 1.5: í’ˆì§ˆ ê²€ì¦

> **ëŒ€ìƒ**: Phase 2ì—ì„œ ì¶”ì¶œëœ ì—”í‹°í‹°/ê´€ê³„ì— ëŒ€í•œ í’ˆì§ˆ ê²€ì¦  
> **ë°©ì‹**: 2-Step Validation (í…ìŠ¤íŠ¸ ê¸°ë°˜ ì—„ê²© ê²€ì¦ â†’ LLM ê¸°ë°˜ ìœ ì—° êµ¬ì œ)

### 5.1 Step 1: í…ìŠ¤íŠ¸ ê¸°ë°˜ ê²€ì¦ (`step5_extraction_validator.py`)

ì²­í¬ ì›ë¬¸ê³¼ ì¶”ì¶œëœ ì—”í‹°í‹°ë¥¼ êµì°¨ ê²€ì¦í•˜ì—¬, ì›ë¬¸ì— ê·¼ê±°ê°€ ì—†ëŠ” í™˜ê°(Hallucination) ì—”í‹°í‹°ë¥¼ DLQ(Dead Letter Queue)ë¡œ ê²©ë¦¬í•©ë‹ˆë‹¤.

| ë¶„ë¥˜ | ê±´ìˆ˜ |
|---|---|
| âœ… ê²€ì¦ í†µê³¼ (Validated) | 1,706 ì²­í¬ |
| âŒ DLQ ê²©ë¦¬ | 409 ì²­í¬ (ì„¸ë¶€ 1,144 ì†ì„±) |

### 5.2 Step 2: LLM Quarantine Review (`step2_5_quarantine_review.py`)

DLQì— ê²©ë¦¬ëœ 1,144ê±´ì„ DeepSeek APIë¥¼ í†µí•´ ë¹„ë™ê¸° ì¬í‰ê°€í•©ë‹ˆë‹¤.

| ê²°ê³¼ | ê±´ìˆ˜ | ë¹„ìœ¨ |
|---|---|---|
| âœ… êµ¬ì œ (False-Negative) | 196ê±´ | 17.1% |
| âŒ ìµœì¢… íê¸° (True-Positive) | 948ê±´ | 82.9% |

### 5.3 ë§ˆìŠ¤í„° ë³‘í•© (`step2_8_merge_master.py`)

ê²€ì¦ í†µê³¼ ë°ì´í„° + êµ¬ì œ ë°ì´í„°ë¥¼ ê²°í•©í•˜ì—¬ `llm_entities_master.json`ì„ ìƒì„±í•©ë‹ˆë‹¤.

---

## 6. Phase 2: ì •ë³´ ì¶”ì¶œ íŒŒì´í”„ë¼ì¸

> **ìœ„ì¹˜**: `pipeline/phase2_extraction/`  
> **ì…ë ¥**: `chunks.json` (1,706 ì²­í¬)  
> **ì¶œë ¥**: `normalized_entities.json` (ì—”í‹°í‹° 16,302ê±´, ê´€ê³„ 31,118ê±´)

### 6.1 Step 2.1: ê·œì¹™ ê¸°ë°˜ í…Œì´ë¸” ì¶”ì¶œ (`step1_table_extractor.py`, 1,191ì¤„)

**ëª©ì **: `A_í’ˆì…ˆ` í…Œì´ë¸”ì˜ êµ¬ì¡°í™”ëœ headers/rowsì—ì„œ **ê·œì¹™ ê¸°ë°˜**ìœ¼ë¡œ ì—”í‹°í‹°(WorkType, Labor, Equipment, Material)ì™€ ê´€ê³„ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.

**í—¤ë” ì—­í•  ë¶„ë¥˜** (`classify_header_role`):
| ì—­í•  | í‚¤ì›Œë“œ ì˜ˆ | ì„¤ëª… |
|---|---|---|
| `name` | ëª…ì¹­, ê³µì¢…ëª…, ì¢…ëª© | ì—”í‹°í‹° ì´ë¦„ |
| `spec` | ê·œê²©, ì‚¬ì–‘ | ê·œê²©/ì‚¬ì–‘ |
| `unit` | ë‹¨ìœ„ | ë‹¨ìœ„ (ì¸, mÂ³, ëŒ€) |
| `quantity` | ìˆ˜ëŸ‰ | íˆ¬ì… ìˆ˜ëŸ‰ |
| `labor` | ì¸ì›ìˆ˜, ë³´í†µì¸ë¶€, íŠ¹ë³„ì¸ë¶€ | ë…¸ë¬´ ì—´ (ê°’ = ì¸ë ¥ ìˆ˜ëŸ‰) |
| `equipment` | ê¸°ê³„, ì¥ë¹„ | ì¥ë¹„ ì—´ |
| `material` | ì¬ë£Œ, ìì¬ | ìì¬ ì—´ |

**í…Œì´ë¸” ìœ í˜•ë³„ ì²˜ë¦¬ ì „ëµ**:

1. **Case A (`A_í’ˆì…ˆ`)**: `extract_from_a_table()` â€” name ì—´ + labor/equipment ì—´ ì¡°í•©ìœ¼ë¡œ ì—”í‹°í‹°Â·ê´€ê³„ ìƒì„±
2. **Case B (`B_ê·œëª¨ê¸°ì¤€`)**: `extract_from_b_table()` â€” ì¡°ê±´ì„ Note ì—”í‹°í‹°ë¡œ ë³€í™˜
3. **Case D (ë§¤íŠ¸ë¦­ìŠ¤)**: `extract_from_matrix_table()` â€” êµ¬ê²½Ã—SCH ë§¤íŠ¸ë¦­ìŠ¤ì—ì„œ êµì°¨ì  ì¶”ì¶œ
   - **D1 íŒ¨í„´** (ë©”íƒ€í–‰): ì²« í–‰ì´ ì§ì¢… ë§¤í•‘, ì´í›„ í–‰ì´ ë°ì´í„°
   - **D2 íŒ¨í„´** (ë³µí•© í—¤ë”): í—¤ë”ê°€ `SCH_ì§ì¢…ëª…` í˜•ì‹

**SCH í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸**: ì—´ í—¤ë”ì˜ ìˆ«ìê°€ ì‹¤ì œ ë°°ê´€ Scheduleì„ ì˜ë¯¸í•˜ëŠ” ì„¹ì…˜ì„ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¡œ ê´€ë¦¬í•˜ì—¬ ì˜¤ì¸ì‹ ë°©ì§€.

### 6.2 Step 2.2: LLM ê¸°ë°˜ ì¶”ì¶œ (`step2_llm_extractor.py`, 710ì¤„)

**ëª©ì **: ê·œì¹™ ì¶”ì¶œë¡œ ì»¤ë²„í•˜ì§€ ëª»í•œ ì²­í¬ë¥¼ **DeepSeek V3 LLM**ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.

**LLM ì¶”ì¶œ ëŒ€ìƒ ì„ ë³„** (`select_llm_target_chunks`):
1. í…Œì´ë¸”ì´ ì—†ëŠ” í…ìŠ¤íŠ¸ ì „ìš© ì²­í¬ (364ê±´)
2. D_ê¸°íƒ€/C_êµ¬ë¶„ì„¤ëª…ë§Œ ìˆëŠ” ì²­í¬
3. Step 2.1ì—ì„œ WorkTypeì´ 0ê°œì¸ ì²­í¬
4. Step 2.1ì—ì„œ ê²½ê³ ê°€ ìˆëŠ” ì²­í¬

**Pydantic ìŠ¤í‚¤ë§ˆ** (JSON Mode ê°•ì œ):
```python
class LLMEntity(BaseModel):
    type: str    # WorkType | Labor | Equipment | Material | Note | Standard
    name: str    # ì—”í‹°í‹° ì´ë¦„ (í•œêµ­ì–´)
    spec: Optional[str]      # ê·œê²©
    unit: Optional[str]      # ë‹¨ìœ„
    quantity: Optional[float] # ìˆ˜ëŸ‰

class LLMRelationship(BaseModel):
    source: str        # ì¶œë°œ ì—”í‹°í‹° ì´ë¦„
    target: str        # ë„ì°© ì—”í‹°í‹° ì´ë¦„
    type: str          # REQUIRES_LABOR ë“±
    quantity: Optional[float]
    unit: Optional[str]
    per_unit: Optional[str]  # "1m3ë‹¹", "100më‹¹"
```

**ë¹„ë™ê¸° ì²˜ë¦¬**: `asyncio.Semaphore`ë¡œ ë™ì‹œì„± ì œì–´, 200ê±´ë§ˆë‹¤ ì¤‘ê°„ ì €ì¥(crash ë°©ì–´), `--resume` ëª¨ë“œë¡œ ì´ì–´í•˜ê¸° ì§€ì›.

### 6.3 Step 2.3: ê´€ê³„ ìƒì„± ë° ë³‘í•© (`step3_relation_builder.py`, 634ì¤„)

**ë³‘í•© ìš°ì„ ìˆœìœ„**:
| í•„ë“œ | ìš°ì„  | ì´ìœ  |
|---|---|---|
| name/spec | LLM | ë” ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ |
| quantity/unit | í…Œì´ë¸” | ì •í™•í•œ ìˆ˜ì¹˜ |
| confidence | ìµœëŒ€ê°’ | ë‘˜ ì¤‘ ë†’ì€ ì‹ ë¢°ë„ |

**ìë™ ìƒì„± ê´€ê³„**:
- `BELONGS_TO`: WorkType â†’ Section (í’ˆì…ˆ â†’ ì ˆ)
- `HAS_CHILD`: Section ê³„ì¸µ (ì¥ â†’ ì ˆ â†’ í•­)
- `REFERENCES`: êµì°¨ì°¸ì¡° (ì˜ˆ: "6-3-1 ì°¸ì¡°")

### 6.4 Step 2.4: ì •ê·œí™” ë° ì¤‘ë³µ ì œê±° (`step4_normalizer.py`, 1,014ì¤„)

**6ë‹¨ê³„ íŒŒì´í”„ë¼ì¸**:

| Phase | ì´ë¦„ | ë™ì‘ | ê²°ê³¼ |
|---|---|---|---|
| **A** | ë¬¸ìì—´ ì •ê·œí™” | NFKC, ê³µë°± ì œê±°, LABOR_MAP(ë³´ í†µ ì¸ ë¶€â†’ë³´í†µì¸ë¶€), ë‹¨ìœ„ ì •ê·œí™” | â€” |
| **B** | ì¤‘ë³µ ì œê±° | type+name+spec í‚¤ ê¸°ë°˜ ê·¸ë£¹í•‘, ëŒ€í‘œ ì—”í‹°í‹° ì„ ì • | 33,455â†’16,302 (51.8% ì••ì¶•) |
| **C** | ê´€ê³„ ë°©í–¥ ë³´ì • | `DIRECTION_RULES` ê¸°ë°˜ source/target ë°©í–¥ êµì • (725ê±´) | â€” |
| **D** | ì´ìƒì¹˜ í•„í„°ë§ | quantity > threshold(ë…¸ë¬´75, ì¥ë¹„3300, ìì¬225) â†’ confidence í•˜í–¥ | â€” |
| **E** | ê´€ê³„ ì°¸ì¡° ê°±ì‹  | ëŒ€í‘œ ì´ë¦„ìœ¼ë¡œ source/target ì¹˜í™˜ + ê´€ê³„ ì¤‘ë³µ ì œê±° | 46,938â†’31,118 |
| **F** | ID ë¶€ì—¬ | ê¸€ë¡œë²Œ ìœ ë‹ˆí¬ ID ìƒì„± (W-0001, L-0001, E-0001, M-0001 ë“±) | â€” |

---

## 7. Phase 3: ë°ì´í„° ì ì¬ ë° ì„ë² ë”©

### 7.1 DB ì ì¬ (`step6_supabase_loader.py`, 453ì¤„)

**ì ì¬ ìˆœì„œ** (FK ì˜ì¡´ì„± ì¤€ìˆ˜):
1. `graph_entities` (TEXT PK, upsert)
2. `graph_relationships` (SERIAL PK, insert)
3. `graph_global_relationships` (SERIAL PK, insert)
4. `graph_chunks` (TEXT PK, upsert)

**`--clean` ëª¨ë“œ**: FK ì—­ìˆœìœ¼ë¡œ ì „ì²´ ì‚­ì œ â†’ ê¹¨ë—í•œ ì¬ì ì¬ (ê³ ì•„ ë…¸ë“œ/ì¶©ëŒ ë°©ì§€)

### 7.2 ì„ë² ë”© ìƒì„± (`step7_embedding_generator.py`, 523ì¤„)

| í•­ëª© | ìƒì„¸ |
|---|---|
| **ëª¨ë¸** | Gemini `text-embedding-004` |
| **ì°¨ì›** | 768 |
| **ë°°ì¹˜** | ìµœëŒ€ 100ê±´/ë°°ì¹˜, Exponential Backoff ì¬ì‹œë„ |
| **í˜ì´ì§•** | Keyset í˜ì´ì§• (offset í˜ì´ì§•ì˜ í–‰ ëˆ„ë½ ë°©ì§€) |
| **ì ì¬** | RPC `bulk_update_embeddings`ë¡œ ë°°ì¹˜ UPDATE |

**ì„ë² ë”© í…ìŠ¤íŠ¸ êµ¬ì„±**:
- **ì—”í‹°í‹°**: `[WorkType] ê°•ê´€ìš©ì ‘ | spec: 200 SCH 40 | ê¸°ê³„ì„¤ë¹„ë¶€ë¬¸ > í”ŒëœíŠ¸ì„¤ë¹„ê³µì‚¬`
- **ì²­í¬**: `[í† ëª©ë¶€ë¬¸ > ì œ6ì¥ ì½˜í¬ë¦¬íŠ¸ê³µì‚¬ > ê±°í‘¸ì§‘ ê³µì‚¬] 6-1-1 | ê±°í‘¸ì§‘ ì¡°ë¦½ í’ˆì…ˆ`

---

## 8. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

> **ìœ„ì¹˜**: `pipeline/sql/step2.6_create_graph_rag_tables.sql`  
> **í™•ì¥**: `pgvector`, `pg_trgm`

### 8.1 í…Œì´ë¸” êµ¬ì¡°

```mermaid
erDiagram
    graph_entities {
        text id PK
        text name
        text type
        jsonb properties
        text source_section
        vector_768 embedding
        timestamptz created_at
    }

    graph_relationships {
        serial id PK
        text source_id FK
        text target_id FK
        text relation
        jsonb properties
        text source_chunk_id
        timestamptz created_at
    }

    graph_global_relationships {
        serial id PK
        text source_id FK
        text target_id FK
        text relation
        jsonb properties
        timestamptz created_at
    }

    graph_chunks {
        text id PK
        text section_id
        text title
        text department
        text chapter
        text section
        text text
        jsonb tables
        jsonb notes
        jsonb conditions
        jsonb cross_references
        text revision_year
        int token_count
        vector_768 embedding
        timestamptz created_at
    }

    ilwi_items {
        serial id PK
        text ilwi_code
        text name
        text spec
        text_array labor_types
        numeric labor_cost
        numeric material_cost
        numeric expense_cost
        numeric total_cost
        text source_id
        timestamptz created_at
    }

    graph_entities ||--o{ graph_relationships : "source_id"
    graph_entities ||--o{ graph_relationships : "target_id"
    graph_entities ||--o{ graph_global_relationships : "source_id"
    graph_entities ||--o{ graph_global_relationships : "target_id"
```

### 8.2 ì¸ë±ìŠ¤

| ì¸ë±ìŠ¤ | ìœ í˜• | ìš©ë„ |
|---|---|---|
| `idx_entities_embedding` | HNSW (vector_cosine_ops) | ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰ |
| `idx_entities_name_trgm` | GIN (gin_trgm_ops) | í•œêµ­ì–´ fuzzy ê²€ìƒ‰ |
| `idx_entities_type` | B-tree | íƒ€ì…ë³„ í•„í„°ë§ |
| `idx_chunks_embedding` | HNSW | ì²­í¬ ë²¡í„° ê²€ìƒ‰ |
| `idx_ilwi_name_trgm` | GIN | ì¼ìœ„ëŒ€ê°€ í¼ì§€ ê²€ìƒ‰ |
| `idx_rel_source/target` | B-tree | ê´€ê³„ íƒìƒ‰ |

### 8.3 RLS ì •ì±…

ëª¨ë“  í…Œì´ë¸”ì— Row Level Security í™œì„±í™”, `anon` ì—­í• ì— `SELECT` í—ˆìš©.

### 8.4 ë°ì´í„° ê·œëª¨

| í…Œì´ë¸” | í–‰ ìˆ˜ |
|---|---|
| `graph_entities` | 16,302ê±´ |
| `graph_relationships` | 31,118ê±´ |
| `graph_global_relationships` | ~2,500ê±´ |
| `graph_chunks` | 1,706ê±´ |
| `ilwi_items` | ~500ê±´ |

---

## 9. SQL RPC í•¨ìˆ˜

> **ìœ„ì¹˜**: `pipeline/sql/step2.7_create_search_functions.sql`

### 9.1 `search_entities_by_embedding`

```sql
CREATE OR REPLACE FUNCTION search_entities_by_embedding(
    query_embedding vector(768),
    match_threshold float DEFAULT 0.5,
    match_count int DEFAULT 10,
    filter_type text DEFAULT NULL
)
RETURNS TABLE (
    id text, name text, type text, 
    properties jsonb, similarity float,
    source_section text
)
```

**ë™ì‘**: pgvectorì˜ ì½”ì‚¬ì¸ ìœ ì‚¬ë„(`1 - (embedding <=> query_embedding)`)ë¡œ ìƒìœ„ Nê°œ ì—”í‹°í‹° ë°˜í™˜. `filter_type` ì˜µì…˜ìœ¼ë¡œ íŠ¹ì • ì—”í‹°í‹° íƒ€ì…ë§Œ í•„í„°ë§ ê°€ëŠ¥. `source_section`ì„ ì§ì ‘ ë°˜í™˜í•˜ì—¬ í›„ì† ì¡°íšŒë¥¼ ì œê±°.

### 9.2 `get_related_resources`

```sql
CREATE OR REPLACE FUNCTION get_related_resources(entity_id text)
RETURNS TABLE (
    direction text, relation text,
    related_id text, related_name text,
    related_type text, properties jsonb
)
```

**ë™ì‘**: ì£¼ì–´ì§„ ì—”í‹°í‹°ì˜ outbound ê´€ê³„(`graph_relationships` + `graph_global_relationships`)ë¥¼ UNION ALLë¡œ íƒìƒ‰í•˜ì—¬ ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜í™˜. Phase 4ì—ì„œ ë¶ˆí•„ìš”í•œ inbound ë¸”ë¡ì„ ì œê±°í•˜ì—¬ ì„±ëŠ¥ ìµœì í™”.

### 9.3 `bulk_update_embeddings`

```sql
CREATE OR REPLACE FUNCTION bulk_update_embeddings(
    p_table text, p_updates jsonb
) RETURNS int
```

**ë™ì‘**: ì„ë² ë”© ë²¡í„°ë¥¼ ë°°ì¹˜ë¡œ UPDATE. Pythonì—ì„œ JSON ë¬¸ìì—´ë¡œ ì „ë‹¬ëœ ë²¡í„°ë¥¼ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ `vector(768)` íƒ€ì…ìœ¼ë¡œ ìºìŠ¤íŒ….

---

## 10. Phase 4: Edge Function â€” RAG ì„œë¹™ ë ˆì´ì–´

> **ìœ„ì¹˜**: `edge-function/` (10ê°œ TypeScript ëª¨ë“ˆ)  
> **ëŸ°íƒ€ì„**: Supabase Edge Functions (Deno)  
> **ì—”ë“œí¬ì¸íŠ¸**: `POST /functions/v1/rag-chat`

### 10.1 ëª¨ë“ˆ êµ¬ì¡°

```mermaid
flowchart LR
    REQ["POST ìš”ì²­"] --> IDX["index.ts<br>(ë¼ìš°í„°)"]
    IDX --> CLARIFY["clarify.ts<br>(ì˜ë„ ë¶„ì„)"]
    IDX --> SEARCH["search.ts<br>(ë²¡í„°/í‚¤ì›Œë“œ ê²€ìƒ‰)"]
    IDX --> GRAPH["graph.ts<br>(ê·¸ë˜í”„ í™•ì¥)"]
    IDX --> LLM["llm.ts<br>(ë‹µë³€ ìƒì„±)"]
    
    CLARIFY --> RESOLVE["resolve.ts<br>(ì—”í‹°í‹° í•´ì„)"]
    SEARCH --> EMB["embedding.ts<br>(Gemini ì„ë² ë”©)"]
    LLM --> CTX["context.ts<br>(ì‘ë‹µ ë¹Œë”)"]
    
    CFG["config.ts<br>(í™˜ê²½ì„¤ì •)"] -.-> IDX
    TYPES["types.ts<br>(íƒ€ì… ì •ì˜)"] -.-> IDX
```

### 10.2 `config.ts` â€” í™˜ê²½ ì„¤ì •

| ì„¤ì • | ìƒì„¸ |
|---|---|
| **Supabase** | `createClient(URL, SERVICE_ROLE_KEY)` |
| **CORS** | í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜ (`ALLOWED_ORIGINS` + `ALLOWED_SUFFIXES`) |
| **Rate Limit** | IP ê¸°ë°˜ ë¶„ë‹¹ 10íšŒ ì œí•œ |
| **LLM** | DeepSeek API (`api.deepseek.com/chat/completions`) |

### 10.3 `types.ts` â€” íƒ€ì… ì‹œìŠ¤í…œ (195ì¤„)

**í•µì‹¬ íƒ€ì…**:
- `ChatRequest`: ì‚¬ìš©ì ìš”ì²­ (`question`, `history`, `entity_id`, `session_context`)
- `SessionContext`: ë©€í‹°í„´ ë§¥ë½ (`last_entity_id`, `last_spec`, `last_quantity`)
- `IntentAnalysis`: ì˜ë„ ë¶„ì„ ê²°ê³¼ (8ê°€ì§€ ì˜ë„)
- `ChatResponse`: í†µí•© ì‘ë‹µ (`type: "answer" | "clarify"`)
- `SelectorPanel`: ëŒ€ê·œëª¨ ëª…í™•í™” UI (ë“œë¡­ë‹¤ìš´+í•„í„°)

### 10.4 `clarify.ts` â€” ì˜ë„ ë¶„ì„ (16,659B)

**8ê°€ì§€ ì˜ë„(Intent)**:

| ì˜ë„ | íŠ¸ë¦¬ê±° ì˜ˆ | ì²˜ë¦¬ |
|---|---|---|
| `search` | "ê°•ê´€ìš©ì ‘ 200mm SCH 40" | ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ |
| `clarify_needed` | "ìš©ì ‘ í’ˆì…ˆ" (ëª¨í˜¸) | ì„ íƒì§€ ì œì‹œ |
| `cost_calculate` | "ë…¸ë¬´ë¹„ ê³„ì‚°í•´ì¤˜" | ë¹„ìš© ì‚°ì¶œ |
| `report_request` | "ì‚°ì¶œì„œ ë§Œë“¤ì–´ì¤˜" | ì‚°ì¶œì„œ í˜•íƒœ ì¶œë ¥ |
| `modify_request` | "50më¡œ ë°”ê¿”ì„œ ë‹¤ì‹œ" | ìˆ˜ëŸ‰/ê³µì¢… ë³€ê²½ |
| `quantity_input` | "50m" (ë‹¨ë… ì…ë ¥) | ìˆ˜ëŸ‰ ê°±ì‹  |
| `followup` | "ë¹„ê³ ë€ ì•Œë ¤ì¤˜" | ì´ì „ ê²°ê³¼ ê¸°ë°˜ í›„ì† |
| `greeting` | "ì•ˆë…•í•˜ì„¸ìš”" | ì¸ì‚¬ ì‘ë‹µ |

**ëª…í™•í™” í”Œë¡œìš°**: `graphClarify()` â†’ DBì—ì„œ ê´€ë ¨ ì—”í‹°í‹° ê²€ìƒ‰ â†’ ë¶€ë¬¸/ê·œê²©ë³„ ê·¸ë£¹í•‘ â†’ `SelectorPanel`(6ê°œ ì´ˆê³¼ ì‹œ í•„í„° UI) ë˜ëŠ” `ClarifyOption[]` ë°˜í™˜.

### 10.5 `search.ts` â€” ê²€ìƒ‰ ì—”ì§„ (24,376B)

**ê²€ìƒ‰ ì „ëµ** (`targetSearch`):
1. **ë²¡í„° ê²€ìƒ‰**: Gemini ì„ë² ë”©ìœ¼ë¡œ query â†’ `search_entities_by_embedding` RPC í˜¸ì¶œ
2. **í‚¤ì›Œë“œ ê²€ìƒ‰**: ë™ì˜ì–´ í™•ì¥ + `pg_trgm` ìœ ì‚¬ë„ ê²€ìƒ‰
3. **ê²°ê³¼ ë³‘í•©**: ë²¡í„° + í‚¤ì›Œë“œ ê²°ê³¼ë¥¼ ìœ ì‚¬ë„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬

### 10.6 `graph.ts` â€” ê·¸ë˜í”„ í™•ì¥ (15,308B)

| í•¨ìˆ˜ | ë™ì‘ |
|---|---|
| `expandGraph()` | ì—”í‹°í‹° â†’ `get_related_resources` RPCë¡œ ê´€ë ¨ ë…¸ë¬´/ì¥ë¹„/ìì¬ í™•ì¥ |
| `searchIlwi()` | ì¼ìœ„ëŒ€ê°€ ë§¤ì¹­ (ì´ë¦„ ê¸°ë°˜ fuzzy ê²€ìƒ‰) |
| `retrieveChunks()` | ì›ë¬¸ ì²­í¬ ì¡°íšŒ (ì¶œì²˜ ì •ë³´ ì œê³µìš©) |
| `fetchLaborCosts()` | 2026ë…„ ë…¸ì„ë‹¨ê°€ ì¡°íšŒ |

### 10.7 `resolve.ts` â€” ì—”í‹°í‹° í•´ì„ (40,649B)

ê°€ì¥ í° ëª¨ë“ˆ. ì—”í‹°í‹° IDë¡œ ì§ì ‘ ì¡°íšŒ, ì„¹ì…˜ë³„ WorkType ëª©ë¡ ì¡°íšŒ, spec ë§¤ì¹­/í•„í„°ë§ ë“±ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

### 10.8 `llm.ts` â€” LLM ë‹µë³€ ìƒì„± (10,556B)

**ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ í•µì‹¬ ê·œì¹™**:
1. **í‘œë²ˆí˜¸ í•„ìˆ˜** (`[í‘œ 13-5-1]`)
2. **ì¶œì²˜ ëª…ì‹œ** (ë¶€ë¬¸ > ì¥ > ì ˆ > í‘œë²ˆí˜¸)
3. **ê³ ì • 4ì—´ í…Œì´ë¸”** (`| ì§ì¢… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ê¸°ì¤€ |`)
4. **ë‹¨ìœ„ ë³€ê²½ ê¸ˆì§€** (ë°ì´í„° ì›ë¬¸ ê·¸ëŒ€ë¡œ)
5. **í˜•ì œ ë°ì´í„° í™œìš©** (ê°™ì€ ì ˆ ë‚´ ë‹¤ë¥¸ ì‘ì—… ë°ì´í„°ë„ ì¶œë ¥)
6. **ê¸ˆì§€ ì‚¬í•­**: ì»¨í…ìŠ¤íŠ¸ ì™¸ ìˆ˜ì¹˜ ìƒì„±, ëª¨í˜¸í•œ í‘œí˜„, ë‹¨ìœ„ ì„ì˜ ë³€ê²½

**ì˜ë„ë³„ íŠ¹ë³„ ì§€ì¹¨**:
- `cost_calculate`: ë…¸ë¬´ë¹„ ì‚°ì¶œí‘œ í˜•ì‹ (`ì§ì¢…|íˆ¬ì…ì¸ì›|ìˆ˜ëŸ‰|ì´íˆ¬ì…|ë…¸ì„ë‹¨ê°€|ì†Œê³„`)
- `report_request`: ì •í˜•í™”ëœ ì‚°ì¶œì„œ í˜•íƒœ (í’ˆì…ˆ ì¶œì²˜ + ì¸ë ¥ í…Œì´ë¸” + í•©ê³„)

### 10.9 `index.ts` â€” ë©”ì¸ ë¼ìš°í„° (992ì¤„, 44KB)

**íŒŒì´í”„ë¼ì¸ íë¦„**:

```mermaid
flowchart TD
    A["POST /rag-chat"] --> B["ì…ë ¥ ê²€ì¦<br>(question_required, 500ì ì œí•œ)"]
    B --> C["handleChat()"]
    C --> D{"entity_id ìˆìŒ?"}
    D -->|Yes| E["ì§ì ‘ ì¡°íšŒ íŒŒì´í”„ë¼ì¸"]
    D -->|No| F["analyzeIntent()"]
    
    F --> G{"intent?"}
    G -->|greeting| H["ì¸ì‚¬ ì‘ë‹µ"]
    G -->|cost_calculate| I["ë¹„ìš© ì‚°ì¶œ (ì¬ê·€)"]
    G -->|report_request| J["ì‚°ì¶œì„œ (ì¬ê·€)"]
    G -->|modify_request| K["ë³€ê²½ ì²˜ë¦¬"]
    G -->|clarify_needed| L["graphClarify()"]
    G -->|search| M["searchPipeline()"]
    
    M --> N["targetSearch()"]
    N --> O["expandGraph()"]
    O --> P["searchIlwi()"]
    P --> Q["retrieveChunks()"]
    Q --> R["buildContext()"]
    R --> S["generateAnswer()"]
    S --> T["ChatResponse (JSON)"]
```

**ì»¨í…ìŠ¤íŠ¸ êµ¬ì¶•** (`buildContext`):
- ì—”í‹°í‹°ë³„ í‘œë²ˆí˜¸, ì¶œì²˜ í‘œì‹œ
- íŒŒìƒ í”„ë¡œí¼í‹°ë¥¼ **ê³ ì • 4ì—´ ê·œê²©** (`| ì§ì¢… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ê¸°ì¤€ |`)ìœ¼ë¡œ ì •í˜•í™”
- í…Œì´ë¸” JSON â†’ Markdown ë³€í™˜ (`tablesToMarkdown`)
- ì¼ìœ„ëŒ€ê°€ ë§¤ì¹­ ê²°ê³¼ í¬í•¨ (ë…¸ë¬´ë¹„/ì¬ë£Œë¹„/ê²½ë¹„/í•©ê³„)

### 10.10 `context.ts` â€” ì‘ë‹µ ë¹Œë” (3,832B)

`makeAnswerResponse()`, `makeClarifyResponse()` íŒ©í† ë¦¬ í•¨ìˆ˜ë¥¼ í†µí•´ ì¼ê´€ëœ `ChatResponse` êµ¬ì¡° ìƒì„±.

---

## 11. í”„ë¡ íŠ¸ì—”ë“œ

> **ìœ„ì¹˜**: `frontend/`  
> **í˜¸ìŠ¤íŒ…**: Cloudflare Pages (`main.antigravity-chatbot.pages.dev`)

### 11.1 ê¸°ìˆ  êµ¬ì„±

| íŒŒì¼ | í¬ê¸° | ì—­í•  |
|---|---|---|
| `index.html` | 46KB | ë©”ì¸ UI (ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ + ì˜ˆì‹œ ì§ˆë¬¸) |
| `style.css` | 9.5KB | ë‹¤í¬ í…Œë§ˆ ìŠ¤íƒ€ì¼ |
| `app.js` | 11KB | í´ë¼ì´ì–¸íŠ¸ ë¡œì§ (315ì¤„) |

**ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬**:
- `marked.js`: ë§ˆí¬ë‹¤ìš´ â†’ HTML ë Œë”ë§
- `DOMPurify`: XSS ë°©ì–´ (Codex F2)

### 11.2 ì£¼ìš” ê¸°ëŠ¥

- **ë§ˆí¬ë‹¤ìš´ ë Œë”ë§**: LLM ë‹µë³€ì˜ ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸”/ì½”ë“œë¸”ë¡ ì •ìƒ ë Œë”ë§
- **ì¶œì²˜ íƒœê·¸**: ê²€ìƒ‰ ê²°ê³¼ì˜ ì¶œì²˜(ì ˆë²ˆí˜¸, ë¶€ë¬¸) í‘œì‹œ
- **ë””ë²„ê·¸ íŒ¨ë„**: ê²€ìƒ‰ í†µê³„(ì—”í‹°í‹° ìˆ˜, ê´€ê³„ ìˆ˜, ì‘ë‹µ ì‹œê°„, í† í° ì‚¬ìš©ëŸ‰, ì¶”ì • ë¹„ìš©)
- **ê¸€ì ìˆ˜ ì¹´ìš´í„°**: ì…ë ¥ ìµœëŒ€ 500ì ì œí•œ
- **ëŒ€í™” ì´ë ¥**: ìµœëŒ€ 5í„´ ìœ ì§€ (10ê°œ ë©”ì‹œì§€)

---

## 12. ë°°í¬ ë° ì¸í”„ë¼

### 12.1 Edge Function ë°°í¬

```batch
# deploy_chat.bat
robocopy edge-function supabase\functions\rag-chat /MIR /XD node_modules
npx supabase functions deploy rag-chat --project-ref bfomacoarwtqzjfxszdr
```

### 12.2 í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬

- **í”Œë«í¼**: Cloudflare Pages
- **ë¹Œë“œ**: Git push â†’ ìë™ ë¹Œë“œ (static site)
- **ë„ë©”ì¸**: `main.antigravity-chatbot.pages.dev`

---

## 13. í™˜ê²½ ë³€ìˆ˜

| ë³€ìˆ˜ | ìš©ë„ | ì‚¬ìš© ìœ„ì¹˜ |
|---|---|---|
| `SUPABASE_URL` | Supabase í”„ë¡œì íŠ¸ URL | Pipeline, Edge Function |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase ì„œë¹„ìŠ¤ ë¡¤ í‚¤ | Pipeline, Edge Function |
| `GEMINI_API_KEY` | Gemini ì„ë² ë”© API í‚¤ | Pipeline, Edge Function |
| `DEEPSEEK_API_KEY` | DeepSeek LLM API í‚¤ | Pipeline, Edge Function |
| `DEEPSEEK_URL` | DeepSeek API ì—”ë“œí¬ì¸íŠ¸ | Edge Function |
| `RAG_API_KEY` | API ì ‘ê·¼ ì œì–´ í‚¤ (ì„ íƒ) | Edge Function |

---

## 14. ë³´ì•ˆ

| ê³„ì¸µ | ì¡°ì¹˜ |
|---|---|
| **CORS** | Origin í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ (ì™€ì¼ë“œì¹´ë“œ `*` ê¸ˆì§€) |
| **Rate Limiting** | IP ê¸°ë°˜ ë¶„ë‹¹ 10íšŒ ì œí•œ |
| **API Key** | `x-api-key` í—¤ë” ê²€ì¦ (ì„ íƒì ) |
| **ì…ë ¥ ê²€ì¦** | payload 10KB ì œí•œ, question 500ì ì ˆì‚­ |
| **XSS ë°©ì–´** | DOMPurify (script/iframe/form íƒœê·¸ ì œê±°) |
| **RLS** | ëª¨ë“  í…Œì´ë¸” Row Level Security í™œì„±í™” |
| **í™˜ê²½ ë³€ìˆ˜** | ë¯¼ê° í‚¤ëŠ” Supabase Secrets / .envë¡œ ê´€ë¦¬ |

---

## 15. í–¥í›„ ê³„íš

| ë‹¨ê³„ | ë‚´ìš© |
|---|---|
| **Phase 5** | í”„ë¡ íŠ¸ì—”ë“œ Selector Panel UI êµ¬í˜„ (ë‹¤ì¤‘ í•„í„° ë“œë¡­ë‹¤ìš´) |
| **Phase 6** | ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘ + RAG í’ˆì§ˆ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ |
| **Phase 7** | ë©€í‹°í„´ ëŒ€í™” ê³ ë„í™” (ì„¸ì…˜ ì˜ì†í™”, ëŒ€í™” ìš”ì•½) |
| **Phase 8** | ì¶”ê°€ í’ˆì…ˆì„œ (ì „ê¸°, í†µì‹  ë“±) ë°ì´í„° í™•ì¥ |

---

> **ì‘ì„±**: Antigravity AI Architect  
> **ìµœì¢… ê°±ì‹ **: 2026-02-21
