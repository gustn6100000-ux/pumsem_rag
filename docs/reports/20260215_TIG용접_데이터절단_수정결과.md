# TIG용접 250+ 데이터 절단 수정 결과

**일시**: 2026-02-15  
**배포**: Edge Function v75 (115.5kB)

---

## 문제

"강관용접 > TIG용접 전체 내용 보기" 시 **250mm 이상 구경 데이터가 누락**되어 표시됨.

---

## 근본 원인 (3계층)

| 레이어 | 문제                                           | 위치                           | 수정                           |
| :----: | ---------------------------------------------- | ------------------------------ | ------------------------------ |
| **L1** | `.limit(1)` / `.limit(3)` — chunk 1~3건만 조회 | `index.ts:306`, `graph.ts:238` | `.limit(20)` / `.limit(15)`    |
| **L2** | `tables` 필드 미SELECT                         | `index.ts:304`, `graph.ts:235` | SELECT에 `tables` 추가         |
| **L3** | tables JSON → LLM 전달 로직 없음               | `index.ts:194~201`             | `tablesToMarkdown()` 헬퍼 신규 |

**구조적 배경**: 강관용접(13-2-3)은 **11개 chunk**(C-0955-A~K)에 데이터가 분산 저장되어 있음.  
TIG용접 표는 C-0955-I(소구경), C-0955-J(중구경 250~400), C-0955-K(대구경 500+) 3개에 분포.  
실제 품셈 표 데이터는 `text` 필드가 아닌 `tables` JSON 필드에 저장.

---

## 변경 파일

### 1. types.ts — ChunkResult 타입 확장

- `TableData` 인터페이스 신규 정의 (table_id, headers, rows 등)
- `ChunkResult`에 `tables?: TableData[]`, `notes?: any[]` 필드 추가

### 2. index.ts — tablesToMarkdown 헬퍼 + full_view 개선

- **`tablesToMarkdown()`**: tables JSON → Markdown 테이블 변환 헬퍼 추가
- **full_view 경로**:
  - `.limit(1)` → `.limit(20)` (전체 chunk 로딩)
  - SELECT에 `tables` 필드 추가
  - sub_section 필터: `:sub=2. TIG용접` 시 TIG 관련 chunk만 선별 → context 크기 관리
  - 전체 chunk의 `text` + `tables` → 하나의 메타 chunk로 병합

### 3. graph.ts — retrieveChunks 개선

- `.limit(3)` → `.limit(15)` (강관용접 11건 커버)
- SELECT에 `tables` 필드 추가
- section_id별 그룹화 → 동일 섹션의 다수 chunk를 하나로 병합
- tables → Markdown 변환 후 text에 추가
- text 상한: 2000자 → 6000자 확장

---

## 검증 결과

**API 테스트**: `"강관용접 TIG용접 전체 품셈", section_id="13-2-3"`

| 항목           | Before (v74)                | After (v75)               |
| -------------- | --------------------------- | ------------------------- |
| 응답 크기      | 301 bytes                   | **4,639 bytes**           |
| answer 길이    | 71자 (에러 메시지)          | **3,531자** (정상 품셈표) |
| 250mm 데이터   | ❌ 없음                      | ✅ `250, 0.750, 1.050...`  |
| entities_found | 0                           | **20**                    |
| 응답 type      | answer ("찾을 수 없습니다") | **answer** (정상 품셈표)  |

---

## 파급 효과

- **full_view 경로**: 모든 섹션에서 chunk 전체 + tables 데이터가 LLM context에 포함됨
- **일반 검색 경로**: `retrieveChunks`에서도 tables 포함 → 표 데이터 기반 답변 품질 향상
- **context 크기**: sub_section 필터로 관련 chunk만 선별하여 불필요한 토큰 소비 방지
