# 🏛️ Master System Architect's Analysis & Execution Report

제출된 **[Phase 4: RAG 검색 레이어 리팩토링 상세 구현 계획서]**를 심층 분석했습니다.

클로드 코드가 제안한 기획안은 본질적으로 훌륭하며, "**데이터베이스가 똑똑해지면(Smart DB), 애플리케이션은 얇아져야 한다(Thin Middleware)**"는 현대 백엔드 최적화 사상을 완벽하게 구현하는 방법론입니다. 

수석 아키텍트 관점(Mode M: 진단+설계 리뷰)에서 이 문서를 점검한 결과, 전반적인 구조 철거 및 리팩토링 로직(Step 1~3)은 타당하나 일부 코드 레벨에서 야기될 수 있는 **잠재적 파급 효과(Gap) 3가지**를 발견했습니다. 안정적인 런타임을 위해 반드시 보완되어야 합니다.

---

## 🅰️ Architect Impact Check (3대 잠재적 위험 및 보완책)

클로드 코드의 원본 기획안을 바탕으로 실제 구현에 들어가기 전, 아래 3가지 아키텍트 보완 지시를 반드시 추가로 반영해야 합니다.

### 🚨 Warning A: 역방향(inbound) 영구 삭제에 따른 비즈니스 탐색 단절

* **클로드 기획안 (Step 1-1):** `get_related_resources` SQL RPC에서 `inbound` 조회를 전면 삭제.
* **아키텍트 진단:** 현재 "강관용접(WorkType) ➔ 용접공(Labor)" 같은 정방향 질의 성능은 2배 향상되지만, **"용접공이 투입되는 모든 공종을 찾아줘"**와 같은 역탐색(Bottom-up) 질의가 유입될 경우 그래프 탐색이 100% 실패하는 맹점이 발생합니다.
* **보완 지시:**
  - 현재 파이프라인(비용 산출 중심)의 최적화를 위해 해당 스크립트에서 삭제하는 것은 타당합니다.
  - 단, 지식 그래프의 양방향 탐색 가능성을 훼손하지 않기 위해, 추후 역탐색 전용인 **`get_tasks_by_resource(resource_id)` RPC 스크립트 분리 생성**을 Phase 4 백로그에 별도 Task로 기록해 두십시오.

### 🚨 Warning B: 동적 마크다운 테이블(Dynamic Table) 렌더링으로 인한 파서 붕괴

* **클로드 기획안 (Step 2-4 A):** `hasPerUnit` 조건 유무에 따라 표를 3열(`|직종|수량|단위|`) 또는 4열(`|직종|수량|단위|기준|`)로 가변적으로(동적 분기) 조립.
* **아키텍트 진단:** LLM은 구조화된 텍스트(Markdown)를 읽을 때 일관된 스키마를 극도로 중시합니다. 프롬프트 컨텍스트 창 내에 3열 표와 4열 표가 무작위로 혼재되면, 모델의 어텐션(Attention)이 무너지면서 데이터를 잘못 매핑하는 환각(Hallucination)이 발생할 수 있습니다. 
* **보완 지시:**
  - 동적 분기 로직을 철거하십시오.
  - **무조건 4열(`|직종|수량|단위|기준|`) 고정 스키마(Static Schema)**로 렌더링하십시오.
  - `per_unit` 값이 없는 행은 빈칸이 아닌 하이픈(`-`)으로 채워 넣어 표의 정합성을 굳건히 유지해야 합니다. 

### 🚨 Warning C: 정규식(Regex)을 이용한 `source_spec` 규격 파싱의 취약성

* **클로드 기획안 (Step 2-4 B):** 문자열 파싱 구문인 `workName.match(/\((.+)\)$/)` 정규식을 통해 공종명 구석의 괄호 데이터를 잘라내어 추출.
* **아키텍트 진단:** 문자열 정규식 파싱은 시스템을 깨지기 쉽게 만드는 대표적 안티 패턴입니다. 만약 엔티티 이름이 `PE관 융착 200mm` 처럼 괄호가 아예 없거나, `강관용접 (SCH 40) - 특수`처럼 뒤에 수식어가 붙는다면 정규식은 `null`을 뿜어내고 핵심 규격은 영구 유실됩니다.
* **보완 지시:**
  - 엔티티 이름(Name 텍스트)을 임의로 파싱하여 쪼개는 로직을 전면 금지합니다.
  - 대신, 이미 안전하게 구조화되어 DB에 들어 있는 **`properties.spec` 또는 RPC 반환값의 `source_spec` 객체 자체를 매핑 대상 1순위로 사용**해야 합니다. 정규식은 해당 객체가 비어있을 때의 최후 Fallback 용도로만 방어적으로 작성하십시오.

---

## Ⓜ️ Integration Action (권장 실행 로드맵)

제안하신 "SQL 스키마 적용 ➔ TS 미들웨어 정리 ➔ Prompt 튜닝"의 Step 1~3 수직 하향식 전환 과정 자체는 무결점 파이프라인의 모범 사례입니다. 위 아키텍트의 3대 보완 수정 사항만을 녹여내시면 완벽합니다.

본 계획서대로 본격적인 코드 포팅(Implementation)을 원하신다면 **"위 지침(Warning A,B,C)을 반영해서, Track 1 (SQL), Track 2 (App), Track 3 (Prompt)를 순차적으로 구현해 줘"**라고 명령해 주십시오. 즉시 시스템 코딩에 돌입하겠습니다.
