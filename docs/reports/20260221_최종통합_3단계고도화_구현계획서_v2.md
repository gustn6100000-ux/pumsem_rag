# ê±´ì„¤í’ˆì…ˆ RAG ì‹œìŠ¤í…œ â€” 3ë‹¨ê³„ ê³ ë„í™” ìµœì¢… í†µí•© êµ¬í˜„ ê³„íšì„œ

> **ì‘ì„±ì¼**: 2026-02-21  
> **ë²„ì „**: v2.0 (ìµœì¢… í†µí•©ë³¸)  
> **ê¸°ë°˜**: Antigravity ì›ì•ˆ + Claude ê²€ì¦ ë³´ê³ ì„œ ë³´ì • 5ê±´ ë°˜ì˜  
> **ëª©í‘œ**: NotebookLM ìˆ˜ì¤€ì˜ ë³µí•© ì¶”ë¡  + DB ê¸°ë°˜ ì •í™•ë„ 100%ì˜ ê±´ì„¤ íŠ¹í™” AI ì‹œìŠ¤í…œ  
> **í•µì‹¬ ì „ëµ**: DeepSeek V3.2 `deepseek-chat`(ë¹„ì‚¬ê³ ) â†” `deepseek-reasoner`(ì‚¬ê³ ) ìë™ ìŠ¤ìœ„ì¹­

---

## 0. Claude ê²€ì¦ ë³´ì • ì¶”ì í‘œ

> [!IMPORTANT]
> ì•„ë˜ 5ê±´ì€ Claudeì˜ ì½”ë“œ ë ˆë²¨ ê²€ì¦ì—ì„œ ì§€ì ëœ ì‚¬í•­ì´ë©°, **ë³¸ ê³„íšì„œì— ëª¨ë‘ ë°˜ì˜ ì™„ë£Œ**ë˜ì—ˆìŠµë‹ˆë‹¤.

| # | ë³´ì • í•­ëª© | ì‹¬ê°ë„ | ì›ì•ˆ ë¬¸ì œì  | ë³¸ ê³„íšì„œ ë°˜ì˜ ë‚´ìš© | ë°˜ì˜ ìœ„ì¹˜ |
|---|---|---|---|---|---|
| 1 | `related_name` ì •ì œ ëˆ„ë½ | âŒ ì¹˜ëª…ì  | `"200_SCH_40_ìš©ì ‘ê³µ"`ì„ ì •ì œ ì—†ì´ DB ê²€ìƒ‰ â†’ ë§¤ì¹­ ì‹¤íŒ¨ â†’ ë‹¨ê°€ 0ì› | `split('_').slice(-1)[0]` ì •ì œ ë¡œì§ ì¶”ê°€ | Phase 1 Â§1-2 |
| 2 | `handleChat()` ë¶„ê¸° ìœ„ì¹˜ ì˜¤ë¥˜ | âŒ êµ¬ì¡°ì  | `analyzeIntent()` ì§í›„ ì‚½ì… â†’ ê¸°ì¡´ Route 1~3 íŒŒê´´ | **Route 4 ì§ì „**ìœ¼ë¡œ ì´ë™ | Phase 2 Â§2-4 |
| 3 | `costMap` 1:N ë§¤ì¹­ ë¬¸ì œ | âš ï¸ ë³´ì • | "ìš©ì ‘ê³µ" ILIKE â†’ "í”ŒëœíŠ¸ìš©ì ‘ê³µ"ë„ ê±¸ë¦¼ â†’ ì˜ëª»ëœ ë‹¨ê°€ ë§¤í•‘ | `findBestCostMatch()` í—¬í¼ ë„ì… | Phase 1 Â§1-3 |
| 4 | ìš°íšŒ ì¶”ë¡  vs í™˜ê° ì–µì œ ëª¨ìˆœ | âŒ ìœ„í—˜ | SYSTEM_PROMPTì— ì§ì ‘ ë„£ìœ¼ë©´ ê¸°ì¡´ Sê¸‰ ì •í™•ë„ ë¶•ê´´ | **Reasoner ì „ìš© í”„ë¡¬í”„íŠ¸ì—ë§Œ ê²©ë¦¬** | Phase 3 Â§3-2 |
| 5 | `deepseek-reasoner` API ì œì•½ | âš ï¸ ì£¼ì˜ | system role ë¯¸ì§€ì› ê°€ëŠ¥ì„± + temperature ì—ëŸ¬ ê°€ëŠ¥ | user prefix í´ë°± + temperature ì œê±° | Phase 2 Â§2-3 |

---

## 1. Phase 1: 2026 ë…¸ì„ë‹¨ê°€ ì •ë°€ ì—°ë™

> í˜„ì¬ ë¬¸ì œ: `fetchLaborCosts()`ë¡œ ê°€ì ¸ì˜¨ ë‹¨ê°€ë¥¼ í…ìŠ¤íŠ¸ í…Œì´ë¸”ë¡œë§Œ contextì— ì¶”ê°€ â†’ LLMì—ê²Œ ê³±ì…ˆ ìœ„ì„ â†’ ê³„ì‚° ì˜¤ë¥˜(í• ë£¨ì‹œë„¤ì´ì…˜) ìœ„í—˜  
> í•´ê²°: ë°±ì—”ë“œì—ì„œ `(ë‹¨ê°€ Ã— ìˆ˜ëŸ‰)` ì‚°ìˆ  ì—°ì‚°ì„ ë¯¸ë¦¬ ìˆ˜í–‰í•˜ì—¬ **í™•ì •ëœ ê²°ê³¼**ë¥¼ contextì— ê¸°ë¡

---

### Â§1-1. ì‚¬ì „ì—°ì‚° ë¡œì§ êµ¬í˜„

#### [MODIFY] [index.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/index.ts) â€” `answerPipeline()` ë‚´ `[4-1]` ë¸”ë¡ (L356~L373)

```typescript
// â”€â”€â”€ [4-1] cost_calculate/report_request ì‹œ ë…¸ì„ë‹¨ê°€ ì‚¬ì „ì—°ì‚° ì£¼ì… â”€â”€â”€
// Why: LLMì´ 0.122 Ã— 215,907ì„ ì§ì ‘ ê³„ì‚°í•˜ë©´ í• ë£¨ì‹œë„¤ì´ì…˜ ìœ„í—˜
//      ì„œë²„ì—ì„œ ë¯¸ë¦¬ ê³±ì…ˆì„ ë§ˆì¹˜ê³  í™•ì •ëœ í‘œë¥¼ ì „ë‹¬ â†’ LLMì€ ë³µì‚¬ë§Œ â†’ ì •í™•ë„ 100%
if (effectiveIntent === "cost_calculate" || effectiveIntent === "report_request") {
    // â­ [Claude ë³´ì • 1] related_name ì •ì œ: "200_SCH_40_ìš©ì ‘ê³µ" â†’ "ìš©ì ‘ê³µ"
    const laborItems = relationsAll.flat()
        .filter(r => r.relation === "REQUIRES_LABOR")
        .map(r => {
            const props = (r.properties || {}) as any;
            const rawName = r.related_name || "";
            const cleanName = rawName.includes('_')
                ? rawName.split('_').slice(-1)[0]  // ë§ˆì§€ë§‰ '_' ì´í›„ = ì§ì¢…ëª…
                : rawName;
            return {
                name: cleanName,
                rawName: rawName,                          // ë””ë²„ê¹…ìš© ì›ë³¸ ë³´ì¡´
                quantity: parseFloat(props.quantity) || 0,  // ë¬¸ìì—´â†’ìˆ«ì ì•ˆì „ ë³€í™˜
                unit: props.unit ?? "ì¸",
                work_type: props.work_type_name ?? "",
                per_unit: props.per_unit ?? "",
            };
        })
        .filter(item => item.name);  // ë¹ˆ ì´ë¦„ ì œê±°

    if (laborItems.length > 0) {
        const uniqueJobNames = [...new Set(laborItems.map(l => l.name))];
        const laborCosts = await fetchLaborCosts(uniqueJobNames);

        // â­ [Claude ë³´ì • 3] costMapì—ì„œ ìµœì  ë§¤ì¹­ í•¨ìˆ˜ ì‚¬ìš©
        const costMap = new Map(laborCosts.map(lc => [lc.job_name, lc.cost_2026]));

        if (laborCosts.length > 0) {
            context += "\n\n## [2026ë…„ ë…¸ì„ë‹¨ê°€ ê¸°ë°˜ ì‚°ì¶œ ê²°ê³¼ (ë°±ì—”ë“œ ê³„ì‚° ì™„ë£Œ)]\n";
            context += "| ì§ì¢… | íˆ¬ì…ìˆ˜ëŸ‰(ì¸) | ë…¸ì„ë‹¨ê°€(ì›/ì¼) | ê¸ˆì•¡(ì›) | ë¹„ê³  |\n";
            context += "|---|---:|---:|---:|---|\n";
            let totalCost = 0;
            laborItems.forEach(l => {
                const matched = findBestCostMatch(l.name, costMap);
                const unitCost = matched?.cost ?? 0;
                const matchedName = matched?.name ?? l.name;
                const amount = Math.round(Number(l.quantity) * unitCost);
                totalCost += amount;
                context += `| ${matchedName} | ${l.quantity} | ${unitCost.toLocaleString()} | ${amount.toLocaleString()} | ${l.work_type} |\n`;
            });
            context += `| **í•©ê³„** | | | **${totalCost.toLocaleString()}** | |\n`;
            context += `\n> âš ï¸ ìœ„ ê¸ˆì•¡ì€ ë°±ì—”ë“œì—ì„œ ì •í™•íˆ ê³„ì‚°ëœ ê°’ì…ë‹ˆë‹¤. LLMì€ ì´ ìˆ«ìë¥¼ ê·¸ëŒ€ë¡œ ì¶œë ¥í•˜ì„¸ìš”.\n`;
        }
    }
}
```

---

### Â§1-2. `related_name` ì •ì œ ë¡œì§ (Claude ë³´ì • #1)

ìœ„ ì½”ë“œì— ì´ë¯¸ ë°˜ì˜ ì™„ë£Œ. í•µì‹¬:

```typescript
const cleanName = rawName.includes('_')
    ? rawName.split('_').slice(-1)[0]   // "200_SCH_40_ìš©ì ‘ê³µ" â†’ "ìš©ì ‘ê³µ"
    : rawName;                           // "ë³´í†µì¸ë¶€" â†’ "ë³´í†µì¸ë¶€" (ê·¸ëŒ€ë¡œ)
```

**Why**: `graph.ts`ì˜ `expandGraph()`ì—ì„œ `work_type_name`ì„ `related_name`ì— prefixë¡œ ê²°í•©í•˜ëŠ” íŒ¨í„´ì´ ìˆì–´, ì§ì¢…ëª… ì•ì— ê·œê²© ì •ë³´ê°€ ë¶™ìŠµë‹ˆë‹¤. ì´ë¥¼ ì •ì œí•˜ì§€ ì•Šìœ¼ë©´ `fetchLaborCosts()`ì˜ ILIKE ë§¤ì¹­ì´ ì‹¤íŒ¨í•˜ì—¬ **ë‹¨ê°€ 0ì› ì¥ì• **ê°€ ë°œìƒí•©ë‹ˆë‹¤.

---

### Â§1-3. `findBestCostMatch()` í—¬í¼ (Claude ë³´ì • #3)

#### [MODIFY] [index.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/index.ts) â€” ìµœìƒë‹¨ ìœ í‹¸ë¦¬í‹° ì˜ì—­ì— ì¶”ê°€

```typescript
// â”€â”€â”€ ë…¸ì„ë‹¨ê°€ ìµœì  ë§¤ì¹­ í—¬í¼ â”€â”€â”€
// Why: "ìš©ì ‘ê³µ"ì´ ILIKEë¡œ "í”ŒëœíŠ¸ìš©ì ‘ê³µ", "íŠ¹ìˆ˜ìš©ì ‘ê³µ"ê¹Œì§€ ê±¸ë¦¼
//      ì •í™• ì¼ì¹˜ â†’ ê³µë°± ì •ê·œí™” â†’ ë¶€ë¶„ ë§¤ì¹­ ìˆœìœ¼ë¡œ ìš°ì„ ìˆœìœ„ ê²°ì •
function findBestCostMatch(
    jobName: string,
    costMap: Map<string, number>
): { name: string; cost: number } | null {
    // 1) ì •í™• ì¼ì¹˜
    if (costMap.has(jobName)) {
        return { name: jobName, cost: costMap.get(jobName)! };
    }
    // 2) ê³µë°± ì œê±° ì •í™• ì¼ì¹˜
    const normalized = jobName.replace(/\s+/g, '');
    for (const [key, cost] of costMap) {
        if (key.replace(/\s+/g, '') === normalized) {
            return { name: key, cost };
        }
    }
    // 3) ë¶€ë¶„ ë¬¸ìì—´ í¬í•¨ (shorter âŠ‚ longer) â€” ê°€ì¥ ì§§ì€ ë§¤ì¹­ ìš°ì„ 
    let bestMatch: { name: string; cost: number } | null = null;
    for (const [key, cost] of costMap) {
        const keyNorm = key.replace(/\s+/g, '');
        if (keyNorm.includes(normalized) || normalized.includes(keyNorm)) {
            if (!bestMatch || key.length < bestMatch.name.length) {
                bestMatch = { name: key, cost };
            }
        }
    }
    return bestMatch;
}
```

---

### Â§1-4. LLM í”„ë¡¬í”„íŠ¸ ê°•ì œí™”

#### [MODIFY] [llm.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/llm.ts) â€” L82~L92

```typescript
if (options?.intent === "cost_calculate") {
    systemContent += `\n\n[íŠ¹ë³„ ì§€ì¹¨: ë…¸ë¬´ë¹„ ì‚°ì¶œ]
ì‚¬ìš©ìê°€ ë…¸ë¬´ë¹„ / ì¸ê±´ë¹„ ê³„ì‚°ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ê·œì¹™ì„ ì—„ê²©íˆ ë”°ë¥´ì„¸ìš”.
1. ì»¨í…ìŠ¤íŠ¸ì˜ [2026ë…„ ë…¸ì„ë‹¨ê°€ ê¸°ë°˜ ì‚°ì¶œ ê²°ê³¼] ì„¹ì…˜ì— ë°±ì—”ë“œê°€ ë¯¸ë¦¬ ê³„ì‚°í•œ ì •í™•í•œ ê¸ˆì•¡ í…Œì´ë¸”ì´ ìˆìŠµë‹ˆë‹¤.
2. ì´ í…Œì´ë¸”ì˜ ìˆ«ì(íˆ¬ì…ìˆ˜ëŸ‰, ë…¸ì„ë‹¨ê°€, ê¸ˆì•¡, í•©ê³„)ë¥¼ ì ˆëŒ€ ìˆ˜ì •í•˜ê±°ë‚˜ ì¬ê³„ì‚°í•˜ì§€ ë§ˆì„¸ìš”.
3. í•´ë‹¹ í…Œì´ë¸”ì„ ë§ˆí¬ë‹¤ìš´ í‘œë¡œ ê·¸ëŒ€ë¡œ ì¶œë ¥í•˜ì„¸ìš”.
4. ì„ì˜ë¡œ ìˆ«ìë¥¼ ë°˜ì˜¬ë¦¼í•˜ê±°ë‚˜ ë³€ê²½í•˜ëŠ” ê²ƒì€ ê¸ˆì§€í•©ë‹ˆë‹¤.
5. ì¶”ê°€ ì„¤ëª…(í• ì¦ ì¡°ê±´, ì£¼ì˜ì‚¬í•­ ë“±)ì€ í‘œ ì•„ë˜ì— ë¶€ì—°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
6. ìˆ˜ëŸ‰ì´ ${options.quantity || 'ë¯¸ì§€ì •'}ìœ¼ë¡œ ì£¼ì–´ì¡ŒìŠµë‹ˆë‹¤. ë¯¸ì§€ì •ì´ë©´ "1ê°œì†Œë‹¹" ê¸°ì¤€ìœ¼ë¡œ ì•ˆë‚´í•˜ì„¸ìš”.`;
}
```

---

## 2. Phase 2: DeepSeek V3.2 ë“€ì–¼ ëª¨ë¸ ë¼ìš°íŒ…

> í•µì‹¬: ë™ì¼ API í‚¤, ë™ì¼ URLì—ì„œ `model` íŒŒë¼ë¯¸í„°ë§Œ ìŠ¤ìœ„ì¹­  
> `"deepseek-chat"` (ë¹„ì‚¬ê³ , ë¹ ë¦„) â†” `"deepseek-reasoner"` (ì‚¬ê³ , ì¶”ë¡ )

---

### Â§2-1. ë³µì¡ë„ íŒë³„ê¸° (`classifyComplexity`)

#### [MODIFY] [clarify.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/clarify.ts) â€” í•¨ìˆ˜ ì¶”ê°€

```typescript
// â”€â”€â”€ ì§ˆë¬¸ ë³µì¡ë„ ë¶„ë¥˜ê¸° (Complexity Classifier) â”€â”€â”€
// Why: 80%ì˜ ë‹¨ìˆœ ì§ˆë¬¸ì€ deepseek-chat(ì €ë ´), 20%ì˜ ë³µí•© ì§ˆë¬¸ë§Œ deepseek-reasoner(ì¶”ë¡ ) ì‚¬ìš©
export function classifyComplexity(question: string, analysis: IntentAnalysis): "simple" | "complex" {
    let score = 0;

    // [ê¸°ì¤€ 1] ì§ˆë¬¸ ê¸¸ì´
    if (question.length > 80) score += 1;
    if (question.length > 150) score += 1;

    // [ê¸°ì¤€ 2] ë³µìˆ˜ ê³µì¢… í‚¤ì›Œë“œ (ì˜ˆ: "ë•íŠ¸ í•´ì²´" + "ë³´ì˜¨ ì² ê±°")
    const workPatterns = question.match(/[ê°€-í£]{2,}(í•´ì²´|ì² ê±°|ì„¤ì¹˜|ì‹œê³µ|íƒ€ì„¤|ìš©ì ‘|ë„ì¥|ë°©ìˆ˜|ë°°ê´€)/g) || [];
    if (workPatterns.length >= 2) score += 2;

    // [ê¸°ì¤€ 3] ì¡°ê±´/ìƒí™© í‚¤ì›Œë“œ â€” 2ê°œ ì´ìƒì¼ ë•Œë§Œ +2
    // â­ [Claude ë³´ì • #5 ê¶Œì¥] ê°œë³„ +1ì´ ì•„ë‹Œ ë¬¶ìŒ ì ìˆ˜ë¡œ ë‹¨ì¼ ì¡°ê±´ ì˜¤íƒ ë°©ì§€
    const conditionKeywords = ["ë†’ì´", "ê³ ì†Œ", "ì§€í•˜", "ìˆ˜ì¤‘", "ì•¼ê°„", "í˜‘ì†Œ", "ìœ„í—˜",
        "í• ì¦", "ë³´ì˜¨", "ë‹¨ì—´", "ë³´ì–‘", "ì–‘ì¤‘", "ì¸ì–‘", "í•´ì²´", "ì² ê±°"];
    const matchedConditions = conditionKeywords.filter(kw => question.includes(kw));
    if (matchedConditions.length >= 2) score += 2;
    else if (matchedConditions.length === 1) score += 1;

    // [ê¸°ì¤€ 4] ë¬¼ë¦¬ëŸ‰/ë‹¨ìœ„ í™˜ì‚° í•„ìš” ì‹œê·¸ë„
    if (/\d+\s*(mm|t|T|í†¤|kg|mÂ²|ã¡|mÂ³|ã¥)/.test(question)) score += 1;
    if (/ë‘ê»˜|ì™¸ê²½|ë‚´ê²½|ì§ê²½|ì§€ë¦„|ë¬´ê²Œ|ì¤‘ëŸ‰/.test(question)) score += 1;

    // [ê¸°ì¤€ 5] "ì–´ë–»ê²Œ ì ìš©" ë¥˜ì˜ ê°€ì´ë“œ ìš”ì²­
    if (/ì–´ë–»ê²Œ|ì ìš©|ë°©ë²•|ì‚°ì¶œ|ê²¬ì |ë‚´ì—­/.test(question)) score += 1;

    console.log(`[classifyComplexity] score=${score}, conditions=${matchedConditions.join(",")}`);

    // â­ [Claude ë³´ì • #5] ì„ê³„ê°’ 4ì  (ë³´ìˆ˜ì  ì‹œì‘, ë¡œê·¸ ê´€ì°° í›„ ì¡°ì •)
    return score >= 4 ? "complex" : "simple";
}
```

---

### Â§2-2. Reasoner ë§ˆìŠ¤í„°í”Œëœ ìƒì„±ê¸°

#### [MODIFY] [llm.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/llm.ts) â€” í•¨ìˆ˜ ì¶”ê°€

```typescript
// â”€â”€â”€ DeepSeek Reasoner (ì‚¬ê³  ëª¨ë“œ) â€” ë³µí•© ì§ˆë¬¸ìš© ë§ˆìŠ¤í„°í”Œëœ ìƒì„±ê¸° â”€â”€â”€
// Why: ë³µí•© ìƒí™©(ë‹¤ì¤‘ ê³µì¢…, ìš°íšŒ ì¶”ë¡ , ë‹¨ìœ„ í™˜ì‚°)ì€ ì‚¬ê³  ëª¨ë“œ(CoT)ê°€
//      ì²´ê³„ì ì¸ 'ê³„ì‚° ì ˆì°¨ì„œ'ë¥¼ ë¨¼ì € ì§œì£¼ê³ ,
//      ì‹¤ì œ ë‹µë³€ì€ ë¹„ì‚¬ê³  ëª¨ë“œ(chat)ê°€ DB ë°ì´í„°ë¥¼ ë§¤í•‘í•´ì„œ ë¹ ë¥´ê²Œ ì¶œë ¥

const REASONER_SYSTEM_PROMPT = `ë‹¹ì‹ ì€ ê±´ì„¤ ì ì‚° ì „ë¬¸ê°€(Master Estimator)ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ë³µí•©ì ì¸ ê±´ì„¤ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬, ì•„ë˜ í˜•ì‹ì˜ JSON 'ì‘ì—… ê°€ì´ë“œ(Master Plan)'ë¥¼ ìƒì„±í•˜ì„¸ìš”.
ì§ì ‘ ë‹µë³€í•˜ì§€ ë§ˆì„¸ìš”. ì˜¤ì§ ê²€ìƒ‰/ê³„ì‚° ì ˆì°¨ë§Œ ì„¤ê³„í•˜ì„¸ìš”.

[ì¶œë ¥ JSON í˜•ì‹]
{
  "reasoning_summary": "ì´ ì§ˆë¬¸ì´ ë³µí•©ì ì¸ ì´ìœ ì™€ ì ‘ê·¼ ë°©ë²• ìš”ì•½ (í•œêµ­ì–´)",
  "search_tasks": [
    {
      "task_id": 1,
      "description": "ê²€ìƒ‰ ëŒ€ìƒ ì„¤ëª…",
      "search_keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2"],
      "target_type": "WorkType",
      "unit": "ton",
      "why": "ì´ ê²€ìƒ‰ì´ í•„ìš”í•œ ì´ìœ "
    }
  ],
  "calculations": [
    {
      "calc_id": 1,
      "description": "ê³„ì‚° ì„¤ëª…",
      "formula": "Ï€ Ã— D Ã— L",
      "variables": { "D": "1.3m", "L": "ë¯¸ì§€ì •" },
      "why": "ì´ ê³„ì‚°ì´ í•„ìš”í•œ ì´ìœ "
    }
  ],
  "adjustments": [
    {
      "type": "í• ì¦/ë³´ì • ì´ë¦„",
      "condition": "ì ìš© ì¡°ê±´",
      "rate": "ë¹„ìœ¨",
      "apply_to": "ì ìš© ëŒ€ìƒ"
    }
  ],
  "final_output_format": "ìµœì¢… ì¶œë ¥ í˜•ì‹ ì§€ì‹œ"
}

[ìš°íšŒ ì¶”ë¡  ê·œì¹™ â€” Reasoner ì „ìš©]
1. ì‚¬ìš©ìê°€ ì§ˆë¬¸í•œ ê·œê²©ì´ í’ˆì…ˆì— ì—†ì„ ê²½ìš°:
   - ì„±ì§ˆ(ì¤‘ëŸ‰, ì¬ì§ˆ, í˜•ìƒ)ì´ ê°€ì¥ ìœ ì‚¬í•œ ìƒìœ„ í’ˆì…ˆì˜ ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ search_tasksì— í¬í•¨í•˜ì„¸ìš”.
   - why í•„ë“œì— "í•´ë‹¹ ê·œê²©ì€ ì¼ë°˜ OO ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë¯€ë¡œ, â–³â–³ í’ˆì…ˆì„ ì¤€ìš©" í˜•íƒœë¡œ ê·¼ê±°ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.
2. ì—¬ëŸ¬ ê³µì¢…ì´ ì¡°í•©ëœ ì§ˆë¬¸ì´ë©´, ê° ê³µì¢…ì„ ë³„ë„ì˜ search_taskë¡œ ë¶„ë¦¬í•˜ì„¸ìš”.
3. ë‹¨ìœ„ í™˜ì‚°ì´ í•„ìš”í•œ ê²½ìš° calculationsì— ê³µì‹ê³¼ ë³€ìˆ˜ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.

[ê±´ì„¤ ë„ë©”ì¸ ìˆ˜í•™ ê³µì‹]
- ì›í†µ í‘œë©´ì : Ï€ Ã— ì™¸ê²½(m) Ã— ê¸¸ì´(m) = ã¡
- ê°•íŒ ì¤‘ëŸ‰: Ï€ Ã— ì™¸ê²½(m) Ã— ë‘ê»˜(m) Ã— ë¹„ì¤‘(7.85) Ã— ê¸¸ì´(m) = kg/m
- 1í†¤ í™˜ì‚° ê¸¸ì´: 1000kg Ã· (ë‹¨ìœ„ì¤‘ëŸ‰ kg/m) = m
- ë©´ì  í™˜ì‚°: ì›í˜• ë‹¨ë©´ â†’ Ï€ Ã— (D/2)Â² = ã¡`;

export async function generateReasoningGuide(
    question: string,
    history: ChatMessage[]
): Promise<{ guide: string; reasoning_content: string }> {

    // â­ [Claude ë³´ì • #5] system role ë¯¸ì§€ì› í´ë°±:
    //    reasonerê°€ system roleì„ ë¬´ì‹œí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, user ë©”ì‹œì§€ì— í•©ì¹¨
    const messages = [
        {
            role: "user" as const,
            content: `[ì‹œìŠ¤í…œ ì§€ì‹œ]\n${REASONER_SYSTEM_PROMPT}\n\n[ì‚¬ìš©ì ì§ˆë¬¸]\n${question}`,
        },
    ];

    // ëŒ€í™” íˆìŠ¤í† ë¦¬ê°€ ìˆìœ¼ë©´ ìµœê·¼ 2í„´ë§Œ ì¶”ê°€
    if (history.length > 0) {
        const recentHistory = history.slice(-2).map(msg => ({
            role: msg.role === "user" ? "user" as const : "assistant" as const,
            content: msg.content,
        }));
        // íˆìŠ¤í† ë¦¬ë¥¼ ì²« ë²ˆì§¸ user ë©”ì‹œì§€ ì•ì— ì‚½ì…
        messages.unshift(...recentHistory);
    }

    const response = await fetch(DEEPSEEK_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${DEEPSEEK_API_KEY}`,
        },
        body: JSON.stringify({
            model: "deepseek-reasoner",   // â† ì‚¬ê³  ëª¨ë“œ ìŠ¤ìœ„ì¹˜
            messages,
            max_tokens: 8192,
            // â­ [Claude ë³´ì • #5] temperature ì œê±° â€” reasonerì—ì„œ ìë™ ì œì–´
        }),
    });

    if (!response.ok) {
        console.error(`[generateReasoningGuide] Reasoner API failed: ${response.status}`);
        // í´ë°±: ì‚¬ê³  ëª¨ë“œ ì‹¤íŒ¨ ì‹œ ë¹ˆ ê°€ì´ë“œ ë°˜í™˜ â†’ ê¸°ì¡´ search ê²½ë¡œë¡œ ì§„í–‰
        return { guide: "{}", reasoning_content: "" };
    }

    const data = await response.json();
    const guide = data.choices?.[0]?.message?.content ?? "{}";
    const reasoning = data.choices?.[0]?.message?.reasoning_content ?? "";

    console.log(`[generateReasoningGuide] guide_len=${guide.length}, reasoning_len=${reasoning.length}`);
    return { guide, reasoning_content: reasoning };
}
```

---

### Â§2-3. API í˜¸í™˜ì„± í™•ì¸ ì‚¬í•­ (Claude ë³´ì • #5)

| í•­ëª© | ëŒ€ì‘ ë°©ì•ˆ | ìƒíƒœ |
|---|---|---|
| `system` role | user ë©”ì‹œì§€ì— `[ì‹œìŠ¤í…œ ì§€ì‹œ]` prefixë¡œ í•©ì¹¨ | âœ… ì½”ë“œ ë°˜ì˜ ì™„ë£Œ |
| `temperature` | reasoner í˜¸ì¶œ ì‹œ íŒŒë¼ë¯¸í„° ìì²´ë¥¼ ì œê±° | âœ… ì½”ë“œ ë°˜ì˜ ì™„ë£Œ |
| `max_tokens` | reasoner ê¸°ë³¸ 32K, ìš°ë¦¬ëŠ” 8K ì‚¬ìš© (ì¶©ë¶„) | âœ… ì ì • |
| API ì—ëŸ¬ í´ë°± | ì‹¤íŒ¨ ì‹œ ë¹ˆ ê°€ì´ë“œ ë°˜í™˜ â†’ ê¸°ì¡´ search ê²½ë¡œ ê³„ì† | âœ… ì½”ë“œ ë°˜ì˜ ì™„ë£Œ |

---

### Â§2-4. ë©”ì¸ íŒŒì´í”„ë¼ì¸ ë¶„ê¸° (Claude ë³´ì • #2 ë°˜ì˜)

#### [MODIFY] [index.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/index.ts) â€” `handleChat()` ë‚´ë¶€

> [!CAUTION]
> **ì‚½ì… ìœ„ì¹˜ê°€ í•µì‹¬ì…ë‹ˆë‹¤.** `analyzeIntent()` ì§í›„ê°€ ì•„ë‹Œ, **Route 4(`searchPipeline`) ì§ì „**ì— ì‚½ì…í•´ì•¼ ê¸°ì¡´ Route 1~3(entity_id ì§ì ‘ ì¡°íšŒ, cost_calculate, clarify_needed ë“±)ì´ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.

```typescript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// handleChat() ë‚´ë¶€ â€” Route 4 ì§ì „ (â‰ˆ L929 ë¶€ê·¼)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ Route 3.5: ë³µí•© ì§ˆë¬¸ â†’ Reasoner ê²½ë¡œ (Phase 2) â”€â”€â”€
// â­ [Claude ë³´ì • #2] Route 4 ì§ì „ì— ì‚½ì… â€” ê¸°ì¡´ Route 1~3 ë³´ì¡´
const complexity = classifyComplexity(question, analysis);
console.log(`[handleChat] complexity=${complexity}, intent=${analysis.intent}`);

if (complexity === "complex") {
    console.log(`[handleChat] ğŸ§  ì‚¬ê³  ëª¨ë“œ(deepseek-reasoner) ê°€ë™`);

    try {
        // Step 1: Reasonerê°€ ë§ˆìŠ¤í„°í”Œëœ(ì‘ì—… ê°€ì´ë“œ) ìƒì„±
        const { guide, reasoning_content } = await generateReasoningGuide(question, history);

        // Step 2: ë§ˆìŠ¤í„°í”Œëœ íŒŒì‹± (ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ search ê²½ë¡œë¡œ í´ë°±)
        let parsedGuide: any = {};
        try { parsedGuide = JSON.parse(guide); } catch {
            console.warn("[handleChat] Reasoner ê°€ì´ë“œ JSON íŒŒì‹± ì‹¤íŒ¨ â†’ ê¸°ì¡´ search ê²½ë¡œ");
            // í´ë°±: ì•„ë˜ì˜ ê¸°ì¡´ searchPipelineìœ¼ë¡œ ê·¸ëƒ¥ ì§„í–‰
        }

        const searchTasks = parsedGuide.search_tasks || [];

        if (searchTasks.length > 0) {
            // â”€â”€ ë§ˆìŠ¤í„°í”Œëœ ê¸°ë°˜ ë‹¤ì¤‘ DB ê²€ìƒ‰ â”€â”€
            // â­ [Claude ë³´ì • ì¶”ê°€] context ë¼ë²¨ë§ìœ¼ë¡œ Chatì´ DB ë°ì´í„°ë§Œ ì¸ìš©í•˜ë„ë¡ ìœ ë„
            let combinedContext = `## [AI ì¶”ë¡  ê°€ì´ë“œ (ì°¸ê³ ìš© â€” ì§ì ‘ ì¸ìš© ê¸ˆì§€)]\n`;
            combinedContext += `${parsedGuide.reasoning_summary || ""}\n\n`;
            combinedContext += `## [DB ê²€ìƒ‰ ê²°ê³¼ (ì•„ë˜ ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ì—¬ ë‹µë³€)]\n`;

            for (const task of searchTasks) {
                const taskEmbedding = await generateEmbedding(task.search_keywords.join(" "));
                const taskAnalysis = {
                    ...analysis,
                    keywords: task.search_keywords,
                    work_name: task.search_keywords[0],
                };
                const taskEntities = await targetSearch(taskAnalysis, taskEmbedding, task.search_keywords.join(" "));

                if (taskEntities.length > 0) {
                    const topEntities = taskEntities.slice(0, 5);
                    const taskRelations = await Promise.all(
                        topEntities.map(e => expandGraph(e.id, e.type))
                    );
                    const taskChunks = await retrieveChunks(topEntities);
                    combinedContext += `\n### ${task.task_id}. ${task.description}\n`;
                    combinedContext += `> ê²€ìƒ‰ ê·¼ê±°: ${task.why}\n\n`;
                    combinedContext += buildContext(topEntities, taskRelations, [], taskChunks);
                    combinedContext += `\n---\n`;
                }
            }

            // ê³„ì‚° ê³µì‹ ê°€ì´ë“œ ì¶”ê°€
            if (parsedGuide.calculations?.length > 0) {
                combinedContext += `\n## [ì ìš© ê³µì‹ (ì°¸ê³ )]\n`;
                parsedGuide.calculations.forEach((calc: any) => {
                    combinedContext += `- ${calc.description}: \`${calc.formula}\` â€” ${calc.why}\n`;
                });
            }

            // í• ì¦/ë³´ì • ì¡°ê±´ ì¶”ê°€
            if (parsedGuide.adjustments?.length > 0) {
                combinedContext += `\n## [í• ì¦/ë³´ì • ì¡°ê±´]\n`;
                parsedGuide.adjustments.forEach((adj: any) => {
                    combinedContext += `- **${adj.type}**: ${adj.condition} â†’ ${adj.rate} (${adj.apply_to})\n`;
                });
            }

            // Step 3: ìµœì¢… ë‹µë³€ì€ ë¹„ì‚¬ê³  ëª¨ë“œ(deepseek-chat)ë¡œ ë¹ ë¥´ê³  ì •í™•í•˜ê²Œ ì¶œë ¥
            const llmResult = await generateAnswer(question, combinedContext, history, {
                intent: analysis.intent,
            });

            // ì†ŒìŠ¤ ì •ë³´ ì¡°í•©
            const sources: SourceInfo[] = [{
                entity_name: "ë³µí•© ì¶”ë¡  ê²°ê³¼",
                entity_type: "ReasonerGuide",
                source_section: searchTasks.map((t: any) => t.description).join(", "),
            }];

            return makeAnswerResponse(llmResult.answer, startTime, {
                sources,
                embeddingTokens: 0,
                llmResult,
            });
        }
    } catch (err) {
        console.error("[handleChat] Reasoner ê²½ë¡œ ì—ëŸ¬:", err, "â†’ ê¸°ì¡´ search ê²½ë¡œë¡œ í´ë°±");
    }
}

// â•â•â• Route 4: search â†’ searchPipeline (ê¸°ì¡´ ë‹¨ìˆœ ê²½ë¡œ, ë³€ê²½ ì—†ìŒ) â•â•â•
return searchPipeline(analysis, question, history, startTime, answerOptions);
```

---

## 3. Phase 3: ë³µí•© ì¶”ë¡  íŒŒì´í”„ë¼ì¸ ê°•í™”

---

### Â§3-1. ë„ë©”ì¸ ìˆ˜í•™ ê³µì‹ â€” Chat SYSTEM_PROMPTì— ì¶”ê°€ âœ…

#### [MODIFY] [llm.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/llm.ts) â€” `SYSTEM_PROMPT` ë‚´ `[ê¸ˆì§€ ì‚¬í•­]` ë°”ë¡œ ìœ„ì— ì‚½ì…

```markdown
[ê±´ì„¤ ë„ë©”ì¸ ìˆ˜í•™ ê³µì‹ â€” ì°¸ê³ ìš©]
ì»¨í…ìŠ¤íŠ¸ì— ë‹¨ìœ„ í™˜ì‚°ì´ í•„ìš”í•œ ë°ì´í„°ê°€ ìˆì„ ë•Œ ì•„ë˜ ê³µì‹ì„ í™œìš©í•˜ì„¸ìš”.
- ì›í†µ í‘œë©´ì : Ï€ Ã— ì™¸ê²½(m) Ã— ê¸¸ì´(m) = ã¡
- ê°•íŒ ì¤‘ëŸ‰: Ï€ Ã— ì™¸ê²½(m) Ã— ë‘ê»˜(m) Ã— ë¹„ì¤‘(7.85) Ã— ê¸¸ì´(m) = kg/m
- 1í†¤ í™˜ì‚° ê¸¸ì´: 1000kg Ã· (ë‹¨ìœ„ì¤‘ëŸ‰ kg/m) = m
- ë©´ì  í™˜ì‚°: ì›í˜• ë‹¨ë©´ â†’ Ï€ Ã— (D/2)Â² = ã¡
â€» ì´ ê³µì‹ì€ ë¬¼ë¦¬ ìƒìˆ˜ì— ê¸°ë°˜í•œ ê³ ì •ê°’ì´ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
```

**Why**: ë¹„ì¤‘ 7.85, Ï€ ë“±ì€ ì‚¬ì‹¤ì— ê¸°ë°˜í•œ ê³ ì • ìƒìˆ˜ì´ë¯€ë¡œ í™˜ê° ìœ„í—˜ ì—†ì´ LLMì´ ì°¸ì¡° ê°€ëŠ¥.

---

### Â§3-2. ìš°íšŒ ì¶”ë¡  ê·œì¹™ â€” Reasoner ì „ìš© ê²©ë¦¬ âŒ (Chat SYSTEM_PROMPTì—ëŠ” ë„£ì§€ ì•ŠìŒ)

> [!WARNING]
> **Claude ë³´ì • #4 (ìµœëŒ€ ë¦¬ìŠ¤í¬ ì˜ì—­) ë°˜ì˜**  
> "ìš°íšŒ ì¶”ë¡  í—ˆìš©" ê·œì¹™ì„ Chatì˜ SYSTEM_PROMPTì— ì§ì ‘ ë„£ìœ¼ë©´:
> - ê¸°ì¡´ ê·œì¹™ *"ì»¨í…ìŠ¤íŠ¸ì— ì—†ëŠ” ì •ë³´ëŠ” ì¶”ì¸¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"* ì™€ ë…¼ë¦¬ì  ëª¨ìˆœ ë°œìƒ
> - LLMì´ "ì—†ìœ¼ë‹ˆ ë¹„ìŠ·í•œ ê±¸ ì°¨ìš©í•˜ê² ë‹¤"ê³  ìì˜ì  íŒë‹¨ â†’ ê¸°ì¡´ Sê¸‰ ì •í™•ë„ ë¶•ê´´
>
> **í•´ê²°**: ìš°íšŒ ì¶”ë¡  ê·œì¹™ì€ **Reasoner(ì‚¬ê³  ëª¨ë“œ)ì˜ `REASONER_SYSTEM_PROMPT`ì—ë§Œ ê²©ë¦¬** (Â§2-2ì— ë°˜ì˜ ì™„ë£Œ)  
> Chat(ë¹„ì‚¬ê³  ëª¨ë“œ)ëŠ” ì—¬ì „íˆ "contextì— ìˆëŠ” ë°ì´í„°ë§Œ ì‚¬ìš©"í•˜ëŠ” ì—„ê²©í•œ ê·œì¹™ì„ ìœ ì§€

**êµ¬ì¡°ì  ì—­í•  ë¶„ë¦¬:**

```
âŒ ìœ„í—˜í•œ êµ¬ì¡°: Chat SYSTEM_PROMPTì— "ìš°íšŒ ì¶”ë¡  í—ˆìš©" ì§ì ‘ ì‚½ì…
   â†’ LLMì´ ìì˜ì ìœ¼ë¡œ ìš°íšŒ íŒë‹¨ â†’ í™˜ê° â†’ ê¸°ì¡´ ì •í™•ë„ ë¶•ê´´

âœ… ì•ˆì „í•œ êµ¬ì¡° (ë³¸ ê³„íšì„œ ì±„íƒ):
   Reasoner: "4T ë•íŠ¸ â†’ ì² ê³¨ì¬ ì² ê±° í’ˆì…ˆì„ ê²€ìƒ‰í•˜ë¼" (search_tasks ìƒì„±)
     â†“
   ë°±ì—”ë“œ: search_tasksë¡œ DB ê²€ìƒ‰ â†’ ì‹¤ì œ ì—”í‹°í‹°/ê´€ê³„ ë°ì´í„° íšë“
     â†“
   Chat: contextì— ìˆëŠ” DB ë°ì´í„°ë§Œìœ¼ë¡œ ë‹µë³€ (ê¸°ì¡´ í™˜ê° ì–µì œ ê·œì¹™ ìœ ì§€)
```

---

### Â§3-3. IntentAnalysis íƒ€ì… í™•ì¥

#### [MODIFY] [types.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/types.ts) â€” `IntentAnalysis`

```diff
 export interface IntentAnalysis {
     intent: "search" | "clarify_needed" | "followup" | "greeting"
-        | "quantity_input" | "cost_calculate" | "modify_request" | "report_request";
+        | "quantity_input" | "cost_calculate" | "modify_request" | "report_request"
+        | "complex_estimate";
     // ... ê¸°ì¡´ í•„ë“œ ìœ ì§€
+    complexity?: "simple" | "complex";  // ë“€ì–¼ ëª¨ë¸ ë¼ìš°íŒ…ìš©
 }
```

**íŒŒê¸‰íš¨ê³¼**: TypeScript union type í™•ì¥ì´ë¯€ë¡œ ê¸°ì¡´ ì½”ë“œì— ì˜í–¥ ì—†ìŒ.

---

## ì „ì²´ ì•„í‚¤í…ì²˜ íë¦„ë„ (ìµœì¢…)

```mermaid
flowchart TD
    A["ğŸ§‘ ì‚¬ìš©ì ì§ˆë¬¸"] --> B["clarify.ts:<br/>analyzeIntent()"]
    B --> R1{"Route 1:<br/>entity_id ì§ì ‘?"}
    R1 -->|Yes| R1A["answerPipeline()<br/>+ Phase 1 ë…¸ì„ë‹¨ê°€"]
    R1A --> OUT1["ğŸ’¬ ì‘ë‹µ"]
    R1 -->|No| R2{"Route 2:<br/>section_id?"}
    R2 -->|Yes| R2A["fullViewPipeline()"]
    R2A --> OUT2["ğŸ’¬ ì‘ë‹µ"]
    R2 -->|No| R3{"Route 3:<br/>cost/clarify/etc?"}
    R3 -->|Yes| R3A["ê¸°ì¡´ ë¼ìš°íŠ¸<br/>(cost_calculate,<br/>clarify_needed ë“±)"]
    R3A --> OUT3["ğŸ’¬ ì‘ë‹µ"]

    R3 -->|No: search| CX{"classifyComplexity()"}

    CX -->|"simple<br/>(score < 4)"| D["targetSearch()"]
    D --> E["expandGraph()"]
    E --> F["buildContext()"]
    F --> G["generateAnswer()<br/>model: deepseek-chat"]
    G --> OUT4["ğŸ’¬ ì‘ë‹µ (ë¹ ë¦„, 2~3ì´ˆ)"]

    CX -->|"complex<br/>(score â‰¥ 4)"| I["generateReasoningGuide()<br/>model: deepseek-reasoner"]
    I --> J["ë§ˆìŠ¤í„°í”Œëœ JSON íŒŒì‹±"]
    J -->|"íŒŒì‹± ì‹¤íŒ¨"| D
    J -->|"íŒŒì‹± ì„±ê³µ"| K["search_tasksë³„<br/>ë‹¤ì¤‘ DB ê²€ìƒ‰"]
    K --> L["ê³„ì‚° ê³µì‹ +<br/>í• ì¦ ì¡°ê±´ ì£¼ì…"]
    L --> M["generateAnswer()<br/>model: deepseek-chat"]
    M --> OUT5["ğŸ’¬ ì‘ë‹µ (ì •ë°€, 5~8ì´ˆ)"]

    style CX fill:#ff9800,color:#000
    style I fill:#e91e63,color:#fff
    style G fill:#4caf50,color:#fff
    style M fill:#4caf50,color:#fff
    style R1 fill:#2196f3,color:#fff
    style R2 fill:#2196f3,color:#fff
    style R3 fill:#2196f3,color:#fff
```

---

## ìˆ˜ì • ëŒ€ìƒ íŒŒì¼ ìš”ì•½

| Phase | íŒŒì¼ | ë³€ê²½ ìœ í˜• | í•µì‹¬ ë³€ê²½ | Claude ë³´ì • ë°˜ì˜ |
|---|---|---|---|---|
| 1 | [index.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/index.ts) | MODIFY | ë…¸ì„ë‹¨ê°€ ì„œë²„ ì‚¬ì „ ê³„ì‚° + `findBestCostMatch()` | #1 #3 |
| 1 | [llm.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/llm.ts) | MODIFY | `cost_calculate` í”„ë¡¬í”„íŠ¸ ê°•ì œí™” | â€” |
| 2 | [clarify.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/clarify.ts) | MODIFY | `classifyComplexity()` í•¨ìˆ˜ ì¶”ê°€ (ì„ê³„ê°’ 4) | #5 |
| 2 | [llm.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/llm.ts) | MODIFY | `generateReasoningGuide()` í•¨ìˆ˜ ì¶”ê°€ | #4 #5 |
| 2 | [index.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/index.ts) | MODIFY | `handleChat()` Route 4 ì§ì „ì— complex ë¶„ê¸° | #2 |
| 3 | [llm.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/llm.ts) | MODIFY | ë„ë©”ì¸ ìˆ˜í•™ ê³µì‹ë§Œ SYSTEM_PROMPT ì¶”ê°€ | #4 |
| 3 | [types.ts](file:///g:/My%20Drive/Antigravity/supabase/functions/rag-chat/types.ts) | MODIFY | `IntentAnalysis` íƒ€ì… í™•ì¥ | â€” |

> `graph.ts`, `search.ts`, `context.ts`, `resolve.ts`, `config.ts`ëŠ” **ë³€ê²½ ì—†ìŒ** (ê¸°ì¡´ ì½”ë“œ ì•ˆì „)

---

## ê¸°ì¡´ Routeë³„ íŒŒê¸‰íš¨ê³¼ ë¶„ì„

| ê¸°ì¡´ Route | Phase 1 | Phase 2 | Phase 3 |
|---|---|---|---|
| Route 1 (entity_id ì¹© í´ë¦­) | âœ… ì‚¬ì „ì—°ì‚° ì ìš© | âœ… ë¬´ì˜í–¥ (ë¶„ê¸° ì´ì „) | âœ… ë¬´ì˜í–¥ |
| Route 2 (section_id full_view) | âœ… ë¬´ì˜í–¥ | âœ… ë¬´ì˜í–¥ (ë¶„ê¸° ì´ì „) | âœ… ë¬´ì˜í–¥ |
| cost_calculate | âœ… ì‚¬ì „ì—°ì‚° ì ìš© | âœ… ë¬´ì˜í–¥ (ë¶„ê¸° ì´ì „) | âœ… ë¬´ì˜í–¥ |
| clarify_needed | âœ… ë¬´ì˜í–¥ | âœ… ë¬´ì˜í–¥ (ë¶„ê¸° ì´ì „) | âœ… ë¬´ì˜í–¥ |
| Route 4 (search, ë‹¨ìˆœ) | âœ… ë¬´ì˜í–¥ | âœ… ê¸°ì¡´ ê²½ë¡œ ìœ ì§€ | âš ï¸ ê³µì‹ ì¶”ê°€ ì˜í–¥ |
| Route 3.5 (search, ë³µí•©) | â€” | âš ï¸ **ì‹ ê·œ ê²½ë¡œ ì¶”ê°€** | âš ï¸ Reasoner ì˜ì¡´ |

---

## ê¶Œì¥ êµ¬í˜„ ìˆœì„œ

```
Phase 1 (ì¦‰ì‹œ â€” 1ì¼)
  â”œâ”€ index.ts: laborItems ì •ì œ + findBestCostMatch() + ì‚¬ì „ì—°ì‚°
  â”œâ”€ llm.ts: cost_calculate í”„ë¡¬í”„íŠ¸ ê°•í™”
  â””â”€ ë°°í¬ í›„ ê²€ì¦: "ê°•ê´€ìš©ì ‘ 200mm SCH 40 10ê°œì†Œ ë…¸ë¬´ë¹„"
       â†“
Phase 2-1 (1~2ì¼)
  â”œâ”€ clarify.ts: classifyComplexity() ì¶”ê°€ (ì„ê³„ê°’ 4ì )
  â”œâ”€ llm.ts: generateReasoningGuide() ì¶”ê°€
  â”œâ”€ DeepSeek Reasoner API ì‹¤ì œ í˜¸ì¶œ í…ŒìŠ¤íŠ¸ (system role ë™ì‘ í™•ì¸)
  â””â”€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: complexity ì ìˆ˜ ë¡œê¹… í™•ì¸
       â†“
Phase 2-2 (1ì¼)
  â”œâ”€ index.ts: handleChat() Route 4 ì§ì „ì— complex ë¶„ê¸° ì‚½ì…
  â””â”€ ë°°í¬ í›„ ê²€ì¦: "ì›í˜• ë•íŠ¸ 4T 1300mm í•´ì²´" â†’ Reasoner ë¡œê·¸ í™•ì¸
       â†“
Phase 3 (1~2ì¼)
  â”œâ”€ llm.ts: SYSTEM_PROMPTì— ë„ë©”ì¸ ìˆ˜í•™ ê³µì‹ë§Œ ì¶”ê°€
  â”œâ”€ types.ts: IntentAnalysis íƒ€ì… í™•ì¥
  â”œâ”€ âŒ Chat SYSTEM_PROMPTì—ëŠ” ìš°íšŒ ì¶”ë¡  ê·œì¹™ ë„£ì§€ ì•ŠìŒ
  â””â”€ ë°°í¬ í›„ ê²€ì¦: NotebookLM ë™ì¼ ì§ˆë¬¸ ë¹„êµ í…ŒìŠ¤íŠ¸
```

---

## ë¹„ìš© ì˜ˆì¸¡

| êµ¬ë¶„ | í˜„ì¬ (chat Only) | ë“€ì–¼ ëª¨ë¸ ì ìš© í›„ |
|---|---|---|
| ë‹¨ìˆœ ì§ˆë¬¸ (80%) | ~â‚©2/ê±´ | ~â‚©2/ê±´ (ë³€ë™ ì—†ìŒ) |
| ë³µí•© ì§ˆë¬¸ (20%) | ~â‚©2/ê±´ (í’ˆì§ˆ ë‚®ìŒ) | ~â‚©8~12/ê±´ (reasoner ì¶”ê°€) |
| **ì›”ê°„ ì˜ˆìƒ** (ì¼ 100ê±´) | ~â‚©6,000 | ~â‚©8,400 (+40%) |

> [!TIP]
> ì›” ë¹„ìš© ì¦ê°€ë¶„ì€ ì•½ â‚©2,400(~$1.7)ì´ì§€ë§Œ, ë³µí•© ì§ˆë¬¸ í’ˆì§ˆì´ NotebookLM ìˆ˜ì¤€ìœ¼ë¡œ ê¸‰ìƒìŠ¹í•˜ë¯€ë¡œ ROI ê·¹ëŒ€í™”
