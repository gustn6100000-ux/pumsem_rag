# [UX 분석 및 개선 계획서] 검색 파이프라인 편의성 강화

## 1. 개요 및 문제점 분석

사용자가 제공한 스크린샷 4장과 현재 백엔드(Edge Function) 로직을 대조 분석한 결과, 사용자가 지적한 "규격 선택의 어려움"과 "결과 데이터의 가독성 저하"는 타당한 지적이며, 다음과 같은 기술적 원인이 있습니다.

### 문제점 A: "규격 선택" (Clarify UI) 단계의 인지 과부하
- **현상**: "플랜지 배관설치" 검색 시, 15개 이상의 규격 옵션(옥외 용접식, 옥내 나사식, 재질별 조합 등)이 단순히 1차원 체크박스 리스트로 나열됨 (스크린샷 1, 2).
- **원인**: 백엔드 `resolve.ts`의 `buildSelectorPanel` 로직이 하위 WorkType이 6개 이상일 때 필터(FilterAxis)를 생성하긴 하지만, **재질/관경/접합방식 등 논리적 계층 구조(Tree)나 단계별 선택(Step-by-step)을 제공하지 않고** 모든 조합의 리스트를 한 번에 뿌려버립니다. 사용자는 본인이 원하는 최종 형태를 위해 수많은 텍스트를 일일이 읽고 찾아야 합니다.

### 문제점 B: 매트릭스 교차표의 가독성 및 효율성 부재
- **현상**: 최종 산출 결과(스크린샷 3, 4)에서 직종별/규격별 인력 투입량이 교차표 형태로 렌더링되나, 텍스트(마크다운 표) 기반으로 빽빽하게 출력되어 한눈에 파악하기 어렵고 "뱉어내는 듯한" 느낌을 줍니다.
- **원인**: 백엔드 `index.ts`의 `renderMatrixTable` 함수가 DB의 그래프 관계(REQUIRES_LABOR)를 단순히 행(직종)-열(규격) 마크다운 문자열로 조합하여 LLM에 넘깁니다. 정보량이 많은 '플랜트 배관 설치' 같은 복합 표에서는 열(Column)이 수십 개로 늘어나며 마크다운 테이블이 깨지거나 가독성이 현저히 떨어집니다.

---

## 2. User Review Required

> [!IMPORTANT]
> 본 개선안은 백엔드 응답 구조의 대대적인 변경과 더불어 **프론트엔드 UI의 전면적인 개편**을 동반해야 완벽히 해결되는 이슈입니다. (현재 로컬 `pjt/pumsem` 소스에는 클라우드에 배포된 프론트엔드 소스코드(Next.js 등으로 추정)가 없는 상태입니다).
> 
> 따라서 **백엔드의 데이터 구조 개선(Phase 1)**을 먼저 진행할 수 있으며, 이 변경 사항을 프론트엔드 레포지토리 담당자가 UI 컴포넌트로 구현(Phase 2)해 주어야 합니다. 이 접근 방향에 동의하시는지 확인 부탁드립니다.

---

## 3. Proposed Changes (백엔드 관점 개선 방향)

### [Phase 1-A] Clarify(명확화) 응답 구조의 단계별/계층적 전환
현재의 단순 리스트(`options` 배열) 나열 방식을 버리고, **계층형 드릴다운 기능**을 강화합니다.
- **`resolve.ts` 수정**: 
  - `FilterAxis`를 발전시켜, 재질 → 접합 방식 → 관경 순서로 뎁스(Depth)를 가진 JSON 객체 트리 형태로 프론트엔드에 전달.
  - LLM 시스템 프롬프트를 수정하여 Clarify 응답이 단순 마크다운 텍스트 출력이 아닌, "Step 1: 재질 선택", "Step 2: 접합 선택" 식의 UI 렌더링용 메타데이터를 담도록 고도화.

### [Phase 1-B] Matrix Table 응답의 JSON 구조화 (렌더링 위임)
마크다운 조합 로직(`renderMatrixTable`)을 폐기하거나 보조 수단으로만 내리고, **구조화된 JSON 데이터 자체를 프론트엔드로 전달**합니다.
- **`index.ts` 수정**:
  - `ChatResponse` 타입 내에 `matrix_data` 필드를 신설.
  - 행(직종), 열(관경/규격), 셀값(수량/단가) 정보를 담은 JSON 데이터 셋업 생성.
  - 프론트엔드는 이 JSON을 바탕으로 고정형 헤더(Sticky Header), 가로 스크롤, 특정 단위 강조 색상 등이 적용된 **동적 데이터 그리드(Ag-Grid 등) 컴포넌트로 렌더링**하도록 유도.

## 4. Verification Plan

### Manual Verification
1. 변경된 로직 적용 후 `플랜지 배관설치` 검색을 로컬 백엔드(`test_api.js`)로 호출합니다.
2. 반환된 JSON에서 `clarification.selector` 배열이 단순 1차원 목록이 아닌 계층화된 메타데이터를 포함하는지 검증합니다.
3. 반환된 JSON(`chat_response`) 내에 마크다운 텍스트 덩어리 대신 구조화된 `matrix_data` 객체가 존재하는지 검증합니다.
4. 사용자(클라이언트)가 이 JSON을 활용하여 계층형 UI와 동적 그리드를 그릴 수 있는 상태임이 확인되면 백엔드 개선이 완료됩니다.
