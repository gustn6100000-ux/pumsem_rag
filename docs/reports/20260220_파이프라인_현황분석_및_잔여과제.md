# ğŸ›ï¸ ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì•„í‚¤í…ì²˜ ë¬´ê²°ì„± ì§„ë‹¨ ë° ê³ ë„í™” ë³´ê³ ì„œ (Final Consolidated)

**ì‘ì„±ì¼:** 2026-02-20  
**ë²„ì „:** v4.0 (Final Consolidated â€” ì›ì¸ ë¶„ì„ + êµì°¨ ê²€ì¦ + ë²„ê·¸ ìˆ˜ì • í†µí•©)  
**ì»¨í…ìŠ¤íŠ¸:** Solar Pro 3 vs DeepSeek-V3 A/B í…ŒìŠ¤íŠ¸, 13-2-4(ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘) ì‹¬ì¸µ ë¹„êµ, ë¹ˆ í…ìŠ¤íŠ¸ ì›ì¸ ì •ë°€ ë¶„ì„, êµì°¨ ê²€ì¦ ì•„í‚¤í…ì²˜ ì„¤ê³„ ë° ì½”ë“œ ë¦¬ë·° ë°˜ì˜

---

## Executive Summary

í˜„ì¬ íŒŒì´í”„ë¼ì¸ì˜ í”„ë¡¬í”„íŠ¸ ì „ê°œ ë¡œì§ê³¼ Pydantic ìŠ¤í‚¤ë§ˆ ê²€ì¦ ì²´ê³„ëŠ” í›Œë¥­í•œ ê¸°ë°˜ì„ ê°–ì¶”ì—ˆìœ¼ë‚˜, ì „ì²´ ë°ì´í„° í’ˆì§ˆ ì§€í‘œëŠ” **75%ì— ì •ì²´**ë˜ì–´ ìˆë‹¤. ì „ì²´ ì…ë ¥ ë°ì´í„°ì˜ 43.1%ë¥¼ ì°¨ì§€í•˜ëŠ” 'ë¹ˆ í…ìŠ¤íŠ¸ ì²­í¬'ê°€ LLMì˜ ê°•ì œ ì¶”ë¡ (Hallucination)ì„ ìœ ë°œí•˜ì—¬ ì§€ì‹ ê·¸ë˜í”„ì˜ ì¡´ì¬ë¡ ì  ë¬´ê²°ì„±(Ontological Integrity)ì„ í›¼ì†í•˜ëŠ” **ë‹¨ì¼ ìµœê³  ì¥ì• ì (Single Point of Failure)**.

### ê¸ˆë²ˆ ì •ë°€ ë¶„ì„ìœ¼ë¡œ ë°í˜€ì§„ 3ëŒ€ í•µì‹¬ ì‚¬ì‹¤

1. ë¹ˆ í…ìŠ¤íŠ¸ 908ê°œ ì¤‘ **903ê°œ(99.4%)ëŠ” ì„œë¸Œì²­í¬ ë¶„ë¦¬ì— ì˜í•œ Phase 1ì˜ ì„¤ê³„ ì˜ë„ëœ ê²°ê³¼**ì´ë©°, **899ê°œ(99%)ëŠ” í˜•ì œ ì²­í¬ì—ì„œ í…ìŠ¤íŠ¸ ë³µì› ê°€ëŠ¥**
2. `max_tokens=8192`ëŠ” **ì´ë¯¸ ì½”ë“œì— ì ìš© ì™„ë£Œ** (step2_llm_extractor.py:290)
3. LLM ì‚°ì¶œë¬¼ì˜ ì›ë³¸ ëŒ€ì¡°(Cross-Validation)ëŠ” í›„ì²˜ë¦¬ ë…ë¦½ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë””ì»¤í”Œë§í•˜ì—¬ êµ¬í˜„í•´ì•¼ í•˜ë©°, ì´ˆê¸° ê²€ì¦ ì½”ë“œì—ì„œ ë°œê²¬ëœ **í† í°í™” ë‹¨ìœ„ ë¶ˆì¼ì¹˜ ë²„ê·¸**ë¥¼ ë°˜ë“œì‹œ ìˆ˜ì •í•´ì•¼ í•¨

### ìµœì¢… ëª©í‘œ

- **í• ë£¨ì‹œë„¤ì´ì…˜ â‰¤ 2%** (`config.py` E6 ê¸°ì¤€ `hallucination_max: 0.02`)
- **P0(2ì‹œê°„) + P1(3~4ì‹œê°„) + P1.5(0.5ì¼) = ì•½ 1.5ì¼ë§Œì— 87% í’ˆì§ˆ ë„ë‹¬**
- P2~P3ê¹Œì§€ ì™„ë£Œ ì‹œ **93%+ ë‹¬ì„±**

---

# Part I: íŒŒì´í”„ë¼ì¸ í˜„í™© ë¶„ì„

## 1. íŒŒì´í”„ë¼ì¸ ì•„í‚¤í…ì²˜ ê°œìš”

### 1-1. ì „ì²´ íë¦„

```
Phase 1 (ì²­í‚¹)          Phase 2 (ì¶”ì¶œ)                 Phase 3 (ì ì¬)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PDF â†’ Markdown    Step 2.1: í…Œì´ë¸” ê·œì¹™ ì¶”ì¶œ     Supabase ì ì¬
  â†’ chunks.json   Step 2.2: LLM ì—”í‹°í‹°/ê´€ê³„ ì¶”ì¶œ   â†’ graph_entities
  (2,105ê°œ ì²­í¬)   Step 2.3: ë³‘í•© + í’ˆì§ˆ ê²€ì¦       â†’ graph_relationships
                                                  â†’ graph_chunks
```

### 1-2. í•µì‹¬ íŒŒì¼ êµ¬ì¡°

| íŒŒì¼                     | ì—­í•                                                | ìœ„ì¹˜                 |
| :----------------------- | :------------------------------------------------- | :------------------- |
| `config.py`              | Phase 2 ì „ì²´ ì„¤ì • (ê²½ë¡œ, í‚¤ì›Œë“œ, ì„ê³„ê°’, LLM ì„¤ì •) | `phase2_extraction/` |
| `step2_llm_extractor.py` | LLM(DeepSeek-V3) ê¸°ë°˜ ì—”í‹°í‹°/ê´€ê³„ ì¶”ì¶œ (667ì¤„)     | `phase2_extraction/` |
| `chunks.json`            | Phase 1 ì¶œë ¥ â€” 2,105ê°œ ì²­í¬                        | `phase1_output/`     |
| `llm_entities.json`      | Step 2.2 ì¶œë ¥ â€” LLM ì¶”ì¶œ ê²°ê³¼                      | `phase2_output/`     |
| `merged_entities.json`   | Step 2.3 ì¶œë ¥ â€” ê·œì¹™+LLM ë³‘í•© ê²°ê³¼                 | `phase2_output/`     |

### 1-3. LLM ì¶”ì¶œ ì„¤ì • (í˜„ì¬)

| ì„¤ì •           | ê°’                                         | ì½”ë“œ ìœ„ì¹˜                    |
| :------------- | :----------------------------------------- | :--------------------------- |
| ëª¨ë¸           | `deepseek-chat` (DeepSeek-V3)              | `config.py:105`              |
| base_url       | `https://api.deepseek.com`                 | `step2_llm_extractor.py:48`  |
| temperature    | `0.1`                                      | `config.py:106`              |
| **max_tokens** | **`8192`** âœ… (ì´ë¯¸ ì ìš©)                   | `step2_llm_extractor.py:290` |
| ë™ì‹œì„±         | `10`                                       | `config.py:107`              |
| ì¬ì‹œë„         | `3íšŒ`                                      | `config.py:108`              |
| íƒ€ì„ì•„ì›ƒ       | `120ì´ˆ`                                    | `step2_llm_extractor.py:262` |
| ì¶œë ¥ í˜•ì‹      | `response_format: {"type": "json_object"}` | `step2_llm_extractor.py`     |

---

## 2. ì…ë ¥ ë°ì´í„° ë¶„í¬ (chunks.json ì‹¤ì¸¡)

### 2-1. ì „ì²´ ìˆ˜ì¹˜

| í•­ëª©                          | ê°’        |   ë¹„ìœ¨    |
| :---------------------------- | :-------- | :-------: |
| **ì´ ì²­í¬**                   | **2,105** |   100%    |
| í…ìŠ¤íŠ¸ ìˆëŠ” ì²­í¬              | 1,197     |   56.9%   |
| **í…ìŠ¤íŠ¸ ì—†ëŠ” ì²­í¬**          | **908**   | **43.1%** |
| í…Œì´ë¸” ì—†ëŠ” ì²­í¬ (í…ìŠ¤íŠ¸ë§Œ)   | 364       |   17.3%   |
| D_ê¸°íƒ€/C_êµ¬ë¶„ì„¤ëª…ë§Œ ìˆëŠ” ì²­í¬ | 1,004     |   47.7%   |

### 2-2. í…Œì´ë¸” ìœ í˜• ë¶„í¬

| ìœ í˜•         | ê°œìˆ˜  | ì„¤ëª…                                  |
| :----------- | :---: | :------------------------------------ |
| `D_ê¸°íƒ€`     | 2,039 | **ê°€ì¥ ë§ìŒ** â€” ë³µí•© ë§¤íŠ¸ë¦­ìŠ¤/ê¸°íƒ€ í‘œ |
| `A_í’ˆì…ˆ`     | 1,081 | í‘œì¤€í’ˆì…ˆ í‘œ (ê·œì¹™ ì¶”ì¶œ ëŒ€ìƒ)          |
| `B_ê·œëª¨ê¸°ì¤€` |  106  | ê·œëª¨ ê¸°ì¤€í‘œ                           |
| `C_êµ¬ë¶„ì„¤ëª…` |   â€”   | êµ¬ë¶„ ì„¤ëª…í‘œ                           |

> âš ï¸ í•˜ë‚˜ì˜ ì²­í¬ì— ì—¬ëŸ¬ í…Œì´ë¸”ì´ í¬í•¨ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, í…Œì´ë¸” ì´ ìˆ˜(3,226+)ëŠ” ì²­í¬ ìˆ˜(2,105)ë³´ë‹¤ ë§ìŒ.

### 2-3. D_ê¸°íƒ€ ì»¬ëŸ¼ ìˆ˜ ë¶„í¬ (ë§¤íŠ¸ë¦­ìŠ¤ ë³µì¡ë„ ì§€í‘œ)

| ì»¬ëŸ¼ ìˆ˜ | D_ê¸°íƒ€ í…Œì´ë¸” ìˆ˜ | ë¹„ê³                                  |
| :-----: | :--------------: | :----------------------------------- |
|   1~3   |       441        | ë‹¨ìˆœ í…Œì´ë¸”                          |
|   4~6   |       865        | ì¤‘ê°„ ë³µì¡ë„                          |
|   7~9   |       479        | ë†’ì€ ë³µì¡ë„                          |
|  10~13  |       313        | **ëŒ€í˜• ë§¤íŠ¸ë¦­ìŠ¤** (13-2-4 ê°™ì€ ìœ í˜•) |
|   14+   |        64        | **ê·¹ëŒ€í˜• ë§¤íŠ¸ë¦­ìŠ¤**                  |

> 10cols ì´ìƒ D_ê¸°íƒ€ í…Œì´ë¸”: **377ê°œ** â€” ì´ë“¤ì´ LLM ì¶”ì¶œì—ì„œ ê°€ì¥ ë¬¸ì œê°€ ë˜ëŠ” ëŒ€ìƒ

---

## 3. ì˜ êµ¬í˜„ëœ ë¶€ë¶„ â€” ìƒì„¸ ê·¼ê±°

### 3-1. Pydantic ìŠ¤í‚¤ë§ˆ ê²€ì¦

`step2_llm_extractor.py` 58~92í–‰ì— ì •ì˜ëœ 3ê°œ ìŠ¤í‚¤ë§ˆ:

```python
class LLMEntity(BaseModel):      # type, name, spec, unit, quantity
class LLMRelationship(BaseModel): # source, target, relation_type, quantity, unit, properties
class LLMExtractionResult(BaseModel): # matrix_analysis_scratchpad, entities[], relationships[], summary, confidence
```

- LLM ì¶œë ¥ì´ ì´ ìŠ¤í‚¤ë§ˆì— ë§ì§€ ì•Šìœ¼ë©´ **ìë™ ê±°ë¶€** â†’ í• ë£¨ì‹œë„¤ì´ì…˜ êµ¬ì¡°ë¬¼ ì°¨ë‹¨
- `model_validate_json()`ìœ¼ë¡œ ì¦‰ì‹œ ê²€ì¦ â†’ ì—ëŸ¬ ì‹œ ì¬ì‹œë„(3íšŒ)

### 3-2. ë§¤íŠ¸ë¦­ìŠ¤ ì „ê°œ í”„ë¡¬í”„íŠ¸ ì„¤ê³„

`SYSTEM_PROMPT` 97~143í–‰ì— êµ¬ì²´ì ì¸ 9ê°œ ê·œì¹™ ëª…ì‹œ:

- **ê·œì¹™ 7**: "ê°€ë¡œì¶•ì— ì—¬ëŸ¬ ê·œê²©ì´ ë‚˜ì—´ëœ í‘œëŠ” ì ˆëŒ€ ì¤‘ê°„ ê·œê²©ì„ ìƒëµí•˜ê±°ë‚˜ 'ë“±'ìœ¼ë¡œ ë¬¶ì§€ ë§ˆì‹­ì‹œì˜¤. **ëª¨ë“  ê·œê²©ì— ëŒ€í•´ ë…ë¦½ëœ ê´€ê³„ ê°ì²´ë¥¼ 100% ì „ê°œ(Unroll)**"
- **ê·œì¹™ 8**: "`properties.source_spec`ì— í•´ë‹¹ ìˆ˜ëŸ‰ì˜ ì •í™•í•œ ê·œê²© ë¬¸ìì—´ì„ ë°˜ë“œì‹œ ê¸°ë¡"
- **ê·œì¹™ 9**: "`matrix_analysis_scratchpad`ì— '[ê·œê²© ìˆ˜] Ã— [ì§ì¢… ìˆ˜] = [ì´ ê´€ê³„ ìˆ˜]' í˜•íƒœë¡œ ì‚¬ê³  ê³¼ì • ê¸°ë¡"

### 3-3. í”„ë¡¬í”„íŠ¸ êµ¬ì„± (`build_user_prompt`)

`step2_llm_extractor.py` 202~257í–‰ â€” ì„¹ì…˜ ë©”íƒ€ë°ì´í„°, ë³¸ë¬¸ í…ìŠ¤íŠ¸, í…Œì´ë¸” Markdown ë³€í™˜, ì£¼ì„, êµì°¨ì°¸ì¡°ë¥¼ ì²´ê³„ì ìœ¼ë¡œ êµ¬ì„±

### 3-4. í‚¤ì›Œë“œ ê¸°ë°˜ ì—”í‹°í‹° ì •ê·œí™”

`config.py` 25~94í–‰ â€” `HEADER_ENTITY_MAPPING` (labor 37ê°œ, equipment 22ê°œ, material 22ê°œ), `LABOR_NORMALIZE_MAP` 18ê°œ ê³µë°± ì •ê·œí™”

### 3-5. í’ˆì§ˆ ê²€ì¦ ì„ê³„ê°’ ì •ì˜

`config.py` 96~102í–‰:

```python
EXTRACTION_THRESHOLDS = {
    "entity_coverage_min": 0.90,      # E1: â‰¥90% ì²­í¬ì—ì„œ 1+ ì—”í‹°í‹°
    "orphan_node_max": 0.05,          # E4: ê´€ê³„ ì—†ëŠ” ì—”í‹°í‹° â‰¤5%
    "sample_accuracy_min": 0.90,      # E5: ìˆ˜ë™ ê²€ì¦ ì •í™•ë„ â‰¥90%
    "hallucination_max": 0.02,        # E6: ì›ë³¸ì— ì—†ëŠ” ì—”í‹°í‹° â‰¤2%
}
```

> ì„ê³„ê°’ì€ ì •ì˜ë˜ì–´ ìˆì§€ë§Œ, **ìë™ ê²€ì¦ ë¡œì§ì€ ì•„ì§ ë¯¸êµ¬í˜„** (ìˆ˜ë™ ê²€ì¦ ì˜ì¡´). â†’ P1.5ì—ì„œ í•´ê²°

---

# Part II: ë¹ˆ í…ìŠ¤íŠ¸ 43.1% ì •ë°€ ì›ì¸ ë¶„ì„

## 4. ì›ì¸ ê·œëª… â€” ë°ì´í„° ì‹¤ì¸¡ ê²°ê³¼

### 4-1. í•µì‹¬ ë°œê²¬: ì„œë¸Œì²­í¬ ë¶„ë¦¬ê°€ ì›ì¸

| ë¶„ë¥˜                      |  ìˆ˜ëŸ‰   |   ë¹„ìœ¨    | ì„¤ëª…                                                                         |
| :------------------------ | :-----: | :-------: | :--------------------------------------------------------------------------- |
| ë¹ˆ í…ìŠ¤íŠ¸ ì¤‘ ì„œë¸Œì²­í¬     | **903** | **99.4%** | Phase 1ì—ì„œ í•˜ë‚˜ì˜ ì„¹ì…˜ì„ ì—¬ëŸ¬ ì²­í¬ë¡œ ë¶„ë¦¬í•  ë•Œ, **ì²« ë²ˆì§¸ì—ë§Œ í…ìŠ¤íŠ¸ ë°°ì •** |
| ë¹ˆ í…ìŠ¤íŠ¸ ì¤‘ ê¸°ë³¸ ì²­í¬    |    5    |   0.6%    | ì ‘ë¯¸ì‚¬ ì—†ì´ ë¹ˆ í…ìŠ¤íŠ¸ (ì§„ì§œ ëˆ„ë½ ê°€ëŠ¥ì„±)                                     |
| ì™„ì „ ê³µë°± (í…Œì´ë¸”ë„ ì—†ìŒ) |    2    |   0.2%    | í…ìŠ¤íŠ¸ë„ í…Œì´ë¸”ë„ ì—†ëŠ” ì™„ì „ ë¹ˆ ì²­í¬                                          |

### 4-2. ë‹¤ì¤‘ ì²­í¬ ì„¹ì…˜ì˜ í…ìŠ¤íŠ¸ ë¶„í¬ íŒ¨í„´

| í•­ëª©               |               ìˆ˜ì¹˜               |
| :----------------- | :------------------------------: |
| ë‹¨ì¼ ì²­í¬ ì„¹ì…˜     |              945ê°œ               |
| **ë‹¤ì¤‘ ì²­í¬ ì„¹ì…˜** | **222ê°œ** (ì´ 1,160ê°œ ì²­í¬ í¬í•¨) |

222ê°œ ë‹¤ì¤‘ ì„¹ì…˜ì˜ íŒ¨í„´:

| íŒ¨í„´              | ì„¹ì…˜ ìˆ˜ | ì˜ë¯¸                                |
| :---------------- | :-----: | :---------------------------------- |
| **T â†’ E**         |   63    | ì²« ì²­í¬ì— í…ìŠ¤íŠ¸, ë‘ ë²ˆì§¸ëŠ” ë¹”      |
| **T â†’ E â†’ E**     |   57    | ì²« ì²­í¬ì—ë§Œ í…ìŠ¤íŠ¸, ë‚˜ë¨¸ì§€ 2ê°œëŠ” ë¹” |
| **T â†’ E â†’ E â†’ E** |   24    | ì²« ì²­í¬ì—ë§Œ í…ìŠ¤íŠ¸, ë‚˜ë¨¸ì§€ 3ê°œëŠ” ë¹” |
| **T â†’ E Ã— 4~14**  |   63+   | ìµœëŒ€ 14ê°œ ì„œë¸Œì²­í¬ê¹Œì§€ ë¶„ë¦¬         |
| **E â†’ E**         |    2    | ì²« ì²­í¬ë„ ë¹ˆ í…ìŠ¤íŠ¸ (ì™„ì „ ëˆ„ë½)     |

> **ê²°ë¡ :** 222ê°œ ë‹¤ì¤‘ ì„¹ì…˜ ì¤‘ **207ê°œ(93.2%)**ê°€ "ì²« ë²ˆì§¸ì—ë§Œ í…ìŠ¤íŠ¸, ë‚˜ë¨¸ì§€ ë¹”" íŒ¨í„´. **Phase 1ì˜ ì„¤ê³„ ì˜ë„ëœ ë™ì‘.**

### 4-3. 13-2-4 ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘ ì‹¤ë¡€

```
C-0956-A  : text=220ch  tables=1  â† "3-2-4 ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘ 1. ì „ê¸°ì•„í¬ìš©ì ‘(Ví˜•)..."
C-0956-B  : text=  0ch  tables=1  â† (EMPTY) í…Œì´ë¸”ë§Œ
C-0956-C  : text=  0ch  tables=1  â† (EMPTY) í…Œì´ë¸”ë§Œ
   ...13ê°œ ì„œë¸Œì²­í¬ ëª¨ë‘ ë¹ˆ í…ìŠ¤íŠ¸...
C-0956-N  : text=  0ch  tables=1  â† (EMPTY) í…Œì´ë¸”ë§Œ
```

### 4-4. ë¹ˆ í…ìŠ¤íŠ¸ ì²­í¬ì˜ í…Œì´ë¸” ìœ í˜• ë¶„í¬

| í…Œì´ë¸” ìœ í˜•    | ì²­í¬ ìˆ˜ |
| :------------- | :-----: |
| `D_ê¸°íƒ€`ë§Œ     | **691** |
| `A_í’ˆì…ˆ`ë§Œ     |   124   |
| `B_ê·œëª¨ê¸°ì¤€`ë§Œ |   56    |
| í˜¼í•© ìœ í˜•      |   35    |
| í…Œì´ë¸” ì—†ìŒ    |    2    |

### 4-5. ì»¨í…ìŠ¤íŠ¸ ë³µì› ê°€ëŠ¥ì„±

| ë¶„ë¥˜                        |  ìˆ˜ëŸ‰   |   ë¹„ìœ¨    | ë³µì› ë°©ë²•                                       |
| :-------------------------- | :-----: | :-------: | :---------------------------------------------- |
| **í˜•ì œ ì²­í¬ì— í…ìŠ¤íŠ¸ ì¡´ì¬** | **899** | **99.0%** | ë™ì¼ base_idì˜ ì²« ë²ˆì§¸ ì„œë¸Œì²­í¬ì—ì„œ í…ìŠ¤íŠ¸ ì£¼ì… |
| í˜•ì œ ì²­í¬ì—ë„ í…ìŠ¤íŠ¸ ì—†ìŒ   |  **9**  |   1.0%    | confidence í•„í„°ë§ìœ¼ë¡œ ê²©ë¦¬                      |

---

## 5. P0 í•´ê²° ì „ëµ: í˜•ì œ ì»¨í…ìŠ¤íŠ¸ ì£¼ì… (ë°©ì•ˆ E)

### 5-1. ê¸°ì¡´ ë°©ì•ˆ ì¬í‰ê°€

| ë°©ì•ˆ                             | ì´ì „ íŒì •      | ì •ë°€ ë¶„ì„ í›„ íŒì • | ì´ìœ                             |
| :------------------------------- | :------------- | :---------------- | :------------------------------ |
| A. Phase 1 í…ìŠ¤íŠ¸ ë³µì›           | ê·¼ë³¸ í•´ê²°      | **ë¶ˆí•„ìš”**        | ë¹ˆ í…ìŠ¤íŠ¸ëŠ” Phase 1ì˜ ì„¤ê³„ ì˜ë„ |
| B. í”„ë¡¬í”„íŠ¸ ì–µì œ                 | ê³¼ì‰ ì–µì œ ìœ„í—˜ | **ë³´ì¡° ìˆ˜ë‹¨**     | 9ê°œ ê³ ë¦½ ì²­í¬ ì „ìš©              |
| C. confidence í•„í„°               | ì¤‘ê°„ íƒ€í˜‘      | **ë³´ì¡° ìˆ˜ë‹¨**     | 9ê°œ ê³ ë¦½ ì²­í¬ ì „ìš©              |
| D. ìˆ˜ëŸ‰ ëŒ€ì¡°                     | êµ¬í˜„ ë³µì¡      | **P1.5ë¡œ ì´ë™**   | ë…ë¦½ í›„ì²˜ë¦¬ë¡œ êµ¬í˜„              |
| **E. í˜•ì œ ì»¨í…ìŠ¤íŠ¸ ì£¼ì… (ì‹ ê·œ)** | â€”              | **P0 í•µì‹¬ ì „ëµ**  | 899ê°œ(99%) ì¦‰ì‹œ í•´ê²°            |

### 5-2. ë°©ì•ˆ E ìƒì„¸ ì„¤ê³„: `build_user_prompt()` ìˆ˜ì •

í˜„ì¬ `build_user_prompt()` (step2_llm_extractor.py:202~257)ì—ì„œ ë¹ˆ í…ìŠ¤íŠ¸ë©´ ë³¸ë¬¸ ë¸”ë¡ì´ í†µì§¸ë¡œ ìƒëµë¨.

**ìˆ˜ì • ë°©ì•ˆ:**
```python
def build_user_prompt(chunk: dict, all_chunks: list[dict]) -> str:
    text = chunk.get("text", "").strip()
    
    # â˜… ë¹ˆ í…ìŠ¤íŠ¸ì¼ ë•Œ: í˜•ì œ ì²­í¬ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ë³µì›
    if not text:
        base_id = re.match(r"(C-\d+)", chunk["chunk_id"]).group(1)
        siblings = [c for c in all_chunks 
                    if c["chunk_id"].startswith(base_id) and c.get("text","").strip()]
        if siblings:
            sibling_text = siblings[0].get("text", "").strip()
            parts.append(f"\n## ê´€ë ¨ ì»¨í…ìŠ¤íŠ¸ (ë™ì¼ ì„¹ì…˜ {siblings[0]['chunk_id']}ì—ì„œ ì°¸ì¡°)")
            parts.append(sibling_text)
            parts.append(f"\nâš ï¸ ìœ„ í…ìŠ¤íŠ¸ëŠ” ë™ì¼ ì„¹ì…˜ì˜ ë‹¤ë¥¸ ì²­í¬ì—ì„œ ê°€ì ¸ì˜¨ ì°¸ì¡° ì»¨í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤.")
            parts.append(f"ì•„ë˜ í…Œì´ë¸”ì˜ ì—”í‹°í‹°ì™€ ê´€ê³„ë¥¼ ì¶”ì¶œí•  ë•Œ ìœ„ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•˜ë˜,")
            parts.append(f"í…Œì´ë¸”ì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ë§Œ ì¶”ì¶œí•˜ì„¸ìš”.")
```

### 5-3. Context Bleeding ë¶€ì‘ìš© ê²½ê³ 

> âš ï¸ **íŒŒê¸‰ íš¨ê³¼ (A3 ê³µë¦¬):** í˜•ì œ ì²­í¬ C-0956-Aì˜ í…ìŠ¤íŠ¸ì— "3mm, 4mm" ê·œê²©ì´ ì–¸ê¸‰ë˜ì–´ ìˆëŠ”ë°, C-0956-B(7mm, 8mm, 9mm í…Œì´ë¸”)ì— ì£¼ì…ë˜ë©´ LLMì´ "3mm"ë¥¼ C-0956-Bì˜ ìˆ«ìì™€ ì˜ëª» ì—°ê²°í•  ê°€ëŠ¥ì„±ì´ ì¡´ì¬. ì´ ë¶€ì‘ìš©ì€ P1.5(êµì°¨ ê²€ì¦)ì—ì„œ í¬ì°©í•˜ì—¬ ê²©ë¦¬.

### 5-4. êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

| ë‹¨ê³„  | ì‘ì—… ë‚´ìš©                                       | ìˆ˜ì • íŒŒì¼                    | ì˜ˆìƒ ê³µìˆ˜ |
| :---: | :---------------------------------------------- | :--------------------------- | :-------: |
|   1   | `select_llm_target_chunks()`ì— ì „ì²´ chunks ì „ë‹¬ | `step2_llm_extractor.py:395` |   10ë¶„    |
|   2   | `build_user_prompt()`ì— í˜•ì œ ê²€ìƒ‰ + ì£¼ì… ë¡œì§   | `step2_llm_extractor.py:202` |   30ë¶„    |
|   3   | `extract_single_chunk()`ì—ì„œ `all_chunks` ì „ë‹¬  | `step2_llm_extractor.py:275` |    5ë¶„    |
|   4   | 9ê°œ ê³ ë¦½ ì²­í¬ì— `confidence â‰¤ 0.7` ìë™ ë¶€ì—¬    | `step2_llm_extractor.py`     |   15ë¶„    |
|   5   | 20ê°œ ìƒ˜í”Œ ê¸°ì¡´ ëŒ€ë¹„ í’ˆì§ˆ ë¹„êµ í…ŒìŠ¤íŠ¸            | CLI `--sample`               |   1ì‹œê°„   |

**ì´ ì˜ˆìƒ ê³µìˆ˜: 2ì‹œê°„**

---

## 6. max_tokens í˜„í™© í™•ì¸

### 6-1. í˜„ì¬ ì½”ë“œ ìƒíƒœ

`step2_llm_extractor.py` 290í–‰:
```python
max_tokens=8192,  # ğŸ’¡ [Track A] ë§¤íŠ¸ë¦­ìŠ¤ ì „ê°œ ì‹œ ì¶œë ¥ í† í° ë¶€ì¡±(Truncation) ë°©ì§€
```

**âœ… ì´ë¯¸ 8192ë¡œ ì ìš© ì™„ë£Œ. P1 ì „ì— ì¶”ê°€ ìˆ˜ì • ë¶ˆí•„ìš”.**

### 6-2. ì•ˆì „ ë§ˆì§„ ê²€ì¦

| ì²­í¬                         | ìœ í˜•          | DeepSeek output tokens | 8192 ëŒ€ë¹„ |
| :--------------------------- | :------------ | :--------------------: | :-------: |
| C-0944-B (í”ŒëœíŠ¸ ë°°ê´€)       | text_only     |         2,378          |    29%    |
| C-0956-A (ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘) | D_ê¸°íƒ€ 13cols |       **5,606**        |  **68%**  |

- ê°€ì¥ í° ì¶œë ¥ 5,606 tokens â†’ **32% ì—¬ìœ ** â†’ ì¶©ë¶„
- ê¶Œì¥: `config.py`ì— `LLM_MAX_TOKENS = 8192` ìƒìˆ˜ ë¶„ë¦¬

---

# Part III: LLM ì—”ì§„ ì˜ì‚¬ê²°ì • (A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼)

## 7. A/B í…ŒìŠ¤íŠ¸ ìƒì„¸ ìˆ˜ì¹˜ (12ê°œ ìƒ˜í”Œ)

| í•­ëª©             | DeepSeek-V3  | Solar Pro 3  | ë¹„ê³                |
| :--------------- | :----------: | :----------: | :----------------- |
| ì„±ê³µë¥            | 12/12 (100%) | 12/12 (100%) | max_tokens=8192 í›„ |
| ì´ ì—”í‹°í‹°        |     109      |   **150**    | Solar +37%         |
| ì´ ê´€ê³„          |   **258**    |     232      | DS +11%            |
| source_spec í¬í•¨ |   **210**    |     203      | DS +3%             |
| ì´ ì‹œê°„          |   **452s**   |     723s     | DS 1.6x ë¹ ë¦„       |
| ì´ Output í† í°   |    24,521    |  **64,778**  | Solar 2.6x         |

### ì—”í‹°í‹° ìœ í˜•ë³„

| ìœ í˜•      | DeepSeek | Solar  |    ì°¨ì´    |
| :-------- | :------: | :----: | :--------: |
| WorkType  |    12    | **22** | Solar +83% |
| Labor     |  **23**  |   21   |  DS +10%   |
| Equipment |    13    |   15   | Solar +15% |
| Material  |    20    | **29** | Solar +45% |
| Note      |    36    | **57** | Solar +58% |

### 13-2-4 ì‹¬ì¸µ ë¹„êµ

| í•­ëª©          |       DeepSeek        |       Solar        |
| :------------ | :-------------------: | :----------------: |
| C-0956-A ì„±ê³µ | âœ… (24 REQUIRES_LABOR) |   âŒ (JSON ì˜ë¦¼)    |
| C-0956-B ì„±ê³µ | âœ… (24 REQUIRES_LABOR) | âŒ (137.8s ë’¤ ì‹¤íŒ¨) |
| output tokens |        ~5,600         |  ~14,000+ (ì˜ë¦¼)   |

### ì—”ì§„ ê²°ì •

**DeepSeek-V3ë¡œ ë©”ì¸ íŒŒì´í”„ë¼ì¸ ë‹¨ì¼í™” í™•ì •.** Solar Pro 3ì€ í–¥í›„ ìœ ë£Œ ë‹¨ê°€ í™•ì • ì‹œ ì—”í‹°í‹° ë³´ê°• ì „ìš©ìœ¼ë¡œë§Œ ê²€í† .

---

# Part IV: êµì°¨ ê²€ì¦(Cross-Validation) ì•„í‚¤í…ì²˜

## 8. ê²€ì¦ê¸° ë„ì… ë°°ê²½

### 8-1. P0 ì»¨í…ìŠ¤íŠ¸ ì£¼ì…ì˜ ìˆ¨ê²¨ì§„ ìœ„í—˜: Context Bleeding

í˜•ì œ ì»¨í…ìŠ¤íŠ¸(P0)ê°€ ì£¼ì…ë˜ë©´ LLMì€ í’ë¶€í•´ì§„ ë§¥ë½ìœ¼ë¡œ ë” ê·¸ëŸ´ì‹¸í•œ JSONì„ ìƒì„±í•˜ì§€ë§Œ, Pydanticì€ **ë°ì´í„° íƒ€ì…(Float, String)ë§Œ ê²€ì‚¬**í•  ë¿ ì›ë³¸ì— **ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ê°’ì¸ì§€** íŒë³„ ë¶ˆê°€.

| í• ë£¨ì‹œë„¤ì´ì…˜ ìœ í˜•              | ì„¤ëª…                                                     | ë°œìƒ ê°€ëŠ¥ì„± |
| :----------------------------- | :------------------------------------------------------- | :---------: |
| **ìœ ë ¹ ìˆ˜ëŸ‰ (Ghost Quantity)** | ì£¼ì… ë§¥ë½ì„ ì˜¤í•´í•˜ì—¬ í‘œì— ì—†ëŠ” ìˆ«ìë¥¼ ê³„ì‚°               |    ë†’ìŒ     |
| **ìœ ë ¹ ê·œê²© (Ghost Spec)**     | í˜•ì œ í…ìŠ¤íŠ¸ì™€ í˜„ì¬ í…Œì´ë¸” í—¤ë”ë¥¼ ìœµí•©í•˜ì—¬ ê°€ì§œ ê·œê²© ìƒì„± |    ë†’ìŒ     |
| **íŒŒìƒê°’ (Derived Value)**     | ì›ë³¸ í•©ì‚°/ë¹„ìœ¨ ê³„ì‚° â†’ ì •ìƒ ì¶”ë¡ ì´ì§€ë§Œ ì›ë³¸ì—ëŠ” ì—†ëŠ” ìˆ«ì |    ì¤‘ê°„     |

### 8-2. ì•„í‚¤í…ì²˜ ê²°ì •: ë””ì»¤í”Œë§ (í›„ì²˜ë¦¬ ë¶„ë¦¬)

| ë°©ì‹                                  | ì¥ì                               | ë‹¨ì                  | ê²°ì •  |
| :------------------------------------ | :-------------------------------- | :------------------- | :---: |
| ì¸ë¼ì¸ (ì¶”ì¶œ ì§í›„ ì¦‰ì‹œ ê²€ì¦)          | ë©”ëª¨ë¦¬ì— ì›ë³¸ ì´ë¯¸ ë¡œë“œ           | async/semaphore ë³‘ëª© |   âŒ   |
| **í›„ì²˜ë¦¬ (P1 ì™„ë£Œ í›„ ë³„ë„ ìŠ¤í¬ë¦½íŠ¸)** | P1 ì½”ë“œ ë³€ê²½ ìµœì†Œ, ì •ì±… ììœ  ì¡°ì • | ì›ë³¸ ì¬ë¡œë“œ í•„ìš”     |   âœ…   |

> P1(`extract_single_chunk()`)ì€ ì´ë¯¸ ë¹„ë™ê¸° + ì„¸ë§ˆí¬ì–´(10)ë¡œ ë³µì¡ë„ê°€ ê·¹ì— ë‹¬í•´ ìˆìŒ. ê²€ì¦ê¸°ë¥¼ ë¼ì›Œ ë„£ìœ¼ë©´ ë©”ëª¨ë¦¬ ë¶€í•˜ì™€ ì—ëŸ¬ íŠ¸ë˜í‚¹ ë¶ˆê°€ ìƒíƒœì— ë¹ ì§.

---

## 9. ê²€ì¦ê¸° ì½”ë“œ ì„¤ê³„ (Bug-Fixed Final)

### 9-1. ì´ˆê¸° ì„¤ê³„ì—ì„œ ë°œê²¬ëœ 3ëŒ€ ë²„ê·¸ ë° ìˆ˜ì •

#### Bug 1: `rows` ë°ì´í„° êµ¬ì¡° ë¶ˆì¼ì¹˜ âœ… ìˆ˜ì •ë¨

**ë¬¸ì œ:** `chunks.json`ì˜ `table.rows`ëŠ” `List[Dict]` êµ¬ì¡°. `for cell in row`ëŠ” ë”•ì…”ë„ˆë¦¬ì˜ Keyë§Œ ìˆœíšŒí•˜ì—¬ ìˆ˜ëŸ‰ ìˆ«ìë¥¼ ì „í˜€ ìˆ˜ì§‘ ëª»í•¨.

```diff
  for row in table.get("rows", []):
-     for cell in row:                    # â† Keyë§Œ ìˆœíšŒ (Bug)
-         truth_numbers.update(extract_numbers(cell))
+     for key, value in row.items():      # â† Key+Value ëª¨ë‘ ìˆœíšŒ (Fixed)
+         truth_numbers.update(extract_numbers(str(value)))
```

#### Bug 2: ë¬¸ìì—´ ì—°ê²° ê¸°ë°˜ substring ì˜¤íŒ âœ… Set ë§¤ì¹­ìœ¼ë¡œ êµì²´

**ë¬¸ì œ:** ëª¨ë“  í—¤ë”/ì…€ì„ í•˜ë‚˜ì˜ ê±°ëŒ€í•œ ë¬¸ìì—´ë¡œ ì—°ê²° í›„ `in` ê²€ìƒ‰ â†’ `"13mm"` ì•ˆì— `"3mm"`ê°€ í¬í•¨ë˜ì–´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê·œê²© í†µê³¼ (False Negative)

```diff
- truth_strings += normalize_text(header)        # ì—°ê²° (Bug)
- if normalize_text(spec) not in truth_strings:   # substring ê²€ìƒ‰ (Bug)
+ truth_tokens.update(tokenize(header))           # Set ë¶„ì ˆ (Fixed)
+ if not spec_tokens.issubset(truth_tokens):      # Set subset ë§¤ì¹­ (Fixed)
```

#### Bug 2.5: í† í°í™” ë‹¨ìœ„ ë¶ˆì¼ì¹˜ âœ… ì¶”ê°€ ìˆ˜ì • í•„ìš”

**ë¬¸ì œ (ì½”ë“œ ë¦¬ë·°ì—ì„œ ë°œê²¬):** `header.split()`ì€ ê³µë°±ìœ¼ë¡œë§Œ ë¶„í• í•˜ì§€ë§Œ, ì‹¤ì œ í—¤ë”ëŠ” ë°‘ì¤„ êµ¬ë¶„:

```python
"ì¸ë ¥(ì¸)_í•˜í–¥_ìš©ì ‘ê³µ".split()  â†’  ["ì¸ë ¥(ì¸)_í•˜í–¥_ìš©ì ‘ê³µ"]  # ë¶„í•  ì•ˆ ë¨!
```

LLMì€ `source_spec: "3mm í•˜í–¥"`ì„ ì¶œë ¥í•˜ì§€ë§Œ, truth_tokensì— `"í•˜í–¥"`ì´ ë…ë¦½ í† í°ìœ¼ë¡œ ì¡´ì¬í•˜ì§€ ì•Šì•„ ì •ìƒ ë°ì´í„°ë¥¼ í• ë£¨ì‹œë„¤ì´ì…˜ìœ¼ë¡œ ì˜¤íŒ.

**ìˆ˜ì •:** `split()` ëŒ€ì‹  ë³µí•© êµ¬ë¶„ì ë¶„í•  í•¨ìˆ˜ ì‚¬ìš©:

```python
def tokenize(text: str) -> set[str]:
    """ê³µë°±, ë°‘ì¤„, ê´„í˜¸, ìŠ¬ë˜ì‹œ ë“± ë³µí•© êµ¬ë¶„ìë¡œ ë¶„í•  í›„ ì •ê·œí™”"""
    parts = re.split(r'[\s_/\(\)\[\]\-]+', str(text))
    return {normalize_token(p) for p in parts if p.strip()}
```

ì ìš© ê²°ê³¼:
```python
tokenize("ì¸ë ¥(ì¸)_í•˜í–¥_ìš©ì ‘ê³µ")  â†’  {"ì¸ë ¥", "ì¸", "í•˜í–¥", "ìš©ì ‘ê³µ"}
tokenize("3mm í•˜í–¥")            â†’  {"3mm", "í•˜í–¥"}
# {"3mm", "í•˜í–¥"}.issubset({"ì¸ë ¥", "ì¸", "í•˜í–¥", "ìš©ì ‘ê³µ", ...})  â†’ True âœ…
```

#### Bug 3: íŒŒìƒê°’(Derived Value) ì˜¤íŒ âœ… ì •ì±… í”„ë ˆì„ì›Œí¬ë¡œ í•´ê²°

**ë¬¸ì œ:** LLMì´ ì›ë³¸ì˜ í•©ì‚°/ë¹„ìœ¨/í• ì¦ ê³„ì‚°ê°’ì„ ì¶œë ¥í•˜ë©´, ê¸°ê³„ì  ëŒ€ì¡°ì—ì„œ "ì›ë³¸ì— ì—†ìŒ"ìœ¼ë¡œ íŒì •.

| ìƒí™©      | ì›ë³¸                 | LLM ì¶œë ¥    |   ê¸°ê³„ íŒì •    |  ì‹¤ì œ  |
| :-------- | :------------------- | :---------- | :------------: | :----: |
| í•©ì‚°      | í•˜í–¥:0.03, íš¡í–¥:0.04 | `qty:0.07`  | âŒ í• ë£¨ì‹œë„¤ì´ì…˜ | âœ… ì •ìƒ |
| ë‹¨ìœ„ ë³€í™˜ | 100më‹¹ 0.5ì¸         | `qty:0.005` | âŒ í• ë£¨ì‹œë„¤ì´ì…˜ | âœ… ì •ìƒ |
| í• ì¦      | ê¸°ë³¸:0.1, í• ì¦ 20%   | `qty:0.12`  | âŒ í• ë£¨ì‹œë„¤ì´ì…˜ | âœ… ì •ìƒ |

**í•´ê²°: 3ë‹¨ê³„ ì •ì±… í”„ë ˆì„ì›Œí¬**

```python
VALIDATION_POLICY = {
    "strict":  "ì›ë³¸ì— ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ìˆ«ìë§Œ í†µê³¼",
    "relaxed": "ì›ë³¸ ìˆ«ì Â± 1% í—ˆìš© (ë¶€ë™ì†Œìˆ˜ì /ë°˜ì˜¬ë¦¼)",
    "derived": "ì›ë³¸ ìˆ«ìì˜ í•©Â·ê³±Â·ë‚˜ëˆ—ì…ˆ ê²°ê³¼ë„ í—ˆìš©",
}
```

> **ê¶Œì¥:** `strict`ë¡œ ì‹œì‘ â†’ Dead Letter Queue ë¶„ì„ â†’ í•„ìš” ì‹œ `relaxed`ë¡œ ì™„í™”. `derived` ëª¨ë“œëŠ” P2(Quarantine Review) ê²°ê³¼ë¥¼ ë³´ê³  ë‚˜ì„œ êµ¬í˜„.

### 9-2. ìµœì¢… ìˆ˜ì • ì½”ë“œ (validate_outputs.pyìš©)

```python
import re
from typing import Tuple, Set

VALIDATION_POLICY = "strict"
EPSILON = 1e-5

def normalize_token(text: str) -> str:
    """ë¹„êµë¥¼ ìœ„í•œ ë‹¨ì¼ í† í° ì •ê·œí™”"""
    if not text: return ""
    return re.sub(r'[\s,\(\)\[\]\{\}]', '', str(text)).lower()

def tokenize(text: str) -> set[str]:
    """ë³µí•© êµ¬ë¶„ì(ê³µë°±, ë°‘ì¤„, ê´„í˜¸, ìŠ¬ë˜ì‹œ)ë¡œ ë¶„í•  í›„ ì •ê·œí™” â€” Bug 2.5 Fix"""
    parts = re.split(r'[\s_/\(\)\[\]\-]+', str(text))
    return {normalize_token(p) for p in parts if p.strip()}

def extract_numbers(text: str) -> set[float]:
    """ë¬¸ìì—´ì—ì„œ ì†Œìˆ˜ì  í¬í•¨ ìˆ˜ì¹˜ ì¶”ì¶œ"""
    if not text: return set()
    nums = re.findall(r"[-+]?\d*\.\d+|\d+", str(text).replace(",", ""))
    return {float(n) for n in nums}

def build_truth_pool(original_chunk: dict) -> Tuple[Set[float], Set[str]]:
    """ì›ë³¸ ì²­í¬ì—ì„œ ê²€ì¦ìš© ì •ë‹µ í’€ ìƒì„±"""
    truth_numbers = set()
    truth_tokens = set()
    
    # í…ìŠ¤íŠ¸ í† í°í™”
    text = original_chunk.get("text", "")
    if text:
        truth_tokens.update(tokenize(text))
    
    # í…Œì´ë¸” í† í°í™” â€” Bug 1 & 2.5 Fixed
    for table in original_chunk.get("tables", []):
        for header in table.get("headers", []):
            truth_tokens.update(tokenize(header))  # tokenize() ì‚¬ìš©
            
        for row in table.get("rows", []):
            for key, value in row.items():          # dict.items() ì‚¬ìš©
                truth_tokens.update(tokenize(str(key)))
                truth_tokens.update(tokenize(str(value)))
                truth_numbers.update(extract_numbers(str(value)))
                
    return truth_numbers, truth_tokens

def check_quantity(q_val: float, truth_numbers: set[float], policy: str) -> bool:
    """ì •ì±… ê¸°ë°˜ ìˆ˜ëŸ‰ ê²€ì¦"""
    # Strict: ì •í™•íˆ ì¼ì¹˜
    if any(abs(q_val - t) < EPSILON for t in truth_numbers):
        return True
    if policy == "strict":
        return False
    # Relaxed: Â±1% í—ˆìš©
    if policy in ["relaxed", "derived"]:
        if any(abs(q_val - t) / (abs(t) + EPSILON) < 0.01 for t in truth_numbers):
            return True
    return False

def validate_against_source(llm_result: dict, original_chunk: dict) -> dict:
    """LLM ì¶”ì¶œ ê²°ê³¼ vs ì›ë³¸ êµì°¨ ëŒ€ì¡° (í›„ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ìš©)"""
    truth_numbers, truth_tokens = build_truth_pool(original_chunk)
    
    for rel in llm_result.get("relationships", []):
        is_valid = True
        warnings = []
        
        # ìˆ˜ëŸ‰ ê²€ì¦
        qty = rel.get("quantity")
        if qty is not None:
            try:
                if not check_quantity(float(qty), truth_numbers, VALIDATION_POLICY):
                    warnings.append(f"qty_mismatch: {qty}")
                    is_valid = False
            except ValueError:
                qty_tokens = tokenize(str(qty))
                if not qty_tokens.issubset(truth_tokens):
                    warnings.append(f"qty_text_mismatch: {qty}")
                    is_valid = False
                    
        # ê·œê²© ê²€ì¦
        spec = rel.get("properties", {}).get("source_spec", "")
        if spec:
            spec_tokens = tokenize(spec)
            if not spec_tokens.issubset(truth_tokens):
                missing = spec_tokens - truth_tokens
                warnings.append(f"spec_mismatch: missing={missing}")
                is_valid = False
                
        rel.setdefault("properties", {})["is_verified"] = is_valid
        if not is_valid:
            rel["properties"]["validation_warnings"] = warnings
            
    return llm_result
```

---

# Part V: To-Be ì•„í‚¤í…ì²˜ & ë¡œë“œë§µ

## 10. ì „ì²´ To-Be ì•„í‚¤í…ì²˜

```mermaid
graph TD
    subgraph "Phase 1: Ingestion"
        A["chunks.json<br>2,105 chunks"] --> B{"Has Sub-chunks?"}
        B -- "Yes: 1,160 chunks" --> C["Sub-chunk Group"]
        B -- "No: 945 chunks" --> D["Single Chunk"]
    end

    subgraph "P0: Context Recovery"
        C --> E{"Text Empty?"}
        E -- "899: sibling exists" --> F["Context Injector<br>í˜•ì œ í…ìŠ¤íŠ¸ ì£¼ì…"]
        E -- "9: isolated" --> G["Flag: confidence â‰¤ 0.7"]
        E -- "No" --> H["Pass Through"]
        D --> H
        F --> H
        G --> H
    end

    subgraph "P1: Main Extraction"
        H --> I["DeepSeek-V3<br>max_tokens: 8192"]
        I --> J{"Pydantic Check"}
        J -- "Valid" --> K["raw_llm_entities.json"]
        J -- "Invalid" --> L["Retry 3x"]
    end

    subgraph "P1.5: Post-Validation"
        K --> M{"Truth Validator<br>tokenize + Set match"}
        A -. "Ground Truth" .-> M
        M -- "Match" --> N["Verified Output"]
        M -- "Mismatch" --> O["Dead Letter Queue"]
    end

    subgraph "P3: DB Load"
        N --> P["Entity Resolution<br>Hash: section_id+name+type"]
        P --> Q[("Supabase DB")]
        O -. "P2: Human Review<br>Policy íŠœë‹" .-> M
    end

    style F fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    style G fill:#ffebee,stroke:#c62828,stroke-width:2px
    style M fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style O fill:#ffebee,stroke:#c62828,stroke-width:2px
    style N fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
```

---

## 11. ì™„ì„±ë„ íŒì • ë§¤íŠ¸ë¦­ìŠ¤

| í‰ê°€ ì°¨ì›            |   í˜„ì¬   | P0+P1 í›„ | P1.5 í›„  | ì „ ê³¼ì œ ì™„ë£Œ |
| :------------------- | :------: | :------: | :------: | :----------: |
| JSON êµ¬ì¡° ì •í•©ì„±     |   95%    |   95%    |   95%    |     95%      |
| ì—”í‹°í‹° ì¶”ì¶œ ì»¤ë²„ë¦¬ì§€ |   80%    | **90%**  |   90%    |     95%      |
| ê´€ê³„ ì „ê°œ ì™„ì „ì„±     |   75%    | **85%**  |   85%    |     95%      |
| ìˆ˜ëŸ‰ ì •í™•ì„±          |  ë¯¸ê²€ì¦  |  ë¯¸ê²€ì¦  | **90%+** |     93%+     |
| ì—”í‹°í‹° ì¤‘ë³µ í•´ì†Œ     |  ë¯¸ì²˜ë¦¬  |  ë¯¸ì²˜ë¦¬  |  ë¯¸ì²˜ë¦¬  |   **90%+**   |
| **ì „ì²´ ë°ì´í„° í’ˆì§ˆ** | **~75%** | **~87%** | **~90%** |   **~93%**   |

---

## 12. Master Action Roadmap (Final)

|    ìˆœìœ„    | ëª¨ë“ˆ                       | ìƒì„¸ ì•¡ì…˜                                                                                             | ë‚œì´ë„ / ê³µìˆ˜  | ì„ ìˆ˜ ì¡°ê±´ |        íš¨ê³¼        |
| :--------: | :------------------------- | :---------------------------------------------------------------------------------------------------- | :------------: | :-------- | :----------------: |
|   **P0**   | **Context Injector**       | `build_user_prompt()`ì— í˜•ì œ í…ìŠ¤íŠ¸ ì£¼ì… + 9ê°œ ê³ ë¦½ ì²­í¬ confidence ê°•ì œ                              | í•˜ / **2ì‹œê°„** | ì—†ìŒ      | **+12%p (75â†’87%)** |
|   **P1**   | **Main Extraction**        | DeepSeek-V3 (max_tokens=8192 í™•ì¸ë¨)ë¡œ 2,105ê±´ ì „ìˆ˜ ì¬ì¶”ì¶œ. **ê²€ì¦ ë¡œì§ ë°°ì œ.**                       |  í•˜ / 3~4ì‹œê°„  | P0 ì™„ë£Œ   |   Baseline í™•ë³´    |
| ğŸš¨ **P1.5** | **Post-Validator**         | `validate_outputs.py` ë…ë¦½ ìŠ¤í¬ë¦½íŠ¸. `tokenize()` + Set ë§¤ì¹­ + `strict` ì •ì±…. Dead Letter Queue ì ì¬. | ì¤‘ / **0.5ì¼** | P1 ì™„ë£Œ   | í• ë£¨ì‹œë„¤ì´ì…˜ ì‹ë³„  |
|  ğŸš¨ **P2**  | **Quarantine Review**      | Dead Letter Queue ë¦¬ë·°. íŒŒìƒê°’ íŒ¨í„´ í™•ì¸ í›„ `relaxed` ì •ì±… ì¬ì‹¤í–‰.                                    |    ì¤‘ / 1ì¼    | P1.5 ì™„ë£Œ |   **FP 15%â†’2%**    |
|   **P3**   | **Entity Resolution**      | `is_verified: True`ë§Œ `(section_id, name, type)` ë³µí•©í‚¤ + ON CONFLICT ë³‘í•©                            |   ìƒ / 2~3ì¼   | P2 ì™„ë£Œ   | **+3%p (90â†’93%)**  |
|   **P4**   | **Equipment Ground Truth** | DS/Solar ì¥ë¹„ í¸ì°¨(61 vs 19) ì›ë³¸ ëŒ€ì¡°                                                                |   ì¤‘ / 0.5ì¼   | P2 ì™„ë£Œ   |        +1%p        |
|   **P5**   | **Hybrid Routing**         | Solar ìœ ë£Œ ë‹¨ê°€ í™•ì • í›„ ì—”í‹°í‹° ë³´ê°• ì „ìš© ë¼ìš°íŒ…                                                       |    ì¤‘ / 1ì¼    | ê°€ê²© í™•ì • |   ì»¤ë²„ë¦¬ì§€ ì¶”ê°€    |

---

## 13. ë¹„ìš© ë¶„ì„

### í˜„ì¬ ê°€ê²© (2026-02-20 ê¸°ì¤€)

| ëª¨ë¸        |        Input         | Output  | 2,105ê±´ ì˜ˆìƒ ë¹„ìš© |
| :---------- | :------------------: | :-----: | :---------------: |
| DeepSeek-V3 |    $0.14~$0.28/M     | $0.42/M |     **~$5~8**     |
| Solar Pro 3 | **$0** (3ì›” 2ì¼ê¹Œì§€) | **$0**  |        $0         |

### 3ì›” 2ì¼ ì´í›„ Solar ì‹œë‚˜ë¦¬ì˜¤

| ì‹œë‚˜ë¦¬ì˜¤    | Solar ì˜ˆìƒ ë¹„ìš© | ë¹„êµ                     |
| :---------- | :-------------: | :----------------------- |
| $0.5/M ìˆ˜ì¤€ |     ~$15~20     | DSì˜ 2~3x (output 2.6ë°°) |
| $1.0/M ìˆ˜ì¤€ |     ~$30~40     | DSì˜ 5~6x                |

---

## 14. ìµœì¢… ê²°ë¡ 

1. **ë¹ˆ í…ìŠ¤íŠ¸ 43.1%ì˜ ì›ì¸ì€ Phase 1ì˜ ì„œë¸Œì²­í¬ ë¶„ë¦¬ ì„¤ê³„**ì´ë©°, Phase 1 ì¬íŒŒì‹±ì€ ë¶ˆí•„ìš”
2. **899ê°œ(99%)ëŠ” í˜•ì œ ì²­í¬ì—ì„œ í…ìŠ¤íŠ¸ ë³µì› ê°€ëŠ¥** â†’ P0 í•µì‹¬ì€ `build_user_prompt()` ìˆ˜ì • (2ì‹œê°„)
3. **max_tokens=8192ëŠ” ì´ë¯¸ ì ìš©** â†’ P1 ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥
4. **êµì°¨ ê²€ì¦(P1.5)ì€ í›„ì²˜ë¦¬ ë…ë¦½ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë””ì»¤í”Œë§** â€” ì´ˆê¸° ì½”ë“œì˜ 3.5ê°œ ë²„ê·¸ ëª¨ë‘ ìˆ˜ì • ì™„ë£Œ
5. **`tokenize()` í•¨ìˆ˜ë¡œ ë³µí•© êµ¬ë¶„ì ë¶„í• ** â€” D_ê¸°íƒ€ ë°‘ì¤„ í—¤ë” í˜¸í™˜ì„± í™•ë³´
6. **P0(2ì‹œê°„) + P1(3~4ì‹œê°„) + P1.5(0.5ì¼) = ì•½ 1.5ì¼ë§Œì— 90% í’ˆì§ˆ ë„ë‹¬**
7. P2~P3ê¹Œì§€ ì™„ë£Œ ì‹œ **í• ë£¨ì‹œë„¤ì´ì…˜ â‰¤ 2%, ì „ì²´ í’ˆì§ˆ 93%+ ë‹¬ì„±**

> **ì•„í‚¤í…íŠ¸ ìµœì¢… ì§€ì‹œ:** P0 â†’ P1 â†’ P1.5 â†’ P2 â†’ P3 ìˆœì„œë¥¼ ë°˜ë“œì‹œ ì¤€ìˆ˜. P0ì™€ P1.5 ìŠ¤í¬ë¦½íŠ¸ë¥¼ **ë³‘ë ¬ ê°œë°œ** ê°€ëŠ¥ (P1.5ëŠ” P1 ê²°ê³¼ë§Œ í•„ìš”í•˜ë¯€ë¡œ P0ì™€ ë…ë¦½). ëª¨ë“  ê²€ì¦ í†µê³¼ ë°ì´í„°ë§Œ DBì— ì ì¬í•  ê²ƒ.

---

# Part VI: ì‹¤í–‰ì•ˆ ê²€í†  ë° êµ¬í˜„ ê°€ì´ë“œ

> **ì»¨í…ìŠ¤íŠ¸:** `20260220_ì”ì—¬ê³¼ì œ_í•´ê²°ë°©ì•ˆ_ì‹¤í–‰ì•ˆ.md` ê²€í†  ê²°ê³¼, ê¸°ì¡´ ë³´ê³ ì„œì—ì„œ ëˆ„ë½ëœ **ì„ê³„ê°’ ë¶ˆì¼ì¹˜** ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìœ¼ë©°, ê° ë‹¨ê³„ì˜ DoD(Definition of Done)ì™€ êµ¬ì²´ì  êµ¬í˜„ íë¦„ì„ ë³´ê°•í•¨.

---

## 15. ì‹ ê·œ ë°œê²¬: í’ˆì§ˆ ì„ê³„ê°’ ì´ì¤‘ ê¸°ì¤€ ë¬¸ì œ

### 15-1. ë¶ˆì¼ì¹˜ í˜„í™© (ì½”ë“œ ì‹¤ì¸¡)

`config.py`ì— ì •ì˜ëœ **ëª©í‘œ ì„ê³„ê°’**ê³¼ `step5_extraction_validator.py`ì— **í•˜ë“œì½”ë”©ëœ ì‹¤í–‰ ì„ê³„ê°’**ì´ ë¶ˆì¼ì¹˜:

| ê²€ì¦ í•­ëª©                  | config.py ëª©í‘œ |    step5 ì‹¤ì œ     | step5 ì½”ë“œ ìœ„ì¹˜                     |  ê´´ë¦¬ ë°°ìˆ˜   |
| :------------------------- | :------------: | :---------------: | :---------------------------------- | :----------: |
| **E4** (ê³ ì•„ ë…¸ë“œ ë¹„ìœ¨)    |  `0.05` (â‰¤5%)  | **`0.30`** (â‰¤30%) | `step5_extraction_validator.py:292` | **6x ì™„í™”**  |
| **E6** (í• ë£¨ì‹œë„¤ì´ì…˜ ë¹„ìœ¨) |  `0.02` (â‰¤2%)  | **`0.20`** (â‰¤20%) | `step5_extraction_validator.py:465` | **10x ì™„í™”** |

### 15-2. ì™„í™”ëœ ì´ìœ  (ì½”ë“œ ì£¼ì„ ë¶„ì„)

step5ì—ì„œ ì˜ë„ì ìœ¼ë¡œ ì™„í™”í•œ ê·¼ê±°ê°€ ì½”ë“œ ì£¼ì„ì— ê¸°ë¡ë˜ì–´ ìˆìŒ:

**E4 (ê³ ì•„ ë…¸ë“œ, line 283):**
```python
# "ê´€ê³„ì— ì°¸ì—¬í•˜ì§€ ì•ŠëŠ” ì—”í‹°í‹° ë¹„ìœ¨ â‰¤ 30%"
```
â†’ í˜„ì¬ ì¶”ì¶œ í’ˆì§ˆì—ì„œ 5%ëŠ” ë‹¬ì„± ë¶ˆê°€ëŠ¥í•˜ì—¬ **ì„ì‹œ ì™„í™”**í•œ ê²ƒìœ¼ë¡œ ì¶”ì •

**E6 (í• ë£¨ì‹œë„¤ì´ì…˜, line 460~464):**
```python
# "ë¶„ì„ ê²°ê³¼ ë¯¸ë§¤ì¹­ì˜ ëŒ€ë¶€ë¶„ì€ LLMì´ í…Œì´ë¸” ì½”ë“œ/êµ¬ì¡°ì—ì„œ
#  ì¶”ë¡ í•œ ì¥ë¹„/ìì¬ëª…. LLM ì¶”ë¡ ì€ PASS/FAIL íŒì •ì—ì„œ ì œì™¸í•˜ê³ ,
#  ì§„ì§œ ì˜ì‹¬(source_method != llm)ë§Œ ê¸°ì¤€ìœ¼ë¡œ íŒì •."
```
â†’ LLM ì¶”ë¡ ì„ ì œì™¸í•˜ê³  "ì§„ì§œ ì˜ì‹¬"ë§Œ íŒì •í•˜ëŠ” ê²ƒì€ í•©ë¦¬ì ì´ë‚˜, **ê¸°ì¤€ ìì²´ê°€ 20%ë¡œ ì—¬ì „íˆ ê³¼ë„í•˜ê²Œ ëŠìŠ¨í•¨**

### 15-3. íŒŒê¸‰ íš¨ê³¼ (A3 ê³µë¦¬)

ì´ ë¶ˆì¼ì¹˜ê°€ ì˜ë¯¸í•˜ëŠ” ê²ƒ:

| ìƒíƒœ           |    E4    |    E6    | ì„¤ëª…                        |
| :------------- | :------: | :------: | :-------------------------- |
| config.py ëª©í‘œ |   â‰¤5%    |   â‰¤2%    | ì—„ê²© â€” í”„ë¡œë•ì…˜ ëª©í‘œ        |
| step5 ì‹¤ì œ     |   â‰¤30%   |   â‰¤20%   | ëŠìŠ¨ â€” í˜„ì¬ PASS ê¸°ì¤€       |
| **ê²©ì°¨**       | **25%p** | **18%p** | ê²€ì¦ ê²Œì´íŠ¸ê°€ ì‚¬ì‹¤ìƒ ë¬´ë ¥í™” |

**ìœ„í—˜:** `step5`ê°€ PASSë¥¼ ì£¼ê³  ìˆì–´ë„, **ì‹¤ì œë¡œëŠ” config.py ê¸°ì¤€ì— ë¯¸ë‹¬**í•œ ë°ì´í„°ê°€ DBì— ì ì¬ë  ìˆ˜ ìˆìŒ.

### 15-4. ê¸°ì¤€ ì¼ì›í™” í•´ê²°ë°©ì•ˆ â€” 2ë‹¨ê³„ ì ‘ê·¼

ë‹¨ìˆœíˆ `config.py` ê°’ì„ importí•˜ë©´ **E4, E6ê°€ ì¦‰ì‹œ FAIL** â†’ íŒŒì´í”„ë¼ì¸ ì •ì§€. ë”°ë¼ì„œ **ì ì§„ì  ìˆ˜ë ´** ì „ëµ:

**1ë‹¨ê³„ (ì¦‰ì‹œ): ì½”ë“œ í†µí•© + í˜„ì‹¤ì  ì¤‘ê°„ê°’ ì„¤ì •**

```python
# config.py â€” ìˆ˜ì •
EXTRACTION_THRESHOLDS = {
    "entity_coverage_min": 0.90,      # E1: â‰¥90% (ìœ ì§€)
    "orphan_node_max": 0.15,          # E4: â‰¤15% (5%â†’15%ë¡œ ìƒí–¥, ì¤‘ê¸° ëª©í‘œ 5%)
    "sample_accuracy_min": 0.90,      # E5: â‰¥90% (ìœ ì§€)
    "hallucination_max": 0.10,        # E6: â‰¤10% (2%â†’10%ë¡œ ìƒí–¥, ì¤‘ê¸° ëª©í‘œ 2%)
}
```

```python
# step5_extraction_validator.py â€” ìˆ˜ì •
from config import EXTRACTION_THRESHOLDS

# check_E4() ë‚´ë¶€
threshold = EXTRACTION_THRESHOLDS["orphan_node_max"]  # í•˜ë“œì½”ë”© 0.30 ì œê±°

# check_E6() ë‚´ë¶€
suspicious_threshold = EXTRACTION_THRESHOLDS["hallucination_max"]  # í•˜ë“œì½”ë”© 0.20 ì œê±°
```

**2ë‹¨ê³„ (P1.5 ì™„ë£Œ í›„): ëª©í‘œì¹˜ ê°•í™”**

P1.5 êµì°¨ ê²€ì¦ê¸° ë„ì…ìœ¼ë¡œ í• ë£¨ì‹œë„¤ì´ì…˜ì´ ë¬¼ë¦¬ì ìœ¼ë¡œ ê²©ë¦¬ë˜ë©´:
```python
EXTRACTION_THRESHOLDS = {
    "orphan_node_max": 0.05,          # E4: ì¤‘ê¸° ëª©í‘œ ë‹¬ì„±
    "hallucination_max": 0.02,        # E6: ìµœì¢… ëª©í‘œ ë‹¬ì„±
}
```

---

## 16. ê²€ì¦ê¸° ì´ì¤‘ êµ¬ì¡°: step5 (E6) vs P1.5 ì—­í•  êµ¬ë¶„

### 16-1. ê³¼ì œ

ê¸°ì¡´ `step5_extraction_validator.py`ì— ì´ë¯¸ 6ë‹¨ê³„ ë§¤ì¹­ ê¸°ë°˜ E6 ê²€ì¦ì´ êµ¬í˜„ë˜ì–´ ìˆìŒ. ì‹ ê·œ `validate_outputs.py` (P1.5)ì™€ **ì—­í• ì´ í˜¼ë™ë˜ë©´ ì´ì¤‘ ê´€ë¦¬ ë¹„ìš©** ë°œìƒ.

### 16-2. ëª…í™•í•œ ì—­í•  ë¶„ë‹´

| ê²€ì¦ê¸°          | íŒŒì¼                            | ê²€ì¦ ëŒ€ìƒ          | ê²€ì¦ ë‚´ìš©                                                 | ì‹¤í–‰ ì‹œì                    |
| :-------------- | :------------------------------ | :----------------- | :-------------------------------------------------------- | :-------------------------- |
| **step5 (E6)**  | `step5_extraction_validator.py` | **ì—”í‹°í‹° ì´ë¦„**    | `entity.name` âˆˆ ì›ë³¸ í…ìŠ¤íŠ¸+í…Œì´ë¸”                        | Step 2.5 (ì •ê·œí™” í›„)        |
| **P1.5 (ì‹ ê·œ)** | `validate_outputs.py`           | **ê´€ê³„ ìˆ˜ëŸ‰/ê·œê²©** | `rel.quantity` âˆˆ ì›ë³¸ ìˆ«ì, `rel.source_spec` âˆˆ ì›ë³¸ í† í° | Step 2.2 ì§í›„ (LLM ì¶”ì¶œ í›„) |

### 16-3. ê²€ì¦ ì°¨ì› ë¹„êµ

| ì°¨ì›                     | step5 E6                                                                               | P1.5                                         |
| :----------------------- | :------------------------------------------------------------------------------------- | :------------------------------------------- |
| **what** (ë¬´ì—‡ì´ ë§ëŠ”ê°€) | ì—”í‹°í‹° ì´ë¦„ì´ ì›ë³¸ì— ì¡´ì¬í•˜ëŠ”ê°€                                                        | ìˆ˜ëŸ‰ ìˆ«ìê°€ ì›ë³¸ì— ì¡´ì¬í•˜ëŠ”ê°€                |
| **ë§¤ì¹­ ë°©ë²•**            | 6ë‹¨ê³„ (exact â†’ normalized â†’ special_char â†’ token â†’ no_trailing_num â†’ underscore_split) | Set subset + ì •ì±… ê¸°ë°˜ (strict/relaxed)      |
| **False Positive ì›ì¸**  | LLM ì¶”ë¡  (ì½”ë“œâ†’ì¥ë¹„ëª…)                                                                 | íŒŒìƒê°’ (í•©ì‚°/ë¹„ìœ¨/í• ì¦)                      |
| **ëŒ€ì¡° ëŒ€ìƒ**            | í…ìŠ¤íŠ¸ + ì¬ê·€ í‰íƒ„í™”ëœ í…Œì´ë¸”                                                          | ìˆ«ì ì§‘í•© + í† í° ì§‘í•©                        |
| **ì¶œë ¥**                 | `hallucinated[]` ë¦¬ìŠ¤íŠ¸ + `suspicious_rate`                                            | `is_verified` í”Œë˜ê·¸ + `validation_warnings` |

### 16-4. step5 E6ì˜ ê¸°ì¡´ êµ¬í˜„ ë¶„ì„ (925ì¤„)

step5ì˜ E6ì€ ì´ë¯¸ ìƒë‹¹íˆ ì„±ìˆ™í•¨:
- `_flatten_tables()`: ì¬ê·€ì ìœ¼ë¡œ í…Œì´ë¸” ë°ì´í„°ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (line 313~333)
- `_normalize_for_match()`: ìœ ì‚¬ ë¬¸ì í†µì¼ (`ï½â†’~`, `Ã—â†’x`, `Â·â†’.`, `â€²â†’'`, `Â°â†’ë„`) (line 378~384)
- 6ë‹¨ê³„ ë§¤ì¹­: ì •í™• â†’ ì •ê·œí™” â†’ íŠ¹ìˆ˜ë¬¸ì â†’ í† í°(2ê¸€ì ì´ìƒ) â†’ ìˆ˜ëŸ‰ ì œê±° â†’ ë°‘ì¤„ ë¶„ë¦¬ (line 406~437)
- `source_method == "llm"` ì¶”ë¡  ì œì™¸ (line 456~458)
- íƒ€ì…ë³„ ë¹„ë¡€ ì¸µí™” ëœë¤ ìƒ˜í”Œë§ 200ê±´ (line 365~375)

**P1.5ëŠ” step5ì™€ ì¤‘ë³µë˜ì§€ ì•ŠìŒ:** step5ëŠ” ì´ë¦„ì„ ê²€ì¦í•˜ê³ , P1.5ëŠ” ìˆ˜ëŸ‰/ê·œê²©ì„ ê²€ì¦í•¨. **ë‘˜ ë‹¤ í•„ìš”.**

---

## 17. P0 êµ¬í˜„ ìƒì„¸ íë¦„

### 17-1. í˜¸ì¶œ ì²´ì¸ ìˆ˜ì • ì „í›„

**í˜„ì¬ (ìˆ˜ì • ì „):**
```
main()
  â†’ chunks = load_chunks()
  â†’ targets = select_llm_target_chunks(chunks)
  â†’ tasks = [extract_single_chunk(chunk, semaphore) for chunk in targets]
    â†’ build_user_prompt(chunk)       # â† all_chunks ì—†ìŒ
```

**ìˆ˜ì • í›„:**
```
main()
  â†’ chunks = load_chunks()
  â†’ all_chunks = chunks              # â† ì „ì²´ ì²­í¬ ë³´ì¡´
  â†’ targets = select_llm_target_chunks(chunks)
  â†’ tasks = [extract_single_chunk(chunk, semaphore, all_chunks) for chunk in targets]
    â†’ build_user_prompt(chunk, all_chunks)  # â† all_chunks ì „ë‹¬
      â†’ if text empty:
        â†’ base_id = re.match(r"(C-\d+)", chunk_id)
        â†’ siblings = [c for c in all_chunks if c.startswith(base_id) and has_text]
        â†’ inject sibling text with warning label
```

### 17-2. ìˆ˜ì • íŒŒì¼ ë° ìœ„ì¹˜ ì •í™• ëª©ë¡

| ìˆœì„œ  | íŒŒì¼                     |  ë¼ì¸   | ë³€ê²½ ë‚´ìš©                                                                    |
| :---: | :----------------------- | :-----: | :--------------------------------------------------------------------------- |
|   1   | `step2_llm_extractor.py` |   202   | `build_user_prompt(chunk)` â†’ `build_user_prompt(chunk, all_chunks)` ì‹œê·¸ë‹ˆì²˜ |
|   2   | `step2_llm_extractor.py` | 202~257 | ë¹ˆ í…ìŠ¤íŠ¸ ì‹œ í˜•ì œ ê²€ìƒ‰ + ì£¼ì… ë¡œì§ ì¶”ê°€                                      |
|   3   | `step2_llm_extractor.py` |   266   | `extract_single_chunk(chunk, semaphore)` â†’ `(chunk, semaphore, all_chunks)`  |
|   4   | `step2_llm_extractor.py` |   275   | `build_user_prompt(chunk)` â†’ `build_user_prompt(chunk, all_chunks)` í˜¸ì¶œë¶€   |
|   5   | `step2_llm_extractor.py` |   578   | íƒœìŠ¤í¬ ìƒì„± ì‹œ `all_chunks=chunks` ì „ë‹¬                                      |
|   6   | `step2_llm_extractor.py` |  ì‹ ê·œ   | 9ê°œ ê³ ë¦½ ì²­í¬ ID í•˜ë“œì½”ë”© + confidence ê°•ì œ ë¡œì§                             |

### 17-3. 9ê°œ ê³ ë¦½ ì²­í¬ ëª©ë¡

```python
ISOLATED_CHUNKS = {
    "C-0172", "C-0578-A", "C-0578-B", 
    "C-0623-A", "C-0623-B", "C-0759", 
    "C-0923", "C-1124", "C-1149"
}
# ì´ ì²­í¬ë“¤ì€ í˜•ì œ ì²­í¬ì—ë„ í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë¯€ë¡œ confidence â‰¤ 0.7 ê°•ì œ
```

---

## 18. P1 ìƒ˜í”Œ ë¹„êµ ê¸°ì¤€ êµ¬ì²´í™”

### 18-1. ë¹„êµ ëŒ€ìƒ

P0 ì ìš© **ì „/í›„** ë™ì¼ 20ê°œ ì²­í¬ì˜ ì¶”ì¶œ ê²°ê³¼ ë¹„êµ

### 18-2. ìƒ˜í”Œ ì„ ì • ê¸°ì¤€ (20ê°œ)

| ê·¸ë£¹                      | ì„ ì • ìˆ˜ | ì„ ì • ê¸°ì¤€                                             |
| :------------------------ | :-----: | :---------------------------------------------------- |
| ë¹ˆ í…ìŠ¤íŠ¸ + í˜•ì œ ìˆìŒ     |  10ê°œ   | P0 íš¨ê³¼ê°€ ê°€ì¥ ì§ì ‘ì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ëŠ” ëŒ€ìƒ               |
| ë¹ˆ í…ìŠ¤íŠ¸ + ê³ ë¦½ (9ê°œ ì¤‘) |   3ê°œ   | confidence ê°•ì œ íš¨ê³¼ ê²€ì¦                             |
| í…ìŠ¤íŠ¸ ìˆëŠ” ì²­í¬          |   5ê°œ   | **íšŒê·€ í…ŒìŠ¤íŠ¸** â€” P0ê°€ ê¸°ì¡´ ì •ìƒ ì²­í¬ë¥¼ í•´ì¹˜ì§€ ì•ŠëŠ”ì§€ |
| ëŒ€í˜• ë§¤íŠ¸ë¦­ìŠ¤ (10+cols)   |   2ê°œ   | ë§¤íŠ¸ë¦­ìŠ¤ ì „ê°œ + ì»¨í…ìŠ¤íŠ¸ ì£¼ì… ë³µí•© ì¼€ì´ìŠ¤             |

### 18-3. ë¹„êµ í•­ëª© ë° PASS ê¸°ì¤€

| ë¹„êµ í•­ëª©                      | PASS ê¸°ì¤€                                                       |
| :----------------------------- | :-------------------------------------------------------------- |
| (a) ë¹ˆ í…ìŠ¤íŠ¸ ì²­í¬ì˜ ì—”í‹°í‹° ìˆ˜ | P0 í›„ â‰¥ P0 ì „ (ê°ì†Œí•˜ë©´ FAIL)                                   |
| (b) ë¹ˆ í…ìŠ¤íŠ¸ ì²­í¬ì˜ ê´€ê³„ ìˆ˜   | P0 í›„ â‰¥ P0 ì „                                                   |
| (c) Context Bleeding ë°œìƒ ì—¬ë¶€ | **0ê±´** (í˜•ì œ í…ìŠ¤íŠ¸ì˜ ê·œê²©ì´ í˜„ì¬ í…Œì´ë¸”ì— ì˜ëª» ë§¤í•‘ëœ ì¼€ì´ìŠ¤) |
| (d) í…ìŠ¤íŠ¸ ìˆëŠ” ì²­í¬ íšŒê·€      | ì—”í‹°í‹°/ê´€ê³„ ìˆ˜ ë³€í™” Â±5% ì´ë‚´                                    |
| (e) ê³ ë¦½ ì²­í¬ confidence       | 9ê°œ ëª¨ë‘ `â‰¤ 0.7`                                                |

**FAIL ì‹œ ëŒ€ì‘:**
- (c) Context Bleeding ë°œìƒ â†’ P0 ì£¼ì… í”„ë¡¬í”„íŠ¸ì— ê·œê²© ë²”ìœ„ ì œí•œ ë¬¸êµ¬ ì¶”ê°€
- (d) íšŒê·€ ë°œìƒ â†’ P0 ë¡œì§ì´ ê¸°ì¡´ ì²­í¬ì— ê°„ì„­í•˜ëŠ” ê²½ë¡œ í™•ì¸ í›„ ì¡°ê±´ ë¶„ê¸°

---

## 19. P1.5 ì™„ë£Œ ê¸°ì¤€ (DoD) êµ¬ì²´í™”

### 19-1. ì •ëŸ‰ì  PASS ê¸°ì¤€

| ì§€í‘œ                                     |           ê¸°ì¤€            | ì„¤ëª…                                    |
| :--------------------------------------- | :-----------------------: | :-------------------------------------- |
| Dead Letter Queue í¬ê¸° (strict)          |   â‰¤ ì „ì²´ ê´€ê³„ì˜ **20%**   | ì´ˆê³¼ ì‹œ `tokenize()` ì •ê·œí™” ê·œì¹™ ì¬ê²€í†  |
| Dead Letter Queue í¬ê¸° (relaxed ì ìš© í›„) |   â‰¤ ì „ì²´ ê´€ê³„ì˜ **5%**    | ì´ ìˆ˜ì¤€ì´ë©´ ìˆ˜ë™ ê²€í†  ê°€ëŠ¥              |
| `is_verified=true` ë¹„ìœ¨ (ìµœì¢…)           |         â‰¥ **85%**         | relaxed ì ìš© í›„ ê¸°ì¤€                    |
| ê²€ì¦ ì‹¤í–‰ ì‹œê°„                           | â‰¤ **10ë¶„** (2,105ê±´ ê¸°ì¤€) | ì„±ëŠ¥ ìš”êµ¬ì‚¬í•­                           |

### 19-2. Dead Letter Queue í¬ê¸°ë³„ ëŒ€ì‘í‘œ

| DLQ í¬ê¸° (strict) |  ìƒíƒœ  | ëŒ€ì‘                                                    |
| :---------------: | :----: | :------------------------------------------------------ |
|       â‰¤ 10%       | âœ… ì–‘í˜¸ | ì¦‰ì‹œ ìˆ˜ë™ ê²€í†  â†’ P2                                     |
|      11~20%       | âš ï¸ ì£¼ì˜ | `tokenize()` ì •ê·œí™” í™•ì¥ ê²€í†  í›„ ì¬ì‹¤í–‰, ì´í›„ ìˆ˜ë™ ê²€í†  |
|      21~30%       | âŒ ê²½ê³  | ì •ê·œí™” ê·œì¹™ì— êµ¬ì¡°ì  ë¬¸ì œ â€” `tokenize()` ì¬ì„¤ê³„ í•„ìš”    |
|       > 30%       | ğŸš¨ ì¤‘ë‹¨ | ê²€ì¦ ë¡œì§ ìì²´ë¥¼ ì „ë©´ ì¬ê²€í†  â€” P0 ì£¼ì… ë¶€ì‘ìš© ê°€ëŠ¥ì„±    |

### 19-3. ì¶œë ¥ íŒŒì¼ êµ¬ì¡°

```
phase2_output/
  â”œâ”€â”€ raw_llm_entities.json           # P1 ì¶”ì¶œ ê²°ê³¼ (ê²€ì¦ ì „)
  â”œâ”€â”€ validated_entities.json         # P1.5 ê²€ì¦ í†µê³¼ (is_verified=true)
  â”œâ”€â”€ dead_letter_queue.json          # P1.5 ê²€ì¦ ì‹¤íŒ¨ (is_verified=false)
  â””â”€â”€ validation_report.json          # P1.5 í†µê³„ ë¦¬í¬íŠ¸
       â”œâ”€â”€ total_relationships: int
       â”œâ”€â”€ verified_count: int
       â”œâ”€â”€ quarantined_count: int
       â”œâ”€â”€ quarantine_rate: float
       â”œâ”€â”€ policy_used: "strict" | "relaxed"
       â”œâ”€â”€ warning_type_distribution: {}  # qty_mismatch, spec_mismatch ë“±
       â””â”€â”€ top_10_quarantined_samples: []
```

---

## 20. ê°±ì‹ ëœ ìµœì¢… ì‹¤í–‰ ìˆœì„œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 20-1. ì „ì²´ íë¦„

```
[ ] 1. ê¸°ì¤€ ì¼ì›í™” 1ë‹¨ê³„ (0.5~1ì‹œê°„)
       â†’ config.py ì¤‘ê°„ê°’ ì„¤ì • (E4: 0.15, E6: 0.10)
       â†’ step5ê°€ config.EXTRACTION_THRESHOLDS importí•˜ë„ë¡ ìˆ˜ì •
       â†’ step5 í•˜ë“œì½”ë”© 0.30/0.20 ì œê±°

[ ] 2. P0: Context Injector (2ì‹œê°„)
       â†’ build_user_prompt() ì‹œê·¸ë‹ˆì²˜ ë³€ê²½
       â†’ ë¹ˆ í…ìŠ¤íŠ¸ ì‹œ í˜•ì œ ê²€ìƒ‰ + ì£¼ì… ë¡œì§
       â†’ extract_single_chunk() ì‹œê·¸ë‹ˆì²˜ ë³€ê²½
       â†’ main() íƒœìŠ¤í¬ ìƒì„±ë¶€ ìˆ˜ì •
       â†’ 9ê°œ ê³ ë¦½ ì²­í¬ confidence ê°•ì œ

[ ] 3. P1-Sample: ìƒ˜í”Œ 20ê±´ ë¹„êµ í…ŒìŠ¤íŠ¸ (1ì‹œê°„)
       â†’ ë¹ˆ í…ìŠ¤íŠ¸ 10 + ê³ ë¦½ 3 + ì •ìƒ 5 + ëŒ€í˜• ë§¤íŠ¸ë¦­ìŠ¤ 2
       â†’ 5ê°œ ë¹„êµ í•­ëª© PASS í™•ì¸
       â†’ Context Bleeding 0ê±´ í™•ì¸

[ ] 4. P1: Main Extraction (3~4ì‹œê°„)
       â†’ DeepSeek-V3, max_tokens=8192
       â†’ 2,105ê±´ ì „ìˆ˜ ì¶”ì¶œ â†’ raw_llm_entities.json

[ ] 5. P1.5: Post-Validator êµ¬í˜„ + ì‹¤í–‰ (0.5ì¼)
       â†’ validate_outputs.py ì‹ ê·œ ì‘ì„±
       â†’ tokenize() + Set ë§¤ì¹­ + strict ì •ì±…
       â†’ ì‹¤í–‰ â†’ validated_entities.json + dead_letter_queue.json
       â†’ DLQ í¬ê¸° í™•ì¸ (20% ì´í•˜?)

[ ] 6. P2: Quarantine Review (1ì¼)
       â†’ DLQ ìˆ˜ë™ ë¶„ë¥˜ (íŒŒìƒê°’? Ghost? ì •ê·œí™” ë¬¸ì œ?)
       â†’ í•„ìš” ì‹œ relaxed ì •ì±…ìœ¼ë¡œ ì¬ì‹¤í–‰
       â†’ ìµœì¢… is_verified=true â‰¥ 85% í™•ì¸

[ ] 7. ê¸°ì¤€ ì¼ì›í™” 2ë‹¨ê³„ (0.5ì‹œê°„)
       â†’ P1.5 ì‹¤ì  ê¸°ë°˜ìœ¼ë¡œ config.py ëª©í‘œ ê°•í™”
       â†’ E4: 0.15 â†’ 0.05, E6: 0.10 â†’ 0.02
       â†’ step5 ì¬ì‹¤í–‰í•˜ì—¬ PASS í™•ì¸

[ ] 8. P3: Entity Resolution + DB Load (2~3ì¼)
       â†’ is_verified=true ë°ì´í„°ë§Œ ë³µí•©í‚¤ ë³‘í•©
       â†’ Supabase ì ì¬
```

### 20-2. ë³‘ë ¬ ê°€ëŠ¥ ê²½ë¡œ

```
                   â”Œâ”€ P0 (2h) â”€â†’ P1-Sample (1h) â”€â†’ P1 (3~4h) â”€â”
ê¸°ì¤€ ì¼ì›í™” 1ë‹¨ê³„ â”€â”¤                                              â”œâ”€â†’ P2 â†’ ê¸°ì¤€ ì¼ì›í™” 2ë‹¨ê³„ â†’ P3
                   â””â”€ P1.5 ìŠ¤í¬ë¦½íŠ¸ ê°œë°œ (0.5d, P1 ê²°ê³¼ ë¶ˆí•„ìš”) â”€â”˜
                     â†‘ P1.5 ì½”ë“œë§Œ ë¨¼ì € ì‘ì„±, ì‹¤í–‰ì€ P1 ì™„ë£Œ í›„
```

**ì´ ì˜ˆìƒ ê³µìˆ˜: P0~P1.5 = ì•½ 1.5ì¼, P2+P3 = ì•½ 3~4ì¼, ì „ì²´ = ì•½ 1ì£¼ì¼**

---

## 21. ìµœì¢… ê²°ë¡  (Consolidated)

1. **ë¹ˆ í…ìŠ¤íŠ¸ 43.1%ì˜ ì›ì¸ì€ Phase 1ì˜ ì„œë¸Œì²­í¬ ë¶„ë¦¬ ì„¤ê³„**ì´ë©°, Phase 1 ì¬íŒŒì‹±ì€ ë¶ˆí•„ìš”
2. **899ê°œ(99%)ëŠ” í˜•ì œ ì²­í¬ì—ì„œ í…ìŠ¤íŠ¸ ë³µì› ê°€ëŠ¥** â†’ P0 í•µì‹¬ì€ `build_user_prompt()` ìˆ˜ì • (2ì‹œê°„)
3. **max_tokens=8192ëŠ” ì´ë¯¸ ì ìš©** â†’ P1 ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥
4. **êµì°¨ ê²€ì¦(P1.5)ì€ í›„ì²˜ë¦¬ ë…ë¦½ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë””ì»¤í”Œë§** â€” 3.5ê°œ ë²„ê·¸ ëª¨ë‘ ìˆ˜ì • ì™„ë£Œ
5. **`tokenize()` í•¨ìˆ˜ë¡œ ë³µí•© êµ¬ë¶„ì ë¶„í• ** â€” D_ê¸°íƒ€ ë°‘ì¤„ í—¤ë” í˜¸í™˜ì„± í™•ë³´
6. **í’ˆì§ˆ ì„ê³„ê°’ ì´ì¤‘ ê¸°ì¤€ ë°œê²¬ (E4: 5%â†’30%, E6: 2%â†’20%)** â€” 2ë‹¨ê³„ ì ì§„ì  ìˆ˜ë ´ìœ¼ë¡œ í•´ê²°
7. **step5(E6)ê³¼ P1.5ëŠ” ì—­í• ì´ ë‹¤ë¦„** â€” step5ëŠ” ì—”í‹°í‹° ì´ë¦„, P1.5ëŠ” ê´€ê³„ ìˆ˜ëŸ‰/ê·œê²© ê²€ì¦
8. **P0(2ì‹œê°„) + P1(3~4ì‹œê°„) + P1.5(0.5ì¼) = ì•½ 1.5ì¼ë§Œì— 90% í’ˆì§ˆ ë„ë‹¬**
9. P2~P3ê¹Œì§€ ì™„ë£Œ ì‹œ **í• ë£¨ì‹œë„¤ì´ì…˜ â‰¤ 2%, ì „ì²´ í’ˆì§ˆ 93%+ ë‹¬ì„±**
10. P0ì™€ P1.5 ìŠ¤í¬ë¦½íŠ¸ë¥¼ **ë³‘ë ¬ ê°œë°œ** ê°€ëŠ¥ â†’ ì „ì²´ ê³µìˆ˜ ì•½ **1ì£¼ì¼**

> **ìµœì¢… ì§€ì‹œ:** ê¸°ì¤€ ì¼ì›í™” 1ë‹¨ê³„ë¥¼ **ê°€ì¥ ë¨¼ì €** ì‹¤í–‰í•˜ì—¬ íŒŒì´í”„ë¼ì¸ ì „ì²´ì˜ íŒì • ê¸°ì¤€ì„ ì •ë¦½í•œ í›„, P0 â†’ P1-Sample â†’ P1 â†’ P1.5 â†’ P2 â†’ ê¸°ì¤€ ì¼ì›í™” 2ë‹¨ê³„ â†’ P3 ìˆœì„œë¡œ ì§„í–‰. ëª¨ë“  ê²€ì¦ í†µê³¼ ë°ì´í„°(`is_verified: true`)ë§Œ DBì— ì ì¬í•  ê²ƒ.
