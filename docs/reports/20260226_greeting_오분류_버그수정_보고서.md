# 20260226 — Greeting 오분류 버그 수정 보고서

**작성일**: 2026-02-26
**대상 파일**: `edge-function/clarify.ts`, `edge-function/index.ts`
**배포 환경**: Supabase Edge Function (`rag-chat`)

---

## 1. 버그 개요

### 증상
`플랜지 배관설치`, `배관설치`, `배관 플랜지` 등 공종 관련 쿼리를 입력하면 품셈 검색/명확화 대신 greeting 안내 메시지가 반환됨.

```json
{
  "type": "answer",
  "answer": "안녕하세요! 건설 공사 표준품셈 AI 어시스턴트입니다...",
  "search_info": { "entities_found": 0 }
}
```

### 발견 경위
오늘(2026-02-26) 커밋된 `clarify.ts`의 Intent 9개 확장 이후 회귀 여부를 API 직접 호출로 검증하던 중 발견.

---

## 2. 테스트 결과 (버그 수정 전)

| 쿼리 | 기대 타입 | 실제 타입 | entities_found |
|---|---|---|---|
| `플랜지 배관설치` | `clarify` | ❌ `answer` (greeting) | 0 |
| `배관설치` | `clarify` | ❌ `answer` (greeting) | 0 |
| `플랜지 설치` | `clarify` | ❌ `answer` (greeting) | 0 |
| `배관 플랜지` | `clarify` | ❌ `answer` (greeting) | 0 |
| `콘크리트 타설` | `clarify` | ✅ `clarify` | 0 |
| `강관용접 200mm SCH40 품셈` | `answer` | ✅ `answer` | 10 |
| `안녕` | `answer` (greeting) | ✅ `answer` | 0 |

---

## 3. 근본 원인 분석

### 원인 1: DeepSeek LLM 오분류

`clarify.ts`의 `analyzeIntent` 함수가 DeepSeek API를 호출하여 intent를 분류할 때, "플랜지 배관설치" 류의 쿼리를 `greeting`으로 잘못 분류.

분류 시 `work_name: null`, `keywords: []`까지 함께 반환하여 기존 안전망 코드로는 탐지 불가:

```typescript
// 기존 안전망 — greeting은 검사 대상 아님
const validIntents = ["search", "clarify_needed", "followup", "greeting", ...];
if (!validIntents.includes(parsed.intent)) { ... }  // greeting은 통과
if (parsed.intent === "search" && parsed.ambiguity_reason) { ... }  // greeting은 해당 없음
```

### 원인 2: `validIntents`에 `complex_estimate` 누락 (로컬 파일 동기화 이슈)

GitHub 최신 버전에는 `complex_estimate`가 `validIntents`에 포함되어 있으나, 로컬 `edge-function/clarify.ts`에는 누락된 상태였음.

```typescript
// GitHub (최신) — 9개
const validIntents = [..., "complex_estimate"];

// 로컬 edge-function (누락) — 8개
const validIntents = ["search", "clarify_needed", "followup", "greeting",
                       "quantity_input", "cost_calculate", "modify_request", "report_request"];
```

### 원인 3: 테스트 환경의 bash 한글 인코딩 문제

`curl`에서 bash 변수 `$q`로 한글 쿼리를 전달할 때 UTF-8이 깨져서 Edge Function에 오염된 문자열이 전달됨. 테스트 중 Fix A가 작동하지 않는 것처럼 보였으나, 실제로는 수신 문자열 자체가 달라서 `includes("배관") = false`가 나온 것.

```
# 디버그 응답에서 확인된 실제 수신 값
[DBG q="÷ ġ" len=12 hasBaegwan=false]
```

올바른 테스트 방법: `node` 또는 `test_api.js` 사용 필수.

---

## 4. 수정 내용

### 4-1. `edge-function/clarify.ts` — validIntents 복구 + Fix A (clarify 레이어)

**변경 위치**: `analyzeIntent` 함수 내 안전성 보장 블록 (기존 line 286)

```typescript
// Before
const validIntents = [
  "search", "clarify_needed", "followup", "greeting",
  "quantity_input", "cost_calculate", "modify_request", "report_request"
];
if (!validIntents.includes(parsed.intent)) { ... }
if (parsed.intent === "search" && parsed.ambiguity_reason) { ... }
parsed.keywords = parsed.keywords || [];

// After
const validIntents = [
  "search", "clarify_needed", "followup", "greeting",
  "quantity_input", "cost_calculate", "modify_request", "report_request",
  "complex_estimate"  // ← 복구
];
if (!validIntents.includes(parsed.intent)) { ... }
if (parsed.intent === "search" && parsed.ambiguity_reason) { ... }

// Fix A: greeting + keywords 존재 시 clarify_needed로 교정 (regex 버전)
const workTermPattern = /설치|용접|배관|시공|제작|타설|철거|해체|보온|도장|미장|조적|플랜지|강관|덕트|콘크리트|거푸집|철근|굴착|성토|절토|포장/;
if (parsed.intent === "greeting" && workTermPattern.test(question)) {
    parsed.intent = "clarify_needed";
    parsed.ambiguity_reason = parsed.ambiguity_reason ?? "공종명이 포함되어 있어 clarify_needed로 재분류";
    if (!parsed.work_name && parsed.keywords.length > 0) {
        parsed.work_name = parsed.keywords[0];
    }
}
parsed.keywords = parsed.keywords || [];
```

> **참고**: `clarify.ts` 내 Fix A는 Deno 환경에서 한글 regex가 간헐적으로 오작동하는 문제로 단독으로는 불충분. `index.ts`의 Fix A와 이중 방어선 구성.

### 4-2. `edge-function/index.ts` — Fix A (라우팅 레이어, 핵심 방어선)

**변경 위치**: Route 3 의도 분석 직후, greeting 분기 직전 (line 1101)

```typescript
// Before
// ─── 인사/도움말 ───
if (analysis.intent === "greeting") {
    return makeAnswerResponse("안녕하세요!...", startTime);
}

// After
// ─── 인사/도움말 ───
// Fix A: LLM이 공종 쿼리를 greeting으로 오분류한 경우 clarify_needed로 강제 교정
if (analysis.intent === "greeting") {
    const workTerms = [
        "설치", "용접", "배관", "시공", "제작", "타설", "철거", "해체",
        "보온", "도장", "미장", "조적", "플랜지", "강관", "덕트",
        "콘크리트", "거푸집", "철근", "굴착", "성토", "절토", "포장"
    ];
    if (workTerms.some((t) => question.includes(t))) {
        analysis.intent = "clarify_needed";
        console.log(`[Fix A] greeting → clarify_needed (question="${question}")`);
    }
}
if (analysis.intent === "greeting") {
    return makeAnswerResponse("안녕하세요!...", startTime);
}
```

**설계 이유**: `clarify.ts`의 Fix A가 Deno regex 환경 문제로 불안정할 수 있어, `index.ts`에서 `String.includes()`로 최종 차단. `question` 원문을 직접 검사하므로 LLM 응답의 `work_name`/`keywords` 값에 의존하지 않음.

---

## 5. 테스트 결과 (버그 수정 후)

Node.js로 올바른 UTF-8 인코딩으로 테스트:

```javascript
// 테스트 코드
const body = JSON.stringify({question: '플랜지 배관설치', history: []});
// Content-Type: application/json
```

| 쿼리 | 기대 타입 | 실제 타입 | entities_found | 결과 |
|---|---|---|---|---|
| `플랜지 배관설치` | `clarify` | `clarify` | 0 | ✅ |
| `배관설치` | `clarify` | `clarify` | 0 | ✅ |
| `배관 플랜지` | `clarify` | `clarify` | 0 | ✅ |
| `안녕` | `answer` (greeting) | `answer` | 0 | ✅ |
| `뭘 할 수 있어?` | `answer` (greeting) | `answer` | 0 | ✅ |
| `강관용접 200mm SCH40 품셈` | `answer` | `answer` | 10 | ✅ |

`플랜지 배관설치` clarify 응답 예시:
```json
{
  "type": "clarify",
  "answer": "\"Flange 배관설치 플랜지 Flange 배관설치 배관 파이프\" 관련 품셈이 26개 분야에 있습니다.\n어떤 분야의 품셈을 찾으시나요?"
}
```

---

## 6. 부수 발견 사항

### bash curl 한글 인코딩 깨짐
bash 환경에서 `curl -d "{\"question\": \"$q\"}"` 형태로 한글을 전달할 때 UTF-8이 손상됨.
**대안**: `node test_api.js` 또는 Node.js 인라인 스크립트 사용.

```bash
# ❌ 잘못된 테스트 방법 (한글 깨짐)
curl -d "{\"question\": \"플랜지 배관설치\"}"

# ✅ 올바른 테스트 방법
node -e "require('https').request(...)"
node test_api.js
```

---

## 7. 배포 이력

| 시각 | 내용 |
|---|---|
| 10:49 | GitHub 커밋 — 종합 시스템 감사 및 개선계획서 추가, index.ts 수정 |
| 11:37 | GitHub 커밋 — Phase A/B 개선 작업 완료 (Intent 9개, alias 쿼리, telemetry) |
| 오후 | Fix A 구현 — `clarify.ts` validIntents 복구 + greeting 안전망 |
| 오후 | Fix A 구현 — `index.ts` routing 레이어 greeting 차단 추가 |
| 오후 | Supabase `rag-chat` Edge Function 재배포 완료 |
