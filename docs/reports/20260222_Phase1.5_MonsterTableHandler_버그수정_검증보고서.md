# Phase 1.5 Monster Table Handler Bug Fixes - 검증 보고서

> **작성일**: 2026-02-22
> **작성자**: Antigravity AI Architect
> **대상**: Phase 1.5-B (Route 0.5 라우터) 버그 수정 내역

---

## 1. 개요
MonsterTableHandler(Route 0.5) 구현체에서 **복수 재질 매칭(Multiple Materials Bug)** 및 **비표준 단위(인/ton 등) 수량 연산(Unit Multiplier Bug)**이라는 2건의 알고리즘(수식) 연산 버그를 확인하고, 이를 수정해 에지 함수에 배포를 완료했습니다. 

## 2. 해결 내역

### 2.1 복수 재질 매칭 (Duplicate Row Summation) 버그 수정
- **증상**: "탄소강관"으로 질의 시, DB 내 `배관용탄소강관(KSD3507)`, `압력배관용탄소강관(KSD3562)`, `배관용아크용접탄소강관(KSD3583)` 등 `%탄소강관%` 조건을 만족하는 모든 재질의 데이터가 중복 추출되어 합산 비용이 실제 단가의 3~4배로 부풀려지는 현상이 발견되었습니다.
- **해결**: `ilike`로 조회해온 레코드 셋에서 질의문(Question) 내 명시된 재질 이름 원문과 접두어가(e.g., `배관용탄소강관`) 가장 근사하게 일치하는 단일 `material` 객체를 도출하여, 해당 객체와 동일한 material 행만을 필터링하도록 로직을 재구성했습니다.

### 2.2 비표준 단위 수량 연산 무시 (Unit Multiplier) 버그 수정
- **증상**: 수량의 단위가 `인/100m`가 아닌 경우 (예: `인/ton`), 사용자가 지정한 수량(multiplier)이 실제 품(수량) 산정식 (`actualQty`)에 전혀 곱해지지 않고 무조건 1ton으로 고정되어 노임 비용이 계산되는 치명적인 산식 누락이 있었습니다.
- **해결**: 삼항 연산자를 수정하여 `qtyPer100m * quantityMultiplier`가 `인/100m`를 제외한 모든 단위(`인/ton` 등) 기반 연산에서도 정상 동작하도록 수식을 보정했습니다. 이에 더불어 LLM이 테이블을 렌더링할 때 `100m 환산 금액(원)` 헤더를 `10m`나 `10ton`처럼 사용자 질의 수량 및 단위에 맞춰 동적으로 변경토록 개선을 진행했습니다.

## 3. 에지 함수 배포 (Deployment Fix)
- **증상**: 윈도우 환경 구조(`npx`)와 도커 폴더 마운트 권한 부족(G 드라이브) 특성으로 인해, Edge Function 배포 시 Docker Container 실행과정에서 Mount Path를 찾지 못하여 지속적으로 배포가 실패했습니다 (`error running container: exit 1`). 
- **해결**: 배포 디렉터리(`supabase/functions/rag-chat`)를 C 드라이브 `C:\temp\Antigravity-Deploy` 위치로 임시로 복제하여 마운트 권한 액세스 문제를 우회했습니다. 그 후 `npx -y supabase functions deploy` 명령어를 실행하여 성공적으로 운영 DB 서버(Supabase)에 반영했습니다.

## 4. 검증 결과
실서버(Edge Function 엔드포인트)를 타겟으로 하여 다음의 파라미터로 REST 호출을 수행했습니다.
- **질의**: `13-1-1 플랜트 배관 설치 배관용 탄소강관 200mm 옥내 용접식 10m 노무비`

**결과**: 의도한 대로 1가지 특정 품목(`배관용탄소강관(KSD3507)`)에 대해서만 정확하게 3개 행(플랜트용접공, 플랜트배관공, 특별인부)이 도출되었으며 도출된 10m에 대한 노무비 합산 금액과 노임단가 수량 계산이 완벽히 매치되었습니다.
  - LLM 메타데이터
    - `llm_input_tokens`: 2682
    - `llm_output_tokens`: 482
    - `estimated_cost_krw`: 0.54

✅ **모든 버그 픽스가 정상 작동함을 확인했습니다.**
