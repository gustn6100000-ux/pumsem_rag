# UX 개선계획서 - 검색파이프라인 종합 분석 결과

> **분석일**: 2026-02-27
> **대상 문서**: `docs/reports/20260227_UX_개선계획서_검색파이프라인.md`
> **대상 저장소**: https://github.com/gustn6100000-ux/pumsem_rag
> **분석 범위**: `edge-function/resolve.ts`, `edge-function/index.ts`, `edge-function/types.ts`

---

## 문제점 A: Clarify UI 인지 과부하

### 현재 코드 구조 (`resolve.ts`)

`buildSelectorPanel()`이 `FilterAxis`(직경, SCH 등)를 추출해 필터 패널을 만들긴 하지만, 구조적 한계가 있다.

| 현재 | 문제 |
|------|------|
| `FilterAxis`가 **단일 깊이(flat)**로만 동작 | 재질→접합→관경 같은 **다단계 계층(Tree)** 표현 불가 |
| `extractFilterAxes()`가 specs의 key-value를 1:1 매핑 | "옥외 용접식 SUS 50A" 같은 복합 속성이 **단일 리스트**로 나열됨 |
| `parseWorkTypeName()`이 이름에서 규격을 추출하지만 **정규식 기반의 단순 파싱** | 복합 규격명에서 계층 정보 손실 |
| `SelectorPanel.filters`가 독립적 축으로만 존재 | **축 간 종속 관계**(재질 선택 시 가능한 관경 필터링)가 없음 |

### 개선안 타당성 분석

계획서의 Phase 1-A (계층형 드릴다운 전환)는 타당하다. 구체적으로:

1. **`FilterAxis` 타입 확장 필요**: 현재 `{ key, label, values[] }` → `{ key, label, values[], children?: FilterAxis[] }` 또는 별도의 `FilterTree` 타입 신설
2. **`buildSelectorPanel`의 items→filters 매핑 로직 수정**: 현재 `extractFilterAxes`가 flat하게 뽑는 걸, 도메인 규칙 기반으로 depth를 부여해야 함 (예: 재질 > 접합방식 > 관경)
3. **`presentClarify`의 `sub_section` 분기 활용**: 이미 `buildSubSectionMap`으로 하위 구조를 만드는 로직이 있으므로, 이를 확장하면 됨

### 파급효과 경고

- `ClarifyResult.selector` 구조가 바뀌면 프론트엔드의 체크박스 렌더링 로직 전면 변경 필요
- `graphClarify()` (clarify.ts)에서도 `SelectorPanel`을 참조하므로 동시 수정 필요

---

## 문제점 B: 매트릭스 교차표 가독성

### 현재 코드 구조 (`index.ts`)

`renderMatrixTable()`의 동작:

```
specs.length <= 1 → 단순 flat 테이블 (직종 | 수량 | 단위 | 기준)
specs.length > 1  → 교차표 (행=직종, 열=규격별 수량)
```

| 현재 | 문제 |
|------|------|
| 마크다운 문자열로 직접 조립 | 열이 10개+ 넘으면 마크다운 테이블 **자체가 깨짐** |
| 결과를 `answer` 문자열에 합쳐서 LLM에 전달 | LLM이 표를 재해석/재포맷하면서 **정보 왜곡** 가능 |
| `ChatResponse`에 구조화된 데이터 필드 없음 | 프론트엔드가 **파싱 불가** → 그대로 텍스트 출력 |
| `buildContext()`에서 교차표를 context 문자열에 포함 | 토큰 낭비 + LLM 혼란 |

### 개선안 타당성 분석

Phase 1-B (JSON 구조화)도 타당하다:

1. **`ChatResponse` 타입에 `matrix_data` 필드 추가**: 현재 `types.ts`의 `ChatResponse`는 `answer: string` 하나로 모든 걸 담으므로, 별도의 구조화 필드가 반드시 필요
2. **제안 구조:**
   ```typescript
   interface MatrixData {
     title: string;
     category: string;       // "투입 인력" | "투입 장비" | "사용 자재"
     row_label: string;      // "직종" | "장비명" | "자재명"
     columns: string[];      // 규격 목록
     rows: { name: string; values: Record<string, string> }[];
     unit: string;
   }
   ```
3. **`renderMatrixTable`은 유지하되 보조 수단으로**: JSON 생성 함수를 별도로 만들고, 마크다운은 LLM 프롬프트용 fallback으로만 사용

### 파급효과 경고

- `buildContext()` (index.ts:161-310)에서 교차표를 context에 넣는 로직도 같이 수정 필요
- `generateAnswer()` (llm.ts)의 프롬프트가 마크다운 표를 전제로 작성되어 있을 가능성 → 확인 필요
- `answerPipeline`, `fullViewPipeline`, `complexTablePipeline` 세 곳 모두에서 `renderMatrixTable` 호출 → 전부 수정

---

## 추가 발견 사항

| 항목 | 상세 |
|------|------|
| **Phase 순서 타당** | 백엔드(Phase 1) → 프론트엔드(Phase 2) 순서는 올바름. 현재 프론트엔드 소스가 이 레포에 없으므로 백엔드 먼저 정리하는 게 맞음 |
| **`complexTablePipeline`과의 중복** | index.ts:861-1020에 복합 테이블 전용 파이프라인이 이미 존재. matrix_data 구조화 시 이 파이프라인과 통합 검토 필요 |
| **Verification Plan 보완 필요** | 계획서의 검증 항목이 수동 테스트만 제시. 기존 `test_api.js`, `test_duct.json` 등 테스트 인프라를 활용한 자동화 검증 항목 추가 권장 |
| **LLM 프롬프트 변경 리스크** | Phase 1-A에서 "LLM 시스템 프롬프트 수정"을 언급했는데, `clarify.ts`의 `graphClarify` 프롬프트 변경 시 기존 검색 품질에 회귀(regression) 발생 가능 |

---

## 수정 영향 범위 요약

```
Phase 1-A (Clarify 계층화)
├── types.ts        → FilterAxis 타입 확장 or FilterTree 신설
├── resolve.ts      → buildSelectorPanel, extractFilterAxes, presentClarify 수정
├── clarify.ts      → graphClarify 프롬프트 수정 (SelectorPanel 참조)
└── [프론트엔드]     → 체크박스 리스트 → 계층형 드릴다운 UI 전면 교체 (Phase 2)

Phase 1-B (Matrix JSON 구조화)
├── types.ts        → ChatResponse에 matrix_data 필드 추가, MatrixData 타입 신설
├── index.ts        → renderMatrixTable 보조화 + buildMatrixData 신설
│   ├── buildContext()         → 교차표 context 로직 수정
│   ├── answerPipeline()       → matrix_data 포함 응답 생성
│   ├── fullViewPipeline()     → matrix_data 포함 응답 생성
│   └── complexTablePipeline() → matrix_data 통합 검토
├── llm.ts          → generateAnswer 프롬프트 확인/수정
└── [프론트엔드]     → 마크다운 표 → Ag-Grid 등 동적 그리드 렌더링 (Phase 2)
```
