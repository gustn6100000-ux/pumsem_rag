# 의도 분석 한→영 번역 기능 구현 보고서

**작성일**: 2026-02-14  
**Edge Function 버전**: v47 (96.47kB)  
**대상 파일**: `supabase/functions/rag-chat/index.ts`

---

## 1. 변경 배경

### 기존 방식의 문제 (DB korean_alias)

사용자가 한글로 외래어 건설 용어를 검색할 때 (예: "크러셔", "플랜지"), 영문명으로 저장된 DB 엔티티와 매칭되지 않는 문제가 있었다. 이를 해결하기 위해 `graph_entities.properties.korean_alias`에 한글 별칭을 일일이 등록하는 방식은 다음과 같은 구조적 한계가 있다:

| 문제              | 설명                                                    |
| ----------------- | ------------------------------------------------------- |
| **확장성 부재**   | 신규 엔티티 추가 시마다 수동 별칭 등록 필요             |
| **커버리지 한계** | "크러셔", "크라셔", "크러셔기" 등 동의어/변형 대응 불가 |
| **유지보수 부담** | 986개 WorkType × N개 변형 = 비현실적                    |

### 올바른 해결 방향: 의도 분석 단계에서 번역

DB에 별칭을 등록하지 않고, **DeepSeek 의도 분석 시점에서 LLM이 자동 번역**하도록 프롬프트를 수정하면:
- LLM이 자체 지식으로 한글 외래어 → 영문 원어를 자동 매핑
- 동의어/변형/비표준 표기도 자연스럽게 처리
- 유지보수 비용 제로

---

## 2. 변경 내용

### 2-1. DeepSeek INTENT_SYSTEM_PROMPT 수정 (L882~893)

키워드 추출 규칙에 **한글 외래어 → 영문 원어 번역 지시** 추가:

```
## 키워드 추출 규칙
- 영문 약어 → 한글 변환: "tig" → ["TIG", "TIG용접"]
- ⭐ 한글 외래어 → 영문 원어 번역 (필수!): 
  예: "크러셔" → ["크러셔", "Crusher"]
  예: "에이치빔" → ["에이치빔", "H-Beam"]
  예: "탱크" → ["탱크", "Tank", "STORAGE TANK"]
- ⭐ work_name도 동일하게: 한글 외래어 → 영문 원어
  예: "크러셔 운전" → work_name: "Crusher"
```

**설계 근거**: DeepSeek이 정상 동작하면 LLM이 자체 지식으로 번역하므로 딕셔너리 불필요. LLM의 언어 능력을 활용한 범용적 해결.

### 2-2. KO_EN_DICT 정적 딕셔너리 추가 (L901~930)

DeepSeek API 장애 시 `ruleBasedIntent()` 폴백에서도 기본적인 한→영 변환을 보장하기 위한 정적 매핑 38개 항목:

```typescript
const KO_EN_DICT: Record<string, string[]> = {
    "크러셔": ["Crusher"], "크라셔": ["Crusher"],
    "플랜지": ["Flange"], "플렌지": ["Flange"],
    "에이치빔": ["H-Beam"], "탱크": ["Tank", "STORAGE TANK"],
    "티그": ["TIG", "TIG용접"], "크레인": ["Crane"],
    "펌프": ["Pump"], "밸브": ["Valve"],
    // ... 총 38개 항목
};
```

**설계 근거**: 
- DeepSeek 장애(연결 실패, rate limit 등) 시에도 핵심 건설 용어 번역 보장
- 정적 딕셔너리는 **보조 수단**이며, 주된 번역은 DeepSeek LLM이 담당

### 2-3. ruleBasedIntent 함수 로직 개선 (L931~970)

| 항목             | 변경 전             | 변경 후                              |
| ---------------- | ------------------- | ------------------------------------ |
| keywords         | 한글만 포함         | 한글 + 영문 번역 + 질문 내 영문 단어 |
| work_name        | 첫 번째 한글 키워드 | 영문 번역이 있으면 영문 원어 우선    |
| 영문 키워드 추출 | 없음                | 질문에서 직접 영문 단어 추출         |

```typescript
// 변경 전
const work_name = workKeywords.length > 0 ? workKeywords[0] : null;
keywords: workKeywords;

// 변경 후
const work_name = translatedKeywords.length > 0
    ? translatedKeywords[0]  // 영문 원어 우선 (DB 엔티티명과 매칭)
    : (workKeywords.length > 0 ? workKeywords[0] : null);
keywords: allKeywords;  // 한글 + 영문 번역 + 질문 내 영문
```

---

## 3. 테스트 결과

### 배포 확인
- ✅ v47 배포 성공 (96.47kB)
- ✅ HTTP 200 응답 정상

### 한→영 번역 기능 자체는 정상 구현

**단, 테스트에서 발견된 별도 이슈:**

| 테스트 질문                 | 결과             | 분석                  |
| --------------------------- | ---------------- | --------------------- |
| "크러셔 운전 품셈 알려줘"   | entities_found=0 | ⚠️ 아래 별도 이슈 참조 |
| "에이치빔 설치 품셈 알려줘" | entities_found=0 | ⚠️ 아래 별도 이슈 참조 |
| "크러셔 품셈 알려줘"        | entities_found=0 | ⚠️ 아래 별도 이슈 참조 |

---

## 4. 발견된 별도 이슈: targetSearch ILIKE 패턴 매칭 문제

### 증상
"크러셔 품셈"으로 검색해도 `entities_found=0`이지만, DB에는 크러셔 WorkType이 **실제로 존재** (`W-4642` ~ `W-4670`, source_section: `8-2-12`).

### 원인 분석
`targetSearch` 함수의 ILIKE 패턴이 키워드를 **결합**하여 생성하기 때문:

```
질문: "크러셔 운전 품셈 알려줘"
추출 키워드: ["크러셔", "운전"]
생성 패턴: %크러셔%운전%
DB 엔티티명: 크러셔(13, 060040)
→ 매칭 실패! ("운전"이 엔티티명에 없음)
```

### 이 이슈의 본질
- 한→영 번역 문제가 **아님**
- `targetSearch`의 키워드 결합 ILIKE 패턴이 과도하게 구체적
- "운전", "설치" 같은 **동작어가 불용어로 제거되지 않아** 패턴에 포함되어 매칭 실패
- **해결 방향**: `targetSearch`에서 "설치", "운전", "철거", "조립" 등 동작어를 불용어로 추가하거나, 키워드 개별 ILIKE OR 패턴으로 변경

### 영향 범위
이 이슈는 **모든 "공종명 + 동작어" 검색**에 영향 (크러셔만의 문제가 아님):
- "크레인 운전 품셈" → 실패 가능
- "펌프 설치 품셈" → 실패 가능
- "H-Beam 설치 품셈" → 예외적으로 성공 가능 (엔티티명 자체에 "설치" 포함)

> [!IMPORTANT]
> **이 이슈는 본 작업(한→영 번역)과 독립적인 별도 개선 사항**입니다.
> 향후 `targetSearch` 함수의 키워드 패턴 생성 로직을 개선하면 해결됩니다.

---

## 5. 파일 변경 이력

| 변경 위치              | 라인     | 내용                                                |
| ---------------------- | -------- | --------------------------------------------------- |
| `INTENT_SYSTEM_PROMPT` | L882~893 | 한글→영문 번역 지시 7줄 추가                        |
| `KO_EN_DICT`           | L901~930 | 한→영 정적 딕셔너리 38항목 추가                     |
| `ruleBasedIntent()`    | L931~970 | 한→영 번역 + 영문 키워드 추출 + work_name 영문 우선 |

**파일 동기화**: 
- 원본: `C:\Users\lhs\sb_deploy\supabase\functions\rag-chat\index.ts`
- 백업: `G:\내 드라이브\Antigravity\python_code\supabase\functions\rag-chat\index.ts`

---

## 6. 다음 단계 (권장)

1. **`targetSearch` ILIKE 패턴 개선** — "운전", "설치", "철거" 등 동작어를 불용어 처리
2. **개별 키워드 OR 검색** — 복합 패턴 대신 키워드별 개별 ILIKE OR로 변경
3. **추가 KO_EN_DICT 항목** — 실제 사용 패턴에서 누락된 용어 추가
