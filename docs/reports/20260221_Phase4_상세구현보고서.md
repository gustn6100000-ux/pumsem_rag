# Phase 4 지식 그래프 RAG 통합 아키텍처 및 상세 구현 기획서

**작성일**: 2026-02-21
**목적**: Phase 1.5 ~ Phase 3를 통해 환각(Hallucination)이 100% 제거된 무결점 지식 그래프 데이터를 바탕으로, RAG(Retrieval-Augmented Generation) 시스템 및 Supabase Edge Function을 고도화(Phase 4)하기 위한 상세 변경 명세서입니다.

---

## 1. 개요 및 설계 방향
과거 Phase 4(2월 중순경)에서는 오염된 데이터로 인해 발생하던 "검색 결과 중복", "환각 노드 참조", "Token ILIKE 병합" 등 데이터의 결함을 애플리케이션(Edge Function/SQL) 단에서 억지로 땜질(Patch)하는 복잡한 로직이 주를 이루었습니다.

하지만 이제 DB 레이어에 **순도 100%의 정제된 엔티티(16,302건)와 관계(31,118건)**가 적재되어 있으므로, Phase 4의 아키텍처는 "검색 성능의 극대화"와 "정보의 손실(per_unit 등) 방지"에 초점을 맞추어 **코드를 대폭 다이어트 시키고 직관적으로 리팩토링**합니다.

---

## 2. 모듈별 상세 변경 사항 (Action Plan)

### 2.1. Supabase SQL RPC (DB 저장소 레벨 변경)
DB 내에 존재하는 노드가 모두 신뢰할 수 있으므로, 복잡했던 중복 제거 로직을 단순화하고, 새롭게 추가된 스키마(per_unit)를 반환하도록 수정합니다.

- **대상 파일**: `supabase/migrations/[시간]_rag_search_rpcs.sql` 신규 작성 혹은 기존 Search 함수 수정
- **변경 사항**:
  1. **텍스트 검색 함수 (`match_entities`, `search_graph_nodes` 등)**
     - 과거엔 중복 노드를 Group By로 묶어내던 로직 지양 -> 이미 Step 4에서 엔티티가 Dedup 되었으므로 **단항 검색(Single Row Match)**으로 전환.
     - `properties->>'per_unit'` 속성을 Query 아웃풋 조인 결과에 명시적으로 노출시킵니다.
  2. **관계 탐색 함수 (`get_entity_relationships`)**
     - 기존에 방향성(`target_type`, `source_type`)이 틀려 양방향 조회를 해야 했던 로직을 제거하고, **정방향(`source_id` -> `target_id`) 조회 규칙으로 단순화**(Phase 2.4 - Phase C 방향 보정 완료 효과).정방향 탐색 속도 2배 향상 기대.

### 2.2. Supabase Edge Function 로직 변경
RAG 챗봇으로 질문이 들어왔을 때, 컨텍스트를 조립하는 백엔드 함수입니다. (예: `search-pumsem` 또는 `chat-agent`)

- **대상 파일**: `supabase/functions/search-pumsem/index.ts` (또는 관련 함수)
- **변경 사항**:
  1. **과도한 애플리케이션 레벨의 후처리(Post-processing) 제거**
     - `deduplicateResults()` 등 코드 단에서 엔티티 중복을 걸러내던 무거운 자바스크립트 로직을 전면 제거합니다(DB 무결성 확보의 이점).
  2. **`per_unit` (기준단위) 조립 로직 신설**
     - LLM 프롬프트 조립 로직(Context Builder)에서 관계 투입량을 표기할 때, `단위(unit)`뿐만 아니라 **`기준단위(per_unit)`를 함께 렌더링**하도록 추가합니다.
     - *수정 전*: `강관용접 -> 용접공 (0.3 인)`
     - *수정 후*: `강관용접 -> 용접공 (0.3 인 / 10m 당) (source_spec: SCH 40)`
  3. **고립 청크(Orphan Chunk)에 대한 Semantic Search 폴백(Fallback)**
     - 관계망이 비어있는 Section 및 주석(Note)을 묻는 질문 대비, `graph_chunks` 테이블 대상 pgvector 유사도 검색 가중치를 조정하여 검색 커버리지를 보완합니다.

### 2.3. RAG LLM System Prompt (Agent 레벨 변경)
최종 사용자에게 답변을 생성하는 LLM의 프롬프트 지침을 현재 데이터 구조에 맞게 튜닝합니다.

- **대상 위치**: Edge Function 내부의 System Prompt 상수 블록
- **변경 사항**:
  1. **기준단위 표기 의무화**: "투입 수량을 답변할 때는 제공된 컨텍스트에 있는 `per_unit`(예: '1m3당')을 반드시 사용자에게 공지하라."는 시스템 룰 추가.
  2. **스펙 혼동 방지**: "동일한 공종명이더라도 `source_spec`(관경, 두께 등)에 따라 투입량이 다르므로, 사용자가 규격을 누락하고 질문한 경우 섣불리 대답하지 말고 **명확화(Clarification)** 플로우를 통해 규격을 되물어라."라는 엄격한 지시어 하드코딩.

---

## 3. 기대 효과 및 실행 순서
1. **[Phase 4A] SQL RPC 패치**: 무결성 데이터 기반의 가볍고 빠른 Graph 탐색 SQL 배포.
2. **[Phase 4B] Edge Function 리팩토링**: `per_unit` 반영 및 사용되지 않는 쓰레기(Legacy) 중복 제거 자바스크립트 코드 삭거.
3. **[Phase 4C] Edge Function Deploy & e2e 테스팅**: 실제 질문("SCH 40 강관용접 200mm 인건비 알려줘") 쿼리를 통한 RAG 테스트 수행 및 답변 정확성 검증.
