# Phase 4 RAG 챗봇 검증 결과 보고서

> **작성일**: 2026-02-12 (수) 20:50  
> **선행 보고서**: `20260212_Phase2_DB적재_임베딩_실행결과.md`

---

## 1. 검증 결과 요약

### 판정: ❌ **FAIL** — 0/5 PASS

RAG 챗봇 TC-1~6 자동 검증 결과, **모든 테스트 케이스가 실패**했다.
원인은 데이터 적재 자체의 문제가 아니라, **엔티티 중복 + 벡터 검색 미스매칭**이다.

---

## 2. 근본 원인 분석

### 2-1. 엔티티 중복 문제

DB에 동일한 물리적 대상에 대해 **이름이 미묘하게 다른 2벌의 엔티티**가 존재한다.

| φ 없음 (step1 D1 추출)  | φ 있음 (step2 LLM 추출)  |
| ----------------------- | ------------------------ |
| `강관용접(200, SCH 40)` | `강관용접(φ200, SCH 40)` |
| `강관용접(200, SCH 20)` | `강관용접(φ200, SCH 20)` |
| `강관용접(200, SCH 80)` | `강관용접(φ200, SCH 80)` |

### 2-2. 데이터 정확도 차이

| 엔티티                   | 직종             |      수량 | 기대값 | 정확?                   |
| ------------------------ | ---------------- | --------: | -----: | ----------------------- |
| `강관용접(200, SCH 40)`  | 플랜트용접공     | **0.287** |  0.287 | ✅                       |
| `강관용접(φ200, SCH 40)` | 플랜트용접공     | **0.294** |  0.287 | ❌                       |
| `강관용접(200, SCH 20)`  | **용접공**       | **0.287** |  0.287 | ✅                       |
| `강관용접(φ200, SCH 20)` | ~~플랜트용접공~~ | **0.244** |  0.287 | ❌ (직종+수량 모두 틀림) |
| `강관용접(φ200, SCH 80)` | 플랜트용접공     | **0.416** |  0.362 | ❌                       |
| `강관용접(φ15, SCH 80)`  | 플랜트용접공     | **0.067** |  0.075 | ❌                       |
| `강관용접(φ350, SCH 20)` | ~~플랜트용접공~~ | **0.438** |  0.442 | ❌ (직종도 틀림)         |

**핵심**: 
- **φ 없는 버전** (step1 D1 테이블 추출) = **정확** ✅
- **φ 있는 버전** (step2 LLM 추출) = **부정확** ❌ — LLM이 테이블에서 추론한 값

### 2-3. 벡터 검색 미스매칭

사용자가 "강관용접 200mm SCH 40"을 검색하면:
- `강관용접(250, SCH 60)` — similarity 0.889 (최상위, **전혀 다른 규격**)
- `강관용접(250, SCH 40)` — similarity 0.876
- 정작 `강관용접(200, SCH 40)`은 Top 5에 미포함

**원인**: 임베딩 모델이 "200mm"와 "(200,"의 의미적 유사성을 정확히 파악하지 못함

---

## 3. 발생 경로 추적

```
[step1] D1 패턴 → 강관용접(200, SCH 40) ← 정확한 수치
                ↓
[step2] LLM 추출 → 강관용접(φ200, SCH 40) ← LLM이 φ 접두사 추가 + 잘못된 수치
                ↓
[step3] 병합 → 이름이 다르므로 별도 엔티티로 보존
         ※ 테이블 우선 로직은 "같은 이름"의 엔티티에만 적용
                ↓
[step4] 정규화 → 이름이 다르므로 중복 제거 안 됨
                ↓
[step6] DB 적재 → 2벌 모두 적재
                ↓
[step7] 임베딩 → φ 있는 버전이 벡터 공간에서 더 잘 매칭
                ↓
[검색] → 부정확한 φ 버전이 검색되어 잘못된 값 반환
```

---

## 4. 해결 방안

### 방안 A: step4 정규화에서 φ 접두사 통일 (권장)

**위치**: `step4_normalizer.py`의 엔티티 정규화 로직

```python
# 이름에서 φ, Φ, ø, ∅ 등을 통일 또는 제거
# 예: "강관용접(φ200, SCH 40)" → "강관용접(200, SCH 40)"
import re
def normalize_entity_name(name):
    # φ 접두사 제거 (구경 값 앞의 φ/Φ/ø/∅)
    name = re.sub(r'[φΦø∅]\s*(\d)', r'\1', name)
    # 공백 정리
    name = re.sub(r'\s+', ' ', name).strip()
    return name
```

**효과**: 
- LLM 추출의 φ 버전이 step1의 정확한 버전과 병합
- step3의 "테이블 우선" 로직이 작동 → step1 수치 보존
- 중복 엔티티 제거 → 벡터 검색에서 1건만 매칭

**영향 범위**: step4 이후 (step5, step6, step7) 재실행 필요

### 방안 B: 벡터 검색 + 키워드 폴백 (보완)

**위치**: Edge Function `searchEntities()`

벡터 검색 결과에 정확한 규격이 없으면, 키워드 기반 폴백 검색:
```sql
SELECT * FROM graph_entities
WHERE name ILIKE '%강관용접%' AND name ILIKE '%200%' AND name ILIKE '%SCH 40%'
ORDER BY name;
```

### 방안 C: DB 정리 (임시)

φ 있는 버전의 엔티티를 DB에서 직접 삭제:

```sql
-- φ 접두사가 포함된 강관용접 엔티티 삭제
DELETE FROM graph_relationships
WHERE source_id IN (SELECT id FROM graph_entities WHERE name LIKE '강관용접(φ%');
DELETE FROM graph_entities WHERE name LIKE '강관용접(φ%';
```

---

## 5. 권장 실행 순서

1. **방안 A 구현**: step4 정규화에서 φ 통일 → step4~step7 재실행 (~30분)
2. **방안 B 구현**: Edge Function에 키워드 폴백 추가
3. **재검증**: TC-1~7 재실행

---

## 6. 테스트 로그

### TC-1 응답 전문

```
질문: "강관용접 200mm SCH 40 품셈"

답변: "제공된 품셈 데이터에서 정확히 일치하는 강관용접(200mm, SCH 40)에 대한 
직접적인 품셈은 찾을 수 없습니다. 그러나 유사한 조건의 품셈 정보를 제공합니다.

📋 [표 13-2-3] 강관용접 품셈
📍 출처: 기계설비부문 > 제13장 플랜트설비공사 > 강관용접

강관용접(φ200, SCH 120) 1개소당
| 직종         |  수량 | 단위 |
| ------------ | ----: | ---- |
| 플랜트용접공 | 0.557 | 인   |
| 특별인부     | 0.326 | 인   | " |

소스: 강관용접(250, SCH 60) sim=0.889 ← 완전히 다른 규격이 Top 1
```

### DB 검증 결과 전문

| 엔티티                 | 직종         | 실제 수량 | 기대 수량 | 일치 |
| ---------------------- | ------------ | --------: | --------: | ---- |
| 강관용접(200, SCH 40)  | 플랜트용접공 |     0.287 |     0.287 | ✅    |
| 강관용접(φ200, SCH 40) | 플랜트용접공 |     0.294 |     0.287 | ❌    |
| 강관용접(200, SCH 20)  | 용접공       |     0.287 |     0.287 | ✅    |
| 강관용접(φ200, SCH 20) | 플랜트용접공 |     0.244 |     0.287 | ❌    |
| 강관용접(φ200, SCH 80) | 플랜트용접공 |     0.416 |     0.362 | ❌    |
| 강관용접(φ15, SCH 80)  | 플랜트용접공 |     0.067 |     0.075 | ❌    |
| 강관용접(φ350, SCH 20) | 플랜트용접공 |     0.438 |     0.442 | ❌    |

**결론**: φ 없는 버전(step1 D1 추출)은 정확. φ 있는 버전(step2 LLM 추출)은 부정확. 정규화에서 φ 통일이 핵심.
