# 셀렉터 정렬 및 출력 품질 개선 구현 결과

**일시**: 2026-02-15  
**배포**: Edge Function v80 (clarify.ts + index.ts)  
**상태**: 배포 완료, 사용자 검증 대기

---

## 문제 (3건)

|   #   | 문제                 | 증상                                 | 원인                                                                             |
| :---: | -------------------- | ------------------------------------ | -------------------------------------------------------------------------------- |
|   1   | **셀렉터 정렬**      | 15→150→20→200 순서 (문자열 정렬)     | `buildSelectorPanel()`에서 정렬 미적용                                           |
|   2   | **출력 데이터 정렬** | 90→200→90→200 혼재                   | `buildContext()`에서 work_type_name 순서 그대로 출력                             |
|   3   | **주의사항 간결**    | "비파괴검사 KS 1급 가산" 제목만 표시 | Note entity의 `note_content`=null, 실제 내용은 `properties.spec/quantity`에 저장 |

---

## 수정 내용

### 1. `clarify.ts` — 셀렉터 아이템 숫자 정렬

**위치**: `buildSelectorPanel()` 함수 (L392 부근)

```diff
     if (selectorItems.length < 6) return undefined;

+    // 숫자 기준 자연 정렬 (15, 20, 90, 100, 125, 150, 200)
+    selectorItems.sort((a, b) => {
+        const numA = parseInt((a.label.match(/\d+/) || ['0'])[0], 10);
+        const numB = parseInt((b.label.match(/\d+/) || ['0'])[0], 10);
+        if (numA !== numB) return numA - numB;
+        return a.label.localeCompare(b.label, 'ko');
+    });
+
     const filters = extractFilterAxes(selectorItems);
```

**효과**: label에서 첫 번째 숫자를 추출하여 자연수 정렬. 같은 숫자면 한국어 로케일 비교.

**기대 결과**: `강관용접(15, SCH 40)` → `강관용접(20, SCH 40)` → `강관용접(90, SCH 40)` → `강관용접(100, SCH 40)` → `강관용접(125, SCH 40)` → `강관용접(150, SCH 40)` → `강관용접(200, SCH 40)`

---

### 2. `index.ts` — 출력 데이터 work_type_name 숫자 정렬

**위치**: `buildContext()` 함수, 투입 인력 `hasWorkType` 분기 (L155 부근)

```diff
                 parts.push(`**[표 ${sectionId}] 투입 인력**\n`);
-                for (const [workName, laborItems] of byWorkType) {
+                const sortedWorkTypes = [...byWorkType.entries()].sort(([a], [b]) => {
+                    const numA = parseInt((a.match(/\d+/) || ['0'])[0], 10);
+                    const numB = parseInt((b.match(/\d+/) || ['0'])[0], 10);
+                    if (numA !== numB) return numA - numB;
+                    const numA2 = parseInt((a.match(/\d+.*?(\d+)/)?.[1] || '0'), 10);
+                    const numB2 = parseInt((b.match(/\d+.*?(\d+)/)?.[1] || '0'), 10);
+                    return numA2 - numB2;
+                });
+                for (const [workName, laborItems] of sortedWorkTypes) {
```

**효과**: 규격 이름에서 숫자 2개를 추출하여 정렬 (1차: 호칭경, 2차: SCH).

**검증 결과** (API 테스트):
```
v78: 90→200→90→200→200→200 (혼재)
v79: 구경 90mm → 구경 200mm (정렬됨) ✅
```

---

### 3. `index.ts` — 주의사항 상세 출력 (spec + quantity)

**위치**: `buildContext()` 함수, HAS_NOTE 처리 (L212 부근)

**수정 전** (v79):
```
- 비파괴검사 KS 1급 가산: 계수 1        ← 계수 표시
- Back Mirror 용접 가산: 계수 0.3
```

**수정 후** (v80): `properties.content`(원문) 최우선, quantity를 %로 변환
```typescript
const content = props.note_content;  // expandGraph에서 주입된 원문
if (content) {
    // 원문 그대로 출력 (note_13-2-3_* 엔티티)
    parts.push(`- ${content}`);
} else {
    // 개별 Note: quantity를 %로 변환 (0.3 → 30%)
    const pct = Math.round(Number(quantity) * 100);
    detail += `: ${pct}%까지 ${action}`;
}
```

**DB 데이터 구조**:
- `note_13-2-3_5` (N-0699): `properties.content`에 원문 전체 저장
  - "다음과 같은 용접작업인 경우는 본 품을 증감한다. ㉮ Back Mirror 용접(극히 협소한 장소) : 30%까지 가산..."
- 개별 Note (N-0163 등): `properties.quantity`에 계수(0.3), `properties.spec`에 조건

**검증 결과** (v80 API 테스트):
```
- 비파괴검사 KS 1급 가산: 100%까지 가산    ✅
- Back Mirror 용접 가산: 30%까지 가산       ✅ (이전: 계수 0.3)
- Back Ring 사용 가산: 25%까지 가산          ✅
- Nozzle 용접 가산: 50%까지 가산             ✅
- Sloping Line 용접 가산: 100%까지 가산      ✅
- Mitre 용접 가산: 50%까지 가산              ✅
- Socket 용접 감: 40%까지 감                 ✅
```

---

## DB 데이터 참고 (Note entity 구조)

| id     | name                   | properties.spec   | properties.quantity |
| ------ | ---------------------- | ----------------- | ------------------- |
| N-3682 | 비파괴검사 KS 1급 가산 | 100% 범위 내 가산 | 1.0                 |
| N-0163 | Back Mirror 용접 가산  | 극히 협소한 장소  | 0.3                 |
| N-0164 | Back Ring 사용 가산    | (없음)            | 0.25                |
| N-0234 | Mitre 용접 가산        | (없음)            | 0.5                 |
| N-0238 | Nozzle 용접 가산       | (없음)            | 0.5                 |
| N-0265 | Sloping Line 용접 가산 | (없음)            | 1.0                 |
| N-0266 | Socket 용접 감         | (없음)            | 0.4                 |

> Note: `note_content` 필드는 전체적으로 **null**. LLM 추출 시 `spec`과 `quantity` properties에 저장됨.

---

## 검증 가이드

### 셀렉터 정렬 확인 (프론트엔드)
1. 챗봇에서 **"강관용접 전기아크용접 품셈"** 입력
2. 섹션 선택 후 **"1. 전기아크용접"** 선택
3. 셀렉터 패널에서 아이템 순서가 **숫자 순**(15→20→25→32→...→200) 인지 확인

### 출력 데이터 정렬 확인
1. 셀렉터에서 **90 SCH40, 200 SCH40** 등 복수 선택
2. 출력된 투입 인력 테이블이 **호칭경 오름차순**이고, 같은 호칭경 내 **SCH 오름차순**인지 확인

### 주의사항 상세 확인
1. 위와 같은 쿼리 결과에서 주의사항 섹션 확인
2. 각 주의사항에 **가산/감 수치**와 **조건**(있는 경우)이 함께 표시되는지 확인
