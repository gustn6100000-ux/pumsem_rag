# ğŸ“‹ ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘ ì¶œë ¥ê°’ ì¶•ì†Œ/ì™œê³¡ ë¬¸ì œ â€” ìƒì„¸ ì§„ë‹¨ ë¦¬í¬íŠ¸

> **ì‘ì„±ì¼**: 2026-02-27  
> **ëŒ€ìƒ ì‹œìŠ¤í…œ**: í’ˆì…ˆ AI ì±—ë´‡ (Edge Function `rag-chat`)  
> **í”„ë¡œë•ì…˜ URL**: https://main.antigravity-chatbot.pages.dev/  
> **ì¦ìƒ**: "ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘" ê²€ìƒ‰ ì‹œ ìˆ˜ì¹˜ ë°ì´í„°ê°€ ì¶•ì†ŒÂ·ì™œê³¡ë˜ê±°ë‚˜ ì•„ì˜ˆ í‘œì‹œ ì•ˆ ë¨

---

## 1. ì¦ìƒ ìš”ì•½

### 1.1 ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤

| ë‹¨ê³„ | ì‚¬ìš©ì ì…ë ¥ | ì±—ë´‡ ì‘ë‹µ | ë¬¸ì œì  |
|:---:|---|---|---|
| 1 | "ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘ í’ˆì…ˆ ì•Œë ¤ì¤˜" | **5ê°œ ë¶„ì•¼** clarify ì¹© ì œì‹œ (13-2-4, 13-2-2, etc.) | âŒ ìˆ˜ì¹˜ ì—†ì´ ì„ íƒë§Œ ìš”êµ¬ |
| 2 | ë¶„ì•¼ ì¹© ì„ íƒ (13-2-4) | **6ê°œ ë¶„ë¥˜** clarify ì¬ì œì‹œ (Ví˜• 44ê±´, Uí˜• 29ê±´...) | âŒ ì—¬ì „íˆ ìˆ˜ì¹˜ ì—†ìŒ |
| 3 | ë¶„ë¥˜ ì¹© ì„ íƒ (e.g. Ví˜•) | LLM ì‘ë‹µ ìƒì„± â†’ í…Œì´ë¸” **ì¶•ì†Œ/ì™œê³¡** | âŒ ê°’ì´ ë¶€ì •í™•í•˜ê±°ë‚˜ ì˜ë¦¼ |

### 1.2 ê¸°ëŒ€ ë™ì‘ vs ì‹¤ì œ ë™ì‘

```
ê¸°ëŒ€: ë‘ê»˜ë³„ ì†Œìš”ì „ë ¥/ìš©ì ‘ë´‰ì‚¬ìš©ëŸ‰/ì¸ë ¥ êµì°¨í‘œê°€ ì •í™•í•œ ìˆ˜ì¹˜ë¡œ ì¶œë ¥
ì‹¤ì œ: clarify ë¬´í•œ ë£¨í”„ or LLMì´ ìˆ˜ì¹˜ë¥¼ ì„ì˜ë¡œ ìš”ì•½/ì¶•ì†Œ/ëˆ„ë½
```

---

## 2. ë°ì´í„° ê³„ì¸µ ë¶„ì„

### 2.1 DB í…Œì´ë¸” êµ¬ì¡°

```mermaid
graph TD
    A[graph_chunks<br/>14ê±´ / section 13-2-4] -->|tables JSON| B[êµì°¨í‘œ ë°ì´í„°<br/>15ê°œ í…Œì´ë¸”]
    A -->|text| C[ì›ë¬¸ í…ìŠ¤íŠ¸<br/>220ì + 0ìÃ—13]
    D[graph_entities<br/>130ê±´ WorkType] -->|properties| E[quantity: null âŒ<br/>unit: null âŒ]
    D -->|source_section| A
    F[graph_relationships<br/>REQUIRES_LABOR] -->|properties| G[quantity: 7.0 âœ…<br/>unit: ì¸ âœ…]
    D -->|source_id| F
```

### 2.2 section 13-2-4 ë°ì´í„° í˜„í™©

#### graph_chunks (14ê±´)

| chunk_id | tables ìˆ˜ | text ê¸¸ì´ | ë¹„ê³  |
|---|:---:|:---:|---|
| C-0956-A | 1 | 220ì | Ví˜•(ë‘ê»˜ 3~6mm) |
| C-0956-B | 1 | 0ì | Ví˜•(ë‘ê»˜ 7~10mm) |
| C-0956-C | 1 | 0ì | Ví˜•(ë‘ê»˜ 11~14mm) |
| C-0956-D | 2 | 0ì | Ví˜•(15mm) + Uí˜•(15~30mm) |
| C-0956-E ~ N | ê° 1 | 0ì | Uí˜•/Hí˜•/Xí˜•/Fillet ë°ì´í„° |

> [!IMPORTANT]
> **14ê°œ chunkì— 15ê°œ í…Œì´ë¸”**ì´ JSONìœ¼ë¡œ ì •ë°€ ì €ì¥ë¨. textëŠ” ê±°ì˜ ë¹„ì–´ìˆê³ , **ì‹¤ì œ ë°ì´í„°ëŠ” `tables` í•„ë“œì— ì§‘ì¤‘**.

#### graph_entities â€” WorkType ë¶„í¬ (ì´ 130ê±´)

| sub_section | ê°œìˆ˜ | ì˜ˆì‹œ entity name |
|---|:---:|---|
| 0. ì „ê¸°ì•„í¬ìš©ì ‘(ì´ê´„) | 1 | â€” |
| 1. ì „ê¸°ì•„í¬ìš©ì ‘(Ví˜•) | **44** | `ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘(10, SCH ì†Œìš”ì „ë ¥(kWh))` |
| 2. ì „ê¸°ì•„í¬ìš©ì ‘(Uí˜•) | **29** | `ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘(20, SCH ì¸ ë ¥(ì¸))` |
| 3. ì „ê¸°ì•„í¬ìš©ì ‘(Hí˜•) | **16** | `ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘(H, 15mm ìš©ì ‘ë´‰ì‚¬ìš©ëŸ‰(kg))` |
| 4. ì „ê¸°ì•„í¬ìš©ì ‘(Xí˜•) | **23** | `ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘(X, 25mm ì†Œìš”ì „ë ¥(kWh))` |
| 5. ì „ê¸°ì•„í¬ìš©ì ‘(Filletìš©ì ‘) | **17** | `ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘(Fillet, 6mm ì¸ ë ¥(ì¸))` |

> [!WARNING]
> entity nameì— **(ë‘ê»˜, SCH, ì¸¡ì •í•­ëª©)** ì´ ëª¨ë‘ í¬í•¨ëœ ë¹„ì •ê·œí™” êµ¬ì¡°. `properties.quantity`ì™€ `properties.unit`ì€ **ëª¨ë‘ null**. ì‹¤ì œ ìˆ˜ì¹˜ëŠ” `graph_relationships.properties.quantity`ì—ë§Œ ì¡´ì¬.

#### graph_relationships â€” ì‹¤ì²´ ìˆ˜ì¹˜ ë°ì´í„°

`W-0530` (ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘(10, SCH ì†Œìš”ì „ë ¥(kWh))) ê¸°ì¤€:

| relation | target | quantity | unit | ë¹„ê³  |
|---|---|:---:|---|---|
| REQUIRES_LABOR | í•˜í–¥ (L-0454) | 7.0 / 4.7 | ì¸ | âš ï¸ ì¤‘ë³µ(2ê±´) |
| REQUIRES_LABOR | íš¡í–¥ (L-0484) | 8.0 / 5.25 | ì¸ | âš ï¸ ì¤‘ë³µ(2ê±´) |
| REQUIRES_LABOR | ì…í–¥ (L-0310) | 8.4 / 6.1 | ì¸ | âš ï¸ ì¤‘ë³µ(2ê±´) |
| REQUIRES_LABOR | ìƒí–¥ (L-0250) | 5.7 | ì¸ | 1ê±´ |
| BELONGS_TO | Section S-0266 | â€” | â€” | ì†Œì† ê´€ê³„ |

> [!CAUTION]
> ë™ì¼ sourceâ†’target ê´€ê³„ì— **quantityê°€ ë‹¤ë¥¸ ì¤‘ë³µ ë ˆì½”ë“œ**ê°€ ì¡´ì¬ (7.0 vs 4.7 ë“±). ì´ëŠ” ì¶”ì¶œ íŒŒì´í”„ë¼ì¸ì˜ merge ê³¼ì •ì—ì„œ ë°œìƒí•œ ê²ƒìœ¼ë¡œ, **ì–´ë–¤ ê°’ì´ ì •í™•í•œì§€ íŒë³„ ë¶ˆê°€**. ë°˜ë©´ `graph_chunks.tables` JSONì—ëŠ” ì •í™•í•œ ì›ë³¸ê°’ì´ ë³´ì¡´ë¨.

#### graph_chunks.tables JSON â€” ì›ë³¸ ë°ì´í„° ìƒ˜í”Œ

```json
// C-0956-A, í…Œì´ë¸” T-13-2-4-01-1 (Ví˜•, ë‘ê»˜ 3~6mm)
{
  "type": "D_ê¸°íƒ€",
  "table_id": "T-13-2-4-01-1",
  "headers": ["êµ¬ë¶„ ìì„¸ ë° ì§ì¢… ë‘ê»˜(mm)", "ìš©ì ‘ë´‰ì‚¬ìš©ëŸ‰(kg)_í•˜í–¥", ...],
  "rows": [
    {
      "êµ¬ë¶„ ìì„¸ ë° ì§ì¢… ë‘ê»˜(mm)": 3,
      "ì†Œìš”ì „ë ¥(kWh)_í•˜í–¥": "0.60",
      "ì†Œìš”ì „ë ¥(kWh)_íš¡í–¥": "0.70",
      "ì†Œìš”ì „ë ¥(kWh)_ì…í–¥": "0.90",
      "ìš©ì ‘ë´‰ì‚¬ìš©ëŸ‰(kg)_í•˜í–¥": 0.17,
      "ìš©ì ‘ë´‰ì‚¬ìš©ëŸ‰(kg)_íš¡í–¥": "0.20",
      "ìš©ì ‘ë´‰ì‚¬ìš©ëŸ‰(kg)_ì…í–¥": 0.22,
      "ì¸ ë ¥(ì¸)_í•˜í–¥_ìš©ì ‘ê³µ": "0.030",
      "ì¸ ë ¥(ì¸)_í•˜í–¥_íŠ¹ë³„ì¸ë¶€": 0.009,
      "ì¸ ë ¥(ì¸)_íš¡í–¥_ìš©ì ‘ê³µ": 0.036,
      "ì¸ ë ¥(ì¸)_íš¡í–¥_íŠ¹ë³„ì¸ë¶€": 0.011,
      "ì¸ ë ¥(ì¸)_ì…í–¥_ìš©ì ‘ê³µ": 0.044,
      "ì¸ ë ¥(ì¸)_ì…í–¥_íŠ¹ë³„ì¸ë¶€": 0.013
    },
    // ... ë‘ê»˜ 4mm, 5mm, 6mm í–‰
  ]
}
```

> âœ… **ì´ JSONì´ ê°€ì¥ ì •í™•í•œ ì›ë³¸ ë°ì´í„°**. ë‘ê»˜Ã—ìì„¸Ã—ì§ì¢…Ã—ì¸¡ì •í•­ëª©ì´ ì™„ì „í•œ êµì°¨í‘œ í˜•íƒœ.

---

## 3. ì½”ë“œ íë¦„ ì¶”ì 

### 3.1 ì „ì²´ íŒŒì´í”„ë¼ì¸ íë¦„ë„

```mermaid
flowchart TD
    Q["ì‚¬ìš©ì: ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘ í’ˆì…ˆ"] --> HC[handleChat]
    HC --> AI[analyzeIntent<br/>clarify.ts]
    AI -->|intent=clarify_needed| GC[graphClarify<br/>clarify.ts â†’ resolve.ts]
    GC -->|5ê°œ ë¶„ì•¼ ì¹©| U1["ì‚¬ìš©ì: ì¹© ì„ íƒ<br/>section_id=13-2-4"]
    
    U1 --> HC2[handleChat<br/>sectionId ìˆìŒ]
    HC2 -->|isFullView=false| GC2[graphClarify<br/>sub_section ì„ íƒ UI]
    GC2 -->|6ê°œ ë¶„ë¥˜ ì¹©| U2["ì‚¬ìš©ì: Ví˜• ì„ íƒ<br/>section_id=13-2-4:sub=1. ì „ê¸°ì•„í¬ìš©ì ‘(Ví˜•)"]

    U2 --> HC3[handleChat<br/>isSubSection=true]
    HC3 --> FVP[fullViewPipeline]
    FVP --> LC[chunk ë¡œë”©<br/>14ê±´ â†’ sub í•„í„°]
    FVP --> WT[WorkType ë¡œë”©<br/>130ê±´ â†’ 44ê±´Ví˜•]
    FVP --> EG[expandGraph Ã—44<br/>REQUIRES_LABOR ê´€ê³„]
    FVP --> BC[buildContext<br/>44 entities + relations]
    BC --> LLM["generateAnswer<br/>âš ï¸ í† í° í­ë°œ"]
    LLM -->|ì¶•ì†Œ/ì™œê³¡| FAIL["âŒ ì˜ë¦° ì¶œë ¥"]
    
    style FAIL fill:#ff4444,color:white
    style LLM fill:#ff8800,color:white
```

### 3.2 í•µì‹¬ í•¨ìˆ˜ë³„ ë¬¸ì œì 

#### â‘  `handleChat()` â€” [index.ts:1078-1252](file:///g:/My%20Drive/Antigravity/pjt/pumsem/supabase/functions/rag-chat/index.ts#L1078-L1252)

```
Route 2: section_id ìˆìœ¼ë©´ â†’
  isSubSectionì´ë©´ â†’ fullViewPipeline()  âœ… ì—¬ê¸°ê¹Œì§€ëŠ” ì •ìƒ
  ì•„ë‹ˆë©´ â†’ graphClarify() (Step 2 drill-down)
```

- **ë¬¸ì œ**: `sectionId="13-2-4"` ì§„ì… ì‹œ `isFullView=false` â†’ `graphClarify`ë¡œ ë¹ ì§ â†’ 6ê°œ sub_section ì¹© ì œì‹œ
- WT 130ê±´ì´ ìˆìœ¼ë¯€ë¡œ `searchPipeline` ê²½ë¡œì—ì„œë„ `childWorkTypes.length > 3` â†’ clarify ë¶„ê¸°

#### â‘¡ `fullViewPipeline()` â€” [index.ts:405-663](file:///g:/My%20Drive/Antigravity/pjt/pumsem/supabase/functions/rag-chat/index.ts#L405-L663)

sub_section ì„ íƒ í›„ ì§„ì…í•˜ëŠ” ë©”ì¸ ì‘ë‹µ ìƒì„± ê²½ë¡œ.

```
[1] chunk ë¡œë”©: 14ê±´ â†’ sub í•„í„° â†’ ê´€ë ¨ chunkë§Œ ë‚¨ê¹€
[2] chunk ë³‘í•©: text + tablesToMarkdown(tables) â†’ í•˜ë‚˜ë¡œ í•©ì¹¨
[3] WorkType ë¡œë”©: 130ê±´ â†’ sub_section í•„í„° â†’ 44ê±´(Ví˜•)
    â†’ expandGraph() Ã— 44 = REQUIRES_LABOR ê´€ê³„ ìˆ˜ë°± ê±´
[4] context ìƒì„±:
    - sub_section ëª¨ë“œ â†’ chunk.text ì œì™¸ (line 631)  â† âš ï¸ ì›ë¬¸ JSON í…Œì´ë¸”ë„ í•¨ê»˜ ì œì™¸ë¨
    - buildContext(44 entities, relations) â†’ ë§¤íŠ¸ë¦­ìŠ¤ í…Œì´ë¸” 44ê±´ ë Œë”ë§
[5] LLM í˜¸ì¶œ â†’ ì‘ë‹µ ìƒì„±
```

**í•µì‹¬ ë¬¸ì œ (line 627-642)**:
```typescript
if (fullSubSection) {
    // sub_section ëª¨ë“œ: chunk.text ì œì™¸ â†’ ê·¸ë˜í”„ ë°ì´í„°ë§Œ ì‚¬ìš©
    contextParts.push(`**ì„ íƒëœ ë¶„ë¥˜**: ${fullSubSection}`);
    // âš ï¸ ì—¬ê¸°ì„œ graph_chunks.tablesì˜ ì •ë°€ ë°ì´í„°ê°€ ì œì™¸ë¨!
    contextParts.push(buildContext(wtEntities, relationsAll, [], [], fullSubSection));
} else {
    contextParts.push(buildContext(wtEntities, relationsAll, [], [chunk as ChunkResult]));
}
```

#### â‘¢ `buildContext()` â€” [index.ts:152-300](file:///g:/My%20Drive/Antigravity/pjt/pumsem/supabase/functions/rag-chat/index.ts#L152-L300)

```
ê° entityë§ˆë‹¤:
  - properties í‘œì‹œ (spec, quantity ë“±) â†’ âš ï¸ ëª¨ë‘ null
  - ê´€ê³„ ê·¸ë£¹í™” (REQUIRES_LABOR, USES_MATERIAL ë“±)
  - renderMatrixTable()ë¡œ êµì°¨í‘œ ë Œë”ë§
```

**ë¬¸ì œ**: 44ê°œ entity Ã— ê° 3~8ê°œ ê´€ê³„ = ìˆ˜ë°± í–‰ì˜ Markdown â†’ LLM ì…ë ¥ í† í° í­ë°œ

#### â‘£ `renderMatrixTable()` â€” [index.ts:52-131](file:///g:/My%20Drive/Antigravity/pjt/pumsem/supabase/functions/rag-chat/index.ts#L52-L131)

```
itemsì—ì„œ (name, spec, quantity) ì¶”ì¶œ â†’ specë³„ êµì°¨í‘œ ìƒì„±
```

**ë¬¸ì œ**: 
- `item.related_name`ì—ì„œ specì„ ì¶”ì¶œí•˜ëŠ” ë¡œì§ì´ `_` ê¸°ë°˜ split â†’ ê°•íŒ ìš©ì ‘ ë°ì´í„°ì˜ ì´ë¦„ êµ¬ì¡°ì™€ ë¶ˆì¼ì¹˜
- ê²°ê³¼ì ìœ¼ë¡œ specì´ `-`ë¡œ í‘œì‹œë˜ì–´ êµì°¨í‘œê°€ ì•„ë‹Œ ë‹¨ìˆœ í”Œë« í…Œì´ë¸”ë¡œ í´ë°±

#### â‘¤ `tablesToMarkdown()` â€” [index.ts:133-150](file:///g:/My%20Drive/Antigravity/pjt/pumsem/supabase/functions/rag-chat/index.ts#L133-L150)

```
graph_chunks.tables JSON â†’ Markdown í…Œì´ë¸” ë³€í™˜
```

**í˜„í™©**: í•¨ìˆ˜ ìì²´ëŠ” ë™ì‘í•˜ì§€ë§Œ, sub_section ëª¨ë“œì—ì„œ `fullViewPipeline`ì´ chunk.textë¥¼ ì œì™¸í•˜ë¯€ë¡œ **í˜¸ì¶œ ìì²´ê°€ ì•ˆ ë¨**.

---

## 4. ê·¼ë³¸ ì›ì¸ ì¢…í•© (4ê°€ì§€)

### ğŸ”´ ì›ì¸ 1: entityì— ìˆ˜ì¹˜ ë°ì´í„° ë¶€ì¬

```
graph_entities.properties.quantity = null
graph_entities.properties.unit = null
```

WorkType entityê°€ `ê°•íŒ ì „ê¸°ì•„í¬ìš©ì ‘(10, SCH ì†Œìš”ì „ë ¥(kWh))` ì‹ìœ¼ë¡œ **ì´ë¦„ì— ì¸¡ì • í•­ëª©ì„ ì¸ì½”ë”©**í•˜ì—¬, ì‹¤ì œ ìˆ˜ëŸ‰ì€ entity propertiesê°€ ì•„ë‹Œ `graph_relationships.properties.quantity`ì—ë§Œ ì¡´ì¬. `buildContext`ê°€ entity propertiesë¥¼ í‘œì‹œí•  ë•Œ ë¹ˆ ê°’ë§Œ ë‚˜ì˜´.

### ğŸ”´ ì›ì¸ 2: 130ê±´ WorkType â†’ clarify ë¬´í•œ ë£¨í”„

`searchPipeline` line 787:
```typescript
if (childWorkTypes && childWorkTypes.length > 3) {
    // â†’ graphClarify() í˜¸ì¶œ = í•­ìƒ clarify ë¶„ê¸°
}
```

130ê±´ â†’ 6ê°œ sub_section ì„ íƒ â†’ 44ê±´(Ví˜•) â†’ fullViewPipelineì´ì§€ë§Œ, ì‚¬ìš©ìê°€ ì²˜ìŒë¶€í„° "Ví˜•"ì„ ëª¨ë¥´ë©´ ìµœì†Œ **2ë²ˆì˜ clarify** ë‹¨ê³„ë¥¼ ê±°ì³ì•¼ í•¨.

### ğŸ”´ ì›ì¸ 3: sub_section ëª¨ë“œì—ì„œ graph_chunks.tables ì œì™¸

`fullViewPipeline` line 627-631:
```typescript
if (fullSubSection) {
    // chunk.text ì œì™¸! (graph_chunks.tables í¬í•¨)
    // = ê°€ì¥ ì •í™•í•œ ì›ë³¸ ë°ì´í„°ê°€ LLM contextì—ì„œ ë¹ ì§
}
```

**Why this matters**: `graph_relationships`ì˜ quantityëŠ” ì¤‘ë³µÂ·ë¶ˆì¼ì¹˜ ê°€ëŠ¥ì„±ì´ ìˆì§€ë§Œ, `graph_chunks.tables` JSONì€ ì›ë³¸ ê·¸ëŒ€ë¡œì´ë¯€ë¡œ ê°€ì¥ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë°ì´í„°.

### ğŸ”´ ì›ì¸ 4: LLM í† í° ì´ˆê³¼ â†’ ì¶œë ¥ ì¶•ì†Œ/ì™œê³¡

44ê°œ entity Ã— ê° ê´€ê³„ ë°ì´í„° â†’ `buildContext` ì¶œë ¥ì´ ìˆ˜ì²œ ì¤„ì˜ Markdown â†’ Gemini/DeepSeekì˜ **ì¶œë ¥ í† í° í•œê³„(~4K~8K)** ì´ˆê³¼ â†’ í…Œì´ë¸”ì´ ì¤‘ê°„ì— ì˜ë¦¬ê±°ë‚˜, LLMì´ ìì²´ì ìœ¼ë¡œ "ìš”ì•½"í•˜ë©´ì„œ ìˆ˜ì¹˜ë¥¼ ë³€ê²½.

---

## 5. í•´ê²° ë°©ì•ˆ (ìˆ˜ì • ì‘ì—… ê°€ì´ë“œ)

### ì˜µì…˜ A: graph_chunks.tables ì§ì ‘ ë Œë”ë§ (â­ ì¶”ì²œ)

**ê°œìš”**: sub_section ì„ íƒ ì‹œ, `graph_chunks.tables` JSONì„ ì„œë²„ì—ì„œ ì§ì ‘ íŒŒì‹±í•˜ì—¬ Markdown êµì°¨í‘œë¡œ ë³€í™˜ â†’ LLMì—ëŠ” ì´ ì™„ì„±ëœ í…Œì´ë¸”ì„ "ê·¸ëŒ€ë¡œ ì¶œë ¥í•˜ë¼"ê³  ì „ë‹¬.

**ìˆ˜ì • ëŒ€ìƒ**:
- `fullViewPipeline()` in `index.ts` (line 405~663)

**ìˆ˜ì • ë‚´ìš©**:
```
1. sub_section ì§„ì… ì‹œ, allChunksì—ì„œ tables JSON ì¶”ì¶œ
2. tables JSONì„ tablesToMarkdown()ìœ¼ë¡œ ë³€í™˜ (ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í•¨ìˆ˜)
3. ë³€í™˜ëœ Markdown í…Œì´ë¸”ì„ contextPartsì— ì§ì ‘ ì‚½ì…
4. entity/relationship ê¸°ë°˜ buildContextëŠ” ë³´ì¡° ì •ë³´ë¡œë§Œ ì‚¬ìš©
5. LLMì—ê²Œ "ì•„ë˜ í…Œì´ë¸”ì„ ê·¸ëŒ€ë¡œ ì¶œë ¥í•˜ë¼" í”„ë¡¬í”„íŠ¸ ê°•í™”
```

**ì¥ì **: ì •í™•ë„ 100%, LLM í† í° ì ˆì•½, ê¸°ì¡´ `tablesToMarkdown()` í•¨ìˆ˜ ì¬í™œìš©
**ë‹¨ì **: sub_sectionë³„ í…Œì´ë¸” í•„í„° ë¡œì§ ì¶”ê°€ í•„ìš”

---

### ì˜µì…˜ B: entity ê·¸ë£¹í•‘ + ë§¤íŠ¸ë¦­ìŠ¤ ì¶•ì†Œ

**ê°œìš”**: 44ê°œ entityë¥¼ ë‘ê»˜ë³„ë¡œ ê·¸ë£¹í•‘ â†’ ë‘ê»˜ Ã— ìì„¸ êµì°¨í‘œ 1ê°œë¡œ í†µí•© â†’ context í¬ê¸° ëŒ€í­ ê°ì†Œ.

**ìˆ˜ì • ëŒ€ìƒ**:
- `buildContext()` in `index.ts`
- `renderMatrixTable()` in `index.ts`

**ì¥ì **: ê¸°ì¡´ ì½”ë“œ êµ¬ì¡° ìœ ì§€
**ë‹¨ì **: entity name íŒŒì‹± ë¡œì§ì´ ë³µì¡í•˜ê³  ì·¨ì•½

---

### ì˜µì…˜ C: complex_table_specs í™•ì¥

**ê°œìš”**: í˜„ì¬ ë°°ê´€(13-1-1)ë§Œ ì§€ì›í•˜ëŠ” `complex_table_specs` DBì— ê°•íŒ ìš©ì ‘(13-2-4) ë°ì´í„°ë¥¼ ì ì¬ â†’ `complexTablePipeline`ìœ¼ë¡œ ì²˜ë¦¬.

**ìˆ˜ì • ëŒ€ìƒ**:
- `complex_table_specs` DB í…Œì´ë¸”
- `COMPLEX_TABLE_TRIGGERS` config in `index.ts`
- `detectComplexTable()` in `index.ts`

**ì¥ì **: `complexTablePipeline` ê²€ì¦ ì™„ë£Œ, ë…¸ì„ë‹¨ê°€ ê³„ì‚° í¬í•¨
**ë‹¨ì **: ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”(graph_chunks.tables â†’ complex_table_specs)

---

## 6. ë°ì´í„° ì •í•©ì„± ìš”ì•½

| ì €ì¥ì†Œ | ë°ì´í„° ì¡´ì¬ | ì •í™•ë„ | í˜„ì¬ í™œìš© ì—¬ë¶€ | ë¹„ê³  |
|---|:---:|:---:|:---:|---|
| `graph_chunks.tables` (JSON) | âœ… 15ê°œ í…Œì´ë¸” | âœ… ì›ë³¸ ê·¸ëŒ€ë¡œ | âŒ sub_sectionì—ì„œ ì œì™¸ | **ê°€ì¥ ì‹ ë¢°** |
| `graph_relationships` (properties) | âœ… ìˆ˜ë°± ê±´ | âš ï¸ ì¤‘ë³µ ì¡´ì¬ | âš ï¸ ê°„ì ‘ í™œìš© | ì¤‘ë³µ ë ˆì½”ë“œ ë¬¸ì œ |
| `graph_entities` (properties) | âŒ null | â€” | âŒ | quantity/unit ë¯¸ì €ì¥ |
| `complex_table_specs` | âŒ 13-1-1ë§Œ | â€” | âŒ | ê°•íŒ ìš©ì ‘ ë¯¸ì§€ì› |

---

## 7. ê´€ë ¨ ì½”ë“œ íŒŒì¼

| íŒŒì¼ | ì—­í•  | í•µì‹¬ í•¨ìˆ˜ |
|---|---|---|
| [index.ts](file:///g:/My%20Drive/Antigravity/pjt/pumsem/supabase/functions/rag-chat/index.ts) | ë©”ì¸ íŒŒì´í”„ë¼ì¸ | `handleChat`, `fullViewPipeline`, `searchPipeline`, `buildContext`, `renderMatrixTable`, `tablesToMarkdown` |
| [clarify.ts](file:///g:/My%20Drive/Antigravity/pjt/pumsem/supabase/functions/rag-chat/clarify.ts) | ì˜ë„ ë¶„ì„ + ëª…í™•í™” | `analyzeIntent`, `graphClarify` |
| [resolve.ts](file:///g:/My%20Drive/Antigravity/pjt/pumsem/supabase/functions/rag-chat/resolve.ts) | ê³„ì¸µ íƒìƒ‰ + UI ìƒì„± | `resolveSection`, `presentClarify`, `buildSelectorPanel` |
