# 2026-02-20 파이프라인 잔여과제 해결방안 (실행안)

## 1) 분석 대상
- 원문 보고서: `20260220_파이프라인_현황분석_및_잔여과제.md`
- 교차검증 코드/데이터:
  - `rag/pipeline/phase1_output/chunks.json`
  - `rag/pipeline/phase2_extraction/step2_llm_extractor.py`
  - `rag/pipeline/phase2_extraction/config.py`
  - `rag/pipeline/phase2_extraction/step5_extraction_validator.py`

## 2) 사실 검증 결과
- 총 청크: 2,105
- 빈 텍스트: 908 (43.1%)
- 텍스트 존재: 1,197 (56.9%)
- 빈 텍스트 중 서브청크: 903
- 빈 텍스트 중 기본청크: 5
- 형제 텍스트 복원 가능: 899 (99.0%)
- 형제 텍스트 없는 고립 청크: 9
  - `C-0172, C-0578-A, C-0578-B, C-0623-A, C-0623-B, C-0759, C-0923, C-1124, C-1149`
- `max_tokens=8192` 적용 확인:
  - `rag/pipeline/phase2_extraction/step2_llm_extractor.py:290`

## 3) 잔여과제(미완료)
1. P0 미구현
- `build_user_prompt()`가 빈 텍스트 청크에 형제 컨텍스트를 주입하지 않음.
- 위치: `rag/pipeline/phase2_extraction/step2_llm_extractor.py:202`

2. 호출부 시그니처 미연결
- `extract_single_chunk()`는 `chunk, semaphore`만 받음.
- 위치: `rag/pipeline/phase2_extraction/step2_llm_extractor.py:266`
- 태스크 생성부도 `all_chunks` 미전달.
- 위치: `rag/pipeline/phase2_extraction/step2_llm_extractor.py:578`

3. 후처리 교차검증기(P1.5) 부재
- 보고서에서 제안한 `validate_outputs.py`가 코드베이스에 없음.

4. 품질 임계값 불일치
- 설정 임계값: E4=0.05, E6=0.02
  - `rag/pipeline/phase2_extraction/config.py:97`
- 실제 검증기 임계값: E4=0.30, E6=0.20 (하드코딩)
  - `rag/pipeline/phase2_extraction/step5_extraction_validator.py:292`
  - `rag/pipeline/phase2_extraction/step5_extraction_validator.py:465`

## 4) 해결방안 (우선순위)

### P0 (즉시, 약 2시간)
- 목표: 빈 텍스트 청크의 맥락 복원
- 변경:
  1. `build_user_prompt(chunk: dict, all_chunks: list[dict]) -> str`로 변경
  2. `text`가 비어 있으면 같은 base_id(`C-xxxx`) 형제 중 텍스트 있는 청크를 찾아 `관련 컨텍스트` 섹션 주입
  3. 주입 컨텍스트는 참고용 문구와 함께 명시
  4. 형제도 비어있는 9개 청크는 `confidence <= 0.7` 강제

### P1 (약 3~4시간)
- 목표: DeepSeek 단일 경로로 전수 재추출
- 조건:
  - `max_tokens=8192` 유지
  - `response_format={"type":"json_object"}` 유지
  - 샘플 20건 비교 후 전수 실행

### P1.5 (약 0.5일)
- 목표: 후처리 원본대조 검증기 도입
- 신규 파일: `rag/pipeline/phase2_extraction/validate_outputs.py`
- 핵심 로직:
  1. `tokenize()` 복합 구분자 분리 (`공백/밑줄/괄호/슬래시/하이픈`)
  2. `rows`는 `for key, value in row.items()`로 순회
  3. spec은 substring이 아닌 token set subset 검증
  4. qty는 정책(`strict` 기본)으로 검증
  5. 출력에 `is_verified`, `validation_warnings`, `dead_letter_queue` 생성

### 기준 일원화 (약 0.5~1시간)
- `step5_extraction_validator.py`가 `config.EXTRACTION_THRESHOLDS`를 import해서 사용하도록 수정
- 하드코딩된 0.30/0.20 제거

## 5) 완료 기준(DoD)
- 복원 가능 빈 청크 899건에 대해 컨텍스트 주입 적용 확인
- 고립 9건 저신뢰도 처리 확인
- 후처리 검증 후 `is_verified=true`만 적재 대상 분리
- E4/E6 판정이 `config.py` 기준과 일치

## 6) 권장 실행 순서
1. P0 구현
2. P1 재추출
3. P1.5 검증기 실행
4. 기준 일원화 및 재평가
5. 검증 통과 데이터만 DB 적재
