# Phase 3-C: Chunk 본문 키워드 검색 — 테스트 결과 보고서

> **작성일**: 2026-02-13 22:35  
> **배포 버전**: v45 (93.93kB)  
> **Project**: bfomacoarwtqzjfxszdr  

---

## 1. 문제 정의

### 1.1 원래 증상

"**장비 편성 관련 품셈**", "**인력 편성 관련 품셈**" 등 품셈서 본문(chunk text)에만 존재하는 소제목/용어로 검색 시, **무관한 Section**만 반환되고 실제 관련 WorkType을 찾지 못함.

### 1.2 첨부 이미지 분석 — 수정 전(Before) 동작

첨부된 4장의 이미지는 **"장비 해체"** 검색 플로우를 보여주며, 기존 시스템의 동작 패턴을 그대로 드러냄.

#### 📸 이미지 1: "장비 해체" 검색 결과

| 항목            | 값                        |
| --------------- | ------------------------- |
| **질의**        | "장비 해체"               |
| **응답 타입**   | `clarify` (5개 분야 선택) |
| **응답 시간**   | 5.1초                     |
| **반환된 옵션** | Section 5개 (아래 표)     |

| #   | 옵션 (Section)  | 부문 > 장 > 절                                         |
| --- | --------------- | ------------------------------------------------------ |
| 1   | 공통장비        | 공통부문 > 제2장 가설공사 > 공통장비                   |
| 2   | 부수장비        | 기계설비부문 > 제8장 공기조화설비공사 > 부수장비       |
| 3   | 스마트 건설장비 | 공통부문 > 제8장 건설기계 > [80]스마트 건설장비        |
| 4   | 스마트 건설장비 | 공통부문 > 제8장 건설기계 > [80]스마트 건설장비 (중복) |
| 5   | 해상장비        | 공통부문 > 제8장 건설기계 > [90]해상장비               |

**분석:**
- 기존 `graphClarify`가 `"장비"`라는 키워드로 `graph_entities.name` ILIKE 검색 → **이름에 "장비"가 포함된 Section** 5개를 반환
- "장비 해체"라는 의도와 직접 부합하는 결과(예: 장비 조립·해체)가 아니라, "장비"가 이름에 들어간 **모든 Section**을 나열
- 4번 옵션이 3번과 중복 표시되는 부수적 이슈도 존재
- 하단 메시지: *"장비 해체는 공종명이 넓은 범위로, 구체적인 장비 종류(예: 크레인, 펌프, 기계)나 규격이 지정되지 않아 세분화가 필요합니다"* → DeepSeek의 `ambiguity_reason`

#### 📸 이미지 2: "공통장비 품셈" 선택 (Drill-down Step 2)

| 항목            | 값                                           |
| --------------- | -------------------------------------------- |
| **질의**        | "공통장비 품셈" (사용자가 이미지 1에서 선택) |
| **응답 타입**   | `clarify` (하위 작업 선택)                   |
| **응답 시간**   | 0.5초 (캐시된 결과 또는 단순 DB 조회)        |
| **반환된 옵션** | 1 full_view + 6 worktype                     |

| #   | 옵션 타입   | 작업명                    |
| --- | ----------- | ------------------------- |
| 📋   | `full_view` | 공통장비 전체 내용 보기   |
| 1   | `worktype`  | 건설용리프트 설치 및 해체 |
| 2   | `worktype`  | 경사이동                  |
| 3   | `worktype`  | 마스트 설치 및 해체       |
| 4   | `worktype`  | 수직이동                  |
| 5   | `worktype`  | 수평이동                  |
| 6   | `worktype`  | 파이프 루프공             |

**분석:**
- `graphClarify` Step 2가 정상 작동: `sectionId=2-12`(공통장비)의 하위 WorkType 6개 + 전체보기 옵션
- **기존 시스템의 drill-down은 제대로 작동**하고 있음
- 문제는 **Step 1에서 올바른 Section에 도달하지 못하는 것**

#### 📸 이미지 3: "공통장비 전체 품셈" 응답 (상세 데이터)

| 항목              | 값                                    |
| ----------------- | ------------------------------------- |
| **응답 타입**     | `answer` (전체 품셈 데이터 표시)      |
| **응답 시간**     | 0.5초                                 |
| **표시된 테이블** | [표 2-12-1] 건설용리프트 설치 및 해체 |

**상세 데이터:**

```
[표 2-12-1] 건설용리프트 설치 및 해체
규격: 싱글 1.2ton (대당)

투입 인력:
| 직종       | 수량 | 단위 |
| ---------- | ---- | ---- |
| 기계설비공 | 1.31 | 인   |
| 비계공     | 2.04 | 인   |
| 보통인부   | 0.87 | 인   |

투입 장비:
| 장비명 | 수량 | 단위 |
| ------ | ---- | ---- |
| 지게차 | 1.95 | hr   |

주의사항:
- 이 품셈은 '2-9-2 건설용리프트 방호선반 설치 및 해체'를 따릅니다.
- 지게차 진입이 불가능한 경우 크레인 등으로 장비를 변경할 수 있습니다.
- 공구손료 및 경장비(윈치 등)의 기계경비는 인력품의 3%로 계상합니다.
```

**분석:**
- LLM 답변 생성(Phase 2)이 정상 작동: 구조화된 테이블 형태로 품셈 데이터 출력
- 인력, 장비, 주의사항이 모두 포함된 완성도 높은 응답

#### 📸 이미지 4: 추가 품셈 데이터 (마스트, 파이프 루프공)

| 항목            | 데이터                                      |
| --------------- | ------------------------------------------- |
| **[표 2-12-2]** | 마스트 설치 및 해체 (층당)                  |
| **[표 2-12-4]** | 파이프 루프공 — 장비 조립해체/기계이동 설치 |

**마스트 설치 및 해체 인력:**

| 직종     | 수량  | 단위 |
| -------- | ----- | ---- |
| 비계공   | 0.8   | 인   |
| 보통인부 | 0.27  | 인   |
| 특별인부 | 0.051 | 인   |

**파이프 루프공 — 장비 조립해체/기계이동 투입 장비:**

| 작업 구분 | 지반 조건/규격 | 장비명 | 수량 | 단위 |
| --------- | -------------- | ------ | ---- | ---- |
| 수평이동  | 점토·실트      | 크레인 | 90   | 분   |
| 경사이동  | 점토·실트      | 크레인 | 150  | 분   |
| —         | —              | 잭     | 240  | 분   |

**분석:**
- 원문 청크 데이터(graph_chunks)에서 테이블 구조가 잘 보존되어 LLM이 정확히 포맷팅
- 주의사항: *"층별 할증 및 적용 범위에 대한 주의사항이 있습니다"* → 원문 참조 유도

---

## 2. 근본 원인 분석

### 2.1 3단계 원인 체인

```
[원인 1] 데이터 구조적 공백
  "장비편성", "인력편성" 등은 graph_entities에 독립 엔티티로 등록되어 있지 않음.
  → 품셈서 원문의 소제목(sub-heading)으로만 chunk text에 존재.
                ↓
[원인 2] 검색 파이프라인의 구조적 한계
  기존 검색은 graph_entities.name에 대한 ILIKE/벡터 검색만 수행.
  → chunk text(graph_chunks.text) 본문 검색 레이어가 부재.
                ↓
[원인 3] graphClarify의 분기 우선순위 문제
  전략 3(키워드 독립 검색)에서 "장비" ILIKE → Section 5개 매칭.
  복수 섹션 분기(uniqueSectionIds.length > 1)가 최우선으로 실행.
  → chunk text 결과(WorkType)가 있어도 복수 섹션 분기에서 먼저 return.
```

### 2.2 의도 분석 결과 (DeepSeek)

"장비 편성 관련 품셈" 질의에 대해 DeepSeek v3.2가 반환한 `IntentAnalysis`:

```json
{
  "intent": "clarify_needed",
  "work_name": null,
  "spec": null,
  "keywords": ["장비", "편성"]
}
```

- `work_name = null` → searchTerms가 keywords만으로 구성: `["장비", "편성"]`
- `intent = clarify_needed` → `graphClarify` 경로 진입 (targetSearch 미실행)

---

## 3. 수정 내용

### 3.1 신규 함수: `chunkTextFallbackSearch`

| 항목          | 상세                                                                                   |
| ------------- | -------------------------------------------------------------------------------------- |
| **위치**      | `index.ts` L293~387                                                                    |
| **역할**      | chunk 본문(graph_chunks.text)에서 복합어 키워드 ILIKE 검색 → 매칭 섹션의 WorkType 반환 |
| **실행 조건** | 한글 키워드 2개 이상 (단일 키워드 → skip)                                              |
| **검색 패턴** | 복합어 우선 (`%장비편성%`) → 키워드 조합 (`%장비%편성%`)                               |
| **stopWords** | 경량 목록 (품셈, 알려줘, 얼마 등). **"장비", "인력"은 보존**                           |

### 3.2 `graphClarify` 전략 4 추가

| 항목          | 상세                                                                                            |
| ------------- | ----------------------------------------------------------------------------------------------- |
| **위치**      | `index.ts` L1195~1242                                                                           |
| **실행 조건** | keywords에서 생성된 **복합어**(예: `"장비편성"`)가 전략 1~3 결과의 엔티티 이름에 없을 때만 실행 |
| **안전장치**  | compoundTerms가 기존 결과에 매칭되면 실행 안 함 → 기존 정상 쿼리에 영향 없음                    |

### 3.3 Phase 3-C 분기 추가

| 항목     | 상세                                                                                                                      |
| -------- | ------------------------------------------------------------------------------------------------------------------------- |
| **위치** | `index.ts` L1343~1363 (케이스 분기 최상단)                                                                                |
| **역할** | `chunkTextResults`에 WorkType이 존재하면 → **복수 섹션 분기보다 우선** 반환                                               |
| **이유** | chunk text에서 찾은 WorkType이 "장비편성"과 직접 연관된 정확한 결과이므로, 이름에 "장비"가 포함된 무관한 Section보다 우선 |

### 3.4 `targetSearch` Layer 4 추가

| 항목          | 상세                                                            |
| ------------- | --------------------------------------------------------------- |
| **위치**      | `index.ts` L1504~1522                                           |
| **실행 조건** | 벡터 검색 결과에 `WorkType + similarity ≥ 0.7` 엔티티가 없을 때 |
| **역할**      | `intent=search` 경로에서도 chunk text fallback 실행 가능        |

### 3.5 수정 흐름도

```
질의: "장비 편성 관련 품셈"
  │
  ├─ DeepSeek 의도 분석
  │    intent=clarify_needed, keywords=["장비","편성"]
  │
  ├─ graphClarify 진입
  │    │
  │    ├─ 전략 1: Section ILIKE "%장비%" → 5개 Section (노이즈)
  │    ├─ 전략 2: WorkType ILIKE "%장비%편성%" → 0건
  │    ├─ 전략 3: 키워드별 독립 검색 → "장비" WorkType ~36건
  │    │
  │    ├─ 전략 4 (NEW): 복합어 "장비편성" 체크
  │    │    compoundMatchFound = false (기존 결과에 "장비편성" 없음)
  │    │    → chunkTextFallbackSearch("장비 편성") 실행
  │    │    → graph_chunks.text ILIKE "%장비편성%" → 4개 섹션 매칭
  │    │    → 해당 섹션의 WorkType 15건 반환 ✅
  │    │
  │    ├─ Phase 3-C 분기 (NEW): chunkWorkTypes.length > 0
  │    │    → 복수 섹션 분기보다 우선 → WorkType 옵션 직접 표시 ✅
  │    │
  │    └─ (기존 복수 섹션 분기: 실행 안 됨)
```

---

## 4. 테스트 결과

### 4.1 핵심 테스트 (Phase 3-C 대상)

| #   | 질의                  | Before                                | After                                            | 판정          |
| --- | --------------------- | ------------------------------------- | ------------------------------------------------ | ------------- |
| T1  | "장비 편성 관련 품셈" | ❌ Section 5개 (공통장비, 해상장비 등) | ✅ WorkType 10건 (고압분사, 기성말뚝 등 기초공사) | **수정 성공** |
| T2  | "인력 편성 관련 품셈" | ❌ (동일 패턴)                         | ✅ WorkType 10건 (기성말뚝, 현장타설말뚝 등)      | **수정 성공** |

### 4.2 T1 상세 결과 ("장비 편성 관련 품셈")

```
type=clarify | latency=5575ms
answer: "장비 편성" 관련 품셈 항목입니다. 어떤 작업의 품셈을 찾으시나요?

options (10):
  1. [worktype] [공통] R.C.D                              | section=5-3-5
  2. [worktype] [공통] R.C.D(Reverse Circulation Drill)    | section=5-3-5
  3. [worktype] [공통] 고압분사 주입공법                    | section=5-2-2
  4. [worktype] [공통] 고압분사 주입공법(외부 반출/반입)     | section=5-2-2
  5. [worktype] [공통] 고압분사 주입공법(작업구간 이동)      | section=5-2-2
  6. [worktype] [공통] 그라우팅(400~600mm, 10m미만)         | section=5-3-1
  7. [worktype] [공통] 그라우팅(400~600mm, 10~20m미만)      | section=5-3-1
  8. [worktype] [공통] 그라우팅(400~600mm, 20~30m미만)      | section=5-3-1
  9. [worktype] [공통] 그라우팅(700~800mm, 10m미만)         | section=5-3-1
 10. [worktype] [공통] 그라우팅(700~800mm, 10~20m미만)      | section=5-3-1
```

### 4.3 데이터 검증 — chunk text에 "장비편성" 실제 존재 확인

SQL 쿼리로 반환된 섹션의 chunk text에 "장비편성"이 실제로 포함되어 있는지 검증:

| section_id | 절 이름           | "장비편성" 포함 | "인력편성" 포함 | 원문 컨텍스트                                 |
| ---------- | ----------------- | --------------- | --------------- | --------------------------------------------- |
| **5-2-2**  | 고압분사 주입공법 | ✅               | ❌               | `4. 장비편성 ② 기종의 선정은 다음을 기준한다` |
| **5-3-1**  | 기성말뚝 기초     | ✅               | ✅               | `3. 인력편성(인/일) 4. 장비편성`              |
| **5-3-2**  | 말뚝박기용 천공   | ✅               | ❌               | `4. 장비편성 - 시공조건(말뚝이음 유무...)`    |
| **5-3-5**  | 현장타설말뚝      | ✅               | ✅               | `나. 장비편성 다. 작업소요시간(본당)`         |

→ **모든 반환 결과가 실제 "장비편성" 소제목을 포함하는 섹션의 WorkType**임을 검증 완료.

### 4.4 진단 데이터 (`_debug` 필드)

```json
{
  "work_name": null,
  "keywords": ["장비", "편성"],
  "searchTerms": ["장비", "편성"],
  "kwTokens": ["장비", "편성"],
  "compoundTerms": ["장비편성"],
  "compoundMatchFound": false,
  "layer4_triggered": true,
  "layer4_resultCount": 15,
  "layer4_results": [
    "R.C.D[5-3-5]", "고압분사 주입공법[5-2-2]",
    "기성말뚝 기초[5-3-1]", "말뚝박기용 천공[5-3-2]", ...
  ],
  "prelimResultCount": 46,
  "sectionsCount": 5,
  "extraWTCount": 36
}
```

**해석:**
- 기존 전략 1~3 결과: Section 5개 + WorkType 36개 (이름에 "장비" 포함) = **노이즈**
- 전략 4 (chunk text): 복합어 `"장비편성"` 미매칭 → fallback 실행 → **정확한 15건**
- Phase 3-C 분기: chunk WorkType 15건 존재 → 복수 섹션 분기를 건너뛰고 **WorkType 직접 표시**

### 4.5 회귀 테스트 (기존 정상 쿼리)

| #   | 질의                         | 기대                  | 실제                           | 판정     |
| --- | ---------------------------- | --------------------- | ------------------------------ | -------- |
| R1  | "강관용접 200mm SCH 40 품셈" | `answer`              | ✅ `answer`, len=897, sources=5 | **Pass** |
| R2  | "잡철물 제작 품셈"           | `clarify` (복수 분야) | ✅ `clarify`, options=12        | **Pass** |
| R3  | "콘크리트 타설 품셈"         | `clarify`             | ✅ `clarify`, options=12        | **Pass** |

---

## 5. 첨부 이미지 데이터와의 비교 분석

### 5.1 "장비 해체" vs "장비 편성" — 동일 패턴, 동일 문제

첨부 이미지의 "장비 해체" 검색과 Phase 3-C 대상인 "장비 편성" 검색은 **동일한 구조적 문제 패턴**을 공유:

| 비교 항목       | "장비 해체" (이미지)                                   | "장비 편성" (수정 전)                                  |
| --------------- | ------------------------------------------------------ | ------------------------------------------------------ |
| **입력 키워드** | ["장비", "해체"]                                       | ["장비", "편성"]                                       |
| **전략 1 결과** | Section: 공통장비, 부수장비, 스마트 건설장비, 해상장비 | Section: 공통장비, 부수장비, 스마트 건설장비, 해상장비 |
| **문제 원인**   | "장비" → 이름에 포함된 Section만 매칭                  | "장비" → 이름에 포함된 Section만 매칭                  |
| **실제 의도**   | 장비 조립·해체 품셈                                    | 장비편성 관련 기초공사 품셈                            |
| **적합한 결과** | 건설용리프트 해체, 마스트 해체 등                      | 고압분사 주입공법, 기성말뚝 기초 등                    |

### 5.2 "장비 해체"도 수정이 필요한가?

"장비 해체"의 경우:
- **"해체"는 `ACTION_VERBS`에 등록된 범용 동사**이므로 전략 3에서 독립 검색이 제외됨
- 하지만 **"장비해체"라는 복합어는 chunk text에 존재할 가능성**이 있음
- 현재 Phase 3-C 수정은 `chunkTextFallbackSearch`를 통해 "장비해체" 복합어도 검색 가능

→ **"장비 해체"도 동일한 수정 효과를 받을 수 있음.** 다만 DeepSeek이 `searchTerms = ["장비", "해체"]`를 반환하고, `kwTokens`에서 "해체"가 포함될 경우 복합어 `"장비해체"`가 생성되어 chunk text 검색이 실행됨.

### 5.3 이미지 3~4의 데이터 품질 평가

이미지 3~4는 "공통장비 전체 품셈"에 대한 **최종 answer 응답**:

| 평가 항목          | 점수  | 설명                                                                |
| ------------------ | ----- | ------------------------------------------------------------------- |
| **데이터 정확도**  | ★★★★★ | 인력 수량(기계설비공 1.31인, 비계공 2.04인 등)이 원문과 일치        |
| **테이블 포맷**    | ★★★★★ | 투입 인력/장비 테이블이 깔끔하게 구조화                             |
| **주의사항 포함**  | ★★★★☆ | 3개 주의사항이 포함되었으나, 원문 전체 주의사항 대비 일부 누락 가능 |
| **다중 표 처리**   | ★★★★★ | [표 2-12-1], [표 2-12-2], [표 2-12-4]를 연속으로 처리               |
| **장비 시간 단위** | ★★★★★ | 분 단위(90분, 150분, 240분)가 정확히 표시                           |

---

## 6. 잔여 이슈 및 후속 작업

### 6.1 `_debug` 필드 제거

현재 응답에 `_debug` 필드가 임시로 포함되어 있음. 프로덕션 안정화 후 제거 필요.

- `ClarifyResult` 인터페이스에서 `_debug` 제거
- `handleChat` clarify_needed 분기에서 `_debug` 제거
- `graphClarify` 케이스 A/B/C/복수섹션 분기에서 `_debug: debugInfo` 제거

### 6.2 "장비 해체" 추가 테스트

첨부 이미지의 "장비 해체" 쿼리에 대해 Phase 3-C 수정 후 결과가 개선되는지 확인 필요.

### 6.3 중복 옵션 이슈

이미지 1에서 `[80]스마트 건설장비`가 2번 표시되는 중복 이슈 → `graphClarify`의 `uniqueResults` 중복 제거 로직 보강 필요.

### 6.4 반환 항목과 질의의 연관성 표시

반환된 WorkType(예: "고압분사 주입공법")의 이름에 "장비편성"이 직접 포함되지 않으므로, 사용자가 연관성을 파악하기 어려울 수 있음. 향후 개선:
- 옵션 label에 `(장비편성 포함)` 같은 태그 추가 검토
- 또는 응답 메시지에 `"이 품셈들은 '장비편성' 관련 내용을 포함하고 있습니다"` 추가

---

## 7. 최종 판정

| 항목              | 판정                                                                        |
| ----------------- | --------------------------------------------------------------------------- |
| **핵심 기능**     | ✅ **정상 동작** — chunk 본문 키워드 검색이 정확한 WorkType 반환             |
| **회귀 안정성**   | ✅ **Pass** — 기존 3개 테스트 케이스 모두 정상                               |
| **안전장치**      | ✅ **유효** — 복합어 미매칭 조건 + 단일키워드 가드 작동 확인                 |
| **데이터 정확도** | ✅ **검증 완료** — SQL로 4개 섹션의 chunk text에 "장비편성" 존재 확인        |
| **성능**          | ⚠️ **모니터링 필요** — 전략 4 추가로 latency 소폭 증가 가능 (현재 5.5~6.9초) |
| **프로덕션 준비** | ⚠️ **`_debug` 필드 제거 후** 프로덕션 배포 가능                              |
