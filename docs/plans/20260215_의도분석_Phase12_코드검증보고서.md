# Phase 1+2 코드 검증 보고서

> 검증일: 2026-02-15  
> 검증 방법: 정적 코드 분석 + 논리 흐름 시뮬레이션  
> 검증 범위: `types.ts`, `index.ts`, `index.html` 변경 사항 전체

---

## 1. 검증 방법론

### 1-1. 검증 전략

배포 전 단계이므로 **정적 분석(Static Analysis)** 기반으로 검증 수행.

| 검증 영역       | 방법                                  | 도구                    |
| --------------- | ------------------------------------- | ----------------------- |
| 문법 오류       | TypeScript 컴파일 에러 확인           | IDE lint feedback       |
| 타입 정합성     | 인터페이스 간 필드 일치 여부          | 파일 간 cross-reference |
| 논리 흐름       | 사용자 시나리오별 코드 경로 추적      | 수동 flow tracing       |
| 프롬프트 일관성 | 출력 형식 ↔ Few-shot ↔ 파싱 로직 정합 | 텍스트 비교             |
| 방어 코드       | 에러/엣지케이스 처리 누락 여부        | 분기 분석               |

### 1-2. 검증 대상 파일

```
edge-function/types.ts   — SessionContext, IntentAnalysis 확장, SourceInfo.entity_id
edge-function/index.ts   — INTENT_SYSTEM_PROMPT, analyzeIntent, handleChat, ruleBasedIntent
frontend/index.html      — sessionContext 전역 상태 + 자동 갱신
```

---

## 2. 검증 항목별 결과

### 2-1. 타입 정의 정합성 검증

**검증 내용**: `types.ts`와 `index.ts`에 중복 정의된 인터페이스 간 동기화 확인

| 인터페이스                    | types.ts | index.ts | 일치 |
| ----------------------------- | -------- | -------- | ---- |
| `ChatRequest.session_context` | ✅ 추가됨 | ✅ 추가됨 | ✅    |
| `SessionContext` (5필드)      | ✅ 정의됨 | ✅ 정의됨 | ✅    |
| `IntentAnalysis.intent` (8개) | ✅ 확장됨 | ✅ 확장됨 | ✅    |
| `IntentAnalysis.modify_type`  | ✅ 추가됨 | ✅ 추가됨 | ✅    |
| `IntentAnalysis.quantity`     | ✅ 추가됨 | ✅ 추가됨 | ✅    |
| `SourceInfo.entity_id`        | ✅ 추가됨 | ✅ 추가됨 | ✅    |

> **발견된 문제**: 없음. 모든 중복 인터페이스가 동기화됨.

---

### 2-2. INTENT_SYSTEM_PROMPT 일관성 검증

**검증 내용**: 프롬프트의 출력 형식 ↔ 분류 기준 ↔ Few-shot 간 정합성

#### 초기 검증 시 발견 (C1: Critical)

```
## 출력 형식 (수정 전)
{
  "intent": "search | clarify_needed | followup | greeting | quantity_input",  ← 새 intent 3개 누락!
  ...
  "ambiguity_reason": "..."
  ← modify_type, quantity 필드 없음!
}
```

**문제**: 분류 기준과 Few-shot에는 `cost_calculate`, `modify_request`, `report_request`와 `modify_type`, `quantity`가 있지만, 출력 형식에는 누락. LLM이 Few-shot을 보고 출력할 수는 있지만, 형식 정의와 불일치하면 **출력을 생략할 확률**이 높음.

**수정 후:**

```
## 출력 형식 (수정 후)
{
  "intent": "search | clarify_needed | ... | cost_calculate | modify_request | report_request",
  ...
  "modify_type": "quantity | work_change | exclude_labor 또는 null",
  "quantity": "수량 숫자 또는 null"
}
```

#### Few-shot 예시 ↔ 분류 기준 매핑 검증

| Few-shot 입력           | 기대 intent    | 분류 기준에 정의? | 일치 |
| ----------------------- | -------------- | ----------------- | ---- |
| "TIG용접 품셈"          | clarify_needed | ✅                 | ✅    |
| "강관용접 200mm SCH 40" | search         | ✅                 | ✅    |
| "노무비 계산해줘"       | cost_calculate | ✅                 | ✅    |
| "50m로 바꿔서 다시"     | modify_request | ✅                 | ✅    |
| "그거 말고 TIG로 해줘"  | modify_request | ✅                 | ✅    |
| "산출서 만들어줘"       | report_request | ✅                 | ✅    |

---

### 2-3. analyzeIntent 함수 흐름 검증

**검증 내용**: sessionContext 주입 + 파싱 + 안전성 가드 동작 확인

#### 시나리오 A: sessionContext 있을 때

```
입력: question="노무비 계산해줘"
      sessionContext={ last_entity_id: "W-0788", last_work_name: "강관용접(200, SCH 40)" }

코드 경로:
1. L1093: sessionContext?.last_entity_id = "W-0788" → truthy
2. L1094-1099: systemContent에 ## 현재 세션 상태 블록 부착
3. L1102-1123: DeepSeek API 호출 (systemContent 사용)
4. L1132: 응답 파싱 → { intent: "cost_calculate", ... }
5. L1135: validIntents 포함 확인 → ✅ "cost_calculate" 유효
6. 반환: { intent: "cost_calculate" }
```

#### 시나리오 B: sessionContext null일 때

```
입력: question="노무비 계산해줘", sessionContext=undefined

코드 경로:
1. L1093: sessionContext?.last_entity_id = undefined → falsy
2. systemContent = INTENT_SYSTEM_PROMPT (변경 없음)
3. DeepSeek API 호출 → { intent: "cost_calculate" }
4. 반환: { intent: "cost_calculate" }
```

#### 시나리오 C: DeepSeek 장애 시

```
코드 경로:
1. L1125-1127: response.ok = false → ruleBasedIntent(question) 폴백
2. ruleBasedIntent: /노무비/ 패턴 매칭 → { intent: "cost_calculate" }
```

> **발견된 문제**: ruleBasedIntent에 새 intent 패턴이 없었음 → I3으로 수정 완료.

---

### 2-4. handleChat 분기 로직 검증

**검증 내용**: 새 intent 3개의 실행 경로 + 엣지케이스

#### cost_calculate 분기 시뮬레이션

| 조건      | sessionContext.last_entity_id | 동작                                             | 검증 |
| --------- | ----------------------------- | ------------------------------------------------ | ---- |
| 세션 없음 | null                          | "먼저 품셈을 검색해 주세요" 안내                 | ✅    |
| 세션 있음 | "W-0788"                      | `handleChat(q, h, "W-0788", undefined, sc)` 재귀 | ✅    |

재귀 호출 안전성:
```
handleChat(..., entityId="W-0788") 
  → Phase -1 진입 (L2096: if (entityId))
  → entity 직접 조회 → 응답 반환
  → 재귀 깊이 = 1 (무한루프 없음) ✅
```

#### modify_request 분기 시뮬레이션

| modify_type     | sessionContext 존재 | work_name | 동작                                | 검증        |
| --------------- | ------------------- | --------- | ----------------------------------- | ----------- |
| "quantity"      | ✅                   | N/A       | 이전 entity로 재귀 조회             | ✅           |
| "work_change"   | ✅                   | "TIG용접" | intent→search 전환 → 아래 분기 처리 | ✅           |
| "exclude_labor" | ✅                   | N/A       | "아직 준비 중" 안내                 | ✅ (수정 후) |
| null            | ✅                   | null      | "아직 준비 중" 안내                 | ✅ (수정 후) |
| null            | ❌                   | null      | "이전 결과 없음" 안내               | ✅           |

> **초기 발견 (M2)**: `exclude_labor`과 `modify_type=null` 시 fallthrough 발생 → 수정 완료.

#### report_request 분기 시뮬레이션

| 조건      | sessionContext.last_entity_id | 동작                             | 검증 |
| --------- | ----------------------------- | -------------------------------- | ---- |
| 세션 없음 | null                          | "먼저 품셈을 검색해 주세요" 안내 | ✅    |
| 세션 있음 | "W-0788"                      | 재귀 호출 → Phase -1 → 응답      | ✅    |

---

### 2-5. 프론트엔드 sessionContext 검증

**검증 내용**: 상태 초기화 → 갱신 → 전달 → 리셋 흐름

#### 상태 생성 흐름
```
L932-938: sessionContext 초기화 (모든 필드 null)
  ↓
L1072-1076: reqBody에 session_context 첨부
  ↓ (서버 응답)
L1112-1121: data.sources[0]에서 entity_id/entity_name/source_section 추출 → 갱신
```

#### entity_id 추적 검증

| 시나리오        | sources 내용                                                  | sessionContext 갱신         |
| --------------- | ------------------------------------------------------------- | --------------------------- |
| 일반 검색 성공  | `[{entity_id:"W-0788", entity_name:"강관용접(200, SCH 40)"}]` | `last_entity_id="W-0788"` ✅ |
| clarify 응답    | sources=[]                                                    | 갱신 안 됨 (정상) ✅         |
| 칩 클릭 후 검색 | sendMessage(entityId) → 서버 → sources 반환                   | 응답 후 갱신 ✅              |

#### spec 추출 로직 검증

```javascript
// L1119: entity_name에서 괄호 내용 추출
const specMatch = "강관용접(200, SCH 40)".match(/\((.*?)\)/);
// specMatch[1] = "200, SCH 40"
// .replace(/,\s*/g, ' ') → "200 SCH 40" ✅
```

| entity_name 패턴                  | 추출 결과         | 정상 작동 |
| --------------------------------- | ----------------- | --------- |
| "강관용접(200, SCH 40)"           | "200 SCH 40"      | ✅         |
| "TIG용접(100, SCH 20)"            | "100 SCH 20"      | ✅         |
| "잡철물 제작 및 설치" (괄호 없음) | null (갱신 안 됨) | ✅         |

> **발견된 문제**: `last_quantity` 갱신 로직 없음(m2). 현 단계에서 서버가 수량을 반환하지 않으므로 보류.

---

### 2-6. ruleBasedIntent 폴백 검증 (수정 후)

| 입력                    | 매칭 패턴         | 결과                        | 검증               |
| ----------------------- | ----------------- | --------------------------- | ------------------ |
| "노무비 계산해줘"       | `/노무비/`        | cost_calculate              | ✅                  |
| "인건비 얼마야"         | `/인건비/`        | cost_calculate              | ✅                  |
| "산출서 만들어줘"       | `/산출서/`        | report_request              | ✅                  |
| "50m로 바꿔서 다시"     | `/(50)(m)(바꿔)/` | modify_request(quantity=50) | ✅                  |
| "TIG로 바꿔줘"          | `/로\s*바꿔/`     | modify_request(work_change) | ✅                  |
| "강관용접 200mm SCH 40" | 기존 로직         | search                      | ✅ (기존 동작 유지) |
| "안녕"                  | `/안녕/`          | greeting                    | ✅ (기존 동작 유지) |

---

## 3. 발견 → 수정 이력

| #   | 심각도     | 발견 내용                                        | 수정 방법                                             | 상태   |
| --- | ---------- | ------------------------------------------------ | ----------------------------------------------------- | ------ |
| C1  | 🔴 Critical | 프롬프트 출력 형식에 새 필드 누락                | JSON schema에 `modify_type`/`quantity`/새 intent 명시 | ✅ 수정 |
| M2  | 🟡 Major    | `modify_request`에서 `exclude_labor` fallthrough | 안내 메시지 + 가드 추가                               | ✅ 수정 |
| I1  | 🟢 개선     | 디버그 로그에 `modify_type`/`quantity` 미출력    | 로그 포맷 확장                                        | ✅ 수정 |
| I3  | 🟢 개선     | ruleBasedIntent에 새 intent 패턴 없음            | 6개 regex 패턴 추가                                   | ✅ 수정 |
| m2  | 🟢 Minor    | `last_quantity` 추적 부재                        | 서버 응답에 수량 미포함 → 보류                        | ⏸️ 보류 |
| I2  | 🟢 Minor    | 새 대화 시 sessionContext 리셋                   | clearChat 기능 없음 → 보류                            | ⏸️ 보류 |

---

## 4. 결론

- **총 6건 검출**, 4건 즉시 수정, 2건 보류
- **Critical 1건**(C1: 프롬프트 출력 형식)은 즉시 수정하여 LLM이 `modify_type`/`quantity`를 출력하도록 보장
- **기존 기능 회귀 위험**: 없음. 기존 5개 intent 로직은 변경하지 않았으며, 새 분기는 기존 분기 앞에 추가
- 배포 후 실 테스트에서는 DeepSeek의 분류 정확도와 sessionContext 추적 정확성을 우선 확인 필요
