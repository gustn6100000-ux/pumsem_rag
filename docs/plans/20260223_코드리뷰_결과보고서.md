# PUMSEM 코드 리뷰 결과 보고서

> **작성일**: 2026-02-23
> **작성자**: Antigravity AI Architect
> **검토 대상**: Phase 4 / Phase 1.5-C / Phase 2 구현 결과
> **검토 디렉토리**: `supabase/functions/rag-chat/` (배포 대상 디렉토리)
> **결과**: ✅ Phase 4, Phase 1.5-C 완전 구현 | ⚠️ Phase 2 — Route 3.5 Dead Code 버그 1건

---

## 0. 배경

이전 코드 리뷰는 구버전 사본인 `edge-function/` 디렉토리를 대상으로 수행되어 모든 항목이 미구현으로 오판정됐다.
실제 배포 코드는 `supabase/functions/rag-chat/`이며, 본 보고서는 해당 디렉토리를 기준으로 재검토한 결과다.

| 디렉토리 | 용도 | 상태 |
|---|---|---|
| `edge-function/` | 초기 개발 시 사본 (2/15~2/22 타임스탬프) | 구버전 — 미사용 |
| `supabase/functions/rag-chat/` | 실제 배포 디렉토리 (2/23 타임스탬프) | 최신 — 검토 대상 ✅ |

---

## 1. Phase 4 — RAG Search Layer Refactoring

### 검토 결과: ✅ 5/5 완전 구현

| 항목 | 파일 | 위치 | 판정 |
|---|---|---|:---:|
| RPC `get_related_resources_v2` 전환 | `graph.ts` | L20, L54 | ✅ |
| `renderFlatTable()` 신규 (교차표 제거) | `index.ts` | L54, L153, L159, L165 | ✅ |
| SYSTEM_PROMPT 4열 플랫 지시 | `llm.ts` | L33 | ✅ |
| `skipRegex` 비-노무 항목 필터 | `resolve.ts` | L685, L744 | ✅ |
| 라벨 중복 제거 | `resolve.ts` | L753 | ✅ |

#### 세부 확인

**`graph.ts` — RPC v2 전환 (2개소)**
```typescript
// L20 (직접 조회)
const { data: relations } = await supabase.rpc(
    "get_related_resources_v2",
    { p_entity_id: entityId }
);

// L54 (WorkType 순회 내)
const { data: wtRels } = await supabase.rpc(
    "get_related_resources_v2",
    { p_entity_id: wt.id }
);
```

**`llm.ts` — SYSTEM_PROMPT 4열 플랫 테이블 지시 (L33)**
```
3. **표 형식 — 컨텍스트 구조 유지**: 컨텍스트에 제공된 4열 플랫 구조 표
   (직종/장비명/자재명 | 수량 | 단위 | 규격)를 **있는 그대로** 유지하여 출력합니다.
```
(구버전의 "매트릭스(교차표)... 절대 4열 플랫으로 분해하지 않습니다" 지시 → 완전 교체됨)

**`resolve.ts` — skipRegex + 라벨 중복 제거 (L744-L753)**
```typescript
const skipRegex = /(비례비|비계|지보공|동바리|철거|운반|폐기물|할증|기타|부대비용|소운반)/;

for (const wt of workTypes) {
    if (wt.type === 'WorkType' && skipRegex.test(wt.name)) continue;  // L748
    if (options.find(o => o.entity_id === wt.id)) continue;           // entity_id 중복 제거
    const label = ...;
    if (options.find(o => o.label === label)) continue;               // L753: 라벨 중복 제거
    options.push({ ... });
}
```

---

## 2. Phase 1.5-C — Monster Table Expansion

### 검토 결과: ✅ 4/4 구현 (일부 방식 상이하나 기능 정상)

| 항목 | 파일 | 판정 | 비고 |
|---|---|:---:|---|
| 재질 6종 확장 | `parse_13_1_1.py` | ✅ | MULTIPLIERS 합성 방식 (기록서와 방식 다름) |
| 밸브 설치 파서 신규 | `parse_13_3_1.py` | ✅ | 압력등급(10.5K~176K) 5종 차원 추가 |
| φ/ø 접두사 + 소수점 버그 수정 | `step1_table_extractor.py` | ✅ | L498 정상 처리 |
| 멀티파일 UPSERT | `seed_db.py` | ✅ | 기록서 내용과 완전 일치 |

#### 구현 방식 차이 메모

**`parse_13_1_1.py`** — 기록서는 재질별 정규식 확장으로 설명하나, 실제 구현은 `MULTIPLIERS` 승수 테이블을 통한 합성 방식:
- 배관용탄소강관(KSD3507) + 압력배관용탄소강관(KSD3562): 원본 HTML 직접 파싱
- 나머지 5종 (Cr합금강관, 스텐레스강관, 알루미늄관, 동관, 황동관): 탄소강관 기준값 × 재질별 보정계수(%)로 합성

**`parse_13_3_1.py`** — 기록서의 "3차원 (구경 × 직종 × 수량), 3직종"과 달리 실제 구현:
- 직종: 플랜트배관공, 특별인부 **2종** (용접공 제외)
- `joint_type` 컬럼을 압력등급(10.5K, 21~27.5K, 42~62K, 105K, 176K) 저장에 재활용

**`step1_table_extractor.py`** — 출력 포맷이 기록서(`D200`)와 다름. 실제 코드는 `φ200` 형식 사용. 핵심 버그 수정(φ 제거 후 파싱, 소수점 보존)은 정상.

---

## 3. Phase 2 — DeepSeek Dual-Model Routing

### 검토 결과: ⚠️ 5/6 구현 — Route 3.5 Dead Code 버그 1건

| 항목 | 파일 | 위치 | 판정 |
|---|---|---|:---:|
| `classifyComplexity()` 정의 | `clarify.ts` | L34 | ✅ |
| `generateReasoningGuide()` 정의 | `llm.ts` | L190 | ✅ |
| Route 3.5 조건문 | `index.ts` | L1147 | ✅ |
| `IntentAnalysis.complex_estimate` | `types.ts` | L105 | ✅ |
| `IntentAnalysis.complexity?` 필드 | `types.ts` | L112 | ✅ |
| Thinking UI (4초 타임아웃, 보라색) | `app.js` | L179 | ✅ |
| **`classifyComplexity` import + 호출** | `index.ts` | **L36-42, L1052** | ❌ |

---

## 4. 버그 상세 — Route 3.5 Dead Code

### 원인

`classifyComplexity()`가 `clarify.ts`에 정의되어 있으나 `index.ts`에서 **import되지 않고 호출되지 않음**.
결과적으로 `analysis.complexity`는 항상 `undefined`이며, Route 3.5 조건이 절대 충족되지 않는다.

### 증거

**`index.ts` L36-42 — `classifyComplexity` 누락**
```typescript
import {
    analyzeIntent,
    detectCostIntent,
    extractSpec,
    graphClarify,
    normalizeSpec,
    // classifyComplexity 없음 ← 누락
} from "./clarify.ts";
```

**`index.ts` L1051-1053 — 호출 누락**
```typescript
// ═══ Route 3: 의도 분석 (DeepSeek v3.2) ═══
const analysis = await analyzeIntent(question, history, sessionContext);
// analysis.complexity = classifyComplexity(question, analysis);  ← 이 줄 없음
analysis.spec = normalizeSpec(analysis.spec);
```

**`index.ts` L1147-1148 — 조건이 항상 false**
```typescript
// analysis.complexity는 항상 undefined → 이 블록은 절대 실행 안 됨
if (analysis.complexity === "complex" && (analysis.intent === "search" || analysis.intent === "complex_estimate")) {
```

### 영향 범위

- `generateReasoningGuide()` (deepseek-reasoner): 호출 불가 상태
- 복합 질의(다중 공종, 할증 조건 등)가 Route 3.5를 거치지 않고 Route 4로 직행
- `app.js` Thinking UI: 4초 후 항상 "DeepSeek Reasoner 가동 중" 표시되나, 실제 Reasoner 호출 없음

### 수정 방법 (2개소, 2줄 추가)

**수정 1 — `index.ts` import 추가 (L42 다음)**
```typescript
import {
    analyzeIntent,
    detectCostIntent,
    extractSpec,
    graphClarify,
    normalizeSpec,
    classifyComplexity,   // ← 추가
} from "./clarify.ts";
```

**수정 2 — `index.ts` L1053 다음 줄 추가**
```typescript
const analysis = await analyzeIntent(question, history, sessionContext);
analysis.complexity = classifyComplexity(question, analysis);   // ← 추가
analysis.spec = normalizeSpec(analysis.spec);
```

---

## 5. 부가 이슈 (낮은 우선순위)

| 항목 | 상태 | 설명 |
|---|:---:|---|
| `clarify.ts` L286 `validIntents`에 `complex_estimate` 누락 | ⚠️ | DeepSeek이 `complex_estimate` 반환 시 `search`로 강제 전환. INTENT_SYSTEM_PROMPT도 5개 의도만 나열하므로 실질 영향 없음 |
| `AnswerOptions.complexity` 필드 누락 | ⚠️ | 기록서 명시 항목이나 현재 Route 3.5 로직은 `IntentAnalysis.complexity`만 사용하여 실질 영향 없음 |

---

## 6. 종합 판정

| Phase | 완료 | 미완료/버그 | 종합 |
|---|---|---|---|
| Phase 4 | 5/5 | 0 | ✅ 완전 구현 |
| Phase 1.5-C | 4/4 | 0 | ✅ 완전 구현 |
| Phase 2 | 6/7 | 1 (import 누락) | ⚠️ 핵심 버그 1건 |

**즉시 수정 필요**: `index.ts` 2개소에 `classifyComplexity` import + 호출 추가 후 재배포.

---

## 7. edge-function/ 디렉토리 처리 권고

`edge-function/`은 초기 개발 사본으로 현재 배포 코드와 불일치하여 혼란을 유발할 수 있다.
아래 두 가지 중 하나를 선택한다.

| 옵션 | 명령 | 권장 여부 |
|---|---|---|
| **삭제** | `git rm -r edge-function/` | 권장 ✅ (혼란 방지) |
| **동기화** | `supabase/functions/rag-chat/`의 파일을 `edge-function/`에 복사 | 두 디렉토리 유지가 필요한 경우 |
