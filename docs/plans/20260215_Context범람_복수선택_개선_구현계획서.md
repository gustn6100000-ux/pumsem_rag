# Context 범람 및 복수 선택 개선 — 구현 계획서

**일시**: 2026-02-15

## 문제 요약

사용자가 **강판 전기아크용접 > 호칭경=4 > 3개 WorkType 선택** 후 결과를 보면:
1. 두께=4가 아닌 **전 범위(3,5,6,13...)** 데이터가 출력됨
2. 3개 선택했으나 **1개만** 조회됨
3. 표가 **세로 나열**이라 가독성 떨어짐

## 근본 원인

|   #   | 원인                          | 위치                    | 설명                                                                                                         |
| :---: | ----------------------------- | ----------------------- | ------------------------------------------------------------------------------------------------------------ |
|   1   | chunk tables context 범람     | `graph.ts` → `index.ts` | `retrieveChunks`가 section 전체 14개 chunk의 tables 병합 → LLM이 그래프 관계(두께=4) 무시하고 원문 전체 출력 |
|   2   | 복수 선택 시 첫 entity만 전송 | `frontend/index.html`   | `handleSelectorSubmit`에서 `firstItem.dataset.entityId`만 전달                                               |
|   3   | 매트릭스 미지원               | `index.ts`              | `buildContext` 투입 인력이 `직종\|수량\|단위` 세로 나열                                                      |

## 수정 사항

### 1. graph.ts — retrieveChunks에 specFilter 추가
- tables 병합 시 해당 spec 값 포함 행만 추출

### 2. index.ts — Phase -1 복수 entity 처리 + spec 필터 전달
- entity_id 쉼표 구분 → `.in()` 복수 조회
- spec에서 숫자 추출 → `retrieveChunks(entities, specNum)` 전달

### 3. index.ts — buildContext 투입 인력 매트릭스 출력
- `하향_용접공` → 자세/직종 분리 → 가로 매트릭스 렌더링

### 4. frontend/index.html — handleSelectorSubmit 복수 entity_id 전달
- 선택된 전체 entity_id를 쉼표 구분으로 전달
