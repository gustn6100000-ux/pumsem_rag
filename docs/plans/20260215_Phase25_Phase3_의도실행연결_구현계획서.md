# Phase 2.5 + Phase 3 상세 구현 계획서

> 작성일: 2026-02-15  
> 목표: 의도 분류 → 답변 생성 연결 + 업계 은어 변환

---

## 배경: 왜 이게 필요한가

Phase 1+2에서 의도 **분류**는 완성했지만, 분류된 intent가 **답변 생성에 반영되지 않는** 상태.

```
현재: "노무비 계산해줘" → cost_calculate 분류 ✅ → 일반 품셈 표 출력 ❌
목표: "노무비 계산해줘" → cost_calculate 분류 ✅ → 노무비 계산 표 출력 ✅
```

---

## Phase 2.5: Intent → 답변 생성 연결

### 핵심 원리

`generateAnswer` 함수에 **intent와 quantity를 전달**하고, `SYSTEM_PROMPT`에 **intent별 답변 지침을 추가**한다.

### 변경 1: `generateAnswer` 시그니처 확장

#### [MODIFY] [index.ts](file:///g:/My%20Drive/Antigravity/edge-function/index.ts)

**현재** (L2013-2016):
```typescript
async function generateAnswer(
    question: string,
    context: string,
    history: ChatMessage[]
): Promise<LLMResult>
```

**변경 후**:
```typescript
interface AnswerOptions {
    intent?: string;       // "cost_calculate" | "report_request" | "modify_request" 등
    quantity?: number;     // 사용자 지정 수량 (50m, 10개소 등)
    modifyType?: string;   // "quantity" | "work_change"
}

async function generateAnswer(
    question: string,
    context: string,
    history: ChatMessage[],
    options?: AnswerOptions
): Promise<LLMResult>
```

### 변경 2: intent별 프롬프트 분기 주입

`generateAnswer` 내부에서 `SYSTEM_PROMPT`에 **intent별 추가 지침**을 동적으로 부착한다.

```typescript
// generateAnswer 내부
let systemContent = SYSTEM_PROMPT;

if (options?.intent === "cost_calculate") {
    systemContent += `\n\n[특별 지침: 노무비 산출]
사용자가 노무비/인건비 계산을 요청했습니다.
1. 품셈 인력 데이터(직종, 수량, 단위)를 기반으로 노무비를 산출하세요.
2. 수량이 ${options.quantity || '미지정'}으로 주어졌습니다.
3. 노무비 산출 형식:
   | 직종 | 투입인원(인/개소) | 수량 | 총 투입(M/D) | 노임단가(원) | 소계(원) |
4. labor_costs 테이블 단가가 컨텍스트에 있으면 그것을 사용하세요.
5. 합계 행을 추가하세요.`;
}

if (options?.intent === "report_request") {
    systemContent += `\n\n[특별 지침: 산출서 형태 출력]
사용자가 산출서/내역서를 요청했습니다.
1. 정형화된 산출 내역서 형태로 출력하세요.
2. 포함 항목: 품셈 출처, 규격, 인력 투입, 노무비 산출, 합계
3. 수량이 ${options.quantity || '미지정'}으로 주어졌습니다.
4. 표번호, 출처 정보를 상단에 명시하세요.`;
}

if (options?.quantity && options.intent !== "cost_calculate" && options.intent !== "report_request") {
    systemContent += `\n\n[수량 정보]
사용자가 수량 ${options.quantity}을 지정했습니다.
품셈 인력/장비 수량에 이 값을 곱하여 총 투입량을 계산해 주세요.`;
}
```

### 변경 3: handleChat에서 intent/quantity를 generateAnswer에 전달

`generateAnswer` 호출부 4곳 중 **3곳**(Phase -1, 일반 흐름 2곳)에서 options를 전달한다.

> [!IMPORTANT]
> `entities.length === 0`인 경우(L2648)는 데이터 없음이므로 intent 전달 불필요.

#### 호출부 1: Phase -1 직접 조회 (L2147)

```typescript
// 현재
const llmResult = await generateAnswer(question, context, history);

// 변경 (analysis 접근 불가 → 재귀 호출 시 options 전달 필요)
```

**문제**: Phase -1은 `analysis` 변수가 존재하지 않는 시점. `cost_calculate`/`report_request`에서 재귀 호출로 Phase -1에 도착하기 때문.

**해결**: `handleChat` 시그니처에 `options?: AnswerOptions`를 추가하고, 재귀 호출 시 전달.

```typescript
// handleChat 시그니처
async function handleChat(
    question: string,
    history: ChatMessage[],
    entityId?: string,
    sectionId?: string,
    sessionContext?: SessionContext,
    answerOptions?: AnswerOptions  // ← 추가
): Promise<ChatResponse>
```

#### cost_calculate 재귀 호출 수정 (L2455 근처)

```typescript
// 현재
return handleChat(question, history, targetEntityId, undefined, sessionContext);

// 변경
return handleChat(question, history, targetEntityId, undefined, sessionContext, {
    intent: "cost_calculate",
    quantity: analysis.quantity || sessionContext?.last_quantity || undefined,
});
```

#### report_request 재귀 호출 수정 (L2510 근처)

```typescript
// 현재
return handleChat(question, history, targetEntityId, undefined, sessionContext);

// 변경
return handleChat(question, history, targetEntityId, undefined, sessionContext, {
    intent: "report_request",
    quantity: sessionContext?.last_quantity || undefined,
});
```

#### modify_request(quantity) 재귀 호출 수정 (L2464 근처)

```typescript
// 현재
return handleChat(question, history, sessionContext.last_entity_id, undefined, sessionContext);

// 변경
return handleChat(question, history, sessionContext.last_entity_id, undefined, sessionContext, {
    intent: "cost_calculate",
    quantity: analysis.quantity,
    modifyType: "quantity",
});
```

#### Phase -1에서 generateAnswer 호출 수정 (L2147)

```typescript
// 현재
const llmResult = await generateAnswer(question, context, history);

// 변경
const llmResult = await generateAnswer(question, context, history, answerOptions);
```

#### 일반 흐름에서 generateAnswer 호출 수정 (L2698)

```typescript
// 현재
const llmResult = await generateAnswer(question, context, history);

// 변경
const llmResult = await generateAnswer(question, context, history, {
    intent: analysis.intent,
    quantity: analysis.quantity || undefined,
});
```

---

## Phase 3: 업계 은어/단위 변환

### 변경 4: `normalizeSpec` 후처리 함수 추가

#### [MODIFY] [index.ts](file:///g:/My%20Drive/Antigravity/edge-function/index.ts)

`analyzeIntent` 함수 바로 뒤에 추가:

```typescript
function normalizeSpec(spec: string | null): string | null {
    if (!spec) return null;
    let s = spec;

    // 인치 → mm 변환 (배관 호칭경)
    const inchMap: Record<string, string> = {
        '1': '25', '1.5': '40', '2': '50', '3': '80',
        '4': '100', '6': '150', '8': '200', '10': '250',
        '12': '300', '14': '350', '16': '400', '20': '500', '24': '600',
    };
    const inchMatch = s.match(/(\d+(?:\.\d+)?)\s*(?:인치|inch|")/i);
    if (inchMatch && inchMap[inchMatch[1]]) {
        s = s.replace(inchMatch[0], inchMap[inchMatch[1]]);
    }

    // 파이 → mm (200파이 → 200)
    s = s.replace(/(\d+)\s*(?:파이|φ|Φ|∅)/gi, '$1');

    // mm 제거 (200mm → 200)
    s = s.replace(/(\d+)\s*mm/gi, '$1');

    // SCH 띄어쓰기 정규화 (SCH40 → SCH 40)
    s = s.replace(/SCH\s*(\d+)/gi, 'SCH $1');

    return s.trim();
}
```

### 변경 5: 프롬프트에 변환 규칙 추가

`INTENT_SYSTEM_PROMPT`의 핵심 제약 섹션에 추가:

```
5. 규격 변환 규칙:
   - 인치 → mm: 1"=25, 2"=50, 3"=80, 4"=100, 6"=150, 8"=200, 10"=250, 12"=300
   - "파이"는 mm 호칭경: "200파이" → spec: "200"
   - 단위 제거: "200mm" → "200"
```

### 변경 6: analyzeIntent 결과에 normalizeSpec 적용

```typescript
// analyzeIntent 호출 직후
const analysis = await analyzeIntent(question, history, sessionContext);
analysis.spec = normalizeSpec(analysis.spec);
```

---

## 수정 파일 요약

| 파일                                | 변경 내용                                                                                       | 난이도 |
| ----------------------------------- | ----------------------------------------------------------------------------------------------- | ------ |
| `index.ts` — `generateAnswer`       | 시그니처에 `options?: AnswerOptions` 추가, 내부에서 intent별 프롬프트 동적 부착                 | 중     |
| `index.ts` — `handleChat`           | 시그니처에 `answerOptions` 추가, 재귀 호출 3곳에서 options 전달, 일반 흐름 1곳에서 options 전달 | 중     |
| `index.ts` — `SYSTEM_PROMPT`        | 직접 수정 없음 (동적 부착으로 처리)                                                             | -      |
| `index.ts` — `INTENT_SYSTEM_PROMPT` | 규격 변환 규칙 3줄 추가                                                                         | 하     |
| `index.ts` — `normalizeSpec`        | 새 함수 추가 (~25줄)                                                                            | 하     |
| `index.ts` — `analyzeIntent` 후처리 | `normalizeSpec` 호출 1줄                                                                        | 하     |

---

## 검증 계획

### 시나리오 테스트 (배포 후)

| #   | 입력                            | 기대 결과                            |
| --- | ------------------------------- | ------------------------------------ |
| 1   | "강관용접 200mm SCH 40"         | 기존과 동일 품셈 표 (회귀 확인)      |
| 2   | (세션 유지) "노무비 계산해줘"   | 노무비 산출 표 (직종/투입/단가/소계) |
| 3   | (세션 유지) "50m로 바꿔서 다시" | 50m 적용된 노무비 재산출             |
| 4   | (세션 유지) "산출서 만들어줘"   | 정형 산출 내역서 형태                |
| 5   | "8인치 배관 용접"               | spec="200"으로 변환 → 검색           |
| 6   | "200파이 SCH 40 강관용접"       | spec="200 SCH 40" → search           |
| 7   | "TIG용접 품셈"                  | 기존과 동일 clarify (회귀 확인)      |
