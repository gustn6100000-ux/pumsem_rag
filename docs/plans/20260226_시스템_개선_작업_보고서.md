# 2026-02-26 ì¢…í•© ì‹œìŠ¤í…œ ê°ì‚¬ ê°œì„  ì‘ì—… ë³´ê³ ì„œ

> **ì‘ì„±ì¼**: 2026-02-26  
> **ì‘ì—…ì**: Antigravity AI Architect  
> **ê²€í†  ê¸°ì¤€**: `20260226_ì¢…í•©_ì‹œìŠ¤í…œ_ê°ì‚¬_ë°_ê°œì„ ê³„íšì„œ.md` + OpenAI Codex ì •ì  ê°ì‚¬ ë³´ê³ ì„œ  
> **ë°°í¬ ëŒ€ìƒ**: Supabase Edge Function `rag-chat` (project: pumsem / bfomacoarwtqzjfxszdr)

---

## 1. ì‘ì—… ê°œìš”

ê¸°ì¡´ ê°ì‚¬ ê³„íšì„œ(Section 1~4)ì™€ OpenAI Codex ì •ì  ê°ì‚¬ ê²°ê³¼(Section 5)ë¥¼ í†µí•©í•˜ì—¬, ì‹¤ì œ ì½”ë“œë² ì´ìŠ¤ì— ëŒ€í•œ **Phase A(ì¦‰ì‹œ ë³µêµ¬)** ë° **Phase B(ë…¼ë¦¬ ê³ ë„í™” ë° ê°€ì‹œì„±)** ê°œì„  ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  Supabaseì— ë°°í¬ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.

---

## 2. ìˆ˜ì • íŒŒì¼ ëª©ë¡ ë° ìƒì„¸ ë³€ê²½ ë‚´ì—­

### 2.1 `edge-function/` (ì‚­ì œ)

| êµ¬ë¶„ | ë‚´ìš© |
|---|---|
| **ì‘ì—…** | í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ êµ¬ë²„ì „ `edge-function/` ë””ë ‰í† ë¦¬ ì™„ì „ ì‚­ì œ |
| **ì´ìœ ** | IDE ì „ì—­ ê²€ìƒ‰ ì˜¤ì—¼, Source of Truth í˜¼ë™ ë°©ì§€ |
| **ë°©ë²•** | `Remove-Item -Recurse -Force` (PowerShell) |
| **ì˜í–¥** | ê¸°ì¡´ `seed_13_1_1.ts` ì™¸ ì”ì¡´ íŒŒì¼ ëª¨ë‘ ì œê±°. ìš´ì˜ ì½”ë“œ(`supabase/functions/rag-chat/`)ì— ì˜í–¥ ì—†ìŒ |

---

### 2.2 `supabase/functions/rag-chat/clarify.ts`

#### ë³€ê²½ 1: Intent í”„ë¡¬í”„íŠ¸ í™•ì¥ (5ê°œ â†’ 9ê°œ)

**ìˆ˜ì • ì „:**
```
## âš ï¸ ì¤‘ìš”: intentëŠ” ë°˜ë“œì‹œ ì•„ë˜ 5ê°œ ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©
"intent": "search" | "clarify_needed" | "followup" | "greeting" | "quantity_input"
```

**ìˆ˜ì • í›„:**
```
## âš ï¸ ì¤‘ìš”: intentëŠ” ë°˜ë“œì‹œ ì•„ë˜ 9ê°œ ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©
"intent": "search" | "clarify_needed" | "followup" | "greeting" | "quantity_input" 
         | "cost_calculate" | "modify_request" | "report_request" | "complex_estimate"
```

**ì¶”ê°€ëœ Intent ì„¤ëª…:**

| Intent | ìš©ë„ | ì˜ˆì‹œ |
|---|---|---|
| `cost_calculate` | ë‹¨ê°€/ë¹„ìš© ê³„ì‚° ëª…ì‹œ ìš”ì²­ | "ë‹¨ê°€ê°€ ì–¼ë§ˆì•¼?", "ì§ì ‘ë…¸ë¬´ë¹„ ê³„ì‚°í•´ë´" |
| `modify_request` | ê¸°ì¡´ ê²°ê³¼ ì¡°ê±´ ë³€ê²½ | "ì•¼ê°„ í• ì¦ 20% ì ìš©í•´ì¤˜", "íŒŒì´í”„ë¥¼ 100mmë¡œ" |
| `report_request` | ë³´ê³ ì„œ/í‘œ í˜•íƒœ ì¶œë ¥ ìš”ì²­ | "ë‚´ì—­ì„œ í˜•íƒœë¡œ ì •ë¦¬í•´ì¤˜", "í‘œë¡œ ë³´ì—¬ì¤˜" |
| `complex_estimate` | ë³µí•© ë‚´ì—­ ì¢…í•© ì‚°ì¶œ | "13-1-1 30í†¤ì´ë‘ ë‹¤ë¥¸ ê³µì¢… í•©ì‚°í•´ì„œ ê²¬ì " |

#### ë³€ê²½ 2: `validIntents` ë°°ì—´ì— `complex_estimate` ì¶”ê°€

```diff
- const validIntents = ["search", "clarify_needed", "followup", "greeting", 
-     "quantity_input", "cost_calculate", "modify_request", "report_request"];
+ const validIntents = ["search", "clarify_needed", "followup", "greeting", 
+     "quantity_input", "cost_calculate", "modify_request", "report_request", "complex_estimate"];
```

> **Why**: LLMì´ `complex_estimate`ë¥¼ ë°˜í™˜í•´ë„ `validIntents`ì— ì—†ì–´ ë¬´íš¨ ì²˜ë¦¬ë˜ë˜ ë¬¸ì œ í•´ì†Œ. Route 3.5 ì§„ì… ê²½ë¡œê°€ ì •ìƒ í™œì„±í™”ë¨.

#### ë³€ê²½ 3: `classifyComplexity` íŒì •ì‹ ê°•í™”

```diff
  // 5. ì—°ì‚°/ë³µí•© ëª…ì‹œ í‚¤ì›Œë“œ (+2ì )
- if (/í•©ì‚°|í¬í•¨í•´ì„œ|ì „ì²´|ì´ì•¡|ê³„ì‚°í•´/i.test(question)) score += 2;
+ if (/í•©ì‚°|í¬í•¨í•´ì„œ|ì „ì²´|ì´ì•¡|ê³„ì‚°í•´|ì‚°ì¶œ/i.test(question)) score += 2;
  
- // 5.5. 'ì‚°ì¶œ/ì‚°ì •' + ë³µìˆ˜ ê³µì¢… ì¡°í•© ì‹œ (+1pt) â€” ë‹¨ë… ì‚¬ìš© ì‹œ ê³¼ë¶„ë¥˜ ë°©ì§€
- if (/ì‚°ì¶œ|ì‚°ì •/.test(question) && workMatchCount >= 2) score += 1;
+ // 5.5. 'ì‚°ì¶œ/ì‚°ì •' + ë³µìˆ˜ ê³µì¢… ì¡°í•© ì‹œ (+1pt) â€” ë‹¨ë… ì‚¬ìš© ì‹œ ê³¼ë¶„ë¥˜ ë°©ì§€
+ if (/ì‚°ì¶œ|ì‚°ì •/.test(question) && workMatchCount >= 2) score += 1;
```

> **Why**: `ì‚°ì¶œ`ì´ ë‹¨ë…ìœ¼ë¡œ ì‚¬ìš©ë  ë•Œì—ë„ ë³µì¡ë„ ì ìˆ˜ì— ë°˜ì˜ë˜ë„ë¡ ê·œì¹™ 5ì— ì¶”ê°€.  
> ê·œì¹™ 5.5ì˜ `ì‚°ì¶œ|ì‚°ì •` AND ì¡°ê±´ì€ ìœ ì§€í•˜ì—¬ ë³µìˆ˜ ê³µì¢… + ì‚°ì¶œ ì¡°í•© ì‹œì—ë§Œ ì¶”ê°€ ê°€ì‚°.  
> **ê²€í†  í›„ ìˆ˜ì •**: ì´ˆê¸° êµ¬í˜„ì—ì„œ ê·œì¹™ 5.5ì˜ AND ì¡°ê±´ì´ ëˆ„ë½ë˜ì–´ ë³µìˆ˜ ê³µì¢… ì´ì¤‘ ê°€ì‚° ë²„ê·¸ê°€ ìˆì—ˆìœ¼ë‚˜, ìì²´ ê²€í†  ì‹œ ë°œê²¬í•˜ì—¬ ì¦‰ì‹œ ë³µì› ì™„ë£Œ.

---

### 2.3 `supabase/functions/rag-chat/search.ts`

#### ë³€ê²½: `keywordFallbackSearch()` alias ì¿¼ë¦¬ ì—°ê²°

```diff
  const { data, error } = await supabase
      .from("graph_entities")
      .select("id, name, type, properties, source_section")
      .in("type", ["WorkType", "Standard"])
-     .or(`name.ilike.${pattern},properties->>"korean_alias".ilike.${pattern}`)
+     .or(orClauses.join(","))
      .limit(3);
```

> **Why**: `orClauses` ë°°ì—´ì—ëŠ” ê¸°ë³¸ ILIKE íŒ¨í„´ê³¼ ì•½ì¹­ í™•ì¥(`TIGâ†’TIG(Tungsten Inert Gas)` ë“±)ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë‚˜, ì‹¤ì œ `.or()` í˜¸ì¶œì—ëŠ” í•˜ë“œì½”ë”©ëœ 2ê°œ ì¡°ê±´ë§Œ ì‚¬ìš©ë˜ê³  ìˆì—ˆìŒ. ìˆ˜ì • í›„ alias expansionì´ ì‹¤ì œ DB ì¿¼ë¦¬ì— ë°˜ì˜ë˜ì–´ ê²€ìƒ‰ íšŒìˆ˜ìœ¨(recall) í–¥ìƒ.

---

### 2.4 `supabase/functions/rag-chat/types.ts`

#### ë³€ê²½: `SearchInfo` ì¸í„°í˜ì´ìŠ¤ì— `telemetry` í•„ë“œ ì¶”ê°€

```diff
  export interface SearchInfo {
      entities_found: number;
      relations_expanded: number;
      ilwi_matched: number;
      chunks_retrieved: number;
      latency_ms: number;
+     telemetry?: {
+         embedding_ms: number;
+         rpc_ms: number;
+         llm_ms: number;
+     };
      token_usage?: TokenUsage;
  }
```

> **Why**: ê¸°ì¡´ `latency_ms`ë§Œìœ¼ë¡œëŠ” ì „ì²´ ì²˜ë¦¬ ì‹œê°„ë§Œ í™•ì¸ ê°€ëŠ¥. ë³‘ëª© ì›ì¸ ë¶„ì„ì„ ìœ„í•´ Embedding/RPC/LLM ë‹¨ê³„ë³„ ì§€ì—°ì‹œê°„ ë¶„ë¦¬ í•„ìš”.

---

### 2.5 `supabase/functions/rag-chat/context.ts`

#### ë³€ê²½: `makeAnswerResponse()` ë§¤ê°œë³€ìˆ˜ì— `telemetry` ì˜µì…˜ ì¶”ê°€

```diff
  opts?: {
      sources?: SourceInfo[];
      ...
      llmResult?: LLMResult;
+     telemetry?: { embedding_ms: number; rpc_ms: number; llm_ms: number; };
  }
```

```diff
  const searchInfo: SearchInfo = {
      ...
      latency_ms: Date.now() - startTime,
+     ...(opts?.telemetry && { telemetry: opts.telemetry }),
  };
```

---

### 2.6 `supabase/functions/rag-chat/index.ts`

#### ë³€ê²½: 4ê°œ íŒŒì´í”„ë¼ì¸ì— í…”ë ˆë©”íŠ¸ë¦¬ ê³„ì¸¡ ì£¼ì…

| íŒŒì´í”„ë¼ì¸ | ê³„ì¸¡ ë°©ì‹ | ì „ë‹¬ ê²½ë¡œ |
|---|---|---|
| `searchPipeline` | `tEmbedStart`â†’`embedding_ms`, `tRpcStart`â†’`rpc_ms` ì§ì ‘ ì¸¡ì • | `answerPipeline`ì˜ `opts.telemetry`ë¡œ ì „ë‹¬ |
| `answerPipeline` | `tLlmStart`â†’`llm_ms` ì§ì ‘ ì¸¡ì • + `opts.telemetry`ì—ì„œ ì´ì „ ë‹¨ê³„ ìˆ˜ì‹  | `makeAnswerResponse`ì˜ `telemetry`ë¡œ ì¡°ë¦½ |
| `fullViewPipeline` | `tLlmStart`â†’`llm_ms` ì§ì ‘ ì¸¡ì •, `rpc_ms`ëŠ” ì—­ì‚° | `makeAnswerResponse`ì— ì§ì ‘ ì „ë‹¬ |
| `complexTablePipeline` | `tLlmStart`â†’`llm_ms` ì§ì ‘ ì¸¡ì •, embedding ì—†ì–´ 0 | `makeAnswerResponse`ì— ì§ì ‘ ì „ë‹¬ |

**API ì‘ë‹µ ì˜ˆì‹œ:**
```json
{
  "search_info": {
    "entities_found": 3,
    "latency_ms": 4200,
    "telemetry": {
      "embedding_ms": 320,
      "rpc_ms": 1450,
      "llm_ms": 2380
    }
  }
}
```

---

## 3. ì •í•©ì„± êµì°¨ ê²€ì¦ ê²°ê³¼

### 3.1 Intent ê³„ì•½ ì²´ì¸

```
INTENT_SYSTEM_PROMPT (9ê°œ intent)
  â†’ LLM ë°˜í™˜ê°’
  â†’ validIntents ë°°ì—´ (9ê°œ â€” ë¬´íš¨ì²˜ë¦¬ ë°©ì§€)
  â†’ IntentAnalysis.intent ìœ ë‹ˆì˜¨ íƒ€ì… (9ê°œ)
  â†’ handleChat switch ë¶„ê¸° (9ê°œ ëª¨ë‘ ì²˜ë¦¬ ê²½ë¡œ ì¡´ì¬)
```

**ê²°ê³¼: âœ… ì „ êµ¬ê°„ ì¼ê´€ì„± í™•ì¸**

### 3.2 í…”ë ˆë©”íŠ¸ë¦¬ íƒ€ì… ì²´ì¸

```
types.ts (SearchInfo.telemetry íƒ€ì… ì •ì˜)
  â†’ context.ts (makeAnswerResponse opts.telemetry â†’ searchInfo ë³‘í•©)
  â†’ index.ts (4ê°œ íŒŒì´í”„ë¼ì¸ì—ì„œ Date.now() ì¸¡ì • í›„ ì „ë‹¬)
  â†’ API ì‘ë‹µ JSON (search_info.telemetry)
```

**ê²°ê³¼: âœ… 3ê°œ íŒŒì¼ ê°„ í•„ë“œëª…/íƒ€ì… ì™„ì „ ì¼ì¹˜**

### 3.3 Route 3.5 ì§„ì… ì¡°ê±´

```typescript
// index.ts L1175
if (analysis.complexity === "complex" && 
    (analysis.intent === "search" || analysis.intent === "complex_estimate"))
```

- `complex_estimate`ê°€ `validIntents`ì— ë“±ë¡ë¨ â†’ LLM ë°˜í™˜ ì‹œ ë¬´íš¨ ì²˜ë¦¬ ì•ˆ ë¨ âœ…
- `classifyComplexity`ì—ì„œ `ì‚°ì¶œ` í‚¤ì›Œë“œê°€ +2ì ìœ¼ë¡œ ë°˜ì˜ â†’ ë³µì¡ë„ `complex` íŒì • ê°€ëŠ¥ âœ…
- **ì´ì¤‘ ì•ˆì „ì¥ì¹˜**: intentê°€ `search`ì—¬ë„ `complexity=complex`ì´ë©´ Route 3.5 ì§„ì… âœ…

---

## 4. ìì²´ ê²€í† ì—ì„œ ë°œê²¬ ë° ìˆ˜ì •í•œ ì´ìŠˆ

| # | ì´ìŠˆ | ì‹¬ê°ë„ | ì¡°ì¹˜ |
|:---:|---|:---:|---|
| 1 | `classifyComplexity` ê·œì¹™ 5.5ì—ì„œ `ì‚°ì¶œ\|ì‚°ì •` AND ì¡°ê±´ ëˆ„ë½ â†’ ë³µìˆ˜ ê³µì¢… ì‹œ ì´ì¤‘ ê°€ì‚°(+3pt) | ğŸŸ¡ ì¤‘ | **ì¦‰ì‹œ ìˆ˜ì • ì™„ë£Œ** â€” AND ì¡°ê±´ ë³µì› |
| 2 | `complex_estimate` í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ ë¶€ì¡± (1ì¤„) | ğŸŸ¢ ë‚® | í˜„ì¬ ì´ì¤‘ ì•ˆì „ì¥ì¹˜ë¡œ ì»¤ë²„ë¨. í–¥í›„ ëª¨ë‹ˆí„°ë§ |

---

## 5. ë°°í¬ ë° ê²€ì¦

| í•­ëª© | ê²°ê³¼ |
|---|---|
| **ë°°í¬ ëª…ë ¹** | `npx supabase functions deploy rag-chat --project-ref bfomacoarwtqzjfxszdr --no-verify-jwt` |
| **ì—…ë¡œë“œ íŒŒì¼** | `index.ts`, `search.ts`, `types.ts`, `config.ts`, `resolve.ts`, `context.ts`, `llm.ts`, `clarify.ts` (8ê°œ) |
| **ë°°í¬ ìƒíƒœ** | âœ… ì„±ê³µ |
| **ë¹Œë“œ ì—ëŸ¬** | ì—†ìŒ |

---

## 6. ë³€ê²½ íŒŒì¼ ìš”ì•½

| íŒŒì¼ | ë³€ê²½ ìœ í˜• | ì£¼ìš” ë‚´ìš© |
|---|:---:|---|
| `edge-function/` | ğŸ—‘ï¸ ì‚­ì œ | êµ¬ë²„ì „ ë””ë ‰í† ë¦¬ ì œê±° |
| `clarify.ts` | âœï¸ ìˆ˜ì • | Intent 9ê°œ í™•ì¥, validIntents ë™ê¸°í™”, ë³µì¡ë„ íŒì • ê°•í™” |
| `search.ts` | âœï¸ ìˆ˜ì • | alias OR ì¡°ê±´ ì‹¤ì œ ì¿¼ë¦¬ ì—°ê²° |
| `types.ts` | âœï¸ ìˆ˜ì • | SearchInfo.telemetry íƒ€ì… ì¶”ê°€ |
| `context.ts` | âœï¸ ìˆ˜ì • | makeAnswerResponseì— telemetry ì „ë‹¬ ë¡œì§ ì¶”ê°€ |
| `index.ts` | âœï¸ ìˆ˜ì • | 4ê°œ íŒŒì´í”„ë¼ì¸ í…”ë ˆë©”íŠ¸ë¦¬ ê³„ì¸¡ ì£¼ì… |
| `20260226_ì¢…í•©_ì‹œìŠ¤í…œ_ê°ì‚¬_ë°_ê°œì„ ê³„íšì„œ.md` | âœï¸ ìˆ˜ì • | Section 5(Codex êµì°¨ê²€ì¦ + ìˆ˜ì •ëœ Action Plan) ì¶”ê°€ |
