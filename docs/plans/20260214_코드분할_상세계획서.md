# Edge Function 코드 분할 상세 계획서

**작성일**: 2026-02-14  
**대상 파일**: `rag-chat/index.ts` (2,521줄 / 112KB / 67개 함수)  
**목표**: 단일 파일 → 기능별 모듈 분리, 배포 안정성 및 유지보수성 향상

---

## 1. 현재 구조 분석

### 1-1. 섹션 맵

| 섹션                      | 줄 범위     | 줄 수 | 내용                                                                                                                                         |
| ------------------------- | ----------- | ----- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| **[A] 설정 & 유틸**       | L1~L53      | 53    | import, env, CORS, Rate Limit                                                                                                                |
| **타입 정의**             | L55~L124    | 70    | ChatMessage, ChatRequest, ClarifyOption 등 11개 interface                                                                                    |
| **[B] 임베딩**            | L125~L163   | 39    | `generateEmbedding()`                                                                                                                        |
| **[C] 검색 파이프라인**   | L164~L651   | 488   | `searchEntities`, `keywordFallbackSearch`, `chunkTextFallbackSearch`, `deduplicateResults`, `expandGraph`, `retrieveChunks`, `searchIlwi` 등 |
| **[D] 컨텍스트 조합**     | L652~L811   | 160   | `buildContext()`                                                                                                                             |
| **[E] 의도분석 + 명확화** | L812~L1704  | 893   | `detectCostIntent`, `extractSpec`, `analyzeIntent`, `ruleBasedIntent`, `graphClarify`, `targetSearch`, `KO_EN_DICT`                          |
| **[F] LLM 답변 생성**     | L1705~L1872 | 168   | `SYSTEM_PROMPT`, `generateAnswer()`                                                                                                          |
| **[G] 메인 핸들러**       | L1873~L2521 | 649   | `handleChat()`, `Deno.serve()`                                                                                                               |

### 1-2. 전역 의존성

```mermaid
graph TD
    ENV["환경변수<br/>GEMINI_API_KEY<br/>SUPABASE_URL<br/>SUPABASE_SERVICE_ROLE_KEY<br/>DEEPSEEK_API_KEY<br/>RAG_API_KEY"]
    SB["supabase 클라이언트<br/>createClient()"]
    
    ENV --> SB
    SB --> search["search.ts"]
    SB --> graph["graph.ts"]
    SB --> clarify["clarify.ts"]
    ENV --> embedding["embedding.ts"]
    ENV --> llm["llm.ts"]
    
    search --> index["index.ts"]
    graph --> index
    clarify --> index
    embedding --> index
    llm --> index
```

### 1-3. 함수 간 호출 관계

```
handleChat() 호출 트리:
├── analyzeIntent()          ← clarify.ts
│   ├── ruleBasedIntent()    ← clarify.ts (내부)
│   └── DeepSeek API 호출    ← clarify.ts (내부)
├── graphClarify()           ← clarify.ts
│   └── supabase 쿼리        ← supabase 클라이언트
├── generateEmbedding()      ← embedding.ts
├── targetSearch()           ← search.ts
│   └── supabase 쿼리        ← supabase 클라이언트
├── searchEntities()         ← search.ts
│   ├── keywordFallbackSearch()  ← search.ts (내부)
│   ├── chunkTextFallbackSearch() ← search.ts (내부)
│   └── extractSpecNumbers()     ← search.ts (내부)
├── deduplicateResults()     ← search.ts
├── expandGraph()            ← graph.ts
│   └── supabase 쿼리        ← supabase 클라이언트
├── searchIlwi()             ← graph.ts
├── retrieveChunks()         ← graph.ts
├── buildContext()           ← context.ts
└── generateAnswer()         ← llm.ts
```

---

## 2. 분할 설계

### 2-1. 모듈 구조

```
rag-chat/
├── index.ts          ← 엔트리포인트: Deno.serve + handleChat
├── types.ts          ← 모든 interface/type 정의
├── config.ts         ← 환경변수, supabase 클라이언트, CORS, Rate Limit
├── embedding.ts      ← generateEmbedding
├── search.ts         ← searchEntities, keywordFallbackSearch, 
│                        chunkTextFallbackSearch, extractSpecNumbers,
│                        deduplicateResults, targetSearch
├── graph.ts          ← expandGraph, retrieveChunks, searchIlwi
├── clarify.ts        ← analyzeIntent, ruleBasedIntent, graphClarify,
│                        detectCostIntent, extractSpec, KO_EN_DICT
├── context.ts        ← buildContext
├── llm.ts            ← SYSTEM_PROMPT, generateAnswer
└── index.html        ← 프론트엔드 (변경 없음)
```

### 2-2. 모듈별 상세 명세

#### `types.ts` — 타입 정의 (~80줄)

| export 항목         | 현재 위치   | 종류      |
| ------------------- | ----------- | --------- |
| `ChatMessage`       | L56~L59     | interface |
| `ChatRequest`       | L61~L66     | interface |
| `SourceInfo`        | L68~L74     | interface |
| `TokenUsage`        | L76~L82     | interface |
| `SearchInfo`        | L84~L91     | interface |
| `ClarifyOption`     | L94~L101    | interface |
| `ClarificationInfo` | L103~L107   | interface |
| `ChatResponse`      | L109~L115   | interface |
| `IntentAnalysis`    | L118~L124   | interface |
| `EntityResult`      | L167~L174   | interface |
| `RelatedResource`   | L407~L414   | interface |
| `IlwiItem`          | L582~L590   | interface |
| `ChunkResult`       | L610~L618   | interface |
| `ClarifyResult`     | L1060~L1063 | interface |
| `LLMResult`         | L1781~L1785 | interface |

---

#### `config.ts` — 환경 설정 (~60줄)

```typescript
// config.ts에서 export할 항목
export const GEMINI_API_KEY: string;
export const SUPABASE_URL: string;
export const SUPABASE_SERVICE_ROLE_KEY: string;
export const RAG_API_KEY: string;
export const DEEPSEEK_API_KEY: string;
export const DEEPSEEK_URL: string;
export const supabase: SupabaseClient;
export const ALLOWED_ORIGINS: string[];
export function getCorsHeaders(req: Request): Record<string, string>;
export function checkRateLimit(ip: string): boolean;
```

| 현재 위치                       | 이동 대상 |
| ------------------------------- | --------- |
| L5~L6 (import)                  | config.ts |
| L10~L18 (env + supabase client) | config.ts |
| L20~L53 (CORS + Rate Limit)     | config.ts |

---

#### `embedding.ts` — 임베딩 생성 (~45줄)

```typescript
// embedding.ts
import { GEMINI_API_KEY } from "./config.ts";
export async function generateEmbedding(text: string): Promise<number[]>;
```

| 현재 위치        | 함수                  |
| ---------------- | --------------------- |
| L125~L131 (상수) | EMBEDDING_URL         |
| L132~L163        | `generateEmbedding()` |

---

#### `search.ts` — 검색 파이프라인 (~540줄, 가장 큰 모듈)

```typescript
// search.ts
import { supabase } from "./config.ts";
import type { EntityResult, IntentAnalysis } from "./types.ts";

export function extractSpecNumbers(question: string): string[];
export async function keywordFallbackSearch(question: string, specNumbers: string[]): Promise<EntityResult[]>;
export async function chunkTextFallbackSearch(question: string): Promise<EntityResult[]>;
export async function searchEntities(embedding: number[], question: string): Promise<EntityResult[]>;
export function deduplicateResults<T>(results: T[]): T[];
export async function targetSearch(analysis: IntentAnalysis, embedding: number[], question: string): Promise<EntityResult[]>;
```

| 현재 위치   | 함수                        | 줄 수 |
| ----------- | --------------------------- | ----- |
| L176~L236   | `searchEntities()`          | 61    |
| L238~L253   | `extractSpecNumbers()`      | 16    |
| L255~L292   | `keywordFallbackSearch()`   | 38    |
| L294~L388   | `chunkTextFallbackSearch()` | 95    |
| L390~L404   | `deduplicateResults()`      | 15    |
| L1585~L1704 | `targetSearch()`            | 120   |

> **참고**: `targetSearch`는 현재 [E] 섹션(L1585)에 있지만, 검색 모듈에 속하므로 `search.ts`로 이동.

---

#### `graph.ts` — 그래프 확장 + 일위대가 (~280줄)

```typescript
// graph.ts
import { supabase } from "./config.ts";
import type { EntityResult, RelatedResource, IlwiItem, ChunkResult } from "./types.ts";

export async function expandGraph(entityId: string, entityType: string): Promise<RelatedResource[]>;
export async function searchIlwi(name: string, spec: string | null): Promise<IlwiItem[]>;
export async function retrieveChunks(entities: EntityResult[]): Promise<ChunkResult[]>;
```

| 현재 위치 | 함수                                                 | 줄 수 |
| --------- | ---------------------------------------------------- | ----- |
| L416~L579 | `expandGraph()` (내부 `expandSectionWorkTypes` 포함) | 164   |
| L592~L607 | `searchIlwi()`                                       | 16    |
| L620~L651 | `retrieveChunks()`                                   | 32    |

---

#### `clarify.ts` — 의도분석 + 명확화 (~740줄, 두 번째로 큰 모듈)

```typescript
// clarify.ts
import { supabase, DEEPSEEK_API_KEY, DEEPSEEK_URL } from "./config.ts";
import type { IntentAnalysis, ChatMessage, ClarifyResult, ClarifyOption } from "./types.ts";

export function detectCostIntent(question: string): boolean;
export function extractSpec(question: string): string | null;
export function ruleBasedIntent(question: string): IntentAnalysis;
export async function analyzeIntent(question: string, history: ChatMessage[]): Promise<IntentAnalysis>;
export async function graphClarify(analysis: IntentAnalysis, sectionId?: string): Promise<ClarifyResult>;
```

| 현재 위치   | 함수                                     | 줄 수 |
| ----------- | ---------------------------------------- | ----- |
| L813~L823   | `COST_KEYWORDS` + `detectCostIntent()`   | 11    |
| L824~L839   | `SPEC_PATTERNS` + `extractSpec()`        | 16    |
| L840~L901   | 의도분석 프롬프트 상수                   | 62    |
| L902~L929   | `KO_EN_DICT`                             | 28    |
| L931~L989   | `ruleBasedIntent()`                      | 59    |
| L991~L1052  | `analyzeIntent()`                        | 62    |
| L1065~L1583 | `graphClarify()` (내부 `makeLabel` 포함) | 519   |

---

#### `context.ts` — 컨텍스트 조합 (~160줄)

```typescript
// context.ts
import type { EntityResult, RelatedResource, IlwiItem, ChunkResult } from "./types.ts";

export function buildContext(
    entities: EntityResult[],
    relationsAll: RelatedResource[][],
    ilwiResults: IlwiItem[],
    chunks: ChunkResult[]
): string;
```

| 현재 위치 | 함수             | 줄 수 |
| --------- | ---------------- | ----- |
| L655~L811 | `buildContext()` | 157   |

---

#### `llm.ts` — LLM 답변 생성 (~170줄)

```typescript
// llm.ts
import { GEMINI_API_KEY } from "./config.ts";
import type { ChatMessage, LLMResult } from "./types.ts";

export const SYSTEM_PROMPT: string;
export async function generateAnswer(
    question: string, context: string, history: ChatMessage[]
): Promise<LLMResult>;
```

| 현재 위치   | 함수               | 줄 수 |
| ----------- | ------------------ | ----- |
| L1706~L1779 | `SYSTEM_PROMPT`    | 74    |
| L1787~L1872 | `generateAnswer()` | 86    |

---

#### `index.ts` — 엔트리포인트 (분할 후 ~600줄)

```typescript
// index.ts (분할 후)
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { getCorsHeaders, checkRateLimit, RAG_API_KEY } from "./config.ts";
import type { ChatRequest, ChatResponse, ChatMessage } from "./types.ts";
import { generateEmbedding } from "./embedding.ts";
import { searchEntities, targetSearch, deduplicateResults } from "./search.ts";
import { expandGraph, searchIlwi, retrieveChunks } from "./graph.ts";
import { analyzeIntent, graphClarify, detectCostIntent, extractSpec } from "./clarify.ts";
import { buildContext } from "./context.ts";
import { generateAnswer } from "./llm.ts";

// handleChat() — ~540줄
async function handleChat(...): Promise<ChatResponse> { ... }

// Deno.serve() — ~100줄
Deno.serve(async (req) => { ... });
```

---

## 3. 분할 후 예상 결과

| 파일           | 예상 줄 수 | 비율 |
| -------------- | ---------- | ---- |
| `types.ts`     | ~80        | 3%   |
| `config.ts`    | ~60        | 2%   |
| `embedding.ts` | ~45        | 2%   |
| `search.ts`    | ~540       | 21%  |
| `graph.ts`     | ~280       | 11%  |
| `clarify.ts`   | ~740       | 29%  |
| `context.ts`   | ~160       | 6%   |
| `llm.ts`       | ~170       | 7%   |
| `index.ts`     | ~600       | 24%  |
| **합계**       | **~2,675** | 100% |

> 줄 수가 약간 증가(+6%)하는 이유: 각 파일에 `import/export` 구문이 추가되기 때문. 실제 로직 코드는 동일.

---

## 4. 의존성 방향 (순환 참조 방지)

```mermaid
graph TD
    types["types.ts<br/>(의존성 없음)"]
    config["config.ts<br/>← types"]
    embedding["embedding.ts<br/>← config"]
    search["search.ts<br/>← config, types"]
    graph["graph.ts<br/>← config, types"]
    clarify["clarify.ts<br/>← config, types"]
    context["context.ts<br/>← types"]
    llm["llm.ts<br/>← config, types"]
    index["index.ts<br/>← 모든 모듈"]
    
    types --> config
    types --> search
    types --> graph
    types --> clarify
    types --> context
    types --> llm
    config --> embedding
    config --> search
    config --> graph
    config --> clarify
    config --> llm
    
    embedding --> index
    search --> index
    graph --> index
    clarify --> index
    context --> index
    llm --> index
```

**순환 참조 없음**: 모든 화살표가 단방향(아래→위)으로만 흐름.

---

## 5. 작업 절차

### Phase 1: 파일 생성 (순서 중요)

1. `types.ts` 생성 — 모든 interface 추출
2. `config.ts` 생성 — 환경변수 + supabase 클라이언트 + CORS/RateLimit
3. `embedding.ts` 생성 — generateEmbedding 함수 추출
4. `search.ts` 생성 — 검색 관련 함수 6개 추출
5. `graph.ts` 생성 — 그래프 확장 함수 3개 추출
6. `clarify.ts` 생성 — 의도분석/명확화 함수 5개 + 상수 추출
7. `context.ts` 생성 — buildContext 함수 추출
8. `llm.ts` 생성 — SYSTEM_PROMPT + generateAnswer 추출
9. `index.ts` 재작성 — import 구문 + handleChat + Deno.serve

### Phase 2: 로컬 검증

1. TypeScript 문법 오류 검사 (Deno check)
2. 로컬 http-server로 chatbot UI 테스트
3. "강관용접", "텍스 설치" 등 핵심 쿼리 동작 확인

### Phase 3: 배포

1. Supabase Edge Function 배포 (분할된 파일 전체)
2. Cloudflare Pages로 프론트엔드 배포
3. 라이브 환경 테스트

---

## 6. 리스크 분석

| 리스크                      | 확률 | 영향                     | 대응                                      |
| --------------------------- | ---- | ------------------------ | ----------------------------------------- |
| import 경로 오류            | 중   | 배포 실패                | Deno 기반이라 `.ts` 확장자 필수 포함      |
| 순환 참조                   | 낮   | 런타임 에러              | 의존성 그래프가 단방향이므로 불가능       |
| 전역 상태 공유 문제         | 중   | rateLimitMap 초기화 누락 | config.ts에서 export, index.ts에서만 참조 |
| handleChat 내부 의존성 누락 | 중   | 컴파일 에러              | 함수별 사용처 교차 검증 완료              |
| MCP API 배포 시 번들 실패   | 낮   | 배포 불가                | 로컬 `deno check` 선행, CLI 배포 fallback |

---

## 7. 변경 없는 항목

- `index.html` — 프론트엔드는 변경 없음 (백엔드 API 인터페이스 동일)
- API 엔드포인트 URL — `/functions/v1/rag-chat` 그대로
- 요청/응답 JSON 스키마 — `ChatRequest`, `ChatResponse` 동일
- DB 스키마 — 변경 없음
- 환경변수 — 추가/변경 없음
