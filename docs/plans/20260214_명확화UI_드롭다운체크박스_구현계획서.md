# 명확화 UI 개선: 드롭다운/체크박스 구현 계획서

**작성일**: 2026-02-14  
**Phase**: UI 개선  
**대상 파일**: `clarify.ts`, `types.ts` (백엔드), `index.html` (프론트엔드)  
**선행 보고서**: [명확화UI_드롭다운_개선_상세검토보고서](../reports/20260214_명확화UI_드롭다운_개선_상세검토보고서.md)

---

## 1. 목적

현재 chip 12개 제한(DB 122건 중 30건 조회 → 12개만 표시)을 해결하여,
**드롭다운 필터 + 체크박스 + 선택 버튼** 방식의 Selector Panel로 개선

---

## 2. 현재 코드 → Gap 분석

| 항목          | 현재 상태                    | 변경 후                              | 수정 위치                           |
| ------------- | ---------------------------- | ------------------------------------ | ----------------------------------- |
| 데이터 반환량 | `limit(30)` + 12개 chip 제한 | `limit(200)` 전체 반환               | `clarify.ts` L297, L375, L386, L700 |
| 응답 타입     | `ClarifyOption[]`만          | `SelectorPanel` 추가                 | `types.ts`                          |
| 프론트 렌더링 | flat chip → 즉시 API 호출    | 드롭다운 필터 + 체크박스 + 선택 버튼 | `index.html` L911-958               |
| 다중 선택     | ❌ 불가                       | ✅ 체크박스 → 선택 버튼               | `index.html` 신규                   |
| 필터          | ❌ 없음                       | ✅ 호칭경/SCH 2축 필터                | `index.html` 신규                   |

---

## 3. 백엔드 변경

### 3-1. 타입 추가 (`types.ts`)

```typescript
interface FilterAxis {
    label: string;    // "호칭경(mm)"
    key: string;      // "spec1"
    values: string[]; // ["15","20","25",...]
}

interface SelectorItem {
    entity_id: string;
    name: string;
    spec1?: string;   // 호칭경 "100"
    spec2?: string;   // SCH "40"
}

interface SelectorPanel {
    panel_type: 'spec_selector';
    section_path: string;
    total_count: number;
    filters: FilterAxis[];
    items: SelectorItem[];
}
```

`ClarifyResult`에 `selector?: SelectorPanel` 필드 추가

### 3-2. `clarify.ts` 변경

| 변경                   | 내용                                                                                    |
| ---------------------- | --------------------------------------------------------------------------------------- |
| **limit 해제**         | Step 2 `limit(30)` → `limit(200)`                                                       |
| **필터 추출 함수**     | `extractFilterAxes()` 신규 — 이름 패턴 `공종명(spec1, prefix spec2)`에서 규격 자동 추출 |
| **SelectorPanel 구성** | WorkType > 6개 + 규격 패턴 매칭 시 selector 반환                                        |
| **12개 제한 제거**     | 케이스 A `options.length >= 12` → 전체 반환 (프론트가 필터링)                           |

```typescript
// 필터 축 자동 추출 (이름 패턴 파싱)
function extractFilterAxes(workTypes: any[]): { filters: FilterAxis[], items: SelectorItem[] } {
    const pattern = /\((\d+),\s*(.*?)\)$/;
    // spec1/spec2 추출 → 숫자 정렬
}
```

---

## 4. 프론트엔드 변경

### 4-1. CSS 추가 (~80줄)

`.selector-panel`, `.filter-dropdown`, `.filter-checkbox`, `.selector-item`, `.selector-actions`

### 4-2. JS 변경

| 함수                          | 내용                                             | 예상 줄 수 |
| ----------------------------- | ------------------------------------------------ | ---------- |
| `addClarifyMessage()` 수정    | selector 분기 추가                               | 10줄 수정  |
| `renderSelectorPanel()` 신규  | 드롭다운 필터 + 체크박스 목록 + 선택 버튼 렌더링 | +60줄      |
| `filterSelectorItems()` 신규  | 필터 체크 변경 시 아이템 필터링                  | +30줄      |
| `handleSelectorSubmit()` 신규 | 선택된 entity_id 배열 → 일괄 조회                | +20줄      |
| `renderChips()` 분리          | 기존 chip 렌더링 로직 함수로 추출                | 리팩토링   |

### 4-3. 조건부 적용

```javascript
if (clarification.selector) {
    html += renderSelectorPanel(clarification.selector);
} else if (clarification.options?.length > 6) {
    html += renderOptionsAsPanel(clarification.options);
} else if (clarification.options?.length > 0) {
    html += renderChips(clarification.options);  // 기존 chip 유지
}
```

| 조건                          | UI                      | 이유                   |
| ----------------------------- | ----------------------- | ---------------------- |
| `selector` 필드 존재          | Selector Panel          | 2축 필터 데이터 제공   |
| `options > 6` (selector 없음) | 기본 Panel (체크박스만) | 다수 항목 구조화       |
| `options ≤ 6`                 | 기존 chip               | 소수는 chip이 직관적   |
| Section 선택 (Step 1)         | 기존 chip               | 분야 2~3개는 chip 적합 |

---

## 5. UI 와이어프레임

```
┌─────────────────────────────────────────────┐
│ 🤖 기계설비부문 > 제13장 > 강관용접         │
│    품셈은 122개 작업으로 분류되어 있습니다.  │
├─────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────┐              │
│  │호칭경(mm) ▼ │  │ SCH    ▼ │   🔍 필터    │
│  │ ☑ 전체선택  │  │ ☑ 전체   │              │
│  │ ☐ 15        │  │ ☐ 20     │              │
│  │ ☐ 20        │  │ ☐ 40     │              │
│  │ ☐ 25        │  │ ☐ 80     │              │
│  └─────────────┘  └──────────┘              │
├─────────────────────────────────────────────┤
│  매칭 결과: 9건                             │
│  ☐ 강관용접(100, SCH 40)                    │
│  ☐ 강관용접(100, SCH 80)                    │
│  ☐ 강관용접(100, SCH 120)                   │
├─────────────────────────────────────────────┤
│  ┌──────────────┐  ┌────────────────────┐   │
│  │ 📋 전체보기  │  │ 🔎 선택항목 조회(2)│   │
│  └──────────────┘  └────────────────────┘   │
└─────────────────────────────────────────────┘
```

---

## 6. 작업량 및 의존성

| 파일               | 추가/수정                       | 줄 수      |
| ------------------ | ------------------------------- | ---------- |
| `types.ts`         | 타입 추가                       | +25줄      |
| `clarify.ts`       | limit 해제 + SelectorPanel 구성 | +60줄      |
| `index.html` (CSS) | 패널 스타일                     | +80줄      |
| `index.html` (JS)  | 렌더링/필터/제출 함수           | +120줄     |
| **합계**           |                                 | **~285줄** |

**의존성**: 백엔드 먼저 완료 → 프론트엔드 구현 → 배포 + 테스트

---

## 7. 검증 계획

| 단계 | 테스트                          | 기대 결과                              |
| ---- | ------------------------------- | -------------------------------------- |
| 1    | `"강관용접"` 쿼리               | Selector Panel + 122개 항목 + 2축 필터 |
| 2    | `"콘크리트 타설"` 쿼리          | 기존 chip (소수 옵션)                  |
| 3    | `"잡철물"` 쿼리                 | Section chip (복수 분야)               |
| 4    | 필터 선택 (호칭경 100 + SCH 40) | 아이템 필터링 동작                     |
| 5    | 체크박스 다중 선택 → 조회 클릭  | API 호출 + 결과                        |
| 6    | 모바일 640px 이하               | 반응형 레이아웃                        |
