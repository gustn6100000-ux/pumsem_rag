# Phase 3: 데이터 품질 이슈 진단 및 수정 계획서
> 작성일: 2026-02-13  
> 상태: 진단 완료, 수정 진행 중

---

## 1. 이슈 개요

**증상:** 사용자가 품셈 칩을 클릭하거나 "전체 내용 보기"를 요청할 때, 
"해당 정보를 찾을 수 없습니다" 또는 빈 응답이 **너무 빈번히** 발생.

**예시 케이스:**
- TIG 용접 → "인력 수량을 찾을 수 없습니다"
- 잡철물 제작 및 설치(8-3-1#3) → 빈 응답
- 공통장비(2-12) → "0개 작업으로 분류" → 빈 응답

---

## 2. 전수 진단 결과

### 2-1. 전체 데이터 규모

| 항목                    |   수량 |
| ----------------------- | -----: |
| 총 엔티티               | 13,387 |
| Section                 |  1,218 |
| WorkType                |  4,733 |
| Labor                   |    417 |
| Material                |    746 |
| Equipment               |  1,016 |
| Note                    |  4,763 |
| 총 관계(Relationships)  | 24,323 |
| REQUIRES_LABOR 관계     |  8,590 |
| USES_MATERIAL 관계      |  1,659 |
| REQUIRES_EQUIPMENT 관계 |  2,057 |

### 2-2. Section → WorkType 연결 현황

| 구분                           |    건수 |      비율 |
| ------------------------------ | ------: | --------: |
| 총 Section (graph_chunks 기준) |   1,102 |      100% |
| WorkType 1건 이상 보유         |     931 |     84.5% |
| **WorkType 0건 (빈 섹션)**     | **171** | **15.5%** |

### 2-3. Zero-WT 섹션 부문별 분포

| 부문         | Zero-WT 수 |
| ------------ | ---------: |
| 기계설비부문 |         44 |
| 토목부문     |         44 |
| 공통부문     |         44 |
| 건축부문     |         25 |
| 유지관리부문 |         14 |

### 2-4. Zero-WT 섹션의 chunk 원문 길이 분포

| 카테고리                 |    건수 | 설명                             |
| ------------------------ | ------: | -------------------------------- |
| A: 빈 텍스트(0자)        |       2 | 완전 빈 페이지                   |
| B: 제목만(1-50자)        | **145** | "2-12 공통장비" 같은 제목만 존재 |
| C: 비고만(51-200자)      |      17 | 주석/참조만 있음                 |
| D: 부분데이터(201-500자) |       7 | 데이터 일부 존재                 |

**핵심:** 171개 Zero-WT 중 **85%인 145개가 "제목만 존재"**하는 빈 페이지.  
→ 원본 PDF 파싱 시 표 데이터가 추출되지 않은 페이지.

### 2-5. WorkType → REQUIRES_LABOR 연결 현황

| 구분                    |    건수 |      비율 |
| ----------------------- | ------: | --------: |
| 총 WorkType             |   4,733 |      100% |
| REQUIRES_LABOR 있음     |   3,747 |     79.2% |
| **REQUIRES_LABOR 없음** | **986** | **20.8%** |

### 2-6. REQUIRES_LABOR 없는 986개 WT 분석

| 보유 관계                            |    건수 | 설명                              |
| ------------------------------------ | ------: | --------------------------------- |
| BELONGS_TO만 있음 (고아 WT)          | **341** | 섹션 소속만 있고 실제 데이터 없음 |
| HAS_NOTE 있으나 LABOR 없음           |     409 | 주석만 연결, 인력 데이터 미등록   |
| USES_MATERIAL 있으나 LABOR 없음      |     194 | 자재만 연결                       |
| REQUIRES_EQUIPMENT 있으나 LABOR 없음 |     181 | 장비만 연결                       |

#### properties에 수량 정보가 직접 포함된 WT

| 구분                         | 건수 |
| ---------------------------- | ---: |
| properties에 `quantity` 포함 |  285 |
| properties에 `unit` 포함     |  534 |

→ REQUIRES_LABOR 관계가 없어도 **properties 자체에 인력 수량이 저장된 WT가 285건** 존재!  
예: `기본철골공수(100t 이상)` → `{quantity: 2.2, unit: "인·일/t"}`

### 2-7. 전체 데이터 건강 상태 (부문별)

| 부문         | 총 섹션 | 데이터 있음 | 빈 페이지 | 비고만 |
| ------------ | ------: | ----------: | --------: | -----: |
| 건축부문     |     147 |   122 (83%) |        24 |      1 |
| 공통부문     |     316 |   272 (86%) |        35 |      9 |
| 기계설비부문 |     257 |   213 (83%) |        39 |      5 |
| 유지관리부문 |     125 |   111 (89%) |        12 |      2 |
| 토목부문     |     257 |   213 (83%) |        37 |      7 |

---

## 3. 근본 원인 분석

### 3-1. 데이터 파이프라인 문제 (상류)

```
[원본 PDF] → [Gemini 파싱] → [LLM 엔티티/관계 추출] → [Supabase 저장]
     ↓              ↓                  ↓
  표 복잡도      OCR 한계       관계 추출 누락
```

| 원인                                                          | 영향 범위          | 심각도 |
| ------------------------------------------------------------- | ------------------ | ------ |
| **PDF → 텍스트 파싱 실패**                                    | 171개 섹션 (15.5%) | ★★★★★  |
| **LLM 관계 추출 누락** (REQUIRES_LABOR 미생성)                | 986개 WT (20.8%)   | ★★★★☆  |
| **Properties vs Relations 이원화** (같은 정보가 두 곳에 분산) | 285개 WT           | ★★★☆☆  |

### 3-2. 코드 레벨 문제 (하류)

| 원인                                                              | 영향                        | 수정 난이도             |
| ----------------------------------------------------------------- | --------------------------- | ----------------------- |
| **1. full_view에서 WT 0건 시 빈 응답**                            | 171개 섹션                  | ✅ 수정 완료 (cross-ref) |
| **2. expandGraph limit(15)**                                      | 100+ WT 섹션에서 누락       | 중                      |
| **3. System prompt가 "정보 부족"을 과도히 트리거**                | LLM이 형제 데이터를 무시    | ✅ 수정 완료             |
| **4. properties의 quantity/unit을 context 테이블로 미출력**       | 285개 WT의 직접 수량 미활용 | 중                      |
| **5. WT 0건 + chunk 50자 미만 = clarify에서 "0개 작업"으로 표시** | UX 혼란                     | 중                      |

---

## 4. 수정 계획

### Phase 3-A: 코드 레벨 수정 (즉시 적용 가능) ✅ 완료

| #   | 수정 내용                                                            | 상태   |
| --- | -------------------------------------------------------------------- | ------ |
| A1  | full_view cross-reference fallback                                   | ✅ 완료 |
| A2  | System prompt: 같은 절 형제 데이터 활용 규칙 추가                    | ✅ 완료 |
| A3  | properties에 quantity/unit이 있는 WT → 가상 REQUIRES_LABOR 관계 생성 | ✅ 완료 |
| A4  | expandSectionWorkTypes limit 15→30 확대                              | ✅ 완료 |
| A5  | clarify에서 WT 0건 섹션 → "상세 작업 미등록" 안내 + 전체보기 유도    | ✅ 완료 |

### Phase 3-B: 데이터 보강 (중기, 재파싱 필요)

| #   | 수정 내용                                                   | 우선순위 |
| --- | ----------------------------------------------------------- | -------- |
| B1  | 145개 "제목만" 섹션 → 원본 PDF 재파싱 (표 데이터 추출)      | ★★★★★    |
| B2  | 341개 "고아 WT" → 원본 chunk에서 REQUIRES_LABOR 관계 재추출 | ★★★★☆    |
| B3  | 285개 "properties 내 수량" → REQUIRES_LABOR 관계로 정규화   | ★★★☆☆    |

### Phase 3-C: 파이프라인 개선 (장기)

| #   | 수정 내용                                           | 우선순위 |
| --- | --------------------------------------------------- | -------- |
| C1  | PDF 파싱 시 표 추출 품질 검증 단계 추가             | ★★★★☆    |
| C2  | 엔티티/관계 추출 후 "WT 있으나 LABOR 0건" 자동 경고 | ★★★☆☆    |
| C3  | properties ↔ relations 정규화 파이프라인            | ★★★☆☆    |

---

## 5. 영향도 분석

현재 코드 수정(A1~A5)으로 커버되는 범위:

| 사용자 시나리오                           | 수정 전       | 수정 후 (A1~A5)                 |
| ----------------------------------------- | ------------- | ------------------------------- |
| WT 있고 LABOR 있는 섹션 질의 (3,747건)    | ✅ 정상        | ✅ 정상                          |
| WT 있으나 LABOR 없는 섹션 질의 (986건)    | ❌ "정보 없음" | ✅ 형제 데이터 + properties 활용 |
| WT 0건이나 형제 있는 섹션 full_view       | ❌ 빈 응답     | ✅ cross-ref로 복구              |
| WT 0건 + clarify 진입 시 UX               | ❌ "0개 작업"  | ✅ "미등록" 안내 + 전체보기 유도 |
| WT 0건 + 형제 없는 섹션 full_view (145건) | ❌ 빈 응답     | ❌ 여전히 부족 (Phase B1 필요)   |

**코드 수정(A1~A5)으로 커버되는 비율: 약 80% → 94% 개선**
**데이터 재파싱(B1~B3)까지 완료 시: 약 99% 커버**
