# 노무비 산출 시스템 — 구현 가능성 상세 분석

> 작성일: 2026-02-15  
> 목적: 사용자 목표 시스템 vs 현재 구현 상태 Gap 분석

---

## 목표 시스템 흐름

```
사용자 입력 (설명/치수/상세정보)
   → ① 의도 분석 (LLM)
   → ② 품셈 선택 (clarify UI)
   → ③ 품셈 확정
   → ④ 노무비 산출 (인공수 × 노임단가)
   → ⑤ 산출 내역서 출력 (품셈 + 노무비 + 총액)
   → ⑥ 수량 변동 / 품셈 변경 → 재산출
```

---

## 7단계별 현재 구현 상태

| 단계                  | 기능                             | 현재 상태                     | 구현 난이도 |
| --------------------- | -------------------------------- | ----------------------------- | ----------- |
| ① 사용자 입력         | 설명/치수/상세정보 입력          | ✅ **구현 완료**               | -           |
| ② 의도 분석           | LLM이 work_name/spec/intent 추출 | ✅ **구현 완료** (재설계 완료) | -           |
| ③ 품셈 선택           | clarify UI로 후보 제시           | ✅ **구현 완료** (드롭다운/칩) | -           |
| ④ 품셈 확정           | 사용자가 선택 → entity_id 전달   | ✅ **구현 완료**               | -           |
| ⑤ 품셈 데이터 조회    | 직종별 인공수(M/D) 추출          | ✅ **구현 완료** (graph 확장)  | -           |
| ⑥ 노임단가 대입       | 인공수 × 현재 노임단가 = 노무비  | ⚠️ **부분 구현**               | **중간**    |
| ⑦ 산출 내역서 출력    | 품셈+노무비+총액 표시            | ⚠️ **LLM에 의존**              | **중간**    |
| ⑧ 수량 변동/품셈 변경 | 대화형 재산출                    | ⚠️ **부분 구현**               | **중~상**   |

---

## 이미 동작하는 부분 (①~⑤)

현재 시스템은 **"질문 → 의도분석 → 품셈 검색 → 그래프 확장 → LLM 답변"** 파이프라인이 완성되어 있음.

**예시: "강관용접 200mm SCH 40" 입력 시 DB에서 확인된 데이터 경로:**

```
W-0788 "강관용접(200, SCH 40)"
  ├─ REQUIRES_LABOR → "플랜트용접공" (0.294인)
  └─ REQUIRES_LABOR → "특별인부" (0.172인)
```

이 데이터가 `expandGraph()` → `buildContext()` → LLM으로 전달되어 답변에 포함됨.

---

## ⚠️ ⑥ 노임단가 대입 — "계산이 안 되는 게 아니라, 정확하지 않다"

### 데이터 현황

| 데이터                                 | 위치                           | 상태       |
| -------------------------------------- | ------------------------------ | ---------- |
| **품셈 인공수** (플랜트용접공 0.294인) | `graph_relationships`          | ✅ 있음     |
| **노임단가** (플랜트용접공 292,640원)  | `labor_costs` 테이블 (118직종) | ✅ 있음     |
| **인공수 × 단가 자동 계산**            | Edge Function 코드             | ❌ **없음** |

### 문제 핵심

현재는 LLM이 `buildContext()`에서 받은 텍스트를 보고 **자기가 곱셈을 해서** 답변함.  
LLM은 계산기가 아니라서 **오차가 발생할 수 있음.**

```
현재 흐름:
  품셈 데이터 (텍스트) → LLM에 전달 → LLM이 "0.294 × 292,640 = ???" 직접 계산
  → 답변에 포함 (정확도 불안정)

목표 흐름:
  품셈 데이터 (구조화) → 코드가 직접 계산 → 계산 결과를 LLM에 전달
  → LLM은 계산 결과를 "설명"만 함 (정확도 100%)
```

### 구현 필요 사항

1. `graph_relationships`의 노무 데이터에서 직종명 추출
2. `labor_costs` 테이블에서 해당 직종의 단가 매칭 (퍼지 매칭 필요)
3. `인공수 × 단가` 계산을 **코드 레벨**에서 수행
4. 계산 결과를 구조화된 객체로 LLM context에 전달

**난이도: 중간** — 데이터가 이미 있고, 매칭 로직만 추가하면 됨

---

## ⚠️ ⑦ 산출 내역서 — "형식이 일정하지 않다"

**현재:** LLM이 자유 형식으로 Markdown 테이블을 생성 (매번 형식이 다름)

**목표 형식:**

```
┌─────────────────────────────────────────────────┐
│ ★ 품셈 산출 내역서                                │
├─────────────────────────────────────────────────┤
│ 공종: 강관용접 (200, SCH 40)                     │
│ 출처: 기계설비부문 > 제13장 > 강관용접 (13-2-3)   │
│ 기준: 1m당                                       │
├─────────┬──────────┬────────────┬───────────────┤
│ 직종     │ 인공수    │ 노임단가    │ 노무비        │
├─────────┼──────────┼────────────┼───────────────┤
│ 플랜트    │ 0.294인  │ 292,640원  │ 86,036원      │
│ 용접공    │          │            │               │
│ 특별인부  │ 0.172인  │ 226,122원  │ 38,893원      │
├─────────┼──────────┼────────────┼───────────────┤
│ 합계     │ 0.466인  │            │ 124,929원     │
└─────────┴──────────┴────────────┴───────────────┘

  × 수량 10m = 총 노무비: 1,249,290원
```

### 구현 방법

| 방식                                    | 장점                      | 단점                   |
| --------------------------------------- | ------------------------- | ---------------------- |
| **A. 코드에서 HTML/Markdown 직접 생성** | 형식 100% 고정, 계산 정확 | LLM의 자연어 설명 제한 |
| **B. 구조화 데이터 + LLM 서식**         | 자연어 설명 가능, 유연    | 형식 변동 가능         |

**권장: A+B 혼합** — 계산 테이블은 코드가 생성, 주석/설명은 LLM이 추가

**난이도: 중간** — `buildContext()` 수정 + 프론트엔드 렌더링 로직 추가

---

## ⚠️ ⑧ 수량 변동 / 품셈 변경 — "가장 도전적인 부분"

### 현재 intent 분류

- `quantity_input`: "10개소", "50m 계산해줘" → 이미 분류 가능
- `followup`: "SCH 80은?" → 이미 분류 가능

### 핵심 문제: 세션 상태 관리

intent 분류는 되지만, **이전 대화에서 확정된 품셈 데이터를 기억하지 못함.**

```
Turn 1: "강관용접 200mm SCH 40" → 품셈 확정 (W-0788)
Turn 2: "수량 10m로 계산해줘"   → intent=quantity_input ✅
   BUT: W-0788 정보가 사라짐 → 다시 검색부터 시작 ❌
```

### 현재 history 구조

```typescript
interface ChatRequest {
    question: string;
    history?: ChatMessage[];  // role + content 텍스트만
    entity_id?: string;       // 칩 클릭 시에만 전달
}
```

`history`에는 **텍스트만** 있고, **구조화된 품셈 데이터** (entity_id, 인공수, 단가 등)는 없음.

### 필요한 변경

| 항목            | 현재                  | 필요                                              |
| --------------- | --------------------- | ------------------------------------------------- |
| 세션 상태 관리  | ❌ 없음 (stateless)    | ✅ 마지막 확정 품셈 ID + 수량 저장                 |
| 프론트엔드 상태 | 텍스트 history만      | `lastConfirmedEntity`, `lastQuantity` 추가        |
| 서버 처리       | 매 요청마다 새로 검색 | `quantity_input`이면 이전 entity 재사용           |
| 품셈 변경 처리  | ❌ 없음                | "TIG로 바꿔줘" → 기존 규격 유지하면서 공종만 변경 |

**난이도: 중~상** — 상태 관리 아키텍처 변경 필요

---

## 최종 판정

| 질문                 | 답변                              |
| -------------------- | --------------------------------- |
| **구현이 가능한가?** | ✅ **완전히 가능**                 |
| **어려운가?**        | 단계별로 다름 (아래 참고)         |
| **가장 큰 리스크?**  | 직종명 퍼지 매칭 + 세션 상태 관리 |

---

## 구현 로드맵 (난이도 순)

### Phase 1 (쉬움, 1-2일)

- ✅ **노임단가 자동 계산 함수 추가**
  - `labor_costs` 테이블 JOIN + 곱셈
  - 데이터가 이미 있음 (118직종, 2026년 단가)
- ✅ **산출 테이블 코드 생성**
  - `buildContext`에서 계산 결과를 구조화

### Phase 2 (중간, 2-3일)

- ⚠️ **직종명 퍼지 매칭**
  - "플랜트용접공" (품셈) ↔ "플랜트용접공" (단가)
  - 대부분 정확히 일치하지만, 예외 케이스 처리 필요
- ⚠️ **산출 내역서 프론트엔드 렌더링**
  - 고정 형식 HTML 테이블
  - 수량 입력 UI (인풋 필드)

### Phase 3 (도전적, 3-5일)

- 🔴 **세션 상태 관리 (수량 변동)**
  - 프론트엔드에 lastEntity/lastQuantity 상태 추가
  - ChatRequest에 context 필드 추가
  - `quantity_input` 시 이전 entity 재사용
- 🔴 **품셈 변경 대화 ("TIG로 바꿔줘")**
  - followup intent에서 공종 변경 감지
  - 기존 규격은 유지하면서 새 공종으로 재검색

---

## DB 데이터 현황 (확인 완료)

| 테이블                | 데이터                          | 비고              |
| --------------------- | ------------------------------- | ----------------- |
| `graph_entities`      | WorkType, Labor, Equipment 등   | 품셈 엔티티       |
| `graph_relationships` | REQUIRES_LABOR (직종, 인공수)   | 품셈↔노무 관계    |
| `labor_costs`         | 118직종, 2026년 노임단가        | 149,081~675,173원 |
| `ilwi_items`          | 일위대가 (노무비, 재료비, 경비) | 일위대가 비교용   |
| `graph_chunks`        | 원문 청크 (주의사항 등)         | 컨텍스트 보강용   |

### 핵심 포인트

1. **데이터는 이미 다 있음** — `graph_relationships`에 인공수, `labor_costs`에 118직종 노임단가(2026년)
2. **파이프라인도 이미 있음** — 의도분석→검색→그래프확장→LLM
3. **부족한 것은 "계산 레이어"와 "상태 관리"** — 이 두 가지만 추가하면 목표 달성
