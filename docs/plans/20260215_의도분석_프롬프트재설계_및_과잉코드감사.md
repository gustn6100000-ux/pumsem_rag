# 의도 분석 프롬프트 재설계 + 과잉 코드 감사

> 작성일: 2026-02-15  
> 근본 원인: LLM 의도분석이 중복 키워드 생성 → downstream 검색 패턴 과도 → 매칭 실패  
> 적용 스킬: `prompt-engineering-patterns`, `llm-structured-extraction`

---

## 1. 문제 진단

### 1.1 근본 원인 체인

```
[LLM 의도분석] "TIG용접 품셈"
   → work_name="TIG용접", keywords=["TIG", "TIG용접"]

[graphClarify L1189] searchTerms = [work_name, ...keywords]
   = ["TIG용접", "TIG", "TIG용접"]   ← 중복 포함

[전략 2 L1406] workPattern = "%" + searchTerms.join("%") + "%"
   = "%TIG용접%TIG%TIG용접%"         ← DB에 매칭 불가능한 패턴

[전략 2 실패] → 전략 3 → 전략 4 → 벡터 폴백 → 13-2-4 반환
```

### 1.2 SQL 검증 결과

| 패턴                    | 결과               |
| ----------------------- | ------------------ |
| `%TIG용접%TIG%TIG용접%` | **0건** ❌          |
| `%TIG용접%`             | **1건** ✅ (W-0631) |

### 1.3 현재 INTENT_SYSTEM_PROMPT 구조적 문제

| 문제                        | 위치     | 설명                                                                                                   |
| --------------------------- | -------- | ------------------------------------------------------------------------------------------------------ |
| **한글→영문 변환 하드코딩** | L939-949 | `"tig" → ["TIG", "TIG용접"]` 같은 규칙이 프롬프트에 직접 포함 → LLM이 work_name과 중복되는 키워드 생성 |
| **Few-shot 예시 부재**      | 전체     | 규칙만 나열, 입출력 쌍 예시 없음 → LLM의 비결정적 행동                                                 |
| **중복 금지 규칙 없음**     | 전체     | keywords에 work_name 포함 허용 → searchTerms 배열 오염                                                 |
| **토큰 낭비**               | L940-949 | ~15개 변환 예시가 프롬프트 토큰의 ~30% 차지                                                            |

---

## 2. 재설계 계획

### 2.1 INTENT_SYSTEM_PROMPT 재설계

**파일:** `edge-function/index.ts` L900-953

**적용 스킬 패턴:**
- `system-prompts.md`: **Role → Guidelines → Output Format → Constraints** 분리
- `llm-structured-extraction`: **Few-shot 예시**로 정확한 파싱 유도 + **"중복 추출 금지"** 명시
- `prompt-template-library.md`: Intent Detection 표준 패턴

**AS-IS:**
```
[역할 1줄]
[의도 판별 기준 5개 — 규칙 나열]
[키워드 추출 규칙 — 한글→영문 변환 15개 하드코딩]
[대화 히스토리 활용 규칙]
```
→ 문제: 규칙과 예시가 혼재, 변환 규칙이 프롬프트에 포함, 중복 방지 없음

**TO-BE:**
```
[역할 1줄]
[Output JSON Schema — 필드별 설명]
[Hard Constraints 3개]  ← "keywords에 work_name 절대 포함 금지" 포함
[의도 분류 기준 — 간결 정리]
[Few-shot 예시 5개 — 입출력 쌍]
```
→ 목표: 토큰 ~600 → ~400 축소, 중복 키워드 원천 차단

**Few-shot 예시 설계:**

```json
// 예시 1: 약어 쿼리 → clarify_needed
입력: "TIG용접 품셈"
출력: {"intent":"clarify_needed","work_name":"TIG용접","spec":null,"keywords":[],"ambiguity_reason":"규격 미지정"}

// 예시 2: 구체 쿼리 → search
입력: "강관용접 200mm SCH 40 품셈"
출력: {"intent":"search","work_name":"강관용접","spec":"200 SCH 40","keywords":[],"ambiguity_reason":null}

// 예시 3: 넓은 범위 → clarify_needed
입력: "용접"
출력: {"intent":"clarify_needed","work_name":"용접","spec":null,"keywords":[],"ambiguity_reason":"용접 종류 미지정"}

// 예시 4: 외래어 → work_name에 영문 원어
입력: "크러셔 운전 품셈"
출력: {"intent":"search","work_name":"Crusher 운전","spec":null,"keywords":["크러셔"],"ambiguity_reason":null}

// 예시 5: 후속 질문
입력: "SCH 80은?" (이전: 강관용접 200mm SCH 40)
출력: {"intent":"followup","work_name":"강관용접","spec":"SCH 80","keywords":[],"ambiguity_reason":null}
```

---

### 2.2 searchTerms 중복 제거

**파일:** `edge-function/index.ts` — graphClarify L1189, targetSearch L1778-1783

**추가할 유틸리티 함수:**

```typescript
function buildSearchTerms(work_name: string | null, keywords: string[]): string[] {
    const terms: string[] = [];
    if (work_name) terms.push(work_name);
    for (const kw of keywords) {
        if (!kw || kw.length < 2) continue;
        // work_name에 이미 포함된 키워드는 제외
        if (terms.some(t => t.includes(kw) || kw.includes(t))) continue;
        // 기존 terms에 중복이면 제외
        if (terms.includes(kw)) continue;
        terms.push(kw);
    }
    return terms;
}
```

**적용 위치:**
- `graphClarify` L1189: `const searchTerms = buildSearchTerms(work_name, keywords);`
- `targetSearch` L1778-1783: 동일 적용

---

### 2.3 ILIKE 패턴 전략 변경

**파일:** `edge-function/index.ts` — graphClarify L1406, targetSearch L1783

**현재:**
```typescript
const pattern = "%" + searchTerms.join("%") + "%";
// ["TIG용접", "TIG"] → "%TIG용접%TIG%" (순차 AND 의미)
```

**변경:**
```typescript
// work_name 우선 단독 매칭
const primaryPattern = searchTerms[0] ? `%${searchTerms[0]}%` : null;
// 보조 키워드는 OR절로 추가
const orConditions = searchTerms.map(t => `name.ilike.%${t}%`).join(',');
```

---

## 3. 과잉 코드 감사

### 3.1 index.ts 내 코드

| 코드                                            | 위치                                   | 판단         | 근거                                                      |
| ----------------------------------------------- | -------------------------------------- | ------------ | --------------------------------------------------------- |
| `KO_EN_DICT`                                    | L961-985                               | ✅ **유지**   | DeepSeek 장애 시 `ruleBasedIntent` 폴백에서 사용          |
| `ACTION_VERBS`                                  | graphClarify 내부                      | ✅ **유지**   | 전략 3 키워드 독립 검색에서 "용접" 등 범용 동사 제외 유효 |
| `chunkTextFallbackSearch`                       | graphClarify 전략4, targetSearch 4단계 | ✅ **유지**   | 엔티티명에 없는 용어 검색용 (장비편성 등)                 |
| L1096-1099 `search+ambiguity→clarify` 강제 전환 | analyzeIntent 후처리                   | ⚠️ **재검토** | 프롬프트 재설계 후 LLM이 정확히 분류하면 불필요할 수 있음 |

### 3.2 search.ts 내 코드 (런타임 미사용)

> **핵심:** `index.ts`는 `search.ts`를 import하지 않음. 따라서 search.ts의 모든 코드는 현재 배포된 Edge Function 런타임에서 **실행되지 않음**.

| 코드                              | 위치               | 판단         | 근거                              |
| --------------------------------- | ------------------ | ------------ | --------------------------------- |
| `ABBREVIATION_MAP`                | search.ts 상단     | 🟡 **미사용** | index.ts에서 import 안 함         |
| `expandAbbreviations`             | search.ts          | 🟡 **미사용** | 동일                              |
| `keywordFallbackSearch` 약칭 확장 | search.ts L320-332 | 🟡 **미사용** | 동일                              |
| `targetSearch` (search.ts 버전)   | search.ts L271     | 🟡 **미사용** | index.ts에 동명 함수 존재 (L1733) |

### 3.3 과잉 설계 판정 요약

| 항목                                        | 원래 목적         | 실제 효과                                | 판정                                  |
| ------------------------------------------- | ----------------- | ---------------------------------------- | ------------------------------------- |
| search.ts `expandAbbreviations`             | TIG→정식명칭 매칭 | 런타임 미실행                            | **과잉** (삭제 or 모듈화 대상)        |
| search.ts `keywordFallbackSearch` 약칭 확장 | TIG 폴백          | 런타임 미실행                            | **과잉**                              |
| DB name 변경 (W-0631 TIG용접)               | ILIKE 매칭 보장   | ✅ 유효하지만 상위 경로 문제로 효과 못 봄 | **유효** (프롬프트 수정 후 효과 발휘) |
| INTENT_SYSTEM_PROMPT 한글→영문 15줄         | 외래어 처리       | LLM이 중복 키워드 생성 유발              | **과잉 → 제거**                       |

---

## 4. 작업 범위

이번 작업 범위는 **3가지**로 한정:

1. ✅ `INTENT_SYSTEM_PROMPT` 재설계 (Few-shot 기반, 중복 금지)
2. ✅ `buildSearchTerms` 유틸리티 추가 + 적용
3. ✅ ILIKE 패턴 전략 변경 (work_name 단독 우선)

**범위 외:**
- search.ts 과잉 코드 삭제 (별도 리팩토링 작업으로 분리)
- index.ts ↔ search.ts 모듈 통합 (대규모 리팩토링)

---

## 5. 검증 계획

배포 후 아래 쿼리들을 API 호출로 테스트:

| #   | 쿼리                    | 기대 intent    | 기대 결과             |
| --- | ----------------------- | -------------- | --------------------- |
| 1   | "TIG용접 품셈"          | clarify_needed | W-0631 (13-2-3) 포함  |
| 2   | "tig"                   | clarify_needed | TIG용접 옵션 포함     |
| 3   | "강관용접 200mm SCH 40" | search         | 정확 매칭             |
| 4   | "용접"                  | clarify_needed | 복수 분야 옵션        |
| 5   | "크러셔 운전"           | search         | Crusher 매칭          |
| 6   | "잡철물"                | clarify_needed | 하위 WorkType 선택    |
| 7   | "콘크리트 타설"         | search/clarify | 정상 동작 확인 (회귀) |
