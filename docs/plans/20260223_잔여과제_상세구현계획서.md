# 건설품셈 RAG 시스템 — 잔여 작업 상세 구현 계획서

본 계획서는 2026-02-23 기준 완료되지 않은 **Phase 4, Phase 1.5-C, Phase 2, Phase 3**의 구체적인 코드 레벨 변경 사항(Physical Implementation)과 실행 절차를 정의합니다.

## User Review Required
> [!IMPORTANT]
> - Phase 4에서 SQL RPC 함수 변경과 Edge Function 리팩토링이 동시에 이루어집니다. 배포 시 다운타임이 발생할 수 있으므로, SQL 패치 후 즉시 Edge Function을 배포해야 합니다.
> - Phase 1.5-C의 `parse_13_3_1.py` (밸브 설치)는 새로운 파서 개발이 필요합니다. 

## Proposed Changes

### Phase 4: RAG 검색 레이어 경량화 및 리팩토링

#### [MODIFY] pipeline/sql/step2.7_create_search_functions.sql
- `get_related_resources()`: 역방향 조회(inbound) 로직을 전면 삭제하고 outbound(정방향) 조회만 유지하여 RPC 성능 극대화 (Architect Warning A: 역방향 전용 RPC는 별도 백로그로 분리).
- `search_entities_by_embedding()`: 반환 테이블에 `source_section` 컬럼 추가 (추가 조회를 없애기 위함).

#### [MODIFY] edge-function/search.ts
- `targetSearch()`: SQL 반환값에 포함된 `source_section`을 직접 사용하도록 수정.
- 별도의 `source_section` 후속 쿼리 블록 삭제.
- `deduplicateResults()`: 타입 레벨의 중복 제거 로직 완전 철거 (SQL 레벨에서 처리됨).

#### [MODIFY] edge-function/resolve.ts
- `deduplicateWorkTypes()`: 불필요한 중복 제거 로직 삭제하여 미들웨어 코드 두께 감소.

#### [MODIFY] edge-function/context.ts
- 사용하지 않는 구버전 컨텍스트 조합 함수 등 정리.

#### [MODIFY] edge-function/index.ts
- `buildContext()`: 
  - 엔티티 렌더링 시 **무조건 고정 4열 스키마** (`|직종|수량|단위|기준|`) 적용 (Architect Warning B 반영).
  - `per_unit` 값이 비어있을 경우 하이픈(`-`)으로 채움.
  - 마크다운 조립 시 `match(/\([^)]+\)/)` 같은 정규식 문자열 파싱 로직을 전면 삭제하고 `source_spec` 객체 속성을 최우선으로 매핑 (Architect Warning C 반영).

#### [MODIFY] edge-function/llm.ts
- `SYSTEM_PROMPT`: 고정 4열 테이블 생성 및 데이터의 `per_unit` 표기에 대한 강제 지시문 추가.

---

### Phase 1.5-C: Monster Table 재질 및 추가 공종 확장

#### [MODIFY] pipeline/scripts/parse_13_1_1.py
- 기존 "배관용 탄소강관" 1종 외 **6개 재질**(압력배관용 탄소강관, Cr합금강관, 스텐레스강관, 알루미늄관, 동관, 황동관)의 정규식 범위 확장 적용.
- 각 재질별 사이즈(구경) 배열과 이와 매칭할 가중치/품셈 파싱 로직 추가.

#### [NEW] pipeline/scripts/parse_13_3_1.py
- 제13장 13-3-1 (플랜지 및 밸브류 설치) 전용 테이블 파서 신규 생성.
- `parse_13_1_1.py`의 구조(BeautifulSoup + Pandas 조합)를 활용하여 구경별(15mm~1500mm) 인력 품셈 추출.

#### [NEW] pipeline/scripts/seed_13_3_1.ts
- 파싱된 밸브 설치 데이터를 Supabase `complex_table_specs` 테이블에 적재하는 시드 스크립트 작성 (TypeScript 기반 Edge Function 연동 대응).

---

### Phase 2: DeepSeek 듀얼 모델 라우팅

#### [MODIFY] edge-function/clarify.ts
- `classifyComplexity(question, analysis)` 함수 추가: 
  - 질문 길이, 복수 공종 키워드(해체/타설/용접 등), 조건 키워드, 물리량/단위 키워드 등을 분석하여 4점 이상 시 `complex` 반환. (Claude 보정 #5 반영)

#### [MODIFY] edge-function/llm.ts
- `generateReasoningGuide(question, history)` 함수 추가:
  - 모델: `deepseek-reasoner` (사고 모드) 호출.
  - 파라미터 제약 대응(Claude 보정 #5): `system` Role 미지원 대비 `user` 메시지 앞단에 시스템 지시문 합병, `temperature` 속성 제거.
  - 프롬프트: 사용자의 복합 질문에 대해 JSON 형태의 `search_tasks`, `calculations`, `adjustments` 마스터플랜 생성.
  - 환각 방지(Claude 보정 #4): **우회 추론 허용 규칙**은 오직 Reasoner 프롬프트에만 국한하여 주입.

#### [MODIFY] edge-function/index.ts
- `handleChat()` 내 Route 4 (searchPipeline, 기존 단순 검색) 진입 직전에 `classifyComplexity()` 분기 로직 삽입 (Route 3.5 신설, Claude 보정 #2 반영).
- 복합 질문일 경우:
  1. Reasoner 마스터플랜 호출 (실패 시 기본 경로 폴백).
  2. 명시된 `search_tasks` 배열을 순회하며 `targetSearch()` 멀티 DB 검색 수행.
  3. `combinedContext` 주입 후, 최종 답변은 `deepseek-chat`으로 산출.

---

### Phase 3: 복합 추론 파이프라인

#### [MODIFY] edge-function/types.ts
- `IntentAnalysis` 인터페이스에 `complex_estimate` 타입 및 `complexity?: "simple" | "complex"` 필드 추가 (TypeScript Union 확장).

#### [MODIFY] edge-function/llm.ts
- 기본 채팅 시스템 프롬프트(Chat용 `SYSTEM_PROMPT`) 하단에 **물리학 및 도메인 수학 공식** (원통 표면적, 강판 중량, 1톤/면적 환산 등 고정 상수 기반 산식) 추가 작성.
  - *단, 우회 판단을 LLM이 직접 내리지 않게 우회 추론 조건 지시는 뺌.*

## Verification Plan

### Phase 4 (SQL/Edge Function 리팩토링)
1. Supabase SQL 패치 & Edge Function 배포.
2. 챗봇 테스트 쿼리: `강관용접 200mm SCH 40 단가 알려줘`
3. 정상적으로 **고정 4열 표의 데이터**가 누락 없이 노출되는지 브라우저에서 시각적 확인.

### Phase 1.5-C (추가 공종 데이터 병합)
1. Python 전처리 스크립트(`parse_13_3_1.py`)와 시드 봇(`seed_13_3_1.ts`) 구동.
2. Supabase 대시보드 `complex_table_specs` 테이블에 밸브 설치 데이터(15mm~1500mm 구경벌)가 정확도 높게 반영(Insert)되었는지 SQL 카운트 검사.

### Phase 2 & 3 (듀얼 모델 적용 후 고도화 렌더링)
1. 챗봇 테스트 쿼리: `원형 덕트 4T 1300mm 해체 + 보온 철거 + 고소작업 15m`
2. **복합 질의 응답 시간 체크**: 예상 5~8초 (단순 쿼리 2~3초).
3. Supabase Edge Function 로그 접속: `deepseek-reasoner`가 호출되어 `classifyComplexity()` 분기 조건을 탔는지(SCORE 4점 이상) 직접 확인.
4. **연산 결괏값 교차 검증**: 응답 결과의 노무비를 도메인 공식 (`π × D × L` 체적 계산 등)으로 직접 수계산 한 내역과 대조, 할루시네이션 개입 여부 감시.
