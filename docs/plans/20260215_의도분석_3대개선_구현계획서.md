# 의도 분석 시스템 3대 개선 — 상세 구현 계획서

> 작성일: 2026-02-15  
> 목적: 노무비 산출 흐름을 지원하는 의도 분석 시스템으로 확장

---

## 1. 세션 상태 관리 (`session_context`)

### 문제

"아까 건 50m 치면 얼마야?", "그거 말고 TIG로 해줘" 같은 맥락 참조 질문에서 **이전 턴의 품셈 데이터를 모름**.

현재: `{ question, history: [{role,content}], entity_id?, section_id? }` — 텍스트만 전달  
목표: 이전에 확정된 품셈 ID, 수량, 계산 결과를 구조화 전달

### 변경 파일

#### [MODIFY] types.ts

**추가할 타입:**

```typescript
export interface SessionContext {
    last_entity_id: string | null;
    last_work_name: string | null;
    last_spec: string | null;
    last_quantity: number | null;
    last_section_id: string | null;
}
```

**ChatRequest에 session_context 추가:**

```diff
 export interface ChatRequest {
     question: string;
     history?: ChatMessage[];
     entity_id?: string;
     section_id?: string;
+    session_context?: SessionContext;
 }
```

#### [MODIFY] index.ts

1. `handleChat` 함수: `body.session_context` 수신 처리
2. `analyzeIntent` 함수: session_context를 LLM 프롬프트에 주입
3. `INTENT_SYSTEM_PROMPT`: 세션 컨텍스트 참조 규칙 추가
4. `quantity_input` 분기: session_context.last_entity_id로 직접 검색

#### [MODIFY] index.html

1. 전역 상태 변수 추가: `let sessionContext = { ... }`
2. 응답 수신 후 상태 업데이트
3. 요청 시 session_context 첨부

---

## 2. Intent 세분화 (5개 → 8개)

### 추가 Intent 3개

| 새 Intent        | 사용자 예시                 | 동작                      |
| ---------------- | --------------------------- | ------------------------- |
| `cost_calculate` | "노무비 계산해줘"           | 확정 품셈의 노무비 산출   |
| `modify_request` | "수량 바꿔줘", "TIG로 변경" | 이전 결과 기반 변경       |
| `report_request` | "산출서 만들어줘"           | 정형화된 산출 내역서 생성 |

### 변경 파일

#### [MODIFY] types.ts

```diff
 export interface IntentAnalysis {
-    intent: "search" | "clarify_needed" | "followup" | "greeting" | "quantity_input";
+    intent: "search" | "clarify_needed" | "followup" | "greeting" | "quantity_input" | "cost_calculate" | "modify_request" | "report_request";
     work_name: string | null;
     spec: string | null;
     keywords: string[];
     ambiguity_reason: string | null;
+    modify_type?: "quantity" | "work_change" | "exclude_labor" | null;
+    quantity?: number | null;
 }
```

#### [MODIFY] index.ts

1. INTENT_SYSTEM_PROMPT 의도 분류 기준 확장
2. Few-shot 예시 4개 추가
3. validIntents 배열 확장
4. handleChat에 cost_calculate/modify_request/report_request 분기 추가

---

## 3. 업계 은어/단위 변환

### 전략: 프롬프트 Few-shot + 코드 후처리

#### [MODIFY] index.ts

1. INTENT_SYSTEM_PROMPT에 인치→mm 변환표 추가
2. normalizeSpec() 후처리 함수 추가
3. analyzeIntent 결과에 normalizeSpec 적용

**인치→mm 변환표:**
```
1/2"→15, 3/4"→20, 1"→25, 1.5"→40, 2"→50, 3"→80, 4"→100, 6"→150, 8"→200, 10"→250, 12"→300
```

---

## 검증 계획

| #   | 입력                      | 기대 intent    | 기대 work_name | 기대 spec    |
| --- | ------------------------- | -------------- | -------------- | ------------ |
| 1   | "TIG용접 품셈"            | clarify_needed | "TIG용접"      | null         |
| 2   | "강관용접 200mm SCH 40"   | search         | "강관용접"     | "200 SCH 40" |
| 3   | "아까 건 50m 치면 얼마야" | modify_request | null           | null         |
| 4   | "노무비 계산해줘"         | cost_calculate | null           | null         |
| 5   | "산출서 만들어줘"         | report_request | null           | null         |
| 6   | "8인치 배관 용접"         | clarify_needed | "강관용접"     | "200"        |
| 7   | "200파이 SCH 40"          | search         | "강관용접"     | "200 SCH 40" |
| 8   | "그거 말고 TIG로 해줘"    | modify_request | "TIG용접"      | null         |
| 9   | "특별인부 빼면 얼마야"    | modify_request | null           | null         |
| 10  | "20개소로 바꿔줘"         | modify_request | null           | null         |
