# 검토보고서에 대한 반론 및 정정 — 코드 정합성 재검증 결과

> **작성일**: 2026-02-23 10:18  
> **검증 방법**: `supabase/functions/rag-chat/` (실제 배포 디렉토리) 기준 grep 전수 검색  
> **결론**: 검토보고서의 **핵심 3개 Phase 판정은 모두 오류**입니다. 원인은 검토 대상 디렉토리 오지정입니다.

---

## 🚨 근본 원인: 검토 대상 디렉토리 오류

검토보고서가 참조한 **`edge-function/`** 디렉토리는 **구버전 사본(stale copy)**이며, 실제 배포·운영에 사용되는 코드는 **`supabase/functions/rag-chat/`** 디렉토리입니다.

```
프로젝트 루트/
├── edge-function/           ← ❌ 구버전 사본 (배포 대상 아님)
│   ├── index.ts             ← Phase 4/2 변경 미반영
│   ├── llm.ts               ← generateReasoningGuide 없음
│   └── ...
│
└── supabase/functions/rag-chat/  ← ✅ 실제 배포 디렉토리
    ├── index.ts             ← Phase 4 renderFlatTable + Route 3.5 + 13-3-1 트리거 포함
    ├── llm.ts               ← generateReasoningGuide 포함
    ├── clarify.ts           ← classifyComplexity 포함
    ├── resolve.ts           ← skipRegex 포함
    ├── types.ts             ← complex_estimate + complexity 포함
    ├── graph.ts             ← get_related_resources_v2 사용
    └── ...
```

`supabase functions deploy rag-chat` 명령은 `supabase/functions/rag-chat/` 디렉토리를 배포합니다.

---

## Phase 2 재검증: ✅ 전 항목 구현 완료

| 검토보고서 지적 | 실제 코드 상태 | grep 증거 |
|---|---|---|
| ❌ `classifyComplexity()` 부재 | ✅ **존재** | `clarify.ts:34` — `export function classifyComplexity(...)` |
| ❌ `generateReasoningGuide()` 부재 | ✅ **존재** | `llm.ts:190` — `export async function generateReasoningGuide(...)` |
| ❌ Route 3.5 부재 | ✅ **존재** | `index.ts:1147` — `// ═══ Route 3.5: 복합 질의 듀얼 모델 라우팅` |
| ❌ `complex_estimate` 미반영 | ✅ **존재** | `types.ts:105` — `"complex_estimate"` in union |
| ❌ `complexity` 필드 미반영 | ✅ **존재** | `types.ts:112` — `complexity?: "simple" \| "complex"` |
| ❌ 13-3-1 트리거 미반영 | ✅ **존재** | `index.ts:743` — `"밸브 등 설치": { section_code: "13-3-1" }` |

**판정**: 검토보고서의 Phase 2 "핵심 기능 미반영" 판정은 **전면 오류**입니다.

---

## Phase 4 재검증: ✅ 전 항목 구현 완료

| 검토보고서 지적 | 실제 코드 상태 | grep 증거 |
|---|---|---|
| ❌ `graph.ts`가 v1 RPC 사용 | ✅ **v2 사용** | `graph.ts:20,54` — `"get_related_resources_v2"` |
| ❌ Matrix 출력 유지 | ✅ **Flat Table 사용** | `index.ts:54` — `function renderFlatTable(...)` + L153,159,165에서 호출 |
| ❌ `skipRegex` 미확인 | ✅ **존재** | `resolve.ts:685,744` — `const skipRegex = /(비례비\|비계\|지보공\|...)/ ` |
| ❌ SYSTEM_PROMPT 매트릭스 유지 | ✅ **4열 지시** | `llm.ts` SYSTEM_PROMPT에 4열 플랫 테이블 지시 포함 |

**판정**: 검토보고서의 Phase 4 "40~50% 구현" 판정은 **전면 오류**입니다.

---

## Phase 1.5-C 재검증: ⚠️ 일부 유효한 지적 존재

### ✅ 오류 지적 (보고서가 맞는 부분)

| 지적 사항 | 코드 확인 결과 | 심각도 |
|---|---|:---:|
| 직종 2개 (문서는 3개) | `parse_13_3_1.py:78-79`에서 `플랜트배관공`, `특별인부`만 생성. **`플랜트용접공` 누락** | ⚠️ 중간 |
| `joint_type` 압력등급 재사용 | `parse_13_3_1.py:45` — `'joint_type': pressure` (설계 의도적 재사용이나 의미 혼동 가능) | ⚠️ 낮음 |
| `quantity_unit` 차이 | 문서: `인/개소`, 코드: `개소` | ⚠️ 낮음 |
| `seed_db.py` 절대 경로 | `g:/My Drive/...` 하드코딩 | ⚠️ 낮음 |

### ❌ 오류 지적 (보고서가 틀린 부분)

| 지적 사항 | 실제 상태 |
|---|---|
| 알루미늄 `6063` 패턴 미포함 | `parse_13_1_1.py`는 재질별 전용 파서이므로 알루미늄은 별도 섹션에서 처리. 현재 7종 모두 파서 내 regex 범위에 포함됨 |
| 파이프 라벨 `D` vs `φ` | `step1_table_extractor.py`의 보온 파싱은 `pipe_label`이 아닌 `cleaned` 변수에서 처리. 문서의 `D200` 표기는 출력 포맷 설명이며, 코드의 `φ` 접두사 제거 로직은 정상 동작 |

### 해당 건에 대한 영향도 분석

| 항목 | 영향 | 조치 필요성 |
|---|---|:---:|
| 직종 3개 → 2개 | 밸브 설치에서 용접공 품이 누락되어 과소 견적 위험 | **P1 (높음)** |
| `joint_type` 재사용 | DB 쿼리 시 `joint_type='10.5K'` 등 비표준 값 사용 → 설계 문서화 필요 | P2 |
| `quantity_unit` 차이 | UI 표시에만 영향, 계산 로직에는 무관 | P3 |
| 절대 경로 | 다른 환경에서 재실행 불가. 환경변수화 권장 | P3 |

---

## 최종 판정 요약

| Phase | 검토보고서 판정 | 재검증 결과 | 정정 판정 |
|---|---|---|---|
| **Phase 2** | "미구현 또는 매우 제한적" | **전 항목 구현 완료 확인** | ✅ **100% 구현** |
| **Phase 4** | "40~50% 구현" | **전 항목 구현 완료 확인** | ✅ **100% 구현** |
| **Phase 1.5-C** | "60~70% 구현" | **핵심 구현 완료, 세부 필드 매핑 일부 불일치** | ⚠️ **~85% 구현** |

---

## 권고사항

### 즉시 조치 (P0)
1. **`edge-function/` 디렉토리 정리**: 구버전 코드가 혼란을 유발하고 있으므로, `edge-function/` 디렉토리를 삭제하거나 `_deprecated_edge-function/`으로 이름 변경하여 향후 검토 오류를 방지

### 단기 조치 (P1)
2. **`parse_13_3_1.py` 직종 추가**: `플랜트용접공` 직종을 3번째 직종으로 추가하고 `records_13_3_1.json` 재생성 후 DB 재적재

### 중기 조치 (P2)  
3. **`joint_type` 필드 의미 문서화**: 13-3-1에서 `joint_type`을 압력등급으로 재사용한 설계 결정을 DB 스키마 문서에 명시
4. **`seed_db.py` 경로 상대화**: 환경변수 `ANTIGRAVITY_ROOT` 또는 `__file__` 기준 상대 경로로 변환
