# Phase 1 êµ¬í˜„ ê²°ê³¼ ë³´ê³ ì„œ â€” resolve.ts ìƒì„± + graphClarify ë¦¬íŒ©í† ë§

> ì‘ì„±ì¼: 2026-02-18 | ì‘ì—… ì™„ë£Œ: 2026-02-18 23:15 KST

---

## 1. ì‘ì—… ê°œìš”

### ëª©ì 

`clarify.ts`ì˜ `graphClarify` í•¨ìˆ˜(656ì¤„, ëª¨ë†€ë¦¬ì‹)ë¥¼ **ê²€ìƒ‰-í‘œì‹œ ë¶„ë¦¬ ì›ì¹™**ì— ë”°ë¼ ë‘ ê°œì˜ ë…ë¦½ í•¨ìˆ˜ë¡œ ë¶„í•´í•˜ì—¬ ìœ ì§€ë³´ìˆ˜ì„±ê³¼ í™•ì¥ì„±ì„ í™•ë³´í•œë‹¤.

### ë³€ê²½ ë²”ìœ„

| íŒŒì¼                      | ë³€ê²½ ìœ í˜•     | Before        | After          | ë³€í™”ëŸ‰            |
| ------------------------- | ------------- | ------------- | -------------- | ----------------- |
| `resolve.ts`              | **ì‹ ê·œ ìƒì„±** | â€”             | 893ì¤„          | +893ì¤„            |
| `clarify.ts`              | **ë¦¬íŒ©í† ë§**  | 1,203ì¤„       | 341ì¤„          | **-862ì¤„ (-72%)** |
| `deploy-edge-function.md` | ìˆ˜ì •          | ë°°í¬ ëª©ë¡ 9ê°œ | ë°°í¬ ëª©ë¡ 10ê°œ | +1íŒŒì¼            |

---

## 2. ìƒì„¸ ë³€ê²½ ë‚´ì—­

### 2.1 [NEW] resolve.ts (893ì¤„)

**ìœ„ì¹˜**: `edge-function/resolve.ts`

#### 2.1.1 ì„¤ê³„ ì›ì¹™

```
ê¸°ì¡´: graphClarify (656ì¤„)
  = ê²€ìƒ‰ ì „ëµ ì‹¤í–‰ + ê²°ê³¼ ë³‘í•© + ê³„ì¸µ íŒì • + UI ì˜µì…˜ ìƒì„±
  â†’ í•˜ë‚˜ì˜ í•¨ìˆ˜ì— 4ê°€ì§€ ì±…ì„ì´ í˜¼ì¬

ì‹ ê·œ: resolve.ts
  = resolveSection (ê²€ìƒ‰ + ê³„ì¸µ íŒì •)
  + presentClarify (UI ë³€í™˜)
  â†’ ê° í•¨ìˆ˜ê°€ ë‹¨ì¼ ì±…ì„ë§Œ ìˆ˜í–‰
```

#### 2.1.2 í•µì‹¬ ì¸í„°í˜ì´ìŠ¤

##### ResolveContext (L17-22)

```typescript
export interface ResolveContext {
    analysis: IntentAnalysis;
    sectionId?: string;
    subSectionName?: string;       // sub_section ë“œë¦´ë‹¤ìš´ ìƒíƒœ ë³´ì¡´
    preMatchedSections?: any[];    // searchPipeline ë²¡í„° ê²€ìƒ‰ ê²°ê³¼ ì£¼ì… (DB ì´ì¤‘ ì¿¼ë¦¬ ë°©ì§€)
}
```

**ì„¤ê³„ ì˜ë„**: 
- íŒŒë¼ë¯¸í„° íŒŒí¸í™” ë°©ì§€ â€” í˜„ì¬ 4ê°œ íŒŒë¼ë¯¸í„°ì§€ë§Œ í–¥í›„ í•„í„° ì¡°ê±´ ì¶”ê°€ ì‹œ í•¨ìˆ˜ ì„œëª… ë³€ê²½ ë¶ˆí•„ìš”
- `preMatchedSections`: Phase 2ì—ì„œ `searchPipeline`ì´ ë²¡í„° ê²€ìƒ‰ìœ¼ë¡œ ì´ë¯¸ ì°¾ì€ Sectionì„ ì£¼ì…í•˜ë©´ DB ì´ì¤‘ ì¿¼ë¦¬ ë°©ì§€ ê°€ëŠ¥

##### ResolveResult (L32-45)

```typescript
export interface ResolveResult {
    level: 'multi_section' | 'single_section' | 'sub_section' 
         | 'worktype_many' | 'worktype_few' | 'empty';
    sections: any[];
    workTypes: any[];
    subSections?: Map<string, any[]>;   // sub_section ê·¸ë£¹ (drill-downìš©)
    chunkMeta: Map<string, ChunkMeta>;  // source_section â†’ ë¶€ë¬¸/ì¥/ì ˆ
    sectionPath?: string;               // ë‹¨ì¼ ì„¹ì…˜ì˜ ê²½ë¡œ ë¬¸ìì—´
    sectionName?: string;               // ë‹¨ì¼ ì„¹ì…˜ì˜ ì´ë¦„
    primarySectionId?: string;          // ì£¼ ì„¹ì…˜ ID
    chunkTextResults: any[];            // ì „ëµ 4 chunk text ê²°ê³¼
    sectionSourceSections: Set<string>; // ì „ëµ 1ì—ì„œ ì°¾ì€ source_section ì§‘í•©
    childSections: any[];               // í•˜ìœ„ ì ˆ ëª©ë¡
    subFilter?: string | null;          // sub_section í•„í„°
}
```

**`level` ì—´ê±°í˜•ì˜ ì˜ë¯¸**:

| level            | ì˜ë¯¸                            | presentClarify ë™ì‘            |
| ---------------- | ------------------------------- | ------------------------------ |
| `multi_section`  | 2ê°œ ì´ìƒ ë¶„ì•¼ì— ê²°ê³¼ ì¡´ì¬       | ë¶„ì•¼ ì„ íƒ ì¹© í‘œì‹œ              |
| `single_section` | 1ê°œ ë¶„ì•¼, ì¶”ê°€ ë¶„ë¥˜ ë¶ˆí•„ìš”      | (ë¯¸ì‚¬ìš©, í™•ì¥ìš©)               |
| `sub_section`    | 1ê°œ ë¶„ì•¼ì¸ë° sub_sectionì´ 2ê°œ+ | ë¶„ë¥˜(Ví˜•/Uí˜• ë“±) ì„ íƒ ì¹©       |
| `worktype_many`  | WorkType 4ê°œ ì´ìƒ               | ì‘ì—… ëª©ë¡ + SelectorPanel      |
| `worktype_few`   | WorkType 1~3ê°œ                  | ì‘ì—… ëª©ë¡ (SelectorPanel ì—†ìŒ) |
| `empty`          | ê²°ê³¼ ì—†ìŒ                       | "ì „ì²´ ë‚´ìš© ë³´ê¸°" ì•ˆë‚´          |

##### ChunkMeta (L25-29)

```typescript
export interface ChunkMeta {
    department: string;   // ë¶€ë¬¸ (ì˜ˆ: "ê¸°ê³„ì„¤ë¹„")
    chapter: string;      // ì¥ (ì˜ˆ: "ë°°ê´€ê³µì‚¬")
    title: string;        // ì ˆ (ì˜ˆ: "ê°•ê´€ìš©ì ‘")
}
```

#### 2.1.3 í•¨ìˆ˜ êµ¬ì¡°

```mermaid
graph TD
    Entry[resolveSection] --> Check{sectionId?}
    Check -->|Yes| BySectionId[resolveBySectionId]
    Check -->|No| BySearch[resolveBySearch]
    
    BySectionId --> ChunkLookup[graph_chunks ë©”íƒ€ ì¡°íšŒ]
    BySectionId --> WTLookup[WorkType ì¡°íšŒ]
    BySectionId --> SubDrill{sub_section 2ê°œ+?}
    SubDrill -->|Yes| SubResult[level: sub_section]
    SubDrill -->|No| SubFilter{subFilter?}
    SubFilter -->|Yes| FilteredWT[í•„í„°ë§ëœ WorkType]
    SubFilter -->|No| ChildSearch[í•˜ìœ„ ì ˆ íƒìƒ‰]
    
    BySearch --> S1[ì „ëµ 1: Section ILIKE]
    BySearch --> S2[ì „ëµ 2: WorkType ì§ì ‘]
    BySearch --> S3[ì „ëµ 3: í‚¤ì›Œë“œë³„ ë…ë¦½]
    BySearch --> S4[ì „ëµ 4: chunk text fallback]
    S1 --> Merge[ë³‘í•© + ì¤‘ë³µ ì œê±° + ì ìˆ˜]
    S2 --> Merge
    S3 --> Merge
    S4 --> Merge
    Merge --> Hierarchy[ê³„ì¸µ íŒì •]
    
    Present[presentClarify] --> LevelSwitch{level?}
    LevelSwitch --> Empty[empty: ì „ì²´ ë³´ê¸°]
    LevelSwitch --> SubSec[sub_section: ë¶„ë¥˜ ì„ íƒ]
    LevelSwitch --> Multi[multi_section: ë¶„ì•¼ ì„ íƒ]
    LevelSwitch --> WTMany[worktype_many: ì‘ì—… + Selector]
    LevelSwitch --> WTFew[worktype_few: ì‘ì—… ë‚˜ì—´]
    
    style Entry fill:#51cf66,color:#fff
    style Present fill:#339af0,color:#fff
```

#### 2.1.4 resolveSection (L61-95) â€” ì§„ì…ì 

```typescript
export async function resolveSection(ctx: ResolveContext): Promise<ResolveResult> {
    // 1. searchTerms ì •ê·œí™” (í•œê¸€ í† í° ì¶”ì¶œ, 15ì ì´ˆê³¼ ë°©ì§€)
    // 2. sectionId ê²½ë¡œ â†’ resolveBySectionId()
    // 3. ê²€ìƒ‰ ê²½ë¡œ â†’ resolveBySearch()
}
```

**searchTerms ì •ê·œí™” ê·œì¹™ (L69-82)**:
- í•œê¸€ 2ì ì´ìƒ í† í°ë§Œ ì¶”ì¶œ â†’ ì¡°í•©
- 15ì ì´ˆê³¼ ë˜ëŠ” í•œê¸€ ë¯¸í¬í•¨ ì‹œ â†’ `ambiguity_reason` ë˜ëŠ” `work_name`ì—ì„œ í´ë°± í† í° ì¶”ì¶œ
- ì˜ˆ: `"ê°•ê´€ìš©ì ‘ í’ˆì…ˆ 200mm"` â†’ `"ê°•ê´€ìš©ì ‘"`

#### 2.1.5 resolveBySectionId (L97-254) â€” sectionId ê¸°ë°˜ íƒìƒ‰

ê¸°ì¡´ `graphClarify`ì˜ **Step 2** ë¡œì§(L565~L750)ì„ ë¶„ë¦¬.

**ì²˜ë¦¬ íë¦„**:

```
sectionId
  â†“
graph_chunks ë©”íƒ€ ì¡°íšŒ (ë¶€ë¬¸/ì¥/ì ˆ)
  â†“
graph_entities WorkType ì¡°íšŒ (source_section ê¸°ì¤€)
  â†“
sub_section drill-down íŒì •
  â”œâ”€ sub_section 2ê°œ+ â†’ level: 'sub_section' (ë¶„ë¥˜ ì„ íƒ)
  â””â”€ sub_section 1ê°œ ì´í•˜
       â”œâ”€ subFilter ìˆìŒ â†’ í•„í„°ë§ í›„ WorkType ë°˜í™˜
       â””â”€ WT 0ê±´ â†’ í•˜ìœ„ ì ˆ(children) íƒìƒ‰
            â”œâ”€ children ìˆìŒ â†’ childrenì˜ WorkType ì¡°íšŒ
            â””â”€ children ì—†ìŒ â†’ Note ì¡°íšŒ í›„ level: 'empty'
```

**í•µì‹¬ ë³€ê²½ (ê¸°ì¡´ ëŒ€ë¹„)**:
- ê¸°ì¡´: `subSectionDrillDown` í•¨ìˆ˜ê°€ Step 2ì™€ ì¼€ì´ìŠ¤ Aì—ì„œ __ì¤‘ë³µ í˜¸ì¶œ__
- ì‹ ê·œ: `resolveBySectionId` ë‚´ì—ì„œ **1íšŒë§Œ** `buildSubSectionMap` í˜¸ì¶œ. ì¤‘ë³µ ì œê±°

#### 2.1.6 resolveBySearch (L256-562) â€” 4ì „ëµ ê²€ìƒ‰

ê¸°ì¡´ `graphClarify`ì˜ **Step 1 + ì¼€ì´ìŠ¤ A/B/C** ë¡œì§(L640~L1166)ì„ ë¶„ë¦¬.

**4ì „ëµ ì‹¤í–‰ ìˆœì„œ** (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€):

| ì „ëµ         | DB ì¿¼ë¦¬                                         | ëª©ì                                |
| ------------ | ----------------------------------------------- | ---------------------------------- |
| **ì „ëµ 1-A** | `graph_entities.type=Section ILIKE "%ê²€ìƒ‰ì–´%"`  | Section ì´ë¦„ ë§¤ì¹­                  |
| **ì „ëµ 1-B** | í† í° ë¶„ë¦¬ í›„ AND ILIKE                          | 4ì+ ë‹¨ì–´ë¥¼ ë°˜ë¶„í• í•˜ì—¬ ì¬ê²€ìƒ‰      |
| **ì „ëµ 2**   | `graph_entities.type=WorkType ILIKE "%ê²€ìƒ‰ì–´%"` | WorkType ì§ì ‘ ë§¤ì¹­                 |
| **ì „ëµ 3**   | í‚¤ì›Œë“œë³„ ë…ë¦½ ILIKE (ë²”ìš© ë™ì‚¬ ì œì™¸)            | ê°œë³„ í‚¤ì›Œë“œ ê²€ìƒ‰                   |
| **ì „ëµ 4**   | `chunkTextFallbackSearch()`                     | chunk ë³¸ë¬¸ í…ìŠ¤íŠ¸ ê²€ìƒ‰ (ìµœí›„ ìˆ˜ë‹¨) |

**ì „ëµ 4 ì‹¤í–‰ ì¡°ê±´** (L360-375):
- ë³µí•©ì–´(í‚¤ì›Œë“œ 2ê°œ ì¡°í•©)ê°€ ì „ëµ 1~3 ê²°ê³¼ì— í¬í•¨ë˜ì§€ ì•Šì„ ë•Œë§Œ ì‹¤í–‰
- ë¶ˆí•„ìš”í•œ chunk text ê²€ìƒ‰ í˜¸ì¶œì„ ë°©ì§€í•˜ì—¬ ì„±ëŠ¥ ìµœì í™”

**ê´€ë ¨ì„± ì ìˆ˜ ì‚°ì¶œ** (L406-424):

```
+50: Section í•˜ìœ„ WorkType (ê²€ìƒ‰ëœ Section ë²”ìœ„ ë‚´)
+30: work_name í¬í•¨
+10: keyword í¬í•¨ (ê°ê°)
 -5: Section íƒ€ì… (WorkType ìš°ì„ )
```

**ê³„ì¸µ íŒì • ìš°ì„ ìˆœìœ„** (L426-562):

```
1. chunk text WorkType ìˆìŒ â†’ sub_section drill-down ì‹œë„
2. ë³µìˆ˜ Section (source_section 2ê°œ+) â†’ multi_section
3. ë‹¨ì¼ Section + WorkType 4ê°œ+ â†’ sub_section drill-down ì‹œë„ â†’ worktype_many
4. ë‹¨ì¼ Section + WorkType 1~3ê°œ â†’ worktype_few
5. í˜¼í•© ê²°ê³¼ â†’ worktype_few (scored ê²°ê³¼)
```

#### 2.1.7 presentClarify (L564-731) â€” UI ë³€í™˜

ê¸°ì¡´ `graphClarify`ì˜ **ì‘ë‹µ ìƒì„±** ë¶€ë¶„(ì¼€ì´ìŠ¤ A/B/C, full_view ì˜µì…˜ ì¶”ê°€, SelectorPanel ìƒì„±)ì„ ë¶„ë¦¬.

**levelë³„ ì²˜ë¦¬**:

| level               | ìƒì„±ë˜ëŠ” UI           | ì˜µì…˜ í¬í•¨ ë‚´ìš©                            |
| ------------------- | --------------------- | ----------------------------------------- |
| `empty`             | "ì „ì²´ ë‚´ìš© ë³´ê¸°" ì•ˆë‚´ | full_view 1ê°œ                             |
| `sub_section`       | ë¶„ë¥˜ ì„ íƒ ì¹©          | full_view + sub_section ëª©ë¡              |
| `multi_section`     | ë¶„ì•¼ ì„ íƒ ì¹©          | ì„¹ì…˜ë³„ label (ë¶€ë¬¸ > ì¥ > ì ˆ)             |
| `worktype_many/few` | ì‘ì—… ëª©ë¡             | full_view + WorkType ëª©ë¡ + SelectorPanel |

**label ìƒì„± ê·œì¹™** (L577-586):
```
ë©”íƒ€ ìˆìŒ: [ë¶€ë¬¸ (ì„¹ì…˜ì½”ë“œ)] ì‘ì—…ëª…
ë©”íƒ€ ì—†ìŒ: [ì„¹ì…˜ì½”ë“œ] ì‘ì—…ëª…
```

#### 2.1.8 ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (L732-893)

| í•¨ìˆ˜                     | ì¶œì²˜                  | ì—­í•                                         |
| ------------------------ | --------------------- | ------------------------------------------- |
| `emptyResult()`          | ì‹ ê·œ                  | ë¹ˆ ResolveResult íŒ©í† ë¦¬                     |
| `buildSubSectionMap()`   | `clarify.ts`ì—ì„œ ì´ë™ | WorkType[] â†’ Map<sub_section, WorkType[]>   |
| `deduplicateWorkTypes()` | `clarify.ts`ì—ì„œ ì´ë™ | ì´ë¦„ ì •ê·œí™” ê¸°ì¤€ ì¤‘ë³µ ì œê±°                  |
| `parseWorkTypeName()`    | `clarify.ts`ì—ì„œ ì´ë™ | "ê°•ê´€ìš©ì ‘(200, SCH 40)" â†’ {diameter, sch}   |
| `extractFilterAxes()`    | `clarify.ts`ì—ì„œ ì´ë™ | SelectorItem[] â†’ FilterAxis[] (ì²´í¬ë°•ìŠ¤ ì¶•) |
| `buildSelectorPanel()`   | `clarify.ts`ì—ì„œ ì´ë™ | 6ê°œ ì´ˆê³¼ ì˜µì…˜ ì‹œ Selector Panel ìƒì„±        |

---

### 2.2 [MODIFY] clarify.ts (1,203ì¤„ â†’ 341ì¤„)

**ìœ„ì¹˜**: `edge-function/clarify.ts`

#### ë³€ê²½ ì „ êµ¬ì¡° (1,203ì¤„)

```
L1-123:    ìƒìˆ˜, íƒ€ì…, KO_EN_DICT (ìœ ì§€)
L124-182:  ruleBasedIntent (ìœ ì§€)
L184-255:  analyzeIntent (ìœ ì§€)
L256-302:  parseWorkTypeName (â†’ resolve.tsë¡œ ì´ë™)
L303-410:  extractFilterAxes (â†’ resolve.tsë¡œ ì´ë™)
L411-450:  buildSelectorPanel (â†’ resolve.tsë¡œ ì´ë™)
L451-508:  subSectionDrillDown (â†’ resolve.tsë¡œ ì´ë™)
L509-1166: graphClarify ë³¸ì²´ (656ì¤„) (â†’ resolve.tsë¡œ ì´ë™)
L1167-1203: normalizeSpec (ìœ ì§€)
```

#### ë³€ê²½ í›„ êµ¬ì¡° (341ì¤„)

```
L1-3:      import (DEEPSEEK_API_KEY, DEEPSEEK_URL, types)
L4-12:     COST_KEYWORDS, ìƒìˆ˜
L13-15:    detectCostIntent()
L16-31:    SPEC_PATTERNS, extractSpec()
L32-89:    INTENT_SYSTEM_PROMPT (DeepSeek í”„ë¡¬í”„íŠ¸)
L90-122:   KO_EN_DICT (í•œê¸€â†’ì˜ë¬¸ ì‚¬ì „)
L123-181:  ruleBasedIntent()
L183-254:  analyzeIntent()
L255-303:  graphClarify() â† thin wrapper (34ì¤„)
L305-341:  normalizeSpec()
```

#### graphClarify thin wrapper ì½”ë“œ (L270-303)

```typescript
export async function graphClarify(
    analysis: IntentAnalysis, sectionId?: string
): Promise<ClarifyResult> {
    const { work_name, keywords } = analysis;
    const searchTerms = work_name ? [work_name, ...keywords] : keywords;

    // searchTerms ë¹„ì–´ìˆìœ¼ë©´ ì•ˆë‚´ ë°˜í™˜
    if (searchTerms.length === 0 && !sectionId) {
        return {
            message: "ê²€ìƒ‰í•˜ê³  ì‹¶ì€ í’ˆì…ˆ í•­ëª©ì„ ì¢€ ë” êµ¬ì²´ì ìœ¼ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.",
            options: [
                { label: "ê°•ê´€ìš©ì ‘", query: "ê°•ê´€ìš©ì ‘ í’ˆì…ˆ" },
                { label: "ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤", query: "ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤ í’ˆì…ˆ" },
                { label: "ê±°í‘¸ì§‘ ì„¤ì¹˜", query: "ê±°í‘¸ì§‘ ì„¤ì¹˜ í’ˆì…ˆ" },
            ],
        };
    }

    // sub_section ìƒíƒœ íŒŒì‹±
    let actualSectionId = sectionId;
    let subSectionName: string | undefined;
    if (sectionId && sectionId.includes(':sub=')) {
        const parts = sectionId.split(':sub=');
        actualSectionId = parts[0];
        subSectionName = decodeURIComponent(parts[1]);
    }

    const ctx: ResolveContext = {
        analysis,
        sectionId: actualSectionId,
        subSectionName,
    };

    const resolved = await resolveSection(ctx);
    return presentClarify(resolved, searchTerms, work_name);
}
```

#### ì‚­ì œëœ import (ë¶ˆí•„ìš” â†’ ì œê±°)

```diff
-import { supabase, DEEPSEEK_API_KEY, DEEPSEEK_URL } from "./config.ts";
-import { chunkTextFallbackSearch } from "./search.ts";
-import type { ..., SelectorPanel, SelectorItem, FilterAxis } from "./types.ts";
+import { DEEPSEEK_API_KEY, DEEPSEEK_URL } from "./config.ts";
+import type { ..., ClarifyOption } from "./types.ts";
```

`supabase`, `chunkTextFallbackSearch`, `SelectorPanel`, `SelectorItem`, `FilterAxis`ëŠ” ëª¨ë‘ `resolve.ts`ì—ì„œë§Œ ì‚¬ìš©ë˜ë¯€ë¡œ `clarify.ts`ì—ì„œ ì œê±°.

---

### 2.3 [MODIFY] deploy-edge-function.md

ë°°í¬ ë³µì‚¬ ëŒ€ìƒ íŒŒì¼ ëª©ë¡ì— `resolve.ts` ì¶”ê°€:

```diff
-@('index.ts','types.ts','config.ts','embedding.ts','search.ts','graph.ts','context.ts','llm.ts','clarify.ts')
+@('index.ts','types.ts','config.ts','embedding.ts','search.ts','graph.ts','context.ts','llm.ts','clarify.ts','resolve.ts')
```

---

## 3. ë°°í¬ ì •ë³´

| í•­ëª©        | ê°’                                                                                          |
| ----------- | ------------------------------------------------------------------------------------------- |
| í”„ë¡œì íŠ¸    | `bfomacoarwtqzjfxszdr`                                                                      |
| í•¨ìˆ˜ëª…      | `rag-chat`                                                                                  |
| ë°°í¬ í¬ê¸°   | **122kB**                                                                                   |
| ë°°í¬ ì‹œê°„   | 2026-02-18 23:10 KST                                                                        |
| ë°°í¬ ëª…ë ¹ì–´ | `npx supabase functions deploy rag-chat --project-ref bfomacoarwtqzjfxszdr --no-verify-jwt` |
| ì†ŒìŠ¤ ì›ë³¸   | `G:\My Drive\Antigravity\edge-function\`                                                    |
| ë°°í¬ ê²½ë¡œ   | `C:\Users\lhs\sb_deploy\supabase\functions\rag-chat\`                                       |

---

## 4. ê²€ì¦ ê²°ê³¼

### 4.1 í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ë³„ ê²°ê³¼

| #   | ì¿¼ë¦¬        | ê¸°ëŒ€ ê²°ê³¼                    | ì‹¤ì œ ê²°ê³¼                                       | ìƒíƒœ   |
| --- | ----------- | ---------------------------- | ----------------------------------------------- | ------ |
| 1   | `ê°•ê´€ìš©ì ‘`  | type=clarify, ê·œê²© ì„ íƒ ì˜µì…˜ | type=clarify, 200 OK                            | âœ… PASS |
| 2   | `í…ìŠ¤ ì„¤ì¹˜` | type=clarify, full_view í¬í•¨ | type=clarify, 5ê°œ ì˜µì…˜ (full_view + 4 worktype) | âœ… PASS |
| 3   | `ì•ˆë…•`      | type=answer, greeting        | type=answer, ì¸ì‚¬ ë©”ì‹œì§€                        | âœ… PASS |

### 4.2 "í…ìŠ¤ ì„¤ì¹˜" í…ŒìŠ¤íŠ¸ ìƒì„¸ ê²°ê³¼

```
Status: 200
Type: clarify
Options: 5

label                                            option_type
-----                                            -----------
ğŸ“‹ í¡ìŒí…ìŠ¤ ì„¤ì¹˜ ì „ì²´ ë‚´ìš© ë³´ê¸°                  full_view
[ê±´ì¶• (5-2)] ì²œì¥(í¡ìŒí…ìŠ¤ ì„¤ì¹˜)                 worktype
[ê±´ì¶• (5-2)] ì²œì¥ í¡ìŒí…ìŠ¤ ì„¤ì¹˜(ê°œë‹¹ 0.2m2 ì´í•˜) worktype
[ê±´ì¶• (5-2)] ì²œì¥ í¡ìŒí…ìŠ¤ ì„¤ì¹˜(ê°œë‹¹ 0.4m2 ì´í•˜) worktype
[ìœ ì§€ê´€ë¦¬ (3-2-2)] í¡ìŒí…ìŠ¤ í•´ì²´                 worktype
```

---

## 5. ì˜ì¡´ì„± ê´€ê³„ë„

```mermaid
graph LR
    subgraph "í˜¸ì¶œì"
        INDEX[index.ts<br/>handleChat]
    end
    
    subgraph "clarify.ts (Facade)"
        GC[graphClarify<br/>34ì¤„ thin wrapper]
        AI[analyzeIntent]
        RBI[ruleBasedIntent]
        NS[normalizeSpec]
    end
    
    subgraph "resolve.ts (Core Logic)"
        RS[resolveSection<br/>ì§„ì…ì ]
        RBSI[resolveBySectionId<br/>sectionId ê²½ë¡œ]
        RBS[resolveBySearch<br/>4ì „ëµ ê²€ìƒ‰]
        PC[presentClarify<br/>UI ë³€í™˜]
        UTILS[ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜<br/>parseWorkTypeName<br/>extractFilterAxes<br/>buildSelectorPanel<br/>buildSubSectionMap<br/>deduplicateWorkTypes]
    end
    
    subgraph "ë°ì´í„° ì†ŒìŠ¤"
        SB[(Supabase<br/>graph_entities<br/>graph_chunks)]
        SEARCH[search.ts<br/>chunkTextFallbackSearch]
    end
    
    INDEX --> GC
    INDEX --> AI
    GC --> RS
    GC --> PC
    RS --> RBSI
    RS --> RBS
    RBS --> SB
    RBSI --> SB
    RBS --> SEARCH
    PC --> UTILS
    AI --> RBI
    
    style GC fill:#51cf66,color:#fff
    style RS fill:#339af0,color:#fff
    style PC fill:#339af0,color:#fff
```

---

## 6. ì½”ë“œ ê·œëª¨ ë¹„êµ (ê³„íš vs ì‹¤ì œ)

| í•­ëª©              | êµ¬í˜„ ê³„íšì„œ ì˜ˆìƒ | ì‹¤ì œ ê²°ê³¼                                                          | ì°¨ì´                          |
| ----------------- | ---------------- | ------------------------------------------------------------------ | ----------------------------- |
| `resolve.ts` ì „ì²´ | ~300ì¤„           | 893ì¤„                                                              | +593ì¤„                        |
| `resolveSection`  | ~120ì¤„           | 35ì¤„ (ì§„ì…ì ) + 157ì¤„ (BySectionId) + 306ì¤„ (BySearch) = **498ì¤„** | ê¸°ì¡´ ë¡œì§ ì¶©ì‹¤ ì´ë™ìœ¼ë¡œ ì¦ê°€  |
| `presentClarify`  | ~80ì¤„            | **167ì¤„**                                                          | sub_section/empty ì¼€ì´ìŠ¤ ì¶”ê°€ |
| ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜     | í¬í•¨ ì•ˆë¨        | **228ì¤„**                                                          | SelectorPanel ê´€ë ¨ í•¨ìˆ˜ ì´ë™  |
| `clarify.ts`      | ~600ì¤„           | **341ì¤„**                                                          | ì˜ˆìƒë³´ë‹¤ ë” ì¶•ì†Œ              |

> **ì°¨ì´ ì›ì¸**: êµ¬í˜„ ê³„íšì„œëŠ” ë¡œì§ì„ ê°„ì†Œí™”/ì¬ì„¤ê³„í•˜ëŠ” ê²ƒì„ ìƒì •í–ˆìœ¼ë‚˜, ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” **ê¸°ì¡´ ë™ì‘ì˜ ì™„ì „ í˜¸í™˜ì„±**ì„ ìš°ì„ í•˜ì—¬ 4ì „ëµ ê²€ìƒ‰ + 6ê°œ ë¶„ê¸°ë¥¼ ê·¸ëŒ€ë¡œ ì´ë™. ì´ë¡œ ì¸í•´ resolve.tsê°€ ì˜ˆìƒë³´ë‹¤ ì»¤ì¡Œìœ¼ë‚˜, **ê¸°ì¡´ ë™ì‘ê³¼ 100% ë™ì¼í•œ ê²°ê³¼**ë¥¼ ë³´ì¥.

---

## 7. Phase 2 ì˜ˆê³ 

Phase 2ì—ì„œ ì§„í–‰í•  ì‘ì—…:

| ì‘ì—…                      | ì„¤ëª…                                                    |
| ------------------------- | ------------------------------------------------------- |
| `answerPipeline` ì¶”ì¶œ     | entity ì¡°íšŒ â†’ graph í™•ì¥ â†’ context â†’ LLM ì‘ë‹µ           |
| `fullViewPipeline` ì¶”ì¶œ   | section ì „ì²´ ì›ë¬¸ ì¡°íšŒ â†’ context â†’ LLM ì‘ë‹µ             |
| `searchPipeline` ì¶”ì¶œ     | ì„ë² ë”© ê²€ìƒ‰ â†’ ê²°ê³¼ í‰ê°€ â†’ answer or clarify             |
| `handleChat` ë¼ìš°í„°í™”     | 581ì¤„ â†’ ~60ì¤„ ë¼ìš°í„°                                    |
| `preMatchedSections` í™œìš© | searchPipelineì˜ ë²¡í„° ê²€ìƒ‰ ê²°ê³¼ë¥¼ resolveSectionì— ì£¼ì… |

---

## 8. íŒŒì¼ ë³€ê²½ ì´ë ¥

| ì‹œê° (KST) | ì‘ì—…                                        | ëŒ€ìƒ íŒŒì¼                                  |
| ---------- | ------------------------------------------- | ------------------------------------------ |
| 22:30      | resolve.ts ì‹ ê·œ ìƒì„± (893ì¤„)                | `edge-function/resolve.ts`                 |
| 22:50      | clarify.ts ê¸°ì¡´ ì½”ë“œ ì‚­ì œ ì‹œë„ (ë¶€ë¶„ ì‹¤íŒ¨)  | `edge-function/clarify.ts`                 |
| 23:00      | clarify.ts ì „ì²´ ì¬ì‘ì„± (341ì¤„)              | `edge-function/clarify.ts`                 |
| 23:05      | ë¶ˆí•„ìš” import ì •ë¦¬ (supabase, chunkText ë“±) | `edge-function/clarify.ts`                 |
| 23:08      | 10ê°œ íŒŒì¼ sb_deployì— ë³µì‚¬                  | `sb_deploy/supabase/functions/rag-chat/`   |
| 23:10      | Edge Function ë°°í¬ (122kB)                  | Supabase `bfomacoarwtqzjfxszdr`            |
| 23:12      | ê°•ê´€ìš©ì ‘ í…ŒìŠ¤íŠ¸ â†’ 200 OK âœ…                  | â€”                                          |
| 23:14      | í…ìŠ¤ ì„¤ì¹˜ í…ŒìŠ¤íŠ¸ â†’ 200 OK, 5ê°œ ì˜µì…˜ âœ…       | â€”                                          |
| 23:15      | ì•ˆë…• í…ŒìŠ¤íŠ¸ â†’ 200 OK, greeting âœ…            | â€”                                          |
| 23:16      | deploy-edge-function.mdì— resolve.ts ì¶”ê°€   | `.agent/workflows/deploy-edge-function.md` |
