# Phase 4C: 다음 단계 실행 계획서

> **작성 일시**: 2026-02-14 09:48 KST  
> **현 상태**: 4C-0(스캔) ✅ → 4C-1(파이프라인 수정) ✅ → **4C-2, 4C-3, 4C-V 대기**  
> **근거**: 4C-0 보고서, 4C-1 결과 보고서

---

## 전체 진행 현황

```
Phase 4C (추출 파이프라인 개선)
│
├─ 4C-0. DB 전수 스캔                    ✅ 완료
│   └─ 38개 섹션, 1,060건 재추출 확정
│
├─ 4C-1. step1_table_extractor.py 수정   ✅ 완료
│   └─ 5개 수정 항목 전부 적용 (+130줄)
│
├─ 4C-2. step6_data_validator.py 작성    ⏳ 다음
│   └─ 5가지 검증 항목 자동화
│
├─ 4C-3. 대상 섹션 재추출                ⏳ 대기
│   └─ 38개 섹션 삭제 → 재추출 → 재삽입
│
└─ 4C-V. 전체 검증 + 챗봇 회귀 테스트    ⏳ 대기
    └─ Validator 실행 + 챗봇 3건 회귀 테스트
```

---

## 4C-2. `step6_data_validator.py` 신규 작성 [예상 30분]

### 목적
재추출 전후의 데이터 정합성을 자동으로 검증하는 독립 스크립트.

### 검증 항목 5가지

| #   | 검증 항목                | SQL 쿼리 대상                                      | Pass 기준           |
| --- | ------------------------ | -------------------------------------------------- | ------------------- |
| 1   | `source_chunk` 기록 여부 | `graph_entities.properties`                        | null 건수 = 0       |
| 2   | 비강관 SCH 잔존 여부     | `graph_entities.name LIKE '%SCH%'`                 | 화이트리스트 외 0건 |
| 3   | chunk 텍스트 비어있는지  | `graph_chunks.text IS NULL OR text = ''`           | 빈 chunk ≤ 10%      |
| 4   | 공백 중복 엔티티         | `REPLACE(name, ' ', '') GROUP BY HAVING count > 1` | 0그룹               |
| 5   | 소제목 미반영            | 13-2-4 엔티티에 V형/U형 접미어                     | 전부 반영           |

### 실행 방식
- Supabase MCP 직접 SQL 실행 (Python 스크립트 대신)
- 결과를 JSON 형식으로 출력

### 산출물
- 검증 결과 보고서 (Pass/Fail 판정)

---

## 4C-3. 대상 섹션 재추출 [예상 1~2시간]

### 전략: 섹션 단위 DELETE → 재추출 → INSERT

```sql
-- Step 1: 해당 섹션의 기존 관계 삭제
DELETE FROM graph_relationships 
WHERE source_id IN (
    SELECT id FROM graph_entities WHERE source_section = :section_id
);

-- Step 2: 해당 섹션의 기존 엔티티 삭제
DELETE FROM graph_entities WHERE source_section = :section_id;

-- Step 3: 수정된 파이프라인으로 재추출 → 재삽입
```

### 재추출 대상 38개 섹션 (우선순위별)

| 우선순위        | 섹션 수 | 건수  | 대표 섹션                                      |
| --------------- | ------- | ----- | ---------------------------------------------- |
| 🔴 P1 (심각)     | 3개     | 225건 | 크러셔, 수치지도, 구획정리                     |
| 🟡 P2 (중간)     | 6개     | 200건 | 냉동기, 지형현황, 송풍기, 도장, 절단, 경지구획 |
| 🔵 P3 (확인완료) | 7개     | 287건 | 응력제거, 유리섬유복합관, 배관보온 등          |
| ⚪ 신규발견      | 22개    | 348건 | 측량류(9장), Boiler, 탑다운 등                 |

### 실행 순서

1. **백업**: 재추출 대상 섹션의 entities + relationships 백업 테이블 생성
2. **P1 3개 섹션 먼저 처리** → 즉시 검증
3. **P2 + P3 처리** → 검증
4. **신규 22개 일괄 처리** → 검증

### 실행 방법 선택지

| 방법                     | 장점                       | 단점                   |
| ------------------------ | -------------------------- | ---------------------- |
| **A. Python 파이프라인** | 자동화, 임베딩 재생성 포함 | 로컬 Python 환경 필요  |
| **B. Supabase SQL 직접** | 환경 무관, 즉시 실행       | 수동 작업, 임베딩 별도 |

> [!IMPORTANT]
> **현재 로컬 Python 실행 환경에 제약이 있으므로**, 방법 B(SQL 직접) 또는 환경 설정 후 방법 A를 선택해야 합니다.

### 재추출 시 주의사항

- 재추출 데이터의 **임베딩(embedding) 컬럼**도 재생성 필요
- Phase 4B에서 수동 패치한 13-2-4 V형/U형 태깅이 파이프라인에 반영되었으므로 **재추출로 자동 적용됨**
- 4개 정상 SCH 섹션(13-2-3, 13-1-1, 13-1-2, 13-2-1)은 **재추출 대상이 아님**

---

## 4C-V. 전체 검증 + 챗봇 회귀 테스트 [예상 30분]

### Validator 실행

`step6_data_validator.py`로 5가지 검증 항목 자동 확인.

### 챗봇 회귀 테스트 (3건)

| #   | 쿼리                            | 기대 결과                      | 검증 포인트         |
| --- | ------------------------------- | ------------------------------ | ------------------- |
| 1   | `강관용접 200mm SCH 40`         | 기존과 동일 (SCH 유지)         | 정상 섹션 보호 확인 |
| 2   | `크러셔 100`                    | SCH 없이 `크러셔(100, 139076)` | SCH 오기 제거 확인  |
| 3   | `강판 전기아크용접 V형 두께 10` | `-V형` 접미어 포함             | 소제목 반영 확인    |

### 성공 기준

| 기준                                     | 측정 방법         |
| ---------------------------------------- | ----------------- |
| `source_chunk` 기록률 100% (재추출 섹션) | Validator 검증 #1 |
| 비강관 SCH 잔존 0건                      | Validator 검증 #2 |
| chunk 텍스트 커버리지 ≥ 90%              | Validator 검증 #3 |
| 회귀 테스트 3건 Pass                     | 챗봇 테스트       |

---

## 의사결정 필요 사항

> [!CAUTION]
> 다음 단계 진행 전 결정이 필요합니다.

### 1. 재추출 실행 방식

- **A. Python 파이프라인**: `python step1_table_extractor.py` → 자동 추출. 로컬 환경 필요
- **B. SQL 직접 수정**: Supabase MCP로 SCH 이름 일괄 UPDATE. 빠르지만 부분적 해결

### 2. 임베딩 재생성

- 이름 변경 엔티티만 재생성? 전체 재생성?
- `step3_embedder.py` 사용? 별도 방법?

### 3. 실행 시점

- 현 세션에서 계속?
- 별도 세션에서 실행?

---

## 예상 소요 시간

| 단계                     | 소요 시간 | 누적       |
| ------------------------ | --------- | ---------- |
| 4C-2 Validator           | 30분      | 30분       |
| 4C-3 재추출 (P1 우선)    | 1시간     | 1시간 30분 |
| 4C-3 재추출 (P2+P3+신규) | 1시간     | 2시간 30분 |
| 4C-V 검증                | 30분      | 3시간      |
| **합계**                 |           | **~3시간** |
