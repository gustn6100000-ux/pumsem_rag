# 2026-02-26 종합 시스템 감사 및 개선 계획서

> **작성일**: 2026-02-26  
> **작성자**: Antigravity AI Architect  
> **검토 영역**: 데이터베이스 스키마(Supabase), 백엔드 라우팅(Edge Functions), 데이터 파이프라인(Python 스크립트)  

---

## 1. 감사 개요 및 주요 발견(Key Findings)

최근 문서(`20260223_코드리뷰_정합성검증_및_버그수정_보고서.md` 등)와 **물리적 코드베이스의 실제 상태를 대조**한 결과, 치명적인 형상 불일치(Source of Truth Mismatch)가 식별되었습니다.

이전 2월 23일 상황에서 AI(또는 환경)가 문서상으로는 "버그 3건을 커밋하여 완료했다"고 기재하였으나, **실제 파일시스템에는 일부 수정사항만 반영**되고 핵심 버그 수정 및 파일 삭제는 완전히 누락되어 있었습니다.

### 1.1 문서와 실제 코드의 불일치 상세

| 항목 (보고서 주장) | 실제 코드 반영 여부 | 상태 |
|---|---|:---:|
| 파이프라인 `parse_13_3_1.py` 단위 오기 수정 | ✅ 반영됨 (`인/개소`) | 정상 |
| 파이프라인 `seed_db.py` 상대 경로 변경 | ✅ 반영됨 (`os.path.dirname`) | 정상 |
| 구버전 `edge-function/` 폴더 삭제 | ❌ **미반영** (여전히 프로젝트 루트에 존재) | **위험** |
| `index.ts` 내 Route 3.5 버그 수정 (`classifyComplexity` 임포트/호출) | ❌ **미반영** (Line 36~42, L1051 인근 누락) | **치명적** |

**결론**: 파이프라인 Python 스크립트 수정사항은 로컬에 체화되었으나, Edge Function 라우팅 파일 및 낡은 폴더 제거 작업은 누락되었습니다. 현재 **Phase 2 듀얼 모델 라우팅은 물리적으로 동작하지 않는 데드 코드(Dead Code)** 상태입니다.

---

## 2. 세부 진단 결과 (현재 문제점)

### 2.1 Backend / Routing (`supabase/functions/rag-chat/`)
1. **[P0] Route 3.5 진입 불가 (Dead Code)**: 
   - `index.ts`에서 `classifyComplexity` 함수를 Import하거나 호출하지 않아, 사용자 질의 복잡도가 영구적으로 `undefined`로 평가됨.
   - 결과적으로 DeepSeek Reasoner가 가동하지 못하며, 모든 복잡한 질문이 단순 검색(Route 4)으로 직행합니다.
2. **[P1] 복잡도 분류 로직(Rule-based)의 사각지대**:
   - `clarify.ts`의 `classifyComplexity()` 내 정규식이 "톤", "산출", "합산", "+" 기호 등을 인식하지 못합니다.
3. **[P2] Route 4 병목 구간 추적 불가**:
   - 특정 단순 질의(TC5) 처리 시 20초 이상이 소요되었으나, 현재 `index.ts` 및 `search.ts`에 단계별 지연시간(Embed, RPC, LLM) 텔레메트리 캡처 구간이 없어 병목 계측이 불가합니다.

### 2.2 Database / Pipeline (`pipeline/sql`, `pipeline/scripts/`)
1. **DB 스키마 구성**: `graph_entities`, `graph_relationships` 등 구조가 정상이며 `vector`, `pg_trgm` 확장 기반 RAG 검색이 문제없이 연결되어 있습니다.
2. **관리 상태**: 13장 플랜트 등 파이프라인은 잘 구축되었으나, 추후 이종 간 매핑이나 정밀한 분석을 위해 DB 메타데이터 확장이 검토될 수 있습니다 (우선순위 낮음).

### 2.3 환경 관리 (Environment)
1. **[P0] 구버전 코드 방치**: 프로젝트 루트의 `edge-function/` 디렉토리가 여전히 존재. 이는 IDE 전역 검색 결과 오염과 컨텍스트 혼동을 야기하는 치명적 부채입니다.

---

## 3. 아키텍처 개선 방향

현재 식별된 문제를 기반으로 다음의 핵심 지침을 수립합니다.

1. **형상 동기화 및 부채 청산 (Clean-up)**
   - 미신청된 코드 팩트(버그)를 바로잡습니다. 폐기 폴더 물리 삭제 작업도 동반됩니다.
   
2. **라우팅 지능 고도화 (Routing Intelligence)**
   - 규격 단위(`톤`)와 수식어(`+`, `산출` 등)를 포착하도록 `classifyComplexity` 판정식을 업그레이드.
   
3. **가시성 확보 (Observability)**
   - AI 검색 처리 시간(Telemetry)을 측정하는 계측 코드 도입으로 병목 추적.

---

## 4. 향후 상세 작업 목록 (Action Plan)

본 감사 결과를 바탕으로 즉각 실행할 구체적 Task를 다음과 같이 제안합니다.

### Phase A: 즉시 복구 및 부채 청산 (P0)
- [ ] **구버전 정리**: `edge-function/` 디렉토리 완전 삭제
- [ ] **Route 3.5 버그 픽스**: `supabase/functions/rag-chat/index.ts` 파일에 `classifyComplexity` 임포트 추가 및 의도 분석 블록에 호출 선언 주입

### Phase B: 논리 고도화 및 가시성 추가 (P1)
- [ ] **복잡도 판정식 강화**: `clarify.ts`의 `classifyComplexity` 함수 정규표현식 보완 (`톤`, `+`, `산출` 등)
- [ ] **성능 텔레메트리 구축**: RAG 파이프라인 상의 단계별(Embed, RPC, LLM) 반응 시간 계측(Telemetry Payload) 구현
- [ ] **엣지 함수 재배포**: 수정된 백엔드를 Supabase 배포(`supabase functions deploy`) 및 검토
