# ê±´ì„¤í’ˆì…ˆ RAG ì‹œìŠ¤í…œ â€” ì”ì—¬ ì‘ì—… ìƒì„¸ êµ¬í˜„ ê³„íšì„œ

> **ì‘ì„±ì¼**: 2026-02-23
> **ë²„ì „**: v3.0 (ì½”ë“œë² ì´ìŠ¤ ëŒ€ì¡° ê²€ì¦ ë°˜ì˜ í™•ì •íŒ)
> **ê¸°ë°˜**: v2.0 + ì½”ë“œë² ì´ìŠ¤ ì „ìˆ˜ ê²€ì¦(types.ts, graph.ts, clarify.ts, search.ts, index.ts, llm.ts, context.ts, app.js, SQL, parse_13_1_1.py)
> **ëŒ€ìƒ**: Phase 4, Phase 1.5-C, Phase 2, Phase 3

---

## 0. ë¦¬ë·° ë°˜ì˜ ì¶”ì í‘œ

### v2 â†’ v3 ë³€ê²½ ì´ë ¥

| # | í•­ëª© | ì‹¬ê°ë„ | v2 ìƒíƒœ | v3 ì¡°ì¹˜ |
|---|---|---|---|---|
| 1 | v2 SQL íŒŒë¼ë¯¸í„°ëª… `entity_id` â‰  ì½”ë“œì˜ `p_entity_id` | ğŸ”´ ì¹˜ëª… | ë¶ˆì¼ì¹˜ | Â§4-1ì—ì„œ `p_entity_id`ë¡œ í†µì¼ |
| 2 | `graph.ts` RPC í˜¸ì¶œë¶€ 2ê³³ ë¯¸íŒŒì•… (line 19, 53) | ğŸ”´ ì¹˜ëª… | 1ê³³ë§Œ ì–¸ê¸‰ | Â§4-2ì—ì„œ 2ê³³ ëª…ì‹œ |
| 3 | v2ì˜ `graph_global_relationships` ì¶”ê°€ â†’ `get_entity_hierarchy`ì™€ ì¤‘ë³µ | ğŸ”´ ì¹˜ëª… | ë¯¸ì¸ì§€ | Â§4-1ì—ì„œ v2 SQL ì¬ì„¤ê³„ + Â§4-2ì—ì„œ graph.ts ì¤‘ë³µ ì œê±° |
| 4 | Track 1-B (`source_section` ì¶”ê°€) ì´ë¯¸ ì™„ë£Œ | ğŸ”´ ì¹˜ëª… | ìˆ˜ì • ì˜ˆì • | **ì‚­ì œ** |
| 5 | Route 3.5ì—ì„œ Reasoner ì„±ê³µ ì‹œ `return` ëˆ„ë½ | ğŸŸ  ì¤‘ìš” | í´ìŠ¤ë£¨ | Â§2-3ì—ì„œ returnë¬¸ ì¶”ê°€ |
| 6 | Thinking UI í•¨ìˆ˜ëª… ë¶ˆì¼ì¹˜ (`appendMessage` â‰  `addMessage`) | ğŸŸ  ì¤‘ìš” | ë¶ˆì¼ì¹˜ | Â§2-4ì—ì„œ ê¸°ì¡´ í•¨ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ì¬ì‘ì„± |
| 7 | `AnswerOptions`ì— `complexity` í•„ë“œ ë¯¸ì¶”ê°€ | ğŸŸ  ì¤‘ìš” | ëˆ„ë½ | Â§3-2ì—ì„œ ì¶”ê°€ |
| 8 | `complex_estimate` intent í•¸ë“¤ëŸ¬ ë¯¸ì •ì˜ | ğŸŸ  ì¤‘ìš” | ëˆ„ë½ | Â§3-2ì—ì„œ í•¸ë“¤ëŸ¬ + validIntents ì¶”ê°€ |
| 9 | `seed_13_3_1.ts` ìœ„ì¹˜ ëª¨ìˆœ | ğŸŸ  ì¤‘ìš” | `pipeline/scripts/` | Â§C-2ì—ì„œ `edge-function/` í†µì¼ |
| 10 | ë³µì¡ë„ ë¡œê¹…/ê´€ì°°ê°€ëŠ¥ì„± ë¶€ì¬ | ğŸŸ¡ ê°œì„  | ì—†ìŒ | Â§2-1ì— ë¡œê·¸ ì¶”ê°€ |
| 11 | Reasoner ë¹„ìš© ì¶”ì • ë¯¸ê¸°ì¬ | ğŸŸ¡ ê°œì„  | ì—†ìŒ | Â§2-5 ë¹„ìš© ë¶„ì„ ì‹ ì„¤ |
| 12 | Phase 2/3 ë¡¤ë°± ì „ëµ ë¶€ì¬ | ğŸŸ¡ ê°œì„  | ì—†ìŒ | Â§2-6 ë¡¤ë°± ì „ëµ ì‹ ì„¤ |
| 13 | ì¬ì§ˆë³„ ì†ŒìŠ¤ MD íŒŒì¼ ê²½ë¡œ ë¯¸ëª…ì‹œ | ğŸŸ¡ ê°œì„  | ì—†ìŒ | Â§C-1ì— íŒŒì¼ ë§¤í•‘ ì¶”ê°€ |
| 14 | `deepseek-reasoner` API í˜¸í™˜ì„±/ì‹œê·¸ë‹ˆì²˜ ë¯¸ê²€ì¦ | ğŸŸ¡ ê°œì„  | ì—†ìŒ | Â§2-2ì— API ìŠ¤í™ ëª…ì‹œ |
| 15 | `complex_table_specs` ë°¸ë¸Œ ìŠ¤í‚¤ë§ˆ ë¯¸ì •ì˜ | ğŸŸ¡ ê°œì„  | ì—†ìŒ | Â§C-3 ìŠ¤í‚¤ë§ˆ í™•ì¥ ì‹ ì„¤ |

### v2ì—ì„œ ìœ ì§€ëœ í•­ëª©

| # | ë°˜ì˜ í•­ëª© | ì¶œì²˜ | ë°˜ì˜ ìœ„ì¹˜ |
|---|---|---|---|
| 1 | `get_related_resources_v2()` ë¬´ì¤‘ë‹¨ ë°°í¬ | ê°œì„ íŒ | Phase 4 Â§4-1 (íŒŒë¼ë¯¸í„°ëª… ìˆ˜ì •) |
| 2 | ì„œí‚· ë¸Œë ˆì´ì»¤ + íƒ€ì„ì•„ì›ƒ 15ì´ˆ | ê°œì„ íŒ + ì•„í‚¤í…íŠ¸ ë³´ì™„ | Phase 2 Â§2-3 |
| 3 | í”„ë¡ íŠ¸ì—”ë“œ Thinking UI | ê°œì„ íŒ | Phase 2 Â§2-4 (í•¨ìˆ˜ ì¬ì‘ì„±) |
| 4 | ìˆ˜í•™ ê³µì‹ ì¡°ê±´ë¶€ ì£¼ì… (í† í° ì ˆê°) | ê°œì„ íŒ | Phase 3 Â§3-1 |
| 5 | ~~`context.ts` ì •ë¦¬~~ | âŒ ì‚­ì œ | ì½”ë“œ ê²€ì¦: ì£½ì€ ì½”ë“œ ì—†ìŒ (3í•¨ìˆ˜ ëª¨ë‘ ì‚¬ìš© ì¤‘) |
| 6 | ~~`deduplicateResults`/`deduplicateWorkTypes` ì‚­ì œ~~ | âŒ ì‚­ì œ | ì½”ë“œ ê²€ì¦: ì´ë¯¸ ì œê±° ì™„ë£Œ |
| 7 | ~~`BaseEstimatorParser` ì¶”ìƒí™”~~ | âš ï¸ ë³´ë¥˜ | ì‚¬í›„ ë¦¬íŒ©í† ë§ìœ¼ë¡œ ì „í™˜ |

---

## Phase 4: RAG ê²€ìƒ‰ ë ˆì´ì–´ ê²½ëŸ‰í™” ë° ë¦¬íŒ©í† ë§

### Â§4-1. SQL RPC íŒ¨ì¹˜ (ë¬´ì¤‘ë‹¨ ë°°í¬)

#### [MODIFY] pipeline/sql/step2.7_create_search_functions.sql

**Track 1-A: `get_related_resources_v2()` ì‹ ê·œ ìƒì„±**

```sql
-- Why: ê¸°ì¡´ í•¨ìˆ˜ë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ë©´ Edge Function ë°°í¬ ì „ê¹Œì§€ API ì¥ì•  ë°œìƒ
--      v2ë¥¼ ì‹ ê·œ ìƒì„± â†’ Edge Function ë°°í¬ â†’ êµ¬ë²„ì „ DROP ìˆœì„œë¡œ ë¬´ì¤‘ë‹¨ ë‹¬ì„±
--
-- âš ï¸ v3 ìˆ˜ì •: íŒŒë¼ë¯¸í„°ëª… p_entity_id ìœ ì§€ (graph.ts í˜¸ì¶œë¶€ í˜¸í™˜)
-- âš ï¸ v3 ìˆ˜ì •: graph_global_relationships ì œì™¸ (get_entity_hierarchyì™€ ì¤‘ë³µ ë°©ì§€)
--
-- [v2 ëŒ€ë¹„ ë³€ê²½ì ]
--   1. íŒŒë¼ë¯¸í„°: entity_id â†’ p_entity_id (ê¸°ì¡´ í˜¸ì¶œ ì½”ë“œì™€ ì¼ì¹˜)
--   2. graph_global_relationships UNION ALL ì œê±° (ì•„ë˜ ì‚¬ìœ  ì°¸ì¡°)
--
-- [graph_global_relationships ì œì™¸ ì‚¬ìœ ]
--   í˜„í–‰: get_entity_hierarchy()ê°€ Section íƒ€ì…ì—ì„œ graph_global_relationships ì–‘ë°©í–¥ ì¡°íšŒ
--   v2ì•ˆ: v2ì— outbound ì¶”ê°€ â†’ Section íƒ€ì…ì—ì„œ outbound ì¤‘ë³µ ë°œìƒ
--   v3ì•ˆ: v2ëŠ” graph_relationshipsë§Œ ë‹´ë‹¹, ê³„ì¸µ íƒìƒ‰ì€ ê¸°ì¡´ get_entity_hierarchy ìœ ì§€
--         â†’ ì—­í•  ë¶„ë¦¬ ëª…í™•, ì¤‘ë³µ ë°ì´í„° ì œê±°

CREATE OR REPLACE FUNCTION get_related_resources_v2(p_entity_id text)
RETURNS TABLE (
    direction text, relation text,
    related_id text, related_name text,
    related_type text, properties jsonb
) AS $$
BEGIN
    RETURN QUERY
    SELECT 'outbound'::text, r.relation, r.target_id, e.name, e.type, r.properties
    FROM graph_relationships r
    JOIN graph_entities e ON e.id = r.target_id
    WHERE r.source_id = p_entity_id;
END;
$$ LANGUAGE plpgsql STABLE;
```

> **v2ì™€ì˜ ì°¨ì´**: v2ëŠ” `graph_global_relationships`ë¥¼ UNION ALLë¡œ í¬í•¨í–ˆìœ¼ë‚˜, ì´ëŠ” `get_entity_hierarchy()`ì™€ outbound ë°©í–¥ì´ ì¤‘ë³µë¨. v3ì—ì„œëŠ” **ì—­í•  ë¶„ë¦¬ ì›ì¹™**ì— ë”°ë¼ ì œì™¸. í–¥í›„ `get_entity_hierarchy` í˜¸ì¶œ ìµœì í™”ê°€ í•„ìš”í•˜ë©´ ë³„ë„ ê³¼ì œë¡œ ë¶„ë¦¬.

**~~Track 1-B: `search_entities_by_embedding()` ë°˜í™˜ê°’ í™•ì¥~~ â†’ âŒ ì‚­ì œ**

> **ì‚­ì œ ì‚¬ìœ **: ì½”ë“œ ê²€ì¦ ê²°ê³¼ ì´ë¯¸ ì™„ë£Œë¨.
> - `step2.7_create_search_functions.sql:23-24`: ë°˜í™˜ í…Œì´ë¸”ì— `source_section TEXT` ì´ë¯¸ ì¡´ì¬
> - `search.ts:292` ì£¼ì„: "(Codex F4) ì´ì œ search_entities_by_embeddingì—ì„œ source_sectionì„ ì§ì ‘ ë°˜í™˜"
> - ì¶”ê°€ ì‘ì—… ë¶ˆí•„ìš”

**ë¡¤ë°± ì „ëµ**: Edge Functionì´ ì•„ì§ v2ë¥¼ ì°¸ì¡°í•˜ì§€ ì•ŠëŠ” í•œ, êµ¬ë²„ì „ì´ ì •ìƒ ë™ì‘. ë¬¸ì œ ë°œìƒ ì‹œ Edge Functionë§Œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë˜ëŒë¦¼.

---

### Â§4-2. Edge Function ê²½ëŸ‰í™”

#### [MODIFY] edge-function/graph.ts â€” `expandGraph()`

âš ï¸ **v3 í•µì‹¬ ìˆ˜ì •: RPC í˜¸ì¶œë¶€ 2ê³³ ëª¨ë‘ êµì²´ í•„ìˆ˜**

```typescript
// í˜¸ì¶œë¶€ 1: expandGraph() ë©”ì¸ (graph.ts:19)
// AS-IS:
const { data: relations, error: relErr } = await supabase.rpc(
    "get_related_resources",
    { p_entity_id: entityId }
);
// TO-BE:
const { data: relations, error: relErr } = await supabase.rpc(
    "get_related_resources_v2",
    { p_entity_id: entityId }
);

// í˜¸ì¶œë¶€ 2: expandSectionWorkTypes() ë‚´ë¶€ (graph.ts:53)
// AS-IS:
const { data: wtRels } = await supabase.rpc(
    "get_related_resources",
    { p_entity_id: wt.id }
);
// TO-BE:
const { data: wtRels } = await supabase.rpc(
    "get_related_resources_v2",
    { p_entity_id: wt.id }
);
```

- ë°°í¬ ì™„ë£Œ í›„ êµ¬ë²„ì „ RPC `get_related_resources` DROP ì‹¤í–‰
- `get_entity_hierarchy`ëŠ” ë³€ê²½ ì—†ìŒ (Section ê³„ì¸µ íƒìƒ‰ ì—­í•  ìœ ì§€)

#### ~~[MODIFY] edge-function/search.ts~~ â†’ âŒ ì‚­ì œ

> **ì‚­ì œ ì‚¬ìœ **: `source_section` ì§ì ‘ ì°¸ì¡°ëŠ” ì´ë¯¸ êµ¬í˜„ ì™„ë£Œ (`search.ts:292` Codex F4). ì¶”ê°€ ìˆ˜ì • ë¶ˆí•„ìš”.

#### [MODIFY] edge-function/resolve.ts

- (ë³„ë„ ì‚­ì œ ì‘ì—… ì—†ìŒ â€” `deduplicateWorkTypes()`ëŠ” ì´ë¯¸ ì œê±°ë¨)

#### [MODIFY] edge-function/index.ts â€” `buildContext()`

- ì—”í‹°í‹° ë Œë”ë§ ì‹œ ì‹¬í”Œ í…Œì´ë¸”ì€ ê³ ì • 4ì—´ ìŠ¤í‚¤ë§ˆ (`|ì§ì¢…|ìˆ˜ëŸ‰|ë‹¨ìœ„|ê¸°ì¤€|`) ìœ ì§€ í™•ì¸
- `per_unit` ê°’ì´ ë¹„ì–´ìˆì„ ê²½ìš° í•˜ì´í”ˆ(`-`)ìœ¼ë¡œ ì¹˜í™˜í•˜ì—¬ í…Œì´ë¸” ì •í•©ì„± ìœ ì§€
- `renderMatrixTable()`ì˜ `props.source_spec || props.spec || props.per_unit || props.work_type_name` ìš°ì„ ìˆœìœ„ ì²´ì¸ ìœ ì§€ (í˜„í–‰ ì½”ë“œ `index.ts:70` ì´ë¯¸ êµ¬í˜„ë¨ â€” ë™ì‘ í™•ì¸ë§Œ ìˆ˜í–‰)

#### [MODIFY] edge-function/llm.ts â€” `SYSTEM_PROMPT`

- ê³ ì • 4ì—´ í…Œì´ë¸” ìƒì„± ê°•ì œ ì§€ì‹œë¬¸ ì¶”ê°€
- `per_unit` í‘œê¸° ê·œì¹™ ëª…ì‹œ (ê°’ ì—†ìœ¼ë©´ `-` ì¶œë ¥)

---

### Â§4-3. ë°°í¬ ìˆœì„œ (ë¬´ì¤‘ë‹¨)

```
Step 1: SQL íŒ¨ì¹˜ (v2 í•¨ìˆ˜ ìƒì„± â€” graph_relationships outboundë§Œ)
    â†’ êµ¬ë²„ì „ í•¨ìˆ˜ ìœ ì§€, ê¸°ì¡´ Edge Function ì •ìƒ ë™ì‘
        â†“
Step 2: Edge Function ë°°í¬ (graph.ts 2ê³³ ëª¨ë‘ v2 ì°¸ì¡°)
    â†’ ì‹ /êµ¬ RPC ëª¨ë‘ ì¡´ì¬, ì¦‰ì‹œ ì „í™˜
        â†“
Step 3: ê²€ì¦ í›„ êµ¬ë²„ì „ SQL DROP (get_related_resources ì‚­ì œ)
    â†’ í´ë¦° ìƒíƒœ
```

---

## Phase 1.5-C: Monster Table ì¬ì§ˆ ë° ì¶”ê°€ ê³µì¢… í™•ì¥

### Â§C-1. ê¸°ì¡´ íŒŒì„œ ì¬ì§ˆ í™•ì¥

#### [MODIFY] pipeline/scripts/parse_13_1_1.py

- ê¸°ì¡´ "ë°°ê´€ìš© íƒ„ì†Œê°•ê´€(KSD3507)" 1ì¢… ì™¸ **6ê°œ ì¬ì§ˆ** ì •ê·œì‹ ë§¤í•‘ í™•ì¥:

| # | ì¬ì§ˆ | í‘œì¤€ ì½”ë“œ | ì˜ˆìƒ ë ˆì½”ë“œ | ì†ŒìŠ¤ íŒŒì¼ |
|---|---|---|---|---|
| 1 | ë°°ê´€ìš© íƒ„ì†Œê°•ê´€ | KSD3507 | âœ… 280ê±´ ì™„ë£Œ | `20260208_747-878 OKOK.md` (p.697~) |
| 2 | ì••ë ¥ë°°ê´€ìš© íƒ„ì†Œê°•ê´€ | KSD3562 | ~280ê±´ | âš ï¸ **êµ¬í˜„ ì „ í™•ì¸ í•„ìš”** |
| 3 | Crí•©ê¸ˆê°•ê´€ | A335 | ~200ê±´ | âš ï¸ **êµ¬í˜„ ì „ í™•ì¸ í•„ìš”** |
| 4 | ìŠ¤í…ë ˆìŠ¤ê°•ê´€ | Type304 | ~280ê±´ | âš ï¸ **êµ¬í˜„ ì „ í™•ì¸ í•„ìš”** |
| 5 | ì•Œë£¨ë¯¸ëŠ„ê´€ | â€” | ~150ê±´ | âš ï¸ **êµ¬í˜„ ì „ í™•ì¸ í•„ìš”** |
| 6 | ë™ê´€ | â€” | ~150ê±´ | âš ï¸ **êµ¬í˜„ ì „ í™•ì¸ í•„ìš”** |
| 7 | í™©ë™ê´€ | â€” | ~100ê±´ | âš ï¸ **êµ¬í˜„ ì „ í™•ì¸ í•„ìš”** |

> **v3 ì¶”ê°€**: ì†ŒìŠ¤ íŒŒì¼ ì»¬ëŸ¼ ì‹ ì„¤. ì¬ì§ˆ 2~7ì˜ ì›ë³¸ MD íŒŒì¼ ê²½ë¡œ ë° í˜ì´ì§€ ë²”ìœ„ëŠ” êµ¬í˜„ ì°©ìˆ˜ ì „ `pipeline/download_file/` ë””ë ‰í† ë¦¬ì—ì„œ í™•ì¸í•˜ì—¬ ë§¤í•‘ í•„ìš”. ë™ì¼ íŒŒì¼(`20260208_747-878 OKOK.md`) ë‚´ í›„ì† í˜ì´ì§€ì— ìˆì„ ìˆ˜ ìˆìœ¼ë‚˜, **ì¶”ì¸¡í•˜ì§€ ì•Šê³  í™•ì¸ í›„ ì§„í–‰**.

- ê° ì¬ì§ˆë³„ `normalize_material()` í•¨ìˆ˜ì˜ ì •ê·œì‹ íŒ¨í„´ ì¶”ê°€
  - í‘œì¤€ ì½”ë“œ ì—†ëŠ” ì¬ì§ˆ(ì•Œë£¨ë¯¸ëŠ„ê´€, ë™ê´€, í™©ë™ê´€): ì¬ì§ˆëª… í•œê¸€ ë§¤ì¹­ìœ¼ë¡œ ì²˜ë¦¬
  - `normalize_material()` í˜„í–‰: `re.match(r'(.+?)(KSD\d+|A\d+|Type\d+)', cleaned)` â†’ ì½”ë“œ ì—†ëŠ” ì¬ì§ˆì€ else ë¶„ê¸°ë¡œ `cleaned` ë°˜í™˜ (ì´ë¯¸ ëŒ€ì‘ë¨)
- ê¸°ì¡´ í…Œì´ë¸” ì¸ë±ìŠ¤ í•˜ë“œì½”ë”©(`tables[0]`, `tables[1]`, `tables[2]`) â†’ **ì¬ì§ˆë³„ í…Œì´ë¸” ë²”ìœ„ ë™ì  íƒìƒ‰**ìœ¼ë¡œ ê°œì„ 
  - í˜„í–‰ ë¬¸ì œ: `parse_13_1_1.py:28-30`ì—ì„œ `tables[0]`, `tables[1]`, `tables[2]` ê³ ì • ì¸ë±ìŠ¤ ì‚¬ìš©
  - ê°œì„ : ì¬ì§ˆ í—¤ë”(`rowspan` ì…€ì˜ í…ìŠ¤íŠ¸)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í…Œì´ë¸” ë²”ìœ„ë¥¼ ë™ì  íƒìƒ‰

### Â§C-2. ë°¸ë¸Œë¥˜ íŒŒì„œ ì‹ ê·œ ì‘ì„±

#### [NEW] pipeline/scripts/parse_13_3_1.py

- ì œ13ì¥ 13-3-1 (í”Œëœì§€ ë° ë°¸ë¸Œë¥˜ ì„¤ì¹˜) ì „ìš© íŒŒì„œ
- êµ¬ê²½ë³„(15mm~1500mm) ì¸ë ¥ í’ˆì…ˆ ë§¤í•‘
- êµ¬ì¡°: `parse_13_1_1.py`ì„ ë…ë¦½ ë³µì œ í›„ í…Œì´ë¸” ë ˆì´ì•„ì›ƒì— ë§ê²Œ ìˆ˜ì •
- ì˜ì¡´: `beautifulsoup4` (ê¸°ì¡´ íŒŒì„œì™€ ë™ì¼ â€” `pipeline/` í™˜ê²½ì— ì´ë¯¸ ì„¤ì¹˜)
- âš ï¸ `BaseEstimatorParser` ì¶”ìƒí™”ëŠ” **ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ** â€” ë°¸ë¸Œë¥˜ í…Œì´ë¸” í¬ë§·ì´ ë°°ê´€ê³¼ ìƒì´í•  ê²½ìš° ì¶”ìƒí™” ë¹„ìš©ì´ ì‹¤ìµ ì´ˆê³¼. ì¶”í›„ ê³µí†µ íŒ¨í„´ í™•ì¸ ì‹œ ì‚¬í›„ ë¦¬íŒ©í† ë§.

#### [NEW] edge-function/seed_13_3_1.ts

> **v3 ìˆ˜ì •**: `pipeline/scripts/` â†’ `edge-function/`ë¡œ ìœ„ì¹˜ ë³€ê²½.
> ì‚¬ìœ : ê¸°ì¡´ ì‹œë“œ íŒŒì¼ `seed_13_1_1.ts`ê°€ `edge-function/`ì— ìœ„ì¹˜ â€” ë™ì¼ íŒ¨í„´ ìœ ì§€.

- íŒŒì‹±ëœ ë°¸ë¸Œ ì„¤ì¹˜ JSON â†’ Supabase `complex_table_specs` í…Œì´ë¸” ì ì¬
- Supabase JS SDKì˜ `.insert()` ë°°ì¹˜ ì²˜ë¦¬ (100ê±´ ë‹¨ìœ„)

### Â§C-3. `complex_table_specs` ìŠ¤í‚¤ë§ˆ í™•ì¥ [NEW]

> **v3 ì‹ ì„¤**: ë°¸ë¸Œë¥˜ ë°ì´í„°ì˜ ì»¬ëŸ¼ êµ¬ì¡°ê°€ ë°°ê´€ ì„¤ì¹˜ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ìŠ¤í‚¤ë§ˆ í˜¸í™˜ì„±ì„ ì‚¬ì „ í™•ì¸.

#### [MODIFY] pipeline/sql/ (ì‹ ê·œ ë§ˆì´ê·¸ë ˆì´ì…˜ SQL)

í˜„í–‰ `complex_table_specs` ìŠ¤í‚¤ë§ˆ (ë°°ê´€ ì„¤ì¹˜ 13-1-1 ê¸°ì¤€):

```
section_code, section_name, material, spec_mm, outer_dia_mm, thickness_mm,
unit_weight, pipe_location, joint_type, job_name, quantity, quantity_unit, source_page
```

ë°¸ë¸Œë¥˜(13-3-1) ì¶”ê°€ ì‹œ ì˜ˆìƒ ì°¨ì´:

| ë°°ê´€(13-1-1) ì»¬ëŸ¼ | ë°¸ë¸Œ(13-3-1) ëŒ€ì‘ | í˜¸í™˜ ì—¬ë¶€ |
|---|---|---|
| `material` | ë°¸ë¸Œ ì¢…ë¥˜ (ë²„í„°í”Œë¼ì´, ê²Œì´íŠ¸ ë“±) | âš ï¸ ì˜ë¯¸ ë³€ê²½ |
| `pipe_location` (ì˜¥ë‚´/ì˜¥ì™¸) | í•´ë‹¹ ì—†ìŒ | âš ï¸ NULL í—ˆìš© í•„ìš” |
| `joint_type` (ìš©ì ‘/ë‚˜ì‚¬) | í•´ë‹¹ ì—†ìŒ | âš ï¸ NULL í—ˆìš© í•„ìš” |
| `outer_dia_mm`, `thickness_mm`, `unit_weight` | í•´ë‹¹ ì—†ìŒ (ë°¸ë¸ŒëŠ” êµ¬ê²½ë§Œ) | âš ï¸ NULL í—ˆìš© í•„ìš” |

**ëŒ€ì‘ ë°©ì•ˆ**: ê¸°ì¡´ ì»¬ëŸ¼ì˜ `NOT NULL` ì œì•½ì„ `NULL` í—ˆìš©ìœ¼ë¡œ ì™„í™”í•˜ê±°ë‚˜, `valve_type` ë“± ë°¸ë¸Œ ì „ìš© ì»¬ëŸ¼ ì¶”ê°€. êµ¬í˜„ ì°©ìˆ˜ ì‹œ ì›ë³¸ PDFì˜ 13-3-1 í…Œì´ë¸” êµ¬ì¡°ë¥¼ í™•ì¸í•œ í›„ í™•ì •.

---

## Phase 2: DeepSeek ë“€ì–¼ ëª¨ë¸ ë¼ìš°íŒ…

### Â§2-1. ë³µì¡ë„ íŒë³„ê¸°

#### [MODIFY] edge-function/clarify.ts

`classifyComplexity(question, analysis)` í•¨ìˆ˜ ì¶”ê°€:

```typescript
export function classifyComplexity(question: string, analysis: IntentAnalysis): "simple" | "complex" {
    let score = 0;

    // [ê¸°ì¤€ 1] ì§ˆë¬¸ ê¸¸ì´
    if (question.length > 80) score += 1;
    if (question.length > 150) score += 1;

    // [ê¸°ì¤€ 2] ë³µìˆ˜ ê³µì¢… í‚¤ì›Œë“œ (2ê°œ ì´ìƒ â†’ +2)
    const workPatterns = question.match(/[ê°€-í£]{2,}(í•´ì²´|ì² ê±°|ì„¤ì¹˜|ì‹œê³µ|íƒ€ì„¤|ìš©ì ‘|ë„ì¥|ë°©ìˆ˜|ë°°ê´€)/g) || [];
    if (workPatterns.length >= 2) score += 2;

    // [ê¸°ì¤€ 3] ì¡°ê±´/ìƒí™© í‚¤ì›Œë“œ ë¬¶ìŒ ì ìˆ˜ (Claude ë³´ì • #5)
    const conditionKeywords = ["ë†’ì´", "ê³ ì†Œ", "ì§€í•˜", "ìˆ˜ì¤‘", "ì•¼ê°„", "í˜‘ì†Œ", "ìœ„í—˜",
        "í• ì¦", "ë³´ì˜¨", "ë‹¨ì—´", "ë³´ì–‘", "ì–‘ì¤‘", "ì¸ì–‘", "í•´ì²´", "ì² ê±°"];
    const matched = conditionKeywords.filter(kw => question.includes(kw));
    if (matched.length >= 2) score += 2;
    else if (matched.length === 1) score += 1;

    // [ê¸°ì¤€ 4] ë¬¼ë¦¬ëŸ‰/ë‹¨ìœ„ í™˜ì‚° ì‹œê·¸ë„
    if (/\d+\s*(mm|t|T|í†¤|kg|mÂ²|ã¡|mÂ³|ã¥)/.test(question)) score += 1;
    if (/ë‘ê»˜|ì™¸ê²½|ë‚´ê²½|ì§ê²½|ì§€ë¦„|ë¬´ê²Œ|ì¤‘ëŸ‰/.test(question)) score += 1;

    // [ê¸°ì¤€ 5] ê°€ì´ë“œ ìš”ì²­
    if (/ì–´ë–»ê²Œ|ì ìš©|ë°©ë²•|ì‚°ì¶œ|ê²¬ì |ë‚´ì—­/.test(question)) score += 1;

    const result = score >= 4 ? "complex" : "simple";

    // â­ v3 ì¶”ê°€: ê´€ì°°ê°€ëŠ¥ì„± â€” ì„ê³„ê°’ íŠœë‹ì„ ìœ„í•œ ë¡œê·¸
    console.log(`[classifyComplexity] score=${score}, result=${result}, ` +
        `workPatterns=${workPatterns.length}, conditions=${matched.length}, ` +
        `q_len=${question.length}, q="${question.substring(0, 50)}..."`);

    return result;
}
```

> **v3 ë³€ê²½**: `console.log` ì¶”ê°€ â€” `score`, `result`, ì£¼ìš” íŒë³„ ìš”ì¸ì„ ë¡œê¹…í•˜ì—¬ ë°°í¬ í›„ Supabase Edge Function ë¡œê·¸ì—ì„œ ì„ê³„ê°’(4ì ) ì ì •ì„±ì„ ê´€ì°°. ì´ˆê¸° 1ì£¼ê°„ ë¡œê·¸ ë¶„ì„ í›„ ì„ê³„ê°’ ì¡°ì • ì—¬ë¶€ ê²°ì •.

---

### Â§2-2. Reasoner ë§ˆìŠ¤í„°í”Œëœ ìƒì„±ê¸°

#### [MODIFY] edge-function/llm.ts

`generateReasoningGuide(question, history, signal)` í•¨ìˆ˜ ì¶”ê°€:

```typescript
// â­ v3 ì¶”ê°€: í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ + API í˜¸ì¶œ ì½”ë“œ ëª…ì‹œ

interface ReasonerGuideResult {
    guide: string;          // JSON ë¬¸ìì—´: { search_tasks, calculations, adjustments }
    inputTokens: number;
    outputTokens: number;
    reasoningTokens: number; // ì‚¬ê³  í† í° (deepseek-reasoner ê³ ìœ )
}

export async function generateReasoningGuide(
    question: string,
    history: ChatMessage[],
    signal?: AbortSignal
): Promise<ReasonerGuideResult> {

    // deepseek-reasoner ì œì•½: system role ë¯¸ì§€ì›, temperature ë¯¸ì§€ì›
    // â†’ system ì§€ì‹œë¬¸ì„ user ë©”ì‹œì§€ ì•ë‹¨ì— ë³‘í•©

    const systemInstruction = `ë‹¹ì‹ ì€ ê±´ì„¤ ê³µì‚¬ í’ˆì…ˆ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë³µí•© ì§ˆì˜ë¥¼ ë¶„ì„í•˜ì—¬ ê²€ìƒ‰ ì „ëµì„ ìˆ˜ë¦½í•˜ì„¸ìš”.
ë°˜ë“œì‹œ ì•„ë˜ JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”:
{
  "search_tasks": [
    { "query": "ê²€ìƒ‰í•  ê³µì¢…ëª…", "spec": "ê·œê²© ë˜ëŠ” null", "purpose": "ì´ ê²€ìƒ‰ì´ í•„ìš”í•œ ì´ìœ " }
  ],
  "calculations": [
    { "formula": "ì ìš©í•  ìˆ˜ì‹", "variables": ["í•„ìš”í•œ ë³€ìˆ˜ë“¤"] }
  ],
  "adjustments": [
    { "condition": "í• ì¦/ë³´ì • ì¡°ê±´", "factor": "ì ìš© ê³„ìˆ˜" }
  ]
}`;

    const messages = [
        // system role â†’ user ë©”ì‹œì§€ë¡œ ë³‘í•©
        {
            role: "user" as const,
            content: `[ì‹œìŠ¤í…œ ì§€ì‹œ]\n${systemInstruction}\n\n---\n\n[ì‚¬ìš©ì ì§ˆë¬¸]\n${question}`,
        },
        // íˆìŠ¤í† ë¦¬ (ìµœê·¼ 3í„´ë§Œ)
        ...history.slice(-3).map(h => ({
            role: h.role === "user" ? "user" as const : "assistant" as const,
            content: h.content,
        })),
    ];

    const response = await fetch(DEEPSEEK_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${DEEPSEEK_API_KEY}`,
        },
        body: JSON.stringify({
            model: "deepseek-reasoner",
            messages,
            max_tokens: 2048,
            // temperature ì œê±°: deepseek-reasonerëŠ” temperature ë¯¸ì§€ì›
        }),
        signal, // AbortController.signal â†’ 15ì´ˆ íƒ€ì„ì•„ì›ƒ ì—°ë™
    });

    if (!response.ok) {
        throw new Error(`Reasoner API failed: ${response.status}`);
    }

    const data = await response.json();
    const guide = data.choices?.[0]?.message?.content ?? "{}";
    const usage = data.usage || {};

    console.log(`[generateReasoningGuide] reasoning_tokens=${usage.reasoning_tokens || 0}, ` +
        `input=${usage.prompt_tokens || 0}, output=${usage.completion_tokens || 0}`);

    return {
        guide,
        inputTokens: usage.prompt_tokens || 0,
        outputTokens: usage.completion_tokens || 0,
        reasoningTokens: usage.reasoning_tokens || 0,
    };
}
```

> **v3 ë³€ê²½ì **:
> 1. í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ì— `signal?: AbortSignal` ëª…ì‹œ
> 2. `ReasonerGuideResult` íƒ€ì… ì •ì˜ (reasoning_tokens í¬í•¨)
> 3. API í˜¸ì¶œ ì½”ë“œ ì „ë¬¸ ì‘ì„± (system role ë³‘í•©, temperature ì œê±°)
> 4. í† í° ì‚¬ìš©ëŸ‰ ë¡œê¹… ì¶”ê°€
>
> **API í˜¸í™˜ì„± ì°¸ê³ **: DeepSeek APIì˜ `deepseek-reasoner` ëª¨ë¸ëª…ì€ 2025-01 ê³µê°œ. system role ë¯¸ì§€ì›, temperature ë¯¸ì§€ì›ì€ ê³µì‹ ë¬¸ì„œ í™•ì¸ ì™„ë£Œ. ë°°í¬ ì „ stagingì—ì„œ API í˜¸ì¶œ ì„±ê³µ ì—¬ë¶€ 1íšŒ í…ŒìŠ¤íŠ¸ í•„ìˆ˜.

- (Claude ë³´ì • #4): ìš°íšŒ ì¶”ë¡  í—ˆìš© ê·œì¹™ì€ **Reasoner ì „ìš© í”„ë¡¬í”„íŠ¸ì—ë§Œ ê²©ë¦¬**, Chat SYSTEM_PROMPTì—ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ì•ŠìŒ

---

### Â§2-3. ë©”ì¸ íŒŒì´í”„ë¼ì¸ ë¶„ê¸° (ì„œí‚· ë¸Œë ˆì´ì»¤ í¬í•¨)

#### [MODIFY] edge-function/index.ts â€” `handleChat()`

Route 4 (`searchPipeline`) ì§ì „ì— **Route 3.5** ì‚½ì… (Claude ë³´ì • #2):

```typescript
// â”€â”€â”€ Route 3.5: ë³µí•© ì§ˆë¬¸ â†’ Reasoner ê²½ë¡œ â”€â”€â”€
import { classifyComplexity } from "./clarify.ts";

const complexity = classifyComplexity(question, analysis);

if (complexity === "complex") {
    try {
        // â­ ì„œí‚· ë¸Œë ˆì´ì»¤: 15ì´ˆ íƒ€ì„ì•„ì›ƒ, ì¬ì‹œë„ 0íšŒ (ì¦‰ì‹œ í´ë°±)
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15_000);

        const reasonerResult = await generateReasoningGuide(question, history, controller.signal);
        clearTimeout(timeout);

        let parsedGuide: any = {};
        try { parsedGuide = JSON.parse(reasonerResult.guide); } catch {
            // JSON íŒŒì‹± ì‹¤íŒ¨ â†’ ê¸°ì¡´ search ê²½ë¡œë¡œ í´ë°±
            console.warn("[handleChat] Reasoner JSON íŒŒì‹± ì‹¤íŒ¨ â†’ Route 4 í´ë°±");
        }

        const searchTasks = parsedGuide.search_tasks || [];
        if (searchTasks.length > 0) {
            // ë‹¤ì¤‘ DB ê²€ìƒ‰: searchTasks ê°ê°ì— ëŒ€í•´ targetSearch ì‹¤í–‰
            const embedding = await generateEmbedding(question);
            const allEntities: EntityResult[] = [];

            for (const task of searchTasks.slice(0, 3)) { // ìµœëŒ€ 3ê°œ ê²€ìƒ‰ íƒœìŠ¤í¬
                const taskAnalysis: IntentAnalysis = {
                    ...analysis,
                    work_name: task.query,
                    spec: task.spec || null,
                    keywords: [task.query],
                };
                const taskEntities = await targetSearch(taskAnalysis, embedding, task.query);
                allEntities.push(...taskEntities);
            }

            if (allEntities.length > 0) {
                // â­ v3 ìˆ˜ì •: returnë¬¸ ì¶”ê°€ â€” Reasoner ê²½ë¡œ ì™„ë£Œ ì‹œ Route 4 ì‹¤í–‰ ë°©ì§€
                return answerPipeline(allEntities, question, history, startTime, {
                    answerOptions: { ...answerOptions, complexity: "complex" },
                    analysis,
                });
            }
            // allEntities 0ê±´ì´ë©´ Route 4ë¡œ í´ë°±
        }
    } catch (err) {
        // â­ Reasoner ì‹¤íŒ¨/íƒ€ì„ì•„ì›ƒ â†’ ì¦‰ì‹œ ê¸°ì¡´ ê²½ë¡œ í´ë°± (ì„œë¹„ìŠ¤ ë¬´ì¤‘ë‹¨)
        console.error("[handleChat] Reasoner ì„œí‚· ë¸Œë ˆì´ì»¤ ì‘ë™:", err);
    }
}

// Route 4: searchPipeline (ê¸°ì¡´ ë‹¨ìˆœ ê²½ë¡œ, ë³€ê²½ ì—†ìŒ)
return searchPipeline(analysis, question, history, startTime, answerOptions);
```

> **v3 í•µì‹¬ ìˆ˜ì •**: `return answerPipeline(...)` ì¶”ê°€. v2ì—ì„œëŠ” Reasoner ì„±ê³µ í›„ `return`ì´ ì—†ì–´ Route 4ê°€ í•­ìƒ ì‹¤í–‰ë˜ëŠ” ì´ì¤‘ í˜¸ì¶œ ë¬¸ì œê°€ ìˆì—ˆìŒ.

---

### Â§2-4. í”„ë¡ íŠ¸ì—”ë“œ Thinking UI

#### [MODIFY] frontend/app.js

> **v3 ìˆ˜ì •**: ê¸°ì¡´ `addMessage()`/`showLoading()`/`hideLoading()` í•¨ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ì¬ì‘ì„±. v2ì˜ ë¯¸ì •ì˜ í•¨ìˆ˜(`appendMessage`, `removeThinkingMessage`) ì œê±°.

```javascript
// â”€â”€â”€ Thinking UI (ë³µí•©ì¶”ë¡  5~8ì´ˆ UX ë°©ì–´) â”€â”€â”€
// ê¸°ì¡´ showLoading()ì€ ì¦‰ì‹œ í‘œì‹œë˜ëŠ” íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°.
// Thinking UIëŠ” 2ì´ˆ ì§€ì—° í›„ì—ë§Œ í‘œì‹œë˜ì–´ ë³µí•© ì§ˆì˜ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ì œê³µ.

let thinkingTimer = null;

function showThinkingIfSlow() {
    thinkingTimer = setTimeout(() => {
        // ê¸°ì¡´ ë¡œë”© ì¸ë””ì¼€ì´í„°ë¥¼ Thinking ë©”ì‹œì§€ë¡œ êµì²´
        hideLoading();
        const div = document.createElement('div');
        div.className = 'message assistant';
        div.id = 'thinkingMessage';

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = 'ğŸ¤–';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content thinking';
        contentDiv.textContent = 'ë³µí•© ì§ˆì˜ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

        div.appendChild(avatar);
        div.appendChild(contentDiv);
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 2000);
}

function clearThinking() {
    if (thinkingTimer) {
        clearTimeout(thinkingTimer);
        thinkingTimer = null;
    }
    const el = document.getElementById('thinkingMessage');
    if (el) el.remove();
}

// â”€â”€â”€ handleSubmit ìˆ˜ì • (ê¸°ì¡´ í•¨ìˆ˜ ë‚´ë¶€) â”€â”€â”€
// showLoading() í˜¸ì¶œ ì§í›„ì— showThinkingIfSlow() ì¶”ê°€
// hideLoading() í˜¸ì¶œ ì§ì „ì— clearThinking() ì¶”ê°€
```

ì ìš© ìœ„ì¹˜ (`handleSubmit` ë‚´ë¶€):
```javascript
// AS-IS:
showLoading();
try {
    const result = await sendQuestion(question);
    hideLoading();
    // ...

// TO-BE:
showLoading();
showThinkingIfSlow();  // â† ì¶”ê°€
try {
    const result = await sendQuestion(question);
    clearThinking();    // â† ì¶”ê°€
    hideLoading();
    // ...
} catch (err) {
    clearThinking();    // â† ì¶”ê°€
    hideLoading();
    // ...
```

---

### Â§2-5. ë¹„ìš© ì˜í–¥ ë¶„ì„ [NEW]

> **v3 ì‹ ì„¤**: Reasoner ê²½ë¡œì˜ ë¹„ìš© ì˜í–¥ì„ ì‚¬ì „ ì¶”ì •.

| í•­ëª© | deepseek-chat (í˜„í–‰) | deepseek-reasoner (ì‹ ê·œ) | ë¹„ê³  |
|---|---|---|---|
| Input í† í° ë‹¨ê°€ | ~â‚©0.18/1K | ~â‚©0.55/1K | reasoner 3ë°° |
| Output í† í° ë‹¨ê°€ | ~â‚©0.72/1K | ~â‚©2.19/1K | reasoner 3ë°° |
| Reasoning í† í° | â€” | ~â‚©2.19/1K | reasoner ì „ìš© |
| ê±´ë‹¹ í‰ê·  ë¹„ìš© | ~â‚©3~5 | ~â‚©15~25 | ì¶”ë¡  í† í° í¬í•¨ |

**ì›”ê°„ ë¹„ìš© ì‹œë®¬ë ˆì´ì…˜** (ì¼ 100ê±´ ê°€ì •):

| ì‹œë‚˜ë¦¬ì˜¤ | ë‹¨ìˆœ(chat) | ë³µí•©(reasoner) | ì›”ê°„ ì´ ë¹„ìš© |
|---|---|---|---|
| í˜„í–‰ (100% chat) | 100ê±´ Ã— â‚©4 | 0ê±´ | ~â‚©12,000 |
| Phase 2 ì ìš© (80/20) | 80ê±´ Ã— â‚©4 | 20ê±´ Ã— â‚©20 | ~â‚©21,600 (+80%) |
| ë³´ìˆ˜ì  (90/10) | 90ê±´ Ã— â‚©4 | 10ê±´ Ã— â‚©20 | ~â‚©16,800 (+40%) |

**ë¹„ìš© ê´€ë¦¬ ë°©ì•ˆ**:
- ì„ê³„ê°’ 4ì  â†’ ì´ˆê¸° ë³´ìˆ˜ì  ì„¤ì •ìœ¼ë¡œ reasoner ë¹„ìœ¨ 10~15% ìœ ì§€
- ë¡œê·¸ ê´€ì°° í›„ ì„ê³„ê°’ ì¡°ì • (ì˜¬ë¦¬ë©´ ë¹„ìš©â†“ ì •í™•ë„â†“, ë‚´ë¦¬ë©´ ë¹„ìš©â†‘ ì •í™•ë„â†‘)
- ì›”ê°„ â‚©30,000 ì´ˆê³¼ ì‹œ ê²½ê³  ì•Œë¦¼ ê²€í†  (ë³„ë„ ê³¼ì œ)

---

### Â§2-6. ë¡¤ë°± ì „ëµ [NEW]

> **v3 ì‹ ì„¤**: Phase 2/3ì— ëŒ€í•œ ëª…ì‹œì  ë¡¤ë°± ê³„íš.

#### Phase 2 ë¹„í™œì„±í™” (ì¦‰ì‹œ ê°€ëŠ¥)

```typescript
// ë°©ë²• 1: classifyComplexityë¥¼ í•­ìƒ "simple" ë°˜í™˜ìœ¼ë¡œ ë³€ê²½
export function classifyComplexity(): "simple" | "complex" {
    return "simple"; // â† ì´ í•œ ì¤„ë¡œ Reasoner ê²½ë¡œ ì™„ì „ ë¹„í™œì„±í™”
}
```

- Reasoner ì½”ë“œë¥¼ ì‚­ì œí•  í•„ìš” ì—†ì´ íŒë³„ê¸°ë§Œ ê³ ì •í•˜ë©´ ê¸°ì¡´ Route 4ë§Œ ì‹¤í–‰
- Edge Function ì¬ë°°í¬ 1íšŒë¡œ ì¦‰ì‹œ ì ìš©

#### Phase 3 ë¹„í™œì„±í™”

- Phase 3ì˜ ìˆ˜í•™ ê³µì‹ ì£¼ì…ì€ `options?.complexity === "complex"` ì¡°ê±´ë¶€
- Phase 2ê°€ ë¹„í™œì„±í™”ë˜ë©´ complexityê°€ í•­ìƒ "simple" â†’ **Phase 3ë„ ìë™ ë¹„í™œì„±í™”**
- ë³„ë„ ë¡¤ë°± ì‘ì—… ë¶ˆí•„ìš”

---

## Phase 3: ë³µí•© ì¶”ë¡  íŒŒì´í”„ë¼ì¸

### Â§3-1. ë„ë©”ì¸ ìˆ˜í•™ ê³µì‹ â€” ì¡°ê±´ë¶€ ì£¼ì… (í† í° ì ˆê°)

#### [MODIFY] edge-function/llm.ts â€” `generateAnswer()`

- **ê¸°ì¡´ ê³„íš(ì „ë©´ ì‚½ì…)**ê³¼ ë‹¬ë¦¬, `options.complexity === "complex"` ì¼ ë•Œë§Œ SYSTEM_PROMPT í•˜ë‹¨ì— ê³µì‹ ì£¼ì…:

```typescript
if (options?.complexity === "complex") {
    systemContent += `\n\n[ê±´ì„¤ ë„ë©”ì¸ ìˆ˜í•™ ê³µì‹ â€” ì°¸ê³ ìš©]
ì»¨í…ìŠ¤íŠ¸ì— ë‹¨ìœ„ í™˜ì‚°ì´ í•„ìš”í•œ ë°ì´í„°ê°€ ìˆì„ ë•Œ ì•„ë˜ ê³µì‹ì„ í™œìš©í•˜ì„¸ìš”.
- ì›í†µ í‘œë©´ì : Ï€ Ã— ì™¸ê²½(m) Ã— ê¸¸ì´(m) = ã¡
- ê°•íŒ ì¤‘ëŸ‰: Ï€ Ã— ì™¸ê²½(m) Ã— ë‘ê»˜(m) Ã— ë¹„ì¤‘(7.85) Ã— ê¸¸ì´(m) = kg/m
- 1í†¤ í™˜ì‚° ê¸¸ì´: 1000kg Ã· (ë‹¨ìœ„ì¤‘ëŸ‰ kg/m) = m
- ë©´ì  í™˜ì‚°: ì›í˜• ë‹¨ë©´ â†’ Ï€ Ã— (D/2)Â² = ã¡
â€» ì´ ê³µì‹ì€ ë¬¼ë¦¬ ìƒìˆ˜ì— ê¸°ë°˜í•œ ê³ ì •ê°’ì´ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`;
}
```

**í† í° ì ˆê° íš¨ê³¼**: ë‹¨ìˆœ ì§ˆë¬¸(80%) ì‹œ ~150í† í° ì ˆì•½ Ã— ì¼ 80ê±´ = **ì›”ê°„ ~360,000í† í° ì ˆê°**

---

### Â§3-2. íƒ€ì… í™•ì¥

#### [MODIFY] edge-function/types.ts â€” `IntentAnalysis`

```diff
 export interface IntentAnalysis {
     intent: "search" | "clarify_needed" | "followup" | "greeting"
-        | "quantity_input" | "cost_calculate" | "modify_request" | "report_request";
+        | "quantity_input" | "cost_calculate" | "modify_request" | "report_request"
+        | "complex_estimate";
+    complexity?: "simple" | "complex";
     work_name: string | null;
     spec: string | null;
     keywords: string[];
     ambiguity_reason: string | null;
     modify_type?: "quantity" | "work_change" | "exclude_labor" | null;
     quantity?: number | null;
 }
```

#### [MODIFY] edge-function/types.ts â€” `AnswerOptions`

> **v3 ì¶”ê°€**: `complexity` í•„ë“œ ì¶”ê°€ â€” Â§3-1ì˜ ì¡°ê±´ë¶€ ê³µì‹ ì£¼ì…ì— í•„ìš”.

```diff
 export interface AnswerOptions {
     intent?: string;
     quantity?: number;
     modifyType?: string;
+    complexity?: "simple" | "complex";
 }
```

#### [MODIFY] edge-function/clarify.ts â€” `validIntents` ë°°ì—´

> **v3 ì¶”ê°€**: `complex_estimate`ë¥¼ ìœ íš¨ intent ëª©ë¡ì— ì¶”ê°€.

```typescript
// clarify.ts:253
const validIntents = [
    "search", "clarify_needed", "followup", "greeting", "quantity_input",
    "cost_calculate", "modify_request", "report_request",
    "complex_estimate",  // â† v3 ì¶”ê°€
];
```

#### [MODIFY] edge-function/index.ts â€” `handleChat()` intent ë¶„ê¸°

> **v3 ì¶”ê°€**: `complex_estimate` intent í•¸ë“¤ëŸ¬.

```typescript
// Route 3 intent ë¶„ê¸° (clarify_needed ì§ì „ì— ì‚½ì…)

// â”€â”€â”€ ë³µí•© ê²¬ì  (complex_estimate) â†’ Route 3.5ë¡œ ê°•ì œ ë¼ìš°íŒ… â”€â”€â”€
if (analysis.intent === "complex_estimate") {
    // complex_estimateëŠ” LLMì´ ì§ì ‘ íŒë³„í•œ ë³µí•© ì§ˆì˜
    // classifyComplexityì™€ ë¬´ê´€í•˜ê²Œ Reasoner ê²½ë¡œë¡œ ì§„ì…
    analysis.complexity = "complex";
    // Route 3.5 ì´í•˜ì—ì„œ ì²˜ë¦¬ (ì•„ë˜ complexity === "complex" ë¶„ê¸°ë¡œ ì§„í–‰)
}
```

---

### Â§3-3. ìš°íšŒ ì¶”ë¡  ê·œì¹™ â€” Chat SYSTEM_PROMPTì— ë„£ì§€ ì•ŠìŒ âŒ

> [!CAUTION]
> Claude ë³´ì • #4 ì—„ê²© ì¤€ìˆ˜: "ìš°íšŒ ì¶”ë¡  í—ˆìš©" ê·œì¹™ì€ Reasoner ì „ìš© í”„ë¡¬í”„íŠ¸ì—ë§Œ ê²©ë¦¬.
> Chat(ë¹„ì‚¬ê³  ëª¨ë“œ)ëŠ” "contextì— ìˆëŠ” ë°ì´í„°ë§Œ ì‚¬ìš©"í•˜ëŠ” ê¸°ì¡´ í™˜ê° ì–µì œ ê·œì¹™ì„ ê·¸ëŒ€ë¡œ ìœ ì§€.

---

## ìˆ˜ì • ëŒ€ìƒ íŒŒì¼ ìš”ì•½

| Phase | íŒŒì¼ | ë³€ê²½ ìœ í˜• | í•µì‹¬ ë³€ê²½ | v3 ë³€ê²½ |
|---|---|---|---|---|
| 4 | `step2.7_create_search_functions.sql` | MODIFY | `_v2()` ì‹ ê·œ (outbound only) | ğŸ”´ íŒŒë¼ë¯¸í„°ëª… ìˆ˜ì •, global_rel ì œì™¸ |
| ~~4~~ | ~~`edge-function/search.ts`~~ | ~~MODIFY~~ | ~~source_section ì§ì ‘ ì°¸ì¡°~~ | âŒ ì‚­ì œ (ì´ë¯¸ ì™„ë£Œ) |
| 4 | `edge-function/index.ts` | MODIFY | buildContext í…Œì´ë¸” ì •í•©ì„± í™•ì¸ | â€” |
| 4 | `edge-function/graph.ts` | MODIFY | RPC v2 ì „í™˜ (**2ê³³**) | ğŸ”´ í˜¸ì¶œë¶€ 2ê³³ ëª…ì‹œ |
| 4 | `edge-function/llm.ts` | MODIFY | 4ì—´ í…Œì´ë¸” ì§€ì‹œë¬¸ | â€” |
| 1.5-C | `parse_13_1_1.py` | MODIFY | 6ê°œ ì¬ì§ˆ í™•ì¥ | ğŸŸ¡ ì†ŒìŠ¤íŒŒì¼ ë§¤í•‘ ì¶”ê°€ |
| 1.5-C | `parse_13_3_1.py` | **NEW** | ë°¸ë¸Œë¥˜ íŒŒì„œ | â€” |
| 1.5-C | `seed_13_3_1.ts` | **NEW** | ë°¸ë¸Œ ë°ì´í„° ì ì¬ | ğŸŸ  ìœ„ì¹˜ edge-function/ë¡œ ë³€ê²½ |
| 1.5-C | ë§ˆì´ê·¸ë ˆì´ì…˜ SQL | **NEW** | complex_table_specs ìŠ¤í‚¤ë§ˆ í™•ì¥ | ğŸŸ¡ v3 ì‹ ì„¤ |
| 2 | `edge-function/clarify.ts` | MODIFY | classifyComplexity() + validIntents | ğŸŸ¡ ë¡œê¹… + validIntents ì¶”ê°€ |
| 2 | `edge-function/llm.ts` | MODIFY | generateReasoningGuide() | ğŸŸ  ì „ì²´ ì½”ë“œ ëª…ì‹œ |
| 2 | `edge-function/index.ts` | MODIFY | Route 3.5 + ì„œí‚·ë¸Œë ˆì´ì»¤ | ğŸ”´ returnë¬¸ ì¶”ê°€ |
| 2 | `frontend/app.js` | MODIFY | Thinking UI | ğŸŸ  ê¸°ì¡´ í•¨ìˆ˜ ê¸°ë°˜ ì¬ì‘ì„± |
| 3 | `edge-function/types.ts` | MODIFY | IntentAnalysis + AnswerOptions í™•ì¥ | ğŸŸ  AnswerOptions.complexity ì¶”ê°€ |
| 3 | `edge-function/llm.ts` | MODIFY | ìˆ˜í•™ ê³µì‹ ì¡°ê±´ë¶€ ì£¼ì… | â€” |
| 3 | `edge-function/index.ts` | MODIFY | complex_estimate í•¸ë“¤ëŸ¬ | ğŸŸ  v3 ì‹ ì„¤ |

> ë³€ê²½ ì—†ëŠ” íŒŒì¼: `config.ts`, `embedding.ts`, `context.ts`, `resolve.ts`, `search.ts` (ê¸°ì¡´ ì½”ë“œ ì•ˆì „)

---

## Verification Plan

### Phase 4 ê²€ì¦
1. `get_related_resources_v2(p_entity_id)` SQL ì ìš© â†’ ê¸°ì¡´ Edge Functionìœ¼ë¡œ ê¸°ì¡´ ì¿¼ë¦¬ ì •ìƒ ë™ì‘ í™•ì¸ (ë¬´ì¤‘ë‹¨ ê²€ì¦)
2. Edge Function ë°°í¬ í›„ `ê°•ê´€ìš©ì ‘ 200mm SCH 40 ë‹¨ê°€ ì•Œë ¤ì¤˜` â†’ í…Œì´ë¸” ëˆ„ë½ ì—†ì´ ë…¸ì¶œ
3. **v3 ì¶”ê°€**: `expandSectionWorkTypes` ê²½ë¡œ ê²€ì¦ â€” ë™ì¼ sectionì˜ WorkType ì—¬ëŸ¬ ê±´ì— ëŒ€í•´ v2ê°€ ì˜¬ë°”ë¥¸ ê´€ê³„ ë°˜í™˜ í™•ì¸
4. êµ¬ë²„ì „ `get_related_resources()` DROP í›„ ì „ì²´ íšŒê·€ í…ŒìŠ¤íŠ¸

### Phase 1.5-C ê²€ì¦
1. `parse_13_1_1.py` í™•ì¥ ì‹¤í–‰ â†’ 6ê°œ ì¬ì§ˆ ë ˆì½”ë“œ ì´ ~1,440ê±´ JSON ìƒì„± í™•ì¸
2. `parse_13_3_1.py` + `seed_13_3_1.ts` â†’ `complex_table_specs` í…Œì´ë¸” ì¹´ìš´íŠ¸ ê²€ì‚¬
3. **v3 ì¶”ê°€**: `complex_table_specs` ìŠ¤í‚¤ë§ˆ í˜¸í™˜ì„± â€” ë°¸ë¸Œ ë°ì´í„° INSERT ì‹œ NULL ì»¬ëŸ¼ ì •ìƒ ì²˜ë¦¬ í™•ì¸
4. ì±—ë´‡: `ìŠ¤í…ë ˆìŠ¤ê°•ê´€ 100mm í”ŒëœíŠ¸ ë°°ê´€ ì„¤ì¹˜ ë…¸ë¬´ë¹„` â†’ Route 0.5 ì •ìƒ ê°ì§€

### Phase 2 & 3 ê²€ì¦
1. ë‹¨ìˆœ ì¿¼ë¦¬ `ê°•ê´€ìš©ì ‘ í’ˆì…ˆ ì•Œë ¤ì¤˜` â†’ Complexity Score < 4, `deepseek-chat` í˜¸ì¶œ í™•ì¸
2. ë³µí•© ì¿¼ë¦¬ `ì›í˜• ë•íŠ¸ 4T 1300mm í•´ì²´ + ë³´ì˜¨ ì² ê±° + ê³ ì†Œì‘ì—… 15m` â†’ `deepseek-reasoner` í˜¸ì¶œ
3. **v3 ì¶”ê°€**: Reasoner ì„±ê³µ ì‹œ Route 4 ë¯¸ì‹¤í–‰ í™•ì¸ (ì´ì¤‘ í˜¸ì¶œ ë°©ì§€)
4. **v3 ì¶”ê°€**: Reasoner íƒ€ì„ì•„ì›ƒ(15ì´ˆ) ì‹œ Route 4 í´ë°± ì •ìƒ ë™ì‘ í™•ì¸
5. ì‘ë‹µ ì‹œê°„: ë‹¨ìˆœ 2~3ì´ˆ, ë³µí•© 5~8ì´ˆ (15ì´ˆ íƒ€ì„ì•„ì›ƒ ë¯¸ë„ë‹¬)
6. í”„ë¡ íŠ¸ì—”ë“œ: 2ì´ˆ ê²½ê³¼ ì‹œ Thinking UI í‘œì‹œ â†’ ì‘ë‹µ ë„ì°© ì‹œ ì •ìƒ ì œê±°
7. ë…¸ë¬´ë¹„ êµì°¨ ê²€ì¦: ë„ë©”ì¸ ê³µì‹ ìˆ˜ê³„ì‚° vs LLM ì¶œë ¥ ëŒ€ì¡°
8. **v3 ì¶”ê°€**: `classifyComplexity` ë¡œê·¸ì—ì„œ score ë¶„í¬ í™•ì¸ (1ì£¼ê°„)
9. **v3 ì¶”ê°€**: ë¡¤ë°± í…ŒìŠ¤íŠ¸ â€” `classifyComplexity` â†’ `return "simple"` ê³ ì • ì‹œ ì „ì²´ ì‹œìŠ¤í…œ ì •ìƒ ë™ì‘

---

## ê¶Œì¥ êµ¬í˜„ ìˆœì„œ

```
Phase 4 (ì¦‰ì‹œ â€” 2~3ì¼)
  â”œâ”€ Day 1: SQL v2 í•¨ìˆ˜ ìƒì„± (p_entity_id íŒŒë¼ë¯¸í„°, outbound only)
  â”œâ”€ Day 2: Edge Function ìˆ˜ì • (graph.ts 2ê³³, index.ts, llm.ts)
  â”œâ”€ Day 2: ë°°í¬ + ê²€ì¦ (expandSectionWorkTypes ê²½ë¡œ í¬í•¨)
  â””â”€ Day 3: êµ¬ë²„ì „ SQL DROP + íšŒê·€ í…ŒìŠ¤íŠ¸
       â†“
Phase 1.5-C (2~3ì¼)
  â”œâ”€ Day 0: ì¬ì§ˆë³„ ì†ŒìŠ¤ MD íŒŒì¼ ë§¤í•‘ í™•ì¸ (download_file/ íƒìƒ‰)
  â”œâ”€ Day 1: parse_13_1_1.py 6ê°œ ì¬ì§ˆ í™•ì¥ + ê²€ì¦
  â”œâ”€ Day 2: parse_13_3_1.py ì‹ ê·œ ì‘ì„± + complex_table_specs ìŠ¤í‚¤ë§ˆ í™•ì¥
  â”œâ”€ Day 2: seed_13_3_1.ts (edge-function/)
  â””â”€ Day 3: DB ì ì¬ + ì±—ë´‡ í†µí•© í…ŒìŠ¤íŠ¸
       â†“
Phase 2 (2~3ì¼)
  â”œâ”€ Day 0: deepseek-reasoner API í˜¸ì¶œ 1íšŒ í…ŒìŠ¤íŠ¸ (staging)
  â”œâ”€ Day 1: types.ts í™•ì¥ + classifyComplexity() + generateReasoningGuide()
  â”œâ”€ Day 2: handleChat Route 3.5 (returnë¬¸ í¬í•¨) + complex_estimate í•¸ë“¤ëŸ¬
  â”œâ”€ Day 2: frontend Thinking UI (ê¸°ì¡´ í•¨ìˆ˜ ê¸°ë°˜)
  â””â”€ Day 3: ë°°í¬ + Reasoner ë¡œê·¸ ê²€ì¦ + ë¹„ìš© ëª¨ë‹ˆí„°ë§ ì‹œì‘
       â†“
Phase 3 (1ì¼)
  â”œâ”€ AnswerOptions.complexity ë°˜ì˜
  â”œâ”€ ìˆ˜í•™ ê³µì‹ ì¡°ê±´ë¶€ ì£¼ì…
  â””â”€ NotebookLM ë¹„êµ í…ŒìŠ¤íŠ¸
       â†“
ë¡¤ë°± ëŒ€ê¸° (1ì£¼)
  â”œâ”€ classifyComplexity ë¡œê·¸ ë¶„ì„ (score ë¶„í¬, reasoner ë¹„ìœ¨)
  â”œâ”€ ë¹„ìš© ì‹¤ì¸¡ ëŒ€ë¹„ Â§2-5 ì¶”ì •ì¹˜ ë¹„êµ
  â””â”€ ì„ê³„ê°’ ì¡°ì • ì—¬ë¶€ ê²°ì •
```

**ì˜ˆìƒ ì´ ì†Œìš”: 8~11ì¼** (v2 ëŒ€ë¹„ +1ì¼ â€” API ì‚¬ì „ ê²€ì¦ ë° ìŠ¤í‚¤ë§ˆ í™•ì¸ ì¶”ê°€)

---

## ë¶€ë¡: ê¸°ì¡´ ê²°í•¨ ì°¸ê³  (ë³¸ ê³„íšì„œ ë²”ìœ„ ì™¸)

> ì•„ë˜ í•­ëª©ì€ ë³¸ ê³„íšì„œì˜ êµ¬í˜„ ë²”ìœ„ì—ëŠ” í¬í•¨ë˜ì§€ ì•Šìœ¼ë‚˜, Phase 2/3 í†µí•© í…ŒìŠ¤íŠ¸ ì‹œ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆì–´ ê¸°ë¡.

| # | í•­ëª© | í˜„ìƒ | ì˜í–¥ |
|---|---|---|---|
| A | `app.js`ì—ì„œ `session_context` ë¯¸ì „ì†¡ | `sendQuestion()`ì´ `question`/`history`ë§Œ ì „ì†¡ | `cost_calculate`, `modify_request` ë“± ì„¸ì…˜ ì˜ì¡´ intentê°€ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë¯¸ë™ì‘ |
| B | `handleChat()` í•¨ìˆ˜ í¬ê¸° (167ì¤„ â†’ ~200ì¤„) | Route 3.5 ì¶”ê°€ë¡œ ë³µì¡ë„ ì¦ê°€ | í–¥í›„ ë¼ìš°íŒ… ë¡œì§ ë¶„ë¦¬(ì˜ˆ: `routeComplex()`) ë¦¬íŒ©í† ë§ ê²€í†  |
| C | `search_entities_typed` RPC ë¯¸ì¶”ì  | `search.ts:449`ì—ì„œ í˜¸ì¶œí•˜ë‚˜ SQL íŒŒì¼ì— ë¯¸í¬í•¨ | DBì— ì§ì ‘ ì¡´ì¬í•  ìˆ˜ ìˆìœ¼ë‚˜, SQL ì¶”ì  íŒŒì¼ì— ì¶”ê°€ í•„ìš” |
