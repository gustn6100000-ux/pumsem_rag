# Phase 4: RAG ê²€ìƒ‰ ë ˆì´ì–´ ë¦¬íŒ©í† ë§ ìƒì„¸ êµ¬í˜„ ê³„íšì„œ

**ì‘ì„±ì¼**: 2026-02-21
**ì„ í–‰ ì™„ë£Œ**: Phase 1.5~3 í†µí•© íŒŒì´í”„ë¼ì¸ (DB í´ë¦° ìƒíƒœ í™•ë³´)
**ëª©ì **: Edge Function ê¸°ë°˜ RAG ê²€ìƒ‰ ë ˆì´ì–´ë¥¼ ê²½ëŸ‰í™”í•˜ê³  `per_unit`/`source_spec` ë Œë”ë§ì„ ì¶”ê°€
**REV**: 1.1 (ì•„í‚¤í…íŠ¸ ë¦¬ë·° Warning A/B/C ë°˜ì˜)

---

## 1. í˜„ì¬ ìƒíƒœ ì§„ë‹¨

### 1-1. DB ìƒíƒœ (Phase 3 ì™„ë£Œ)
- LLM í™˜ê° ë°ì´í„° 948ê±´ ê²©ë¦¬/íê¸° ì™„ë£Œ
- ìˆœìˆ˜ ì—”í‹°í‹° 16,302ê±´ + ì •ë°©í–¥ ë³´ì • ê´€ê³„ 31,118ê±´ Supabase ì ì¬ ì™„ë£Œ
- relationship.properties JSONBì— `per_unit` í•„ë“œ ì´ë¯¸ ì €ì¥ë¨ (`step6_supabase_loader.py:106`)

### 1-2. Edge Function ë ˆê±°ì‹œ ë¬¸ì œì 

| ë¬¸ì œ | ìœ„ì¹˜ | ì„¤ëª… |
|------|------|------|
| ì—­ë°©í–¥ ì¡°íšŒ ì”ì¡´ | `step2.7_create_search_functions.sql:71-82` | `get_related_resources`ê°€ inbound UNION ALL í¬í•¨ |
| JS ì¤‘ë³µ ì œê±° ì”ì¡´ | `search.ts:255-265` | `deduplicateResults()` â€” í´ë¦° DBì—ì„œ ë¶ˆí•„ìš” |
| JS ì¤‘ë³µ ì œê±° ì”ì¡´ | `resolve.ts:813-828` | `deduplicateWorkTypes()` â€” ë™ì¼ ì‚¬ìœ  |
| source_section ì´ì¤‘ ì¿¼ë¦¬ | `search.ts:307-324` | RPCê°€ source_section ë¯¸ë°˜í™˜ â†’ í›„ì† ì¿¼ë¦¬ |
| `per_unit` ë¯¸ë Œë”ë§ | `index.ts:buildContext()` | quantity/unitë§Œ í‘œì‹œ, per_unit ëˆ„ë½ |
| `source_spec` ë¯¸ë Œë”ë§ | `index.ts:buildContext()` | work_type_name í—¤ë”ì—ë§Œ ê°„ì ‘ ë…¸ì¶œ |
| buildContext ì¤‘ë³µ | `index.ts:70-307` + `context.ts:151-371` | ê±°ì˜ ë™ì¼í•œ í•¨ìˆ˜ê°€ 2ê³³ì— ì¡´ì¬ |
| ëª…í™•í™” ê·œì¹™ ë¶€ì¬ | `llm.ts:SYSTEM_PROMPT` | ê·œê²© ëˆ„ë½ ì‹œ ë˜ë¬¼ì–´ì•¼ í•˜ëŠ” ê·œì¹™ ì—†ìŒ |

---

## 2. ì•„í‚¤í…íŠ¸ ë¦¬ë·° ë°˜ì˜ ì‚¬í•­ (Warning A/B/C)

### Warning A: ì—­ë°©í–¥ íƒìƒ‰ ë‹¨ì ˆ ëŒ€ë¹„ â†’ ë°±ë¡œê·¸ ë“±ë¡

`get_related_resources`ì—ì„œ inboundë¥¼ ì œê±°í•˜ë©´ "ìš©ì ‘ê³µì´ íˆ¬ì…ë˜ëŠ” ëª¨ë“  ê³µì¢…" ê°™ì€ ì—­íƒìƒ‰(Bottom-up) ì§ˆì˜ê°€ ë¶ˆê°€ëŠ¥í•´ì§„ë‹¤. í˜„ì¬ íŒŒì´í”„ë¼ì¸(ë¹„ìš© ì‚°ì¶œ ì¤‘ì‹¬)ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì‚­ì œí•˜ë˜, **ì¶”í›„ ì—­íƒìƒ‰ ì „ìš© RPCë¥¼ ë³„ë„ ìƒì„±**í•˜ëŠ” ê²ƒì„ Phase 4 ë°±ë¡œê·¸ì— ê¸°ë¡í•œë‹¤.

- **ë°±ë¡œê·¸ Task**: `get_tasks_by_resource(resource_id TEXT)` RPC ë¶„ë¦¬ ìƒì„±
- **ìš°ì„ ìˆœìœ„**: Low (í˜„ì¬ ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ ì—†ìŒ)
- **íŠ¸ë¦¬ê±° ì¡°ê±´**: "X ì§ì¢…ì´ íˆ¬ì…ë˜ëŠ” ê³µì¢… ëª©ë¡" ë¥˜ì˜ ì—­íƒìƒ‰ UI/ê¸°ëŠ¥ ìš”êµ¬ ì‹œ

### Warning B: ë™ì  ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” â†’ ê³ ì • 4ì—´ ìŠ¤í‚¤ë§ˆ

LLM ì»¨í…ìŠ¤íŠ¸ ë‚´ì—ì„œ 3ì—´ í‘œì™€ 4ì—´ í‘œê°€ í˜¼ì¬ë˜ë©´ ì–´í…ì…˜ ë¶•ê´´ â†’ ë°ì´í„° ì˜¤ë§¤í•‘ í™˜ê° ë°œìƒ ìœ„í—˜.

- **ê²°ì •**: `hasPerUnit` ë™ì  ë¶„ê¸° ë¡œì§ **ì² ê±°**
- **ê³ ì • ìŠ¤í‚¤ë§ˆ**: ë¬´ì¡°ê±´ 4ì—´ `| ì§ì¢… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ê¸°ì¤€ |` ìœ¼ë¡œ ë Œë”ë§
- `per_unit` ê°’ì´ ì—†ëŠ” í–‰ì€ í•˜ì´í”ˆ(`-`)ìœ¼ë¡œ ì±„ì›€

### Warning C: ì •ê·œì‹ íŒŒì‹± â†’ DB ì†ì„± ìš°ì„  ì°¸ì¡°

`workName.match(/\((.+)\)$/)` ì •ê·œì‹ì€ ê´„í˜¸ ì—†ëŠ” ì—”í‹°í‹°ëª…ì´ë‚˜ ë’¤ì— ìˆ˜ì‹ì–´ê°€ ë¶™ëŠ” ê²½ìš° `null`ì„ ë°˜í™˜í•˜ì—¬ ê·œê²© ìœ ì‹¤.

- **ê²°ì •**: ì—”í‹°í‹° ì´ë¦„ í…ìŠ¤íŠ¸ì˜ ì •ê·œì‹ íŒŒì‹±ì„ **1ìˆœìœ„ì—ì„œ ì œê±°**
- **1ìˆœìœ„**: DBì˜ `properties.spec` ë˜ëŠ” relationship `properties.source_spec` ê°ì²´ ì§ì ‘ ì‚¬ìš©
- **ìµœí›„ Fallback**: ìœ„ ê°ì²´ê°€ ë¹„ì–´ìˆì„ ë•Œë§Œ ì •ê·œì‹ìœ¼ë¡œ ë°©ì–´ì  ì¶”ì¶œ

---

## 3. ì‘ì—… ìˆœì„œ ë° ìƒì„¸ êµ¬í˜„

### Track 1. SQL RPC ë¦¬íŒ©í† ë§ (Supabase SQL Editor)

#### Step 1-1. `get_related_resources` â€” ì—­ë°©í–¥(inbound) ì œê±°

**ëŒ€ìƒ íŒŒì¼**: `pipeline/sql/step2.7_create_search_functions.sql` (ë¼ì¸ 55-83)

**í˜„ì¬ ì½”ë“œ**:
```sql
-- outbound: source_id â†’ target_id
SELECT 'outbound'::TEXT AS direction, ...
WHERE r.source_id = p_entity_id
UNION ALL
-- inbound: target_id â†’ source_id  â† ì‚­ì œ ëŒ€ìƒ
SELECT 'inbound'::TEXT AS direction, ...
WHERE r.target_id = p_entity_id;
```

**ë³€ê²½ì•ˆ**:
```sql
CREATE OR REPLACE FUNCTION get_related_resources(p_entity_id TEXT)
RETURNS TABLE(
    direction TEXT,
    relation  TEXT,
    related_id TEXT,
    related_name TEXT,
    related_type TEXT,
    properties JSONB
) AS $$
SELECT
    'outbound'::TEXT AS direction,
    r.relation,
    e.id   AS related_id,
    e.name AS related_name,
    e.type AS related_type,
    r.properties
FROM graph_relationships r
JOIN graph_entities e ON e.id = r.target_id
WHERE r.source_id = p_entity_id;
$$ LANGUAGE sql STABLE;
```

**íŒŒê¸‰íš¨ê³¼**:
- `graph.ts:expandGraph()`ì—ì„œ `r.direction === "inbound"` í•„í„°ë§ ì½”ë“œëŠ” í˜„ì¬ ì—†ìœ¼ë¯€ë¡œ JS ì¸¡ ìˆ˜ì • ë¶ˆí•„ìš”
- `get_entity_hierarchy`ëŠ” **global_relationships** (HAS_CHILD, REFERENCES) ê³„ì¸µ íƒìƒ‰ìš©ì´ë¯€ë¡œ ì–‘ë°©í–¥ ìœ ì§€ â€” **ê±´ë“œë¦¬ì§€ ì•ŠìŒ**
- **(Warning A ëŒ€ë¹„)** ì¶”í›„ ì—­íƒìƒ‰ ì „ìš© `get_tasks_by_resource` RPCë¥¼ ë³„ë„ ìƒì„± ì˜ˆì • (ë°±ë¡œê·¸)

#### Step 1-2. `search_entities_by_embedding` â€” `source_section` ì§ì ‘ ë°˜í™˜

**ëŒ€ìƒ íŒŒì¼**: `pipeline/sql/step2.7_create_search_functions.sql` (ë¼ì¸ 12-49)

**í˜„ì¬ ë¬¸ì œ**: RPCê°€ `source_section`ì„ ë¯¸ë°˜í™˜ â†’ `search.ts:309-324`ì—ì„œ ë³„ë„ DB ì¿¼ë¦¬ í•„ìš”

**ë³€ê²½ì•ˆ**:
```sql
CREATE OR REPLACE FUNCTION search_entities_by_embedding(
    query_embedding_text TEXT,
    match_count INT DEFAULT 5,
    match_threshold FLOAT DEFAULT 0.5
) RETURNS TABLE(
    id TEXT,
    name TEXT,
    type TEXT,
    properties JSONB,
    similarity FLOAT,
    source_section TEXT          -- â† ì‹ ê·œ ì¶”ê°€
) AS $$
DECLARE parsed_vector vector(768);
BEGIN
    IF query_embedding_text IS NULL OR trim(query_embedding_text) = '' THEN
        RETURN;
    END IF;
    BEGIN
        parsed_vector := query_embedding_text::vector(768);
    EXCEPTION WHEN OTHERS THEN
        RETURN;
    END;
    RETURN QUERY
    SELECT ge.id, ge.name, ge.type, ge.properties,
           (1 - (ge.embedding <=> parsed_vector))::FLOAT AS similarity,
           ge.source_section                             -- â† ì‹ ê·œ ì¶”ê°€
    FROM graph_entities ge
    WHERE ge.embedding IS NOT NULL
      AND 1 - (ge.embedding <=> parsed_vector) > match_threshold
    ORDER BY ge.embedding <=> parsed_vector
    LIMIT match_count;
END;
$$ LANGUAGE plpgsql STABLE;
```

**íŒŒê¸‰íš¨ê³¼**: `search.ts:307-324`ì˜ source_section í›„ì† ì¿¼ë¦¬ ë¸”ë¡ ì „ì²´ ì‚­ì œ ê°€ëŠ¥ (DB ì™•ë³µ 1íšŒ ì ˆê°)

---

### Track 2. Edge Function ê²½ëŸ‰í™”

#### Step 2-1. `search.ts` â€” ë ˆê±°ì‹œ ì‚­ì œ

**ëŒ€ìƒ íŒŒì¼**: `edge-function/search.ts`

**ì‚­ì œ ëŒ€ìƒ**:

1. **`deduplicateResults()` í•¨ìˆ˜ ì‚­ì œ** (ë¼ì¸ 255-265)
   ```typescript
   // ì‚­ì œ: DB í´ë¦° ìƒíƒœì—ì„œ ì¤‘ë³µ ì—”í‹°í‹° ì—†ìŒ
   export function deduplicateResults<T extends ...>(results: T[]): T[] { ... }
   ```

2. **`deduplicateResults()` í˜¸ì¶œ ì§€ì  ë³€ê²½** (ë¼ì¸ 509, 516)
   ```typescript
   // ë³€ê²½ ì „:
   return deduplicateResults([...chunkResults, ...vectorResults.filter(...)]);
   return deduplicateResults(vectorResults);

   // ë³€ê²½ í›„:
   return [...chunkResults, ...vectorResults.filter(e => !chunkIds.has(e.id))];
   return vectorResults;
   ```

3. **source_section í›„ì† ì¿¼ë¦¬ ë¸”ë¡ ì‚­ì œ** (ë¼ì¸ 307-324)
   - Track 1 Step 1-2ì—ì„œ RPCê°€ ì§ì ‘ ë°˜í™˜í•˜ë¯€ë¡œ ë¶ˆí•„ìš”
   ```typescript
   // ì „ì²´ ì‚­ì œ ëŒ€ìƒ:
   if (entities.length > 0) {
       const ids = entities.map((e) => e.id);
       const { data: fullEntities } = await supabase
           .from("graph_entities")
           .select("id, source_section")
           .in("id", ids);
       if (fullEntities) {
           const sectionMap = new Map(
               (fullEntities as any[]).map((e: any) => [e.id, e.source_section])
           );
           entities.forEach((e) => {
               e.source_section = sectionMap.get(e.id) || undefined;
           });
       }
   }
   ```

#### Step 2-2. `resolve.ts` â€” ë ˆê±°ì‹œ ì‚­ì œ

**ëŒ€ìƒ íŒŒì¼**: `edge-function/resolve.ts`

**ì‚­ì œ ëŒ€ìƒ**:
1. **`deduplicateWorkTypes()` í•¨ìˆ˜ ì‚­ì œ** (ë¼ì¸ 813-828)
2. **í˜¸ì¶œ ì§€ì  ì‚­ì œ** (ë¼ì¸ 211)
   ```typescript
   // ë³€ê²½ ì „:
   workTypes = deduplicateWorkTypes(workTypes);
   // ë³€ê²½ í›„: í–‰ ì‚­ì œ
   ```

#### Step 2-3. `buildContext` ì¤‘ë³µ í†µí•©

**í˜„ì¬ ìƒíƒœ**: `buildContext()`ê°€ 2ê³³ì— ê±°ì˜ ë™ì¼í•˜ê²Œ ì¡´ì¬
- `context.ts:151-371` â€” importìš©ìœ¼ë¡œ exportë˜ì–´ ìˆìœ¼ë‚˜ **ì‹¤ì œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ**
- `index.ts:70-307` â€” `handleChat` íŒŒì´í”„ë¼ì¸ ë‚´ë¶€ì—ì„œ ì‹¤ì œ ì‚¬ìš©

**ë°©ì¹¨**: `context.ts`ì˜ `buildContext()`ë¥¼ ì‚­ì œí•˜ê³ , `index.ts`ì˜ ê²ƒë§Œ ìœ ì§€

#### Step 2-4. `per_unit` + `source_spec` ë Œë”ë§ ì¶”ê°€ (Warning B/C ë°˜ì˜)

**ëŒ€ìƒ íŒŒì¼**: `edge-function/index.ts`ì˜ `buildContext()` í•¨ìˆ˜

##### (A) íˆ¬ì… ì¸ë ¥ í…Œì´ë¸” â€” ê³ ì • 4ì—´ ìŠ¤í‚¤ë§ˆ (Warning B ë°˜ì˜)

**í˜„ì¬** (index.ts:171-179, ê·œê²©ë³„ ê·¸ë£¹ ë‚´ë¶€):
```typescript
parts.push("| ì§ì¢… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ |");
parts.push("| --- | ---: | --- |");
laborItems.forEach((l) => {
    const props = (l.properties || {}) as any;
    parts.push(`| ${l.related_name} | ${props.quantity ?? "-"} | ${props.unit ?? "ì¸"} |`);
});
```

**ë³€ê²½ì•ˆ (ê³ ì • 4ì—´)**:
```typescript
// âš ï¸ Warning B ë°˜ì˜: ë¬´ì¡°ê±´ 4ì—´ ê³ ì • ìŠ¤í‚¤ë§ˆ (3ì—´/4ì—´ í˜¼ì¬ ê¸ˆì§€)
parts.push("| ì§ì¢… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ê¸°ì¤€ |");
parts.push("| --- | ---: | --- | --- |");
laborItems.forEach((l) => {
    const props = (l.properties || {}) as any;
    parts.push(
        `| ${l.related_name} | ${props.quantity ?? "-"} | ${props.unit ?? "ì¸"} | ${props.per_unit ?? "-"} |`
    );
});
```

ë™ì¼ íŒ¨í„´ì„ **ì¥ë¹„(REQUIRES_EQUIPMENT)** (ë¼ì¸ 196-208)ì™€ **ìì¬(USES_MATERIAL)** (ë¼ì¸ 210-222)ì—ë„ ì ìš©:
```typescript
// ì¥ë¹„: ê³ ì • 4ì—´
parts.push("| ì¥ë¹„ëª… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ê¸°ì¤€ |");
parts.push("| --- | ---: | --- | --- |");
equipment.forEach((eq) => {
    const props = (eq.properties || {}) as any;
    parts.push(`| ${eq.related_name} | ${props.quantity ?? "-"} | ${props.unit ?? "-"} | ${props.per_unit ?? "-"} |`);
});

// ìì¬: ê³ ì • 4ì—´
parts.push("| ìì¬ëª… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ê¸°ì¤€ |");
parts.push("| --- | ---: | --- | --- |");
material.forEach((m) => {
    const props = (m.properties || {}) as any;
    parts.push(`| ${m.related_name} | ${props.quantity ?? "-"} | ${props.unit ?? "-"} | ${props.per_unit ?? "-"} |`);
});
```

##### (B) source_spec í‘œì‹œ â€” DB ì†ì„± ìš°ì„  ì°¸ì¡° (Warning C ë°˜ì˜)

**í˜„ì¬** (index.ts:169):
```typescript
parts.push(`**${workName}**`);
```

**ë³€ê²½ì•ˆ (DB ì†ì„± 1ìˆœìœ„, ì •ê·œì‹ ìµœí›„ Fallback)**:
```typescript
// âš ï¸ Warning C ë°˜ì˜: DB properties.spec 1ìˆœìœ„, ì •ê·œì‹ì€ ìµœí›„ Fallback
// workNameì— ëŒ€ì‘í•˜ëŠ” ì—”í‹°í‹°ì˜ propertiesì—ì„œ spec ì¶”ì¶œ ì‹œë„
const relSpec = laborItems[0] ? (laborItems[0].properties as any)?.source_spec : null;
// 1ìˆœìœ„: DBì˜ relationship properties.source_spec
// 2ìˆœìœ„: DBì˜ entity properties.spec (expandGraphì—ì„œ ì£¼ì…ëœ work_type_nameì— í¬í•¨)
// ìµœí›„ Fallback: ì´ë¦„ í…ìŠ¤íŠ¸ì—ì„œ ê´„í˜¸ íŒŒì‹±
let specLabel = relSpec || null;
if (!specLabel) {
    const match = workName.match(/\((.+)\)$/);
    if (match) specLabel = match[1];
}
if (specLabel) {
    parts.push(`**${workName}** (source_spec: ${specLabel})`);
} else {
    parts.push(`**${workName}**`);
}
```

##### (C) ë‹¨ìˆœ í…Œì´ë¸”(hasWorkType=false, hasMatrix=false)ì—ë„ ê³ ì • 4ì—´ ì ìš©

**ëŒ€ìƒ** (index.ts:181-192): work_type_nameì´ ì—†ëŠ” ë‹¨ìˆœ ì¸ë ¥ í…Œì´ë¸”ì—ë„ ë™ì¼í•˜ê²Œ ê³ ì • 4ì—´ `| ì§ì¢… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ê¸°ì¤€ |` ì ìš©.

##### (D) ë§¤íŠ¸ë¦­ìŠ¤ íŒ¨í„´(hasMatrix=true, ìì„¸Ã—ì§ì¢…) í…Œì´ë¸”ì— per_unit í—¤ë” ì¶”ê°€

**ëŒ€ìƒ** (index.ts:125-148): ë§¤íŠ¸ë¦­ìŠ¤ í…Œì´ë¸”ì˜ í—¤ë” ë¼ì¸ì— per_unit ì •ë³´ë¥¼ ì¶”ê°€:
```typescript
// ê¸°ì¡´: parts.push(`**[í‘œ ${sectionId}] íˆ¬ì… ì¸ë ¥**\n`);
// ë³€ê²½: per_unit ì •ë³´ê°€ ìˆìœ¼ë©´ ê¸°ì¤€ í‘œê¸°
const samplePerUnit = labor[0] ? (labor[0].properties as any)?.per_unit : null;
const basisLabel = samplePerUnit ? ` (${samplePerUnit})` : "";
parts.push(`**[í‘œ ${sectionId}] íˆ¬ì… ì¸ë ¥${basisLabel}**\n`);
```

---

### Track 3. System Prompt íŠœë‹

**ëŒ€ìƒ íŒŒì¼**: `edge-function/llm.ts`ì˜ `SYSTEM_PROMPT` ìƒìˆ˜

**ì¶”ê°€í•  ê·œì¹™** (ê¸°ì¡´ `[ë‹µë³€ ê·œì¹™]` ì„¹ì…˜ í•˜ë‹¨, `[ê¸ˆì§€ ì‚¬í•­]` ì§ì „ì— ì‚½ì…):

```
[ëª…í™•í™” ê·œì¹™ â€” ê·œê²© ëˆ„ë½ ì‹œ ë°˜ë“œì‹œ ë˜ë¬¼ì–´ë¼]
1. ì‚¬ìš©ìê°€ ê³µì¢…ëª…ë§Œ ì§ˆë¬¸í•˜ê³  ê·œê²©(source_spec)ì„ ëˆ„ë½í•œ ê²½ìš°:
   - ì˜ˆ: "ê°•ê´€ìš©ì ‘ í’ˆì…ˆ ì•Œë ¤ì¤˜" (ê·œê²© ì—†ìŒ)
   - ì»¨í…ìŠ¤íŠ¸ì— 3ê°œ ì´ìƒì˜ ê·œê²©(200 SCH 40, 250 SCH 80 ë“±)ì´ ì¡´ì¬í•˜ë©´,
     ì „ì²´ë¥¼ ë‚˜ì—´í•˜ì§€ ë§ê³  "ì–´ë–¤ ê·œê²©ì˜ í’ˆì…ˆì„ ì°¾ìœ¼ì‹œë‚˜ìš”?"ë¼ê³  ë˜ë¬¼ì–´ë¼.
   - ë‹¨, ê·œê²©ì´ 1~2ê°œë¿ì´ë©´ ì „ì²´ë¥¼ ë³´ì—¬ì¤˜ë„ ëœë‹¤.
2. ê¸°ì¤€ ë‹¨ìœ„(per_unit) í‘œê¸°:
   - ì»¨í…ìŠ¤íŠ¸ì˜ "ê¸°ì¤€" ì»¬ëŸ¼ì— "1mÂ³ë‹¹", "ê°œì†Œë‹¹", "10më‹¹" ë“±ì´ ìˆìœ¼ë©´
     ë‹µë³€ í…Œì´ë¸”ì˜ í—¤ë” ë˜ëŠ” ë³¸ë¬¸ì— ë°˜ë“œì‹œ í•´ë‹¹ ê¸°ì¤€ì„ ëª…ì‹œí•˜ë¼.
   - ì˜ˆ: "ğŸ“‹ [í‘œ 13-2-3] ê°•ê´€ìš©ì ‘(200, SCH 40) â€” **ê°œì†Œë‹¹** íˆ¬ì… ì¸ë ¥"
3. source_spec ì •ë³´ê°€ ì»¨í…ìŠ¤íŠ¸ì— ìˆìœ¼ë©´ ë‹µë³€ì— ë°˜ë“œì‹œ í¬í•¨í•˜ë¼.
   - ì˜ˆ: "ê·œê²©: í˜¸ì¹­ê²½ 200mm, SCH 40"
```

**íŒŒê¸‰íš¨ê³¼**:
- LLM ë‹µë³€ ìƒì„± ë‹¨ê³„ì—ì„œë§Œ ì‘ë™ â†’ ê²€ìƒ‰/ê·¸ë˜í”„ í™•ì¥ ë¡œì§ì— ì˜í–¥ ì—†ìŒ
- `clarify.ts:analyzeIntent()`ì˜ ì˜ë„ ë¶„ì„ì—ì„œ ì´ë¯¸ `clarify_needed` íŒì • ë¡œì§ì´ ìˆìœ¼ë¯€ë¡œ, ì˜ë„ ë¶„ì„ì„ í†µê³¼í•œ `search` â†’ ë‹¤ìˆ˜ ê·œê²© ë°ì´í„°ê°€ contextì— ì‹¤ë¦° ê²½ìš°ì— System Promptê°€ **ë³´ì¡° ì•ˆì „ì¥ì¹˜**ë¡œ ì‘ë™

---

## 4. ìˆ˜ì • ëŒ€ìƒ íŒŒì¼ ìš”ì•½

| ìˆœì„œ | íŒŒì¼ | ë³€ê²½ ìœ í˜• | ë³€ê²½ ë‚´ìš© | Warning ë°˜ì˜ |
|------|------|-----------|-----------|-------------|
| Step 1-1 | `pipeline/sql/step2.7_create_search_functions.sql` | SQL ìˆ˜ì • | `get_related_resources` inbound ë¸”ë¡ ì œê±° | A |
| Step 1-2 | `pipeline/sql/step2.7_create_search_functions.sql` | SQL ìˆ˜ì • | `search_entities_by_embedding` source_section ì¶”ê°€ | - |
| Step 2-1 | `edge-function/search.ts` | ì½”ë“œ ì‚­ì œ | `deduplicateResults()` ì‚­ì œ + source_section í›„ì†ì¿¼ë¦¬ ì‚­ì œ | - |
| Step 2-2 | `edge-function/resolve.ts` | ì½”ë“œ ì‚­ì œ | `deduplicateWorkTypes()` ì‚­ì œ | - |
| Step 2-3 | `edge-function/context.ts` | ì½”ë“œ ì‚­ì œ | ë¯¸ì‚¬ìš© `buildContext()` ì‚­ì œ | - |
| Step 2-4 | `edge-function/index.ts` | ì½”ë“œ ìˆ˜ì • | `buildContext()` ê³ ì • 4ì—´ + DBì†ì„± ìš°ì„  source_spec | B, C |
| Step 3 | `edge-function/llm.ts` | í”„ë¡¬í”„íŠ¸ ìˆ˜ì • | `SYSTEM_PROMPT` ëª…í™•í™” ê·œì¹™ + per_unit í‘œê¸° ê·œì¹™ ì¶”ê°€ | - |

---

## 5. Phase 4 ë°±ë¡œê·¸

| Task | ì„¤ëª… | ìš°ì„ ìˆœìœ„ | íŠ¸ë¦¬ê±° ì¡°ê±´ |
|------|------|----------|------------|
| `get_tasks_by_resource` RPC | ì—­íƒìƒ‰ ì „ìš© SQL í•¨ìˆ˜ ë¶„ë¦¬ ìƒì„± (Warning A) | Low | "X ì§ì¢…ì´ íˆ¬ì…ë˜ëŠ” ê³µì¢… ëª©ë¡" ë¥˜ì˜ ì—­íƒìƒ‰ ìš”êµ¬ ì‹œ |

---

## 6. ê²€ì¦ ë°©ë²•

### 6-1. SQL ê²€ì¦ (Supabase SQL Editor)
```sql
-- get_related_resources: inbound ì œê±° í™•ì¸
SELECT * FROM get_related_resources('W-0001') LIMIT 10;
-- â†’ direction ì»¬ëŸ¼ì— 'inbound'ê°€ ì—†ì–´ì•¼ í•¨

-- search_entities_by_embedding: source_section ë°˜í™˜ í™•ì¸
SELECT * FROM search_entities_by_embedding('[0.1, 0.2, ...]'::TEXT, 3, 0.3);
-- â†’ source_section ì»¬ëŸ¼ì´ í¬í•¨ë˜ì–´ì•¼ í•¨
```

### 6-2. Edge Function ê²€ì¦ (ë¡œì»¬ ë˜ëŠ” ë°°í¬ í›„)
```bash
# í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ 1: per_unit ê³ ì • 4ì—´ ë Œë”ë§ í™•ì¸
curl -X POST <EDGE_FUNCTION_URL> \
  -H "Content-Type: application/json" \
  -H "x-api-key: <KEY>" \
  -d '{"question": "ê°•ê´€ìš©ì ‘ 200mm SCH 40 í’ˆì…ˆ"}'
# â†’ ì‘ë‹µ contextì— "| ì§ì¢… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ | ê¸°ì¤€ |" ê³ ì • 4ì—´ì´ì–´ì•¼ í•¨
# â†’ per_unit ê°’ì´ ì—†ëŠ” í–‰ì€ "-"ìœ¼ë¡œ ì±„ì›Œì ¸ì•¼ í•¨

# í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ 2: ê·œê²© ëˆ„ë½ ì‹œ ëª…í™•í™” ë™ì‘ í™•ì¸
curl -X POST <EDGE_FUNCTION_URL> \
  -d '{"question": "ê°•ê´€ìš©ì ‘ í’ˆì…ˆ ì•Œë ¤ì¤˜"}'
# â†’ clarify ì‘ë‹µ ë˜ëŠ” LLMì´ ê·œê²©ì„ ë˜ë¬¼ì–´ì•¼ í•¨

# í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ 3: source_spec DB ì†ì„± ê¸°ë°˜ í‘œì‹œ í™•ì¸
curl -X POST <EDGE_FUNCTION_URL> \
  -d '{"question": "ê°•ê´€ìš©ì ‘ 200mm SCH 40 ì¸ë ¥"}'
# â†’ ì‘ë‹µì— "source_spec: ..." í˜•íƒœê°€ í¬í•¨ë˜ì–´ì•¼ í•¨
# â†’ ì •ê·œì‹ íŒŒì‹±ì´ ì•„ë‹Œ DB properties ê¸°ë°˜ì´ì–´ì•¼ í•¨
```

### 6-3. Warning B ì „ìš© ê²€ì¦
```
per_unitì´ ìˆëŠ” ê³µì¢…ê³¼ ì—†ëŠ” ê³µì¢…ì„ ì—°ì†ìœ¼ë¡œ ê²€ìƒ‰í–ˆì„ ë•Œ,
ë‘ ê²°ê³¼ ëª¨ë‘ ë™ì¼í•œ 4ì—´ ìŠ¤í‚¤ë§ˆ(|ì§ì¢…|ìˆ˜ëŸ‰|ë‹¨ìœ„|ê¸°ì¤€|)ë¡œ ë Œë”ë§ë˜ëŠ”ì§€ í™•ì¸:
- per_unit ìˆëŠ” ê²½ìš°: ê¸°ì¤€ ì»¬ëŸ¼ì— "ê°œì†Œë‹¹", "10më‹¹" ë“± í‘œì‹œ
- per_unit ì—†ëŠ” ê²½ìš°: ê¸°ì¤€ ì»¬ëŸ¼ì— "-" í‘œì‹œ
- 3ì—´ í…Œì´ë¸”ì´ í˜¼ì¬ë˜ë©´ ì•ˆ ë¨
```

### 6-4. íšŒê·€ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ê¸°ì¡´ entity_id ì§ì ‘ ì¡°íšŒ (Route 1) ì •ìƒ ë™ì‘
- [ ] section_id full_view (Route 2) ì •ìƒ ë™ì‘
- [ ] ì˜ë„ ë¶„ì„ â†’ clarify ë¶„ê¸° (Route 3) ì •ìƒ ë™ì‘
- [ ] ë²¡í„° ê²€ìƒ‰ â†’ answer íŒŒì´í”„ë¼ì¸ (Route 4) ì •ìƒ ë™ì‘
- [ ] ë¹„ìš© ì‚°ì¶œ (cost_calculate) ì •ìƒ ë™ì‘
- [ ] ë„ë©”ì¸ ë™ì˜ì–´ ê²€ìƒ‰ (PEê´€, ìœµì°© ë“±) ì •ìƒ ë™ì‘
- [ ] ë§¤íŠ¸ë¦­ìŠ¤ íŒ¨í„´ í…Œì´ë¸” (ê°•ê´€ìš©ì ‘ êµ¬ê²½Ã—SCH) ì •ìƒ ë Œë”ë§
