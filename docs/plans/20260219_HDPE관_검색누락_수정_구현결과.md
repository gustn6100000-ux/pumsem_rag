# HDPE관 검색 누락 수정 — 구현 결과 보고서

- **작성일**: 2026-02-19
- **작성자**: AI Architect (Antigravity)
- **관련 모듈**: Edge Function (`rag-chat`)
- **배포 크기**: 122.1kB

---

## 1. 문제 정의

### 1.1 현상
- 사용자가 **"hdpe관"**으로 검색 시 `"관련된 품셈 항목을 찾지 못했습니다"` 반환
- 반면 **"pe관"**으로 검색 시에는 정상적으로 10개 이상의 결과 반환

### 1.2 영향 범위
- DB에 존재하는 핵심 엔티티 **"가스용 폴리에틸렌(PE)관 접합 및 부설"** (W-0727, source_section: `11-3#2`)이 검색 불가
- PE 계열 전체 WorkType 5건 이상 누락

---

## 2. 근본 원인 분석 (Root Cause)

### 2.1 원인 1: AND 순서 패턴 (search.ts, resolve.ts)

`targetSearch` 2단계와 `resolveBySearch` 전략 2에서 키워드 결합 시 **AND 순서 패턴**을 사용:

```typescript
// 기존 코드 (search.ts L338, resolve.ts L325)
const pattern = "%" + searchTerms.join("%") + "%";
// keywords = ["HDPE관", "PE관", "PE", "폴리에틸렌"] 일 때:
// → pattern = "%HDPE관%PE관%PE%폴리에틸렌%"
// → 이름에 "HDPE관", "PE관", "PE", "폴리에틸렌"이 순서대로 모두 포함되어야 매칭
```

**"가스용 폴리에틸렌(PE)관 접합 및 부설"**에는 `HDPE관`이 없어 매칭 실패.

### 2.2 원인 2: 짧은 영문 키워드 noise

DeepSeek LLM 의도 분석에서 `keywords: ["HDPE관", "PE관", "PE", "폴리에틸렌"]`을 반환.  
이 중 **"PE" (2글자)**가 ILIKE `%PE%` 패턴에 의해 아래 항목들과 매칭:

| 매칭된 항목                 | PE 포함 위치 |
| --------------------------- | ------------ |
| Front **Pe**destal 설치     | 단어 중간    |
| S**pe**ed ring 조립설치     | 단어 중간    |
| Shield u**ppe**r cover 설치 | 단어 중간    |

→ 이 noise 항목들이 `LIMIT 20/50`을 채워 정작 "가스용 폴리에틸렌(PE)관"이 밀려남.

### 2.3 원인 3: LLM 프롬프트에 역방향 확장 규칙 부재

INTENT_SYSTEM_PROMPT에 `"PE관" → ["PE관", "HDPE관"]` 규칙만 있고,  
**역방향** `"HDPE관" → ["PE관", "PE", "폴리에틸렌"]` 확장 규칙이 없어 LLM이 적절한 키워드를 생성하지 못함.

### 2.4 원인 4: ruleBasedIntent 폴백에 영문 약어 확장 없음

LLM 호출 실패 시 `ruleBasedIntent`로 폴백되는데, 이 함수에서 "hdpe" → "PE" 변환 로직이 없어 DB 매칭 불가.

---

## 3. 수정 내용

### 3.1 clarify.ts — LLM 프롬프트 + 폴백 로직

#### 3.1.1 INTENT_SYSTEM_PROMPT 수정 (L85-88)

```diff
- 동의어 확장: "PE관" → ["PE관", "HDPE관"]
+ 동의어 확장: "PE관" → ["PE관", "HDPE관"], "HDPE관" → ["HDPE관", "PE관", "PE드럼", "폴리에틸렌"]
+ ⭐ 약어/접두어 확장: HDPE는 PE의 하위 종류이므로 반드시 PE관 등 한글 복합어로 keywords에 포함
+   예: "HDPE관" → keywords: ["HDPE관", "PE관", "PE드럼", "폴리에틸렌"], work_name: "PE관"
+ ⛔ 금지: "PE", "PV" 같은 2글자 영문 약어를 단독으로 keywords에 넣지 마세요!
+   반드시 한글과 결합한 복합어로 (PE관, PE드럼, PVC관)
```

**설계 의도**: DeepSeek가 2글자 영문 약어를 단독 키워드로 생성하는 것을 프롬프트 레벨에서 차단.

#### 3.1.2 KO_EN_DICT 추가 (L113)

```typescript
"에이치디피이": ["HDPE", "PE"], "피이": ["PE"],
```

**설계 의도**: 한국어 발음 입력(`에이치디피이`)도 영문 약어로 변환.

#### 3.1.3 ENG_EXPAND 딕셔너리 수정 (L153-161)

```diff
- const ENG_EXPAND: Record<string, string[]> = {
-     "HDPE": ["PE", "폴리에틸렌"], "hdpe": ["PE", "폴리에틸렌"],
-     "PVC": ["PVC관"], "pvc": ["PVC관"],
- };
+ const ENG_EXPAND: Record<string, string[]> = {
+     "HDPE": ["PE관", "PE드럼", "HDPE관", "폴리에틸렌"],
+     "PVC": ["PVC관"],
+ };
```

**설계 의도**: 영문 약어를 **한글 복합어**로 확장하여 ILIKE 검색 시 noise 방지.  
- 기존: `HDPE → PE` (2글자 → Pedestal, Speed 등에 매칭)
- 변경: `HDPE → PE관, PE드럼, HDPE관, 폴리에틸렌` (복합어 → 정확한 매칭)

---

### 3.2 search.ts — targetSearch 2단계 키워드 검색

#### 수정 위치: L337-382

**기존 코드:**
```typescript
const pattern = "%" + searchTerms.join("%") + "%";
// → %HDPE관%PE관%PE%폴리에틸렌% (AND 순서)
const { data } = await supabase
    .from("graph_entities")
    .or(`name.ilike.${pattern},...`)
    .limit(5);
```

**수정 코드:**
```typescript
// ⭐ ILIKE 검색에는 noise가 적은 키워드만 사용
// - 한글 키워드: 항상 포함 (PE관, PE드럼, 폴리에틸렌)
// - 영문 ≥ 4자: 포함 (HDPE)
// - 영문 ≤ 3자: 제외 (PE → noise 방지)
const dedupTerms = [...new Set(searchTerms.filter(t => t.length >= 2))];
const ilikeTerms = dedupTerms.filter(t => {
    const isAllEnglish = /^[A-Za-z]+$/.test(t);
    return !isAllEnglish || t.length >= 4;
});

const orClauses = ilikeTerms
    .map(t => `name.ilike.%${t}%`)
    .join(",");
// → name.ilike.%HDPE관%,name.ilike.%PE관%,name.ilike.%PE드럼%,name.ilike.%폴리에틸렌% (OR)

const { data } = await supabase
    .from("graph_entities")
    .or(orClauses)
    .limit(50);  // 5→50 확대

// 관련도 정렬: 매칭 키워드 수 + 원문 한글어 매칭 보너스
const questionKorean = question.match(/[가-힣]+/g) || []; // "관"
const scored = data.map((e: any) => {
    let score = 0;
    const nameLower = e.name.toLowerCase();
    for (const t of dedupTerms) {
        if (nameLower.includes(t.toLowerCase())) score += 2;
    }
    for (const k of questionKorean) {
        if (nameLower.includes(k)) score += 1; // "관" 포함 시 +1
    }
    return { ...e, _score: score };
});
scored.sort((a, b) => b._score - a._score);
return toEntityResults(scored.slice(0, 20), 0.95);
```

**핵심 변경점:**

| 항목      | 기존                   | 변경                                    |
| --------- | ---------------------- | --------------------------------------- |
| 패턴 방식 | AND 순서 (`join("%")`) | OR 독립 (`각 키워드별`)                 |
| 짧은 영문 | ILIKE에 포함           | **4자 미만 영문 제외**                  |
| 결과 수   | limit 5                | limit 50 → 정렬 후 상위 20              |
| 정렬      | DB 순서 그대로         | **매칭 키워드 수 + 원문 한글어 보너스** |

---

### 3.3 resolve.ts — resolveBySearch 전략 2

#### 수정 위치: L324-336

**기존 코드:**
```typescript
// 전략 2: WorkType 직접 탐색
const workPattern = "%" + searchTerms.join("%") + "%";
const { data: workTypes } = await supabase
    .from("graph_entities")
    .eq("type", "WorkType")
    .or(`name.ilike.${workPattern},properties->>"korean_alias".ilike.${workPattern}`)
    .limit(200);
```

**수정 코드:**
```typescript
// 전략 2: WorkType 직접 탐색 (OR 검색)
// ⭐ 짧은 영문 단독(PE 등 ≤3자)은 noise 방지로 제외
const safeWorkTerms = searchTerms.filter((t: string) => {
    const isAllEng = /^[A-Za-z]+$/.test(t);
    return t.length >= 2 && (!isAllEng || t.length >= 4);
});
const wTerms = safeWorkTerms.length > 0 ? safeWorkTerms : searchTerms.filter((t: string) => t.length >= 2);
const workOrClauses = wTerms.map((t: string) => `name.ilike.%${t}%`).join(",");
const { data: workTypes } = await supabase
    .from("graph_entities")
    .eq("type", "WorkType")
    .or(workOrClauses)
    .limit(200);
```

**설계 의도**: `graphClarify` → `resolveSection` → `resolveBySearch` 경로에서도 동일한 OR 검색 + 영문 필터 적용.

---

## 4. 검색 흐름 아키텍처 (수정 후)

```
사용자 입력: "hdpe관"
    │
    ├─ analyzeIntent (DeepSeek v3.2)
    │   └─ work_name: "PE관"
    │   └─ keywords: ["HDPE관", "PE관", "PE드럼", "폴리에틸렌"]  ← "PE" 단독 금지
    │   └─ intent: "clarify_needed" or "search"
    │
    ├─[intent=clarify_needed]─→ graphClarify
    │   └─ resolveSection
    │       └─ resolveBySearch
    │           ├─ 전략 1: Section ILIKE (%PE관%)
    │           ├─ 전략 2: WorkType OR검색 ← 수정됨
    │           │   └─ name.ilike.%HDPE관% OR name.ilike.%PE관% OR name.ilike.%PE드럼% OR ...
    │           ├─ 전략 3: 키워드별 독립검색
    │           └─ 전략 4: chunk text fallback
    │
    └─[intent=search]─→ searchPipeline
        └─ targetSearch
            ├─ 1단계: work_name+spec ILIKE
            ├─ 2단계: 키워드 OR검색 + 관련도 정렬 ← 수정됨
            │   └─ 짧은 영문(PE) 제외 + 매칭 수 + 원문 한글어 보너스
            ├─ 3단계: 벡터 검색
            └─ 4단계: chunk text fallback
```

---

## 5. 테스트 결과

### 5.1 수정 전 (Before)

| 검색어   | 결과                                   |
| -------- | -------------------------------------- |
| "hdpe관" | ❌ "관련된 품셈 항목을 찾지 못했습니다" |
| "pe관"   | ✅ 10개 항목 정상                       |

### 5.2 수정 후 (After)

| 검색어   | 결과                 | 항목 수     |
| -------- | -------------------- | ----------- |
| "hdpe관" | ✅ **18개 항목** 반환 | PE관련 전체 |

### 5.3 주요 반환 항목 (수정 후)

| 구분     | 항목명                                   | section_code |
| -------- | ---------------------------------------- | ------------ |
| ✅ 핵심   | **가스용 폴리에틸렌(PE)관 접합 및 부설** | 11-3#2       |
| ✅        | 가교화 폴리에틸렌관 접합 및 배관 (16mm)  | 1-6-3#2      |
| ✅        | 가교화 폴리에틸렌관 접합 및 배관 (20mm)  | 1-6-3#2      |
| ✅        | PE드럼 설치 및 해체                      | 2-9-4        |
| ✅        | PE가설방호벽 설치 및 해체                | 2-9-5        |
| ✅        | PE가설휀스 설치 및 해체                  | 2-9-8        |
| ✅        | HDPE 시트 설치                           | 5-4-1        |
| ✅        | 배관보온 해체(발포폴리에틸렌보온재)      | 4-1-4        |
| ❌ 제거됨 | ~~Front Pedestal 설치~~                  | noise        |
| ❌ 제거됨 | ~~Speed ring 조립설치~~                  | noise        |
| ❌ 제거됨 | ~~Shield upper cover 설치~~              | noise        |

### 5.4 Noise 제거 확인

| 항목                         | 기존       | 수정 후            |
| ---------------------------- | ---------- | ------------------ |
| Front Pedestal (PE 포함)     | 포함       | **제거**           |
| Speed ring (PE 포함)         | 포함       | **제거**           |
| Shield upper cover (PE 포함) | 포함       | **제거**           |
| 관련 PE/HDPE 항목            | 5건 미노출 | **18건 전체 노출** |

---

## 6. 수정 파일 요약

| 파일                       | 수정 내용                                                                             | 수정 라인              |
| -------------------------- | ------------------------------------------------------------------------------------- | ---------------------- |
| `edge-function/clarify.ts` | INTENT_SYSTEM_PROMPT 역방향 확장 + PE 단독 금지 + ENG_EXPAND 복합어 + KO_EN_DICT 추가 | L85-88, L113, L153-161 |
| `edge-function/search.ts`  | targetSearch 2단계 OR 검색 + 영문 필터 + 관련도 정렬                                  | L337-382               |
| `edge-function/resolve.ts` | resolveBySearch 전략 2 OR 검색 + 영문 필터                                            | L324-336               |

---

## 7. 파급 효과 (Side Effect) 분석

### 7.1 긍정적 영향
- **모든 약어 검색**: HDPE뿐 아니라 향후 유사 약어(PVC, GIP 등) 검색에도 동일 패턴 재사용 가능
- **Noise 감소**: 짧은 영문 필터링으로 전체 검색 품질 향상

### 7.2 주의 사항
- **OR 검색 확대**: limit 50으로 확대 → DB 쿼리 비용 미미하게 증가 (graph_entities 인덱스 활용)
- **3자 영문 필터**: "TIG", "MIG" 같은 3자 영문은 ILIKE에서 제외됨 → `expandAbbreviations` 함수에서 별도 처리 중이므로 영향 없음
- **resolve.ts 전략 2**: `properties->>"korean_alias"` ILIKE 검색이 제거됨 → 전략 3에서 keyword별 독립 검색이 이를 대체
