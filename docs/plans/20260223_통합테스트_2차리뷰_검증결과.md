# 통합 테스트 보고서 2차 리뷰 — 사실 확인 결과

> **작성일**: 2026-02-23 11:50  
> **리뷰어**: Claude Code (지적) → Antigravity Architect (사실 확인)  
> **대상**: `20260223_통합테스트_10케이스_결과보고서.md`  
> **결론**: 4건 지적 중 **3건 정당**, 1건 향후 조사 필요

---

## 이슈 1: TC10 Route 3.5 미발화 — ✅ 지적 정확

### Claude Code 지적

> TC10("철근콘크리트 타설 30톤 + 거푸집 설치 + 철근 배근 조립 노무비 산출")은 `classifyComplexity` 점수가 3pt로 임계값(4pt) 미달이며 Route 3.5가 발화되지 않았을 가능성이 높다.

### 코드 대조 검증 (`clarify.ts:33-64`)

```typescript
export function classifyComplexity(question: string, analysis: IntentAnalysis): "simple" | "complex" {
    let score = 0;
    if (question.length >= 60) score += 2;
    else if (question.length >= 30) score += 1;           // TC10: 36자 → +1pt

    const workKeywords = ["해체", "철거", "타설", "용접", "설치", "제작", "보온", "배관", "미장", "조적"];
    // TC10: '타설'✅ '설치'✅ → 2개 매칭  → +2pt

    const conditionKeywords = ["고소작업", "고소", "할증", "야간", "지하", "공간"];
    // TC10: 해당 없음                     → +0pt

    const unitMatches = question.match(/\d+(mm|t|ton|m|㎡|㎥|개소|본|T|kg)/gi);
    // TC10: '30톤' → '톤'은 regex 목록에 없음 (ton만 있음) → 매칭 0개 → +0pt

    if (/합산|포함해서|전체|총액|계산해/i.test(question)) score += 2;
    // TC10: '노무비 산출' → '산출'은 목록에 없음           → +0pt

    // 합계: 1 + 2 + 0 + 0 + 0 = 3pt → simple ❌
}
```

### 결론

| TC | 점수 산출 | 결과 | Route 3.5 |
|:---:|---|:---:|:---:|
| TC8 | 1(길이) + 2(해체+철거) + 1(고소작업) + 1(4T+1300mm+15m) = **5pt** | complex | ✅ 발화 |
| TC9 | 1(길이) + 2(용접+보온) + 0 + 1(200mm+50mm) = **4pt** | complex | ✅ 발화 |
| TC10 | 1(길이) + 2(타설+설치) + 0 + 0 = **3pt** | **simple** | ❌ **미발화** |

**보고서 수정 필요**: TC10은 Route 3.5가 아닌 Route 4(`searchPipeline`)로 처리되었습니다.

---

## 이슈 2: Route 3.5 발화 증거 불충분 — ✅ 지적 타당

### Claude Code 지적

> 보고서는 "응답 시간 증가로 확인"만을 근거로 삼고 있으며, 이는 간접 증거에 불과하다.

### 사실 확인

코드에 이미 로그가 내장되어 있으므로 서버 로그로 직접 확인 가능합니다:

```typescript
// classifyComplexity 내부 (clarify.ts L62)
console.log(`[classifyComplexity] Score: ${score} -> ${isComplex}`);

// Route 3.5 조건문 (index.ts L1148)
console.log(`[handleChat] 🎯 Route 3.5 (Complex) triggered.`);
```

단, Supabase Edge Function 로그 API는 `event_message`에 HTTP 요약만 포함하고 `console.log` 내용은 Dashboard에서만 확인 가능합니다.

### 결론

| 근거 유형 | 현재 보고서 | 보완 경로 |
|---|---|---|
| 응답 시간 (간접) | ✅ 사용 중 | 보조 근거로만 유지 |
| 서버 로그 (직접) | ❌ 미확인 | Supabase Dashboard → Functions → Logs에서 확인 가능 |
| 코드 분석 (논리적) | ❌ 미사용 | 위 이슈 1의 점수 산출표로 보완 완료 |

---

## 이슈 3: Phase 4 플랫 테이블 형식 미검증 — ✅ 지적 타당 → 검증 완료

### Claude Code 지적

> TC5와 TC7이 answer를 반환했지만 실제 응답 텍스트가 없어 Phase 4의 핵심 변경(`renderFlatTable`, `SYSTEM_PROMPT` 4열 지시)이 적용됐는지 확인 불가.

### 검증 실행

TC5("강관용접 200mm SCH 40 품셈")를 재실행하여 응답 텍스트 확인:

```
📌 **[표 13-2-3] 강관용접 → 전기아크용접**
📍 출처: 기계설비부문 > 제13장 플랜트설비공사 > 강관용접

| 직종/장비명 | 수량 | 단위 | 규격 |
| :--- | :--- | :--- | :--- |
| 플랜트 용접공 | 0.287 | 인 | 200, SCH 40 |
```

### 결론

- **4열 플랫 구조 정상 확인** (`직종/장비명 | 수량 | 단위 | 규격`)
- Phase 4의 `renderFlatTable` + `SYSTEM_PROMPT` 지시가 **정상 적용됨**
- 구버전의 교차표 형식(`| 직종 | 200 SCH 20 | 200 SCH 40 |`)은 완전히 제거됨

---

## 이슈 4: TC5 응답시간 20.6s — ⚠️ 향후 조사 필요

### Claude Code 지적

> 규격이 명확히 지정된 단순 검색임에도 20.6초 소요. TC6(밸브, 11.2s)보다 2배 느림.

### 분석

현재 `search_info`에 세부 breakdown(embedding 시간, RPC 시간, LLM 시간)이 없어 원인 특정 불가.

**예상 병목 후보:**

| 후보 | 가능성 | 근거 |
|---|:---:|---|
| `expandGraph()`에서 형제 WorkType 과다 조회 | 높음 | 13-1-1(배관설치)은 재질×규격 조합이 수백 건 |
| DeepSeek v3 LLM 응답 대기 | 중간 | LLM 콜드스타트 또는 긴 컨텍스트 |
| 중복 RPC 호출 | 낮음 | `get_related_resources_v2`는 outbound만 조회 |

**개선 방향**: `search_info`에 단계별 타이밍(`embed_ms`, `rpc_ms`, `llm_ms`)을 추가하여 병목을 정량적으로 추적하는 것을 Phase 3에서 반영.

---

## classifyComplexity 개선 제안

Claude Code의 분석에서 드러난 regex 누락 3건:

| 현재 미인식 | 개선안 | 영향 |
|---|---|---|
| 한글 '톤' | regex에 `톤` 추가: `/\d+(mm\|t\|ton\|톤\|m\|...)/gi` | TC10 물리량 +1pt 가능 |
| '산출' 키워드 | 복합 명시어에 `산출\|산정` 추가 | TC10 복합 +2pt 가능 |
| `+` 연산자 | `question.includes('+')` → +1pt 규칙 추가 | 명시적 다중 공종 커버 |

위 3건 적용 시 TC10 점수: 1 + 2 + 0 + 1(톤) + 2(산출) = **6pt → complex**로 정상 분류됨.

> ⚠️ **단, 이 개선은 Phase 3 착수 시 적용할 사항이며, 현 보고서는 현재 코드 기준의 사실만 기록합니다.**

---

## 보고서 정오표

| 위치 | 현재 기술 | 수정 |
|---|---|---|
| TC10 판정 | "Route 3.5 정상 발화" | **"Route 4 직행 (score 3pt < 임계값 4pt)"** |
| Category C 설명 | "TC8~TC10 모두 Route 3.5 발화" | **"TC8-TC9만 Route 3.5 발화 (score ≥4), TC10은 Route 4"** |
| Route 3.5 증거 | "응답 시간 증가로 확인" | **"TC8: 코드 분석상 5pt → complex 확정. TC9: 4pt → complex 확정"** |
| Phase 4 검증 | 응답 텍스트 없음 | **TC5 응답에서 4열 플랫 테이블 확인 (`\| 플랜트 용접공 \| 0.287 \| 인 \| 200, SCH 40 \|`)** |
