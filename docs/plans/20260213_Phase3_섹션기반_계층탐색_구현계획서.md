# Phase 3: 섹션 기반 계층 탐색 (Section-First Clarification) 구현계획서

**작성일**: 2026-02-13  
**버전**: v1.0  
**목적**: 품셈 데이터의 섹션 → 청크 → 하목 계층 구조를 활용하여, 사용자 의도를 정확한 섹션에 먼저 매칭한 후 하위 항목으로 드릴다운하는 2단계 명확화 흐름 구현

---

## 1. 현황 분석

### 1.1 데이터 구조 (이미 구축 완료)

```
graph_entities (13,387건)
├── Section (1,218건)    ← 절 단위 (8-3-1, 9-1-2 등)
├── WorkType (4,733건)   ← 하목 단위 (규격철물 설치_경량철재 등)
├── Note (4,763건)       ← 비고/조건
├── Labor (417건)        ← 직종
├── Equipment (1,016건)  ← 장비
├── Material (746건)     ← 자재
└── Standard (494건)     ← 기준

graph_relationships (24,323건)
├── REQUIRES_LABOR (8,590)  ← WorkType → Labor (인력 수량)
├── HAS_NOTE (6,103)        ← WorkType → Note
├── BELONGS_TO (5,060)      ← WorkType → Section
├── REQUIRES_EQUIPMENT (2,057)
├── USES_MATERIAL (1,659)
└── APPLIES_STANDARD (854)

graph_global_relationships (2,126건)
└── 부문 → 장 → 절 계층 관계

graph_chunks (2,105건)
├── section_id     ← "8-3-1#3", "9-1-2#3" (섹션 매핑 키)
├── department     ← "건축부문", "기계설비부문"
├── chapter        ← "제8장 금속공사"
├── title          ← "잡철물 제작 및 설치"
├── text           ← 원문 전체 (평균 ~1,200자)
├── tables         ← 품셈 테이블 (JSON)
├── notes          ← 비고 사항 (JSON)
└── conditions     ← 적용 조건 (JSON)
```

### 1.2 현재 문제

| #      | 문제                     | 증거                                                              |
| ------ | ------------------------ | ----------------------------------------------------------------- |
| **P1** | 섹션 선택 단계 누락      | "잡철물 제작" → 바로 WorkType 6개 나열 (8-3-1 vs 9-1-2 선택 없음) |
| **P2** | 메시지-옵션 불일치       | 메시지: "건축부문 > 제8장" / 옵션: 전부 [기계설비]                |
| **P3** | graph_chunks 미활용      | 원문 text, tables, notes, conditions가 clarify에서 활용 안 됨     |
| **P4** | 단일 단계 clarify만 존재 | 복수 섹션 → 하목 선택의 2단계 드릴다운 불가                       |

---

## 2. 목표 흐름 설계

### 2.1 2단계 Clarify Flow

```
사용자: "잡철물 제작"
        │
        ▼
═══ Step 1: 섹션 선택 ═══════════════════════════════════
│                                                        │
│  "잡철물 제작 및 설치" 품셈이 2개 분야에 있습니다.     │
│  어떤 분야를 찾으시나요?                                │
│                                                        │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 건축부문 > 제8장 금속공사 > 8-3-1 잡철물 제작 및 설치│ │
│  └───────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 기계설비부문 > 제9장 기타공사 > 9-1-2 잡철물 제작 및 설치│ │
│  └───────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 📋 전체 분야 모두 보기                             │ │
│  └───────────────────────────────────────────────────┘ │
═════════════════════════════════════════════════════════
        │
   (사용자가 "기계설비부문" 선택)
        │
        ▼
═══ Step 2: 하목 선택 or 전체 조회 ═══════════════════════
│                                                        │
│  기계설비부문 > 9-1-2 잡철물 제작 및 설치              │
│  하위 6개 작업이 있습니다. 어떤 작업의 품셈을 찾으시나요?│
│                                                        │
│  ┌──────────────────────────────────────┐              │
│  │ 📋 9-1-2 전체 내용 보기 (원문 포함)  │              │
│  └──────────────────────────────────────┘              │
│  ┌──────────────────────────────────────┐              │
│  │ 현장제작 설치_경량철재                │              │
│  └──────────────────────────────────────┘              │
│  ┌──────────────────────────────────────┐              │
│  │ 현장제작 설치_일반철재                │              │
│  └──────────────────────────────────────┘              │
│  ┌──────────────────────────────────────┐              │
│  │ 규격철물 설치_경량철재                │              │
│  └──────────────────────────────────────┘              │
│         ... (나머지 WorkType)                          │
═════════════════════════════════════════════════════════
        │
   (사용자가 "현장제작 설치_경량철재" 선택)
        │
        ▼
═══ 답변 생성 ═══════════════════════════════════════════
│ graph_chunks에서 section_id="9-1-2#3" 원문 조회       │
│ + graph_relationships에서 W-5264의 노무/장비 조회     │
│ → LLM에 전달 → 정확한 답변 생성                       │
═════════════════════════════════════════════════════════
```

### 2.2 단일 섹션이면 Step 1 스킵

```
사용자: "모르타르 배합" → 섹션 1개 (9-1-1) → Step 1 스킵 → Step 2로 직행
사용자: "강관용접 200mm" → 정확 매칭 1개 → clarify 없이 즉시 답변
```

---

## 3. 구현 상세

### 3.1 수정 대상 파일

| 파일         | 수정 내용                                                           |
| ------------ | ------------------------------------------------------------------- |
| `index.ts`   | `graphClarify()` 리팩터링, `handleChat()` section_id 기반 분기 추가 |
| `index.html` | clarify chip에 `section_id` 전달, Step 2 UI 렌더링                  |

### 3.2 `graphClarify()` 리팩터링

#### 현재 로직
```
graphClarify(analysis)
  → Section ILIKE + WorkType ILIKE + 키워드 검색
  → 결과 전부 합쳐서 관련성 점수 정렬
  → WorkType > 3이면 케이스A (WorkType 나열)
  → Section > 1이면 케이스B (Section 나열)
  → 그 외 케이스C
```

#### 변경 로직
```
graphClarify(analysis, sectionId?)
  │
  ├── sectionId 있음 (Step 2) ─────────────┐
  │   → graph_chunks에서 section_id로 조회    │
  │   → 해당 section의 WorkType 조회          │
  │   → "전체 내용 보기" + WorkType 옵션 반환 │
  │                                            │
  └── sectionId 없음 (Step 1) ─────────────┐
      → Section ILIKE 검색                   │
      → graph_chunks JOIN으로 부문/장/절 메타 │
      │                                      │
      ├── Section 2개↑ (복수 분야)            │
      │   → 분야별 Section 옵션 반환          │
      │   → 각 옵션에 section_id 포함         │
      │                                      │
      ├── Section 1개 (단일 분야)             │
      │   → 해당 Section의 WorkType 조회      │
      │   → WorkType > 1이면 Step 2 옵션 반환 │
      │   → WorkType 0~1이면 즉시 검색        │
      │                                      │
      └── Section 0개                        │
          → WorkType 직접 검색               │
          → 기존 로직 유지                   │
```

### 3.3 `ChatRequest` 인터페이스 확장

```typescript
interface ChatRequest {
    question: string;
    history?: ChatMessage[];
    entity_id?: string;     // WorkType 직접 조회 (기존)
    section_id?: string;    // Step 2: 섹션 내 하목 선택 (신규)
}
```

### 3.4 `ClarifyOption` 인터페이스 확장

```typescript
interface ClarifyOption {
    label: string;
    query: string;
    entity_id?: string;       // WorkType 직접 조회
    source_section?: string;  // 출처 표시용
    section_id?: string;      // Step 2 트리거용 (신규)
    option_type?: 'section' | 'worktype' | 'full_view';  // 옵션 유형 (신규)
}
```

### 3.5 `handleChat()` 흐름 수정

```
handleChat(question, history, entityId?, sectionId?)
  │
  ├── Phase -1: entityId 있음 → 직접 조회 (기존, 변경 없음)
  │
  ├── Phase -0.5: sectionId 있음 (신규) ──────────────────┐
  │   → graphClarify(analysis, sectionId)                  │
  │   → 해당 Section 내 WorkType 옵션 반환 (Step 2)       │
  │   → OR WorkType 1개면 즉시 답변                        │
  │                                                        │
  ├── Phase 0: 의도 분석                                   │
  │                                                        │
  ├── Phase 1: targetSearch → entities 조회                │
  │   → Section만 매칭 + 복수?                             │
  │     → YES: graphClarify(analysis) → Step 1 반환        │
  │     → NO (Section 1개): sectionId 자동 설정 → Step 2   │
  │                                                        │
  └── Phase 2+: 기존 답변 생성 흐름                       │
```

### 3.6 프론트엔드 수정 (`index.html`)

#### clarify chip 렌더링 변경

```javascript
// 현재
onclick="handleClarifyClick('${query}', '${entityId}')"

// 변경: option_type에 따라 다른 동작
// option_type === 'section' → sectionId 전달 (Step 2 트리거)
// option_type === 'worktype' → entityId 전달 (직접 조회)  
// option_type === 'full_view' → sectionId + 전체 보기 플래그

onclick="handleClarifyClick('${query}', '${entityId}', '${sectionId}', '${optionType}')"
```

#### `sendMessage()` 수정

```javascript
async function sendMessage(entityId = null, sectionId = null) {
    const reqBody = { question, history };
    if (entityId) reqBody.entity_id = entityId;
    if (sectionId) reqBody.section_id = sectionId;  // 신규
    // ...
}
```

#### `handleClarifyClick()` 수정

```javascript
function handleClarifyClick(query, entityId, sectionId, optionType) {
    userInput.value = query;
    userInput.dispatchEvent(new Event('input'));
    
    if (optionType === 'section') {
        // Step 2: 섹션 내 하목 선택
        sendMessage(null, sectionId);
    } else if (optionType === 'worktype') {
        // 직접 조회
        sendMessage(entityId, null);
    } else if (optionType === 'full_view') {
        // 섹션 전체 내용
        sendMessage(null, sectionId);
    } else {
        sendMessage(entityId, null);
    }
}
```

### 3.7 graph_chunks 활용 강화

#### "전체 내용 보기" 선택 시

```typescript
// sectionId로 graph_chunks 원문 조회
const { data: chunk } = await supabase
    .from("graph_chunks")
    .select("id, section_id, title, department, chapter, text, tables, notes, conditions")
    .eq("section_id", sectionId)
    .limit(1);

// 원문 text + tables + notes + conditions를 LLM 컨텍스트에 포함
const context = [
    `## 원문: ${chunk.title}`,
    `**출처**: ${chunk.department} > ${chunk.chapter}`,
    `**본문**:\n${chunk.text}`,
    chunk.tables ? `**테이블**:\n${JSON.stringify(chunk.tables)}` : "",
    chunk.notes ? `**비고**:\n${JSON.stringify(chunk.notes)}` : "",
    chunk.conditions ? `**적용조건**:\n${JSON.stringify(chunk.conditions)}` : "",
].join("\n\n");
```

---

## 4. 기대 동작 시나리오

### 시나리오 A: 복수 분야 (잡철물)

| 단계 | 사용자                        | 챗봇                                              |
| ---- | ----------------------------- | ------------------------------------------------- |
| 1    | "잡철물 제작"                 | **2개 분야** 선택: 건축(8-3-1) / 기계설비(9-1-2)  |
| 2    | [기계설비] 클릭               | **6개 하목** 선택: 전체보기 / 현장제작_경량 / ... |
| 3    | [현장제작 설치_경량철재] 클릭 | 원문 + 노무(철공 9.17인, 용접공 3.34인...) 답변   |

### 시나리오 B: 단일 분야 (모르타르 배합)

| 단계 | 사용자          | 챗봇                                                   |
| ---- | --------------- | ------------------------------------------------------ |
| 1    | "모르타르 배합" | Section 1개 → **Step 1 스킵** → 하목 선택 or 즉시 답변 |

### 시나리오 C: 정확 매칭 (강관용접 200mm SCH 40)

| 단계 | 사용자                  | 챗봇                                            |
| ---- | ----------------------- | ----------------------------------------------- |
| 1    | "강관용접 200mm SCH 40" | WorkType 정확 매칭 → **clarify 없이** 즉시 답변 |

---

## 5. 수정 범위 요약

| #   | 파일         | 함수/영역              | 변경 내용                                            | 난이도 |
| --- | ------------ | ---------------------- | ---------------------------------------------------- | ------ |
| 1   | `index.ts`   | `ChatRequest`          | `section_id` 필드 추가                               | ⭐      |
| 2   | `index.ts`   | `ClarifyOption`        | `section_id`, `option_type` 필드 추가                | ⭐      |
| 3   | `index.ts`   | `graphClarify()`       | sectionId 파라미터 추가, 2단계 분기 로직             | ⭐⭐⭐    |
| 4   | `index.ts`   | `handleChat()`         | Phase -0.5 (sectionId 처리), Section 단일/복수 분기  | ⭐⭐⭐    |
| 5   | `index.ts`   | 신규 함수              | `getChunkContext(sectionId)` — 원문+테이블+비고 조회 | ⭐⭐     |
| 6   | `index.html` | `sendMessage()`        | sectionId 파라미터 추가                              | ⭐      |
| 7   | `index.html` | `handleClarifyClick()` | optionType별 분기                                    | ⭐⭐     |
| 8   | `index.html` | chip 렌더링            | section_id, option_type 속성 반영                    | ⭐⭐     |

---

## 6. 우선순위 및 실행 순서

```
Phase 3-1: 백엔드 기반 구축 (인터페이스 + graphClarify 리팩터링)
    → ChatRequest, ClarifyOption 확장
    → graphClarify(analysis, sectionId?) 구현
    → getChunkContext(sectionId) 구현

Phase 3-2: handleChat 흐름 수정
    → Phase -0.5 (sectionId 처리) 추가
    → Section 복수/단일 분기 로직
    → "전체 보기" 시 graph_chunks 원문 컨텍스트 주입

Phase 3-3: 프론트엔드 수정
    → sendMessage(entityId, sectionId) 확장
    → handleClarifyClick(query, entityId, sectionId, optionType) 확장
    → chip 렌더링에 option_type별 스타일/동작

Phase 3-4: 배포 + 통합 테스트
    → "잡철물 제작" 시나리오 A 전체 흐름 검증
    → "모르타르 배합" 시나리오 B (Step 1 스킵) 검증
    → "강관용접 200mm" 시나리오 C (즉시 답변) 검증
```

---

## 7. 파급 효과 (A3 Ontological Integrity)

| 영역                | 영향           | 대응                                       |
| ------------------- | -------------- | ------------------------------------------ |
| 기존 entity_id 흐름 | 변경 없음      | entity_id와 section_id는 독립 경로         |
| Phase -1 직접 조회  | 변경 없음      | entityId 우선 → sectionId 차선             |
| targetSearch        | 변경 없음      | graphClarify만 변경                        |
| buildContext        | 원문 청크 추가 | getChunkContext 결과를 기존 context에 병합 |
| analyzeIntent       | 변경 없음      | clarify_needed 판단은 그대로               |
