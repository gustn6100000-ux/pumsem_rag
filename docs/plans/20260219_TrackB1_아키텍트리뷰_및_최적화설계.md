# Track B-1: ì•„í‚¤í…íŠ¸ Post-Mortem ë¦¬ë·° ë° ìµœì í™” ì„¤ê³„

> **ì‘ì„±ì¼:** 2026-02-19  
> **ìƒíƒœ:** íŠ¸ë™ 1 êµ¬í˜„ ìŠ¹ì¸  
> **ì„ í–‰ ë¬¸ì„œ:** `20260219_TrackB1_ë„ë©”ì¸ë™ì˜ì–´ê²€ìƒ‰_ê¸°ìˆ ì„œ.md`

---

## 1. Post-Mortem í‰ê°€: 3ëŒ€ ê·¼ë³¸ ì›ì¸ í•´ë¶€

### 1.1 DevOps â€” ì„€ë„ìš° ë°°í¬(Shadow Deployment) íƒì§€

| í•­ëª© | ë‚´ìš© |
|------|------|
| **í˜„ìƒ** | ì½”ë“œ ìˆ˜ì • í›„ 4íšŒ ë°°í¬(v100~v103)í–ˆìœ¼ë‚˜ ëŸ°íƒ€ì„ ë³€í™” ì—†ìŒ |
| **ì›ì¸** | ê°œë°œ ê²½ë¡œ(`edge-function/`)ì™€ ë°°í¬ ê²½ë¡œ(`supabase/functions/rag-chat/`)ê°€ ë¬¼ë¦¬ì ìœ¼ë¡œ ë¶„ë¦¬ |
| **íƒì§€ ë°©ë²•** | ë””ë²„ê·¸ íƒœê·¸ `[debug]`ë¥¼ ì½”ë“œì— ì‚½ì… â†’ ì‘ë‹µì— ë¯¸ì¶œë ¥ í™•ì¸ â†’ `grep` ê²€ìƒ‰ìœ¼ë¡œ ë°°í¬ ëŒ€ìƒ íŒŒì¼ì— ìˆ˜ì •ì‚¬í•­ 0ê±´ í™•ì¸ |
| **ë“±ê¸‰** | ğŸ”´ Critical â€” ëª¨ë“  ìˆ˜ì •ì´ ë¬´íš¨í™”ë¨ |

```mermaid
graph LR
    A["ìˆ˜ì •: edge-function/*.ts"] -->|"âŒ ì—°ê²° ì—†ìŒ"| C["ë°°í¬: supabase/functions/rag-chat/*.ts"]
    B["npx supabase deploy"] --> C
    C --> D["Supabase Edge Runtime"]
    style A fill:#ff6b6b,color:#fff
    style C fill:#51cf66,color:#fff
```

> [!CAUTION]
> **ì„€ë„ìš° ë°°í¬ì˜ ìœ„í—˜ì„±:** ê°œë°œìëŠ” ì½”ë“œê°€ ìˆ˜ì •ë˜ì—ˆë‹¤ê³  í™•ì‹ í•˜ì§€ë§Œ, ì‹¤ì œ í”„ë¡œë•ì…˜ì—ëŠ” êµ¬ë²„ì „ì´ ì‹¤í–‰. ë””ë²„ê·¸ íƒœê·¸ ì‚½ì…ì´ ìœ ì¼í•œ ê²€ì¦ ìˆ˜ë‹¨ì´ì—ˆìŒ.

---

### 1.2 Routing â€” LLM ë¹„ê²°ì •ì  ë¶„ê¸°ì˜ ì–‘ë©´ ë°©ì–´

| í•­ëª© | ë‚´ìš© |
|------|------|
| **í˜„ìƒ** | `resolve.ts` íŒ¨ì¹˜ í›„ì—ë„ ì‘ë‹µ ë³€í™” ì—†ìŒ |
| **ì›ì¸** | LLM `analyzeIntent`ê°€ ë™ì¼ ì§ˆë¬¸ì— `intent: "search"` ë˜ëŠ” `intent: "clarify_needed"`ë¥¼ **ë¹„ê²°ì •ì ìœ¼ë¡œ ë°˜í™˜** |
| **ì‹¤ì œ ê²½ë¡œ** | `searchPipeline`(index.ts L629) â†’ `targetSearch` â†’ `sectionOnly` ë¶„ê¸° |
| **ì˜¤íŒ ê²½ë¡œ** | `graphClarify` â†’ `resolveSection` â†’ `resolveBySearch` â†’ `presentClarify` |
| **ë“±ê¸‰** | ğŸŸ¡ Medium â€” ì–‘ìª½ ëª¨ë‘ íŒ¨ì¹˜ í•„ìš” |

```mermaid
flowchart TD
    A["handleChat"] --> B["analyzeIntent(LLM)"]
    B -->|"intent: search/answer<br/>(ì‹¤ì œ ê²½ë¡œ)"| C["searchPipeline<br/>index.ts L629"]
    B -->|"intent: clarify_needed<br/>(ê°€ì • ê²½ë¡œ)"| D["graphClarify<br/>clarify.ts L284"]
    C --> E["targetSearch â†’ sectionOnly â†’ clarify ì‘ë‹µ"]
    D --> F["resolveSection â†’ resolveBySearch â†’ presentClarify"]
    
    style C fill:#4ecdc4,color:#fff
    style D fill:#ffe066,color:#333
    style B fill:#ff8787,color:#fff
```

> [!IMPORTANT]
> **ë¹„ê²°ì •ì  ë¼ìš°í„° ë°©ì–´ ì›ì¹™:** LLM ê¸°ë°˜ ë¼ìš°íŒ…ì—ì„œëŠ” **ê°€ëŠ¥í•œ ëª¨ë“  ë¶„ê¸°ì— ë™ì¼í•œ ê¸°ëŠ¥ì„ ì¤‘ë³µ ë°°ì¹˜**í•´ì•¼ í•œë‹¤. í•œìª½ë§Œ íŒ¨ì¹˜í•˜ë©´ LLMì˜ ë¶„ë¥˜ ê²°ê³¼ì— ë”°ë¼ ê°„í—ì ìœ¼ë¡œ ê¸°ëŠ¥ì´ ë™ì‘/ë¯¸ë™ì‘í•˜ëŠ” ìœ ë ¹ ë²„ê·¸(Phantom Bug)ê°€ ë°œìƒ.

---

### 1.3 Semantic Logic â€” ëŒ€ì†Œë¬¸ì ë¹„êµ ì‹¤íŒ¨

| í•­ëª© | ë‚´ìš© |
|------|------|
| **í˜„ìƒ** | `DOMAIN_SYNONYM_MAP["PEê´€"]`ì— ë™ì˜ì–´ê°€ ë“±ë¡ë˜ì–´ ìˆìœ¼ë‚˜ `"peê´€"` ì…ë ¥ ì‹œ ë§¤ì¹­ ì‹¤íŒ¨ |
| **ì›ì¸** | `term.includes(key)` â€” JavaScript `String.includes()`ëŠ” case-sensitive |
| **ìˆ˜ì •** | `term.toUpperCase().includes(key.toUpperCase())` |
| **ë“±ê¸‰** | ğŸŸ¢ Low â€” ìˆ˜ì • ê°„ë‹¨í•˜ë‚˜ ì„íŒ©íŠ¸ í¼ |

```typescript
// Before (case-sensitive)
if (term.includes(key) || key.includes(term))
// â†’ "peê´€".includes("PEê´€") === false âŒ

// After (case-insensitive)
if (termUpper.includes(keyUpper) || keyUpper.includes(termUpper))
// â†’ "PEê´€".includes("PEê´€") === true âœ…
```

---

## 2. ì”ì¡´ ê¸°ìˆ  ë¶€ì±„ ë° ì•„í‚¤í…ì²˜ ì†”ë£¨ì…˜

### 2.1 íŠ¸ë™ 1: ì‘ë‹µ ì§€ì—° ìµœì í™” (`Promise.all` ë³‘ë ¬í™”)

> **ìƒíƒœ:** âœ… êµ¬í˜„ ìŠ¹ì¸  
> **ì˜ˆìƒ ì‘ì—…ì‹œê°„:** 15ë¶„  
> **ì˜ˆìƒ íš¨ê³¼:** +1.4s â†’ +0.1~0.2s (ë™ì˜ì–´ ì¿¼ë¦¬ I/Oê°€ targetSearchì— ì™„ì „íˆ ê°€ë ¤ì§)

#### ë¬¸ì œ

```mermaid
sequenceDiagram
    participant EF as Edge Function
    participant DB as Supabase DB
    
    Note over EF: searchPipeline ì‹œì‘
    EF->>DB: targetSearch (ILIKE + ë²¡í„°)
    DB-->>EF: entities (3~5ì´ˆ)
    Note over EF: sectionOnly ë¶„ê¸° ì§„ì…
    EF->>DB: ë™ì˜ì–´ WorkType ì¿¼ë¦¬
    DB-->>EF: synonymWorkTypes (1.4ì´ˆ)
    Note over EF: ì´ ì§€ì—°: 4.4~6.4ì´ˆ
```

`targetSearch`ì™€ ë™ì˜ì–´ WorkType ì¿¼ë¦¬ê°€ **ì§ë ¬(Sequential)** ì‹¤í–‰. ë™ì˜ì–´ ì¿¼ë¦¬ëŠ” `targetSearch` ê²°ê³¼ì— ì˜ì¡´í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë³‘ë ¬í™” ê°€ëŠ¥.

#### ì†”ë£¨ì…˜: `Promise.all` ë³‘ë ¬ ì²˜ë¦¬

```mermaid
sequenceDiagram
    participant EF as Edge Function
    participant DB as Supabase DB
    
    Note over EF: searchPipeline ì‹œì‘
    par ë³‘ë ¬ ì‹¤í–‰
        EF->>DB: targetSearch (ILIKE + ë²¡í„°)
        EF->>DB: ë™ì˜ì–´ WorkType ì¿¼ë¦¬
    end
    DB-->>EF: entities (3~5ì´ˆ)
    DB-->>EF: synonymWorkTypes (1.4ì´ˆ, ê°€ë ¤ì§)
    Note over EF: ì´ ì§€ì—°: 3~5ì´ˆ (ë™ì˜ì–´ ë¬´ë£Œ)
```

#### êµ¬í˜„ ì½”ë“œ

```typescript
// [index.ts] searchPipeline ë„ì…ë¶€

const embedding = await generateEmbedding(question);

// 1. ë™ì˜ì–´ ì¬ë£Œ ì¦‰ì‹œ ì¶”ì¶œ (targetSearch ëŒ€ê¸° ë¶ˆí•„ìš”)
const { expandDomainSynonyms } = await import("./search.ts");
const domainTerms = analysis.work_name
    ? [analysis.work_name, ...(analysis.keywords || [])]
    : analysis.keywords || [];
const domainExp = expandDomainSynonyms(domainTerms);
const synOrClauses = domainExp.length > 0
    ? domainExp.map(s => `name.ilike.%${s}%`).join(",")
    : null;

// 2. ë©”ì¸ ê²€ìƒ‰ + ë™ì˜ì–´ ì„œë¸Œ ê²€ìƒ‰ì„ Promise.allë¡œ ë³‘ë ¬ ì¶œë°œ
const [entities, synWTsResponse] = await Promise.all([
    targetSearch(analysis, embedding, question),
    synOrClauses
        ? supabase.from("graph_entities")
            .select("id, name, type, source_section, properties")
            .eq("type", "WorkType")
            .or(synOrClauses)
            .limit(50)
        : Promise.resolve({ data: [] as any[], error: null }),
]);

const synonymWorkTypes = synWTsResponse.data || [];

// 3. ì´í›„ sectionOnly ë¶„ê¸°ì—ì„œ ì´ë¯¸ í™•ë³´ëœ synonymWorkTypes ì¦‰ì‹œ ì‚¬ìš©
const sectionOnly = entities.length > 0 && entities.every(e => e.type === "Section");
if (sectionOnly) {
    const sectionSourceIds = [...new Set(entities.map(e => e.source_section).filter(Boolean))];
    const synSectionIds = [...new Set(synonymWorkTypes.map(w => w.source_section).filter(Boolean))];
    const allSectionIds = [...new Set([...sectionSourceIds, ...synSectionIds])];
    // ... ê¸°ì¡´ multi-section ì˜µì…˜ ìƒì„± ë¡œì§ ...
}
```

> [!NOTE]
> **íƒ€ì… ì•ˆì „ì„±:** `Promise.resolve({ data: [] as any[], error: null })`ë¡œ Supabase ì‘ë‹µ íƒ€ì…ê³¼ ì¼ì¹˜ì‹œì¼œ í›„ì† ì½”ë“œì˜ íƒ€ì… ì¶”ë¡  ì˜¤ë¥˜ ë°©ì§€.

---

### 2.2 íŠ¸ë™ 2: íŒŒì¼ ë™ê¸°í™” SSOT êµ¬ì¶•

> **ìƒíƒœ:** ì„¤ê³„ ì™„ë£Œ, íŠ¸ë™ 1 í›„ ì‹¤í–‰  
> **ì„ í˜¸ ì˜µì…˜:** B (NPM ìŠ¤í¬ë¦½íŠ¸)

| ì˜µì…˜ | ë°©ì‹ | ì¥ì  | ë‹¨ì  | Windows+GDrive í˜¸í™˜ |
|------|------|------|------|---------------------|
| **A** | Junction ë§í¬ (`mklink /J`) | ì›ì²œì  í•´ê²°, ë™ê¸°í™” ë¶ˆí•„ìš” | GDrive ë™ê¸°í™” ë¶ˆì•ˆì • ê°€ëŠ¥ | âš ï¸ ì£¼ì˜ í•„ìš” |
| **B** | NPM deploy ìŠ¤í¬ë¦½íŠ¸ | ì¦‰ì‹œ ì ìš©, ì•ˆì „ | ìˆ˜ë™ ì‹¤í–‰ í•„ìš” | âœ… ì™„ë²½ í˜¸í™˜ |
| **C** | Git pre-commit hook | ìë™í™” | Git ì˜ì¡´ | âœ… í˜¸í™˜ |

#### ì˜µì…˜ B êµ¬í˜„

```json
// package.json
{
  "scripts": {
    "sync": "xcopy /Y /S edge-function\\*.ts supabase\\functions\\rag-chat\\",
    "deploy": "npm run sync && npx supabase functions deploy rag-chat --project-ref bfomacoarwtqzjfxszdr --no-verify-jwt",
    "deploy:check": "npm run sync && fc edge-function\\search.ts supabase\\functions\\rag-chat\\search.ts && echo SYNCED"
  }
}
```

---

### 2.3 íŠ¸ë™ 3: Dynamic Ontology (DOMAIN_SYNONYM_MAP DBí™”)

> **ìƒíƒœ:** ì„¤ê³„ ì™„ë£Œ, MAP 30ê°œ í‚¤ ë„ë‹¬ ì‹œ ì‹¤í–‰  
> **í˜„ì¬ MAP í¬ê¸°:** 9ê°œ í‚¤ Ã— í‰ê·  6ê°œ ë™ì˜ì–´ = 54ê°œ ë§¤í•‘

#### ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ì¤€

| MAP í‚¤ ìˆ˜ | ì¡°ì¹˜ |
|-----------|------|
| ~15ê°œ | í•˜ë“œì½”ë”© ìœ ì§€ (í˜„ì¬) |
| 15~30ê°œ | ë³„ë„ JSON íŒŒì¼ë¡œ ë¶„ë¦¬ (`synonyms.json`) |
| 30ê°œ+ | DB í…Œì´ë¸” `domain_synonyms` ì‹ ì„¤ + Cold Start ìºì‹± |

#### DB í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ (ë¯¸ë˜)

```sql
CREATE TABLE domain_synonyms (
    id SERIAL PRIMARY KEY,
    term TEXT NOT NULL UNIQUE,        -- "PEê´€"
    synonyms JSONB NOT NULL,          -- ["ë°”íŠ¸ìœµì°©", "ì†Œì¼“ìœµì°©", ...]
    category TEXT,                    -- "ë°°ê´€", "ìš©ì ‘" ë“± ë¶„ë¥˜
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_domain_synonyms_term ON domain_synonyms(term);
```

#### Edge Function ë¡œë”© ì½”ë“œ (ë¯¸ë˜)

```typescript
// Cold Start ì‹œ 1íšŒ ë¡œë”© + ì¸ë©”ëª¨ë¦¬ ìºì‹±
let _synonymCache: Record<string, string[]> | null = null;

async function getDomainSynonymMap(): Promise<Record<string, string[]>> {
    if (_synonymCache) return _synonymCache;
    const { data } = await supabase
        .from("domain_synonyms")
        .select("term, synonyms")
        .eq("is_active", true);
    _synonymCache = Object.fromEntries(
        (data || []).map(r => [r.term, r.synonyms])
    );
    return _synonymCache;
}
```

---

## 3. ì‹¤í–‰ ìš°ì„ ìˆœìœ„

| ìˆœì„œ | íŠ¸ë™ | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ | íš¨ê³¼ |
|------|------|------|----------|------|
| **1** | ì‘ë‹µ ìµœì í™” | `Promise.all` ë³‘ë ¬í™” | 15ë¶„ | ì§€ì—° -1.4s |
| **2** | DevOps | NPM deploy ìŠ¤í¬ë¦½íŠ¸ | 5ë¶„ | ì„€ë„ìš° ë°°í¬ ë°©ì§€ |
| **3** | Ontology | MAP í™•ì¥ (í•˜ë“œì½”ë”© ìœ ì§€) | í•„ìš”ì‹œ | ê²€ìƒ‰ ì»¤ë²„ë¦¬ì§€ â†‘ |
| **4** | Track A | ë°ì´í„° ì¶”ì¶œ ì •ë°€í™” | ìˆ˜ ì‹œê°„ | ìˆ˜ëŸ‰/ë…¸ë¬´ëŸ‰ 100% |
