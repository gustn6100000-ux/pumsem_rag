# ì§ˆì˜ ëª…í™•í™”(Query Clarification) + ëŒ€í™”í˜• ê²€ìƒ‰ ë£¨í”„ êµ¬í˜„ ê³„íšì„œ

> **ì‘ì„±ì¼**: 2026-02-13 (ëª©) 15:20  
> **ëª©í‘œ**: ëª¨í˜¸í•œ ì§ˆë¬¸ì— ëŒ€í•´ ê·¸ë˜í”„ êµ¬ì¡°ë¥¼ í™œìš©í•˜ì—¬ ì˜ë¯¸ë¥¼ ì¢íˆê³ , ì •í™•í•œ ì—”í‹°í‹°ë¥¼ íŠ¹ì •í•œ ë’¤ ë‹µë³€í•˜ëŠ” ëŒ€í™”í˜• ê²€ìƒ‰ ë£¨í”„ êµ¬í˜„  
> **ì•„í‚¤í…ì²˜ ì›ì¹™**: ê¸°ì¡´ n8n ë¡œì§ì˜ ì´ì‹ âŒ â†’ ê·¸ë˜í”„ RAG ë„¤ì´í‹°ë¸Œ ì„¤ê³„ âœ…

---

## 0. ë¬¸ì œ ì •ì˜

### í˜„ìƒ
| ì¿¼ë¦¬        | ê¸°ëŒ€                      | ì‹¤ì œ                    | ì›ì¸                                           |
| ----------- | ------------------------- | ----------------------- | ---------------------------------------------- |
| "tig"       | TIGìš©ì ‘(W-0631, 13-2-3)   | "S/W í¬í•¨"(N-0261) ë°˜í™˜ | 3ê¸€ì ì˜ë¬¸ â†’ 768ì°¨ì› ë²¡í„° ë³€ë³„ë ¥ â‰ˆ 0           |
| "ê°•ê´€ìš©ì ‘"  | ê·œê²© ì„ íƒ ì•ˆë‚´            | ì„ì˜ì˜ 1ê°œ ê·œê²© ë°˜í™˜    | ê°•ê´€ìš©ì ‘ WorkTypeì´ **113ê°œ** â†’ ê·œê²© íŠ¹ì • ë¶ˆê°€ |
| "ìš©ì ‘"      | ë²”ìœ„ ì§ˆë¬¸ â†’ ì•ˆë‚´          | ë¬´ì‘ìœ„ WorkType ë°˜í™˜    | "ìš©ì ‘" ê´€ë ¨ ì—”í‹°í‹° ìˆ˜ë°± ê°œ ì¤‘ ìœ ì‚¬ë„ í¸ì°¨ ë¯¸ì„¸ |
| "PEê´€ ì ‘í•©" | HDPE ì—´ìœµì°© ë˜ëŠ” ì „ê¸°ìœµì°© | ê´€ë ¨ ì—†ëŠ” ì—”í‹°í‹°        | ì˜ë¬¸ ì•½ì–´ + í•œê¸€ ì¡°í•© ì²˜ë¦¬ ë¶ˆê°€                |

### êµ¬ì¡°ì  ì›ì¸
```
í˜„ì¬: question â†’ embedding â†’ 13,387ê±´ ì „ì²´ ë²¡í„° ê²€ìƒ‰ â†’ top-5 ë°˜í™˜ â†’ LLM ë‹µë³€
                                    â†‘
                            ë³€ë³„ë ¥ ë¶€ì¡±í•œ ì¿¼ë¦¬ëŠ” ë…¸ì´ì¦ˆ ë°˜í™˜
                            ê·œê²© 113ê°œì¸ ê³µì¢…ì€ "ì–´ë–¤ ê·œê²©?"ì„ ëª¨ë¦„
```

### ëª©í‘œ ìƒíƒœ
```
ê°œì„ : question â†’ [LLM ì˜ë„ ë¶„ì„] â†’ ëª…í™•? â”€â”€YESâ”€â”€â†’ íƒ€ê²Ÿ ê²€ìƒ‰ â†’ LLM ë‹µë³€
                      â”‚                              â†‘
                      NO                     ê·œê²©/ê³µì¢…ì´ íŠ¹ì •ë¨
                      â†“
              [ê·¸ë˜í”„ ê¸°ë°˜ í›„ë³´ íƒìƒ‰]
                      â†“
              "ê°•ê´€ìš©ì ‘ì˜ ì–´ë–¤ ê·œê²©ì´ìš”?"
              + ì„ íƒ ì¹© [200mm SCH 40] [250mm SCH 40] ...
                      â†“
              ì‚¬ìš©ì ì„ íƒ â†’ íƒ€ê²Ÿ ê²€ìƒ‰ â†’ LLM ë‹µë³€
```

---

## 1. ì„¤ê³„ ì›ì¹™

### why ê·¸ë˜í”„ RAG ë„¤ì´í‹°ë¸Œ?

ê¸°ì¡´ n8n ë°©ì‹ì˜ ë¬¸ì œ:
- `extract_core_product` RPC: **í…ìŠ¤íŠ¸ íŒ¨í„´ ë§¤ì¹­ ê¸°ë°˜** â†’ ìƒˆ ê³µì¢… ì¶”ê°€ ì‹œ íŒ¨í„´ë„ ìˆ˜ë™ ì¶”ê°€ í•„ìš”
- `get_clarification_options`: **unit_costs í…Œì´ë¸” ê¸°ë°˜** â†’ flatí•œ ê²€ìƒ‰, ê³„ì¸µ êµ¬ì¡° ë¬´ì‹œ
- ì„¸ì…˜ ìƒíƒœë¥¼ **n8n staticData**ì— ì˜ì¡´ â†’ Edge Functionì—ì„œëŠ” ì‚¬ìš© ë¶ˆê°€

ê·¸ë˜í”„ RAG ë„¤ì´í‹°ë¸Œ ì„¤ê³„:
- **LLMì´ ì˜ë„ë¥¼ ë¶„ì„**í•˜ê³ , **ê·¸ë˜í”„ êµ¬ì¡°ê°€ í›„ë³´ë¥¼ ì œê³µ** â†’ íŒ¨í„´ í•˜ë“œì½”ë”© ë¶ˆí•„ìš”
- `graph_entities`ì˜ **type ê³„ì¸µ**(Section â†’ WorkType â†’ Labor/Equipment/Material)ì´ ìì—°ìŠ¤ëŸ½ê²Œ ë“œë¦´ë‹¤ìš´ ê²½ë¡œ
- ì„¸ì…˜ ìƒíƒœëŠ” **í´ë¼ì´ì–¸íŠ¸ ëŒ€í™” íˆìŠ¤í† ë¦¬**ë¡œ ê´€ë¦¬ (stateless ì„œë²„)

### 3ëŒ€ ì„¤ê³„ ì›ì¹™

| ì›ì¹™                        | ì„¤ëª…                                                                              |
| --------------------------- | --------------------------------------------------------------------------------- |
| **LLM-First Intent**        | ê·œì¹™ ê¸°ë°˜ ì˜ë„ ë¶„ë¥˜ âŒ â†’ LLM êµ¬ì¡°í™” ì¶œë ¥ìœ¼ë¡œ ì˜ë„Â·í‚¤ì›Œë“œÂ·ê·œê²©ì„ í•œ ë²ˆì— ì¶”ì¶œ       |
| **Graph-Guided Narrowing**  | ëª¨í˜¸í•œ ì§ˆë¬¸ â†’ ê·¸ë˜í”„ì˜ Section/WorkType ê³„ì¸µì„ íƒìƒ‰í•˜ì—¬ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” í›„ë³´ë§Œ ì œì‹œ |
| **Stateless Clarification** | ì„œë²„ëŠ” ìƒíƒœë¥¼ ë³´ê´€í•˜ì§€ ì•ŠìŒ. ëª…í™•í™” íˆìŠ¤í† ë¦¬ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ `history[]`ë¡œ ì „ë‹¬    |

---

## 2. ë°ì´í„° ê³„ì¸µ ë¶„ì„ (í˜„ì¬ ê·¸ë˜í”„ êµ¬ì¡°)

### 2.1 ì—”í‹°í‹° íƒ€ì…ë³„ ì—­í• 

| Type          | ê°œìˆ˜  | ì—­í•                                              | ê²€ìƒ‰ ëŒ€ìƒ?    |
| ------------- | ----- | ------------------------------------------------ | ------------- |
| **Section**   | 1,218 | í’ˆì…ˆ ì ˆ(ç¯€) ë‹¨ìœ„. "ê°•ê´€ìš©ì ‘"(13-2-3)             | âœ… 1ì°¨ íƒìƒ‰    |
| **WorkType**  | 4,733 | ì„¸ë¶€ ì‘ì—… + ê·œê²©ë³„ ë¶„ê¸°. "ê°•ê´€ìš©ì ‘(200, SCH 40)" | âœ… íƒ€ê²Ÿ ê²€ìƒ‰   |
| **Labor**     | 417   | íˆ¬ì… ì¸ë ¥ ì§ì¢…. "ë°°ê´€ê³µ", "ìš©ì ‘ê³µ"               | âŒ ê´€ê³„ë¡œ ì ‘ê·¼ |
| **Equipment** | 1,016 | íˆ¬ì… ì¥ë¹„                                        | âŒ ê´€ê³„ë¡œ ì ‘ê·¼ |
| **Material**  | 746   | ì‚¬ìš© ìì¬                                        | âŒ ê´€ê³„ë¡œ ì ‘ê·¼ |
| **Note**      | 4,763 | ë¹„ê³ , ì£¼ì„, í• ì¦ ì¡°ê±´                            | âŒ ê´€ê³„ë¡œ ì ‘ê·¼ |
| **Standard**  | 494   | ì ìš© ê¸°ì¤€                                        | âŒ ê´€ê³„ë¡œ ì ‘ê·¼ |

### 2.2 ê´€ê³„ êµ¬ì¡°

| ê´€ê³„               | ê°œìˆ˜  | ì˜ë¯¸                           |
| ------------------ | ----- | ------------------------------ |
| REQUIRES_LABOR     | 8,590 | WorkType â†’ Labor (ì¸ë ¥ íˆ¬ì…ëŸ‰) |
| HAS_NOTE           | 6,103 | WorkType/Section â†’ Note (ë¹„ê³ ) |
| BELONGS_TO         | 5,060 | WorkType â†’ Section (ì†Œì†)      |
| REQUIRES_EQUIPMENT | 2,057 | WorkType â†’ Equipment (ì¥ë¹„)    |
| USES_MATERIAL      | 1,659 | WorkType â†’ Material (ìì¬)     |
| APPLIES_STANDARD   | 854   | WorkType â†’ Standard (ê¸°ì¤€)     |

### 2.3 í•µì‹¬ ê´€ì°°: "ê°•ê´€ìš©ì ‘" ì‚¬ë¡€

```
Section: "ê°•ê´€ìš©ì ‘" (S-0249, source_section: 13-2-3)
    â”‚
    â”œâ”€â”€ WorkType: "ê°•ê´€ìš©ì ‘" (W-0760, ê·œê²© ì—†ìŒ, ë‹¨ìœ„: m) â† ëŒ€í‘œ ì—”í‹°í‹°
    â”‚
    â”œâ”€â”€ WorkType: "ê°•ê´€ìš©ì ‘(100, SCH 20)" (W-0763)
    â”œâ”€â”€ WorkType: "ê°•ê´€ìš©ì ‘(100, SCH 40)" (W-0764)
    â”œâ”€â”€ WorkType: "ê°•ê´€ìš©ì ‘(100, SCH 80)" (W-0765)
    â”œâ”€â”€ ...
    â”œâ”€â”€ WorkType: "ê°•ê´€ìš©ì ‘(200, SCH 40)" (W-0788) â† ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ê²ƒ
    â”œâ”€â”€ ...
    â””â”€â”€ WorkType: "ê°•ê´€ìš©ì ‘(600, SCH 160)" (W-0861) â† 113ê°œ ê·œê²©
```

â†’ ì‚¬ìš©ìê°€ "ê°•ê´€ìš©ì ‘"ë§Œ ì…ë ¥í•˜ë©´ 113ê°œ ì¤‘ **ì–´ë–¤ ê·œê²©ì¸ì§€ ë¬¼ì–´ë´ì•¼** í•¨.
â†’ ê·œê²©ê¹Œì§€ ì…ë ¥í•˜ë©´("ê°•ê´€ìš©ì ‘ 200mm SCH 40") **ë°”ë¡œ íƒ€ê²Ÿ ê²€ìƒ‰** ê°€ëŠ¥.

---

## 3. ì•„í‚¤í…ì²˜ ì„¤ê³„

### 3.1 ì „ì²´ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client (index.html)                                            â”‚
â”‚                                                                â”‚
â”‚  ì‚¬ìš©ì ì…ë ¥ â”€â”€â†’ POST /rag-chat â”€â”€â†’ ì‘ë‹µ ë Œë”ë§               â”‚
â”‚                    â†‘                    â”‚                      â”‚
â”‚              history[] í¬í•¨       type: "answer" | "clarify"   â”‚
â”‚                                        â”‚                      â”‚
â”‚  "clarify" ì‹œ:                         â†“                      â”‚
â”‚  ì„ íƒ ì¹© ë Œë”ë§ â”€â”€â†’ ì¹© í´ë¦­ â”€â”€â†’ ìë™ìœ¼ë¡œ ì¬ì§ˆë¬¸               â”‚
â”‚  (historyì— ì´ì „ ëŒ€í™” í¬í•¨)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function (index.ts)                                       â”‚
â”‚                                                                â”‚
â”‚  [Phase 0] LLM ì˜ë„ ë¶„ì„ (analyzeIntent)                       â”‚
â”‚     input:  question + history                                 â”‚
â”‚     output: {                                                  â”‚
â”‚       intent: "search" | "clarify_needed" | "followup" |      â”‚
â”‚               "greeting" | "quantity_input",                   â”‚
â”‚       work_name: string | null,     // ì¶”ì¶œëœ ê³µì¢…ëª…            â”‚
â”‚       spec: string | null,          // ì¶”ì¶œëœ ê·œê²©              â”‚
â”‚       keywords: string[],           // ê²€ìƒ‰ í‚¤ì›Œë“œ              â”‚
â”‚       ambiguity_reason: string | null  // ëª¨í˜¸í•œ ì´ìœ            â”‚
â”‚     }                                                          â”‚
â”‚                                                                â”‚
â”‚  [Phase 1] ì˜ë„ë³„ ë¶„ê¸°                                          â”‚
â”‚     â”œâ”€ "search" (ê·œê²© í™•ì •) â†’ [Phase 2] íƒ€ê²Ÿ ê²€ìƒ‰               â”‚
â”‚     â”œâ”€ "clarify_needed"    â†’ [Phase 1.5] ê·¸ë˜í”„ í›„ë³´ íƒìƒ‰       â”‚
â”‚     â”œâ”€ "followup"          â†’ historyì—ì„œ ì»¨í…ìŠ¤íŠ¸ ë³µì›          â”‚
â”‚     â”œâ”€ "greeting"          â†’ ì¸ì‚¬ë§ ì‘ë‹µ                        â”‚
â”‚     â””â”€ "quantity_input"    â†’ ìˆ˜ëŸ‰ ê³„ì‚° ëª¨ë“œ                     â”‚
â”‚                                                                â”‚
â”‚  [Phase 1.5] ê·¸ë˜í”„ ê¸°ë°˜ í›„ë³´ íƒìƒ‰ (graphClarify)              â”‚
â”‚     work_nameìœ¼ë¡œ Section/WorkType ILIKE ê²€ìƒ‰                   â”‚
â”‚     â†’ í•´ë‹¹ Sectionì˜ í•˜ìœ„ WorkType ê·œê²© ëª©ë¡ ì¶”ì¶œ               â”‚
â”‚     â†’ ì‚¬ìš©ìì—ê²Œ ì„ íƒ ì˜µì…˜ ì œì‹œ                                 â”‚
â”‚                                                                â”‚
â”‚  [Phase 2] íƒ€ê²Ÿ ê²€ìƒ‰ (í™•ì •ëœ í‚¤ì›Œë“œë¡œ)                          â”‚
â”‚     work_name + spec â†’ ILIKE ì§ì ‘ ë§¤ì¹­ (1ìˆœìœ„)                  â”‚
â”‚     ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ â†’ ë²¡í„° ê²€ìƒ‰ (2ìˆœìœ„, type í•„í„° ì ìš©)            â”‚
â”‚     â†’ expandGraph â†’ buildContext â†’ generateAnswer               â”‚
â”‚                                                                â”‚
â”‚  [Phase 3] ì‘ë‹µ ë°˜í™˜                                            â”‚
â”‚     type: "answer" â†’ ì¼ë°˜ ë‹µë³€                                  â”‚
â”‚     type: "clarify" â†’ ì„ íƒ ì˜µì…˜ + ì•ˆë‚´ ë©”ì‹œì§€                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ì‘ë‹µ íƒ€ì… í™•ì¥

```typescript
// ê¸°ì¡´ ChatResponse
interface ChatResponse {
    answer: string;
    sources: SourceInfo[];
    search_info: SearchInfo;
}

// í™•ì¥ëœ ChatResponse
interface ChatResponse {
    type: "answer" | "clarify";       // NEW: ì‘ë‹µ ìœ í˜•
    answer: string;
    sources: SourceInfo[];
    search_info: SearchInfo;
    clarification?: {                 // NEW: ëª…í™•í™” ì •ë³´ (type=clarify ì‹œ)
        options: ClarifyOption[];     // ì„ íƒ ê°€ëŠ¥í•œ í›„ë³´
        reason: string;              // ì™œ ë˜ë¬¼ì—ˆëŠ”ì§€
        original_query: string;      // ì›ë˜ ì§ˆë¬¸
    };
}

interface ClarifyOption {
    label: string;          // í‘œì‹œ í…ìŠ¤íŠ¸: "200mm SCH 40"
    query: string;          // í´ë¦­ ì‹œ ì „ì†¡í•  ì§ˆë¬¸: "ê°•ê´€ìš©ì ‘ 200mm SCH 40 í’ˆì…ˆ"
    entity_id?: string;     // ì§ì ‘ ê²€ìƒ‰ìš© ì—”í‹°í‹° ID (ì˜µì…˜)
    source_section?: string; // ì¶œì²˜ ì ˆë²ˆí˜¸
}
```

---

## 4. ë‹¨ê³„ë³„ êµ¬í˜„ ìƒì„¸

### Phase 0: LLM ì˜ë„ ë¶„ì„ (`analyzeIntent`)

#### ì™œ LLMì¸ê°€?

| ë°©ì‹                     | ì¥ì                                   | ë‹¨ì                                            |
| ------------------------ | ------------------------------------- | ---------------------------------------------- |
| **ê·œì¹™ ê¸°ë°˜** (ê¸°ì¡´ n8n) | ë¹ ë¦„, ì˜ˆì¸¡ ê°€ëŠ¥                       | ìƒˆ íŒ¨í„´ ì¶”ê°€ ì‹œ ì½”ë“œ ìˆ˜ì •, ì˜ë¬¸/ì•½ì–´ ì²˜ë¦¬ ë¶ˆê°€ |
| **LLM ê¸°ë°˜** (ì‹ ê·œ)      | ì˜ë¬¸Â·ì•½ì–´Â·í˜¼í•©ì–´ ìë™ ì²˜ë¦¬, ë§¥ë½ ì´í•´ | ì¶”ê°€ API í˜¸ì¶œ 1íšŒ (100~200ms), ë¹„ìš© ë¯¸ë¯¸       |

#### êµ¬í˜„ ì„¤ê³„

> **ì˜ë„ ë¶„ì„ LLM**: DeepSeek Chat v3.2 (`deepseek-chat`)
> - **ì—”ë“œí¬ì¸íŠ¸**: `https://api.deepseek.com/chat/completions`
> - **í™˜ê²½ë³€ìˆ˜**: `DEEPSEEK_API_KEY` (Supabase Edge Function secretsì— ì¶”ê°€ í•„ìš”)
> - **ì„ íƒ ì´ìœ **: ë¹ ë¥¸ ì‘ë‹µì†ë„, ë‚®ì€ ë¹„ìš©, JSON mode ì§€ì›, í•œÂ·ì˜ í˜¼í•© ì¿¼ë¦¬ ì²˜ë¦¬ ìš°ìˆ˜

```typescript
interface IntentAnalysis {
    intent: "search" | "clarify_needed" | "followup" | "greeting" | "quantity_input";
    work_name: string | null;       // ì¶”ì¶œëœ ê³µì¢…ëª… (í•œê¸€)
    spec: string | null;            // ì¶”ì¶œëœ ê·œê²© ("200mm SCH 40" ë“±)
    keywords: string[];             // ê²€ìƒ‰ìš© í‚¤ì›Œë“œ ë°°ì—´
    ambiguity_reason: string | null; // ëª¨í˜¸ì„± ì‚¬ìœ 
}

// DeepSeek v3.2 API ì„¤ì •
const DEEPSEEK_API_KEY = Deno.env.get("DEEPSEEK_API_KEY")!;
const DEEPSEEK_URL = "https://api.deepseek.com/chat/completions";

async function analyzeIntent(
    question: string,
    history: ChatMessage[]
): Promise<IntentAnalysis> {
    // DeepSeek Chat v3.2 í˜¸ì¶œ (OpenAI í˜¸í™˜ API, JSON mode)
    const response = await fetch(DEEPSEEK_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${DEEPSEEK_API_KEY}`,
        },
        body: JSON.stringify({
            model: "deepseek-chat",  // DeepSeek v3.2
            messages: [
                { role: "system", content: INTENT_SYSTEM_PROMPT },
                ...history.slice(-3).map(h => ({
                    role: h.role === "user" ? "user" : "assistant",
                    content: h.content,
                })),
                { role: "user", content: question },
            ],
            response_format: { type: "json_object" },  // JSON mode
            temperature: 0.1,   // ë‚®ì€ ì˜¨ë„ â†’ ì¼ê´€ëœ ë¶„ë¥˜
            max_tokens: 300,
        }),
    });

    const data = await response.json();
    const content = data.choices?.[0]?.message?.content ?? "{}";
    return JSON.parse(content) as IntentAnalysis;
}
```

#### ë¹„ìš©/ì„±ëŠ¥ ì˜í–¥

| í•­ëª©           | ê°’                                                  |
| -------------- | --------------------------------------------------- |
| ì¶”ê°€ API í˜¸ì¶œ  | 1íšŒ (DeepSeek v3.2 `deepseek-chat`)                 |
| System Prompt  | ~600 í† í°                                           |
| ì˜ˆìƒ ì…ë ¥ í† í° | ~100 í† í° (ì§ˆë¬¸ + íˆìŠ¤í† ë¦¬ ìµœê·¼ 3í„´)                |
| ì˜ˆìƒ ì¶œë ¥ í† í° | ~50 í† í° (JSON)                                     |
| ì¶”ê°€ ì§€ì—°      | ~200~400ms                                          |
| ì¶”ê°€ ë¹„ìš©      | ~â‚©1~2/í˜¸ì¶œ (DeepSeek ìš”ê¸ˆ ê¸°ì¤€, ë¬´ì‹œ ê°€ëŠ¥)          |
| API í‚¤ ê´€ë¦¬    | `DEEPSEEK_API_KEY` â†’ Supabase Edge Function secrets |

---

### Phase 1.5: ê·¸ë˜í”„ ê¸°ë°˜ í›„ë³´ íƒìƒ‰ (`graphClarify`)

#### í•µì‹¬ ì•„ì´ë””ì–´

LLMì´ `clarify_needed`ë¥¼ ë°˜í™˜í•˜ë©´, **ê·¸ë˜í”„ êµ¬ì¡°ë¥¼ íƒìƒ‰í•˜ì—¬ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” í›„ë³´ë§Œ ì œì‹œ**.

```typescript
interface ClarifyResult {
    message: string;           // ì•ˆë‚´ ë©”ì‹œì§€
    options: ClarifyOption[];  // ì„ íƒ ì¹©
    section_info?: string;     // í•´ë‹¹ ì ˆ ì •ë³´
}

async function graphClarify(
    analysis: IntentAnalysis
): Promise<ClarifyResult> {
    const { work_name, keywords, ambiguity_reason } = analysis;

    // ì „ëµ 1: Section ë ˆë²¨ íƒìƒ‰
    // work_nameìœ¼ë¡œ Section ILIKE â†’ í•´ë‹¹ Sectionì˜ WorkType ê·œê²© ëª©ë¡ ì¡°íšŒ
    
    // ì „ëµ 2: WorkType ì§ì ‘ íƒìƒ‰
    // keywordsë¡œ WorkType ILIKE â†’ ê·œê²© íŒ¨í„´ ì¶”ì¶œ â†’ ëŒ€í‘œ ê·œê²© ê·¸ë£¹í•‘

    // ì „ëµ 3: ì˜ë¬¸ í‚¤ì›Œë“œ ì§ì ‘ ë§¤ì¹­
    // "tig" â†’ graph_entities WHERE name ILIKE '%tig%' â†’ íƒ€ì…ë³„ í›„ë³´ ì¶”ì¶œ
}
```

#### ì‹œë‚˜ë¦¬ì˜¤ë³„ ë™ì‘

##### ì‹œë‚˜ë¦¬ì˜¤ A: ê·œê²© ë¯¸ì§€ì • ("ê°•ê´€ìš©ì ‘ í’ˆì…ˆ")

```
1. analyzeIntent â†’ { intent: "clarify_needed", work_name: "ê°•ê´€ìš©ì ‘", spec: null }
2. graphClarify:
   a. Section ê²€ìƒ‰: name ILIKE '%ê°•ê´€ìš©ì ‘%' â†’ S-0249 (13-2-3) ë°œê²¬
   b. í•´ë‹¹ sectionì˜ WorkType ì¡°íšŒ: source_section = '13-2-3'
   c. ê·œê²© ì¶”ì¶œ: properties->>'spec' â†’ ['100 SCH 20', '100 SCH 40', ..., '600 SCH 160']
   d. ê·œê²© ê·¸ë£¹í•‘:
      - êµ¬ê²½ë³„: 15, 20, 25, 32, 40, 50, 65, 80, 90, 95, 100, 125, 150, 200, 250, 300, 350, 400, 450, 500, 600
      - SCHë³„: 20, 30, 40, 60, 80, 100, 120, 140, 160
   e. ëŒ€í‘œ ì˜µì…˜ ìƒì„± (ë„ˆë¬´ ë§ìœ¼ë©´ êµ¬ê²½ ê·¸ë£¹ìœ¼ë¡œ ì¶•ì•½):

3. ì‘ë‹µ:
   {
     type: "clarify",
     answer: "ê°•ê´€ìš©ì ‘ í’ˆì…ˆì€ êµ¬ê²½(15~600mm)ê³¼ SCH(20~160) ì¡°í•©ë³„ë¡œ 113ê°œ ê·œê²©ì´ ìˆìŠµë‹ˆë‹¤.\nì–´ë–¤ ê·œê²©ì˜ í’ˆì…ˆì„ ì°¾ìœ¼ì‹œë‚˜ìš”?",
     clarification: {
       reason: "ê°•ê´€ìš©ì ‘ì€ 113ê°œ ê·œê²©ë³„ í’ˆì…ˆì´ ë³„ë„ ì¡´ì¬",
       options: [
         { label: "200mm SCH 40", query: "ê°•ê´€ìš©ì ‘ 200mm SCH 40 í’ˆì…ˆ" },
         { label: "100mm SCH 40", query: "ê°•ê´€ìš©ì ‘ 100mm SCH 40 í’ˆì…ˆ" },
         { label: "300mm SCH 40", query: "ê°•ê´€ìš©ì ‘ 300mm SCH 40 í’ˆì…ˆ" },
         { label: "ì „ì²´ ê·œê²© ëª©ë¡", query: "ê°•ê´€ìš©ì ‘ ì „ì²´ ê·œê²© ëª©ë¡" },
         // ìµœê·¼ ê²€ìƒ‰ëœ ê·œê²©ì´ë‚˜ ìì£¼ ì‚¬ìš©ë˜ëŠ” ê·œê²© ìš°ì„  í‘œì‹œ
       ]
     }
   }
```

##### ì‹œë‚˜ë¦¬ì˜¤ B: ì˜ë¬¸ ì•½ì–´ ("tig")

```
1. analyzeIntent â†’ { intent: "clarify_needed", work_name: null, keywords: ["TIG", "TIGìš©ì ‘"], ambiguity_reason: "ì˜ë¬¸ ì•½ì–´" }
2. graphClarify:
   a. í‚¤ì›Œë“œ ILIKE ê²€ìƒ‰: name ILIKE '%TIG%'
   b. ê²°ê³¼ 3ê±´:
      - W-0631: "TIG(Tungsten Inert Gas)ìš©ì ‘" (WorkType, 13-2-3)
      - ST-0204: "TIGìš©ì ‘" (Standard, 1-3-1#4)
      - N-0269: "TIGìš©ì ‘ ì‹œ 10% ê°€ì‚°" (Note, 1-1-1#4)
   c. WorkTypeë§Œ í•„í„° â†’ W-0631 í™•ì¸
   d. í•´ë‹¹ section(13-2-3) = ê°•ê´€ìš©ì ‘ â†’ TIGëŠ” ìš©ì ‘ë°©ë²•ì´ì§€ ê³µì¢…ì´ ì•„ë‹˜
   e. ë§¥ë½ íŒŒì•…: TIGìš©ì ‘ì€ ê°•ê´€ìš©ì ‘ì˜ í•˜ìœ„ ìš©ì ‘ë°©ë²•

3. ì‘ë‹µ:
   {
     type: "clarify",
     answer: "TIGìš©ì ‘ì€ ê°•ê´€ìš©ì ‘(13-2-3)ì˜ ìš©ì ‘ ë°©ë²• ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.\nTIGìš©ì ‘ì— ëŒ€í•´ ì–´ë–¤ ì •ë³´ë¥¼ ì°¾ìœ¼ì‹œë‚˜ìš”?",
     clarification: {
       reason: "TIGìš©ì ‘ì€ ìš©ì ‘ë°©ë²•ìœ¼ë¡œ, íŠ¹ì • ê·œê²©ì˜ í’ˆì…ˆê³¼ ì—°ê²°ë©ë‹ˆë‹¤",
       options: [
         { label: "TIGìš©ì ‘ í’ˆì…ˆ ë³´ê¸°", query: "TIGìš©ì ‘ í’ˆì…ˆ ì•Œë ¤ì¤˜" },
         { label: "ê°•ê´€ìš©ì ‘ ì „ì²´ ë³´ê¸°", query: "ê°•ê´€ìš©ì ‘ í’ˆì…ˆ" },
         { label: "TIGìš©ì ‘ í• ì¦ ì¡°ê±´", query: "TIGìš©ì ‘ ê°€ì‚° ì¡°ê±´" },
       ]
     }
   }
```

##### ì‹œë‚˜ë¦¬ì˜¤ C: ë„“ì€ ë²”ìœ„ ("ìš©ì ‘")

```
1. analyzeIntent â†’ { intent: "clarify_needed", work_name: "ìš©ì ‘", keywords: ["ìš©ì ‘"], ambiguity_reason: "ë²”ìœ„ ê³¼ëŒ€" }
2. graphClarify:
   a. Section ê²€ìƒ‰: name ILIKE '%ìš©ì ‘%' â†’ ë‹¤ìˆ˜ ë§¤ì¹­
      - "ê°•ê´€ìš©ì ‘" (13-2-3), "ìŠ¤í…Œì¸ë ˆìŠ¤ê´€ìš©ì ‘" (13-2-4), "ìš©ì ‘ì ‘í•©" (1-1-1#4), ...
   b. WorkType ìƒìœ„ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ: DISTINCT source_section ê¸°ì¤€ ê·¸ë£¹í•‘
   c. ì¹´í…Œê³ ë¦¬ë³„ ëŒ€í‘œ Section ëª©ë¡ ì œì‹œ

3. ì‘ë‹µ:
   {
     type: "clarify",
     answer: "ìš©ì ‘ ê´€ë ¨ í’ˆì…ˆì´ ì—¬ëŸ¬ ë¶„ì•¼ì— ìˆìŠµë‹ˆë‹¤. ì–´ë–¤ ìš©ì ‘ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?",
     clarification: {
       reason: "ìš©ì ‘ì´ í¬í•¨ëœ í’ˆì…ˆ ì ˆì´ ë‹¤ìˆ˜ ì¡´ì¬",
       options: [
         { label: "ê°•ê´€ìš©ì ‘ (ê¸°ê³„ì„¤ë¹„)", query: "ê°•ê´€ìš©ì ‘ í’ˆì…ˆ" },
         { label: "ìŠ¤í…Œì¸ë ˆìŠ¤ê´€ìš©ì ‘", query: "ìŠ¤í…Œì¸ë ˆìŠ¤ê´€ìš©ì ‘ í’ˆì…ˆ" },
         { label: "TIGìš©ì ‘", query: "TIGìš©ì ‘ í’ˆì…ˆ" },
         { label: "ê¸°ë³¸ìš©ì ‘ (ì² ê³¨ê³µì‚¬)", query: "ê¸°ë³¸ìš©ì ‘ í’ˆì…ˆ" },
         { label: "ìš©ì ‘ì ‘í•© (ë°°ê´€ê³µì‚¬)", query: "ìš©ì ‘ì ‘í•© í’ˆì…ˆ" },
       ]
     }
   }
```

##### ì‹œë‚˜ë¦¬ì˜¤ D: ê·œê²© í™•ì • ("ê°•ê´€ìš©ì ‘ 200mm SCH 40")

```
1. analyzeIntent â†’ { intent: "search", work_name: "ê°•ê´€ìš©ì ‘", spec: "200 SCH 40", keywords: ["ê°•ê´€ìš©ì ‘", "200", "SCH 40"] }
2. ë°”ë¡œ Phase 2ë¡œ â†’ ë˜ë¬¼ìŒ ì—†ì´ íƒ€ê²Ÿ ê²€ìƒ‰ ì‹¤í–‰
3. ILIKE: name ILIKE '%ê°•ê´€ìš©ì ‘%200%SCH 40%' â†’ W-0788 ì •í™• ë§¤ì¹­
```

---

### Phase 2: íƒ€ê²Ÿ ê²€ìƒ‰ (ê¸°ì¡´ `searchEntities` ê°œì„ )

#### í˜„ì¬ ë¬¸ì œ
```
ë²¡í„° ê²€ìƒ‰ë§Œ â†’ 13,387ê±´ ì „ì²´ ëŒ€ìƒ â†’ Note/Standard ë…¸ì´ì¦ˆ
```

#### ê°œì„ : 3ë‹¨ê³„ ìºìŠ¤ì¼€ì´ë“œ ê²€ìƒ‰

```typescript
async function targetSearch(
    analysis: IntentAnalysis,
    embedding: number[]
): Promise<EntityResult[]> {

    // 1ë‹¨ê³„: ILIKE ì •í™• ë§¤ì¹­ (work_name + spec)
    if (analysis.work_name && analysis.spec) {
        const exact = await exactMatch(analysis.work_name, analysis.spec);
        if (exact.length > 0) return exact;
    }

    // 2ë‹¨ê³„: ILIKE í‚¤ì›Œë“œ ë§¤ì¹­ (work_nameë§Œ)
    if (analysis.keywords.length > 0) {
        const keyword = await keywordMatch(analysis.keywords);
        if (keyword.length > 0) return keyword;
    }

    // 3ë‹¨ê³„: ë²¡í„° ê²€ìƒ‰ (íƒ€ì… í•„í„° ì ìš©)
    // Section, WorkTypeë§Œ ëŒ€ìƒ (Note, Standard ì œì™¸)
    const vector = await vectorSearch(embedding, ["Section", "WorkType"]);
    return vector;
}
```

#### ë²¡í„° ê²€ìƒ‰ì— íƒ€ì… í•„í„° ì¶”ê°€

í˜„ì¬ `search_entities_by_embedding` SQL í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜, ìƒˆ í•¨ìˆ˜ë¥¼ ìƒì„±:

```sql
CREATE OR REPLACE FUNCTION search_entities_typed(
    query_embedding_text text,
    match_count int DEFAULT 5,
    match_threshold float DEFAULT 0.4,
    type_filter text[] DEFAULT ARRAY['Section', 'WorkType']  -- NEW
)
RETURNS TABLE(
    id text, name text, type text,
    properties jsonb, similarity float,
    source_section text  -- NEW: source_sectionë„ ë°˜í™˜
)
LANGUAGE plpgsql AS $$
DECLARE
    parsed_vector vector(768);
BEGIN
    parsed_vector := query_embedding_text::vector(768);
    RETURN QUERY
    SELECT
        ge.id, ge.name, ge.type, ge.properties,
        (1 - (ge.embedding <=> parsed_vector))::float AS similarity,
        ge.source_section
    FROM graph_entities ge
    WHERE ge.embedding IS NOT NULL
      AND ge.type = ANY(type_filter)                 -- íƒ€ì… í•„í„° ì ìš©
      AND 1 - (ge.embedding <=> parsed_vector) > match_threshold
    ORDER BY ge.embedding <=> parsed_vector
    LIMIT match_count;
END;
$$;
```

---

## 5. í´ë¼ì´ì–¸íŠ¸(index.html) ìˆ˜ì •

### 5.1 ì„ íƒ ì¹© UI

```html
<!-- ëª…í™•í™” ì„ íƒ ì¹© -->
<div class="clarify-chips" id="clarifyChips">
    <!-- ë™ì  ìƒì„± -->
</div>
```

```css
.clarify-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
    padding: 0 4px;
}

.clarify-chip {
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid var(--border-focus);
    background: var(--accent-soft);
    color: var(--accent);
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
}

.clarify-chip:hover {
    background: var(--accent);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px var(--accent-glow);
}
```

### 5.2 ì‘ë‹µ ì²˜ë¦¬ ë¡œì§

```javascript
function handleResponse(data) {
    if (data.type === "clarify" && data.clarification) {
        // ì•ˆë‚´ ë©”ì‹œì§€ ë Œë”ë§
        appendMessage("assistant", data.answer);
        
        // ì„ íƒ ì¹© ë Œë”ë§
        const chipsContainer = createChipsContainer();
        data.clarification.options.forEach(option => {
            const chip = document.createElement("button");
            chip.className = "clarify-chip";
            chip.textContent = option.label;
            chip.onclick = () => {
                // ì¹© í´ë¦­ â†’ í•´ë‹¹ queryë¥¼ ì‚¬ìš©ì ë©”ì‹œì§€ë¡œ ì „ì†¡
                sendMessage(option.query);
            };
            chipsContainer.appendChild(chip);
        });
        appendElement(chipsContainer);
    } else {
        // ì¼ë°˜ ë‹µë³€ ë Œë”ë§ (ê¸°ì¡´ ë¡œì§)
        appendMessage("assistant", data.answer);
        renderSources(data.sources);
    }
}
```

---

## 6. êµ¬í˜„ ìˆœì„œ (Phaseë³„)

### Phase 1: LLM ì˜ë„ ë¶„ì„ + ì‘ë‹µ íƒ€ì… í™•ì¥

| í•­ëª©           | ì‘ì—…                                                 |
| -------------- | ---------------------------------------------------- |
| **index.ts**   | `analyzeIntent()` í•¨ìˆ˜ ì¶”ê°€                          |
| **index.ts**   | `ChatResponse` íƒ€ì…ì— `type`, `clarification` ì¶”ê°€   |
| **index.ts**   | `handleChat()` ì§„ì…ì ì— Phase 0 ë¶„ê¸° ì‚½ì…            |
| **index.html** | ì‘ë‹µ ë¶„ê¸° ì²˜ë¦¬ (`type === "clarify"`)                |
| **ê²€ì¦**       | "tig", "ê°•ê´€ìš©ì ‘", "ìš©ì ‘" ì§ˆë¬¸ â†’ ì˜ë„ ì •í™• ë¶„ë¥˜ í™•ì¸ |

### Phase 2: ê·¸ë˜í”„ ê¸°ë°˜ í›„ë³´ íƒìƒ‰

| í•­ëª©           | ì‘ì—…                                                 |
| -------------- | ---------------------------------------------------- |
| **index.ts**   | `graphClarify()` í•¨ìˆ˜ êµ¬í˜„                           |
| **Supabase**   | `search_entities_typed()` SQL í•¨ìˆ˜ ìƒì„± (íƒ€ì… í•„í„°)  |
| **index.ts**   | ê·œê²© ê·¸ë£¹í•‘ ë¡œì§ êµ¬í˜„                                |
| **index.html** | ì„ íƒ ì¹© UI + CSS êµ¬í˜„                                |
| **ê²€ì¦**       | "ê°•ê´€ìš©ì ‘" â†’ ê·œê²© ì„ íƒ ì¹© í‘œì‹œ â†’ ì¹© í´ë¦­ â†’ ì •í™• ê²€ìƒ‰ |

### Phase 3: íƒ€ê²Ÿ ê²€ìƒ‰ ê°œì„ 

| í•­ëª©         | ì‘ì—…                                              |
| ------------ | ------------------------------------------------- |
| **index.ts** | `targetSearch()` 3ë‹¨ê³„ ìºìŠ¤ì¼€ì´ë“œ êµ¬í˜„            |
| **index.ts** | ê¸°ì¡´ `searchEntities()` â†’ `targetSearch()`ë¡œ êµì²´ |
| **index.ts** | ì˜ë¬¸ í‚¤ì›Œë“œ ILIKE í´ë°± ê°•í™”                       |
| **ê²€ì¦**     | "ê°•ê´€ìš©ì ‘ 200mm SCH 40" â†’ W-0788 ì •í™• ë§¤ì¹­        |

### Phase 4: ëŒ€í™” íë¦„ ìµœì í™”

| í•­ëª©           | ì‘ì—…                                              |
| -------------- | ------------------------------------------------- |
| **index.ts**   | `followup` ì˜ë„ ì²˜ë¦¬: historyì—ì„œ work_name ë³µì›  |
| **index.ts**   | `quantity_input` ì˜ë„ ì²˜ë¦¬: ì´ì „ í’ˆì…ˆì— ìˆ˜ëŸ‰ ê³„ì‚° |
| **index.html** | ëŒ€í™” íˆìŠ¤í† ë¦¬ UX ê°œì„  (ì´ì „ ëª…í™•í™” ì»¨í…ìŠ¤íŠ¸ ìœ ì§€) |
| **ê²€ì¦**       | "ê°•ê´€ìš©ì ‘ 200mm SCH 40" â†’ "SCH 80ì€?" â†’ ì •í™• ì „í™˜ |

---

## 7. ë¦¬ìŠ¤í¬ ë¶„ì„

| ë¦¬ìŠ¤í¬                       | í™•ë¥  | ì˜í–¥ | ëŒ€ì‘                                                                        |
| ---------------------------- | ---- | ---- | --------------------------------------------------------------------------- |
| LLM ì˜ë„ ë¶„ë¥˜ ì˜¤ë¥˜           | ì¤‘   | ë†’   | temperature 0.1 + few-shot ì˜ˆì‹œ 3ê°œ â†’ ì •í™•ë„ 95%+ ëª©í‘œ. ì˜¤ë¶„ë¥˜ ì‹œ ë²¡í„° í´ë°± |
| ì¶”ê°€ API í˜¸ì¶œë¡œ ì§€ì—° ì¦ê°€    | ë‚®   | ì¤‘   | Gemini Flash ~200ms. ì „ì²´ íŒŒì´í”„ë¼ì¸ 3~5ì´ˆ ì¤‘ 5% ë¯¸ë§Œ                       |
| ì„ íƒ ì¹©ì´ ë§ì•„ì§€ëŠ” ê²½ìš°      | ì¤‘   | ë‚®   | ìµœëŒ€ 6ê°œ ì œí•œ + "ì „ì²´ ëª©ë¡" ì˜µì…˜ìœ¼ë¡œ ì¶•ì•½                                   |
| historyê°€ ê¸¸ì–´ì§€ë©´ í† í° ì¦ê°€ | ë‚®   | ë‚®   | ì˜ë„ ë¶„ì„ ì‹œ ìµœê·¼ 3í„´ë§Œ ì „ë‹¬                                                |
| ê·¸ë˜í”„ì— ì—†ëŠ” ê³µì¢… ê²€ìƒ‰      | ë‚®   | ì¤‘   | `graphClarify` ê²°ê³¼ê°€ 0ê±´ì´ë©´ ë²¡í„° ê²€ìƒ‰ìœ¼ë¡œ í´ë°±                            |

---

## 8. ì„±ê³µ ì§€í‘œ

| ì§€í‘œ                             | í˜„ì¬             | ëª©í‘œ                        |
| -------------------------------- | ---------------- | --------------------------- |
| "tig" â†’ TIGìš©ì ‘ ì •í™• ë§¤ì¹­        | âŒ ì‹¤íŒ¨           | âœ… 1í„´ ë˜ëŠ” 2í„´ ë‚´ ì •í™• ë„ë‹¬ |
| "ê°•ê´€ìš©ì ‘" â†’ ê·œê²© ì„ íƒ ì•ˆë‚´      | âŒ ì„ì˜ ê·œê²© ë°˜í™˜ | âœ… ê·œê²© ì„ íƒ ì¹© ì œì‹œ         |
| "ê°•ê´€ìš©ì ‘ 200mm SCH 40" â†’ W-0788 | âš ï¸ ë¶ˆì•ˆì •         | âœ… 100% ì •í™•                 |
| "ìš©ì ‘" â†’ ë¶„ì•¼ë³„ ì•ˆë‚´             | âŒ ë…¸ì´ì¦ˆ         | âœ… ë¶„ì•¼ ì„ íƒ ì¹© ì œì‹œ         |
| ì¶”ê°€ ì§€ì—°                        | 0ms              | < 300ms                     |
| Note/Equipment ë…¸ì´ì¦ˆ ë¹„ìœ¨       | ~36%             | < 5%                        |

---

## 9. íŒŒì¼ ë³€ê²½ ë²”ìœ„

| íŒŒì¼           | ë³€ê²½ ë‚´ìš©                                       | ì˜í–¥ë„   |
| -------------- | ----------------------------------------------- | -------- |
| `index.ts`     | Phase 0~3 ë¡œì§ ì¶”ê°€, ê¸°ì¡´ `handleChat` ë¦¬íŒ©í„°ë§ | ğŸ”´ ëŒ€ê·œëª¨ |
| `index.html`   | ì„ íƒ ì¹© UI, ì‘ë‹µ ë¶„ê¸° ì²˜ë¦¬, CSS                 | ğŸŸ¡ ì¤‘ê·œëª¨ |
| `Supabase SQL` | `search_entities_typed()` í•¨ìˆ˜ ìƒì„±             | ğŸŸ¢ ì†Œê·œëª¨ |

---

## 10. ê¸°ì¡´ n8nì—ì„œ ê°€ì ¸ì˜¨ **êµí›ˆ** (ì´ì‹ì´ ì•„ë‹˜)

| êµí›ˆ                              | n8nì—ì„œì˜ êµ¬í˜„                             | ê·¸ë˜í”„ RAGì—ì„œì˜ ìƒˆ êµ¬í˜„                      |
| --------------------------------- | ------------------------------------------ | --------------------------------------------- |
| ëª¨í˜¸í•œ ì§ˆë¬¸ì— ë°”ë¡œ ë‹µí•˜ë©´ ì•ˆ ëœë‹¤ | `extract_core_product` â†’ confidence ì„ê³„ê°’ | LLM ì˜ë„ ë¶„ì„ â†’ `clarify_needed`              |
| í›„ë³´ë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤˜ì•¼ í•œë‹¤   | `get_clarification_options` (flat ê²€ìƒ‰)    | `graphClarify` (ê³„ì¸µ íƒìƒ‰)                    |
| ì„¸ì…˜ ìƒíƒœê°€ í•„ìš”í•˜ë‹¤              | `staticData[sessionId]` (ì„œë²„ ìƒíƒœ)        | `history[]` (í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ, stateless ì„œë²„) |
| ì˜ë¬¸Â·ì•½ì–´ë¥¼ í•œê¸€ë¡œ ë³€í™˜í•´ì•¼ í•œë‹¤  | í•˜ë“œì½”ë”©ëœ íŒ¨í„´ ë§¤ì¹­                       | LLM í‚¤ì›Œë“œ ì¶”ì¶œ (ìë™ ë™ì˜ì–´ í™•ì¥)            |
| ê·œê²©ì´ ë§ìœ¼ë©´ ì„ íƒì§€ë¥¼ ì¤˜ì•¼ í•œë‹¤  | 12ê±´ í›„ë³´ ë¦¬ìŠ¤íŠ¸                           | ê·œê²© ê·¸ë£¹í•‘ + ì„ íƒ ì¹© (UX ê°œì„ )               |

---

## ë¶€ë¡: êµ¬í˜„ í›„ ì „ì²´ íŒŒì´í”„ë¼ì¸ ë¹„êµ

### Before (í˜„ì¬)
```
question â†’ embedding(200ms) â†’ vectorSearch(300ms) â†’ expandGraph(500ms) â†’ LLM(2s) â†’ answer
ì´ ~3ì´ˆ, ì •í™•ë„ ë¶ˆì•ˆì •
```

### After (êµ¬í˜„ í›„)
```
question â†’ analyzeIntent(200ms) â†’ ë¶„ê¸°
  â”œâ”€ search: â†’ targetSearch(200ms) â†’ expandGraph(500ms) â†’ LLM(2s) â†’ answer
  â”‚   ì´ ~3ì´ˆ, ì •í™•ë„ 99%+
  â”‚
  â””â”€ clarify: â†’ graphClarify(200ms) â†’ clarify response
      ì´ ~0.5ì´ˆ (LLM ë‹µë³€ ìƒì„± ë¶ˆí•„ìš”)
      â†’ ì‚¬ìš©ì ì„ íƒ â†’ search ë¶„ê¸°ë¡œ
      ì´ ~3.5ì´ˆ (2í„´), ì •í™•ë„ 100%
```
