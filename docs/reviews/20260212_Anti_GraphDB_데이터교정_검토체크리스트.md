# Graph DB 데이터 교정 검토 체크리스트

## 1. 문제 발견 경위

RAG 챗봇으로 `[표 13-2-3] 강관용접` 데이터를 질문했을 때, 원본 품셈과 다른 값이 출력됨.
원본 MD 파싱은 정확하나, **Graph DB에 저장된 수치 자체가 원본과 불일치**.

---

## 2. 현황 분석

| 항목 | 수치 |
| --- | ---: |
| 전체 엔티티 | 16,424개 |
| LLM 추출 (오류 가능) | **12,026개 (73%)** |
| 규칙 추출 (정확) | 3,483개 (21%) |
| 영향 section 수 | **937개** |
| 전체 관계 | 23,630개 |

---

## 3. 발견된 문제점

### 3-1. 직종 혼동 🔴
- 원본: SCH 20/30 = **용접공**, SCH 40~160 = **플랜트 용접공**
- DB: 모든 SCH에서 `플랜트용접공`으로 통일 → 직종 구분 소실

### 3-2. 특별인부 허위 생성 🔴
- 원본 전기아크용접 테이블에 **특별인부 없음**
- DB: LLM이 TIG용접 구조를 혼동하여 특별인부 관계 생성

### 3-3. 수치 전면 불일치 🔴 (200mm 구경 예시)

| SCH | 원본 직종 | 원본 값 | DB 직종 | DB 값 | 일치 |
| ---: | --- | ---: | --- | ---: | --- |
| 20 | **용접공** | 0.287 | 플랜트용접공 | 0.244 | ❌ |
| 40 | 플랜트 용접공 | 0.287 | 플랜트용접공 | 0.294 | ❌ |
| 60 | 플랜트 용접공 | 0.325 | 플랜트용접공 | 0.352 | ❌ |
| 80 | 플랜트 용접공 | 0.362 | 플랜트용접공 | 0.416 | ❌ |

### 3-4. 규격 누락 🟡
- SCH 100~160 구경 250~400mm 다수 누락

---

## 4. 근본 원인

```
① PDF → MD 파싱         ✅ 정확
② MD → chunks JSON      ✅ 정확
③ chunks → step1 규칙추출  ⚠️ 매트릭스 테이블 패턴 미지원 → 대부분 스킵
④ chunks → step2 LLM추출   ❌ LLM이 매트릭스를 잘못 해석 → 틀린 값 INSERT
```

`step1_table_extractor.py`가 **3가지 패턴만 인식** (Case A/B/C):
- 매트릭스(구경×SCH), 복합 직종 헤더, 범위 값 등은 미지원
- 미지원 패턴 → step2(LLM)가 대신 처리 → 수치/직종 부정확

---

## 5. 영향 범위

13-2-3뿐 아니라 **LLM이 처리한 937개 section 전체**에 동일한 오류 가능성.

---

## 6. 해결 방향 → [구현 계획서 참조](./20260211_Anti_Graph%20DB%20대규모%20데이터%20교정%20구현%20계획서.md)

| Phase | 작업 | 핵심 |
| --- | --- | --- |
| 1 | step1 규칙 추출기 강화 | 매트릭스 등 새 패턴 추가 |
| 2 | 전체 재추출 (step1~5) | LLM 의존도 축소 |
| 3 | 원본 MD 대조 검증 | 수치 100% 일치 확인 |
| 4 | DB 교체 + 임베딩 재생성 | 백업 후 교체 |

---

## 7. RAG 챗봇 서빙 체크리스트

- [ ] **Phase 1-1**: 미인식 테이블 패턴 전수 조사 (`analyze_unhandled_tables.py`)
- [ ] **Phase 1-2**: step1에 Case D(매트릭스), E(직종 보강), F(범위 값) 추가
- [ ] **Phase 2-1**: step1 재실행 → 커버리지 확인
- [ ] **Phase 2-2**: step2 LLM 재실행 (잔여 청크)
- [ ] **Phase 2-3**: step3(병합) → step4(정규화) → step5(검증) 순차 실행
- [ ] **Phase 3**: 원본 MD 대조 검증 → 불일치 0건 확인
- [ ] **Phase 4-1**: 기존 DB 백업 (`graph_entities_backup`, `graph_relationships_backup`)
- [ ] **Phase 4-2**: step6(DB 적재) → step7(임베딩 재생성) 실행
- [ ] **Phase 4-3**: RAG 챗봇 검증
  - [ ] "강관용접 200mm SCH 40 품셈" → 플랜트 용접공 0.287인
  - [ ] "강관용접 200mm SCH 20 품셈" → **용접공** 0.287인
  - [ ] "강관용접 전체 규격" → 17구경 × 9SCH 전체 데이터
