# Phase 3-C: 검색 레이어 구조적 공백 분석 보고서
> 작성일: 2026-02-13 21:37  
> 트리거: "장비 편성 관련 품셈" 검색 시 기초공사 데이터 미반환

---

## 1. 현상

사용자가 **"장비 편성 관련 품셈"**을 검색했을 때:

### 실제 반환된 결과 (오답)
| #   | 섹션                | 부문                                  |
| --- | ------------------- | ------------------------------------- |
| 1   | 공통장비            | 공통부문 > 제2장 가설공사             |
| 2   | 부수장비            | 기계설비부문 > 제8장 공기조화설비공사 |
| 3   | [80]스마트 건설장비 | 공통부문 > 제8장 건설기계             |
| 4   | [80]스마트 건설장비 | 공통부문 > 제8장 건설기계             |
| 5   | [90]해상장비        | 공통부문 > 제8장 건설기계             |

### 기대되는 결과 (정답)
| #   | 섹션                    | 부문                      | chunk text에 "장비편성" 포함 |
| --- | ----------------------- | ------------------------- | :--------------------------: |
| 1   | 5-1-5 어스앵커 공법     | 공통부문 > 제5장 기초공사 |              ✅               |
| 2   | 5-2-2 고압분사 주입공법 | 공통부문 > 제5장 기초공사 |              ✅               |
| 3   | 5-3-1 기성말뚝 기초     | 공통부문 > 제5장 기초공사 |              ✅               |
| 4   | 5-3-2 말뚝박기용 천공   | 공통부문 > 제5장 기초공사 |              ✅               |
| 5   | 5-3-5 현장타설말뚝      | 공통부문 > 제5장 기초공사 |              ✅               |

→ **완전히 다른 영역의 데이터가 반환**되고 있음.

---

## 2. 원인 분석

### 2-1. 검색 파이프라인 구조와 공백

현재 검색 파이프라인:

```
[사용자 질의: "장비 편성 관련 품셈"]
        │
        ▼
┌─────────────────────────────────────────────────┐
│ Layer 1: 엔티티 이름 벡터 검색 (searchEntities)  │  ✅ 존재
│  graph_entities.embedding ↔ 질의 임베딩          │
│  → "공통장비", "부수장비" 등 이름 유사 매칭       │
│  ❌ "장비편성" 이름의 엔티티 없음 → 오답 반환     │
└─────────────────────────────────────────────────┘
        │ 실패 시
        ▼
┌─────────────────────────────────────────────────┐
│ Layer 2: 엔티티 이름 키워드 폴백 (ILIKE)         │  ✅ 존재
│  graph_entities.name ILIKE '%편성%'               │
│  → stopWords로 "장비" 제거됨, "편성"만 남음       │
│  ❌ 엔티티 이름에 "편성" 포함된 것 없음 → 실패    │
└─────────────────────────────────────────────────┘
        │ 실패 시
        ▼
┌─────────────────────────────────────────────────┐
│ Layer 3: chunk 본문 텍스트 검색                   │  ❌ 없음
│  graph_chunks.text ILIKE '%장비편성%'              │
│  → 이 레이어가 없어서 아예 찾을 수 없음           │
└─────────────────────────────────────────────────┘
```

### 2-2. 왜 벡터 검색이 오답을 반환하는가

| 질의 토큰          | 벡터 검색 매칭 대상                | 결과                       |
| ------------------ | ---------------------------------- | -------------------------- |
| "장비"             | 엔티티 이름에 "장비" 포함된 것들   | 공통장비, 부수장비 등 36개 |
| "편성"             | 임베딩 공간에서 "편성"과 유사한 것 | 거의 없음                  |
| "장비 편성" (복합) | 복합어로서 매칭되는 엔티티 없음    | 0건                        |

벡터 검색은 "장비"에 끌려가서 **이름에 "장비"가 포함된 섹션들을 반환**합니다.  
정답인 "고압분사 주입공법", "기성말뚝 기초" 등은 **이름에 "장비"도 "편성"도 없어서** 매칭 불가.

### 2-3. stopWords에서 "장비" 제거하면 해결되는가?

**아니요. 두 가지 이유:**

#### 이유 1: 해결 효과 없음
```
keywordFallbackSearch는 graph_entities.name에서 ILIKE 검색
→ "장비" 제거 시 키워드: ["장비", "편성"]
→ ILIKE '%장비%편성%' → 엔티티 이름에 "장비편성" 없음 → 0건
→ 문제 그대로
```

#### 이유 2: 부작용 발생
| 시나리오              | "장비" stopWords 유지    | "장비" 제거 시             | 영향             |
| --------------------- | ------------------------ | -------------------------- | ---------------- |
| "콘크리트 타설 품셈"  | `["콘크리트", "타설"]` ✅ | 동일 ✅                     | 영향 없음        |
| "장비 품셈"           | `[]` → 폴백 안 함        | `["장비"]` → 36개 WT 매칭  | 🔶 노이즈         |
| "배관 장비 운반 품셈" | `["배관", "운반"]` ✅     | `["배관", "장비", "운반"]` | 🔶 과잉매칭       |
| **"장비 편성 품셈"**  | `["편성"]` ❌             | `["장비", "편성"]`         | ❌ **여전히 0건** |

→ **부작용만 생기고 원래 문제는 해결 안 됨**

### 2-4. 구조적 패턴: chunk text에만 존재하는 소제목들

품셈서의 **표준 구조** (특히 기초공사 분야):
```
5-3-1 기성말뚝 기초
  1. 적용범위
  2. 장비조립·해체 (회당)
  3. 인력편성 (인/일)     ← chunk text에만 존재
  4. 장비편성              ← chunk text에만 존재
  5. 장비소요시간          ← chunk text에만 존재
```

이 소제목들은 LLM 엔티티 추출 시 **독립 엔티티가 아닌 상위 WorkType의 속성**으로 처리됨.

| 소제목 용어 | chunk text 포함 | 엔티티 이름 존재 |  갭   |
| ----------- | --------------: | ---------------: | :---: |
| 인력편성    |             3건 |          **0건** |   ❌   |
| 장비편성    |             4건 |          **0건** |   ❌   |
| 작업편성    |             2건 |              1건 |   ⚠️   |
| 장비소요    |             1건 |          **0건** |   ❌   |
| 작업능력    |            18건 |              2건 |   ⚠️   |

→ 사용자가 이 소제목 용어로 검색하면 **항상 실패**하는 구조적 문제.

### 2-5. stopWords 영향도 전수 분석

| stopWord | WorkType 이름 매칭 | 제거 시 위험    |
| -------- | -----------------: | --------------- |
| 인력     |               78건 | ★★★★★ 매우 위험 |
| 장비     |               36건 | ★★★★☆ 위험      |
| 자재     |               11건 | ★★★☆☆ 중간      |
| 수량     |                7건 | ★★☆☆☆ 낮음      |
| 관련     |                1건 | ★☆☆☆☆ 무시      |
| 품셈     |                1건 | ★☆☆☆☆ 무시      |
| 단위     |                1건 | ★☆☆☆☆ 무시      |
| 알려줘   |                0건 | —               |
| 얼마     |                0건 | —               |

→ "인력", "장비"를 stopWords에서 제거하면 **가장 넓은 노이즈 발생**

---

## 3. 해결 방안 비교

| #     | 방안                                     | 위험도   | 효과                        | 개발 공수                   |
| ----- | ---------------------------------------- | -------- | --------------------------- | --------------------------- |
| A     | stopWords에서 "장비" 제거                | **높음** | **없음** (원래 문제 미해결) | 1분                         |
| B     | graph_chunks.embedding 벡터 검색 추가    | 중간     | 높음                        | 반나절 (임베딩 재생성 필요) |
| **C** | **chunk text 키워드 검색 fallback 추가** | **낮음** | **높음**                    | **30분**                    |
| D     | 의도분석 LLM에 복합어 구체화 유도        | 낮음     | 중간                        | 15분                        |

### 추천: 방안 C — chunk text 키워드 검색 fallback

**이유:**
1. 기존 Layer 1, 2에 전혀 영향 없음 (새 Layer 3 추가만)
2. chunk text에 이미 데이터가 존재하므로 추가 데이터 작업 불필요
3. "장비편성" 뿐 아니라 "인력편성", "작업능력" 등 동일 패턴 전부 해결
4. 임베딩 재생성 같은 무거운 작업 불필요

---

## 4. 결론

**"장비 편성" 검색 실패는 stopWords 문제가 아니라, 검색 파이프라인에 chunk text 검색 레이어가 없는 구조적 공백입니다.**

stopWords 수정은 부작용만 생기고 원래 문제를 해결하지 못합니다.  
chunk text 키워드 검색 fallback을 새 Layer 3으로 추가하는 것이 안전하고 효과적인 해결책입니다.
