# Step 2.8 RAG 챗봇 서빙 — 상세 구현 계획서 (codex)

> **문서 버전**: v1.0  
> **작성일**: 2026-02-11  
> **전제**: Step 2.7 (임베딩 생성 + SQL 검색 함수) 완료  
> **설계 근거**: `20260211_Step2.6이후_전면재검토_설계보고서.md` §4 Step 2.8

---

## 0. 현재 인프라 상태 (Step 2.7 완료 기준)

### 0.1 Supabase 데이터

| 테이블                       |  건수  | 임베딩 | 비고                              |
| ---------------------------- | :----: | :----: | --------------------------------- |
| `graph_entities`             | 16,364 | ✅ 768d | WorkType, Labor, Equipment 등 7종 |
| `graph_relationships`        | 23,586 |   —    | 6종 관계 (REQUIRES_LABOR 등)      |
| `graph_global_relationships` | 1,063  |   —    | HAS_CHILD(1,061), REFERENCES(2)   |
| `graph_chunks`               | 2,105  | ✅ 768d | 원문 청크 (RAG 참고용)            |
| `ilwi_items`                 | 6,992  |   —    | 구조 검색 전용 (임베딩 안 함)     |

### 0.2 배포된 SQL 함수

| 함수                           | 시그니처                                                                   | 용도              |
| ------------------------------ | -------------------------------------------------------------------------- | ----------------- |
| `search_entities_by_embedding` | `(text, int=5, float=0.5) → TABLE(id, name, type, properties, similarity)` | 벡터 유사도 검색  |
| `get_related_resources`        | `(text) → TABLE(direction, relation, related_id, related_name, ...)`       | 1-hop 그래프 확장 |
| `get_entity_hierarchy`         | `(text) → TABLE(direction, relation, related_id, related_name, ...)`       | 전역 관계 탐색    |
| `search_ilwi`                  | `(text, text=NULL) → TABLE(id, name, spec, labor_cost, ...)`               | 일위대가 검색     |

### 0.3 Supabase 프로젝트 정보

| 항목       | 값                                         |
| ---------- | ------------------------------------------ |
| Project ID | `bfomacoarwtqzjfxszdr`                     |
| API URL    | `https://bfomacoarwtqzjfxszdr.supabase.co` |
| Anon Key   | `eyJhbGciOi...` (JWT, RLS anon_read 정책)  |
| 기존 EF    | `regenerate-embeddings` (unit_costs 용)    |

---

## 1. 시스템 아키텍처

### 1.1 전체 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    RAG 챗봇 시스템 구성                       │
│                                                              │
│  [사용자]                                                    │
│     │ 질문 입력                                              │
│     ▼                                                        │
│  [정적 HTML 프론트엔드]  ← Cloudflare Pages / 로컬           │
│     │ POST /functions/v1/rag-chat                            │
│     ▼                                                        │
│  [Supabase Edge Function: rag-chat]                          │
│     │                                                        │
│     ├─ (A) 질문 임베딩 생성  ← Gemini API                    │
│     │       gemini-embedding-001 → vector(768)               │
│     │                                                        │
│     ├─ (B) 벡터 검색         ← search_entities_by_embedding  │
│     │       질문 벡터 → TOP-3 유사 엔티티                    │
│     │                                                        │
│     ├─ (C) 그래프 확장       ← get_related_resources         │
│     │       각 엔티티 → 관련 Labor/Equipment/Material/Note   │
│     │                                                        │
│     ├─ (D) 계층 확장         ← get_entity_hierarchy          │
│     │       Section 엔티티 → 하위 섹션 정보                  │
│     │                                                        │
│     ├─ (E) 일위대가 검색     ← search_ilwi                   │
│     │       비용 의도 감지 시 → 이름+규격 매칭               │
│     │                                                        │
│     ├─ (F) 원문 청크 보강    ← graph_chunks 직접 조회        │
│     │       엔티티의 source_section → 해당 청크 본문         │
│     │                                                        │
│     └─ (G) LLM 답변 생성    ← Gemini API                    │
│             컨텍스트 조합 → gemini-2.0-flash → 답변           │
│     │                                                        │
│     ▼                                                        │
│  [사용자에게 응답]                                            │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 핵심 설계 원칙

| 원칙            | 적용                                                  |
| --------------- | ----------------------------------------------------- |
| **Zero-ops**    | Edge Function 서버리스 → 집 PC 꺼도 동작              |
| **단일 저장소** | Supabase PostgreSQL = 벡터 + 그래프 + 구조 검색 한 곳 |
| **그래프 RAG**  | 벡터 검색 → 그래프 확장 → 컨텍스트 보강 → LLM 답변    |
| **비용 $0**     | Gemini Free tier + Supabase Free tier                 |
| **원문 참조**   | 답변에 반드시 출처(부문>장>절) 명시                   |

---

## 2. Edge Function 상세 설계

### 2.1 함수 메타데이터

| 항목           | 값                                |
| -------------- | --------------------------------- |
| **slug**       | `rag-chat`                        |
| **runtime**    | Deno (Supabase Edge Runtime)      |
| **entrypoint** | `index.ts`                        |
| **verify_jwt** | `false` (정적 프론트 호출 + 서버측 서명 검증) |
| **CORS**       | allowlist (개발/운영 도메인만 허용) |

> **Why verify_jwt=false**: 프론트엔드가 정적 HTML이므로 JWT 발급 주체가 없음.
> 대신 요청 API Key(`X-RAG-API-Key`) 검증 + 서버측 Rate Limiting + 응답 크기 제한으로 남용 방지.
> 향후 Supabase Auth 도입 시 `true`로 전환.

### 2.2 요청/응답 스키마

#### 요청 (POST)

```typescript
interface ChatRequest {
  question: string;      // 사용자 질문 (필수, 최대 500자)
  history?: ChatMessage[]; // 대화 이력 (선택, 최대 5턴)
}

interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
}
```

#### 응답

```typescript
interface ChatResponse {
  answer: string;           // LLM 생성 답변 (마크다운)
  sources: SourceInfo[];    // 참조 출처
  search_info: SearchInfo;  // 검색 디버그 정보
}

interface SourceInfo {
  entity_name: string;
  entity_type: string;
  section?: string;         // "토목부문 > 제6장 > 콘크리트 타설"
  // section은 search 결과 + graph_chunks(section_id) 추가 조회로 구성
  similarity?: number;
}

interface SearchInfo {
  entities_found: number;
  relations_expanded: number;
  ilwi_matched: number;
  chunks_retrieved: number;
  latency_ms: number;
}
```

### 2.3 처리 파이프라인 상세

```
handleRequest(question)
│
├─ [1] 입력 검증
│     - question 빈 값/길이 초과 체크
│     - question 500자 초과 시 500자로 truncate
│
├─ [2] 질문 임베딩 생성  ────────────────────────────── 약 200ms
│     POST https://generativelanguage.googleapis.com/v1beta/
│           models/gemini-embedding-001:embedContent
│     model: "models/gemini-embedding-001"
│     content: { parts: [{ text: question }] }
│     → vector(768)
│
├─ [3] 벡터 검색  ──────────────────────────────────── 약 100ms
│     supabase.rpc('search_entities_by_embedding', {
│       query_embedding_text: JSON.stringify(embedding),
│       match_count: 5,
│       match_threshold: 0.4
│     })
│     → entities[] (최대 5건)
│
│     ※ threshold 0.5→0.4 완화: 건설 용어의 특수성
│       "PE관 배관" ↔ "폴리에틸렌관 접합" 유사도가 0.45일 수 있음
│
├─ [4] 그래프 확장 (병렬 호출)  ────────────────────── 약 200ms
│     for each entity:
│       ├─ supabase.rpc('get_related_resources', { p_entity_id })
│       └─ supabase.rpc('get_entity_hierarchy', { p_entity_id })
│           ※ Section 타입인 경우만 호출
│
│     결과 구조화:
│       entity.name (WorkType)
│         ├─ REQUIRES_LABOR: [보통인부 0.122인, 콘크리트공 0.045인]
│         ├─ REQUIRES_EQUIPMENT: [바이브레이터 1대]
│         ├─ USES_MATERIAL: [레미콘 1.02m³]
│         ├─ HAS_NOTE: ["할증 10% 적용", "고압 시 별도"]
│         └─ BELONGS_TO: [제6장 콘크리트공사]
│
├─ [5] 비용 의도 감지 + 일위대가 검색  ────────────── 약 100ms
│     detectCostIntent(question):
│       키워드: "비용", "단가", "가격", "원", "얼마", "일위대가",
│              "재료비", "노무비", "경비", "합계"
│
│     if (costIntent) {
│       for each entity (WorkType만):
│         supabase.rpc('search_ilwi', {
│           search_name: entity.name,
│           search_spec: extractSpec(question)  // 규격 추출
│         })
│     }
│
├─ [6] 원문 청크 보강  ────────────────────────────── 약 50ms
│     entity.source_section → graph_chunks.section_id 매칭
│     → 해당 청크의 content (원문 텍스트) 가져오기
│     → 최대 3건, 각 500자 제한
│
├─ [7] 컨텍스트 조합  ─────────────────────────────── 약 10ms
│     buildContext():
│       "## 품셈 정보 (벡터 검색 결과)"
│       "### 1. 콘크리트 타설 (유사도: 0.95)"
│       "- 투입 인력: 보통인부 0.122인, 콘크리트공 0.045인"
│       "- 투입 장비: 바이브레이터 1대"
│       "- 사용 자재: 레미콘 1.02m³"
│       "- 주의사항: 할증 10% 적용"
│       "- 출처: 토목부문 > 제6장 콘크리트공사"
│       "## 일위대가 비용 정보"
│       "| 항목 | 규격 | 노무비 | 재료비 | 합계 |"
│       "## 원문 참고"
│       "(해당 품셈 원문 텍스트)"
│
└─ [8] LLM 답변 생성  ────────────────────────────── 약 2000ms
      POST generativelanguage.googleapis.com/v1beta/
            models/gemini-2.0-flash:generateContent
      
      system_instruction: (§2.4 참조)
      contents: [
        ...history (최대 5턴),
        { role: "user", parts: [{ text: question + context }] }
      ]
      → markdown 형태 답변
```

### 2.4 시스템 프롬프트 설계

```typescript
const SYSTEM_PROMPT = `당신은 건설 공사 품셈(標準品셈) 전문 AI 어시스턴트입니다.

[역할]
- 사용자의 건설 공사 관련 질문에 대해 품셈 데이터를 기반으로 정확하게 답변합니다.
- 답변 시 반드시 제공된 컨텍스트의 데이터만 사용하며, 컨텍스트에 없는 정보는 추측하지 않습니다.

[답변 규칙]
1. **출처 명시**: 답변에 사용한 품셈 항목의 출처(부문 > 장 > 절)를 반드시 표기합니다.
2. **수량 정확성**: 인력, 장비, 자재의 수량과 단위를 정확하게 표기합니다.
   예: "보통인부 0.122인", "콘크리트공 0.045인"
3. **비용 답변 시**: 일위대가 정보가 제공되면, 노무비/재료비/경비/합계를 표 형태로 정리합니다.
4. **주의사항 포함**: 할증, 적용 조건, 제한 사항이 있으면 반드시 언급합니다.
5. **정보 부족 시**: "제공된 품셈 데이터에서 해당 정보를 찾을 수 없습니다"라고 답합니다.
6. **마크다운 형식**: 답변은 마크다운 형식으로 작성하여 가독성을 높입니다.

[금지 사항]
- 컨텍스트에 없는 수치나 기준을 임의로 생성하지 않습니다.
- "일반적으로", "보통", "대략" 등 모호한 표현 대신 정확한 수치를 사용합니다.
- 건설 관련이 아닌 질문에는 "건설 품셈 관련 질문에만 답변할 수 있습니다"라고 응답합니다.`;
```

### 2.5 에러 핸들링

| 에러 시나리오               | HTTP  | 응답                             | 사용자 메시지               |
| --------------------------- | :---: | -------------------------------- | --------------------------- |
| 질문 미입력 / 빈 문자열     |  400  | `{ error: "question_required" }` | "질문을 입력해주세요"       |
| 질문 500자 초과             |  200  | 정상 처리 (500자로 truncate)       | "질문이 길어 500자로 요약 처리" |
| 임베딩 API 실패             |  502  | `{ error: "embedding_failed" }`  | "임베딩 생성 중 오류"       |
| 벡터 검색 0건               |  200  | 정상 (LLM이 "찾을 수 없음" 답변) | —                           |
| Gemini 답변 생성 실패       |  502  | `{ error: "llm_failed" }`        | "답변 생성 중 오류"         |
| Supabase RPC 실패           |  500  | `{ error: "db_error" }`          | "데이터 조회 중 오류"       |
| 요청 Too Large (body >10KB) |  413  | `{ error: "payload_too_large" }` | —                           |

### 2.6 환경 변수

| 변수                        | 용도                   | 설정 방법                                     |
| --------------------------- | ---------------------- | --------------------------------------------- |
| `GEMINI_API_KEY`            | 임베딩 + 답변 생성     | Supabase Dashboard > Edge Functions > Secrets |
| `RAG_API_KEY`               | Edge Function 호출 보호 | Supabase Dashboard > Edge Functions > Secrets |
| `SUPABASE_URL`              | DB 연결 (자동 주입)    | 자동                                          |
| `SUPABASE_SERVICE_ROLE_KEY` | DB 조회 (RLS 바이패스) | 자동                                          |

> **Why SERVICE_ROLE_KEY**: Edge Function은 서버사이드이므로 anon key도 가능하나,
> 내부 RPC 호출의 일관성을 위해 service_role 사용. 외부 노출 위험 없음.


### 2.7 보안 게이트웨이 (필수, API Key 방식)

- `verify_jwt=false` 유지 시에도 공개 호출을 그대로 허용하지 않는다.
- 요청 헤더 `X-RAG-API-Key`를 검증한다. (서명/HMAC 미사용)
- 허용 도메인 allowlist 외 Origin은 차단한다.
- 사용자/IP 기준 분당 호출량 제한을 적용한다.
- 유효하지 않은 API Key는 401로 즉시 종료한다.
---

## 3. 프론트엔드 상세 설계

### 3.1 파일 구조

```
python_code/
└── frontend/
    ├── index.html          ← 메인 챗봇 페이지
    ├── style.css           ← 스타일시트
    └── app.js              ← 챗봇 로직
```

### 3.2 UI/UX 설계

```
┌────────────────────────────────────────────┐
│  🏗️ 건설 품셈 AI 어시스턴트                 │
│──────────────────────────────────────────  │
│                                            │
│  [AI] 안녕하세요! 건설 품셈에 대해          │
│       궁금한 점을 물어보세요.               │
│                                            │
│  [User] 콘크리트 타설 비용 알려줘           │
│                                            │
│  [AI] ## 콘크리트 타설 품셈 정보            │
│       ### 투입 인력                         │
│       | 직종 | 수량 | 단위 |               │
│       |------|------|------|               │
│       | 보통인부 | 0.122 | 인 |            │
│       ...                                  │
│       📌 출처: 토목부문 > 제6장             │
│                                            │
│  ┌──────────────────────────────────┐      │
│  │ 질문을 입력하세요...          [▶]│      │
│  └──────────────────────────────────┘      │
└────────────────────────────────────────────┘
```

### 3.3 주요 기능

| 기능                | 설명                                            |
| ------------------- | ----------------------------------------------- |
| **마크다운 렌더링** | AI 답변의 테이블, 볼드, 리스트를 HTML로 변환    |
| **대화 이력 관리**  | 최근 5턴을 저장하여 Edge Function에 전달        |
| **로딩 상태**       | 답변 대기 시 타이핑 애니메이션                  |
| **에러 표시**       | 네트워크 오류, 서버 오류 시 사용자 안내         |
| **검색 디버그**     | 접이식 패널로 검색 엔티티, 유사도 표시 (개발용) |
| **반응형 레이아웃** | 모바일/데스크톱 대응                            |

### 3.4 API 호출

```javascript
const EDGE_FUNCTION_URL = 
  'https://bfomacoarwtqzjfxszdr.supabase.co/functions/v1/rag-chat';

async function sendQuestion(question, history = []) {
  const response = await fetch(EDGE_FUNCTION_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      // verify_jwt=false + API Key 검증 방식
      'X-RAG-API-Key': RAG_API_KEY,
    },
    body: JSON.stringify({ question, history })
  });
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`);
  }
  
  return await response.json(); // ChatResponse
}
```

---

## 4. Edge Function 구현 계획

### 4.1 코드 구조

```typescript
// index.ts — 진입점
import "jsr:@supabase/functions-js/edge-runtime.d.ts";

// 모듈 분리 (단일 파일이지만 논리적 구획)
// ━━━ [A] 설정 & 유틸 ━━━
//   - 환경 변수 로드
//   - Supabase 클라이언트 생성
//   - CORS 헤더
//   - 입력 검증

// ━━━ [B] 임베딩 생성 ━━━
//   - generateEmbedding(text) → number[]

// ━━━ [C] 검색 파이프라인 ━━━
//   - searchEntities(embedding) → Entity[]
//   - expandGraph(entities) → RelatedResource[]
//   - searchIlwi(entities, question) → IlwiItem[]
//   - retrieveChunks(entities) → Chunk[]

// ━━━ [D] 컨텍스트 조합 ━━━
//   - buildContext(entities, relations, ilwi, chunks) → string

// ━━━ [E] 의도 감지 ━━━
//   - detectCostIntent(question) → boolean
//   - extractSpec(question) → string | null

// ━━━ [F] LLM 답변 생성 ━━━
//   - generateAnswer(question, context, history) → string

// ━━━ [G] 메인 핸들러 ━━━
//   - Deno.serve(handler)
```

### 4.2 검색 흐름 의사코드

```typescript
async function handleChat(question: string, history: ChatMessage[]) {
  const startTime = Date.now();

  // [1] 질문 임베딩
  const embedding = await generateEmbedding(question);

  // [2] 벡터 검색 → 시작점 엔티티
  const entities = await searchEntities(embedding);

  if (entities.length === 0) {
    // 벡터 검색 실패 → LLM에게 "찾을 수 없음" 답변 위임
    const answer = await generateAnswer(question, 
      "제공된 품셈 데이터베이스에서 관련 정보를 찾지 못했습니다.", 
      history
    );
    return { answer, sources: [], search_info: { ... } };
  }

  // [3] 그래프 확장 (병렬)
  const relationsPromises = entities.map(e => 
    expandGraph(e.id, e.type)
  );
  const relationsAll = await Promise.all(relationsPromises);

  // [4] 비용 의도 → 일위대가
  let ilwiResults = [];
  if (detectCostIntent(question)) {
    const workTypeEntities = entities.filter(e => e.type === 'WorkType');
    for (const e of workTypeEntities) {
      const spec = extractSpec(question);
      const items = await searchIlwi(e.name, spec);
      if (items.length > 0) {
        ilwiResults.push(...items);
        break; // 첫 매칭 사용
      }
    }
  }

  // [5] 원문 청크 보강
  const chunks = await retrieveChunks(entities);

  // [6] 컨텍스트 → LLM 답변
  const context = buildContext(entities, relationsAll, ilwiResults, chunks);
  const answer = await generateAnswer(question, context, history);

  // [7] 응답 조립
  return {
    answer,
    sources: entities.map(e => ({
      entity_name: e.name,
      entity_type: e.type,
      similarity: e.similarity
    })),
    search_info: {
      entities_found: entities.length,
      relations_expanded: relationsAll.flat().length,
      ilwi_matched: ilwiResults.length,
      chunks_retrieved: chunks.length,
      latency_ms: Date.now() - startTime
    }
  };
}
```

### 4.3 Gemini API 호출 상세

#### 임베딩 생성

```typescript
// 모델: gemini-embedding-001 (Step 2.7과 동일 모델 필수)
// Why: 검색 시 질문 벡터와 DB 벡터의 모델이 다르면 유사도 무의미
const EMBEDDING_URL = 
  'https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:embedContent';

async function generateEmbedding(text: string): Promise<number[]> {
  const response = await fetch(`${EMBEDDING_URL}?key=${GEMINI_API_KEY}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'models/gemini-embedding-001',
      content: { parts: [{ text }] },
    }),
  });

  if (!response.ok) {
    throw new Error(`Embedding API failed: ${response.status}`);
  }

  const data = await response.json();
  return data.embedding?.values ?? [];
}
```

#### 답변 생성

```typescript
// 모델: gemini-2.0-flash (빠르고 정확)
// Why: Edge Function 제한시간(~25초) 내 응답 필수
//      Flash 모델은 ~2초 응답, Pro는 ~5초 → Flash 선택
const LLM_URL = 
  'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

async function generateAnswer(
  question: string, 
  context: string, 
  history: ChatMessage[]
): Promise<string> {
  const contents = [
    // 대화 이력 (최대 5턴)
    ...history.slice(-5).map(msg => ({
      role: msg.role === 'user' ? 'user' : 'model',
      parts: [{ text: msg.content }],
    })),
    // 현재 질문 + 컨텍스트
    {
      role: 'user',
      parts: [{ text: `[질문]\n${question}\n\n[참고 데이터]\n${context}` }],
    },
  ];

  const response = await fetch(`${LLM_URL}?key=${GEMINI_API_KEY}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
      contents,
      generationConfig: {
        temperature: 0.3,   // 낮은 창의성 → 정확한 품셈 답변
        maxOutputTokens: 2048,
      },
    }),
  });

  if (!response.ok) {
    throw new Error(`LLM API failed: ${response.status}`);
  }

  const data = await response.json();
  return data.candidates?.[0]?.content?.parts?.[0]?.text ?? '답변 생성에 실패했습니다.';
}
```

---

## 5. 비용 의도 감지 & 일위대가 매칭 전략

### 5.1 비용 의도 감지

```typescript
const COST_KEYWORDS = [
  '비용', '단가', '가격', '원', '얼마', '일위대가',
  '재료비', '노무비', '경비', '합계', '산출', '견적',
  '공사비', '원가', '금액'
];

function detectCostIntent(question: string): boolean {
  return COST_KEYWORDS.some(kw => question.includes(kw));
}
```

### 5.2 규격 추출

```typescript
// 사용자 질문에서 규격 패턴 추출
// "강관 용접 배관 D80 기계실" → spec = "D80"
const SPEC_PATTERNS = [
  /D\d+/i,                // D80, D100
  /\d+mm/i,               // 100mm, 200mm
  /\d+톤/,                // 10톤, 25톤  
  /\d+m[³²]?/,            // 0.7m³, 100m²
  /\d+-\d+-\d+/,          // 25-180-12 (레미콘 규격)
];

function extractSpec(question: string): string | null {
  for (const pattern of SPEC_PATTERNS) {
    const match = question.match(pattern);
    if (match) return match[0];
  }
  return null;
}
```

### 5.3 일위대가 재랭킹

```
일위대가 검색 결과가 다수인 경우 (예: 배관 → 144건):
  
  1단계: search_ilwi(name)로 후보 조회 (최대 10건)
  2단계: 사용자 질문에서 규격 키워드 추출
  3단계: spec 매칭으로 필터링
  4단계: 그래도 다수이면 TOP-3만 컨텍스트에 포함
```

---

## 6. 컨텍스트 조합 전략

### 6.1 컨텍스트 구조

```markdown
## 품셈 검색 결과

### 1. {entity_name} ({entity_type}, 유사도: {similarity})
**출처**: {부문} > {장} > {절}

**투입 인력 (REQUIRES_LABOR)**:
| 직종       | 수량  | 단위 |
| ---------- | ----- | ---- |
| 보통인부   | 0.122 | 인   |
| 콘크리트공 | 0.045 | 인   |

**투입 장비 (REQUIRES_EQUIPMENT)**:
- 바이브레이터 1대

**사용 자재 (USES_MATERIAL)**:
- 레미콘 25-180-12: 1.02 m³

**주의사항 (HAS_NOTE)**:
- 할증 10% 적용 (비탈면 작업 시)
- 고압 콘크리트 별도

---

## 일위대가 비용 정보

| 항목          | 규격 | 노무비 | 재료비 | 경비 | 합계   |
| ------------- | ---- | ------ | ------ | ---- | ------ |
| 콘크리트 타설 | 일반 | 41,605 | 52,300 | -    | 93,905 |

---

## 원문 참고 (품셈 원문)

> 6-3-1 콘크리트타설
> [주] ① 콘크리트 타설은 레미콘을 기준으로 하며...
```

### 6.2 컨텍스트 크기 제한

| 항목              | 제한             | 이유                             |
| ----------------- | ---------------- | -------------------------------- |
| 엔티티            | 최대 5건         | TOP-5 결과                       |
| 관계 (per entity) | 최대 20건        | 대부분 엔티티의 관계 < 15        |
| 일위대가          | 최대 5건         | 규격 변형 중복 방지              |
| 청크 원문         | 최대 3건 × 500자 | Gemini 입력 토큰 제한            |
| **총 컨텍스트**   | **~4,000자**     | Gemini Flash 입력 한계 대비 여유 |

---

## 7. 테스트 계획

### 7.1 단위 테스트 (Edge Function 내부)

| #   | 테스트         | 입력             | 기대                           |
| --- | -------------- | ---------------- | ------------------------------ |
| T1  | 임베딩 생성    | "콘크리트 타설"  | 768차원 벡터 반환              |
| T2  | 벡터 검색      | 콘크리트 벡터    | Top-1 엔티티 반환 (유사도 임계값은 환경설정값 이상) |
| T3  | 빈 검색        | "xyzzy" 무의미어 | entities=0, LLM "찾을 수 없음" |
| T4  | 비용 의도 감지 | "비용 알려줘"    | true                           |
| T5  | 비용 비의도    | "인력 알려줘"    | false                          |
| T6  | 규격 추출      | "D80 기계실"     | "D80"                          |

### 7.2 통합 테스트 (E2E)

| #   | 질문                        | 기대 응답 요소                                  |
| --- | --------------------------- | ----------------------------------------------- |
| E1  | "콘크리트 타설 비용 알려줘" | 인력(보통인부, 콘크리트공) + 일위대가 표 + 출처 |
| E2  | "PE관 배관 인력"            | 배관공 + 보통인부 + 수량 + 출처                 |
| E3  | "보통인부가 필요한 공종"    | 다수 WorkType 나열 + 각 수량                    |
| E4  | "철근 가공 장비 뭐 써?"     | Equipment 목록 + 출처                           |
| E5  | "거푸집 설치 주의사항"      | Note 내용 나열                                  |
| E6  | "관 보온 D100 비용"         | 일위대가 규격 필터링 → D100 결과                |
| E7  | "날씨 알려줘"               | "건설 품셈 관련 질문에만 답변"                  |
| E8  | "" (빈 입력)                | 400 에러                                        |

### 7.3 성능 테스트

| 메트릭        | 목표    | 측정 방법                     |
| ------------- | ------- | ----------------------------- |
| E2E 응답 시간 | < 5초   | Edge Function 내부 latency_ms |
| 임베딩 생성   | < 500ms | API 응답 시간                 |
| DB 검색 합계  | < 500ms | 4개 RPC 호출 합산             |
| LLM 답변      | < 3초   | Gemini Flash 응답 시간        |

---

## 8. 프론트엔드 기술 스택

| 구분            | 선택                    | 이유                           |
| --------------- | ----------------------- | ------------------------------ |
| 구조            | 단일 HTML + CSS + JS    | 정적 파일로 배포 간편          |
| 마크다운        | `marked.js` (CDN)       | AI 답변의 테이블/볼드 렌더링   |
| 코드 하이라이트 | 없음                    | 코드 블록 불필요 (건설 데이터) |
| 호스팅          | 로컬 / Cloudflare Pages | Free tier                      |

---

## 9. 배포 계획

### 9.1 배포 순서

```
Phase A: Edge Function 개발 + 배포  ──── 약 2시간
  [1] index.ts 작성
  [2] Supabase Dashboard에서 GEMINI_API_KEY Secret 설정
  [3] deploy_edge_function MCP 도구로 배포
  [4] curl로 E2E 테스트

Phase B: 프론트엔드 개발  ──────────── 약 1시간
  [5] HTML/CSS/JS 작성
  [6] 로컬 브라우저에서 테스트
  [7] Edge Function URL 연동 확인

Phase C: 통합 검증  ────────────────── 약 30분
  [8] E2E 테스트 시나리오 (E1~E8) 실행
  [9] 성능 측정 (latency_ms 확인)
  [10] 최종 보고서 작성
```

### 9.2 Secret 설정

Edge Function에 필요한 시크릿:

| Secret 이름      | 값            | 설정 경로                                     |
| ---------------- | ------------- | --------------------------------------------- |
| `GEMINI_API_KEY` | Gemini API 키 | Supabase Dashboard > Edge Functions > Secrets |

> `SUPABASE_URL`과 `SUPABASE_SERVICE_ROLE_KEY`는 Edge Function 런타임에서 자동 주입.

### 9.3 CORS 정책

```typescript
const ALLOWED_ORIGINS = new Set([
  'http://localhost:5173',
  'https://your-frontend-domain.pages.dev',
]);

const origin = req.headers.get('origin') ?? '';
const allowOrigin = ALLOWED_ORIGINS.has(origin) ? origin : 'null';

const CORS_HEADERS = {
  'Access-Control-Allow-Origin': allowOrigin,
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-RAG-API-Key',
};

// OPTIONS preflight 처리
if (req.method === 'OPTIONS') {
  return new Response(null, { status: 204, headers: CORS_HEADERS });
}
```

---

## 10. 리스크 및 대응

| 리스크                        | 확률  | 영향  | 대응                                                  |
| ----------------------------- | :---: | :---: | ----------------------------------------------------- |
| Edge Function 타임아웃 (25초) |  중   |  높   | LLM 모델 Flash 사용(~2초), 병렬 RPC 호출              |
| Gemini Free tier RPM 제한     |  중   |  중   | 15 RPM → 동시 사용자 적으므로 충분, 필요 시 유료 전환 |
| 벡터 검색 품질 부족           |  중   |  중   | threshold 0.4로 완화, 불만 시 KURE-v1 교체            |
| 일위대가 매칭 실패            |  중   |  중   | pg_trgm 유사도 검색 추가 (SQL 1줄)                    |
| XSS (HTML 프론트엔드)         |  하   |  중   | AI 답변 sanitize (DOMPurify 필수 + unsafe HTML 차단)              |

---

## 11. 산출물 목록 (예정)

| 파일                                              | 용도                     | 상태 |
| ------------------------------------------------- | ------------------------ | ---- |
| `frontend/index.html`                             | 챗봇 메인 페이지         | ⏳    |
| `frontend/style.css`                              | 스타일시트               | ⏳    |
| `frontend/app.js`                                 | 챗봇 로직                | ⏳    |
| Edge Function: `rag-chat` (index.ts)              | 서버사이드 로직          | ⏳    |
| `sql/step2.8_search_chunks.sql`                   | 청크 검색 함수 (필요 시) | ⏳    |
| `docs/20260211_Step2.8_RAG챗봇서빙_최종보고서.md` | 실행 결과 보고서         | ⏳    |

---

## 12. 검증 체크리스트

### 12.1 기능 검증

- [ ] Edge Function 배포 성공
- [ ] 임베딩 생성 정상 (768차원)
- [ ] 벡터 검색 → 유사 엔티티 반환
- [ ] 그래프 확장 → 관련 자원 반환
- [ ] 일위대가 검색 → 비용 정보 반환
- [ ] 원문 청크 보강 → 품셈 원문 포함
- [ ] LLM 답변 생성 → 마크다운 형식
- [ ] 대화 이력 유지 (5턴)
- [ ] 에러 핸들링 정상
- [ ] CORS 정상 (브라우저 호출)

### 12.2 품질 검증

- [ ] E2E 테스트 8건 통과
- [ ] 응답 시간 < 5초
- [ ] 출처 명시 확인
- [ ] 할루시네이션 없음 (컨텍스트 외 정보 생성 안 함)
- [ ] 비용 답변 시 테이블 형식

---

## 변경 이력

| 날짜       | 버전  | 변경 내용 |
| ---------- | :---: | --------- |
| 2026-02-11 | v1.0  | 초안 작성 |







