# 20260211 codex Step2.6 DB스키마/데이터적재 검토결과

- 검토 대상: `20260211_Step2.6_DB스키마_데이터적재_상세구현계획서.md`
- 검토일: 2026-02-11
- 검토자: codex

## 1. 총평

설계 방향과 테이블 분리는 전반적으로 타당합니다.
다만 실행 실패 또는 데이터 손실을 유발할 수 있는 고위험 항목이 있어, 착수 전에 수정 권장합니다.

## 2. 주요 Findings (심각도 순)

### F1. 관계 dedup 키가 과도하게 단순 (High)

문서 의사코드가 관계 중복을 `(source_id, target_id, relation)`로 제거합니다.

근거:
- `python_code/docs/20260211_Step2.6_DB스키마_데이터적재_상세구현계획서.md:247`

실데이터 점검 결과(`normalized_entities.json` 기준):
- 3키 중복 그룹: 782개
- 이 중 `quantity/unit/per_unit` 값이 다른 그룹: 782개

영향:
- 관계 강도/단위 정보 손실 가능

권고:
- dedup 키를 `(source_id, target_id, relation, quantity, unit, per_unit)`로 확장

### F2. 관계 테이블에 `upsert` 공통 적용 설계 위험 (High)

`batch_upsert()`를 공통 유틸로 제시하지만,
`graph_relationships`, `graph_global_relationships`는 `id SERIAL` 구조라 충돌 기준이 불명확합니다.

근거:
- `python_code/docs/20260211_Step2.6_DB스키마_데이터적재_상세구현계획서.md:404`

영향:
- 의도치 않은 중복/갱신 실패 가능

권고:
- `graph_entities`, `graph_chunks`: upsert
- `graph_relationships`, `graph_global_relationships`: insert(+사전 dedup)

### F3. 키 명세 모호 (`SUPABASE_KEY`)로 권한 실패 가능 (High)

체크리스트에 `SUPABASE_KEY`만 명시되어 있어 anon key 사용 가능성이 있습니다.
RLS 활성화 환경에서 insert는 service role 권한이 필요합니다.

근거:
- `python_code/docs/20260211_Step2.6_DB스키마_데이터적재_상세구현계획서.md:532`

권고:
- 환경변수 명시를 `SUPABASE_SERVICE_ROLE_KEY`로 변경
- 해당 키는 서버 측 실행 전용임을 명시

### F4. `unit_costs` NUMERIC 캐스팅 실패 가능 (Medium)

`(metadata->>'labor_cost')::NUMERIC` 직접 캐스팅은 빈문자/비정상 문자열에서 실패합니다.

근거:
- `python_code/docs/20260211_Step2.6_DB스키마_데이터적재_상세구현계획서.md:355`

권고:
- `NULLIF(metadata->>'labor_cost','')::NUMERIC` 형태로 보강
- 필요시 정규식 필터/CASE로 안전 캐스팅

### F5. 경로 하드코딩으로 이식성 저하 (Medium)

`G:\내 드라이브\...` 절대경로 중심 문서화로 환경 의존도가 높습니다.

근거:
- `python_code/docs/20260211_Step2.6_DB스키마_데이터적재_상세구현계획서.md:48`
- `python_code/docs/20260211_Step2.6_DB스키마_데이터적재_상세구현계획서.md:191`

권고:
- `.env` + 프로젝트 상대경로 방식으로 통일

## 3. 실행 전 수정 체크리스트

1. 관계 dedup 키 확장 (`quantity/unit/per_unit` 포함)
2. 관계 테이블 적재 방식을 upsert → insert로 분리
3. 환경변수 키를 `SUPABASE_SERVICE_ROLE_KEY`로 명시
4. `unit_costs` 캐스팅 SQL에 `NULLIF`/안전 캐스팅 반영
5. 파일 경로를 절대경로에서 환경변수 기반으로 전환

## 4. 최종 판정

- **조건부 승인 (Conditional Go)**
- 위 5개 중 1~3번을 선반영한 뒤 Step 2.6 실행 권장
