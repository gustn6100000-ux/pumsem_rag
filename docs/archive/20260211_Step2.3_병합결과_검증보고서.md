# Step 2.3 병합 결과 검증 보고서

> **작성일**: 2026-02-11  
> **입력**: `table_entities.json` (Step 2.1) + `llm_entities.json` (Step 2.2)  
> **출력**: `merged_entities.json` (22.7 MB)

---

## 1. 작업 요약

Step 2.3은 **4가지 작업**을 수행한다:

| 작업  | 설명                                           | 결과                   |
| :---: | ---------------------------------------------- | ---------------------- |
| **A** | Step 2.1 + 2.2 엔티티/관계 병합 (중복 제거)    | 29,628 → 25,344 엔티티 |
| **B** | BELONGS_TO 관계 자동 생성 (WorkType → Section) | 5,637개 생성           |
| **C** | HAS_CHILD 관계 자동 생성 (Section 계층)        | 1,063개 생성           |
| **D** | REFERENCES 관계 자동 생성 (교차참조)           | 2개 생성               |

---

## 2. 병합 통계

### 2.1 엔티티

| 구분              |   Before   |   After    |      변화       |
| ----------------- | :--------: | :--------: | :-------------: |
| Step 2.1 (테이블) |   8,655    |     —      |        —        |
| Step 2.2 (LLM)    |   20,973   |     —      |        —        |
| **합계**          | **29,628** |     —      |        —        |
| 중복 제거         |     —      |     —      | -4,284 (-14.5%) |
| Section 신규 생성 |     —      |   +2,105   |        —        |
| **병합 후 총계**  |     —      | **25,708** |        —        |

### 2.2 엔티티 유형별

| 유형      |    수량    |   비율   |
| --------- | :--------: | :------: |
| Note      |   6,912    |  26.9%   |
| WorkType  |   5,995    |  23.3%   |
| Labor     |   4,270    |  16.6%   |
| Equipment |   2,706    |  10.5%   |
| Material  |   2,618    |  10.2%   |
| Section   |   2,105    |   8.2%   |
| Standard  |   1,102    |   4.3%   |
| **합계**  | **25,708** | **100%** |

### 2.3 관계 유형별 변화

| 유형               | Step 2.1  |  Step 2.2  |    합계    |  병합 후   |    변화    |
| ------------------ | :-------: | :--------: | :--------: | :--------: | :--------: |
| REQUIRES_LABOR     |    625    |   9,306    |   9,931    |   9,484    |    -447    |
| HAS_NOTE           |   1,942   |   4,832    |   6,774    |   6,768    |     -6     |
| **BELONGS_TO**     |    152    |     0      |    152     | **5,637**  | **+5,485** |
| REQUIRES_EQUIPMENT |    122    |   2,490    |   2,612    |   2,582    |    -30     |
| USES_MATERIAL      |     0     |   2,125    |   2,125    |   2,096    |    -29     |
| APPLIES_STANDARD   |     0     |   1,102    |   1,102    |   1,102    |     0      |
| **HAS_CHILD**      |     0     |     0      |     0      | **1,063**  | **+1,063** |
| **REFERENCES**     |     0     |     0      |     0      |   **2**    |   **+2**   |
| **합계**           | **2,841** | **19,855** | **22,696** | **28,734** | **+6,038** |

---

## 3. 검증 결과

### 3.1 종합 판정: ✅ PASS

|   #    | 검증 항목           |     기준      |           결과           | 판정  |
| :----: | ------------------- | :-----------: | :----------------------: | :---: |
| **M1** | 중복 제거 정확성    |     5~50%     |          14.5%           |   ✅   |
| **M2** | BELONGS_TO 커버리지 |     ≥95%      | **100.0%** (5,995/5,995) |   ✅   |
| **M3** | HAS_CHILD 일관성    | 고아 자식 = 0 |           0건            |   ✅   |
| **M4** | REFERENCES 유효성   |   100% 유효   |         2/2 유효         |   ✅   |
| **M5** | Section 완전성      |     ≥95%      | **100.0%** (2,105/2,105) |   ✅   |
| **M6** | 핵심 관계 손실      |      0건      |           0건            |   ✅   |
| **M7** | 샘플 대조 (3건)     |     정상      |           정상           |   ✅   |

### 3.2 M1. 중복 제거 정확성

- 병합 전: **29,628** 엔티티
- 병합 후: **25,344** 엔티티 (Section 추가 전)
- 중복 제거: **4,284건** (14.5%)
- 적정 범위(5~50%) 내 — 과소/과잉 중복 제거 없음

**병합 우선순위**:
- `name/spec`: LLM 우선 (더 자연스러운 한국어)
- `quantity/unit`: 테이블 우선 (정확한 수치)
- `confidence`: 양쪽 최대값

### 3.3 M2. BELONGS_TO 커버리지

- 전체 WorkType: **5,995개**
- BELONGS_TO 있음: **5,995개 (100.0%)**
- BELONGS_TO 없음: **0개**

> **1차 실행 시 78.8%로 미달** → 원인: `generate_belongs_to`에서 이름 기반 매칭으로 관계를 생성했으나, LLM이 추출한 WorkType 이름과 Section 이름이 정확히 일치하지 않는 경우 누락 발생.  
> **수정**: 조립 단계에서 청크 내 모든 WorkType에 대해 직접 BELONGS_TO를 보장하는 로직으로 보강 → **100.0%** 달성.

### 3.4 M3. HAS_CHILD 계층 일관성

- HAS_CHILD 관계: **1,063개**
- 고유 부모: 103개
- 고유 자식: 1,063개
- 고아 자식: **0건** (모든 자식이 부모를 가짐)

`toc_parsed.json`의 1,284개 섹션에서 계층 관계를 자동 생성.  
예: "6" → "6-1", "6-2", "6-3" (장 → 절), "6-3" → "6-3-1" (절 → 항)

### 3.5 M4. REFERENCES 유효성

- REFERENCES 관계: **2건**
- 유효: 2건, 무효: 0건

교차참조가 적은 이유: chunks.json에서 `cross_references` 필드를 가진 청크가 8개밖에 없음. Phase 1에서 교차참조 추출이 제한적이었기 때문. 향후 보강 가능.

### 3.6 M6. 관계 손실 분석

| 핵심 관계 유형     | 합계  | 병합 후 | 손실  | 원인                     |
| ------------------ | :---: | :-----: | :---: | ------------------------ |
| REQUIRES_LABOR     | 9,931 |  9,484  | -447  | 양쪽 동일 관계 중복 제거 |
| REQUIRES_EQUIPMENT | 2,612 |  2,582  |  -30  | 동일                     |
| USES_MATERIAL      | 2,125 |  2,096  |  -29  | 동일                     |

모든 "손실"은 **정상적인 중복 제거** 결과. 10% 이상 손실된 핵심 관계 유형 없음.

### 3.7 M7. 랜덤 샘플 3건 대조

#### 샘플 1: C-0080 (철골 안전망 설치 및 해체)

| 구분        | 엔티티 |  관계  |
| ----------- | :----: | :----: |
| Step 2.1    |   13   |   0    |
| Step 2.2    |   10   |   9    |
| 합계        |   23   |   9    |
| **병합 후** | **16** | **11** |
| 중복 제거   |   7    |   —    |

- BELONGS_TO: 2개 ✅
- Section 엔티티: 1개 ✅

#### 샘플 2: C-0301-I ([90]해상장비)

| 구분        | 엔티티 | 관계  |
| ----------- | :----: | :---: |
| Step 2.1    |   1    |   0   |
| Step 2.2    |   8    |   7   |
| **병합 후** | **9**  | **7** |

- WorkType 없음 → BELONGS_TO 0개 (정상)
- Section 엔티티: 1개 ✅

#### 샘플 3: C-0153 (패널 설치)

| 구분        | 엔티티 | 관계  |
| ----------- | :----: | :---: |
| Step 2.1    |   6    |   0   |
| Step 2.2    |   6    |   5   |
| 합계        |   12   |   5   |
| **병합 후** | **7**  | **6** |
| 중복 제거   |   5    |   —   |

- BELONGS_TO: 1개 ✅
- Section 엔티티: 1개 ✅

---

## 4. 산출물

| 파일                                          |  크기   | 내용             |
| --------------------------------------------- | :-----: | ---------------- |
| `phase2_output/merged_entities.json`          | 22.7 MB | 병합된 전체 결과 |
| `phase2_output/quality_report_step23.txt`     | 3.5 KB  | 검증 리포트      |
| `phase2_extraction/step3_relation_builder.py` | ~21 KB  | 구현 코드        |
| `phase2_extraction/verify_step3.py`           |  ~7 KB  | 검증 스크립트    |

---

## 5. 수정 이력

| 시점     | 내용                                                 | 영향                                                                                |
| -------- | ---------------------------------------------------- | ----------------------------------------------------------------------------------- |
| 1차 구현 | `merge_chunk_extractions`에서 `llm_ent_map` KeyError | 테이블 간 중복 키 충돌. `merged_ent_map` 통합 관리로 수정                           |
| 1차 검증 | M2 BELONGS_TO 78.8% (미달)                           | `generate_belongs_to` 이름 매칭 한계. 조립 단계에서 직접 보장 로직 추가 → 100% 달성 |

---

## 6. 다음 단계: Step 2.4 (정규화)

Step 2.3 결과물 `merged_entities.json`을 입력으로:

1. **문자열 정규화** — 유니코드, 공백, 단위 통일
2. **규칙 기반 중복 제거** — `(type, normalized_name, spec)` 기준
3. **유사도 후보 탐지** — Jaccard + 편집거리
4. **관계 방향 보정** — 774건 (3.9%) 방향 오류 수정
5. **이상치 필터링** — 수량, confidence 이상치
6. **엔티티 ID 부여** — 글로벌 유니크 키

예상 결과: 25,708 → ~8,000~12,000 엔티티 (정규화 후 대폭 감소)
