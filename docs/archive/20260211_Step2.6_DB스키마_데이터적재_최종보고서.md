# Step 2.6 DB 스키마 + 데이터 적재 최종 보고서

> **작성일**: 2026-02-11 20:11
> **실행 환경**: 로컬 PC (Python 3.13) + Supabase SQL Editor
> **Supabase 프로젝트**: `bfomacoarwtqzjfxszdr` (pumsem)
> **총 소요 시간**: 로더 34초 + DDL/SQL Editor 수작업 포함 총 약 10분

---

## 1. 실행 결과 요약

| 단계    | 대상 테이블                     | 기대 건수 | 실제 건수  | 상태  |
| ------- | ------------------------------- | :-------: | :--------: | :---: |
| Phase 1 | DDL (5개 테이블 + 인덱스 + RLS) |     —     |     —      |   ✅   |
| Phase 2 | `graph_entities`                |  16,364   | **16,364** |   ✅   |
| Phase 3 | `graph_relationships`           |  23,586   | **23,586** |   ✅   |
| Phase 4 | `graph_global_relationships`    |   1,063   | **1,063**  |   ✅   |
| Phase 5 | `graph_chunks`                  |   2,105   | **2,105**  |   ✅   |
| Phase 6 | `ilwi_items`                    |   6,992   | **6,992**  |   ✅   |

**총 적재: 50,110건 | 에러: 0건 | 데이터 손실: 0건**

---

## 2. 실행 방식

### Phase 1: DDL 실행 — Supabase SQL Editor

- `sql/step2.6_create_graph_rag_tables.sql` 실행
- 5개 테이블 생성, 13개 인덱스, 5개 RLS 정책
- `vector`, `pg_trgm` 확장 확인 (`CREATE EXTENSION IF NOT EXISTS`)

### Phase 2~5: Python 로더 — `step6_supabase_loader.py`

```
실행: py -3 phase2_extraction/step6_supabase_loader.py
소요: 34초
```

| Phase               | 방식       | 배치 크기 | 비고                     |
| ------------------- | ---------- | :-------: | ------------------------ |
| Phase 2 (엔티티)    | **upsert** |    500    | TEXT PK                  |
| Phase 3 (관계)      | **insert** |    500    | SERIAL PK, 6-tuple dedup |
| Phase 4 (전역 관계) | **insert** |    500    | SERIAL PK                |
| Phase 5 (청크)      | **upsert** |    200    | TEXT PK, JSONB 대용량    |

### Phase 6: 일위대가 — Supabase SQL Editor

- `sql/step2.6_insert_ilwi_items.sql` 실행
- `unit_costs` (namespace='standard_price_2025') → `ilwi_items` 변환
- `NULLIF` 안전 캐스팅 적용 (F4 반영)
- `labor_types` 컬럼은 metadata 내 scalar/array 혼재로 제외 (필요 시 별도 업데이트)

**Phase 6 검증 증적** (Supabase SQL Editor 실행 결과):

```
-- 검증 쿼리 실행 결과 (2026-02-11 20:11)
tbl                         | cnt
----------------------------+-------
graph_entities              | 16364
graph_relationships         | 23586
graph_global_relationships  | 1063
graph_chunks                | 2105
ilwi_items                  | 6992
```

> Phase 6은 SQL Editor에서 수동 실행했으므로 Python 로더 로그에는 미포함.
> 위 검증 쿼리(`step2.6_verify_counts.sql`)로 6,992건 적재 확인 완료.

---

## 3. Codex 검토 반영 확인

| #   | 지적                             |    반영 상태    |
| --- | -------------------------------- | :-------------: |
| F1  | dedup 키 확장 (6-tuple)          |     ✅ 반영      |
| F2  | 관계 테이블 insert 분리          |     ✅ 반영      |
| F3  | `SUPABASE_SERVICE_ROLE_KEY` 명시 |     ✅ 반영      |
| F4  | NUMERIC `NULLIF` 안전 캐스팅     |     ✅ 반영      |
| F5  | 경로 `.env` + 상대경로           | ✅ 코드에서 반영 |

---

## 4. 엔티티 타입별 분포

| 타입      |    건수    |
| --------- | :--------: |
| Note      |   6,249    |
| WorkType  |   4,531    |
| Equipment |   1,795    |
| Material  |   1,667    |
| Section   |   1,218    |
| Standard  |    569     |
| Labor     |    335     |
| **합계**  | **16,364** |

---

## 5. 관계 타입별 분포

| 타입               |    건수    |           테이블           |
| ------------------ | :--------: | :------------------------: |
| REQUIRES_LABOR     |   7,958    |    graph_relationships     |
| HAS_NOTE           |   6,292    |    graph_relationships     |
| BELONGS_TO         |   4,237    |    graph_relationships     |
| REQUIRES_EQUIPMENT |   2,315    |    graph_relationships     |
| USES_MATERIAL      |   1,877    |    graph_relationships     |
| APPLIES_STANDARD   |    907     |    graph_relationships     |
| HAS_CHILD          |   1,061    | graph_global_relationships |
| REFERENCES         |     2      | graph_global_relationships |
| **합계**           | **24,649** |                            |

---

## 6. FK 무결성

| 검증 항목                    |   결과    |
| ---------------------------- | :-------: |
| 관계 orphaned source_id      | **0건** ✅ |
| 관계 orphaned target_id      | **0건** ✅ |
| 전역 관계 orphaned source_id | **0건** ✅ |
| 전역 관계 orphaned target_id | **0건** ✅ |

---

## 7. 생성된 파일 목록

| 파일                                         | 용도                        |
| -------------------------------------------- | --------------------------- |
| `sql/step2.6_create_graph_rag_tables.sql`    | DDL (테이블 + 인덱스 + RLS) |
| `sql/step2.6_insert_ilwi_items.sql`          | 일위대가 적재 SQL           |
| `sql/step2.6_verify_counts.sql`              | 검증 쿼리 모음              |
| `phase2_extraction/step6_supabase_loader.py` | Python 데이터 로더          |
| `phase2_output/logs/step6_loader_*.log`      | 실행 로그                   |
| `phase2_output/logs/step6_summary_*.json`    | 결과 요약 JSON              |

---

## 8. 임베딩 상태

- `graph_entities.embedding`: 전부 **NULL** (16,364건) — Step 2.7에서 채움
- `graph_chunks.embedding`: 전부 **NULL** (2,105건) — Step 2.7에서 채움

---

## 9. 다음 단계

**Step 2.7: 임베딩 생성 + SQL 검색 함수**

1. `graph_entities`의 16,364건에 대해 `gemini-embedding-001`로 768차원 벡터 생성
2. `graph_chunks`의 2,105건에 대해 동일 임베딩 생성
3. SQL 검색 함수 3개 배포:
   - `search_entities_by_embedding` (벡터 유사도 검색)
   - `get_related_resources` (그래프 확장)
   - `search_ilwi` (일위대가 키워드 검색)
