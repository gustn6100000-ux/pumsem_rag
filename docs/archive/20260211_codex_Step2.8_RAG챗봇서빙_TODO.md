# 20260211 codex Step2.8 RAG챗봇서빙 TODO

## 1. 보안 (MUST)
- [ ] Edge Function API Key(`X-RAG-API-Key`) 검증 구현
- [ ] `X-RAG-API-Key` 검증 로직 적용 (서명/HMAC 제거)
- [ ] 허용 Origin allowlist 적용 (`*` 금지)
- [ ] 서버측 Rate Limiting 적용 (IP/토큰 기준)
- [ ] 민감정보 마스킹 로그 정책 적용

## 2. 검색/데이터 정합성 (MUST)
- [ ] `source_section -> graph_chunks.section_id` 조인 로직 구현
- [ ] `sources.section` 생성 로직 구현(추가 조회 포함)
- [ ] RPC 실패 시 에러 코드 표준화 (`db_error`, `embedding_failed`, `llm_failed`)
- [ ] 입력 정책 고정: 500자 초과는 500자로 truncate

## 3. Edge Function 구현
- [ ] `rag-chat/index.ts` 기본 핸들러 생성
- [ ] 임베딩 생성 함수(`gemini-embedding-001`) 구현
- [ ] 벡터 검색 RPC(`search_entities_by_embedding`) 연동
- [ ] 그래프 확장 RPC(`get_related_resources`, `get_entity_hierarchy`) 연동
- [ ] 비용의도 감지 + `search_ilwi` 연동
- [ ] 컨텍스트 조합기(buildContext) 구현
- [ ] LLM 응답 생성(`gemini-2.0-flash`) 구현

## 4. 프론트엔드 구현
- [ ] `frontend/index.html` 채팅 UI 작성
- [ ] `frontend/style.css` 반응형 스타일 작성
- [ ] `frontend/app.js` API 호출/히스토리/에러처리 구현
- [ ] Markdown 렌더 + DOMPurify sanitize 적용

## 5. 테스트
- [ ] 단위 테스트 T1~T6 통과
- [ ] E2E 테스트 E1~E8 통과
- [ ] 성능 목표 확인(평균 < 5s, P95 < 8s)
- [ ] 보안 스모크 테스트(CORS, API Key, rate limit) 통과

## 6. 배포/운영
- [ ] GEMINI_API_KEY 시크릿 설정
- [ ] RAG_API_KEY 시크릿 설정
- [ ] Edge Function 배포 및 smoke test 실행
- [ ] 배포 후 canary 질의 3건 검증
- [ ] 최종보고서 작성 (`20260211_codex_Step2.8_RAG챗봇서빙_최종보고서.md`)

