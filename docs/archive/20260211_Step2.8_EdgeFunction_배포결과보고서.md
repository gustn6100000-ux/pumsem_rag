# Step 2.8 RAG 챗봇 Edge Function 배포 결과 보고서

> **작성일**: 2026-02-11  
> **프로젝트**: bfomacoarwtqzjfxszdr  
> **Edge Function**: `rag-chat` (v6 — 프로덕션)  
> **상태**: ✅ 배포 완료, 전체 파이프라인 정상 동작 (v6: Note 내용 보강 + Section→WorkType 2-hop 확장)

---

## 1. 작업 개요

Step 2.8 RAG 챗봇의 Supabase Edge Function(`rag-chat`)을 배포하고, E2E 테스트를 통해 검색·답변 파이프라인의 정상 동작을 검증하였다.

### 배포된 컴포넌트

| 컴포넌트          | 경로                                                      | 설명                                                                             |
| ----------------- | --------------------------------------------------------- | -------------------------------------------------------------------------------- |
| **Edge Function** | `supabase/functions/rag-chat/index.ts`                    | 7단계 RAG 파이프라인 (인증→입력검증→임베딩→벡터검색→그래프확장→일위대가→LLM답변) |
| **프론트엔드**    | `frontend/index.html`, `style.css`, `app.js`              | 다크 모드 챗봇 UI (marked.js + DOMPurify)                                        |
| **IDE 타입**      | `supabase/functions/rag-chat/types.d.ts`, `tsconfig.json` | VS Code IDE 경고 해소용 (런타임 무영향)                                          |

---

## 2. 버그 수정 — 벡터 검색 0건 문제

### 2.1 증상

Edge Function 배포 후 실제 질문("콘크리트 타설 비용 알려줘")을 보내면 HTTP 200으로 응답하지만, `search_info.entities_found: 0`으로 벡터 검색 결과가 없음.

```json
{
  "search_info": {
    "entities_found": 0,
    "relations_expanded": 0,
    "ilwi_matched": 0,
    "chunks_retrieved": 0,
    "latency_ms": 2789
  }
}
```

### 2.2 진단 과정

| 단계 | 조치                                              | 결과                                                                   |
| ---- | ------------------------------------------------- | ---------------------------------------------------------------------- |
| 1    | Edge Function에 디버그 로그 추가 후 v2 배포       | Supabase 로그에서 console.log 출력 미확인 (로그 서비스 제약)           |
| 2    | `search_entities_by_embedding` RPC 함수 소스 확인 | `query_embedding_text::vector(768)` 캐스팅 로직 및 EXCEPTION 블록 확인 |
| 3    | DB 저장 벡터 차원 확인 (`vector_dims()`)          | **768차원** 확인                                                       |
| 4    | `gemini-embedding-001` 기본 출력 차원 웹 검색     | **기본 3072차원** (MRL 지원, 768/1536/3072 선택 가능)                  |

### 2.3 근본 원인 (Root Cause)

```
┌─────────────────────────────────────────────────────────────────┐
│  gemini-embedding-001 기본 출력: 3072차원                        │
│  DB graph_entities.embedding: vector(768)                       │
│                                                                 │
│  Edge Function에서 outputDimensionality 미지정                   │
│  → 3072차원 벡터 생성                                            │
│  → search_entities_by_embedding 내부에서                         │
│     query_embedding_text::vector(768) 캐스팅 실패                │
│  → EXCEPTION WHEN OTHERS → RAISE NOTICE (에러 삼킴)             │
│  → 빈 결과 RETURN                                               │
│                                                                 │
│  Supabase RPC는 에러 없이 빈 배열 반환                           │
│  → Edge Function은 정상 응답(200)으로 처리                       │
│  → entities_found: 0                                            │
└─────────────────────────────────────────────────────────────────┘
```

**핵심**: Step 2.7(임베딩 생성 파이프라인)에서 `output_dimensionality=768`로 벡터를 생성했으나, Step 2.8 Edge Function에서 동일 파라미터를 누락함.

### 2.4 수정 사항

**파일**: `supabase/functions/rag-chat/index.ts` — `generateEmbedding()` 함수

```typescript
// 수정 전 (v1)
body: JSON.stringify({
    model: "models/gemini-embedding-001",
    content: { parts: [{ text }] },
    // ← outputDimensionality 누락 → 기본 3072차원 출력
}),

// 수정 후 (v3~v4)
const embeddingBody = {
    model: "models/gemini-embedding-001",
    content: { parts: [{ text }] },
    outputDimensionality: 768,  // ← DB 저장 차원과 일치 필수
};
```

### 2.5 파급 효과 (A3 확인)

| 영역             | 영향                              | 판정 |
| ---------------- | --------------------------------- | ---- |
| DB 스키마        | 변경 없음                         | ✅    |
| RPC 함수         | 변경 없음                         | ✅    |
| 프론트엔드       | 변경 없음                         | ✅    |
| 기존 벡터 데이터 | 768차원으로 저장됨 → 호환 유지    | ✅    |
| 검색 품질        | 동일 모델·동일 차원 → 유사도 정상 | ✅    |

---

## 3. 배포 이력

| 버전   | 시각      | 변경 사항                                            | 결과                          |
| ------ | --------- | ---------------------------------------------------- | ----------------------------- |
| v1     | 22:00     | 최초 배포                                            | ❌ 검색 0건                    |
| v2     | 22:10     | 디버그 로그 추가                                     | ❌ 검색 0건 (차원 불일치 발견) |
| v3     | 22:27     | `outputDimensionality: 768` 추가                     | ✅ 검색 정상                   |
| v4     | 22:33     | 디버그 로그 제거, 프로덕션 정리                      | ✅ 안정 배포                   |
| v5     | 22:56     | HAS_NOTE 관계의 실제 내용(content) 보강              | ✅ 주의사항 ID→실제 내용 표시  |
| **v6** | **23:03** | **Section→WorkType 2-hop 확장, 인력/장비/자재 보강** | **✅ 최종 프로덕션 배포**      |

---

## 4. E2E 테스트 결과

### 4.1 입력 검증 테스트

| 시나리오    | 입력               | HTTP    | 응답                             | 판정   |
| ----------- | ------------------ | ------- | -------------------------------- | ------ |
| E8: 빈 질문 | `{"question": ""}` | **400** | `{"error": "question_required"}` | ✅ PASS |

### 4.2 RAG 파이프라인 테스트

| 질문                     | entities | relations | ilwi   | chunks | latency | 판정 |
| ------------------------ | -------- | --------- | ------ | ------ | ------- | ---- |
| 콘크리트 타설 인력       | **5**    | 25        | 0      | 3      | 4,896ms | ✅    |
| 콘크리트 타설 비용 얼마  | 5        | 28        | **20** | 3      | 6,693ms | ✅    |
| 철근 가공 조립 인력 기준 | 5        | **103**   | 0      | 3      | 2,721ms | ✅    |
| PE관 접합 작업 인력      | 5        | 20        | 0      | 3      | 3,991ms | ✅    |

### 4.3 파이프라인 단계별 검증

| 단계              | 기능                                             | 검증 결과                   |
| ----------------- | ------------------------------------------------ | --------------------------- |
| [B] 임베딩 생성   | Gemini API → 768차원 벡터                        | ✅ 정상                      |
| [C-1] 벡터 검색   | `search_entities_by_embedding` RPC               | ✅ 5건 반환, similarity 0.8+ |
| [C-2] 그래프 확장 | `get_related_resources` + `get_entity_hierarchy` | ✅ 20~103건 관계 확장        |
| [C-3] 일위대가    | `search_ilwi` RPC (비용 의도 감지 시)            | ✅ 20건 매칭                 |
| [C-4] 원문 청크   | `graph_chunks` 테이블 조회                       | ✅ 3건 반환                  |
| [D] 컨텍스트 조합 | 품셈 + 일위대가 + 원문 마크다운 조합             | ✅                           |
| [F] LLM 답변      | Gemini 2.0 Flash → 마크다운 응답                 | ✅                           |

---

## 5. 보안 체크리스트 (Codex F1)

| 항목       | 구현 사항                                     | 상태          |
| ---------- | --------------------------------------------- | ------------- |
| CORS       | allowlist 4개 origin만 허용, `*` 금지         | ✅             |
| API Key    | `RAG_API_KEY` 환경변수, `x-api-key` 헤더 검증 | ✅             |
| Rate Limit | IP 기반 분당 10회                             | ✅             |
| Body 제한  | 10KB 초과 시 413                              | ✅             |
| 입력 절삭  | 500자 초과 시 자동 truncate                   | ✅             |
| JWT        | `verify_jwt: false` (자체 API Key 방식 채택)  | ⚠️ 의도된 설정 |

---

## 6. 프론트엔드 현황

| 파일                  | 크기  | 설명                                              |
| --------------------- | ----- | ------------------------------------------------- |
| `frontend/index.html` | 131줄 | 챗봇 레이아웃, marked.js + DOMPurify CDN          |
| `frontend/style.css`  | 243줄 | 다크 모드, glassmorphism, 타이핑 애니메이션       |
| `frontend/app.js`     | 212줄 | API 통신, 대화 이력 5턴, 에러 핸들링, 디버그 패널 |

> 프론트엔드는 아직 **로컬 테스트 / Cloudflare Pages 배포 미완료** 상태.

---

## 7. 잔여 작업 (Next Steps)

| 우선순위 | 작업                                        | 상태      |
| -------- | ------------------------------------------- | --------- |
| P1       | 프론트엔드 로컬 테스트 (Live Server)        | ✅ 완료    |
| P1       | 프론트엔드 `CONFIG.API_URL` 확인 및 설정    | ✅ 완료    |
| P1       | Note ID → 실제 내용 표시 버그 수정          | ✅ v5 완료 |
| P1       | Section→WorkType 인력/장비/자재 미표시 수정 | ✅ v6 완료 |
| P2       | Cloudflare Pages 배포                       | ⬜ TODO    |
| P2       | 비건설 질문 테스트 (도메인 외 거부 확인)    | ⬜ TODO    |
| P3       | Rate Limit 테스트 (11회 연속 호출 → 429)    | ⬜ TODO    |
| P3       | 대화 이력 연속 질문 테스트                  | ⬜ TODO    |
| P3       | 성능 최적화 (latency 3~7s → 목표 3s 이하)   | ⬜ TODO    |

---

## 8. 기술 참고

### Gemini Embedding API 차원 설정

```
gemini-embedding-001 기본값: 3072차원
MRL(Matryoshka Representation Learning) 지원
  → outputDimensionality: 768 | 1536 | 3072

본 프로젝트 설정: 768차원
  - Step 2.7 파이프라인: output_dimensionality=768
  - Step 2.8 Edge Function: outputDimensionality=768
  - DB 스키마: vector(768)
```

### Edge Function 엔드포인트

```
POST https://bfomacoarwtqzjfxszdr.supabase.co/functions/v1/rag-chat

Headers:
  Content-Type: application/json
  x-api-key: <RAG_API_KEY>  (설정된 경우)

Body:
{
  "question": "콘크리트 타설 인력",
  "history": []  // optional, max 5턴
}

Response:
{
  "answer": "...",
  "sources": [...],
  "search_info": { entities_found, relations_expanded, ilwi_matched, chunks_retrieved, latency_ms }
}
```
