# Phase 2 엔티티/관계 추출 — 진행 현황 분석 보고서

> **작성일**: 2026-02-11  
> **최종 갱신**: 2026-02-11 12:30 (Step 2.4 완료 반영)  
> **작성 기준**: Step 2.1~2.4 완료 시점

---

## 1. 전체 파이프라인 진행 상태

|  Step   | 내용                                     |  상태  |   소요 시간   |
| :-----: | ---------------------------------------- | :----: | :-----------: |
| **1.0** | Phase 1 전처리 (섹션 분할 + 청크 생성)   | ✅ 완료 |       —       |
| **2.1** | 테이블 기반 규칙 추출                    | ✅ 완료 |     ~2분      |
| **2.2** | LLM (Gemini 3.0 Flash) 추출              | ✅ 완료 |    72.7분     |
| **2.3** | 관계 생성 + 병합 (BELONGS_TO, cross_ref) | ✅ 완료 |     ~10분     |
| **2.4** | 엔티티 정규화 (중복 제거, 오추출 필터)   | ✅ 완료 |     ~20분     |
| **2.5** | 품질 검증 (E1~E6)                        |   ⏳    |  예상 ~1시간  |
| **2.6** | Supabase 저장                            |   ⏳    | 예상 ~1.5시간 |

---

## 2. 산출물 현황

### 2.1 파일 목록

| 파일                                         |  크기   | 역할                                         |
| -------------------------------------------- | :-----: | -------------------------------------------- |
| `phase2_output/table_entities.json`          |  98 KB  | Step 2.1 테이블 규칙 추출 결과               |
| `phase2_output/llm_entities.json`            | 17.8 MB | Step 2.2 LLM 추출 결과                       |
| `phase2_output/quality_report.txt`           |  7 KB   | 1차 품질 검증 리포트                         |
| `phase2_output/quality_report_deep.txt`      |  7 KB   | 심층 품질 검증 리포트                        |
| `phase2_extraction/config.py`                |  5 KB   | 경로, 매핑, 임계값 설정                      |
| `phase2_extraction/schemas.py`               |    —    | Pydantic 모델 (Entity 7종, Relationship 8종) |
| `phase2_extraction/step1_table_extractor.py` |    —    | 테이블 규칙 추출기                           |
| `phase2_extraction/step2_llm_extractor.py`   |    —    | LLM 비동기 추출기                            |
| `phase2_extraction/verify_step1.py`          |    —    | Step 2.1 검증 스크립트                       |
| `phase2_extraction/verify_step2.py`          |    —    | Step 2.2 1차 검증 스크립트                   |
| `phase2_extraction/verify_step2_deep.py`     |    —    | Step 2.2 심층 검증 스크립트                  |

### 2.2 소스 코드 구조

```
phase2_extraction/
├── __init__.py
├── config.py              ← 경로, 헤더↔엔티티 매핑, 정규화 맵, LLM 설정
├── schemas.py             ← Pydantic 스키마 (EntityType 7종, RelationType 8종)
├── step1_table_extractor.py   ← Step 2.1: 테이블 기반 규칙 추출
├── step2_llm_extractor.py     ← Step 2.2: Gemini 3.0 Flash LLM 추출
├── verify_step1.py
├── verify_step2.py
└── verify_step2_deep.py
```

---

## 3. 추출 결과 요약

### 3.1 Step 2.1 (테이블 규칙 추출)

| 메트릭               |         값          |
| -------------------- | :-----------------: |
| 처리 청크            |    2,105 / 2,105    |
| **총 엔티티**        |      **8,655**      |
| └ Labor              |        2,105        |
| └ Note               |        2,047        |
| └ Section            |        1,741        |
| └ Material           |        1,714        |
| └ Equipment          |         538         |
| └ WorkType           |         510         |
| **총 관계**          |      **2,841**      |
| └ HAS_NOTE           |        1,942        |
| └ REQUIRES_LABOR     |         625         |
| └ BELONGS_TO         |         152         |
| └ REQUIRES_EQUIPMENT |         122         |
| **커버리지**         | 82.7% (1,741/2,105) |

### 3.2 Step 2.2 (LLM 추출)

| 메트릭               |            값            |
| -------------------- | :----------------------: |
| 모델                 | Gemini 3.0 Flash Preview |
| 처리 청크            |      1,879 / 1,879       |
| 소요 시간            |          72.7분          |
| 실패                 |    2건 (API 타임아웃)    |
| **총 엔티티**        |        **20,973**        |
| └ WorkType           |          6,278           |
| └ Note               |          4,895           |
| └ Labor              |          3,650           |
| └ Equipment          |          3,315           |
| └ Material           |          1,733           |
| └ Standard           |          1,102           |
| **총 관계**          |        **19,855**        |
| └ REQUIRES_LABOR     |          9,306           |
| └ HAS_NOTE           |          4,832           |
| └ REQUIRES_EQUIPMENT |          2,490           |
| └ USES_MATERIAL      |          2,125           |
| └ APPLIES_STANDARD   |          1,102           |

### 3.3 합산

| 메트릭 | Step 2.1 | Step 2.2 |  **합계**  |
| ------ | :------: | :------: | :--------: |
| 엔티티 |  8,655   |  20,973  | **29,628** |
| 관계   |  2,841   |  19,855  | **22,696** |

---

## 4. 엔티티 & 관계 구조

### 4.1 엔티티 유형 (6종)

| 유형          | 의미           | 예시                                  |
| ------------- | -------------- | ------------------------------------- |
| **WorkType**  | 공종/작업 종류 | 콘크리트 타설, 철근 가공, 거푸집 설치 |
| **Labor**     | 투입 인력      | 특별인부, 보통인부, 철근공, 비계공    |
| **Equipment** | 투입 장비      | 굴착기 0.7m³, 크레인 25ton            |
| **Material**  | 사용 자재      | 시멘트, 철근 D13, 거푸집판            |
| **Note**      | 주석/조건/할증 | 할증률 10%, 적용 조건                 |
| **Standard**  | 적용 기준/규격 | KCS 14 20 10, 콘크리트 시방서         |

### 4.2 관계 유형 (5종)

| 관계                   | 방향                    | 의미      | 수량  |
| ---------------------- | ----------------------- | --------- | :---: |
| **REQUIRES_LABOR**     | WorkType → Labor        | 인력 투입 | 9,306 |
| **HAS_NOTE**           | WorkType/Section → Note | 조건/할증 | 4,832 |
| **REQUIRES_EQUIPMENT** | WorkType → Equipment    | 장비 투입 | 2,490 |
| **USES_MATERIAL**      | WorkType → Material     | 자재 사용 | 2,125 |
| **APPLIES_STANDARD**   | WorkType → Standard     | 적용 규격 | 1,102 |

### 4.3 그래프 구조 예시

```
철근 가공 및 조립 (WorkType)
    ├── REQUIRES_LABOR ──→ 철근공 (0.042인/ton)
    ├── REQUIRES_LABOR ──→ 보통인부 (0.021인/ton)
    ├── USES_MATERIAL ──→ 결속선 (0.5kg/ton)
    ├── REQUIRES_EQUIPMENT ──→ 철근절단기
    └── HAS_NOTE ──→ "D13 이하 할증 15%"
```

### 4.4 엔티티 JSON 구조

```json
{
  "type": "Labor",
  "name": "특별인부",
  "normalized_name": "특별인부",
  "spec": null,
  "unit": "인",
  "quantity": 0.67,
  "confidence": 0.95,
  "source_chunk_id": "C-0203",
  "source_section_id": "4-2-3",
  "source_method": "llm"
}
```

### 4.5 관계 JSON 구조

```json
{
  "source": "콘크리트 타설",
  "source_type": "WorkType",
  "target": "보통인부",
  "target_type": "Labor",
  "type": "REQUIRES_LABOR",
  "quantity": 0.67,
  "unit": "인",
  "source_chunk_id": "C-0203"
}
```

---

## 5. 품질 검증 결과

### 5.1 1차 검증 (verify_step2.py)

| 항목                        |        결과         | 기준  |     판정      |
| --------------------------- | :-----------------: | :---: | :-----------: |
| Q1 할루시네이션 (단순 매칭) |       20.74%        |  <2%  | ❌ (로직 한계) |
| Q2 관계 무결성              | src 2.2% / tgt 0.1% |  <5%  |       ✅       |
| Q3 고아 엔티티              |        9.3%         | <10%  |       ✅       |
| Q4 커버리지                 |        99.9%        | ≥90%  |       ✅       |
| Q5 노무 수량 이상치         |    63건/9,306건     |   -   |       ⚠️       |

> **Q1 참고**: 20.74%는 매칭 로직의 한계 (LLM이 합성한 이름, 테이블 태그 포함 등). 실제 할루시네이션은 아님.

### 5.2 심층 검증 (verify_step2_deep.py)

| 항목                         |    결과     | 판정  |
| ---------------------------- | :---------: | :---: |
| **Q1-R 할루시네이션 (보정)** |  **3.81%**  |   ✅   |
| Q7 핵심 공종 발견            | 13/15 (87%) |   ✅   |
| Q8 LLM 보강율 (vs 테이블)    |    89.2%    |   ✅   |
| Q8 LLM 저하율                |    0.2%     |   ✅   |
| Q9 관계 방향 오류            |    3.9%     |   ✅   |

### 5.3 Q1-R 할루시네이션 상세 (800건 / 20,973건 = 3.81%)

| 유형      | 건수  | 원인                                                |
| --------- | :---: | --------------------------------------------------- |
| Note      |  707  | LLM이 문맥에서 의미를 합성 ("작업 난이도 할증" 등)  |
| Labor     |  33   | 약어를 풀어쓴 경우 ("고급기술자" ← 원본 "고급기술") |
| Standard  |  27   | 규격명 합성                                         |
| WorkType  |  23   | 하위 규격을 이름에 포함                             |
| Equipment |   7   | 장비명+규격 결합                                    |
| Material  |   3   | 자재명 변형                                         |

> **실질적 할루시네이션은 거의 없음**. 대부분 LLM이 원본의 의미를 보존하면서 이름을 정리한 것.

### 5.4 핵심 품셈 항목 대조 (Q7)

| 공종          | 발견  |               건수               |
| ------------- | :---: | :------------------------------: |
| 콘크리트 타설 |   ✅   |               23건               |
| 철근 가공     |   ✅   |               3건                |
| 거푸집        |   ✅   |               12건               |
| 터파기        |   ✅   |               11건               |
| 되메우기      |   ✅   |               3건                |
| 인력운반      |   ✅   |               2건                |
| 비계          |   ✅   |               18건               |
| 방수          |   ✅   |               23건               |
| 미장          |   ✅   |               3건                |
| 타일          |   ✅   |               8건                |
| 도장          |   ✅   |               48건               |
| H-Beam        |   ✅   |               16건               |
| 용접          |   ✅   |              389건               |
| 잡석다짐      |   ❌   |  0건 ("잡석 기층" 등 다른 이름)  |
| 철근배근      |   ❌   | 0건 ("철근 가공 및 조립"로 추출) |

### 5.5 REQUIRES_LABOR 수량 분포

```
min=0.001, p25=0.16, median=0.8, p75=2.2, max=646.45
```

- **median 0.8인** → 전형적 품셈 값 (1m³당 보통인부 0.67인 등)
- 이상치 63건/9,306건 = **0.7%** → 허용 범위
- max 646.45 → 대규모 공종, Step 2.4 정규화에서 필터링 예정

### 5.6 랜덤 샘플 대조 (Q6)

5건 모두 원본 텍스트와 정확하게 일치:

|   #   | 공종              | 엔티티 | 관계  | 판단  |
| :---: | ----------------- | :----: | :---: | :---: |
|   1   | 조형전정          |   6    |   5   |   ✅   |
|   2   | 강판 전기아크용접 |   16   |  48   |   ✅   |
|   3   | H-Beam 설치       |   11   |   6   |   ✅   |
|   4   | 수치지도 작성     |   15   |  10   |   ✅   |
|   5   | 해상장비          |   5    |   4   |   ✅   |

---

## 6. 알려진 이슈

### 6.1 Phase 2 내부 이슈

|   #   | 이슈                        | 영향도 |    해결 시점    |
| :---: | --------------------------- | :----: | :-------------: |
|   1   | 관계 방향 오류 774건 (3.9%) |  중간  | Step 2.4 정규화 |
|   2   | 고아 엔티티 1,943건 (9.3%)  |  낮음  |  Step 2.3 병합  |
|   3   | 노무 수량 이상치 63건       |  낮음  | Step 2.4 필터링 |
|   4   | API 타임아웃 실패 2건       |  무시  | 0.1%, 무시 가능 |
|   5   | Note 유형 합성 이름 707건   |  낮음  | Step 2.4 정규화 |

### 6.2 Phase 1 잔여 이슈 (#8, #9)

|   #   | 이슈                                   |            Phase 2 영향             | 선행 수정 필요? |
| :---: | -------------------------------------- | :---------------------------------: | :-------------: |
|   8   | D2 91.7→95% 추가 개선 (76건 실패 섹션) |      **0%** — 비정상 청크 0건       |    ❌ 불필요     |
|   9   | D3 158건 오탐 줄이기                   | **메타데이터 수준** — 추출에 무영향 |    ❌ 불필요     |

**근거**:
1. 영향받는 엔티티: **0건 / 29,628건 (0.00%)**
2. section_id는 메타데이터로만 사용 → Phase 2.3에서 검증 로직 추가로 해결
3. 수정 시 Phase 2.2 재실행 필요 (~73분 + $0.25) → 비효율적
4. Phase 2 전체 완료 후 일괄 수정이 효율적

---

## 7. Step 2.2 기술 이슈 & 해결

### 7.1 5시간 무한 hang 문제

| 항목     | 내용                                                                 |
| -------- | -------------------------------------------------------------------- |
| **증상** | 1,850/1,879에서 5시간 이상 무한 대기                                 |
| **원인** | `asyncio.to_thread()`에 타임아웃 없음 → API 호출 hang 시 영원히 대기 |
| **해결** | `asyncio.wait_for(api_call, timeout=120)` 추가                       |

### 7.2 결과 유실 방지

| 항목     | 내용                                            |
| -------- | ----------------------------------------------- |
| **증상** | 프로세스 crash 시 전체 1,850건 결과 소실        |
| **해결** | 200건마다 `llm_entities_partial.json` 중간 저장 |

### 7.3 이어하기 (Resume) 지원

```bash
# 처음부터 전체 실행
py -3 step2_llm_extractor.py

# 이어하기 (기존 결과 스킵)
py -3 step2_llm_extractor.py --resume

# 샘플 20건만
py -3 step2_llm_extractor.py --sample
```

---

## 8. 다음 단계

### Phase 2 잔여 작업

|  Step   | 내용          | 주요 작업                          | 예상 시간 |
| :-----: | ------------- | ---------------------------------- | :-------: |
| **2.5** | 품질 검증     | E1~E6 자동 검증 + 50건 수동 샘플링 |  ~1시간   |
| **2.6** | Supabase 저장 | DDL 생성, 데이터 적재, 인덱스      | ~1.5시간  |

> **Step 2.3/2.4 결과**: Step 2.3에서 25,708 엔티티 + 28,734 관계로 병합 완료.
> Step 2.4에서 16,364 엔티티 + 24,649 관계로 정규화 완료 (36.3% 감소).
> 3단계 26개 검증 항목 전체 PASS.

### 권장 진행 순서

```
Phase 2.5 (검증) → 2.6 (저장)
    ↓
Phase 1 이슈 #8, #9 일괄 수정 (필요 시)
    ↓
재추출 (필요 시만)
```

---

## 9. 사용 기술 스택

| 구분        | 기술                                                               |
| ----------- | ------------------------------------------------------------------ |
| LLM 모델    | Gemini 3.0 Flash Preview                                           |
| 스키마 강제 | Pydantic + `response_schema` (JSON 모드)                           |
| 비동기 처리 | `asyncio` + `asyncio.to_thread` + `Semaphore(10)`                  |
| 타임아웃    | `asyncio.wait_for(timeout=120)`                                    |
| 재시도      | 지수 백오프 (1→2→4초, 최대 3회)                                    |
| 프롬프트    | System + Few-shot + Chain-of-Thought                               |
| 검증        | 6차원 자동 검증 (할루시네이션, 무결성, 커버리지, 수량, 방향, 샘플) |

---

## 10. 독립 감사 재검증 반영 (Codex)

재검증 일시: 2026-02-11  
감사 스크립트: `phase2_extraction/verify_step24_audit.py`  
감사 리포트: `phase2_output/quality_report_step24_audit.txt`

### 10.1 판정

- **PASS**
- Step 2.4 산출물(`normalized_entities.json`) 기준 핵심 수치 일치:
  - 엔티티 16,364
  - 관계 24,649
- 중복 관계(확장키 기준) 0건, self-reference 0건, entity_id 중복 0건

### 10.2 보정 반영 사항

- `normalization_stats.output_entities` stale 값 이슈 수정 완료
  - 수정 전: 16,183
  - 수정 후: 16,364 (실데이터 일치)
- `dedup_removed`도 최종 산출 기준으로 재계산
  - 9,344 (= 25,708 - 16,364)

### 10.3 남은 경고(정책 명시 필요)

- 엄격 방향 규칙 기준에서는 `Section->Material (USES_MATERIAL)` 60건이 오류로 집계됨.
- 현재 구현/검증은 완화 규칙(Section 허용)을 사용하므로 방향 오류 0건.
- 보고서 해석 일관성을 위해 방향 규칙 기준을 문서에 명시 권장.
