# Step 2.8 RAG ì±—ë´‡ ì„œë¹™ â€” ìƒì„¸ êµ¬í˜„ ê³„íšì„œ

> **ë¬¸ì„œ ë²„ì „**: v1.1 (Codex ê²€í†  ë°˜ì˜)  
> **ì‘ì„±ì¼**: 2026-02-11  
> **ì „ì œ**: Step 2.7 (ì„ë² ë”© ìƒì„± + SQL ê²€ìƒ‰ í•¨ìˆ˜) ì™„ë£Œ  
> **ì„¤ê³„ ê·¼ê±°**: `20260211_Step2.6ì´í›„_ì „ë©´ì¬ê²€í† _ì„¤ê³„ë³´ê³ ì„œ.md` Â§4 Step 2.8  
> **Codex ê²€í† **: `20260211_codex_Step2.8_RAGì±—ë´‡ì„œë¹™_ê²€í† ì²´í¬ë¦¬ìŠ¤íŠ¸.md` 6ê±´ ë°˜ì˜

---

## 0. í˜„ì¬ ì¸í”„ë¼ ìƒíƒœ (Step 2.7 ì™„ë£Œ ê¸°ì¤€)

### 0.1 Supabase ë°ì´í„°

| í…Œì´ë¸”                       |  ê±´ìˆ˜  | ì„ë² ë”© | ë¹„ê³                               |
| ---------------------------- | :----: | :----: | --------------------------------- |
| `graph_entities`             | 16,364 | âœ… 768d | WorkType, Labor, Equipment ë“± 7ì¢… |
| `graph_relationships`        | 23,586 |   â€”    | 6ì¢… ê´€ê³„ (REQUIRES_LABOR ë“±)      |
| `graph_global_relationships` | 1,063  |   â€”    | HAS_CHILD(1,061), REFERENCES(2)   |
| `graph_chunks`               | 2,105  | âœ… 768d | ì›ë¬¸ ì²­í¬ (RAG ì°¸ê³ ìš©)            |
| `ilwi_items`                 | 6,992  |   â€”    | êµ¬ì¡° ê²€ìƒ‰ ì „ìš© (ì„ë² ë”© ì•ˆ í•¨)     |

### 0.2 ë°°í¬ëœ SQL í•¨ìˆ˜

| í•¨ìˆ˜                           | ì‹œê·¸ë‹ˆì²˜                                                                   | ìš©ë„              |
| ------------------------------ | -------------------------------------------------------------------------- | ----------------- |
| `search_entities_by_embedding` | `(text, int=5, float=0.5) â†’ TABLE(id, name, type, properties, similarity)` | ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰  |
| `get_related_resources`        | `(text) â†’ TABLE(direction, relation, related_id, related_name, ...)`       | 1-hop ê·¸ë˜í”„ í™•ì¥ |
| `get_entity_hierarchy`         | `(text) â†’ TABLE(direction, relation, related_id, related_name, ...)`       | ì „ì—­ ê´€ê³„ íƒìƒ‰    |
| `search_ilwi`                  | `(text, text=NULL) â†’ TABLE(id, name, spec, labor_cost, ...)`               | ì¼ìœ„ëŒ€ê°€ ê²€ìƒ‰     |

### 0.3 Supabase í”„ë¡œì íŠ¸ ì •ë³´

| í•­ëª©       | ê°’                                         |
| ---------- | ------------------------------------------ |
| Project ID | `bfomacoarwtqzjfxszdr`                     |
| API URL    | `https://bfomacoarwtqzjfxszdr.supabase.co` |
| Anon Key   | `eyJhbGciOi...` (JWT, RLS anon_read ì •ì±…)  |
| ê¸°ì¡´ EF    | `regenerate-embeddings` (unit_costs ìš©)    |

---

## 1. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### 1.1 ì „ì²´ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAG ì±—ë´‡ ì‹œìŠ¤í…œ êµ¬ì„±                       â”‚
â”‚                                                              â”‚
â”‚  [ì‚¬ìš©ì]                                                    â”‚
â”‚     â”‚ ì§ˆë¬¸ ì…ë ¥                                              â”‚
â”‚     â–¼                                                        â”‚
â”‚  [ì •ì  HTML í”„ë¡ íŠ¸ì—”ë“œ]  â† Cloudflare Pages / ë¡œì»¬           â”‚
â”‚     â”‚ POST /functions/v1/rag-chat                            â”‚
â”‚     â–¼                                                        â”‚
â”‚  [Supabase Edge Function: rag-chat]                          â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€ (A) ì§ˆë¬¸ ì„ë² ë”© ìƒì„±  â† Gemini API                    â”‚
â”‚     â”‚       gemini-embedding-001 â†’ vector(768)               â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€ (B) ë²¡í„° ê²€ìƒ‰         â† search_entities_by_embedding  â”‚
â”‚     â”‚       ì§ˆë¬¸ ë²¡í„° â†’ TOP-3 ìœ ì‚¬ ì—”í‹°í‹°                    â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€ (C) ê·¸ë˜í”„ í™•ì¥       â† get_related_resources         â”‚
â”‚     â”‚       ê° ì—”í‹°í‹° â†’ ê´€ë ¨ Labor/Equipment/Material/Note   â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€ (D) ê³„ì¸µ í™•ì¥         â† get_entity_hierarchy          â”‚
â”‚     â”‚       Section ì—”í‹°í‹° â†’ í•˜ìœ„ ì„¹ì…˜ ì •ë³´                  â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€ (E) ì¼ìœ„ëŒ€ê°€ ê²€ìƒ‰     â† search_ilwi                   â”‚
â”‚     â”‚       ë¹„ìš© ì˜ë„ ê°ì§€ ì‹œ â†’ ì´ë¦„+ê·œê²© ë§¤ì¹­               â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€ (F) ì›ë¬¸ ì²­í¬ ë³´ê°•    â† graph_chunks ì§ì ‘ ì¡°íšŒ        â”‚
â”‚     â”‚       ì—”í‹°í‹°ì˜ source_section â†’ í•´ë‹¹ ì²­í¬ ë³¸ë¬¸         â”‚
â”‚     â”‚                                                        â”‚
â”‚     â””â”€ (G) LLM ë‹µë³€ ìƒì„±    â† Gemini API                    â”‚
â”‚             ì»¨í…ìŠ¤íŠ¸ ì¡°í•© â†’ gemini-2.0-flash â†’ ë‹µë³€           â”‚
â”‚     â”‚                                                        â”‚
â”‚     â–¼                                                        â”‚
â”‚  [ì‚¬ìš©ìì—ê²Œ ì‘ë‹µ]                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 í•µì‹¬ ì„¤ê³„ ì›ì¹™

| ì›ì¹™            | ì ìš©                                                  |
| --------------- | ----------------------------------------------------- |
| **Zero-ops**    | Edge Function ì„œë²„ë¦¬ìŠ¤ â†’ ì§‘ PC êº¼ë„ ë™ì‘              |
| **ë‹¨ì¼ ì €ì¥ì†Œ** | Supabase PostgreSQL = ë²¡í„° + ê·¸ë˜í”„ + êµ¬ì¡° ê²€ìƒ‰ í•œ ê³³ |
| **ê·¸ë˜í”„ RAG**  | ë²¡í„° ê²€ìƒ‰ â†’ ê·¸ë˜í”„ í™•ì¥ â†’ ì»¨í…ìŠ¤íŠ¸ ë³´ê°• â†’ LLM ë‹µë³€    |
| **ë¹„ìš© $0**     | Gemini Free tier + Supabase Free tier                 |
| **ì›ë¬¸ ì°¸ì¡°**   | ë‹µë³€ì— ë°˜ë“œì‹œ ì¶œì²˜(ë¶€ë¬¸>ì¥>ì ˆ) ëª…ì‹œ                   |

---

## 2. Edge Function ìƒì„¸ ì„¤ê³„

### 2.1 í•¨ìˆ˜ ë©”íƒ€ë°ì´í„°

| í•­ëª©           | ê°’                                |
| -------------- | --------------------------------- |
| **slug**       | `rag-chat`                        |
| **runtime**    | Deno (Supabase Edge Runtime)      |
| **entrypoint** | `index.ts`                        |
| **verify_jwt** | `false` (ì„œë²„ì¸¡ ë³´í˜¸ì¥ì¹˜ë¡œ ëŒ€ì²´)  |
| **CORS**       | ë„ë©”ì¸ allowlist (ì•„ë˜ Â§2.7 ì°¸ì¡°) |

> **Why verify_jwt=false** _(Codex F1 ë°˜ì˜)_:
> í”„ë¡ íŠ¸ì—”ë“œê°€ ì •ì  HTMLì´ë¯€ë¡œ JWT ë°œê¸‰ ì£¼ì²´ê°€ ì—†ìŒ.
> ëŒ€ì‹  ì•„ë˜ **3ì¢… ì„œë²„ì¸¡ ë³´í˜¸ì¥ì¹˜**ë¥¼ ì ìš©í•˜ì—¬ ë‚¨ìš© ë°©ì§€:
>
> | ë³´í˜¸ì¥ì¹˜ | êµ¬í˜„ | ë¹„ê³  |
> |---------|------|------|
> | **API Key ê²€ì¦** | ì»¤ìŠ¤í…€ í—¤ë” `x-api-key` ê²€ì¦ | í”„ë¡ íŠ¸ì—”ë“œì— í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì… |
> | **Rate Limiting** | IP ê¸°ë°˜ ë¶„ë‹¹ 10íšŒ ì œí•œ (Deno KV ë˜ëŠ” ë©”ëª¨ë¦¬ Map) | burst ë°©ì§€ |
> | **ìš”ì²­ í¬ê¸° ì œí•œ** | body 10KB ì´ˆê³¼ ì‹œ 413 ë°˜í™˜ | payload ë‚¨ìš© ë°©ì§€ |
>
> - `SUPABASE_SERVICE_ROLE_KEY`ëŠ” Edge Function ë‚´ë¶€ì—ì„œë§Œ ì‚¬ìš©, í´ë¼ì´ì–¸íŠ¸ ì‘ë‹µÂ·ë¡œê·¸Â·ì—ëŸ¬ ë©”ì‹œì§€ì— ì ˆëŒ€ ë…¸ì¶œ ê¸ˆì§€.
> - í–¥í›„ Supabase Auth ë„ì… ì‹œ `verify_jwt=true`ë¡œ ì „í™˜.

### 2.2 ìš”ì²­/ì‘ë‹µ ìŠ¤í‚¤ë§ˆ

#### ìš”ì²­ (POST)

```typescript
interface ChatRequest {
  question: string;      // ì‚¬ìš©ì ì§ˆë¬¸ (í•„ìˆ˜, ìµœëŒ€ 500ì)
  history?: ChatMessage[]; // ëŒ€í™” ì´ë ¥ (ì„ íƒ, ìµœëŒ€ 5í„´)
}

interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
}
```

#### ì‘ë‹µ

```typescript
interface ChatResponse {
  answer: string;           // LLM ìƒì„± ë‹µë³€ (ë§ˆí¬ë‹¤ìš´)
  sources: SourceInfo[];    // ì°¸ì¡° ì¶œì²˜
  search_info: SearchInfo;  // ê²€ìƒ‰ ë””ë²„ê·¸ ì •ë³´
}

interface SourceInfo {
  entity_name: string;
  entity_type: string;
  source_section?: string;  // entity.source_section (ì ˆ ì½”ë“œ, ì˜ˆ: "6-3-1")
  section_label?: string;   // chunkì—ì„œ ì¡°í•©: "í† ëª©ë¶€ë¬¸ > ì œ6ì¥ > ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤"
  similarity?: number;
}
// (Codex F4 ë°˜ì˜) sources.section ìƒì‚° ê²½ë¡œ:
//   1ë‹¨ê³„: entity.source_sectionì—ì„œ ì ˆ ì½”ë“œ íšë“ (search_entities_by_embeddingëŠ” ë¯¸ë°˜í™˜)
//   2ë‹¨ê³„: graph_entitiesì—ì„œ idë¡œ ì§ì ‘ ì¡°íšŒí•˜ì—¬ source_section íšë“
//   3ë‹¨ê³„: graph_chunksì—ì„œ section_id = source_sectionìœ¼ë¡œ ì¡°ì¸
//   4ë‹¨ê³„: chunk.department + chunk.chapter + chunk.section + chunk.title ì¡°í•©

interface SearchInfo {
  entities_found: number;
  relations_expanded: number;
  ilwi_matched: number;
  chunks_retrieved: number;
  latency_ms: number;
}
```

### 2.3 ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ ìƒì„¸

```
handleRequest(question)
â”‚
â”œâ”€ [0] ì¸ì¦ ê²€ì¦
â”‚     - x-api-key í—¤ë” ê²€ì¦ (Codex F1)
â”‚     - IP ê¸°ë°˜ rate limit ì²´í¬
â”‚
â”œâ”€ [1] ì…ë ¥ ê²€ì¦
â”‚     - question ë¹ˆ ê°’ ì²´í¬ â†’ 400 ë°˜í™˜
â”‚     - question 500ì ì´ˆê³¼ ì‹œ 500ìë¡œ truncate (Codex F5: ì •ì±… í†µì¼)
â”‚     - body í¬ê¸° 10KB ì´ˆê³¼ ì‹œ 413 ë°˜í™˜
â”‚
â”œâ”€ [2] ì§ˆë¬¸ ì„ë² ë”© ìƒì„±  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì•½ 200ms
â”‚     POST https://generativelanguage.googleapis.com/v1beta/
â”‚           models/gemini-embedding-001:embedContent
â”‚     model: "models/gemini-embedding-001"
â”‚     content: { parts: [{ text: question }] }
â”‚     â†’ vector(768)
â”‚
â”œâ”€ [3] ë²¡í„° ê²€ìƒ‰  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì•½ 100ms
â”‚     supabase.rpc('search_entities_by_embedding', {
â”‚       query_embedding_text: JSON.stringify(embedding),
â”‚       match_count: 5,
â”‚       match_threshold: 0.4
â”‚     })
â”‚     â†’ entities[] (ìµœëŒ€ 5ê±´)
â”‚
â”‚     â€» threshold 0.5â†’0.4 ì™„í™”: ê±´ì„¤ ìš©ì–´ì˜ íŠ¹ìˆ˜ì„±
â”‚       "PEê´€ ë°°ê´€" â†” "í´ë¦¬ì—í‹¸ë Œê´€ ì ‘í•©" ìœ ì‚¬ë„ê°€ 0.45ì¼ ìˆ˜ ìˆìŒ
â”‚
â”œâ”€ [4] ê·¸ë˜í”„ í™•ì¥ (ë³‘ë ¬ í˜¸ì¶œ)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì•½ 200ms
â”‚     for each entity:
â”‚       â”œâ”€ supabase.rpc('get_related_resources', { p_entity_id })
â”‚       â””â”€ supabase.rpc('get_entity_hierarchy', { p_entity_id })
â”‚           â€» Section íƒ€ì…ì¸ ê²½ìš°ë§Œ í˜¸ì¶œ
â”‚
â”‚     ê²°ê³¼ êµ¬ì¡°í™”:
â”‚       entity.name (WorkType)
â”‚         â”œâ”€ REQUIRES_LABOR: [ë³´í†µì¸ë¶€ 0.122ì¸, ì½˜í¬ë¦¬íŠ¸ê³µ 0.045ì¸]
â”‚         â”œâ”€ REQUIRES_EQUIPMENT: [ë°”ì´ë¸Œë ˆì´í„° 1ëŒ€]
â”‚         â”œâ”€ USES_MATERIAL: [ë ˆë¯¸ì½˜ 1.02mÂ³]
â”‚         â”œâ”€ HAS_NOTE: ["í• ì¦ 10% ì ìš©", "ê³ ì•• ì‹œ ë³„ë„"]
â”‚         â””â”€ BELONGS_TO: [ì œ6ì¥ ì½˜í¬ë¦¬íŠ¸ê³µì‚¬]
â”‚
â”œâ”€ [5] ë¹„ìš© ì˜ë„ ê°ì§€ + ì¼ìœ„ëŒ€ê°€ ê²€ìƒ‰  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì•½ 100ms
â”‚     detectCostIntent(question):
â”‚       í‚¤ì›Œë“œ: "ë¹„ìš©", "ë‹¨ê°€", "ê°€ê²©", "ì›", "ì–¼ë§ˆ", "ì¼ìœ„ëŒ€ê°€",
â”‚              "ì¬ë£Œë¹„", "ë…¸ë¬´ë¹„", "ê²½ë¹„", "í•©ê³„"
â”‚
â”‚     if (costIntent) {
â”‚       for each entity (WorkTypeë§Œ):
â”‚         supabase.rpc('search_ilwi', {
â”‚           search_name: entity.name,
â”‚           search_spec: extractSpec(question)  // ê·œê²© ì¶”ì¶œ
â”‚         })
â”‚     }
â”‚
â”œâ”€ [6] ì›ë¬¸ ì²­í¬ ë³´ê°•  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì•½ 50ms
â”‚     entity.source_section â†’ graph_chunks.section_id ë§¤ì¹­ (Codex F3: ì»¬ëŸ¼ëª… ìˆ˜ì •)
â”‚     â†’ í•´ë‹¹ ì²­í¬ì˜ text (ì›ë¬¸ í…ìŠ¤íŠ¸) ê°€ì ¸ì˜¤ê¸°
â”‚     â†’ chunk.department, chunk.chapter, chunk.section, chunk.title ë¡œ ì¶œì²˜ ë¼ë²¨ ì¡°í•©
â”‚     â†’ ìµœëŒ€ 3ê±´, ê° 500ì ì œí•œ
â”‚
â”œâ”€ [7] ì»¨í…ìŠ¤íŠ¸ ì¡°í•©  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì•½ 10ms
â”‚     buildContext():
â”‚       "## í’ˆì…ˆ ì •ë³´ (ë²¡í„° ê²€ìƒ‰ ê²°ê³¼)"
â”‚       "### 1. ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤ (ìœ ì‚¬ë„: 0.95)"
â”‚       "- íˆ¬ì… ì¸ë ¥: ë³´í†µì¸ë¶€ 0.122ì¸, ì½˜í¬ë¦¬íŠ¸ê³µ 0.045ì¸"
â”‚       "- íˆ¬ì… ì¥ë¹„: ë°”ì´ë¸Œë ˆì´í„° 1ëŒ€"
â”‚       "- ì‚¬ìš© ìì¬: ë ˆë¯¸ì½˜ 1.02mÂ³"
â”‚       "- ì£¼ì˜ì‚¬í•­: í• ì¦ 10% ì ìš©"
â”‚       "- ì¶œì²˜: í† ëª©ë¶€ë¬¸ > ì œ6ì¥ ì½˜í¬ë¦¬íŠ¸ê³µì‚¬"
â”‚       "## ì¼ìœ„ëŒ€ê°€ ë¹„ìš© ì •ë³´"
â”‚       "| í•­ëª© | ê·œê²© | ë…¸ë¬´ë¹„ | ì¬ë£Œë¹„ | í•©ê³„ |"
â”‚       "## ì›ë¬¸ ì°¸ê³ "
â”‚       "(í•´ë‹¹ í’ˆì…ˆ ì›ë¬¸ í…ìŠ¤íŠ¸)"
â”‚
â””â”€ [8] LLM ë‹µë³€ ìƒì„±  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì•½ 2000ms
      POST generativelanguage.googleapis.com/v1beta/
            models/gemini-2.0-flash:generateContent
      
      system_instruction: (Â§2.4 ì°¸ì¡°)
      contents: [
        ...history (ìµœëŒ€ 5í„´),
        { role: "user", parts: [{ text: question + context }] }
      ]
      â†’ markdown í˜•íƒœ ë‹µë³€
```

### 2.4 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ê³„

```typescript
const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ ê±´ì„¤ ê³µì‚¬ í’ˆì…ˆ(æ¨™æº–å“ì…ˆ) ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

[ì—­í• ]
- ì‚¬ìš©ìì˜ ê±´ì„¤ ê³µì‚¬ ê´€ë ¨ ì§ˆë¬¸ì— ëŒ€í•´ í’ˆì…ˆ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•˜ê²Œ ë‹µë³€í•©ë‹ˆë‹¤.
- ë‹µë³€ ì‹œ ë°˜ë“œì‹œ ì œê³µëœ ì»¨í…ìŠ¤íŠ¸ì˜ ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ë©°, ì»¨í…ìŠ¤íŠ¸ì— ì—†ëŠ” ì •ë³´ëŠ” ì¶”ì¸¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

[ë‹µë³€ ê·œì¹™]
1. **ì¶œì²˜ ëª…ì‹œ**: ë‹µë³€ì— ì‚¬ìš©í•œ í’ˆì…ˆ í•­ëª©ì˜ ì¶œì²˜(ë¶€ë¬¸ > ì¥ > ì ˆ)ë¥¼ ë°˜ë“œì‹œ í‘œê¸°í•©ë‹ˆë‹¤.
2. **ìˆ˜ëŸ‰ ì •í™•ì„±**: ì¸ë ¥, ì¥ë¹„, ìì¬ì˜ ìˆ˜ëŸ‰ê³¼ ë‹¨ìœ„ë¥¼ ì •í™•í•˜ê²Œ í‘œê¸°í•©ë‹ˆë‹¤.
   ì˜ˆ: "ë³´í†µì¸ë¶€ 0.122ì¸", "ì½˜í¬ë¦¬íŠ¸ê³µ 0.045ì¸"
3. **ë¹„ìš© ë‹µë³€ ì‹œ**: ì¼ìœ„ëŒ€ê°€ ì •ë³´ê°€ ì œê³µë˜ë©´, ë…¸ë¬´ë¹„/ì¬ë£Œë¹„/ê²½ë¹„/í•©ê³„ë¥¼ í‘œ í˜•íƒœë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
4. **ì£¼ì˜ì‚¬í•­ í¬í•¨**: í• ì¦, ì ìš© ì¡°ê±´, ì œí•œ ì‚¬í•­ì´ ìˆìœ¼ë©´ ë°˜ë“œì‹œ ì–¸ê¸‰í•©ë‹ˆë‹¤.
5. **ì •ë³´ ë¶€ì¡± ì‹œ**: "ì œê³µëœ í’ˆì…ˆ ë°ì´í„°ì—ì„œ í•´ë‹¹ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"ë¼ê³  ë‹µí•©ë‹ˆë‹¤.
6. **ë§ˆí¬ë‹¤ìš´ í˜•ì‹**: ë‹µë³€ì€ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì…ë‹ˆë‹¤.

[ê¸ˆì§€ ì‚¬í•­]
- ì»¨í…ìŠ¤íŠ¸ì— ì—†ëŠ” ìˆ˜ì¹˜ë‚˜ ê¸°ì¤€ì„ ì„ì˜ë¡œ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- "ì¼ë°˜ì ìœ¼ë¡œ", "ë³´í†µ", "ëŒ€ëµ" ë“± ëª¨í˜¸í•œ í‘œí˜„ ëŒ€ì‹  ì •í™•í•œ ìˆ˜ì¹˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ê±´ì„¤ ê´€ë ¨ì´ ì•„ë‹Œ ì§ˆë¬¸ì—ëŠ” "ê±´ì„¤ í’ˆì…ˆ ê´€ë ¨ ì§ˆë¬¸ì—ë§Œ ë‹µë³€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"ë¼ê³  ì‘ë‹µí•©ë‹ˆë‹¤.`;
```

### 2.5 ì—ëŸ¬ í•¸ë“¤ë§

| ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤               | HTTP  | ì‘ë‹µ                              | ì‚¬ìš©ì ë©”ì‹œì§€                         |
| --------------------------- | :---: | --------------------------------- | ------------------------------------- |
| API Key ëˆ„ë½/ë¶ˆì¼ì¹˜         |  401  | `{ error: "unauthorized" }`       | â€”                                     |
| Rate Limit ì´ˆê³¼             |  429  | `{ error: "rate_limited" }`       | "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”"           |
| ì§ˆë¬¸ ë¯¸ì…ë ¥ / ë¹ˆ ë¬¸ìì—´     |  400  | `{ error: "question_required" }`  | "ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"                 |
| ì§ˆë¬¸ 500ì ì´ˆê³¼             |   â€”   | 500ìë¡œ ìë™ truncate (ì—ëŸ¬ ì•„ë‹˜) | â€” _(Codex F5: truncate í†µì¼)_         |
| ì„ë² ë”© API ì‹¤íŒ¨             |  502  | `{ error: "embedding_failed" }`   | "ì„ë² ë”© ìƒì„± ì¤‘ ì˜¤ë¥˜" (1íšŒ ì¬ì‹œë„ í›„) |
| ë²¡í„° ê²€ìƒ‰ 0ê±´               |  200  | ì •ìƒ (LLMì´ "ì°¾ì„ ìˆ˜ ì—†ìŒ" ë‹µë³€)  | â€”                                     |
| Gemini ë‹µë³€ ìƒì„± ì‹¤íŒ¨       |  502  | `{ error: "llm_failed" }`         | "ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜" â†’ êµ¬ì¡° ì‘ë‹µ í´ë°±  |
| Supabase RPC ì‹¤íŒ¨           |  500  | `{ error: "db_error" }`           | "ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜"                 |
| ìš”ì²­ Too Large (body >10KB) |  413  | `{ error: "payload_too_large" }`  | â€”                                     |

> **í´ë°± ì „ëµ** _(Codex ê¶Œì¥)_:
> - ì„ë² ë”© ì‹¤íŒ¨ â†’ 1íšŒ ì¬ì‹œë„ í›„ 502 ë°˜í™˜
> - LLM ì‹¤íŒ¨ â†’ ê²€ìƒ‰ ê²°ê³¼ë§Œ êµ¬ì¡°í™”í•˜ì—¬ ë°˜í™˜ (ì¶œì²˜ + ì—”í‹°í‹° ëª©ë¡)

### 2.6 í™˜ê²½ ë³€ìˆ˜

| ë³€ìˆ˜                        | ìš©ë„                   | ì„¤ì • ë°©ë²•                                     |
| --------------------------- | ---------------------- | --------------------------------------------- |
| `GEMINI_API_KEY`            | ì„ë² ë”© + ë‹µë³€ ìƒì„±     | Supabase Dashboard > Edge Functions > Secrets |
| `SUPABASE_URL`              | DB ì—°ê²° (ìë™ ì£¼ì…)    | ìë™                                          |
| `SUPABASE_SERVICE_ROLE_KEY` | DB ì¡°íšŒ (RLS ë°”ì´íŒ¨ìŠ¤) | ìë™                                          |
| `RAG_API_KEY`               | ì»¤ìŠ¤í…€ API key ê²€ì¦    | Supabase Dashboard > Edge Functions > Secrets |

> **Why SERVICE_ROLE_KEY**: Edge Functionì€ ì„œë²„ì‚¬ì´ë“œì´ë¯€ë¡œ anon keyë„ ê°€ëŠ¥í•˜ë‚˜,
> ë‚´ë¶€ RPC í˜¸ì¶œì˜ ì¼ê´€ì„±ì„ ìœ„í•´ service_role ì‚¬ìš©.
> âš ï¸ **ì ˆëŒ€ í´ë¼ì´ì–¸íŠ¸ ì‘ë‹µÂ·ë¡œê·¸Â·ì—ëŸ¬ ë©”ì‹œì§€ì— ë…¸ì¶œ ê¸ˆì§€** _(Codex F1)_.

---

## 3. í”„ë¡ íŠ¸ì—”ë“œ ìƒì„¸ ì„¤ê³„

### 3.1 íŒŒì¼ êµ¬ì¡°

```
python_code/
â””â”€â”€ frontend/
    â”œâ”€â”€ index.html          â† ë©”ì¸ ì±—ë´‡ í˜ì´ì§€
    â”œâ”€â”€ style.css           â† ìŠ¤íƒ€ì¼ì‹œíŠ¸
    â””â”€â”€ app.js              â† ì±—ë´‡ ë¡œì§
```

### 3.2 UI/UX ì„¤ê³„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ—ï¸ ê±´ì„¤ í’ˆì…ˆ AI ì–´ì‹œìŠ¤í„´íŠ¸                 â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                            â”‚
â”‚  [AI] ì•ˆë…•í•˜ì„¸ìš”! ê±´ì„¤ í’ˆì…ˆì— ëŒ€í•´          â”‚
â”‚       ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”.               â”‚
â”‚                                            â”‚
â”‚  [User] ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤ ë¹„ìš© ì•Œë ¤ì¤˜           â”‚
â”‚                                            â”‚
â”‚  [AI] ## ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤ í’ˆì…ˆ ì •ë³´            â”‚
â”‚       ### íˆ¬ì… ì¸ë ¥                         â”‚
â”‚       | ì§ì¢… | ìˆ˜ëŸ‰ | ë‹¨ìœ„ |               â”‚
â”‚       |------|------|------|               â”‚
â”‚       | ë³´í†µì¸ë¶€ | 0.122 | ì¸ |            â”‚
â”‚       ...                                  â”‚
â”‚       ğŸ“Œ ì¶œì²˜: í† ëª©ë¶€ë¬¸ > ì œ6ì¥             â”‚
â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...          [â–¶]â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ì£¼ìš” ê¸°ëŠ¥

| ê¸°ëŠ¥                | ì„¤ëª…                                            |
| ------------------- | ----------------------------------------------- |
| **ë§ˆí¬ë‹¤ìš´ ë Œë”ë§** | AI ë‹µë³€ì˜ í…Œì´ë¸”, ë³¼ë“œ, ë¦¬ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë³€í™˜    |
| **ëŒ€í™” ì´ë ¥ ê´€ë¦¬**  | ìµœê·¼ 5í„´ì„ ì €ì¥í•˜ì—¬ Edge Functionì— ì „ë‹¬        |
| **ë¡œë”© ìƒíƒœ**       | ë‹µë³€ ëŒ€ê¸° ì‹œ íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜                  |
| **ì—ëŸ¬ í‘œì‹œ**       | ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, ì„œë²„ ì˜¤ë¥˜ ì‹œ ì‚¬ìš©ì ì•ˆë‚´         |
| **ê²€ìƒ‰ ë””ë²„ê·¸**     | ì ‘ì´ì‹ íŒ¨ë„ë¡œ ê²€ìƒ‰ ì—”í‹°í‹°, ìœ ì‚¬ë„ í‘œì‹œ (ê°œë°œìš©) |
| **ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ** | ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ëŒ€ì‘                            |

### 3.4 API í˜¸ì¶œ

```javascript
const EDGE_FUNCTION_URL = 
  'https://bfomacoarwtqzjfxszdr.supabase.co/functions/v1/rag-chat';

async function sendQuestion(question, history = []) {
  const response = await fetch(EDGE_FUNCTION_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      // verify_jwt=falseì´ë¯€ë¡œ Authorization í—¤ë” ë¶ˆí•„ìš”
    },
    body: JSON.stringify({ question, history })
  });
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`);
  }
  
  return await response.json(); // ChatResponse
}
```

---

## 4. Edge Function êµ¬í˜„ ê³„íš

### 4.1 ì½”ë“œ êµ¬ì¡°

```typescript
// index.ts â€” ì§„ì…ì 
import "jsr:@supabase/functions-js/edge-runtime.d.ts";

// ëª¨ë“ˆ ë¶„ë¦¬ (ë‹¨ì¼ íŒŒì¼ì´ì§€ë§Œ ë…¼ë¦¬ì  êµ¬íš)
// â”â”â” [A] ì„¤ì • & ìœ í‹¸ â”â”â”
//   - í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
//   - Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
//   - CORS í—¤ë”
//   - ì…ë ¥ ê²€ì¦

// â”â”â” [B] ì„ë² ë”© ìƒì„± â”â”â”
//   - generateEmbedding(text) â†’ number[]

// â”â”â” [C] ê²€ìƒ‰ íŒŒì´í”„ë¼ì¸ â”â”â”
//   - searchEntities(embedding) â†’ Entity[]
//   - expandGraph(entities) â†’ RelatedResource[]
//   - searchIlwi(entities, question) â†’ IlwiItem[]
//   - retrieveChunks(entities) â†’ Chunk[]

// â”â”â” [D] ì»¨í…ìŠ¤íŠ¸ ì¡°í•© â”â”â”
//   - buildContext(entities, relations, ilwi, chunks) â†’ string

// â”â”â” [E] ì˜ë„ ê°ì§€ â”â”â”
//   - detectCostIntent(question) â†’ boolean
//   - extractSpec(question) â†’ string | null

// â”â”â” [F] LLM ë‹µë³€ ìƒì„± â”â”â”
//   - generateAnswer(question, context, history) â†’ string

// â”â”â” [G] ë©”ì¸ í•¸ë“¤ëŸ¬ â”â”â”
//   - Deno.serve(handler)
```

### 4.2 ê²€ìƒ‰ íë¦„ ì˜ì‚¬ì½”ë“œ

```typescript
async function handleChat(question: string, history: ChatMessage[]) {
  const startTime = Date.now();

  // [1] ì§ˆë¬¸ ì„ë² ë”©
  const embedding = await generateEmbedding(question);

  // [2] ë²¡í„° ê²€ìƒ‰ â†’ ì‹œì‘ì  ì—”í‹°í‹°
  const entities = await searchEntities(embedding);

  if (entities.length === 0) {
    // ë²¡í„° ê²€ìƒ‰ ì‹¤íŒ¨ â†’ LLMì—ê²Œ "ì°¾ì„ ìˆ˜ ì—†ìŒ" ë‹µë³€ ìœ„ì„
    const answer = await generateAnswer(question, 
      "ì œê³µëœ í’ˆì…ˆ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", 
      history
    );
    return { answer, sources: [], search_info: { ... } };
  }

  // [3] ê·¸ë˜í”„ í™•ì¥ (ë³‘ë ¬)
  const relationsPromises = entities.map(e => 
    expandGraph(e.id, e.type)
  );
  const relationsAll = await Promise.all(relationsPromises);

  // [4] ë¹„ìš© ì˜ë„ â†’ ì¼ìœ„ëŒ€ê°€
  let ilwiResults = [];
  if (detectCostIntent(question)) {
    const workTypeEntities = entities.filter(e => e.type === 'WorkType');
    for (const e of workTypeEntities) {
      const spec = extractSpec(question);
      const items = await searchIlwi(e.name, spec);
      if (items.length > 0) {
        ilwiResults.push(...items);
        break; // ì²« ë§¤ì¹­ ì‚¬ìš©
      }
    }
  }

  // [5] ì›ë¬¸ ì²­í¬ ë³´ê°•
  const chunks = await retrieveChunks(entities);

  // [6] ì»¨í…ìŠ¤íŠ¸ â†’ LLM ë‹µë³€
  const context = buildContext(entities, relationsAll, ilwiResults, chunks);
  const answer = await generateAnswer(question, context, history);

  // [7] ì‘ë‹µ ì¡°ë¦½
  // (Codex F4) sources.section ìƒì‚°: entity â†’ chunk ì¡°ì¸ìœ¼ë¡œ ì¶œì²˜ ë¼ë²¨ êµ¬ì„±
  const sourcesWithSection = entities.map((e, i) => {
    const chunk = chunks.find(c => c.section_id === e.source_section);
    return {
      entity_name: e.name,
      entity_type: e.type,
      source_section: e.source_section,
      section_label: chunk 
        ? `${chunk.department} > ${chunk.chapter} > ${chunk.title}`
        : e.source_section,
      similarity: e.similarity
    };
  });
  return {
    answer,
    sources: sourcesWithSection,
    search_info: {
      entities_found: entities.length,
      relations_expanded: relationsAll.flat().length,
      ilwi_matched: ilwiResults.length,
      chunks_retrieved: chunks.length,
      latency_ms: Date.now() - startTime
    }
  };
}
```

### 4.3 Gemini API í˜¸ì¶œ ìƒì„¸

#### ì„ë² ë”© ìƒì„±

```typescript
// ëª¨ë¸: gemini-embedding-001 (Step 2.7ê³¼ ë™ì¼ ëª¨ë¸ í•„ìˆ˜)
// Why: ê²€ìƒ‰ ì‹œ ì§ˆë¬¸ ë²¡í„°ì™€ DB ë²¡í„°ì˜ ëª¨ë¸ì´ ë‹¤ë¥´ë©´ ìœ ì‚¬ë„ ë¬´ì˜ë¯¸
const EMBEDDING_URL = 
  'https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:embedContent';

async function generateEmbedding(text: string): Promise<number[]> {
  const response = await fetch(`${EMBEDDING_URL}?key=${GEMINI_API_KEY}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'models/gemini-embedding-001',
      content: { parts: [{ text }] },
    }),
  });

  if (!response.ok) {
    throw new Error(`Embedding API failed: ${response.status}`);
  }

  const data = await response.json();
  return data.embedding?.values ?? [];
}
```

#### ë‹µë³€ ìƒì„±

```typescript
// ëª¨ë¸: gemini-2.0-flash (ë¹ ë¥´ê³  ì •í™•)
// Why: Edge Function ì œí•œì‹œê°„(~25ì´ˆ) ë‚´ ì‘ë‹µ í•„ìˆ˜
//      Flash ëª¨ë¸ì€ ~2ì´ˆ ì‘ë‹µ, ProëŠ” ~5ì´ˆ â†’ Flash ì„ íƒ
const LLM_URL = 
  'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

async function generateAnswer(
  question: string, 
  context: string, 
  history: ChatMessage[]
): Promise<string> {
  const contents = [
    // ëŒ€í™” ì´ë ¥ (ìµœëŒ€ 5í„´)
    ...history.slice(-5).map(msg => ({
      role: msg.role === 'user' ? 'user' : 'model',
      parts: [{ text: msg.content }],
    })),
    // í˜„ì¬ ì§ˆë¬¸ + ì»¨í…ìŠ¤íŠ¸
    {
      role: 'user',
      parts: [{ text: `[ì§ˆë¬¸]\n${question}\n\n[ì°¸ê³  ë°ì´í„°]\n${context}` }],
    },
  ];

  const response = await fetch(`${LLM_URL}?key=${GEMINI_API_KEY}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
      contents,
      generationConfig: {
        temperature: 0.3,   // ë‚®ì€ ì°½ì˜ì„± â†’ ì •í™•í•œ í’ˆì…ˆ ë‹µë³€
        maxOutputTokens: 2048,
      },
    }),
  });

  if (!response.ok) {
    throw new Error(`LLM API failed: ${response.status}`);
  }

  const data = await response.json();
  return data.candidates?.[0]?.content?.parts?.[0]?.text ?? 'ë‹µë³€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
}
```

---

## 5. ë¹„ìš© ì˜ë„ ê°ì§€ & ì¼ìœ„ëŒ€ê°€ ë§¤ì¹­ ì „ëµ

### 5.1 ë¹„ìš© ì˜ë„ ê°ì§€

```typescript
const COST_KEYWORDS = [
  'ë¹„ìš©', 'ë‹¨ê°€', 'ê°€ê²©', 'ì›', 'ì–¼ë§ˆ', 'ì¼ìœ„ëŒ€ê°€',
  'ì¬ë£Œë¹„', 'ë…¸ë¬´ë¹„', 'ê²½ë¹„', 'í•©ê³„', 'ì‚°ì¶œ', 'ê²¬ì ',
  'ê³µì‚¬ë¹„', 'ì›ê°€', 'ê¸ˆì•¡'
];

function detectCostIntent(question: string): boolean {
  return COST_KEYWORDS.some(kw => question.includes(kw));
}
```

### 5.2 ê·œê²© ì¶”ì¶œ

```typescript
// ì‚¬ìš©ì ì§ˆë¬¸ì—ì„œ ê·œê²© íŒ¨í„´ ì¶”ì¶œ
// "ê°•ê´€ ìš©ì ‘ ë°°ê´€ D80 ê¸°ê³„ì‹¤" â†’ spec = "D80"
const SPEC_PATTERNS = [
  /D\d+/i,                // D80, D100
  /\d+mm/i,               // 100mm, 200mm
  /\d+í†¤/,                // 10í†¤, 25í†¤  
  /\d+m[Â³Â²]?/,            // 0.7mÂ³, 100mÂ²
  /\d+-\d+-\d+/,          // 25-180-12 (ë ˆë¯¸ì½˜ ê·œê²©)
];

function extractSpec(question: string): string | null {
  for (const pattern of SPEC_PATTERNS) {
    const match = question.match(pattern);
    if (match) return match[0];
  }
  return null;
}
```

### 5.3 ì¼ìœ„ëŒ€ê°€ ì¬ë­í‚¹

```
ì¼ìœ„ëŒ€ê°€ ê²€ìƒ‰ ê²°ê³¼ê°€ ë‹¤ìˆ˜ì¸ ê²½ìš° (ì˜ˆ: ë°°ê´€ â†’ 144ê±´):
  
  1ë‹¨ê³„: search_ilwi(name)ë¡œ í›„ë³´ ì¡°íšŒ (ìµœëŒ€ 10ê±´)
  2ë‹¨ê³„: ì‚¬ìš©ì ì§ˆë¬¸ì—ì„œ ê·œê²© í‚¤ì›Œë“œ ì¶”ì¶œ
  3ë‹¨ê³„: spec ë§¤ì¹­ìœ¼ë¡œ í•„í„°ë§
  4ë‹¨ê³„: ê·¸ë˜ë„ ë‹¤ìˆ˜ì´ë©´ TOP-3ë§Œ ì»¨í…ìŠ¤íŠ¸ì— í¬í•¨
```

---

## 6. ì»¨í…ìŠ¤íŠ¸ ì¡°í•© ì „ëµ

### 6.1 ì»¨í…ìŠ¤íŠ¸ êµ¬ì¡°

```markdown
## í’ˆì…ˆ ê²€ìƒ‰ ê²°ê³¼

### 1. {entity_name} ({entity_type}, ìœ ì‚¬ë„: {similarity})
**ì¶œì²˜**: {ë¶€ë¬¸} > {ì¥} > {ì ˆ}

**íˆ¬ì… ì¸ë ¥ (REQUIRES_LABOR)**:
| ì§ì¢…       | ìˆ˜ëŸ‰  | ë‹¨ìœ„ |
| ---------- | ----- | ---- |
| ë³´í†µì¸ë¶€   | 0.122 | ì¸   |
| ì½˜í¬ë¦¬íŠ¸ê³µ | 0.045 | ì¸   |

**íˆ¬ì… ì¥ë¹„ (REQUIRES_EQUIPMENT)**:
- ë°”ì´ë¸Œë ˆì´í„° 1ëŒ€

**ì‚¬ìš© ìì¬ (USES_MATERIAL)**:
- ë ˆë¯¸ì½˜ 25-180-12: 1.02 mÂ³

**ì£¼ì˜ì‚¬í•­ (HAS_NOTE)**:
- í• ì¦ 10% ì ìš© (ë¹„íƒˆë©´ ì‘ì—… ì‹œ)
- ê³ ì•• ì½˜í¬ë¦¬íŠ¸ ë³„ë„

---

## ì¼ìœ„ëŒ€ê°€ ë¹„ìš© ì •ë³´

| í•­ëª©          | ê·œê²© | ë…¸ë¬´ë¹„ | ì¬ë£Œë¹„ | ê²½ë¹„ | í•©ê³„   |
| ------------- | ---- | ------ | ------ | ---- | ------ |
| ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤ | ì¼ë°˜ | 41,605 | 52,300 | -    | 93,905 |

---

## ì›ë¬¸ ì°¸ê³  (í’ˆì…ˆ ì›ë¬¸)

> 6-3-1 ì½˜í¬ë¦¬íŠ¸íƒ€ì„¤
> [ì£¼] â‘  ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤ì€ ë ˆë¯¸ì½˜ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ë©°...
```

### 6.2 ì»¨í…ìŠ¤íŠ¸ í¬ê¸° ì œí•œ

| í•­ëª©              | ì œí•œ             | ì´ìœ                              |
| ----------------- | ---------------- | -------------------------------- |
| ì—”í‹°í‹°            | ìµœëŒ€ 5ê±´         | TOP-5 ê²°ê³¼                       |
| ê´€ê³„ (per entity) | ìµœëŒ€ 20ê±´        | ëŒ€ë¶€ë¶„ ì—”í‹°í‹°ì˜ ê´€ê³„ < 15        |
| ì¼ìœ„ëŒ€ê°€          | ìµœëŒ€ 5ê±´         | ê·œê²© ë³€í˜• ì¤‘ë³µ ë°©ì§€              |
| ì²­í¬ ì›ë¬¸         | ìµœëŒ€ 3ê±´ Ã— 500ì | Gemini ì…ë ¥ í† í° ì œí•œ            |
| **ì´ ì»¨í…ìŠ¤íŠ¸**   | **~4,000ì**     | Gemini Flash ì…ë ¥ í•œê³„ ëŒ€ë¹„ ì—¬ìœ  |

---

## 7. í…ŒìŠ¤íŠ¸ ê³„íš

### 7.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (Edge Function ë‚´ë¶€)

| #   | í…ŒìŠ¤íŠ¸         | ì…ë ¥             | ê¸°ëŒ€                                                                     |
| --- | -------------- | ---------------- | ------------------------------------------------------------------------ |
| T1  | ì„ë² ë”© ìƒì„±    | "ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤"  | 768ì°¨ì› ë²¡í„° ë°˜í™˜                                                        |
| T2  | ë²¡í„° ê²€ìƒ‰      | ì½˜í¬ë¦¬íŠ¸ ë²¡í„°    | Top-1 ê²°ê³¼ ì¡´ì¬ + type=WorkType _(Codex F6: ì ˆëŒ€ ìœ ì‚¬ë„ ëŒ€ì‹  ìƒëŒ€ ê¸°ì¤€)_ |
| T3  | ë¹ˆ ê²€ìƒ‰        | "xyzzy" ë¬´ì˜ë¯¸ì–´ | entities=0, LLM "ì°¾ì„ ìˆ˜ ì—†ìŒ"                                           |
| T4  | ë¹„ìš© ì˜ë„ ê°ì§€ | "ë¹„ìš© ì•Œë ¤ì¤˜"    | true                                                                     |
| T5  | ë¹„ìš© ë¹„ì˜ë„    | "ì¸ë ¥ ì•Œë ¤ì¤˜"    | false                                                                    |
| T6  | ê·œê²© ì¶”ì¶œ      | "D80 ê¸°ê³„ì‹¤"     | "D80"                                                                    |
| T7  | API Key ëˆ„ë½   | í—¤ë” ì—†ì´ í˜¸ì¶œ   | 401 ë°˜í™˜ _(Codex F1)_                                                    |
| T8  | Rate Limit     | ì—°ì† 15íšŒ í˜¸ì¶œ   | 11ë²ˆì§¸ë¶€í„° 429 ë°˜í™˜                                                      |

### 7.2 í†µí•© í…ŒìŠ¤íŠ¸ (E2E)

| #   | ì§ˆë¬¸                        | ê¸°ëŒ€ ì‘ë‹µ ìš”ì†Œ                                  |
| --- | --------------------------- | ----------------------------------------------- |
| E1  | "ì½˜í¬ë¦¬íŠ¸ íƒ€ì„¤ ë¹„ìš© ì•Œë ¤ì¤˜" | ì¸ë ¥(ë³´í†µì¸ë¶€, ì½˜í¬ë¦¬íŠ¸ê³µ) + ì¼ìœ„ëŒ€ê°€ í‘œ + ì¶œì²˜ |
| E2  | "PEê´€ ë°°ê´€ ì¸ë ¥"            | ë°°ê´€ê³µ + ë³´í†µì¸ë¶€ + ìˆ˜ëŸ‰ + ì¶œì²˜                 |
| E3  | "ë³´í†µì¸ë¶€ê°€ í•„ìš”í•œ ê³µì¢…"    | ë‹¤ìˆ˜ WorkType ë‚˜ì—´ + ê° ìˆ˜ëŸ‰                    |
| E4  | "ì² ê·¼ ê°€ê³µ ì¥ë¹„ ë­ ì¨?"     | Equipment ëª©ë¡ + ì¶œì²˜                           |
| E5  | "ê±°í‘¸ì§‘ ì„¤ì¹˜ ì£¼ì˜ì‚¬í•­"      | Note ë‚´ìš© ë‚˜ì—´                                  |
| E6  | "ê´€ ë³´ì˜¨ D100 ë¹„ìš©"         | ì¼ìœ„ëŒ€ê°€ ê·œê²© í•„í„°ë§ â†’ D100 ê²°ê³¼                |
| E7  | "ë‚ ì”¨ ì•Œë ¤ì¤˜"               | "ê±´ì„¤ í’ˆì…ˆ ê´€ë ¨ ì§ˆë¬¸ì—ë§Œ ë‹µë³€"                  |
| E8  | "" (ë¹ˆ ì…ë ¥)                | 400 ì—ëŸ¬                                        |

### 7.3 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

| ë©”íŠ¸ë¦­        | ëª©í‘œ    | ì¸¡ì • ë°©ë²•                     |
| ------------- | ------- | ----------------------------- |
| E2E ì‘ë‹µ ì‹œê°„ | < 5ì´ˆ   | Edge Function ë‚´ë¶€ latency_ms |
| ì„ë² ë”© ìƒì„±   | < 500ms | API ì‘ë‹µ ì‹œê°„                 |
| DB ê²€ìƒ‰ í•©ê³„  | < 500ms | 4ê°œ RPC í˜¸ì¶œ í•©ì‚°             |
| LLM ë‹µë³€      | < 3ì´ˆ   | Gemini Flash ì‘ë‹µ ì‹œê°„        |

---

## 8. í”„ë¡ íŠ¸ì—”ë“œ ê¸°ìˆ  ìŠ¤íƒ

| êµ¬ë¶„            | ì„ íƒ                    | ì´ìœ                                          |
| --------------- | ----------------------- | -------------------------------------------- |
| êµ¬ì¡°            | ë‹¨ì¼ HTML + CSS + JS    | ì •ì  íŒŒì¼ë¡œ ë°°í¬ ê°„í¸                        |
| ë§ˆí¬ë‹¤ìš´        | `marked.js` (CDN)       | AI ë‹µë³€ì˜ í…Œì´ë¸”/ë³¼ë“œ ë Œë”ë§                 |
| **XSS ë°©ì–´**    | **`DOMPurify` (CDN)**   | marked.js ë Œë” í›„ HTML sanitize _(Codex F2)_ |
| ì½”ë“œ í•˜ì´ë¼ì´íŠ¸ | ì—†ìŒ                    | ì½”ë“œ ë¸”ë¡ ë¶ˆí•„ìš” (ê±´ì„¤ ë°ì´í„°)               |
| í˜¸ìŠ¤íŒ…          | ë¡œì»¬ / Cloudflare Pages | Free tier                                    |

> **XSS ë°©ì–´ ì •ì±…** _(Codex F2 ë°˜ì˜)_:
> 1. `marked.parse(answer)` â†’ `DOMPurify.sanitize(html)` â†’ `innerHTML`
> 2. DOMPurify í—ˆìš© íƒœê·¸: `<p>, <h1>~<h6>, <table>, <tr>, <td>, <th>, <thead>, <tbody>, <ul>, <ol>, <li>, <strong>, <em>, <code>, <blockquote>, <br>, <hr>`
> 3. ê¸ˆì§€: `<script>, <iframe>, <img>, <a href="javascript:">, <svg>, on*ì´ë²¤íŠ¸`
> 4. `innerHTML` ì§ì ‘ ì£¼ì… ê²½ë¡œ: ì±—ë´‡ ë©”ì‹œì§€ ì˜ì—­ë§Œ í—ˆìš©, ê¸°íƒ€ DOM ì¡°ì‘ì€ `textContent` ì‚¬ìš©

---

## 9. ë°°í¬ ê³„íš

### 9.1 ë°°í¬ ìˆœì„œ

```
Phase A: Edge Function ê°œë°œ + ë°°í¬  â”€â”€â”€â”€ ì•½ 2ì‹œê°„
  [1] index.ts ì‘ì„±
  [2] Supabase Dashboardì—ì„œ GEMINI_API_KEY Secret ì„¤ì •
  [3] deploy_edge_function MCP ë„êµ¬ë¡œ ë°°í¬
  [4] curlë¡œ E2E í…ŒìŠ¤íŠ¸

Phase B: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì•½ 1ì‹œê°„
  [5] HTML/CSS/JS ì‘ì„±
  [6] ë¡œì»¬ ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸
  [7] Edge Function URL ì—°ë™ í™•ì¸

Phase C: í†µí•© ê²€ì¦  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì•½ 30ë¶„
  [8] E2E í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ (E1~E8) ì‹¤í–‰
  [9] ì„±ëŠ¥ ì¸¡ì • (latency_ms í™•ì¸)
  [10] ìµœì¢… ë³´ê³ ì„œ ì‘ì„±
```

### 9.2 Secret ì„¤ì •

Edge Functionì— í•„ìš”í•œ ì‹œí¬ë¦¿:

| Secret ì´ë¦„      | ê°’            | ì„¤ì • ê²½ë¡œ                                     |
| ---------------- | ------------- | --------------------------------------------- |
| `GEMINI_API_KEY` | Gemini API í‚¤ | Supabase Dashboard > Edge Functions > Secrets |

> `SUPABASE_URL`ê³¼ `SUPABASE_SERVICE_ROLE_KEY`ëŠ” Edge Function ëŸ°íƒ€ì„ì—ì„œ ìë™ ì£¼ì….

### 9.3 CORS ì •ì±… _(Codex F1 ë°˜ì˜: allowlist ì ìš©)_

```typescript
// (Codex F1) ë„ë©”ì¸ allowlist â€” '*' ê¸ˆì§€
const ALLOWED_ORIGINS = [
  'http://localhost:3000',           // ë¡œì»¬ ê°œë°œ
  'http://localhost:5500',           // Live Server
  'http://127.0.0.1:5500',          // Live Server (IP)
  'https://pumsem-chat.pages.dev',   // Cloudflare Pages (ë°°í¬ ì‹œ ë³€ê²½)
];

function getCorsHeaders(req: Request): Record<string, string> {
  const origin = req.headers.get('Origin') || '';
  const allowedOrigin = ALLOWED_ORIGINS.includes(origin) ? origin : '';
  return {
    'Access-Control-Allow-Origin': allowedOrigin,
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, x-api-key',
    'Vary': 'Origin',
  };
}

// OPTIONS preflight ì²˜ë¦¬
if (req.method === 'OPTIONS') {
  return new Response(null, { status: 204, headers: getCorsHeaders(req) });
}
```

> **ì£¼ì˜**: ë°°í¬ í™˜ê²½ì´ ë³€ê²½ë˜ë©´ `ALLOWED_ORIGINS` ì—…ë°ì´íŠ¸ í•„ìš”.
> ê°œë°œ í¸ì˜ë¥¼ ìœ„í•´ í™˜ê²½ë³€ìˆ˜ `ALLOWED_ORIGINS_CSV`ë¡œ ì£¼ì…í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥.

---

## 10. ë¦¬ìŠ¤í¬ ë° ëŒ€ì‘

| ë¦¬ìŠ¤í¬                        | í™•ë¥   | ì˜í–¥  | ëŒ€ì‘                                                           |
| ----------------------------- | :---: | :---: | -------------------------------------------------------------- |
| Edge Function íƒ€ì„ì•„ì›ƒ (25ì´ˆ) |  ì¤‘   |  ë†’   | LLM ëª¨ë¸ Flash ì‚¬ìš©(~2ì´ˆ), ë³‘ë ¬ RPC í˜¸ì¶œ                       |
| Gemini Free tier RPM ì œí•œ     |  ì¤‘   |  ì¤‘   | 15 RPM â†’ ë™ì‹œ ì‚¬ìš©ì ì ìœ¼ë¯€ë¡œ ì¶©ë¶„, í•„ìš” ì‹œ ìœ ë£Œ ì „í™˜          |
| ë²¡í„° ê²€ìƒ‰ í’ˆì§ˆ ë¶€ì¡±           |  ì¤‘   |  ì¤‘   | threshold 0.4ë¡œ ì™„í™”, ë¶ˆë§Œ ì‹œ KURE-v1 êµì²´                     |
| ì¼ìœ„ëŒ€ê°€ ë§¤ì¹­ ì‹¤íŒ¨            |  ì¤‘   |  ì¤‘   | pg_trgm ìœ ì‚¬ë„ ê²€ìƒ‰ ì¶”ê°€ (SQL 1ì¤„)                             |
| XSS (HTML í”„ë¡ íŠ¸ì—”ë“œ)         |  í•˜   |  ì¤‘   | `DOMPurify.sanitize()` ì ìš© _(Codex F2)_ + í—ˆìš© íƒœê·¸ allowlist |

---

## 11. ì‚°ì¶œë¬¼ ëª©ë¡ (ì˜ˆì •)

| íŒŒì¼                                              | ìš©ë„                     | ìƒíƒœ |
| ------------------------------------------------- | ------------------------ | ---- |
| `frontend/index.html`                             | ì±—ë´‡ ë©”ì¸ í˜ì´ì§€         | â³    |
| `frontend/style.css`                              | ìŠ¤íƒ€ì¼ì‹œíŠ¸               | â³    |
| `frontend/app.js`                                 | ì±—ë´‡ ë¡œì§                | â³    |
| Edge Function: `rag-chat` (index.ts)              | ì„œë²„ì‚¬ì´ë“œ ë¡œì§          | â³    |
| `sql/step2.8_search_chunks.sql`                   | ì²­í¬ ê²€ìƒ‰ í•¨ìˆ˜ (í•„ìš” ì‹œ) | â³    |
| `docs/20260211_Step2.8_RAGì±—ë´‡ì„œë¹™_ìµœì¢…ë³´ê³ ì„œ.md` | ì‹¤í–‰ ê²°ê³¼ ë³´ê³ ì„œ         | â³    |

---

## 12. ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 12.1 ê¸°ëŠ¥ ê²€ì¦

- [ ] Edge Function ë°°í¬ ì„±ê³µ
- [ ] ì„ë² ë”© ìƒì„± ì •ìƒ (768ì°¨ì›)
- [ ] ë²¡í„° ê²€ìƒ‰ â†’ ìœ ì‚¬ ì—”í‹°í‹° ë°˜í™˜
- [ ] ê·¸ë˜í”„ í™•ì¥ â†’ ê´€ë ¨ ìì› ë°˜í™˜
- [ ] ì¼ìœ„ëŒ€ê°€ ê²€ìƒ‰ â†’ ë¹„ìš© ì •ë³´ ë°˜í™˜
- [ ] ì›ë¬¸ ì²­í¬ ë³´ê°• â†’ í’ˆì…ˆ ì›ë¬¸ í¬í•¨
- [ ] LLM ë‹µë³€ ìƒì„± â†’ ë§ˆí¬ë‹¤ìš´ í˜•ì‹
- [ ] ëŒ€í™” ì´ë ¥ ìœ ì§€ (5í„´)
- [ ] ì—ëŸ¬ í•¸ë“¤ë§ ì •ìƒ
- [ ] CORS ì •ìƒ (ë¸Œë¼ìš°ì € í˜¸ì¶œ)

### 12.2 í’ˆì§ˆ ê²€ì¦

- [ ] E2E í…ŒìŠ¤íŠ¸ 8ê±´ í†µê³¼
- [ ] ì‘ë‹µ ì‹œê°„ < 5ì´ˆ
- [ ] ì¶œì²˜ ëª…ì‹œ í™•ì¸
- [ ] í• ë£¨ì‹œë„¤ì´ì…˜ ì—†ìŒ (ì»¨í…ìŠ¤íŠ¸ ì™¸ ì •ë³´ ìƒì„± ì•ˆ í•¨)
- [ ] ë¹„ìš© ë‹µë³€ ì‹œ í…Œì´ë¸” í˜•ì‹

---

## Codex ê²€í†  ë°˜ì˜ ì¶”ì í‘œ

| #   | Codex ì§€ì                               | ì‹¬ê°ë„ | ë°˜ì˜ ìœ„ì¹˜                                                   | ìƒíƒœ  |
| --- | --------------------------------------- | :----: | ----------------------------------------------------------- | :---: |
| F1  | `verify_jwt=false` + `CORS=*` ë³´ì•ˆ ìœ„í—˜ |  High  | Â§2.1 ë³´í˜¸ì¥ì¹˜ 3ì¢… + Â§2.6 RAG_API_KEY + Â§9.3 CORS allowlist  |   âœ…   |
| F2  | `marked.js`ë§Œìœ¼ë¡œ XSS ë¶ˆì¶©ë¶„            |  High  | Â§8 DOMPurify + í—ˆìš© íƒœê·¸ ì •ì±…                               |   âœ…   |
| F3  | `section_code` â†’ ì‹¤ì œ `section_id`      |  High  | Â§2.3 íŒŒì´í”„ë¼ì¸ [6] ì»¬ëŸ¼ëª… ìˆ˜ì •                             |   âœ…   |
| F4  | `sources.section` RPC ë¯¸ë°˜í™˜            | Medium | Â§2.2 SourceInfo ìŠ¤í‚¤ë§ˆ + Â§4.2 ì‘ë‹µ ì¡°ë¦½ì—ì„œ chunk JOIN ê²½ë¡œ |   âœ…   |
| F5  | ì…ë ¥ì •ì±… ì¶©ëŒ (truncate vs 400)         | Medium | Â§2.3 [1] + Â§2.5 ì—ëŸ¬í‘œì—ì„œ truncateë¡œ í†µì¼                  |   âœ…   |
| F6  | í…ŒìŠ¤íŠ¸ ìœ ì‚¬ë„ >0.8 ê³ ì • â†’ flaky         |  Low   | Â§7.1 T2 ìƒëŒ€ ê¸°ì¤€(Top-1 ì¡´ì¬)ìœ¼ë¡œ ë³€ê²½                      |   âœ…   |

---

## ë³€ê²½ ì´ë ¥

| ë‚ ì§œ       |   ë²„ì „   | ë³€ê²½ ë‚´ìš©                                                                                                                                                                     |
| ---------- | :------: | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2026-02-11 |   v1.0   | ì´ˆì•ˆ ì‘ì„±                                                                                                                                                                     |
| 2026-02-11 | **v1.1** | **Codex ê²€í†  F1~F6 ì „ê±´ ë°˜ì˜**: ë³´ì•ˆ ê°•í™”(API key+rate limit+CORS allowlist), XSS DOMPurify, section_id ìˆ˜ì •, sources.section ìƒì‚° ê²½ë¡œ, ì…ë ¥ truncate í†µì¼, í…ŒìŠ¤íŠ¸ ìƒëŒ€ ê¸°ì¤€ |
